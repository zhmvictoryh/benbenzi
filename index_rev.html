<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Oimo.js REV</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="IE=11" />
		<link rel="shortcut icon" href="images/favicon.ico">
		<style>
			body {
				font-family: Monospace;
				background-color: #222;
				margin: 0px;
				overflow: hidden;
			}
			a { text-decoration:none; }
		</style> 
	</head>
	<body>
		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/BufferGeometryUtils.js"></script>
		<script type="text/javascript" src="js/tweenLite.min.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3D.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DLoader.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DDeflate.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DLZMA.js"></script>
		<script type="text/javascript" src="js/ThreeEngine.js"></script>
		<script type="text/javascript" src="js/AutoTexture.js"></script>
		<script type="text/javascript" src="js/Detector.js"></script>

		<script type="text/javascript" src="js/loth/Interface.js"></script>
		<script type="text/javascript" src="js/loth/Ambience.js"></script>
		<script type="text/javascript" src="js/loth/AmbienceMapList.js"></script>
		<script type="text/javascript" src="js/GSVPano.min.js"></script>
		<script type="text/javascript" src="js/loth/Stats_loth.js"></script>
		<script type="text/javascript" src="js/loth/Gravity_loth.js"></script>

		<script type="text/javascript" src="js/materialShader/SphereShader.js"></script>
		<script type="text/javascript" src="js/materialShader/SpShader.js"></script>
		<script type="text/javascript" src='js/materialShader/HdrShader.js'></script>

		<script type="text/javascript" src='js/navigatorDetect.js'></script>
		

		<script type="text/javascript">
		    var demoName = ["Basic shape", "Dice fall", "Mad pool", "Joint test", "Supermarket", "Greek temple", "Ragdoll"];
		    var vSet = [ {h:90, v:70, d:600}, {h:0, v:60, d:1000}, {h:360, v:45, d:600}, {h:200, v:70, d:1500}, {h:0, v:10, d:1000}];
		    var key = { front:false, back:false, left:false, right:false, jump:false, crouch:false };

		    var currentView = 0;
            var output, garvity, loadInfo;

            var stats,stats2;
        	var Ambience;
        	var Gravity;
        	var threeEngine;
        	var Interface;

            var OimoWorker = new Worker('js/oimo/worker_oimo_rev.js');
        	OimoWorker.postMessage = OimoWorker.webkitPostMessage || OimoWorker.postMessage;

        	//

        	if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

        	window.onload = init;
        	//init();

		    function init() {
		    	Interface = new Interface('rev');
		    	Ambience = new Ambience();
		    	stats = new Stats_loth();
		    	stats2 = new Stats_loth();
		    	stats2.domElement.style.bottom = '60px';
				stats2.rename('OIMO');
		    	Gravity = new Gravity_loth();

                garvity = document.getElementById("gravity");

		    	threeEngine = new ThreeEngine();
		    	document.body.appendChild( threeEngine.domElement );
		    	document.body.appendChild( Interface.domElement );
				document.body.appendChild( stats.domElement );
				document.body.appendChild( stats2.domElement );
				document.body.appendChild( Ambience.domElement );
				document.body.appendChild( Gravity.domElement );
				

				Gravity.setup(-10, changeGravity);
				threeEngine.init();
            }

            function mainAllObjectLoaded(){
            	// hide loader
            	//loadInfo.style.visibility = "hidden";
            	//document.getElementById("loadIcon").style.visibility = "hidden"; 
            	//document.getElementById("loader").style.visibility = "hidden";

            	// start worker
        	    OimoWorker.postMessage({tell:"INITWORLD", dt:1/60, iterations:8, G:-10 });
            }

            //-----------------------------------------------------
            //  OIMO MESSAGE MAIN
            //-----------------------------------------------------

    	    OimoWorker.onmessage = function(e) {
    	    	var phase = e.data.tell;

    	    	// create mesh
	            if(phase === "INIT"){
	            	threeEngine.createObjects(e.data);
	            	OimoWorker.postMessage({tell:"UPDATE"});
				}

				// stats update
				if(phase === "BEGIN"){stats2.begin();}

				// update three object
    	    	if( phase === "RUN"){
    	    		var demo = e.data.infos[0];
    	    		var max = e.data.sleeps.length;
    	    		var i=e.data.sleeps.length;//0;
    	    		var m = e.data.matrix;
        	    	var mtx, n, mesh;

        	    	// Update rendering meshes
        	    	while (i--) {
        	    		if( threeEngine.content.children[i] ){
            	    		mesh = threeEngine.content.children[i];
            	    		if( e.data.sleeps[i]===0){
            	    			n = 12*i;
	            	    		mtx = new THREE.Matrix4(m[n+0], m[n+1], m[n+2], m[n+3], m[n+4], m[n+5], m[n+6], m[n+7], m[n+8], m[n+9], m[n+10], m[n+11], 0, 0, 0, 1);
	            	    		mesh.position.setFromMatrixPosition( mtx )
						    	mesh.rotation.setFromRotationMatrix( mtx );
						    	if(mesh.material){
							    	if(mesh.material.name == "mat01sleep") mesh.material = threeEngine.materials[0];
						    		else if(mesh.material.name == "mat02sleep") mesh.material = threeEngine.materials[1];
						    		else if(mesh.material.name == "mat03sleep") mesh.material = threeEngine.materials[2];
						    		else if(mesh.material.name == "mat04sleep") mesh.material = threeEngine.materials[3];
						    		else if(mesh.material.name == "bonesleep") mesh.material = threeEngine.materials[10];
						    	}
						    } else {
						    	if(mesh.material){
						    		if(mesh.material.name == "mat01") mesh.material = threeEngine.materials[5];
						    		else if(mesh.material.name == "mat02") mesh.material = threeEngine.materials[6];
						    		else if(mesh.material.name == "mat03") mesh.material = threeEngine.materials[7];
						    		else if(mesh.material.name == "mat04") mesh.material = threeEngine.materials[8];
						    		else if(mesh.material.name == "bone") mesh.material = threeEngine.materials[11];
						    	}
					    	}
				        } 
		            }

		            //skin update
		            if(demo === 3) threeEngine.updateSnake();
		            if(demo === 6) threeEngine.updateSila();
		            
		            //Follow object 
		            if(demo === 4 || demo === 5){
		            	var m00=threeEngine.content.children[max-1];
		            	var m01=threeEngine.content.children[max];
		            	m01.position.copy(m00.position);
		            	threeEngine.cameraFollow(m00.position);
		                m01.children[0].rotation.y= m00.rotation.z; //axe01
		                m01.children[0].children[0].rotation.x = m00.rotation.y; //axe02
		            	m01.children[0].children[0].children[0].rotation.y = m00.rotation.x; //axe03
		            }

					displayInfo(e.data.infos);
					stats2.end();
	            }

	            // clear three object
				if(phase === "CLEAR") threeEngine.clear();
				// get ragdoll info
				if(phase === "GETBONES") threeEngine.getSqueletonStructure(e.data.name);
    	    }

    	    //-----------------------------------------------------
            //  OIMO MESSAGE FUNCTION
            //-----------------------------------------------------

	        function sendKey(key){ OimoWorker.postMessage({tell:"KEY", key:key}); }
	        function sendCameraOrientation(phi, theta){ OimoWorker.postMessage({tell:"CAMERA", cam:[phi, theta]}); }
	        function prevDemo(){ OimoWorker.postMessage({tell:"PREV"}); }
	        function nextDemo(){ OimoWorker.postMessage({tell:"NEXT"}); }
	        function changeGravity(G){ OimoWorker.postMessage({tell:"GRAVITY", G:G}); }

	        //-----------------------------------------------------
            //  OIMO INFO
            //-----------------------------------------------------

	        function displayInfo(a){
	        	document.getElementById("demoName").innerHTML = demoName[a[0]];
			    var info =[
	        	    "Rigidbody: "+a[1]+"<br>",
	        	    "Contact: "+a[2]+"<br>",
	        	    "Pair Check: "+a[3]+"<br>",
	        	    "Contact Point: "+a[4]+"<br>",
	        	    "Island: " + a[5] +"<br><br>",
	        	    "Broad-Phase Time: " + a[6] + "ms<br>",
	        	    "Narrow-Phase Time: " + a[7] + "ms<br>",
	        	    "Solving Time: " + a[8] + "ms<br>",
	        	    "Updating Time: " + a[9] + "ms<br>",
	        	    "Total Time: " + a[10] + "ms<br>",
	        	    //"Physics: " + a[11] +" fps<br>",
	        	    //"Render: " + fpstxt +" fps<br>"
			    ].join("\n");

	        	document.getElementById("output").innerHTML = info;
	        }

	        //-----------------------------------------------------
            //  CAMERA AUTOMOVE
            //-----------------------------------------------------

			function moveView() {
				var n = currentView;
				threeEngine.changeView(vSet[n].h, vSet[n].v, vSet[n].d);
				//document.getElementById("bview").innerHTML = "VIEW " + n;
				currentView++;
				if(currentView == vSet.length)currentView = 0;
			}

		</script>
	</body>
</html>