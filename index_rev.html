<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Oimo.js rev</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="css/style.css" />
	</head>
	<body>
		<div id="container" class="unselectable"></div>
		<div id="fps" class="unselectable"></div>
		<div id="debug" class="unselectable"></div>
		<div id="info" class="unselectable">
			<a href="http://3dflashlo.wordpress.com/" target="_blank">Loth 2013</a>
			- <a href="http://threejs.org" target="_blank">Three.js</a>
			- <a href="https://code.google.com/p/sea3d/" target="_blank">Sea3d</a>
			- <a href="https://github.com/saharan/OimoPhysics" target="_blank">Oimo physics</a>
		</div>
		<div id="cursor" class="unselectable">
			<img id="cursorUp" class="unselectable" src="images/cursor0.png">
			<img id="cursorDown" class="unselectable" src="images/cursor01.png">
		</div>
		<div id="menu" class="unselectable">
			<button type="button" onclick="prevDemo()" id="bcontrol">PREV DEMO</button>
			<button type="button" onclick="nextDemo()" id="bcontrol">NEXT DEMO</button>
			<button type="button" onclick="moveView()" id="bview">VIEW</button>
		</div>
		<div id="titre" class="unselectable">
			<img id="logo" class="unselectable" src="images/logo.png"/>
			Oimo.js rev / <a href="index.html" target="_self">dev</a>
		</div>
		<div id="option" class="unselectable">
		GRAVITY<input id="position" type="range" min="0.1" max="2" value="1" step="0.01" onchange="changeGravity()" /><br/>
		</div>

		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/Mirror.js"></script>
		<script type="text/javascript" src="js/tweenLite.min.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3D.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DLoader.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DDeflate.js"></script>
		<script type="text/javascript" src="js/loaders/sea3d/SEA3DLZMA.js"></script>
		<script type="text/javascript" src="js/ViewBasic.js"></script>

		<script type="text/javascript">
		    var vSet = [ {h:90, v:70, d:600}, {h:0, v:60, d:1000}, {h:360, v:45, d:600}, {h:200, v:70, d:1500}, {h:0, v:10, d:1000}];
		    var key = { front:false, back:false, left:false, right:false, jump:false, crouch:false };

		    var currentView = 0;
		    var playerSelect = 1;

		    var dt = 1/60;
            var N = 60;
            var maxBody;
            var pos;
            var sendTime = 0; // Time when we sent last message
            var delay;
            var _output = document.getElementById("debug");
            var temp = 0;
            var timeout;

            var OimoWorker = new Worker('worker_oimo_rev.js');
        	OimoWorker.postMessage = OimoWorker.webkitPostMessage || OimoWorker.postMessage;

		    function init() {
            	// init three.js engine
            	initThree({ mouse:true, autoSize:true, n:Math.floor(Math.random()*4), optimized:false});
            }

            function mainAllObjectLoaded(){
            	// start worker
        	    OimoWorker.postMessage({tell:"INITWORLD", dt:dt, iterations:8 });
            }

            //-----------------------------------------------------
            //  OIMO MESSAGE MAIN
            //-----------------------------------------------------

    	    OimoWorker.onmessage = function(e) {
    	    	var phase = e.data.tell;
    	    	
    	    	// create mesh
	            if(phase === "INIT"){
	            	var max = e.data.types.length;
				    for(var i=0; i!==max; i++){
			        	if( e.data.types[i] == 1) addSphere(e.data.sizes[i]);
			        	else if( e.data.types[i] == 2) addCube(e.data.sizes[i]);
			        	else if( e.data.types[i] == 3) addCylinder(e.data.sizes[i]);
			        	else if( e.data.types[i] == 4) addDice(e.data.sizes[i]);
				    }
				    sendDataToWorker();
				}

				// update three object
    	    	else if( phase === "RUN"){
    	    		var t01 = Date.now();
    	    		var max = e.data.sleeps.length;
    	    		var m = e.data.matrix;
        	    	var mtx, n, mesh;

        	    	// Update rendering meshes
        	    	for(var i=0; i!==max; i++){
        	    		if( content.children[i] ){
            	    		mesh = content.children[i];
            	    		if( e.data.sleeps[i]==0){
            	    			n = 12*i;
	            	    		mtx = new THREE.Matrix4(m[n+0], m[n+1], m[n+2], m[n+3]*100, m[n+4], m[n+5], m[n+6], m[n+7]*100, m[n+8], m[n+9], m[n+10], m[n+11]*100, 0, 0, 0, 1);
						        mesh.position.getPositionFromMatrix( mtx );
						    	mesh.rotation.setFromRotationMatrix( mtx );

						    	if(mesh.material.name == "mat01sleep") mesh.material = mat01;
					    		else if(mesh.material.name == "mat02sleep") mesh.material = mat02;
					    		else if(mesh.material.name == "mat03sleep") mesh.material = mat03;
					    		else if(mesh.material.name == "mat04sleep") mesh.material = mat04;
						    } else {
					    		if(mesh.material.name == "mat01"){ mesh.material = mat01sleep;}
					    		else if(mesh.material.name == "mat02"){ mesh.material = mat02sleep;}
					    		else if(mesh.material.name == "mat03"){ mesh.material = mat03sleep;}
					    		else if(mesh.material.name == "mat04"){ mesh.material = mat04sleep;}
					    	}
				        } 
		            }
		            var t02 = Date.now();
		            temp = t02-t01;

		            delay = (dt * 1000) - (Date.now()-sendTime);
	    	   	    if(delay < 0)  delay = 0;

					displayInfo(e.data.infos);

	    	   	    timeout = setTimeout(sendDataToWorker, delay);
	            }

	            // clear three object
				else if(phase === "CLEAR"){
					clearTimeout(timeout);
					clearContent();
				}

    	   	    
    	    }

            function sendDataToWorker(){
	            sendTime = Date.now();
                OimoWorker.postMessage({tell:"UPDATE"});
	        }

	        function prevDemo(){
	        	clearTimeout(timeout);
	        	OimoWorker.postMessage({tell:"PREV"});
	        } 

	        function nextDemo(){
	        	clearTimeout(timeout);
	        	OimoWorker.postMessage({tell:"NEXT"});
	        }

	        function changeGravity(e){
	        	garvity.value;
	        }

	        function displayInfo(a){
	        	var info = "";
	        	info += "Rigidbody: "+a[0]+"<br>";
	        	info += "Contact: "+a[1]+"<br>";
			    info += "Shapes: "+a[2]+"<br>";
			    info += "Joints: "+a[3]+"<br>";
			    info += "Island: " + a[4] +"<br><br>";
			    
			    info += "Broad-Phase Time: " + a[5] + "ms<br>";
			    info += "Narrow-Phase Time: " + a[6] + "ms<br>";
			    info += "Solving Time: " + a[7] + "ms<br>";
			    info += "Updating Time: " + a[8] + "ms<br>";
			    info += "Total Time: " + a[9] + "ms<br><br>";

			    info += "Fps: " + a[10] +"<br>";
			    info += "Get pos: " + a[11] + "ms<br>";
			    info += "Apply pos: "+ temp +"ms"
	        	_output.innerHTML = info;
	        }

		    function resetDemo() {
		    	OimoWorker.postMessage({tell:"CLEAR"});
			}

			function moveView() {
				var n = currentView;
				onThreeChangeView(vSet[n].h, vSet[n].v, vSet[n].d);
				document.getElementById("bview").innerHTML = "VIEW " + n;
				currentView++;
				if(currentView == vSet.length)currentView = 0;
			}

		    window.onload = init;
		</script>
	</body>
</html>