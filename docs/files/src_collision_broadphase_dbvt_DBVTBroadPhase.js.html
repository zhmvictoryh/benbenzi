<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\collision\broadphase\dbvt\DBVTBroadPhase.js - oimo</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="oimo" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.4</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/BoxShape.html">BoxShape</a></li>
                                <li><a href="../classes/CylinderShape.html">CylinderShape</a></li>
                                <li><a href="../classes/MassInfo.html">MassInfo</a></li>
                                <li><a href="../classes/Proxy.html">Proxy</a></li>
                                <li><a href="../classes/Shape.html">Shape</a></li>
                                <li><a href="../classes/ShapeConfig.html">ShapeConfig</a></li>
                                <li><a href="../classes/SphereShape.html">SphereShape</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\collision\broadphase\dbvt\DBVTBroadPhase.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import { BR_BOUNDING_VOLUME_TREE } from &#x27;../../../constants&#x27;;
import { BroadPhase } from &#x27;../BroadPhase&#x27;;
import { DBVT } from &#x27;./DBVT&#x27;;
import { DBVTProxy } from &#x27;./DBVTProxy&#x27;;
/**
 * A broad-phase algorithm using dynamic bounding volume tree.
 * @author saharan
 * @author lo-th
 */

function DBVTBroadPhase(){

    BroadPhase.call( this);
    this.types = BR_BOUNDING_VOLUME_TREE;

    this.tree = new DBVT();
    this.stack = [];
    this.leaves = [];
    this.numLeaves = 0;

};

DBVTBroadPhase.prototype = Object.create( BroadPhase.prototype );
DBVTBroadPhase.prototype.constructor = DBVTBroadPhase;

DBVTBroadPhase.prototype.createProxy = function ( shape ) {

    return new DBVTProxy(shape);

};

DBVTBroadPhase.prototype.addProxy = function ( proxy ) {

    this.tree.insertLeaf( proxy.leaf );
    this.leaves.push( proxy.leaf );
    this.numLeaves++;

};

DBVTBroadPhase.prototype.removeProxy = function ( proxy ) {

    this.tree.deleteLeaf( proxy.leaf );
    var n = this.leaves.indexOf( proxy.leaf );
    if ( n &gt; -1 ) {
        this.leaves.splice(n,1);
        this.numLeaves--;
    }

};

DBVTBroadPhase.prototype.collectPairs = function () {

    if ( this.numLeaves &lt; 2 ) return;

    var leaf, margin = 0.1, i = this.numLeaves;

    while(i--){

        leaf = this.leaves[i];

        if ( leaf.proxy.aabb.intersectTestTwo( leaf.aabb ) ){

            leaf.aabb.copy( leaf.proxy.aabb, margin );
            this.tree.deleteLeaf( leaf );
            this.tree.insertLeaf( leaf );
            this.collide( leaf, this.tree.root );

        }
    }

};

DBVTBroadPhase.prototype.collide = function ( node1, node2 ) {

    var stackCount = 2;
    var s1, s2, n1, n2, l1, l2;
    this.stack[0] = node1;
    this.stack[1] = node2;

    while( stackCount &gt; 0 ){

        n1 = this.stack[--stackCount];
        n2 = this.stack[--stackCount];
        l1 = n1.proxy != null;
        l2 = n2.proxy != null;
        
        this.numPairChecks++;

        if( l1 &amp;&amp; l2 ){
            s1 = n1.proxy.shape;
            s2 = n2.proxy.shape;
            if ( s1 == s2 || s1.aabb.intersectTest( s2.aabb ) || !this.isAvailablePair( s1, s2 ) ) continue;

            this.addPair(s1,s2);

        }else{

            if ( n1.aabb.intersectTest( n2.aabb ) ) continue;
            
            /*if(stackCount+4&gt;=this.maxStack){// expand the stack
                //this.maxStack&lt;&lt;=1;
                this.maxStack*=2;
                var newStack = [];// vector
                newStack.length = this.maxStack;
                for(var i=0;i&lt;stackCount;i++){
                    newStack[i] = this.stack[i];
                }
                this.stack = newStack;
            }*/

            if( l2 || !l1 &amp;&amp; (n1.aabb.surfaceArea() &gt; n2.aabb.surfaceArea()) ){
                this.stack[stackCount++] = n1.child1;
                this.stack[stackCount++] = n2;
                this.stack[stackCount++] = n1.child2;
                this.stack[stackCount++] = n2;
            }else{
                this.stack[stackCount++] = n1;
                this.stack[stackCount++] = n2.child1;
                this.stack[stackCount++] = n1;
                this.stack[stackCount++] = n2.child2;
            }
        }
    }

};

export { DBVTBroadPhase };
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
