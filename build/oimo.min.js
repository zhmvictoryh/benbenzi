// lo-th.github.io/Oimo.js/license
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i(t.OIMO=t.OIMO||{})}(this,function(t){"use strict";function i(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0}function s(t,i,s,h){this.x=t||0,this.y=i||0,this.z=s||0,this.w=void 0!==h?h:1}function h(t,i,s,h,e,a,o,n,r){this.elements=new Float32Array(9),this.init(void 0!==t?t:1,i||0,s||0,h||0,void 0!==e?e:1,a||0,o||0,n||0,void 0!==r?r:1)}function e(t,i){console.error(t,i)}function a(t){this.parent=t,this.infos=new Float32Array(13),this.f=[0,0,0],this.times=[0,0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=mt,this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0}function o(t){t=t||{},t.world&&(void 0===t.type&&(t.type="jointHinge"),this.name=t.name||"",this.joint=t.world.add(t))}function n(t){t=t||{},t.world&&(void 0===t.type&&(t.type="box"),this.name=t.name||"",this.body=t.world.add(t))}function r(t,i,s,h){this._x=t||0,this._y=i||0,this._z=s||0,this._order=h||r.DefaultOrder}function l(t,i,s,h,e,a,o,n,r,l,c,m,p,u,x,y){this.elements=new Float32Array(16);var d=this.elements;d[0]=void 0!==t?t:1,d[4]=i||0,d[8]=s||0,d[12]=h||0,d[1]=e||0,d[5]=void 0!==a?a:1,d[9]=o||0,d[13]=n||0,d[2]=r||0,d[6]=l||0,d[10]=void 0!==c?c:1,d[14]=m||0,d[3]=p||0,d[7]=u||0,d[11]=x||0,d[15]=void 0!==y?y:1}function c(t,i,s,h,e,a){this.elements=new Float32Array(6);var o=this.elements;o[0]=t||0,o[1]=s||0,o[2]=e||0,o[3]=i||0,o[4]=h||0,o[5]=a||0}function m(){return Xt++}function p(t){this.shape=t,this.aabb=t.aabb}function u(t){p.call(this,t),this.id=m()}function x(t,i){this.shape1=t||null,this.shape2=i||null}function y(){this.types=pt,this.numPairChecks=0,this.numPairs=0,this.pairs=[]}function d(){y.call(this),this.types=ut,this.proxies=[]}function f(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new c}function N(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new c}function z(t){p.call(this,t),this.leaf=new f,this.leaf.proxy=this}function v(){y.call(this),this.types=yt,this.tree=new N,this.stack=[],this.leaves=[],this.numLeaves=0}function b(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new Float32Array(64)}function k(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0}function A(t,i){p.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new k(this,!1),this.max[0]=new k(this,!0),this.min[1]=new k(this,!1),this.max[1]=new k(this,!0),this.min[2]=new k(this,!1),this.max[2]=new k(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]}function w(){y.call(this),this.types=xt,this.numElementsD=0,this.numElementsS=0,this.axesD=[new b,new b,new b],this.axesS=[new b,new b,new b],this.index1=0,this.index2=1}function g(){this.flip=!1}function I(){g.call(this),this.clipVertices1=new Float32Array(24),this.clipVertices2=new Float32Array(24),this.used=new Float32Array(8),this.INF=1/0}function M(t){g.call(this),this.flip=t}function L(){g.call(this)}function S(t){g.call(this),this.flip=t}function P(t){g.call(this),this.flip=t}function V(){g.call(this)}function T(){this.mass=0,this.inertia=new h}function X(){this.relativePosition=new i,this.relativeRotation=new h,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295}function Y(){return Yt++}function Z(t){this.type=zt,this.id=Y(),this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new i,this.rotation=new h,this.relativePosition=(new i).copy(t.relativePosition),this.relativeRotation=(new h).copy(t.relativeRotation),this.aabb=new c,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith}function C(t,i,s,h){Z.call(this,t),this.type=bt,this.width=i,this.height=s,this.depth=h,this.halfWidth=.5*i,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new Float32Array(18),this.elements=new Float32Array(24)}function D(t,i){Z.call(this,t),this.type=vt,this.radius=i}function _(t,s,h){Z.call(this,t),this.type=kt,this.radius=s,this.height=h,this.halfHeight=.5*h,this.normalDirection=new i,this.halfDirection=new i}function U(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1}function E(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t}function q(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN}function F(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1}function j(){this.warmStarted=!1,this.position=new i,this.localPoint1=new i,this.localPoint2=new i,this.normal=new i,this.tangent=new i,this.binormal=new i,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0}function R(t){U.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new F,this.cs.next=new F,this.cs.next.next=new F,this.cs.next.next.next=new F}function B(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new j,this.points[1]=new j,this.points[2]=new j,this.points[3]=new j}function O(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new E(this),this.b2Link=new E(this),this.s1Link=new E(this),this.s2Link=new E(this),this.manifold=new B,this.buffer=[],this.buffer.length=4,this.buffer[0]=new q,this.buffer[1]=new q,this.buffer[2]=new q,this.buffer[3]=new q,this.points=this.manifold.points,this.constraint=new R(this.manifold)}function J(t,h){this.joint=t,this.targetOrientation=(new s).invert(h),this.relativeOrientation=new s,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new i,this.imp=new i,this.rn0=new i,this.rn1=new i,this.rn2=new i,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia}function H(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0}function W(t,i,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0}function Q(t,i){this.cfm=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.enableLimit=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0}function G(t,i,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1}function K(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0}function $(t){this.prev=null,this.next=null,this.body=null,this.joint=t}function tt(t){U.call(this),this.scale=t.scale,this.invScale=t.invScale,this.name="",this.type=wt,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new i).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new i).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new i,this.relativeAnchorPoint2=new i,this.anchorPoint1=new i,this.anchorPoint2=new i,this.allowCollision=t.allowCollision,this.b1Link=new $(this),this.b2Link=new $(this),this.matrix=new l}function it(){this.scale=1,this.invScale=1,this.body1=null,this.body2=null,this.localAnchorPoint1=new i,this.localAnchorPoint2=new i,this.localAxis1=new i,this.localAxis2=new i,this.allowCollision=!1}function st(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0}function ht(t,e,a){tt.call(this,t),this.type=Mt,this.localAxis1=t.localAxis1.clone().norm(),this.localAxis2=t.localAxis2.clone().norm(),this.localAngle1=new i(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var o=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new i).mulMat(o,this.localAngle1),this.nor=new i,this.tan=new i,this.bin=new i,this.ax1=new i,this.ax2=new i,this.an1=new i,this.an2=new i,this.limitMotor=new st(this.nor,!1),this.limitMotor.lowerLimit=e,this.limitMotor.upperLimit=a,this.lc=new H(this),this.r3=new W(this,this.limitMotor,new st(this.tan,!0),new st(this.bin,!0))}function et(t){tt.call(this,t),this.type=It,this.lc=new H(this)}function at(t,s,h){tt.call(this,t),this.type=gt,this.normal=new i,this.nr=new i,this.limitMotor=new st(this.normal,!0),this.limitMotor.lowerLimit=s,this.limitMotor.upperLimit=h,this.t=new K(this,this.limitMotor)}function ot(t,h,e){tt.call(this,t),this.type=Pt,this.localAxis1=(new i).normalize(t.localAxis1),this.localAxis2=(new i).normalize(t.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new i,this.tan=new i,this.bin=new i,this.ac=new J(this,(new s).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new st(this.nor,!0),this.limitMotor.lowerLimit=h,this.limitMotor.upperLimit=e,this.t3=new G(this,this.limitMotor,new st(this.tan,!0),new st(this.bin,!0))}function nt(t,e,a){tt.call(this,t),this.type=St,this.localAxis1=(new i).normalize(t.localAxis1),this.localAxis2=(new i).normalize(t.localAxis2);var o;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,o=1/Tt.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=o,this.localAngAxis1Y*=o,this.localAngAxis1Z*=o,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var n=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2)),r=n.elements;this.localAngAxis2X=this.localAngAxis1X*r[0]+this.localAngAxis1Y*r[1]+this.localAngAxis1Z*r[2],this.localAngAxis2Y=this.localAngAxis1X*r[3]+this.localAngAxis1Y*r[4]+this.localAngAxis1Z*r[5],this.localAngAxis2Z=this.localAngAxis1X*r[6]+this.localAngAxis1Y*r[7]+this.localAngAxis1Z*r[8],this.nor=new i,this.tan=new i,this.bin=new i,this.rotationalLimitMotor=new st(this.nor,!1),this.r3=new W(this,this.rotationalLimitMotor,new st(this.tan,!0),new st(this.bin,!0)),this.translationalLimitMotor=new st(this.nor,!0),this.translationalLimitMotor.lowerLimit=e,this.translationalLimitMotor.upperLimit=a,this.t3=new G(this,this.translationalLimitMotor,new st(this.tan,!0),new st(this.bin,!0))}function rt(t){tt.call(this,t),this.type=Lt,this.localAxis1=(new i).normalize(t.localAxis1),this.localAxis2=(new i).normalize(t.localAxis2);var e;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(a>-1&&a<1)this.localAngAxis1X=this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,e=1/Tt.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e,e=1/Tt.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=e,this.localAngAxis2Y*=e,this.localAngAxis2Z*=e;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,e=1/Tt.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e;var o=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2)),n=o.elements;this.localAngAxis2X=this.localAngAxis1X*n[0]+this.localAngAxis1Y*n[1]+this.localAngAxis1Z*n[2],this.localAngAxis2Y=this.localAngAxis1X*n[3]+this.localAngAxis1Y*n[4]+this.localAngAxis1Z*n[5],this.localAngAxis2Z=this.localAngAxis1X*n[6]+this.localAngAxis1Y*n[7]+this.localAngAxis1Z*n[8]}this.nor=new i,this.tan=new i,this.bin=new i,this.translationalLimitMotor=new st(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new st(this.tan,!1),this.rotationalLimitMotor2=new st(this.bin,!1),this.t3=new G(this,new st(this.nor,!0),this.translationalLimitMotor,new st(this.bin,!0)),this.t3.weight=1,this.r3=new W(this,new st(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)}function lt(t,e,a,o,n,r,c,m,p){this.scale=m||1,this.invScale=p||1,this.name=" ",this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=dt,this.massInfo=new T,this.position=new i(t,e,a),this.orientation=(new s).setFromAxis(o||0,n||0,r||0,c||0),this.newPosition=new i,this.controlPos=!1,this.newOrientation=new s,this.newRotation=new i,this.currentRotation=new i,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new i,this.angularVelocity=new i,this.matrix=new l,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new i,this.sleepOrientation=new s,this.isStatic=!1,this.isDynamic=!1,this.rotation=new h,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new h,this.localInertia=new h,this.inverseLocalInertia=new h,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1}function ct(t,s,h,e,o){switch(this.scale=o||100,this.invScale=1/this.scale,this.timeStep=t||.01666,this.numIterations=h||8,s||2){case 1:this.broadPhase=new d;break;case 2:default:this.broadPhase=new w;break;case 3:this.broadPhase=new v}this.performance=null,this.isNoStat=e||!1,this.isNoStat||(this.performance=new a(this)),this.enableRandomizer=!0,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new i(0,-9.80665,0);var n=5;this.detectors=[],this.detectors.length=n;for(var r=n;r--;)this.detectors[r]=[],this.detectors[r].length=n;this.detectors[vt][vt]=new V,this.detectors[vt][bt]=new S(!1),this.detectors[bt][vt]=new S(!0),this.detectors[bt][bt]=new I,this.detectors[kt][kt]=new L,this.detectors[kt][bt]=new M(!0),this.detectors[bt][kt]=new M(!1),this.detectors[kt][vt]=new P(!0),this.detectors[vt][kt]=new P(!1),this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&!function(){Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),s=1;s<arguments.length;s++){var h=arguments[s];if(void 0!==h&&null!==h)for(var e in h)Object.prototype.hasOwnProperty.call(h,e)&&(i[e]=h[e])}return i}}();var mt="1.3",pt=0,ut=1,xt=2,yt=3,dt=0,ft=1,Nt=2,zt=0,vt=1,bt=2,kt=3,At=4,wt=0,gt=1,It=2,Mt=3,Lt=4,St=5,Pt=6,Vt=.005;i.prototype={constructor:i,init:function(t,i,s){return this.x=t||0,this.y=i||0,this.z=s||0,this},set:function(t,i,s){return this.x=t,this.y=i,this.z=s,this},add:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addTime:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},sub:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},addScale:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},cross:function(t,i){var s=t.x,h=t.y,e=t.z,a=i.x,o=i.y,n=i.z;return this.x=h*n-e*o,this.y=e*a-s*n,this.z=s*o-h*a,this},mul:function(t,i,s){var h=s.elements;return this.x=t.x+i.x*h[0]+i.y*h[1]+i.z*h[2],this.y=t.y+i.x*h[3]+i.y*h[4]+i.z*h[5],this.z=t.z+i.x*h[6]+i.y*h[7]+i.z*h[8],this},mulMat:function(t,i){var s=t.elements;return this.x=s[0]*i.x+s[1]*i.y+s[2]*i.z,this.y=s[3]*i.x+s[4]*i.y+s[5]*i.z,this.z=s[6]*i.x+s[7]*i.y+s[8]*i.z,this},normalize:function(t){var i=t.x,s=t.y,h=t.z,e=i*i+s*s+h*h;return e>0&&(e=1/Tt.sqrt(e),this.x=i*e,this.y=s*e,this.z=h*e),this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Tt.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyQuaternion:function(t){var i=this.x,s=this.y,h=this.z,e=t.x,a=t.y,o=t.z,n=t.w,r=n*i+a*h-o*s,l=n*s+o*i-e*h,c=n*h+e*s-a*i,m=-e*i-a*s-o*h;return this.x=r*n+m*-e+l*-o-c*-a,this.y=l*n+m*-a+c*-e-r*-o,this.z=c*n+m*-o+r*-a-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return t.x!==this.x||t.y!==this.y||t.z!==this.z},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},norm:function(){return this.divideScalar(this.length())}},s.prototype={constructor:s,set:function(t,i,s,h){return this.x=t,this.y=i,this.z=s,this.w=h,this},init:function(t,i,s,h){return this.w=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0,this},add:function(t,i){return this.w=t.w+i.w,this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addTime:function(t,i){var s=t.x,h=t.y,e=t.z,a=this.w,o=this.x,n=this.y,r=this.z;i*=.5;var l=(-s*o-h*n-e*r)*i,c=(s*a+h*r-e*n)*i,m=(-s*r+h*a+e*o)*i,p=(s*n-h*o+e*a)*i;a+=l,o+=c,n+=m,r+=p;var u=1/Tt.sqrt(a*a+o*o+n*n+r*r);return this.w=a*u,this.x=o*u,this.y=n*u,this.z=r*u,this},sub:function(t,i){return this.w=t.w-i.w,this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},scale:function(t,i){return this.w=t.w*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},mul:function(t,i){var s=t.x,h=t.y,e=t.z,a=t.s,o=i.x,n=i.y,r=i.z,l=i.s;return this.x=s*l+a*o+h*r-e*n,this.y=h*l+a*n+e*o-s*r,this.z=e*l+a*r+s*n-h*o,this.w=a*l-s*o-h*n-e*r,this},arc:function(t,i){var s=t.x,h=t.y,e=t.z,a=i.x,o=i.y,n=i.z,r=s*a+h*o+e*n;if(r==-1)return a=h*s-e*e,o=-e*h-s*s,n=s*e+h*h,r=1/Tt.sqrt(a*a+o*o+n*n),this.w=0,this.x=a*r,this.y=o*r,this.z=n*r,this;var l=h*n-e*o,c=e*a-s*n,m=s*o-h*a;return this.w=Tt.sqrt(.5*(1+r)),r=.5/this.w,this.x=l*r,this.y=c*r,this.z=m*r,this},normalize:function(t){var i=Tt.sqrt(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z);return i>0&&(i=1/i),this.w=t.w*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},invert:function(t){return this.w=t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},length:function(){return Tt.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.w=t.w,this.x=t.x,this.y=t.y,this.z=t.z,this},testDiff:function(t){return this.w!==t.w||this.x!==t.x||this.y!==t.y||this.z!==t.z},clone:function(t){return new s(this.x,this.y,this.z,this.w)},toString:function(){return"Quat["+this.x.toFixed(4)+", ("+this.y.toFixed(4)+", "+this.z.toFixed(4)+", "+this.w.toFixed(4)+")]"},setFromAxis:function(t,i,s,h){var e=i*i+s*s+h*h;e>0&&(e=1/Tt.sqrt(e),i*=e,s*=e,h*=e);var a=Tt.sin(.5*t);return this.x=a*i,this.y=a*s,this.z=a*h,this.w=Tt.cos(.5*t),this},setFromRotationMatrix:function(t){var i,s=t.elements,h=s[0],e=s[1],a=s[2],o=s[3],n=s[4],r=s[5],l=s[6],c=s[7],m=s[8],p=h+n+m;return p>0?(i=.5/Tt.sqrt(p+1),this.w=.25/i,this.x=(c-r)*i,this.y=(a-l)*i,this.z=(o-e)*i):h>n&&h>m?(i=2*Tt.sqrt(1+h-n-m),this.w=(c-r)/i,this.x=.25*i,this.y=(e+o)/i,this.z=(a+l)/i):n>m?(i=2*Tt.sqrt(1+n-h-m),this.w=(a-l)/i,this.x=(e+o)/i,this.y=.25*i,this.z=(r+c)/i):(i=2*Tt.sqrt(1+m-h-n),this.w=(o-e)/i,this.x=(a+l)/i,this.y=(r+c)/i,this.z=.25*i),this}},h.prototype={constructor:h,set:function(t,i,s,h,e,a,o,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=a,l[6]=o,l[7]=n,l[8]=r,this},init:function(t,i,s,h,e,a,o,n,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=a,l[6]=o,l[7]=n,l[8]=r,this},multiply:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},add:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(t){var i=this.elements,s=t.elements;return i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[3],i[4]+=s[4],i[5]+=s[5],i[6]+=s[6],i[7]+=s[7],i[8]+=s[8],this},sub:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(t){var i=this.elements,s=t.elements;return i[0]-=s[0],i[1]-=s[1],i[2]-=s[2],i[3]-=s[3],i[4]-=s[4],i[5]-=s[5],i[6]-=s[6],i[7]-=s[7],i[8]-=s[8],this},scale:function(t,i){var s=this.elements,h=t.elements;return s[0]=h[0]*i,s[1]=h[1]*i,s[2]=h[2]*i,s[3]=h[3]*i,s[4]=h[4]*i,s[5]=h[5]*i,s[6]=h[6]*i,s[7]=h[7]*i,s[8]=h[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},mul:function(t,i){var s=this.elements,h=t.elements,e=i.elements,a=h[0],o=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],x=e[0],y=e[3],d=e[6],f=e[1],N=e[4],z=e[7],v=e[2],b=e[5],k=e[8];return s[0]=a*x+r*y+m*d,s[1]=a*f+r*N+m*z,s[2]=a*v+r*b+m*k,s[3]=o*x+l*y+p*d,
s[4]=o*f+l*N+p*z,s[5]=o*v+l*b+p*k,s[6]=n*x+c*y+u*d,s[7]=n*f+c*N+u*z,s[8]=n*v+c*b+u*k,this},mulScale:function(t,i,s,h,e){var a=e||!1,o=this.elements,n=t.elements;return a?(o[0]=i*n[0],o[1]=i*n[1],o[2]=i*n[2],o[3]=s*n[3],o[4]=s*n[4],o[5]=s*n[5],o[6]=h*n[6],o[7]=h*n[7],o[8]=h*n[8]):(o[0]=n[0]*i,o[1]=n[1]*s,o[2]=n[2]*h,o[3]=n[3]*i,o[4]=n[4]*s,o[5]=n[5]*h,o[6]=n[6]*i,o[7]=n[7]*s,o[8]=n[8]*h),this},mulRotate:function(t,i,s,h,e,a){var o=a||!1,n=Tt.sin(i),r=Tt.cos(i),l=1-r,c=s*s*l+r,m=s*h*l-e*n,p=s*e*l+h*n,u=h*s*l+e*n,x=h*h*l+r,y=h*e*l-s*n,d=e*s*l-h*n,f=e*h*l+s*n,N=e*e*l+r,z=t.elements,v=z[0],b=z[3],k=z[6],A=z[1],w=z[4],g=z[7],I=z[2],M=z[5],L=z[8],S=this.elements;return o?(S[0]=c*v+m*b+p*k,S[1]=c*A+m*w+p*g,S[2]=c*I+m*M+p*L,S[3]=u*v+x*b+y*k,S[4]=u*A+x*w+y*g,S[5]=u*I+x*M+y*L,S[6]=d*v+f*b+N*k,S[7]=d*A+f*w+N*g,S[8]=d*I+f*M+N*L):(S[0]=v*c+A*u+I*d,S[1]=v*m+A*x+I*f,S[2]=v*p+A*y+I*N,S[3]=b*c+w*u+M*d,S[4]=b*m+w*x+M*f,S[5]=b*p+w*y+M*N,S[6]=k*c+g*u+L*d,S[7]=k*m+g*x+L*f,S[8]=k*p+g*y+L*N),this},transpose:function(t){var i=this.elements,s=t.elements;return i[0]=s[0],i[1]=s[3],i[2]=s[6],i[3]=s[1],i[4]=s[4],i[5]=s[7],i[6]=s[2],i[7]=s[5],i[8]=s[8],this},setQuat:function(t){var i=this.elements,s=2*t.x,h=2*t.y,e=2*t.z,a=t.x*s,o=t.y*h,n=t.z*e,r=t.x*h,l=t.y*e,c=t.x*e,m=t.w*s,p=t.w*h,u=t.w*e;return i[0]=1-o-n,i[1]=r-u,i[2]=c+p,i[3]=r+u,i[4]=1-a-n,i[5]=l-m,i[6]=c-p,i[7]=l+m,i[8]=1-a-o,this},invert:function(t){var i=this.elements,s=t.elements,h=s[0],e=s[3],a=s[6],o=s[1],n=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=n*m-r*c,u=r*l-o*m,x=o*c-n*l,y=h*p+e*u+a*x;return 0!=y&&(y=1/y),i[0]=y*p,i[1]=y*u,i[2]=y*x,i[3]=y*(c*a-e*m),i[4]=y*(h*m-l*a),i[5]=y*(l*e-h*c),i[6]=y*(e*r-n*a),i[7]=y*(o*a-h*r),i[8]=y*(h*n-o*e),this},toEuler:function(){function t(t){return Tt.min(Tt.max(t,-1),1)}var s=this.elements,h=s[0],e=s[3],a=s[6],o=s[4],n=s[7],r=s[5],l=s[8],c=new i;return c.y=Tt.asin(t(a)),Tt.abs(a)<.99999?(c.x=Tt.atan2(-n,l),c.z=Tt.atan2(-e,h)):(c.x=Tt.atan2(r,o),c.z=0),c},toString:function(){var t=this.elements,i="Mat33|"+t[0].toFixed(4)+", "+t[1].toFixed(4)+", "+t[2].toFixed(4)+"|\n     |"+t[3].toFixed(4)+", "+t[4].toFixed(4)+", "+t[5].toFixed(4)+"|\n     |"+t[6].toFixed(4)+", "+t[7].toFixed(4)+", "+t[8].toFixed(4)+"|";return i},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}};var Tt={sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(t,i,s){return(1-s)*t+s*i},randInt:function(t,i){return t+Tt.floor(Tt.random()*(i-t+1))},rand:function(t,i){return t+Tt.random()*(i-t)},int:function(t){return Tt.floor(t)},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,s){return Tt.max(i,Tt.min(s,t))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,distance:function(t,i){var s=i[0]-t[0],h=i[1]-t[1],e=i[2]-t[2];return Tt.sqrt(s*s+h*h+e*e)},EulerToAxis:function(t,i,s){var h=Tt.cos(.5*i),e=Tt.sin(.5*i),a=Tt.cos(.5*s),o=Tt.sin(.5*s),n=Tt.cos(.5*t),r=Tt.sin(.5*t),l=h*a,c=e*o,m=l*n-c*r,p=l*r+c*n,u=e*a*n+h*o*r,x=h*o*n-e*a*r,y=2*Tt.acos(m),d=p*p+u*u+x*x;return d<.001?(p=1,u=x=0):(d=Tt.sqrt(d),p/=d,u/=d,x/=d),[y,p,u,x]},EulerToMatrix:function(t,i,s){var e=Tt.cos(i),a=Tt.sin(i),o=Tt.cos(s),n=Tt.sin(s),r=Tt.cos(t),l=Tt.sin(t),c=new h,m=c.elements;return m[0]=e*o,m[1]=a*l-e*n*r,m[2]=e*n*l+a*r,m[3]=n,m[4]=o*r,m[5]=-o*l,m[6]=-a*o,m[7]=a*n*r+e*l,m[8]=-a*n*l+e*r,c},MatrixToEuler:function(t){var i,s,h,e=t.elements;return e[3]>.998?(s=Tt.atan2(e[2],e[8]),h=Tt.PI/2,i=0):e[3]<-.998?(s=Tt.atan2(e[2],e[8]),h=-Tt.PI/2,i=0):(s=Tt.atan2(-e[6],e[0]),i=Tt.atan2(-e[5],e[4]),h=Tt.asin(e[3])),[i,s,h]},unwrapDegrees:function(t){return t%=360,t>180&&(t-=360),t<-180&&(t+=360),t},unwrapRadian:function(t){return t%=Tt.TwoPI,t>Tt.PI&&(t-=Tt.TwoPI),t<-Tt.PI&&(t+=Tt.TwoPI),t},acosClamp:function(t){return t>1?0:t<-1?Tt.PI:Tt.acos(t)}};a.prototype={setTime:function(t){this.times[t||0]=performance.now()},setBroadPhase:function(){this.times[2]=performance.now(),this.broadPhaseTime=this.times[2]-this.times[1]},setNarrowPhase:function(){this.times[3]=performance.now(),this.narrowPhaseTime=this.times[3]-this.times[2]},end:function(){this.times[2]=performance.now(),this.solvingTime=this.times[2]-this.times[1],this.totalTime=this.times[2]-this.times[0],this.upfps()},upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},updatingTime:function(){return Tt.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){var t=["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+Tt.fix(this.broadPhaseTime)+"<br>","narrow-phase "+Tt.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+Tt.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+Tt.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n");return t},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime(),this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},o.prototype={constructor:o,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}},n.prototype={constructor:n,setPosition:function(t){this.body.setPosition(t)},setQuaternion:function(t){this.body.setQuaternion(t)},setRotation:function(t){this.body.setRotation(t)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(t,i,s){this.body.resetPosition(t,i,s)},resetRotation:function(t,i,s){this.body.resetRotation(t,i,s)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(t){this.body.checkContact(t)}},r.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],r.DefaultOrder="XYZ",r.prototype={constructor:r,_x:0,_y:0,_z:0,_order:r.DefaultOrder,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get order(){return this._order},set order(t){this._order=t,this.onChangeCallback()},set:function(t,i,s,h){return this._x=t,this._y=i,this._z=s,this._order=h||this._order,this.onChangeCallback(),this},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,i){var s=t.elements,h=s[0],e=s[1],a=s[2],o=s[3],n=s[4],r=s[5],l=s[6],c=s[7],m=s[8];return i=i||this._order,"XYZ"===i?(this._y=Tt.asin(Tt.clamp(a,-1,1)),Tt.abs(a)<.99999?(this._x=Tt.atan2(-r,m),this._z=Tt.atan2(-e,h)):(this._x=Tt.atan2(c,n),this._z=0)):"YXZ"===i?(this._x=Tt.asin(-Tt.clamp(r,-1,1)),Tt.abs(r)<.99999?(this._y=Tt.atan2(a,m),this._z=Tt.atan2(o,n)):(this._y=Tt.atan2(-l,h),this._z=0)):"ZXY"===i?(this._x=Tt.asin(Tt.clamp(c,-1,1)),Tt.abs(c)<.99999?(this._y=Tt.atan2(-l,m),this._z=Tt.atan2(-e,n)):(this._y=0,this._z=Tt.atan2(o,h))):"ZYX"===i?(this._y=Tt.asin(-Tt.clamp(l,-1,1)),Tt.abs(l)<.99999?(this._x=Tt.atan2(c,m),this._z=Tt.atan2(o,h)):(this._x=0,this._z=Tt.atan2(-e,n))):"YZX"===i?(this._z=Tt.asin(Tt.clamp(o,-1,1)),Tt.abs(o)<.99999?(this._x=Tt.atan2(-r,n),this._y=Tt.atan2(-l,h)):(this._x=0,this._y=Tt.atan2(a,m))):"XZY"===i?(this._z=Tt.asin(-Tt.clamp(e,-1,1)),Tt.abs(e)<.99999?(this._x=Tt.atan2(c,n),this._y=Tt.atan2(a,h)):(this._x=Tt.atan2(-r,m),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+i),this._order=i,this.onChangeCallback(),this},setFromQuaternion:function(t,i,s){var h=t.x*t.x,e=t.y*t.y,a=t.z*t.z,o=t.w*t.w;return i=i||this._order,"XYZ"===i?(this._x=Tt.atan2(2*(t.x*t.w-t.y*t.z),o-h-e+a),this._y=Tt.asin(Tt.clamp(2*(t.x*t.z+t.y*t.w),-1,1)),this._z=Tt.atan2(2*(t.z*t.w-t.x*t.y),o+h-e-a)):"YXZ"===i?(this._x=Tt.asin(Tt.clamp(2*(t.x*t.w-t.y*t.z),-1,1)),this._y=Tt.atan2(2*(t.x*t.z+t.y*t.w),o-h-e+a),this._z=Tt.atan2(2*(t.x*t.y+t.z*t.w),o-h+e-a)):"ZXY"===i?(this._x=Tt.asin(Tt.clamp(2*(t.x*t.w+t.y*t.z),-1,1)),this._y=Tt.atan2(2*(t.y*t.w-t.z*t.x),o-h-e+a),this._z=Tt.atan2(2*(t.z*t.w-t.x*t.y),o-h+e-a)):"ZYX"===i?(this._x=Tt.atan2(2*(t.x*t.w+t.z*t.y),o-h-e+a),this._y=Tt.asin(Tt.clamp(2*(t.y*t.w-t.x*t.z),-1,1)),this._z=Tt.atan2(2*(t.x*t.y+t.z*t.w),o+h-e-a)):"YZX"===i?(this._x=Tt.atan2(2*(t.x*t.w-t.z*t.y),o-h+e-a),this._y=Tt.atan2(2*(t.y*t.w-t.x*t.z),o+h-e-a),this._z=Tt.asin(Tt.clamp(2*(t.x*t.y+t.z*t.w),-1,1))):"XZY"===i?(this._x=Tt.atan2(2*(t.x*t.w+t.y*t.z),o-h+e-a),this._y=Tt.atan2(2*(t.x*t.z+t.y*t.w),o+h-e-a),this._z=Tt.asin(Tt.clamp(2*(t.z*t.w-t.x*t.y),-1,1))):console.warn("_Math.Euler: .setFromQuaternion() given unsupported order: "+i),this._order=i,s!==!1&&this.onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){},clone:function(){return new r(this._x,this._y,this._z,this._order)}},l.prototype={constructor:l,set:function(t,i,s,h,e,a,o,n,r,l,c,m,p,u,x,y){var d=this.elements;return d[0]=t,d[4]=i,d[8]=s,d[12]=h,d[1]=e,d[5]=a,d[9]=o,d[13]=n,d[2]=r,d[6]=l,d[10]=c,d[14]=m,d[3]=p,d[7]=u,d[11]=x,d[15]=y,this}},c.prototype={constructor:c,set:function(t,i,s,h,e,a){var o=this.elements;return o[0]=t,o[3]=i,o[1]=s,o[4]=h,o[2]=e,o[5]=a,this},intersectTest:function(t){var i=this.elements,s=t.elements;return i[0]>s[3]||i[1]>s[4]||i[2]>s[5]||i[3]<s[0]||i[4]<s[1]||i[5]<s[2]},intersectTestTwo:function(t){var i=this.elements,s=t.elements;return i[0]<s[0]||i[1]<s[1]||i[2]<s[2]||i[3]>s[3]||i[4]>s[4]||i[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var s=i||0,h=t.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var s=t.elements,h=i.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],s=t[4]-t[1],h=t[5]-t[2];return 2*(i*(s+h)+s*h)},intersectsWithPoint:function(t,i,s){var h=this.elements;return t>=h[0]&&t<=h[3]&&i>=h[1]&&i<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(Tt.min(i[0],t.x),Tt.min(i[1],t.y),Tt.min(i[2],t.z),Tt.max(i[3],t.x),Tt.max(i[4],t.y),Tt.max(i[5],t.z))},expandByScalar:function(t){var i=this.elements;i[0]+=-t,i[1]+=-t,i[2]+=-t,i[3]+=t,i[4]+=t,i[5]+=t}};var Xt=0;p.prototype={constructor:p,update:function(){e("Proxy","Inheritance error.")}},u.prototype=Object.create(p.prototype),u.prototype.constructor=u,u.prototype.update=function(){},y.prototype={constructor:y,createProxy:function(t){e("BroadPhase","Inheritance error.")},addProxy:function(t){e("BroadPhase","Inheritance error.")},removeProxy:function(t){e("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var s=t.parent,h=i.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!==e;){var a=e.joint;if(!a.allowCollision&&(a.body1==s&&a.body2==h||a.body1==h&&a.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){e("BroadPhase","Inheritance error.")},addPair:function(t,i){var s=new x(t,i);this.pairs.push(s),this.numPairs++}},d.prototype=Object.create(y.prototype),d.prototype.constructor=d,d.prototype.createProxy=function(t){return new u(t)},d.prototype.addProxy=function(t){this.proxies.push(t)},d.prototype.removeProxy=function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},d.prototype.collectPairs=function(){var t,i,s,h=0,e=this.proxies,a=e.length;for(this.numPairChecks=a*(a-1)>>1;h<a;)for(i=e[h++],t=h+1;t<a;)s=e[t++],!i.aabb.intersectTest(s.aabb)&&this.isAvailablePair(i.shape,s.shape)&&this.addPair(i.shape,s.shape)},N.prototype={constructor:N,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null==this.root)return void(this.root=t);for(var i,s,h=t.aabb,e=this.root;null==e.proxy;){var a=e.child1,o=e.child2,n=e.aabb,r=a.aabb,l=o.aabb;i=n.surfaceArea(),this.aabb.combine(h,n),s=this.aabb.surfaceArea();var c=2*s,m=2*(s-i),p=m;this.aabb.combine(h,r),p+=null!=a.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-r.surfaceArea();var u=m;if(this.aabb.combine(h,l),u+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea(),p<u){if(c<p)break;e=a}else{if(c<u)break;e=o}}var x,y=e.parent;x=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new f,x.parent=y,x.child1=t,x.child2=e,x.aabb.combine(t.aabb,e.aabb),x.height=e.height+1,e.parent=x,t.parent=x,e==this.root?this.root=x:y.child1==e?y.child1=x:y.child2=x;do x=this.balance(x),this.fix(x),x=x.parent;while(null!=x)},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t==this.root)return void(this.root=null);var i,s=t.parent;if(i=s.child1==t?s.child2:s.child1,s==this.root)return this.root=i,void(i.parent=null);var h=s.parent;i.parent=h,h.child1==s?h.child1=i:h.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do h=this.balance(h),this.fix(h),h=h.parent;while(null!=h)},balance:function(t){var i=t.height;if(i<2)return t;var s,h=t.parent,e=t.child1,a=t.child2,o=e.height,n=a.height,r=o-n;if(r>1){var l=e.child1,c=e.child2,m=l.height,p=c.height;return m>p?(e.child2=t,t.parent=e,t.child1=c,c.parent=t,t.aabb.combine(c.aabb,a.aabb),s=p-n,t.height=p-(s&s>>31)+1,e.aabb.combine(l.aabb,t.aabb),s=m-i,e.height=m-(s&s>>31)+1):(e.child1=t,t.parent=e,t.child1=l,l.parent=t,t.aabb.combine(l.aabb,a.aabb),s=m-n,t.height=m-(s&s>>31)+1,e.aabb.combine(t.aabb,c.aabb),s=i-p,e.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(r<-1){var u=a.child1,x=a.child2,y=u.height,d=x.height;return y>d?(a.child2=t,t.parent=a,t.child2=x,x.parent=t,t.aabb.combine(e.aabb,x.aabb),s=o-d,t.height=o-(s&s>>31)+1,a.aabb.combine(u.aabb,t.aabb),s=y-i,a.height=y-(s&s>>31)+1):(a.child1=t,t.parent=a,t.child2=u,u.parent=t,t.aabb.combine(e.aabb,u.aabb),s=o-y,t.height=o-(s&s>>31)+1,a.aabb.combine(t.aabb,x.aabb),s=i-d,a.height=i-(s&s>>31)+1),null!=h?h.child1==t?h.child1=a:h.child2=a:this.root=a,a.parent=h,a}return t},fix:function(t){var i=t.child1,s=t.child2;t.aabb.combine(i.aabb,s.aabb),t.height=i.height<s.height?s.height+1:i.height+1}},z.prototype=Object.create(p.prototype),z.prototype.constructor=z,z.prototype.update=function(){},v.prototype=Object.create(y.prototype),v.prototype.constructor=v,v.prototype.createProxy=function(t){return new z(t)},v.prototype.addProxy=function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},v.prototype.removeProxy=function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},v.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var t,i=.1,s=this.numLeaves;s--;)t=this.leaves[s],t.proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,i),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},v.prototype.collide=function(t,i){var s,h,e,a,o,n,r=2;for(this.stack[0]=t,this.stack[1]=i;r>0;)if(e=this.stack[--r],a=this.stack[--r],o=null!=e.proxy,n=null!=a.proxy,this.numPairChecks++,o&&n){if(s=e.proxy.shape,h=a.proxy.shape,s==h||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(a.aabb))continue;n||!o&&e.aabb.surfaceArea()>a.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=a,this.stack[r++]=e.child2,this.stack[r++]=a):(this.stack[r++]=e,this.stack[r++]=a.child1,this.stack[r++]=e,this.stack[r++]=a.child2)}},b.prototype={constructor:b,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var s=-1,h=-1,e=0,a=this.numElements;e<a;e++){var o=this.elements[e];if(o==t||o==i){if(s!=-1){h=e;break}s=e}}for(e=s+1,a=h;e<a;e++)this.elements[e-1]=this.elements[e];for(e=h+1,a=this.numElements;e<a;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var s=!1,h=this.elements,e=1,a=this.numElements;e<a;e++){var o=h[e],n=o.value,r=h[e-1];if(r.value>n){var l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);if(h[l]=o,t+=e-l,t>i){s=!0;break}}}if(s){t=2;var c=this.stack;for(c[0]=0,c[1]=this.numElements-1;t>0;){var m=c[--t],p=c[--t],u=m-p;if(u>16){var x=p+Tt.floor(.5*u);for(o=h[x],h[x]=h[m],h[m]=o,n=o.value,e=p-1,l=m;;){var y,d;do y=h[++e];while(y.value<n);do d=h[--l];while(n<d.value&&l!=p);if(e>=l)break;h[e]=d,h[l]=y}h[m]=h[e],h[e]=o,e-p>m-e?(c[t++]=p,c[t++]=e-1,c[t++]=e+1,c[t++]=m):(c[t++]=e+1,c[t++]=m,c[t++]=p,c[t++]=e-1)}else for(e=p+1;e<=m;e++)if(o=h[e],n=o.value,r=h[e-1],r.value>n){l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);h[l]=o}}}},calculateTestCount:function(){for(var t=1,i=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?t--:(i+=t,t++);return i}},A.prototype=Object.create(p.prototype),A.prototype.constructor=A,A.prototype.isDynamic=function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},A.prototype.update=function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},w.prototype=Object.create(y.prototype),w.prototype.constructor=w,w.prototype.createProxy=function(t){return new A(this,t)},w.prototype.addProxy=function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},w.prototype.removeProxy=function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},w.prototype.collectPairs=function(){if(0!=this.numElementsD){var t=this.axesD[this.index1],i=this.axesD[this.index2];t.sort(),i.sort();var s,h,e=t.calculateTestCount(),a=i.calculateTestCount();e<=a?(i=this.axesS[this.index1],i.sort(),s=t.elements,h=i.elements):(t=this.axesS[this.index2],t.sort(),s=i.elements,h=t.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var o,n,r=0,l=0;r<this.numElementsD;){var c,m;if(l==this.numElementsS)c=s[r],m=!0,r++;else{var p=s[r],u=h[l];p.value<u.value?(c=p,m=!0,r++):(c=u,m=!1,l++)}if(c.max){var x=c.pair;if(m){if(x==o){o=o.pair;continue}c=o}else{if(x==n){n=n.pair;continue}c=n}do{if(v=c.pair,v==x){c.pair=v.pair;break}c=v}while(null!=c)}else{for(var y=c.proxy.shape,d=c.min1.value,f=c.max1.value,N=c.min2.value,z=c.max2.value,v=o;null!=v;v=v.pair){var b=v.proxy.shape;this.numPairChecks++,d>v.max1.value||f<v.min1.value||N>v.max2.value||z<v.min2.value||!this.isAvailablePair(y,b)||this.addPair(y,b)}if(m){for(v=n;null!=v;v=v.pair)b=v.proxy.shape,this.numPairChecks++,d>v.max1.value||f<v.min1.value||N>v.max2.value||z<v.min2.value||!this.isAvailablePair(y,b)||this.addPair(y,b);c.pair=o,o=c}else c.pair=n,n=c}}this.index2=3^(this.index1|this.index2)}},g.prototype={constructor:g,detectCollision:function(t,i,s){e("CollisionDetector","Inheritance error.")}},I.prototype=Object.create(g.prototype),I.prototype.constructor=I,I.prototype.detectCollision=function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var a,o,n,r,l,c,m,p,u,x,y,d,f,N,z,v,b,k,A,w,g,I,M,L,S,P,V,T,X,Y,Z,C,D,_,U,E,q=h.elements,F=e.elements,j=h.dimentions,R=e.dimentions,B=h.position,O=e.position,J=B.x,H=B.y,W=B.z,Q=O.x,G=O.y,K=O.z,$=Q-J,tt=G-H,it=K-W,st=h.halfWidth,ht=h.halfHeight,et=h.halfDepth,at=e.halfWidth,ot=e.halfHeight,nt=e.halfDepth,rt=j[0],lt=j[1],ct=j[2],mt=j[3],pt=j[4],ut=j[5],xt=j[6],yt=j[7],dt=j[8],ft=j[9],Nt=j[10],zt=j[11],vt=j[12],bt=j[13],kt=j[14],At=j[15],wt=j[16],gt=j[17],It=R[0],Mt=R[1],Lt=R[2],St=R[3],Pt=R[4],Vt=R[5],Xt=R[6],Yt=R[7],Zt=R[8],Ct=R[9],Dt=R[10],_t=R[11],Ut=R[12],Et=R[13],qt=R[14],Ft=R[15],jt=R[16],Rt=R[17],Bt=lt*Lt-ct*Mt,Ot=ct*It-rt*Lt,Jt=rt*Mt-lt*It,Ht=lt*Vt-ct*Pt,Wt=ct*St-rt*Vt,Qt=rt*Pt-lt*St,Gt=lt*Zt-ct*Yt,Kt=ct*Xt-rt*Zt,$t=rt*Yt-lt*Xt,ti=pt*Lt-ut*Mt,ii=ut*It-mt*Lt,si=mt*Mt-pt*It,hi=pt*Vt-ut*Pt,ei=ut*St-mt*Vt,ai=mt*Pt-pt*St,oi=pt*Zt-ut*Yt,ni=ut*Xt-mt*Zt,ri=mt*Yt-pt*Xt,li=yt*Lt-dt*Mt,ci=dt*It-xt*Lt,mi=xt*Mt-yt*It,pi=yt*Vt-dt*Pt,ui=dt*St-xt*Vt,xi=xt*Pt-yt*St,yi=yt*Zt-dt*Yt,di=dt*Xt-xt*Zt,fi=xt*Yt-yt*Xt,Ni=!1,zi=!1,vi=!1,bi=!1,ki=!1,Ai=!1,wi=!1,gi=!1,Ii=!1;if(Z=rt*$+lt*tt+ct*it,a=Z>0,a||(Z=-Z),C=st,_=rt*It+lt*Mt+ct*Lt,U=rt*St+lt*Pt+ct*Vt,E=rt*Xt+lt*Yt+ct*Zt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),D=_*at+U*ot+E*nt,v=Z-C-D,!(v>0||(Z=mt*$+pt*tt+ut*it,o=Z>0,o||(Z=-Z),C=ht,_=mt*It+pt*Mt+ut*Lt,U=mt*St+pt*Pt+ut*Vt,E=mt*Xt+pt*Yt+ut*Zt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),D=_*at+U*ot+E*nt,b=Z-C-D,b>0||(Z=xt*$+yt*tt+dt*it,n=Z>0,n||(Z=-Z),C=et,_=xt*It+yt*Mt+dt*Lt,U=xt*St+yt*Pt+dt*Vt,E=xt*Xt+yt*Yt+dt*Zt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),D=_*at+U*ot+E*nt,k=Z-C-D,k>0||(Z=It*$+Mt*tt+Lt*it,r=Z>0,r||(Z=-Z),_=It*rt+Mt*lt+Lt*ct,U=It*mt+Mt*pt+Lt*ut,E=It*xt+Mt*yt+Lt*dt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),C=_*st+U*ht+E*et,D=at,A=1*(Z-C-D),A>0||(Z=St*$+Pt*tt+Vt*it,l=Z>0,l||(Z=-Z),_=St*rt+Pt*lt+Vt*ct,U=St*mt+Pt*pt+Vt*ut,E=St*xt+Pt*yt+Vt*dt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),C=_*st+U*ht+E*et,D=ot,w=1*(Z-C-D),w>0||(Z=Xt*$+Yt*tt+Zt*it,c=Z>0,c||(Z=-Z),_=Xt*rt+Yt*lt+Zt*ct,U=Xt*mt+Yt*pt+Zt*ut,E=Xt*xt+Yt*yt+Zt*dt,_<0&&(_=-_),U<0&&(U=-U),E<0&&(E=-E),C=_*st+U*ht+E*et,D=nt,g=1*(Z-C-D),g>0))))))){if(Z=Bt*Bt+Ot*Ot+Jt*Jt,Z>1e-5){if(Z=1/Tt.sqrt(Z),Bt*=Z,Ot*=Z,Jt*=Z,Z=Bt*$+Ot*tt+Jt*it,m=Z>0,m||(Z=-Z),_=Bt*mt+Ot*pt+Jt*ut,U=Bt*xt+Ot*yt+Jt*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*ht+U*et,_=Bt*St+Ot*Pt+Jt*Vt,U=Bt*Xt+Ot*Yt+Jt*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*ot+U*nt,I=Z-C-D,I>0)return}else m=!1,I=0,Ni=!0;if(Z=Ht*Ht+Wt*Wt+Qt*Qt,Z>1e-5){if(Z=1/Tt.sqrt(Z),Ht*=Z,Wt*=Z,Qt*=Z,Z=Ht*$+Wt*tt+Qt*it,p=Z>0,p||(Z=-Z),_=Ht*mt+Wt*pt+Qt*ut,U=Ht*xt+Wt*yt+Qt*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*ht+U*et,_=Ht*It+Wt*Mt+Qt*Lt,U=Ht*Xt+Wt*Yt+Qt*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*nt,M=Z-C-D,M>0)return}else p=!1,M=0,zi=!0;if(Z=Gt*Gt+Kt*Kt+$t*$t,Z>1e-5){if(Z=1/Tt.sqrt(Z),Gt*=Z,Kt*=Z,$t*=Z,Z=Gt*$+Kt*tt+$t*it,u=Z>0,u||(Z=-Z),_=Gt*mt+Kt*pt+$t*ut,U=Gt*xt+Kt*yt+$t*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*ht+U*et,_=Gt*It+Kt*Mt+$t*Lt,U=Gt*St+Kt*Pt+$t*Vt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*ot,L=Z-C-D,L>0)return}else u=!1,L=0,vi=!0;if(Z=ti*ti+ii*ii+si*si,Z>1e-5){if(Z=1/Tt.sqrt(Z),ti*=Z,ii*=Z,si*=Z,Z=ti*$+ii*tt+si*it,x=Z>0,x||(Z=-Z),_=ti*rt+ii*lt+si*ct,U=ti*xt+ii*yt+si*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*et,_=ti*St+ii*Pt+si*Vt,U=ti*Xt+ii*Yt+si*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*ot+U*nt,S=Z-C-D,S>0)return}else x=!1,S=0,bi=!0;if(Z=hi*hi+ei*ei+ai*ai,Z>1e-5){if(Z=1/Tt.sqrt(Z),hi*=Z,ei*=Z,ai*=Z,Z=hi*$+ei*tt+ai*it,y=Z>0,y||(Z=-Z),_=hi*rt+ei*lt+ai*ct,U=hi*xt+ei*yt+ai*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*et,_=hi*It+ei*Mt+ai*Lt,U=hi*Xt+ei*Yt+ai*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*nt,P=Z-C-D,P>0)return}else y=!1,P=0,ki=!0;if(Z=oi*oi+ni*ni+ri*ri,Z>1e-5){if(Z=1/Tt.sqrt(Z),oi*=Z,ni*=Z,ri*=Z,Z=oi*$+ni*tt+ri*it,d=Z>0,d||(Z=-Z),_=oi*rt+ni*lt+ri*ct,U=oi*xt+ni*yt+ri*dt,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*et,_=oi*It+ni*Mt+ri*Lt,U=oi*St+ni*Pt+ri*Vt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*ot,V=Z-C-D,V>0)return}else d=!1,V=0,Ai=!0;if(Z=li*li+ci*ci+mi*mi,Z>1e-5){if(Z=1/Tt.sqrt(Z),li*=Z,ci*=Z,mi*=Z,Z=li*$+ci*tt+mi*it,f=Z>0,f||(Z=-Z),_=li*rt+ci*lt+mi*ct,U=li*mt+ci*pt+mi*ut,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*ht,_=li*St+ci*Pt+mi*Vt,U=li*Xt+ci*Yt+mi*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*ot+U*nt,T=Z-C-D,T>0)return}else f=!1,T=0,wi=!0;if(Z=pi*pi+ui*ui+xi*xi,Z>1e-5){if(Z=1/Tt.sqrt(Z),pi*=Z,ui*=Z,xi*=Z,Z=pi*$+ui*tt+xi*it,N=Z>0,N||(Z=-Z),_=pi*rt+ui*lt+xi*ct,U=pi*mt+ui*pt+xi*ut,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*ht,_=pi*It+ui*Mt+xi*Lt,U=pi*Xt+ui*Yt+xi*Zt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*nt,X=Z-C-D,X>0)return}else N=!1,X=0,gi=!0;if(Z=yi*yi+di*di+fi*fi,Z>1e-5){if(Z=1/Tt.sqrt(Z),yi*=Z,di*=Z,fi*=Z,Z=yi*$+di*tt+fi*it,z=Z>0,z||(Z=-Z),_=yi*rt+di*lt+fi*ct,U=yi*mt+di*pt+fi*ut,_<0&&(_=-_),U<0&&(U=-U),C=_*st+U*ht,_=yi*It+di*Mt+fi*Lt,U=yi*St+di*Pt+fi*Vt,_<0&&(_=-_),U<0&&(U=-U),D=_*at+U*ot,Y=Z-C-D,Y>0)return}else z=!1,Y=0,Ii=!0;var Mi=v,Li=v,Si=0,Pi=a;b>Li&&(Mi=b,Li=b,Si=1,Pi=o),k>Li&&(Mi=k,Li=k,Si=2,Pi=n),A>Li&&(Mi=A,Li=A,Si=3,Pi=r),w>Li&&(Mi=w,Li=w,Si=4,Pi=l),g>Li&&(Mi=g,Li=g,Si=5,Pi=c),I-.01>Li&&!Ni&&(Mi=I,Li=I-.01,Si=6,Pi=m),M-.01>Li&&!zi&&(Mi=M,Li=M-.01,Si=7,Pi=p),L-.01>Li&&!vi&&(Mi=L,Li=L-.01,Si=8,Pi=u),S-.01>Li&&!bi&&(Mi=S,Li=S-.01,Si=9,Pi=x),P-.01>Li&&!ki&&(Mi=P,Li=P-.01,Si=10,Pi=y),V-.01>Li&&!Ai&&(Mi=V,Li=V-.01,Si=11,Pi=d),T-.01>Li&&!wi&&(Mi=T,Li=T-.01,Si=12,Pi=f),X-.01>Li&&!gi&&(Mi=X,Li=X-.01,Si=13,Pi=N),Y-.01>Li&&!Ii&&(Mi=Y,Si=14,Pi=z);var Vi=0,Ti=0,Xi=0,Yi=0,Zi=0,Ci=0,Di=0,_i=0,Ui=0,Ei=0,qi=0,Fi=0,ji=0,Ri=0,Bi=0,Oi=0,Ji=0,Hi=0,Wi=!1;if(0==Si?(Pi?(Ei=J+ft,qi=H+Nt,Fi=W+zt,Vi=rt,Ti=lt,Xi=ct):(Ei=J-ft,qi=H-Nt,Fi=W-zt,Vi=-rt,Ti=-lt,Xi=-ct),ji=vt,Ri=bt,Bi=kt,Yi=-mt,Zi=-pt,Ci=-ut,Oi=At,Ji=wt,Hi=gt,Di=-xt,_i=-yt,Ui=-dt):1==Si?(Pi?(Ei=J+vt,qi=H+bt,Fi=W+kt,Vi=mt,Ti=pt,Xi=ut):(Ei=J-vt,qi=H-bt,Fi=W-kt,Vi=-mt,Ti=-pt,Xi=-ut),ji=ft,Ri=Nt,Bi=zt,Yi=-rt,Zi=-lt,Ci=-ct,Oi=At,Ji=wt,Hi=gt,Di=-xt,_i=-yt,Ui=-dt):2==Si?(Pi?(Ei=J+At,qi=H+wt,Fi=W+gt,Vi=xt,Ti=yt,Xi=dt):(Ei=J-At,qi=H-wt,Fi=W-gt,Vi=-xt,Ti=-yt,Xi=-dt),ji=ft,Ri=Nt,Bi=zt,Yi=-rt,Zi=-lt,Ci=-ct,Oi=vt,Ji=bt,Hi=kt,Di=-mt,_i=-pt,Ui=-ut):3==Si?(Wi=!0,Pi?(Ei=Q-Ct,qi=G-Dt,Fi=K-_t,Vi=-It,Ti=-Mt,Xi=-Lt):(Ei=Q+Ct,qi=G+Dt,Fi=K+_t,Vi=It,Ti=Mt,Xi=Lt),ji=Ut,Ri=Et,Bi=qt,Yi=-St,Zi=-Pt,Ci=-Vt,Oi=Ft,Ji=jt,Hi=Rt,Di=-Xt,_i=-Yt,Ui=-Zt):4==Si?(Wi=!0,Pi?(Ei=Q-Ut,qi=G-Et,Fi=K-qt,Vi=-St,Ti=-Pt,Xi=-Vt):(Ei=Q+Ut,qi=G+Et,Fi=K+qt,Vi=St,Ti=Pt,Xi=Vt),ji=Ct,Ri=Dt,Bi=_t,Yi=-It,Zi=-Mt,Ci=-Lt,Oi=Ft,Ji=jt,Hi=Rt,Di=-Xt,_i=-Yt,Ui=-Zt):5==Si?(Wi=!0,Pi?(Ei=Q-Ft,qi=G-jt,Fi=K-Rt,Vi=-Xt,Ti=-Yt,Xi=-Zt):(Ei=Q+Ft,qi=G+jt,Fi=K+Rt,Vi=Xt,Ti=Yt,Xi=Zt),ji=Ct,Ri=Dt,Bi=_t,Yi=-It,Zi=-Mt,Ci=-Lt,Oi=Ut,Ji=Et,Hi=qt,Di=-St,_i=-Pt,Ui=-Vt):6==Si?(Vi=Bt,Ti=Ot,Xi=Jt,Yi=rt,Zi=lt,Ci=ct,Di=It,_i=Mt,Ui=Lt):7==Si?(Vi=Ht,Ti=Wt,Xi=Qt,Yi=rt,Zi=lt,Ci=ct,Di=St,_i=Pt,Ui=Vt):8==Si?(Vi=Gt,Ti=Kt,Xi=$t,Yi=rt,Zi=lt,Ci=ct,Di=Xt,_i=Yt,Ui=Zt):9==Si?(Vi=ti,Ti=ii,Xi=si,Yi=mt,Zi=pt,Ci=ut,Di=It,_i=Mt,Ui=Lt):10==Si?(Vi=hi,Ti=ei,Xi=ai,Yi=mt,Zi=pt,Ci=ut,Di=St,_i=Pt,Ui=Vt):11==Si?(Vi=oi,Ti=ni,Xi=ri,Yi=mt,Zi=pt,Ci=ut,Di=Xt,_i=Yt,Ui=Zt):12==Si?(Vi=li,Ti=ci,Xi=mi,Yi=xt,Zi=yt,Ci=dt,Di=It,_i=Mt,Ui=Lt):13==Si?(Vi=pi,Ti=ui,Xi=xi,Yi=xt,Zi=yt,Ci=dt,Di=St,_i=Pt,Ui=Vt):14==Si&&(Vi=yi,Ti=di,Xi=fi,Yi=xt,Zi=yt,Ci=dt,Di=Xt,_i=Yt,Ui=Zt),Si>5){Pi||(Vi=-Vi,Ti=-Ti,Xi=-Xi);var Qi,Gi,Ki,$i,ts,is,ss,hs,es,as,os;is=q[0],ss=q[1],hs=q[2],Gi=Vi*is+Ti*ss+Xi*hs,Ki=q[3],$i=q[4],ts=q[5],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[6],$i=q[7],ts=q[8],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[9],$i=q[10],ts=q[11],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[12],$i=q[13],ts=q[14],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[15],$i=q[16],ts=q[17],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[18],$i=q[19],ts=q[20],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=q[21],$i=q[22],ts=q[23],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),es=F[0],as=F[1],os=F[2],Gi=Vi*es+Ti*as+Xi*os,Ki=F[3],$i=F[4],ts=F[5],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[6],$i=F[7],ts=F[8],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[9],$i=F[10],ts=F[11],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[12],$i=F[13],ts=F[14],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[15],$i=F[16],ts=F[17],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[18],$i=F[19],ts=F[20],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=F[21],$i=F[22],ts=F[23],Qi=Vi*Ki+Ti*$i+Xi*ts,Qi<Gi&&(Gi=Qi,es=Ki,as=$i,os=ts),Ki=es-is,$i=as-ss,ts=os-hs,_=Yi*Di+Zi*_i+Ci*Ui;var ns=(Ki*(Yi-Di*_)+$i*(Zi-_i*_)+ts*(Ci-Ui*_))/(1-_*_);return void s.addPoint(is+Yi*ns+Vi*Mi*.5,ss+Zi*ns+Ti*Mi*.5,hs+Ci*ns+Xi*Mi*.5,Vi,Ti,Xi,Mi,!1)}var rs,ls,cs,ms,ps,us,xs,ys,ds,fs,Ns,zs,vs=1,bs=0,ks=0;Wi?(bs=rt*Vi+lt*Ti+ct*Xi,bs<vs&&(vs=bs,ks=0),-bs<vs&&(vs=-bs,ks=1),bs=mt*Vi+pt*Ti+ut*Xi,bs<vs&&(vs=bs,ks=2),-bs<vs&&(vs=-bs,ks=3),bs=xt*Vi+yt*Ti+dt*Xi,bs<vs&&(vs=bs,ks=4),-bs<vs&&(vs=-bs,ks=5),0==ks?(rs=q[0],ls=q[1],cs=q[2],ms=q[6],ps=q[7],us=q[8],xs=q[9],ys=q[10],ds=q[11],fs=q[3],Ns=q[4],zs=q[5]):1==ks?(rs=q[15],ls=q[16],cs=q[17],ms=q[21],ps=q[22],us=q[23],xs=q[18],ys=q[19],ds=q[20],fs=q[12],Ns=q[13],zs=q[14]):2==ks?(rs=q[12],ls=q[13],cs=q[14],ms=q[0],ps=q[1],us=q[2],xs=q[3],ys=q[4],ds=q[5],fs=q[15],Ns=q[16],zs=q[17]):3==ks?(rs=q[21],ls=q[22],cs=q[23],ms=q[9],ps=q[10],us=q[11],xs=q[6],ys=q[7],ds=q[8],fs=q[18],Ns=q[19],zs=q[20]):4==ks?(rs=q[12],ls=q[13],cs=q[14],ms=q[18],ps=q[19],us=q[20],xs=q[6],ys=q[7],ds=q[8],fs=q[0],Ns=q[1],zs=q[2]):5==ks&&(rs=q[3],ls=q[4],cs=q[5],ms=q[6],ps=q[7],us=q[8],xs=q[21],ys=q[22],ds=q[23],fs=q[15],Ns=q[16],zs=q[17])):(bs=It*Vi+Mt*Ti+Lt*Xi,bs<vs&&(vs=bs,ks=0),-bs<vs&&(vs=-bs,ks=1),bs=St*Vi+Pt*Ti+Vt*Xi,bs<vs&&(vs=bs,ks=2),-bs<vs&&(vs=-bs,ks=3),bs=Xt*Vi+Yt*Ti+Zt*Xi,bs<vs&&(vs=bs,ks=4),-bs<vs&&(vs=-bs,ks=5),0==ks?(rs=F[0],ls=F[1],cs=F[2],ms=F[6],ps=F[7],us=F[8],xs=F[9],ys=F[10],ds=F[11],fs=F[3],Ns=F[4],zs=F[5]):1==ks?(rs=F[15],ls=F[16],cs=F[17],ms=F[21],ps=F[22],us=F[23],xs=F[18],ys=F[19],ds=F[20],
fs=F[12],Ns=F[13],zs=F[14]):2==ks?(rs=F[12],ls=F[13],cs=F[14],ms=F[0],ps=F[1],us=F[2],xs=F[3],ys=F[4],ds=F[5],fs=F[15],Ns=F[16],zs=F[17]):3==ks?(rs=F[21],ls=F[22],cs=F[23],ms=F[9],ps=F[10],us=F[11],xs=F[6],ys=F[7],ds=F[8],fs=F[18],Ns=F[19],zs=F[20]):4==ks?(rs=F[12],ls=F[13],cs=F[14],ms=F[18],ps=F[19],us=F[20],xs=F[6],ys=F[7],ds=F[8],fs=F[0],Ns=F[1],zs=F[2]):5==ks&&(rs=F[3],ls=F[4],cs=F[5],ms=F[9],ps=F[10],us=F[11],xs=F[21],ys=F[22],ds=F[23],fs=F[15],Ns=F[16],zs=F[17]));var As,ws,gs,Is,Ms,Ls,Ss,Ps,Vs;this.clipVertices1[0]=rs,this.clipVertices1[1]=ls,this.clipVertices1[2]=cs,this.clipVertices1[3]=ms,this.clipVertices1[4]=ps,this.clipVertices1[5]=us,this.clipVertices1[6]=xs,this.clipVertices1[7]=ys,this.clipVertices1[8]=ds,this.clipVertices1[9]=fs,this.clipVertices1[10]=Ns,this.clipVertices1[11]=zs,ws=0,Is=this.clipVertices1[9],Ms=this.clipVertices1[10],Ls=this.clipVertices1[11],_=(Is-Ei-ji)*Yi+(Ms-qi-Ri)*Zi+(Ls-Fi-Bi)*Ci;for(var Ts=0;Ts<4;Ts++)gs=3*Ts,Ss=this.clipVertices1[gs],Ps=this.clipVertices1[gs+1],Vs=this.clipVertices1[gs+2],U=(Ss-Ei-ji)*Yi+(Ps-qi-Ri)*Zi+(Vs-Fi-Bi)*Ci,_>0?U>0?(gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Vs):(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Vs-Ls)*ns):U>0&&(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Vs-Ls)*ns,gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Vs),Is=Ss,Ms=Ps,Ls=Vs,_=U;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Ls=this.clipVertices2[gs+2],_=(Is-Ei-Oi)*Di+(Ms-qi-Ji)*_i+(Ls-Fi-Hi)*Ui,Ts=0;Ts<As;Ts++)gs=3*Ts,Ss=this.clipVertices2[gs],Ps=this.clipVertices2[gs+1],Vs=this.clipVertices2[gs+2],U=(Ss-Ei-Oi)*Di+(Ps-qi-Ji)*_i+(Vs-Fi-Hi)*Ui,_>0?U>0?(gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Vs):(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Vs-Ls)*ns):U>0&&(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Vs-Ls)*ns,gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Vs),Is=Ss,Ms=Ps,Ls=Vs,_=U;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],_=(Is-Ei+ji)*-Yi+(Ms-qi+Ri)*-Zi+(Ls-Fi+Bi)*-Ci,Ts=0;Ts<As;Ts++)gs=3*Ts,Ss=this.clipVertices1[gs],Ps=this.clipVertices1[gs+1],Vs=this.clipVertices1[gs+2],U=(Ss-Ei+ji)*-Yi+(Ps-qi+Ri)*-Zi+(Vs-Fi+Bi)*-Ci,_>0?U>0?(gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Vs):(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Vs-Ls)*ns):U>0&&(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Vs-Ls)*ns,gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Vs),Is=Ss,Ms=Ps,Ls=Vs,_=U;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Ls=this.clipVertices2[gs+2],_=(Is-Ei+Oi)*-Di+(Ms-qi+Ji)*-_i+(Ls-Fi+Hi)*-Ui,Ts=0;Ts<As;Ts++)gs=3*Ts,Ss=this.clipVertices2[gs],Ps=this.clipVertices2[gs+1],Vs=this.clipVertices2[gs+2],U=(Ss-Ei+Oi)*-Di+(Ps-qi+Ji)*-_i+(Vs-Fi+Hi)*-Ui,_>0?U>0?(gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Vs):(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Vs-Ls)*ns):U>0&&(gs=3*ws,ws++,ns=_/(_-U),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Vs-Ls)*ns,gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Vs),Is=Ss,Ms=Ps,Ls=Vs,_=U;if(As=ws,Wi){var Xs=h;h=e,e=Xs}if(0!=As){var Ys=h!=t;if(As>4){Is=.25*(rs+ms+xs+fs),Ms=.25*(ls+ps+ys+Ns),Ls=.25*(cs+us+ds+zs),Yi=rs-Is,Zi=ls-Ms,Ci=cs-Ls,Di=ms-Is,_i=ps-Ms,Ui=us-Ls;var Zs=0,Cs=0,Ds=0,_s=0,Us=-this.INF;for(vs=this.INF,Ts=0;Ts<As;Ts++)this.used[Ts]=!1,gs=3*Ts,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=Is*Yi+Ms*Zi+Ls*Ci,bs<vs&&(vs=bs,Zs=Ts),bs>Us&&(Us=bs,Ds=Ts);for(this.used[Zs]=!0,this.used[Ds]=!0,Us=-this.INF,vs=this.INF,Ts=0;Ts<As;Ts++)this.used[Ts]||(gs=3*Ts,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=Is*Di+Ms*_i+Ls*Ui,bs<vs&&(vs=bs,Cs=Ts),bs>Us&&(Us=bs,_s=Ts));gs=3*Zs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=(Is-Ei)*Vi+(Ms-qi)*Ti+(Ls-Fi)*Xi,bs<0&&s.addPoint(Is,Ms,Ls,Vi,Ti,Xi,bs,Ys),gs=3*Cs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=(Is-Ei)*Vi+(Ms-qi)*Ti+(Ls-Fi)*Xi,bs<0&&s.addPoint(Is,Ms,Ls,Vi,Ti,Xi,bs,Ys),gs=3*Ds,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=(Is-Ei)*Vi+(Ms-qi)*Ti+(Ls-Fi)*Xi,bs<0&&s.addPoint(Is,Ms,Ls,Vi,Ti,Xi,bs,Ys),gs=3*_s,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=(Is-Ei)*Vi+(Ms-qi)*Ti+(Ls-Fi)*Xi,bs<0&&s.addPoint(Is,Ms,Ls,Vi,Ti,Xi,bs,Ys)}else for(Ts=0;Ts<As;Ts++)gs=3*Ts,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],bs=(Is-Ei)*Vi+(Ms-qi)*Ti+(Ls-Fi)*Xi,bs<0&&s.addPoint(Is,Ms,Ls,Vi,Ti,Xi,bs,Ys)}}}}}},M.prototype=Object.create(g.prototype),M.prototype.constructor=M,M.prototype.getSep=function(t,s,h,e,a){var o,n,r,l,c,m,p,u,x,y,d,f,N,z=new i,v=t.position.x,b=t.position.y,k=t.position.z,A=s.position.x,w=s.position.y,g=s.position.z,I=A-v,M=w-b,L=g-k;I*I+M*M+L*L==0&&(M=.001);var S=-I,P=-M,V=-L;this.supportPointB(t,-S,-P,-V,z);var T=z.x,X=z.y,Y=z.z;this.supportPointC(s,S,P,V,z);var Z=z.x,C=z.y,D=z.z,_=Z-T,U=C-X,E=D-Y;if(_*S+U*P+E*V<=0)return!1;if(S=U*L-E*M,P=E*I-_*L,V=_*M-U*I,S*S+P*P+V*V==0)return h.init(_-I,U-M,E-L),h.normalize(h),e.init(.5*(T+Z),.5*(X+C),.5*(Y+D)),!0;this.supportPointB(t,-S,-P,-V,z);var q=z.x,F=z.y,j=z.z;this.supportPointC(s,S,P,V,z);var R=z.x,B=z.y,O=z.z,J=R-q,H=B-F,W=O-j;if(J*S+H*P+W*V<=0)return!1;o=_-I,n=U-M,r=E-L,l=J-I,c=H-M,m=W-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l,S*I+P*M+V*L>0&&(o=_,n=U,r=E,_=J,U=H,E=W,J=o,H=n,W=r,o=T,n=X,r=Y,T=q,X=F,Y=j,q=o,F=n,j=r,o=Z,n=C,r=D,Z=R,C=B,D=O,R=o,B=n,O=r,S=-S,P=-P,V=-V);for(var Q=0;;){if(++Q>100)return!1;this.supportPointB(t,-S,-P,-V,z);var G=z.x,K=z.y,$=z.z;this.supportPointC(s,S,P,V,z);var tt=z.x,it=z.y,st=z.z,ht=tt-G,et=it-K,at=st-$;if(ht*S+et*P+at*V<=0)return!1;if((U*at-E*et)*I+(E*ht-_*at)*M+(_*et-U*ht)*L<0)J=ht,H=et,W=at,q=G,F=K,j=$,R=tt,B=it,O=st,o=_-I,n=U-M,r=E-L,l=ht-I,c=et-M,m=at-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l;else if((et*W-at*H)*I+(at*J-ht*W)*M+(ht*H-et*J)*L<0)_=ht,U=et,E=at,T=G,X=K,Y=$,Z=tt,C=it,D=st,o=ht-I,n=et-M,r=at-L,l=J-I,c=H-M,m=W-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l;else for(var ot=!1;;){if(o=J-_,n=H-U,r=W-E,l=ht-_,c=et-U,m=at-E,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l,p=1/Tt.sqrt(S*S+P*P+V*V),S*=p,P*=p,V*=p,S*_+P*U+V*E>=0&&!ot){var nt=(U*W-E*H)*ht+(E*J-_*W)*et+(_*H-U*J)*at,rt=(et*W-at*H)*I+(at*J-ht*W)*M+(ht*H-et*J)*L,lt=(M*E-L*U)*ht+(L*_-I*E)*et+(I*U-M*_)*at,ct=(H*E-W*U)*I+(W*_-J*E)*M+(J*U-H*_)*L,mt=nt+rt+lt+ct;mt<=0&&(nt=0,rt=(H*at-W*et)*S+(W*ht-J*at)*P+(J*et-H*ht)*V,lt=(et*W-at*H)*S+(at*J-ht*W)*P+(ht*H-et*J)*V,ct=(U*W-E*H)*S+(E*J-_*W)*P+(_*H-U*J)*V,mt=rt+lt+ct);var pt=1/mt;u=(v*nt+T*rt+q*lt+G*ct)*pt,x=(b*nt+X*rt+F*lt+K*ct)*pt,y=(k*nt+Y*rt+j*lt+$*ct)*pt,d=(A*nt+Z*rt+R*lt+tt*ct)*pt,f=(w*nt+C*rt+B*lt+it*ct)*pt,N=(g*nt+D*rt+O*lt+st*ct)*pt,ot=!0}this.supportPointB(t,-S,-P,-V,z);var ut=z.x,xt=z.y,yt=z.z;this.supportPointC(s,S,P,V,z);var dt=z.x,ft=z.y,Nt=z.z,zt=dt-ut,vt=ft-xt,bt=Nt-yt,kt=-(zt*S+vt*P+bt*V);if((zt-ht)*S+(vt-et)*P+(bt-at)*V<=.01||kt>=0)return!!ot&&(h.init(-S,-P,-V),e.init(.5*(u+d),.5*(x+f),.5*(y+N)),a.x=kt,!0);(vt*E-bt*U)*I+(bt*_-zt*E)*M+(zt*U-vt*_)*L<0?(vt*W-bt*H)*I+(bt*J-zt*W)*M+(zt*H-vt*J)*L<0?(_=zt,U=vt,E=bt,T=ut,X=xt,Y=yt,Z=dt,C=ft,D=Nt):(ht=zt,et=vt,at=bt,G=ut,K=xt,$=yt,tt=dt,it=ft,st=Nt):(vt*at-bt*et)*I+(bt*ht-zt*at)*M+(zt*et-vt*ht)*L<0?(J=zt,H=vt,W=bt,q=ut,F=xt,j=yt,R=dt,B=ft,O=Nt):(_=zt,U=vt,E=bt,T=ut,X=xt,Y=yt,Z=dt,C=ft,D=Nt)}}},M.prototype.supportPointB=function(t,i,s,h,e){var a,o,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=t.halfWidth,u=t.halfHeight,x=t.halfDepth;a=l<0?-p:p,o=c<0?-u:u,n=m<0?-x:x,l=r[0]*a+r[1]*o+r[2]*n+t.position.x,c=r[3]*a+r[4]*o+r[5]*n+t.position.y,m=r[6]*a+r[7]*o+r[8]*n+t.position.z,e.init(l,c,m)},M.prototype.supportPointC=function(t,i,s,h,e){var a,o,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,u=m,x=p*p+u*u,y=t.radius,d=t.halfHeight;0==x?c<0?(a=y,o=-d,n=0):(a=y,o=d,n=0):(x=t.radius/Tt.sqrt(x),c<0?(a=p*x,o=-d,n=u*x):(a=p*x,o=d,n=u*x)),l=r[0]*a+r[1]*o+r[2]*n+t.position.x,c=r[3]*a+r[4]*o+r[5]*n+t.position.y,m=r[6]*a+r[7]*o+r[8]*n+t.position.z,e.init(l,c,m)},M.prototype.detectCollision=function(t,s,h){var e,a;this.flip?(e=s,a=t):(e=t,a=s);var o=new i,n=new i,r=new i;if(this.getSep(e,a,o,n,r)){var l=e.position.x,c=e.position.y,m=e.position.z,p=a.position.x,u=a.position.y,x=a.position.z,y=e.halfWidth,d=e.halfHeight,f=e.halfDepth,N=a.halfHeight,z=a.radius,v=e.dimentions,b=v[0],k=v[1],A=v[2],w=v[3],g=v[4],I=v[5],M=v[6],L=v[7],S=v[8],P=v[9],V=v[10],T=v[11],X=v[12],Y=v[13],Z=v[14],C=v[15],D=v[16],_=v[17],U=a.normalDirection.x,E=a.normalDirection.y,q=a.normalDirection.z,F=a.halfDirection.x,j=a.halfDirection.y,R=a.halfDirection.z,B=o.x,O=o.y,J=o.z,H=B*b+O*k+J*A,W=B*w+O*g+J*I,Q=B*M+O*L+J*S,G=B*U+O*E+J*q,K=H>0,$=W>0,tt=Q>0,it=G>0;K||(H=-H),$||(W=-W),tt||(Q=-Q),it||(G=-G);var st=0;G>.999?st=H>.999?H>G?1:4:W>.999?W>G?2:4:Q>.999&&Q>G?3:4:H>.999?st=1:W>.999?st=2:Q>.999&&(st=3);var ht,et,at,ot,nt,rt,lt,ct,mt,pt,ut,xt,yt,dt,ft,Nt,zt,vt,bt,kt,At,wt,gt,It,Mt,Lt,St,Pt,Vt,Xt,Yt,Zt,Ct,Dt,_t,Ut,Et,qt,Ft,jt,Rt,Bt,Ot,Jt,Ht,Wt,Qt,Gt,Kt,$t,ti,ii,si;if(0==st)h.addPoint(n.x,n.y,n.z,B,O,J,r.x,this.flip);else if(4==st){it?(ot=p-F,nt=u-j,rt=x-R,B=-U,O=-E,J=-q):(ot=p+F,nt=u+j,rt=x+R,B=U,O=E,J=q);var hi,ei,ai,oi,ni,ri,li,ci,mi,pi,ui,xi;kt=1,st=0,Ot=b*B+k*O+A*J,Ot<kt&&(kt=Ot,st=0),-Ot<kt&&(kt=-Ot,st=1),Ot=w*B+g*O+I*J,Ot<kt&&(kt=Ot,st=2),-Ot<kt&&(kt=-Ot,st=3),Ot=M*B+L*O+S*J,Ot<kt&&(kt=Ot,st=4),-Ot<kt&&(kt=-Ot,st=5);var yi=e.elements;switch(st){case 0:hi=yi[0],ei=yi[1],ai=yi[2],oi=yi[6],ni=yi[7],ri=yi[8],li=yi[9],ci=yi[10],mi=yi[11],pi=yi[3],ui=yi[4],xi=yi[5];break;case 1:hi=yi[15],ei=yi[16],ai=yi[17],oi=yi[21],ni=yi[22],ri=yi[23],li=yi[18],ci=yi[19],mi=yi[20],pi=yi[12],ui=yi[13],xi=yi[14];break;case 2:hi=yi[12],ei=yi[13],ai=yi[14],oi=yi[0],ni=yi[1],ri=yi[2],li=yi[3],ci=yi[4],mi=yi[5],pi=yi[15],ui=yi[16],xi=yi[17];break;case 3:hi=yi[21],ei=yi[22],ai=yi[23],oi=yi[9],ni=yi[10],ri=yi[11],li=yi[6],ci=yi[7],mi=yi[8],pi=yi[18],ui=yi[19],xi=yi[20];break;case 4:hi=yi[12],ei=yi[13],ai=yi[14],oi=yi[18],ni=yi[19],ri=yi[20],li=yi[6],ci=yi[7],mi=yi[8],pi=yi[0],ui=yi[1],xi=yi[2];break;case 5:hi=yi[3],ei=yi[4],ai=yi[5],oi=yi[9],ni=yi[10],ri=yi[11],li=yi[21],ci=yi[22],mi=yi[23],pi=yi[15],ui=yi[16],xi=yi[17]}bt=B*(hi-ot)+O*(ei-nt)+J*(ai-rt),bt<=0&&h.addPoint(hi,ei,ai,-B,-O,-J,bt,this.flip),bt=B*(oi-ot)+O*(ni-nt)+J*(ri-rt),bt<=0&&h.addPoint(oi,ni,ri,-B,-O,-J,bt,this.flip),bt=B*(li-ot)+O*(ci-nt)+J*(mi-rt),bt<=0&&h.addPoint(li,ci,mi,-B,-O,-J,bt,this.flip),bt=B*(pi-ot)+O*(ui-nt)+J*(xi-rt),bt<=0&&h.addPoint(pi,ui,xi,-B,-O,-J,bt,this.flip)}else{switch(st){case 1:K?(ht=l+P,et=c+V,at=m+T,B=b,O=k,J=A):(ht=l-P,et=c-V,at=m-T,B=-b,O=-k,J=-A),Wt=w,Qt=g,Gt=I,ii=d,Kt=M,$t=L,ti=S,si=f;break;case 2:$?(ht=l+X,et=c+Y,at=m+Z,B=w,O=g,J=I):(ht=l-X,et=c-Y,at=m-Z,B=-w,O=-g,J=-I),Wt=b,Qt=k,Gt=A,ii=y,Kt=M,$t=L,ti=S,si=f;break;case 3:tt?(ht=l+C,et=c+D,at=m+_,B=M,O=L,J=S):(ht=l-C,et=c-D,at=m-_,B=-M,O=-L,J=-S),Wt=b,Qt=k,Gt=A,ii=y,Kt=w,$t=g,ti=I,si=d}if(kt=B*U+O*E+J*q,At=kt<0?N:-N,ot=p+At*U,nt=u+At*E,rt=x+At*q,G>=.999999?(wt=-O,gt=J,It=B):(wt=B,gt=O,It=J),At=wt*U+gt*E+It*q,Lt=At*U-wt,St=At*E-gt,Pt=At*q-It,At=Tt.sqrt(Lt*Lt+St*St+Pt*Pt),0==At)return;if(At=z/At,Lt*=At,St*=At,Pt*=At,wt=ot+Lt,gt=nt+St,It=rt+Pt,kt<-.96||kt>.96)lt=U*U*1.5-.5,ct=U*E*1.5-.866025403*q,mt=U*q*1.5+.866025403*E,pt=E*U*1.5+.866025403*q,ut=E*E*1.5-.5,xt=E*q*1.5-.866025403*U,yt=q*U*1.5-.866025403*E,dt=q*E*1.5+.866025403*U,ft=q*q*1.5-.5,Nt=wt,zt=gt,vt=It,bt=B*(Nt-ht)+O*(zt-et)+J*(vt-at),wt=Nt-bt*B-ht,gt=zt-bt*O-et,It=vt-bt*J-at,qt=Wt*wt+Qt*gt+Gt*It,Bt=Kt*wt+$t*gt+ti*It,qt<-ii?qt=-ii:qt>ii&&(qt=ii),Bt<-si?Bt=-si:Bt>si&&(Bt=si),wt=qt*Wt+Bt*Kt,gt=qt*Qt+Bt*$t,It=qt*Gt+Bt*ti,Nt=ht+wt,zt=et+gt,vt=at+It,h.addPoint(Nt,zt,vt,B,O,J,bt,this.flip),Nt=Lt*lt+St*ct+Pt*mt,zt=Lt*pt+St*ut+Pt*xt,vt=Lt*yt+St*dt+Pt*ft,Nt=(Lt=Nt)+ot,zt=(St=zt)+nt,vt=(Pt=vt)+rt,bt=B*(Nt-ht)+O*(zt-et)+J*(vt-at),bt<=0&&(wt=Nt-bt*B-ht,gt=zt-bt*O-et,It=vt-bt*J-at,qt=Wt*wt+Qt*gt+Gt*It,Bt=Kt*wt+$t*gt+ti*It,qt<-ii?qt=-ii:qt>ii&&(qt=ii),Bt<-si?Bt=-si:Bt>si&&(Bt=si),wt=qt*Wt+Bt*Kt,gt=qt*Qt+Bt*$t,It=qt*Gt+Bt*ti,Nt=ht+wt,zt=et+gt,vt=at+It,h.addPoint(Nt,zt,vt,B,O,J,bt,this.flip)),Nt=Lt*lt+St*ct+Pt*mt,zt=Lt*pt+St*ut+Pt*xt,vt=Lt*yt+St*dt+Pt*ft,Nt=(Lt=Nt)+ot,zt=(St=zt)+nt,vt=(Pt=vt)+rt,bt=B*(Nt-ht)+O*(zt-et)+J*(vt-at),bt<=0&&(wt=Nt-bt*B-ht,gt=zt-bt*O-et,It=vt-bt*J-at,qt=Wt*wt+Qt*gt+Gt*It,Bt=Kt*wt+$t*gt+ti*It,qt<-ii?qt=-ii:qt>ii&&(qt=ii),Bt<-si?Bt=-si:Bt>si&&(Bt=si),wt=qt*Wt+Bt*Kt,gt=qt*Qt+Bt*$t,It=qt*Gt+Bt*ti,Nt=ht+wt,zt=et+gt,vt=at+It,h.addPoint(Nt,zt,vt,B,O,J,bt,this.flip));else{if(_t=wt,Ut=gt,Et=It,qt=B*(_t-ht)+O*(Ut-et)+J*(Et-at),_t-=qt*B,Ut-=qt*O,Et-=qt*J,kt>0?(Ft=wt+2*F,jt=gt+2*j,Rt=It+2*R):(Ft=wt-2*F,jt=gt-2*j,Rt=It-2*R),Bt=B*(Ft-ht)+O*(jt-et)+J*(Rt-at),Ft-=Bt*B,jt-=Bt*O,Rt-=Bt*J,Vt=_t-ht,Xt=Ut-et,Yt=Et-at,Zt=Ft-ht,Ct=jt-et,Dt=Rt-at,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt,H=Vt*Wt+Xt*Qt+Yt*Gt,W=Zt*Wt+Ct*Qt+Dt*Gt,Ot=H-ii,Jt=W-ii,Ot>0){if(Jt>0)return;Ht=Ot/(Ot-Jt),_t+=wt*Ht,Ut+=gt*Ht,Et+=It*Ht,qt+=Mt*Ht,Vt=_t-ht,Xt=Ut-et,Yt=Et-at,H=Vt*Wt+Xt*Qt+Yt*Gt,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt}else Jt>0&&(Ht=Ot/(Ot-Jt),Ft=_t+wt*Ht,jt=Ut+gt*Ht,Rt=Et+It*Ht,Bt=qt+Mt*Ht,Zt=Ft-ht,Ct=jt-et,Dt=Rt-at,W=Zt*Wt+Ct*Qt+Dt*Gt,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt);if(Ot=H+ii,Jt=W+ii,Ot<0){if(Jt<0)return;Ht=Ot/(Ot-Jt),_t+=wt*Ht,Ut+=gt*Ht,Et+=It*Ht,qt+=Mt*Ht,Vt=_t-ht,Xt=Ut-et,Yt=Et-at,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt}else Jt<0&&(Ht=Ot/(Ot-Jt),Ft=_t+wt*Ht,jt=Ut+gt*Ht,Rt=Et+It*Ht,Bt=qt+Mt*Ht,Zt=Ft-ht,Ct=jt-et,Dt=Rt-at,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt);if(H=Vt*Kt+Xt*$t+Yt*ti,W=Zt*Kt+Ct*$t+Dt*ti,Ot=H-si,Jt=W-si,Ot>0){if(Jt>0)return;Ht=Ot/(Ot-Jt),_t+=wt*Ht,Ut+=gt*Ht,Et+=It*Ht,qt+=Mt*Ht,Vt=_t-ht,Xt=Ut-et,Yt=Et-at,H=Vt*Kt+Xt*$t+Yt*ti,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt}else Jt>0&&(Ht=Ot/(Ot-Jt),Ft=_t+wt*Ht,jt=Ut+gt*Ht,Rt=Et+It*Ht,Bt=qt+Mt*Ht,Zt=Ft-ht,Ct=jt-et,Dt=Rt-at,W=Zt*Kt+Ct*$t+Dt*ti,wt=Ft-_t,gt=jt-Ut,It=Rt-Et,Mt=Bt-qt);if(Ot=H+si,Jt=W+si,Ot<0){if(Jt<0)return;Ht=Ot/(Ot-Jt),_t+=wt*Ht,Ut+=gt*Ht,Et+=It*Ht,qt+=Mt*Ht}else Jt<0&&(Ht=Ot/(Ot-Jt),Ft=_t+wt*Ht,jt=Ut+gt*Ht,Rt=Et+It*Ht,Bt=qt+Mt*Ht);qt<0&&h.addPoint(_t,Ut,Et,B,O,J,qt,this.flip),Bt<0&&h.addPoint(Ft,jt,Rt,B,O,J,Bt,this.flip)}}}},L.prototype=Object.create(g.prototype),L.prototype.constructor=L,L.prototype.getSep=function(t,s,h,e,a){var o,n,r,l,c,m,p,u,x,y,d,f,N,z=new i,v=t.position.x,b=t.position.y,k=t.position.z,A=s.position.x,w=s.position.y,g=s.position.z,I=A-v,M=w-b,L=g-k;I*I+M*M+L*L==0&&(M=.001);var S=-I,P=-M,V=-L;this.supportPoint(t,-S,-P,-V,z);var T=z.x,X=z.y,Y=z.z;this.supportPoint(s,S,P,V,z);var Z=z.x,C=z.y,D=z.z,_=Z-T,U=C-X,E=D-Y;if(_*S+U*P+E*V<=0)return!1;if(S=U*L-E*M,P=E*I-_*L,V=_*M-U*I,S*S+P*P+V*V==0)return h.init(_-I,U-M,E-L),h.normalize(h),e.init(.5*(T+Z),.5*(X+C),.5*(Y+D)),!0;this.supportPoint(t,-S,-P,-V,z);var q=z.x,F=z.y,j=z.z;this.supportPoint(s,S,P,V,z);var R=z.x,B=z.y,O=z.z,J=R-q,H=B-F,W=O-j;if(J*S+H*P+W*V<=0)return!1;o=_-I,n=U-M,r=E-L,l=J-I,c=H-M,m=W-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l,S*I+P*M+V*L>0&&(o=_,n=U,r=E,_=J,U=H,E=W,J=o,H=n,W=r,o=T,n=X,r=Y,T=q,X=F,Y=j,q=o,F=n,j=r,o=Z,n=C,r=D,Z=R,C=B,D=O,R=o,B=n,O=r,S=-S,P=-P,V=-V);for(var Q=0;;){if(++Q>100)return!1;this.supportPoint(t,-S,-P,-V,z);var G=z.x,K=z.y,$=z.z;this.supportPoint(s,S,P,V,z);var tt=z.x,it=z.y,st=z.z,ht=tt-G,et=it-K,at=st-$;if(ht*S+et*P+at*V<=0)return!1;if((U*at-E*et)*I+(E*ht-_*at)*M+(_*et-U*ht)*L<0)J=ht,H=et,W=at,q=G,F=K,j=$,R=tt,B=it,O=st,o=_-I,n=U-M,r=E-L,l=ht-I,c=et-M,m=at-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l;else if((et*W-at*H)*I+(at*J-ht*W)*M+(ht*H-et*J)*L<0)_=ht,U=et,E=at,T=G,X=K,Y=$,Z=tt,C=it,D=st,o=ht-I,n=et-M,r=at-L,l=J-I,c=H-M,m=W-L,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l;else for(var ot=!1;;){if(o=J-_,n=H-U,r=W-E,l=ht-_,c=et-U,m=at-E,S=n*m-r*c,P=r*l-o*m,V=o*c-n*l,p=1/Tt.sqrt(S*S+P*P+V*V),S*=p,P*=p,V*=p,S*_+P*U+V*E>=0&&!ot){var nt=(U*W-E*H)*ht+(E*J-_*W)*et+(_*H-U*J)*at,rt=(et*W-at*H)*I+(at*J-ht*W)*M+(ht*H-et*J)*L,lt=(M*E-L*U)*ht+(L*_-I*E)*et+(I*U-M*_)*at,ct=(H*E-W*U)*I+(W*_-J*E)*M+(J*U-H*_)*L,mt=nt+rt+lt+ct;mt<=0&&(nt=0,rt=(H*at-W*et)*S+(W*ht-J*at)*P+(J*et-H*ht)*V,lt=(et*W-at*H)*S+(at*J-ht*W)*P+(ht*H-et*J)*V,ct=(U*W-E*H)*S+(E*J-_*W)*P+(_*H-U*J)*V,mt=rt+lt+ct);var pt=1/mt;u=(v*nt+T*rt+q*lt+G*ct)*pt,x=(b*nt+X*rt+F*lt+K*ct)*pt,y=(k*nt+Y*rt+j*lt+$*ct)*pt,d=(A*nt+Z*rt+R*lt+tt*ct)*pt,f=(w*nt+C*rt+B*lt+it*ct)*pt,N=(g*nt+D*rt+O*lt+st*ct)*pt,ot=!0}this.supportPoint(t,-S,-P,-V,z);var ut=z.x,xt=z.y,yt=z.z;this.supportPoint(s,S,P,V,z);var dt=z.x,ft=z.y,Nt=z.z,zt=dt-ut,vt=ft-xt,bt=Nt-yt,kt=-(zt*S+vt*P+bt*V);if((zt-ht)*S+(vt-et)*P+(bt-at)*V<=.01||kt>=0)return!!ot&&(h.init(-S,-P,-V),e.init(.5*(u+d),.5*(x+f),.5*(y+N)),a.x=kt,!0);(vt*E-bt*U)*I+(bt*_-zt*E)*M+(zt*U-vt*_)*L<0?(vt*W-bt*H)*I+(bt*J-zt*W)*M+(zt*H-vt*J)*L<0?(_=zt,U=vt,E=bt,T=ut,X=xt,Y=yt,Z=dt,C=ft,D=Nt):(ht=zt,et=vt,at=bt,G=ut,K=xt,$=yt,tt=dt,it=ft,st=Nt):(vt*at-bt*et)*I+(bt*ht-zt*at)*M+(zt*et-vt*ht)*L<0?(J=zt,H=vt,W=bt,q=ut,F=xt,j=yt,R=dt,B=ft,O=Nt):(_=zt,U=vt,E=bt,T=ut,X=xt,Y=yt,Z=dt,C=ft,D=Nt)}}},L.prototype.supportPoint=function(t,i,s,h,e){var a,o,n,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=l,u=m,x=p*p+u*u,y=t.radius,d=t.halfHeight;0==x?c<0?(a=y,o=-d,n=0):(a=y,o=d,n=0):(x=t.radius/Tt.sqrt(x),c<0?(a=p*x,o=-d,n=u*x):(a=p*x,o=d,n=u*x)),l=r[0]*a+r[1]*o+r[2]*n+t.position.x,c=r[3]*a+r[4]*o+r[5]*n+t.position.y,m=r[6]*a+r[7]*o+r[8]*n+t.position.z,e.init(l,c,m)},L.prototype.detectCollision=function(t,s,h){var e,a;t.id<s.id?(e=t,a=s):(e=s,a=t);var o,n,r,l,c,m,p,u,x,y,d,f,N,z,v,b,k,A,w,g,I,M=e.position,L=a.position,S=M.x,P=M.y,V=M.z,T=L.x,X=L.y,Y=L.z,Z=e.halfHeight,C=a.halfHeight,D=e.normalDirection,_=a.normalDirection,U=e.halfDirection,E=a.halfDirection,q=e.radius,F=a.radius,j=D.x,R=D.y,B=D.z,O=_.x,J=_.y,H=_.z,W=U.x,Q=U.y,G=U.z,K=E.x,$=E.y,tt=E.z,it=S-T,st=P-X,ht=V-Y,et=new i,at=new i,ot=new i;if(this.getSep(e,a,et,at,ot)){var nt=et.x*j+et.y*R+et.z*B,rt=et.x*O+et.y*J+et.z*H,lt=nt>0,ct=rt>0;lt||(nt=-nt),ct||(rt=-rt);var mt=0;(nt>.999||rt>.999)&&(mt=nt>rt?1:2);var pt,ut,xt,yt,dt,ft,Nt,zt,vt,bt,kt,At,wt,gt,It,Mt,Lt,St,Pt,Vt,Xt=ot.x;switch(pt=et.x,ut=et.y,xt=et.z,mt){case 0:h.addPoint(at.x,at.y,at.z,pt,ut,xt,Xt,!1);break;case 1:if(lt?(n=S+W,r=P+Q,l=V+G,pt=j,ut=R,xt=B):(n=S-W,r=P-Q,l=V-G,pt=-j,ut=-R,xt=-B),w=pt*O+ut*J+xt*H,o=w<0?C:-C,c=T+o*O,m=X+o*J,p=Y+o*H,rt>=.999999?(u=-ut,x=xt,y=pt):(u=pt,x=ut,y=xt),o=u*O+x*J+y*H,it=o*O-u,st=o*J-x,ht=o*H-y,o=Tt.sqrt(it*it+st*st+ht*ht),0==o)break;if(o=F/o,it*=o,st*=o,ht*=o,u=c+it,x=m+st,y=p+ht,w<-.96||w>.96)yt=O*O*1.5-.5,dt=O*J*1.5-.866025403*H,ft=O*H*1.5+.866025403*J,Nt=J*O*1.5+.866025403*H,zt=J*J*1.5-.5,vt=J*H*1.5-.866025403*O,bt=H*O*1.5-.866025403*J,kt=H*J*1.5+.866025403*O,At=H*H*1.5-.5,wt=u,gt=x,It=y,Mt=pt*(wt-n)+ut*(gt-r)+xt*(It-l),u=wt-Mt*pt-n,x=gt-Mt*ut-r,y=It-Mt*xt-l,o=u*u+x*x+y*y,o>q*q&&(o=q/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=n+u,gt=r+x,It=l+y,h.addPoint(wt,gt,It,pt,ut,xt,Mt,!1),wt=it*yt+st*dt+ht*ft,gt=it*Nt+st*zt+ht*vt,It=it*bt+st*kt+ht*At,wt=(it=wt)+c,gt=(st=gt)+m,It=(ht=It)+p,Mt=pt*(wt-n)+ut*(gt-r)+xt*(It-l),Mt<=0&&(u=wt-Mt*pt-n,x=gt-Mt*ut-r,y=It-Mt*xt-l,o=u*u+x*x+y*y,o>q*q&&(o=q/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=n+u,gt=r+x,It=l+y,h.addPoint(wt,gt,It,pt,ut,xt,Mt,!1)),wt=it*yt+st*dt+ht*ft,gt=it*Nt+st*zt+ht*vt,It=it*bt+st*kt+ht*At,wt=(it=wt)+c,gt=(st=gt)+m,It=(ht=It)+p,Mt=pt*(wt-n)+ut*(gt-r)+xt*(It-l),Mt<=0&&(u=wt-Mt*pt-n,x=gt-Mt*ut-r,y=It-Mt*xt-l,o=u*u+x*x+y*y,o>q*q&&(o=q/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=n+u,gt=r+x,It=l+y,h.addPoint(wt,gt,It,pt,ut,xt,Mt,!1));else{if(d=u,f=x,N=y,k=pt*(d-n)+ut*(f-r)+xt*(N-l),d-=k*pt,f-=k*ut,N-=k*xt,w>0?(z=u+O*C*2,v=x+J*C*2,b=y+H*C*2):(z=u-O*C*2,v=x-J*C*2,b=y-H*C*2),A=pt*(z-n)+ut*(v-r)+xt*(b-l),z-=A*pt,v-=A*ut,b-=A*xt,it=n-d,st=r-f,ht=l-N,u=z-d,x=v-f,y=b-N,Lt=it*it+st*st+ht*ht,St=it*u+st*x+ht*y,Pt=u*u+x*x+y*y,Vt=St*St-Pt*(Lt-q*q),Vt<0)break;Vt=Tt.sqrt(Vt),g=(St+Vt)/Pt,I=(St-Vt)/Pt,I<g&&(o=g,g=I,I=o),I>1&&(I=1),g<0&&(g=0),u=d+(z-d)*g,x=f+(v-f)*g,y=N+(b-N)*g,z=d+(z-d)*I,v=f+(v-f)*I,b=N+(b-N)*I,d=u,f=x,N=y,o=k+(A-k)*g,A=k+(A-k)*I,k=o,k<0&&h.addPoint(d,f,N,pt,ut,xt,Mt,!1),A<0&&h.addPoint(z,v,b,pt,ut,xt,Mt,!1)}break;case 2:if(ct?(c=T-K,m=X-$,p=Y-tt,pt=-O,ut=-J,xt=-H):(c=T+K,m=X+$,p=Y+tt,pt=O,ut=J,xt=H),w=pt*j+ut*R+xt*B,o=w<0?Z:-Z,n=S+o*j,r=P+o*R,l=V+o*B,nt>=.999999?(u=-ut,x=xt,y=pt):(u=pt,x=ut,y=xt),o=u*j+x*R+y*B,it=o*j-u,st=o*R-x,ht=o*B-y,o=Tt.sqrt(it*it+st*st+ht*ht),0==o)break;if(o=q/o,it*=o,st*=o,ht*=o,u=n+it,x=r+st,y=l+ht,w<-.96||w>.96)yt=j*j*1.5-.5,dt=j*R*1.5-.866025403*B,ft=j*B*1.5+.866025403*R,Nt=R*j*1.5+.866025403*B,zt=R*R*1.5-.5,vt=R*B*1.5-.866025403*j,bt=B*j*1.5-.866025403*R,kt=B*R*1.5+.866025403*j,At=B*B*1.5-.5,wt=u,gt=x,It=y,Mt=pt*(wt-c)+ut*(gt-m)+xt*(It-p),u=wt-Mt*pt-c,x=gt-Mt*ut-m,y=It-Mt*xt-p,o=u*u+x*x+y*y,o>F*F&&(o=F/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=c+u,gt=m+x,It=p+y,h.addPoint(wt,gt,It,-pt,-ut,-xt,Mt,!1),wt=it*yt+st*dt+ht*ft,gt=it*Nt+st*zt+ht*vt,It=it*bt+st*kt+ht*At,wt=(it=wt)+n,gt=(st=gt)+r,It=(ht=It)+l,Mt=pt*(wt-c)+ut*(gt-m)+xt*(It-p),Mt<=0&&(u=wt-Mt*pt-c,x=gt-Mt*ut-m,y=It-Mt*xt-p,o=u*u+x*x+y*y,o>F*F&&(o=F/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=c+u,gt=m+x,It=p+y,h.addPoint(wt,gt,It,-pt,-ut,-xt,Mt,!1)),wt=it*yt+st*dt+ht*ft,gt=it*Nt+st*zt+ht*vt,It=it*bt+st*kt+ht*At,wt=(it=wt)+n,gt=(st=gt)+r,It=(ht=It)+l,Mt=pt*(wt-c)+ut*(gt-m)+xt*(It-p),Mt<=0&&(u=wt-Mt*pt-c,x=gt-Mt*ut-m,y=It-Mt*xt-p,o=u*u+x*x+y*y,o>F*F&&(o=F/Tt.sqrt(o),u*=o,x*=o,y*=o),wt=c+u,gt=m+x,It=p+y,h.addPoint(wt,gt,It,-pt,-ut,-xt,Mt,!1));else{if(d=u,f=x,N=y,k=pt*(d-c)+ut*(f-m)+xt*(N-p),d-=k*pt,f-=k*ut,N-=k*xt,w>0?(z=u+j*Z*2,v=x+R*Z*2,b=y+B*Z*2):(z=u-j*Z*2,v=x-R*Z*2,b=y-B*Z*2),A=pt*(z-c)+ut*(v-m)+xt*(b-p),z-=A*pt,v-=A*ut,b-=A*xt,it=c-d,st=m-f,ht=p-N,u=z-d,x=v-f,y=b-N,Lt=it*it+st*st+ht*ht,St=it*u+st*x+ht*y,Pt=u*u+x*x+y*y,Vt=St*St-Pt*(Lt-F*F),Vt<0)break;Vt=Tt.sqrt(Vt),g=(St+Vt)/Pt,I=(St-Vt)/Pt,I<g&&(o=g,g=I,I=o),I>1&&(I=1),g<0&&(g=0),u=d+(z-d)*g,x=f+(v-f)*g,y=N+(b-N)*g,z=d+(z-d)*I,v=f+(v-f)*I,b=N+(b-N)*I,d=u,f=x,N=y,o=k+(A-k)*g,A=k+(A-k)*I,k=o,k<0&&h.addPoint(d,f,N,-pt,-ut,-xt,k,!1),A<0&&h.addPoint(z,v,b,-pt,-ut,-xt,A,!1)}}}},S.prototype=Object.create(g.prototype),S.prototype.constructor=S,S.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var a,o,n,r,l,c=e.dimentions,m=h.position,p=m.x,u=m.y,x=m.z,y=e.position,d=y.x,f=y.y,N=y.z,z=h.radius,v=e.halfWidth,b=e.halfHeight,k=e.halfDepth,A=p-d,w=u-f,g=x-N,I=c[0]*A+c[1]*w+c[2]*g,M=c[3]*A+c[4]*w+c[5]*g,L=c[6]*A+c[7]*w+c[8]*g,S=0;I>v?I=v:I<-v?I=-v:S=1,M>b?M=b:M<-b?M=-b:S|=2,L>k?L=k:L<-k?L=-k:S|=4,7==S?(A=I<0?v+I:v-I,w=M<0?b+M:b-M,g=L<0?k+L:k-L,A<w?A<g?(r=A-v,I<0?(I=-v,A=c[0],w=c[1],g=c[2]):(I=v,A=-c[0],w=-c[1],g=-c[2])):(r=g-k,L<0?(L=-k,A=c[6],w=c[7],g=c[8]):(L=k,A=-c[6],w=-c[7],g=-c[8])):w<g?(r=w-b,M<0?(M=-b,A=c[3],w=c[4],g=c[5]):(M=b,A=-c[3],w=-c[4],g=-c[5])):(r=g-k,L<0?(L=-k,A=c[6],w=c[7],g=c[8]):(L=k,A=-c[6],w=-c[7],g=-c[8])),a=d+I*c[0]+M*c[3]+L*c[6],o=f+I*c[1]+M*c[4]+L*c[7],n=N+I*c[2]+M*c[5]+L*c[8],s.addPoint(p+z*A,u+z*w,x+z*g,A,w,g,r-z,this.flip)):(a=d+I*c[0]+M*c[3]+L*c[6],o=f+I*c[1]+M*c[4]+L*c[7],n=N+I*c[2]+M*c[5]+L*c[8],A=a-m.x,w=o-m.y,g=n-m.z,r=A*A+w*w+g*g,r>0&&r<z*z&&(r=Tt.sqrt(r),l=1/r,A*=l,w*=l,g*=l,s.addPoint(p+z*A,u+z*w,x+z*g,A,w,g,r-z,this.flip)))},P.prototype=Object.create(g.prototype),P.prototype.constructor=P,P.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var a=h.position,o=a.x,n=a.y,r=a.z,l=e.position,c=l.x,m=l.y,p=l.z,u=e.normalDirection.x,x=e.normalDirection.y,y=e.normalDirection.z,d=h.radius,f=e.radius,N=d+f,z=e.halfHeight,v=o-c,b=n-m,k=r-p,A=v*u+b*x+k*y;if(!(A<-z-d||A>z+d)){var w=c+A*u,g=m+A*x,I=p+A*y,M=o-w,L=n-g,S=r-I,P=M*M+L*L+S*S;if(!(P>N*N)){P>f*f&&(P=f/Tt.sqrt(P),M*=P,L*=P,S*=P),A<-z?A=-z:A>z&&(A=z),w=c+A*u+M,g=m+A*x+L,I=p+A*y+S,v=w-o,b=g-n,k=I-r,P=v*v+b*b+k*k;var V;P>0&&P<d*d&&(P=Tt.sqrt(P),V=1/P,v*=V,b*=V,k*=V,s.addPoint(o+v*d,n+b*d,r+k*d,v,b,k,P-d,this.flip))}}},V.prototype=Object.create(g.prototype),V.prototype.constructor=V,V.prototype.detectCollision=function(t,i,s){var h=t,e=i,a=h.position,o=e.position,n=o.x-a.x,r=o.y-a.y,l=o.z-a.z,c=n*n+r*r+l*l,m=h.radius,p=e.radius,u=m+p;if(c>0&&c<u*u){c=Tt.sqrt(c);var x=1/c;n*=x,r*=x,l*=x,s.addPoint(a.x+n*m,a.y+r*m,a.z+l*m,n,r,l,c-u,!1)}};var Yt=0;Z.prototype={constructor:Z,calculateMassInfo:function(t){e("Shape","Inheritance error.")},updateProxy:function(){e("Shape","Inheritance error.")}},C.prototype=Object.create(Z.prototype),C.prototype.constructor=C,C.prototype.calculateMassInfo=function(t){var i=this.width*this.height*this.depth*this.density,s=1/12;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.height*this.height)*s)},C.prototype.updateProxy=function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var s=i[9],h=i[10],e=i[11],a=i[12],o=i[13],n=i[14],r=i[15],l=i[16],c=i[17],m=this.position.x,p=this.position.y,u=this.position.z,x=this.elements;x[0]=m+s+a+r,x[1]=p+h+o+l,x[2]=u+e+n+c,x[3]=m+s+a-r,x[4]=p+h+o-l,x[5]=u+e+n-c,x[6]=m+s-a+r,x[7]=p+h-o+l,x[8]=u+e-n+c,x[9]=m+s-a-r,x[10]=p+h-o-l,x[11]=u+e-n-c,x[12]=m-s+a+r,x[13]=p-h+o+l,x[14]=u-e+n+c,x[15]=m-s+a-r,x[16]=p-h+o-l,x[17]=u-e+n-c,x[18]=m-s-a+r,x[19]=p-h-o+l,x[20]=u-e-n+c,x[21]=m-s-a-r,x[22]=p-h-o-l,x[23]=u-e-n-c;var y=i[9]<0?-i[9]:i[9],d=i[10]<0?-i[10]:i[10],f=i[11]<0?-i[11]:i[11];y=i[12]<0?y-i[12]:y+i[12],d=i[13]<0?d-i[13]:d+i[13],f=i[14]<0?f-i[14]:f+i[14],y=i[15]<0?y-i[15]:y+i[15],d=i[16]<0?d-i[16]:d+i[16],f=i[17]<0?f-i[17]:f+i[17];var N=OIMO.AABB_PROX;this.aabb.set(this.position.x-y-N,this.position.x+y+N,this.position.y-d-N,this.position.y+d+N,this.position.z-f-N,this.position.z+f+N),null!=this.proxy&&this.proxy.update()},D.prototype=Object.create(Z.prototype),D.prototype.constructor=D,D.prototype.calculateMassInfo=function(t){var i=1.333*Tt.PI*this.radius*this.radius*this.radius*this.density;t.mass=i;var s=i*this.radius*this.radius*.4;t.inertia.set(s,0,0,0,s,0,0,0,s)},D.prototype.updateProxy=function(){var t=Vt;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()},_.prototype=Object.create(Z.prototype),_.prototype.constructor=_,_.prototype.calculateMassInfo=function(t){var i=this.radius*this.radius,s=Tt.PI*i*this.height*this.density,h=(.25*i+.0833*this.height*this.height)*s,e=.5*i;t.mass=s,t.inertia.set(h,0,0,0,e,0,0,0,h)},_.prototype.updateProxy=function(){var t,i,s,h,e,a,o,n,r,l,c,m=this.rotation.elements;e=m[1]*m[1],a=m[4]*m[4],o=m[7]*m[7],this.normalDirection.set(m[1],m[4],m[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-e,t=Tt.sqrt(i*i+e*a+e*o),t>0&&(t=this.radius/t),i*=t,s=1-a,t=Tt.sqrt(a*e+s*s+a*o),t>0&&(t=this.radius/t),s*=t,h=1-o,t=Tt.sqrt(o*e+o*a+h*h),t>0&&(t=this.radius/t),h*=t,n=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,r=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,l=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,n=i<0?n-i:n+i,r=s<0?r-s:r+s,l=h<0?l-h:l+h,c=Vt,this.aabb.set(this.position.x-n-c,this.position.x+n+c,this.position.y-r-c,this.position.y+r+c,this.position.z-l-c,this.position.z+l+c),null!=this.proxy&&this.proxy.update()},U.prototype={constructor:U,preSolve:function(t,i){e("Constraint","Inheritance error.")},solve:function(){e("Constraint","Inheritance error.")},postSolve:function(){e("Constraint","Inheritance error.")}},R.prototype=Object.create(U.prototype),R.prototype.constructor=R,R.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},R.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},R.prototype.preSolve=function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements,e=this.p1.x,a=this.p1.y,o=this.p1.z,n=this.p2.x,r=this.p2.y,l=this.p2.z,c=this.m1+this.m2;this.num=this.manifold.numPoints;for(var m=this.cs,p=0;p<this.num;p++){var u,x,y,d,f,N,z=this.ps[p];u=z.position.x,x=z.position.y,y=z.position.z;var v=u-e,b=x-a,k=y-o,A=u-n,w=x-r,g=y-l;m.rp1X=v,m.rp1Y=b,m.rp1Z=k,m.rp2X=A,m.rp2Y=w,m.rp2Z=g,m.norImp=z.normalImpulse,m.tanImp=z.tangentImpulse,m.binImp=z.binormalImpulse;var I=z.normal.x,M=z.normal.y,L=z.normal.z,S=this.lv2.x+this.av2.y*g-this.av2.z*w-(this.lv1.x+this.av1.y*k-this.av1.z*b),P=this.lv2.y+this.av2.z*A-this.av2.x*g-(this.lv1.y+this.av1.z*v-this.av1.x*k),V=this.lv2.z+this.av2.x*w-this.av2.y*A-(this.lv1.z+this.av1.x*b-this.av1.y*v),T=I*S+M*P+L*V,X=S-T*I,Y=P-T*M,Z=V-T*L,C=X*X+Y*Y+Z*Z;C>.04?C=1/Tt.sqrt(C):(X=M*I-L*L,Y=-L*M-I*I,Z=I*L+M*M,C=1/Tt.sqrt(X*X+Y*Y+Z*Z)),X*=C,Y*=C,Z*=C;var D=M*Z-L*Y,_=L*X-I*Z,U=I*Y-M*X;m.norX=I,m.norY=M,m.norZ=L,m.tanX=X,m.tanY=Y,m.tanZ=Z,m.binX=D,m.binY=_,m.binZ=U,m.norU1X=I*this.m1,m.norU1Y=M*this.m1,m.norU1Z=L*this.m1,m.norU2X=I*this.m2,m.norU2Y=M*this.m2,m.norU2Z=L*this.m2,m.tanU1X=X*this.m1,m.tanU1Y=Y*this.m1,m.tanU1Z=Z*this.m1,m.tanU2X=X*this.m2,m.tanU2Y=Y*this.m2,m.tanU2Z=Z*this.m2,m.binU1X=D*this.m1,m.binU1Y=_*this.m1,m.binU1Z=U*this.m1,m.binU2X=D*this.m2,m.binU2Y=_*this.m2,m.binU2Z=U*this.m2;var E=b*L-k*M,q=k*I-v*L,F=v*M-b*I,j=w*L-g*M,R=g*I-A*L,B=A*M-w*I,O=b*Z-k*Y,J=k*X-v*Z,H=v*Y-b*X,W=w*Z-g*Y,Q=g*X-A*Z,G=A*Y-w*X,K=b*U-k*_,$=k*D-v*U,tt=v*_-b*D,it=w*U-g*_,st=g*D-A*U,ht=A*_-w*D,et=E*s[0]+q*s[1]+F*s[2],at=E*s[3]+q*s[4]+F*s[5],ot=E*s[6]+q*s[7]+F*s[8],nt=j*h[0]+R*h[1]+B*h[2],rt=j*h[3]+R*h[4]+B*h[5],lt=j*h[6]+R*h[7]+B*h[8],ct=O*s[0]+J*s[1]+H*s[2],mt=O*s[3]+J*s[4]+H*s[5],pt=O*s[6]+J*s[7]+H*s[8],ut=W*h[0]+Q*h[1]+G*h[2],xt=W*h[3]+Q*h[4]+G*h[5],yt=W*h[6]+Q*h[7]+G*h[8],dt=K*s[0]+$*s[1]+tt*s[2],ft=K*s[3]+$*s[4]+tt*s[5],Nt=K*s[6]+$*s[7]+tt*s[8],zt=it*h[0]+st*h[1]+ht*h[2],vt=it*h[3]+st*h[4]+ht*h[5],bt=it*h[6]+st*h[7]+ht*h[8];m.norT1X=E,m.norT1Y=q,m.norT1Z=F,m.tanT1X=O,m.tanT1Y=J,m.tanT1Z=H,m.binT1X=K,m.binT1Y=$,m.binT1Z=tt,m.norT2X=j,m.norT2Y=R,m.norT2Z=B,m.tanT2X=W,m.tanT2Y=Q,m.tanT2Z=G,m.binT2X=it,m.binT2Y=st,m.binT2Z=ht,m.norTU1X=et,m.norTU1Y=at,m.norTU1Z=ot,m.tanTU1X=ct,m.tanTU1Y=mt,m.tanTU1Z=pt,m.binTU1X=dt,m.binTU1Y=ft,m.binTU1Z=Nt,m.norTU2X=nt,m.norTU2Y=rt,m.norTU2Z=lt,m.tanTU2X=ut,m.tanTU2Y=xt,m.tanTU2Z=yt,m.binTU2X=zt,m.binTU2Y=vt,m.binTU2Z=bt,u=E*s[0]+q*s[1]+F*s[2],x=E*s[3]+q*s[4]+F*s[5],y=E*s[6]+q*s[7]+F*s[8],d=x*k-y*b,f=y*v-u*k,N=u*b-x*v,u=j*h[0]+R*h[1]+B*h[2],x=j*h[3]+R*h[4]+B*h[5],y=j*h[6]+R*h[7]+B*h[8],d+=x*g-y*w,f+=y*A-u*g,N+=u*w-x*A;var kt=1/(c+I*d+M*f+L*N);u=O*s[0]+J*s[1]+H*s[2],x=O*s[3]+J*s[4]+H*s[5],y=O*s[6]+J*s[7]+H*s[8],
d=x*k-y*b,f=y*v-u*k,N=u*b-x*v,u=W*h[0]+Q*h[1]+G*h[2],x=W*h[3]+Q*h[4]+G*h[5],y=W*h[6]+Q*h[7]+G*h[8],d+=x*g-y*w,f+=y*A-u*g,N+=u*w-x*A;var At=1/(c+X*d+Y*f+Z*N);u=K*s[0]+$*s[1]+tt*s[2],x=K*s[3]+$*s[4]+tt*s[5],y=K*s[6]+$*s[7]+tt*s[8],d=x*k-y*b,f=y*v-u*k,N=u*b-x*v,u=it*h[0]+st*h[1]+ht*h[2],x=it*h[3]+st*h[4]+ht*h[5],y=it*h[6]+st*h[7]+ht*h[8],d+=x*g-y*w,f+=y*A-u*g,N+=u*w-x*A;var wt=1/(c+D*d+_*f+U*N);if(m.norDen=kt,m.tanDen=At,m.binDen=wt,z.warmStarted){var gt=z.normalImpulse;this.lv1.x+=m.norU1X*gt,this.lv1.y+=m.norU1Y*gt,this.lv1.z+=m.norU1Z*gt,this.av1.x+=et*gt,this.av1.y+=at*gt,this.av1.z+=ot*gt,this.lv2.x-=m.norU2X*gt,this.lv2.y-=m.norU2Y*gt,this.lv2.z-=m.norU2Z*gt,this.av2.x-=nt*gt,this.av2.y-=rt*gt,this.av2.z-=lt*gt,m.norImp=gt,m.tanImp=0,m.binImp=0,T=0}else m.norImp=0,m.tanImp=0,m.binImp=0;T>-1&&(T=0);var It=this.restitution*-T,Mt=-(z.penetration+.005)*i*.05;It<Mt&&(It=Mt),m.norTar=It,m.last=p==this.num-1,m=m.next}},R.prototype.solve=function(){for(var t=this.lv1.x,i=this.lv1.y,s=this.lv1.z,h=this.lv2.x,e=this.lv2.y,a=this.lv2.z,o=this.av1.x,n=this.av1.y,r=this.av1.z,l=this.av2.x,c=this.av2.y,m=this.av2.z,p=this.cs;;){var u,x,y,d,f,N=p.norImp,z=p.tanImp,v=p.binImp,b=-N*this.friction,k=h-t,A=e-i,w=a-s;f=k*p.tanX+A*p.tanY+w*p.tanZ+l*p.tanT2X+c*p.tanT2Y+m*p.tanT2Z-o*p.tanT1X-n*p.tanT1Y-r*p.tanT1Z,u=z,x=f*p.tanDen,z+=x,f=k*p.binX+A*p.binY+w*p.binZ+l*p.binT2X+c*p.binT2Y+m*p.binT2Z-o*p.binT1X-n*p.binT1Y-r*p.binT1Z,y=v,d=f*p.binDen,v+=d;var g=z*z+v*v;if(g>b*b&&(g=b/Tt.sqrt(g),z*=g,v*=g),x=z-u,d=v-y,t+=p.tanU1X*x+p.binU1X*d,i+=p.tanU1Y*x+p.binU1Y*d,s+=p.tanU1Z*x+p.binU1Z*d,o+=p.tanTU1X*x+p.binTU1X*d,n+=p.tanTU1Y*x+p.binTU1Y*d,r+=p.tanTU1Z*x+p.binTU1Z*d,h-=p.tanU2X*x+p.binU2X*d,e-=p.tanU2Y*x+p.binU2Y*d,a-=p.tanU2Z*x+p.binU2Z*d,l-=p.tanTU2X*x+p.binTU2X*d,c-=p.tanTU2Y*x+p.binTU2Y*d,m-=p.tanTU2Z*x+p.binTU2Z*d,f=(h-t)*p.norX+(e-i)*p.norY+(a-s)*p.norZ+l*p.norT2X+c*p.norT2Y+m*p.norT2Z-o*p.norT1X-n*p.norT1Y-r*p.norT1Z,u=N,x=(f-p.norTar)*p.norDen,N+=x,N>0&&(N=0),x=N-u,t+=p.norU1X*x,i+=p.norU1Y*x,s+=p.norU1Z*x,o+=p.norTU1X*x,n+=p.norTU1Y*x,r+=p.norTU1Z*x,h-=p.norU2X*x,e-=p.norU2Y*x,a-=p.norU2Z*x,l-=p.norTU2X*x,c-=p.norTU2Y*x,m-=p.norTU2Z*x,p.norImp=N,p.tanImp=z,p.binImp=v,p.last)break;p=p.next}this.lv1.x=t,this.lv1.y=i,this.lv1.z=s,this.lv2.x=h,this.lv2.y=e,this.lv2.z=a,this.av1.x=o,this.av1.y=n,this.av1.z=r,this.av2.x=l,this.av2.y=c,this.av2.z=m},R.prototype.postSolve=function(){for(var t=this.cs,i=this.num;i--;){var s=this.ps[i];s.normal.x=t.norX,s.normal.y=t.norY,s.normal.z=t.norZ,s.tangent.x=t.tanX,s.tangent.y=t.tanY,s.tangent.z=t.tanZ,s.binormal.x=t.binX,s.binormal.y=t.binY,s.binormal.z=t.binZ,s.normalImpulse=t.norImp,s.tangentImpulse=t.tanImp,s.binormalImpulse=t.binImp,s.normalDenominator=t.norDen,s.tangentDenominator=t.tanDen,s.binormalDenominator=t.binDen,t=t.next}},B.prototype={constructor:B,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPoint:function(t,i,s,h,e,a,o,n){var r=this.points[this.numPoints++];r.position.x=t,r.position.y=i,r.position.z=s;var l=this.body1.rotation,c=t-this.body1.position.x,m=i-this.body1.position.y,p=s-this.body1.position.z,u=l.elements;r.localPoint1.x=c*u[0]+m*u[3]+p*u[6],r.localPoint1.y=c*u[1]+m*u[4]+p*u[7],r.localPoint1.z=c*u[2]+m*u[5]+p*u[8],l=this.body2.rotation,c=t-this.body2.position.x,m=i-this.body2.position.y,p=s-this.body2.position.z,r.localPoint2.x=c*u[0]+m*u[3]+p*u[6],r.localPoint2.y=c*u[1]+m*u[4]+p*u[7],r.localPoint2.z=c*u[2]+m*u[5]+p*u[8],r.normalImpulse=0,n?(r.normal.x=-h,r.normal.y=-e,r.normal.z=-a):(r.normal.x=h,r.normal.y=e,r.normal.z=a),r.penetration=o,r.warmStarted=!1}},O.prototype={constructor:O,mixRestitution:function(t,i){return Tt.sqrt(t*i)},mixFriction:function(t,i){return Tt.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var s=this.buffer[i],h=this.points[i];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,i=e;i--;){h=this.points[i];for(var a=h.localPoint1.x,o=h.localPoint1.y,n=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,u=t;u--;){s=this.buffer[u];var x=s.lp1X-a,y=s.lp1Y-o,d=s.lp1Z-n,f=x*x+y*y+d*d;x=s.lp2X-r,y=s.lp2Y-l,d=s.lp2Z-c;var N=x*x+y*y+d*d;f<N?f<p&&(p=f,m=u):N<p&&(p=N,m=u)}if(m!=-1){var z=this.buffer[m];this.buffer[m]=this.buffer[--t],this.buffer[t]=z,h.normalImpulse=z.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},J.prototype={constructor:J,preSolve:function(t,i){var s,e,a;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),a=(new h).add(this.ii1,this.ii2).elements,s=1/(a[0]*(a[4]*a[8]-a[7]*a[5])+a[3]*(a[7]*a[2]-a[1]*a[8])+a[6]*(a[1]*a[5]-a[4]*a[2])),this.dd=new h(a[4]*a[8]-a[5]*a[7],a[2]*a[7]-a[1]*a[8],a[1]*a[5]-a[2]*a[4],a[5]*a[6]-a[3]*a[8],a[0]*a[8]-a[2]*a[6],a[2]*a[3]-a[0]*a[5],a[3]*a[7]-a[4]*a[6],a[1]*a[6]-a[0]*a[7],a[0]*a[4]-a[1]*a[3]).multiply(s),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),s=2*this.relativeOrientation.w,this.vel.scale(this.relativeOrientation,s),e=this.vel.length(),e>.02?(e=(.02-e)/e*i*.05,this.vel.scaleEqual(e)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var t=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,t),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}},H.prototype={constructor:H,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,e=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*e[1]+-this.r2y*e[2],this.ax2y=this.r2z*e[4]+-this.r2y*e[5],this.ax2z=this.r2z*e[7]+-this.r2y*e[8],this.ay2x=-this.r2z*e[0]+this.r2x*e[2],this.ay2y=-this.r2z*e[3]+this.r2x*e[5],this.ay2z=-this.r2z*e[6]+this.r2x*e[8],this.az2x=this.r2y*e[0]+-this.r2x*e[1],this.az2y=this.r2y*e[3]+-this.r2x*e[4],this.az2z=this.r2y*e[6]+-this.r2x*e[7];var a=this.m1+this.m2,o=new h(a,0,0,0,a,0,0,0,a),n=o.elements;n[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,n[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,n[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,n[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,n[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,n[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,n[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,n[0]+=e[4]*this.r2z*this.r2z-(e[7]+e[5])*this.r2y*this.r2z+e[8]*this.r2y*this.r2y,n[1]+=(e[6]*this.r2y+e[5]*this.r2x)*this.r2z-e[3]*this.r2z*this.r2z-e[8]*this.r2x*this.r2y,n[2]+=(e[3]*this.r2y-e[4]*this.r2x)*this.r2z-e[6]*this.r2y*this.r2y+e[7]*this.r2x*this.r2y,n[3]+=(e[2]*this.r2y+e[7]*this.r2x)*this.r2z-e[1]*this.r2z*this.r2z-e[8]*this.r2x*this.r2y,n[4]+=e[0]*this.r2z*this.r2z-(e[6]+e[2])*this.r2x*this.r2z+e[8]*this.r2x*this.r2x,n[5]+=(e[1]*this.r2x-e[0]*this.r2y)*this.r2z-e[7]*this.r2x*this.r2x+e[6]*this.r2x*this.r2y,n[6]+=(e[1]*this.r2y-e[4]*this.r2x)*this.r2z-e[2]*this.r2y*this.r2y+e[5]*this.r2x*this.r2y,n[7]+=(e[3]*this.r2x-e[0]*this.r2y)*this.r2z-e[5]*this.r2x*this.r2x+e[2]*this.r2x*this.r2y,n[8]+=e[0]*this.r2y*this.r2y-(e[3]+e[1])*this.r2x*this.r2y+e[4]*this.r2x*this.r2x;var r=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2]));this.dd=new h(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).multiply(r),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var l=Tt.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);l>.005?(l=(.005-l)/l*i*.05,this.velx*=l,this.vely*=l,this.velz*=l):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=i*t[0]+s*t[1]+h*t[2],a=i*t[3]+s*t[4]+h*t[5],o=i*t[6]+s*t[7]+h*t[8];this.impx+=e,this.impy+=a,this.impz+=o,this.l1.x+=e*this.m1,this.l1.y+=a*this.m1,this.l1.z+=o*this.m1,this.a1.x+=e*this.ax1x+a*this.ay1x+o*this.az1x,this.a1.y+=e*this.ax1y+a*this.ay1y+o*this.az1y,this.a1.z+=e*this.ax1z+a*this.ay1z+o*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=a*this.m2,this.l2.z-=o*this.m2,this.a2.x-=e*this.ax2x+a*this.ay2x+o*this.az2x,this.a2.y-=e*this.ax2y+a*this.ay2y+o*this.az2y,this.a2.z-=e*this.ax2z+a*this.ay2z+o*this.az2z}},W.prototype={constructor:W,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,a=this.limitMotor2.frequency,o=this.limitMotor3.frequency,n=e>0,r=a>0,l=o>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,u=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-u):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var x=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-x):x<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-x):x>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-x):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var y=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-y):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var d=6.2831853*e,f=d*d*t,N=i/(f+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*N,this.limitVelocity1*=f*N}else this.cfm1=0,this.limitVelocity1*=.05*i;r&&2!=this.limitState2?(d=6.2831853*a,f=d*d*t,N=i/(f+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*N,this.limitVelocity2*=f*N):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(d=6.2831853*o,f=d*d*t,N=i/(f+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*N,this.limitVelocity3*=f*N):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var z=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*z,this.d01=(this.k02*this.k21-this.k01*this.k22)*z,this.d02=(this.k01*this.k12-this.k02*this.k11)*z,this.d10=(this.k12*this.k20-this.k10*this.k22)*z,this.d11=(this.k00*this.k22-this.k02*this.k20)*z,this.d12=(this.k02*this.k10-this.k00*this.k12)*z,this.d20=(this.k10*this.k21-this.k11*this.k20)*z,this.d21=(this.k01*this.k20-this.k00*this.k21)*z,this.d22=(this.k00*this.k11-this.k01*this.k10)*z,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var v=this.limitImpulse1+this.motorImpulse1,b=this.limitImpulse2+this.motorImpulse2,k=this.limitImpulse3+this.motorImpulse3;this.a1.x+=v*this.a1x1+b*this.a1x2+k*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+k*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+k*this.a1z3,this.a2.x-=v*this.a2x1+b*this.a2x2+k*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+k*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+k*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=t*this.ax1+i*this.ay1+s*this.az1-this.limitVelocity1,e=t*this.ax2+i*this.ay2+s*this.az2-this.limitVelocity2,a=t*this.ax3+i*this.ay3+s*this.az3-this.limitVelocity3,o=h*this.d00+e*this.d01+a*this.d02,n=h*this.d10+e*this.d11+a*this.d12,r=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=o,this.limitImpulse2+=n,this.limitImpulse3+=r,this.a1.x+=o*this.a1x1+n*this.a1x2+r*this.a1x3,this.a1.y+=o*this.a1y1+n*this.a1y2+r*this.a1y3,this.a1.z+=o*this.a1z1+n*this.a1z2+r*this.a1z3,this.a2.x-=o*this.a2x1+n*this.a2x2+r*this.a2x3,this.a2.y-=o*this.a2y1+n*this.a2y2+r*this.a2y3,this.a2.z-=o*this.a2z1+n*this.a2z2+r*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,a=t*this.ax3+i*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,a+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,x=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,f=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=f;var N=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,a+=y*this.k20,N|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,a+=d*this.k21,N|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-x,h+=f*this.k02,e+=f*this.k12,N|=4);var z;switch(N){case 1:z=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*z,f=(-this.k21*e+this.k11*a)*z;break;case 2:z=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*z,f=(-this.k20*h+this.k00*a)*z;break;case 3:f=a/this.k22;break;case 4:z=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*z,d=(-this.k10*h+this.k00*e)*z;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=y+p,this.limitImpulse2=d+u,this.limitImpulse3=f+x;var v=l+y,b=c+d,k=m+f;this.a1.x+=v*this.a1x1+b*this.a1x2+k*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+k*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+k*this.a1z3,this.a2.x-=v*this.a2x1+b*this.a2x2+k*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+k*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+k*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=t*this.ax2+i*this.ay2+s*this.az2}},Q.prototype={constructor:Q,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor.frequency,a=e>0,o=this.lowerLimit<=this.upperLimit,n=this.limitMotor.angle;if(o?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),a||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||a)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,a&&2!=this.limitState){var r=6.2831853*e,l=r*r*t,c=i/(l+2*this.limitMotor.dampingRatio*r);this.cfm=this.motorDenom*c,this.limitVelocity*=l*c}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var m=this.limitImpulse+this.motorImpulse;this.a1.x+=m*this.a1x,this.a1.y+=m*this.a1y,this.a1.z+=m*this.a1z,this.a2.x-=m*this.a2x,this.a2.y-=m*this.a2y,this.a2.z-=m*this.a2z},solve:function(){var t,i=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var a=h+t;this.a1.x+=a*this.a1x,this.a1.y+=a*this.a1y,this.a1.z+=a*this.a1z,this.a2.x-=a*this.a2x,this.a2.y-=a*this.a2y,this.a2.z-=a*this.a2z}},G.prototype={constructor:G,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax1+a*this.ay1+o*this.az1,r=e*this.ax2+a*this.ay2+o*this.az2,l=e*this.ax3+a*this.ay3+o*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,u=c>0,x=m>0,y=p>0,d=this.lowerLimit1<=this.upperLimit1,f=this.lowerLimit2<=this.upperLimit2,N=this.lowerLimit3<=this.upperLimit3;(u&&n>20||n<-20)&&(u=!1),(x&&r>20||r<-20)&&(x=!1),(y&&l>20||l<-20)&&(y=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,u||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,u||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),u||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),f?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,x||(r=this.lowerLimit2)):r<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,x||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,x||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),x||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),N?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,y||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),y||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),
this.enableMotor1&&(0!=this.limitState1||u)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||x)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||y)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var z=n*this.ax1+r*this.ax2+l*this.ax2,v=n*this.ay1+r*this.ay2+l*this.ay2,b=n*this.az1+r*this.az2+l*this.az2,k=this.m2/(this.m1+this.m2);this.weight>=0&&(k=this.weight);var A=1-k;this.r1x=this.r1.x+z*k,this.r1y=this.r1.y+v*k,this.r1z=this.r1.z+b*k,this.r2x=this.r2.x-z*A,this.r2y=this.r2.y-v*A,this.r2z=this.r2.z-b*A,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var w=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*w,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*w,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*w,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*w,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*w,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*w,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*w,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*w,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*w,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,u&&2!=this.limitState1){var g=6.2831853*c,I=g*g*t,M=i/(I+2*this.limitMotor1.dampingRatio*g);this.cfm1=this.kv00*M,this.limitVelocity1*=I*M}else this.cfm1=0,this.limitVelocity1*=.05*i;x&&2!=this.limitState2?(g=6.2831853*m,I=g*g*t,M=i/(I+2*this.limitMotor2.dampingRatio*g),this.cfm2=this.kv11*M,this.limitVelocity2*=I*M):(this.cfm2=0,this.limitVelocity2*=.05*i),y&&2!=this.limitState3?(g=6.2831853*p,I=g*g*t,M=i/(I+2*this.limitMotor3.dampingRatio*g),this.cfm3=this.kv22*M,this.limitVelocity3*=I*M):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var L=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*L,this.d01=(this.k02*this.k21-this.k01*this.k22)*L,this.d02=(this.k01*this.k12-this.k02*this.k11)*L,this.d10=(this.k12*this.k20-this.k10*this.k22)*L,this.d11=(this.k00*this.k22-this.k02*this.k20)*L,this.d12=(this.k02*this.k10-this.k00*this.k12)*L,this.d20=(this.k10*this.k21-this.k11*this.k20)*L,this.d21=(this.k01*this.k20-this.k00*this.k21)*L,this.d22=(this.k00*this.k11-this.k01*this.k10)*L;var S=this.limitImpulse1+this.motorImpulse1,P=this.limitImpulse2+this.motorImpulse2,V=this.limitImpulse3+this.motorImpulse3;this.l1.x+=S*this.l1x1+P*this.l1x2+V*this.l1x3,this.l1.y+=S*this.l1y1+P*this.l1y2+V*this.l1y3,this.l1.z+=S*this.l1z1+P*this.l1z2+V*this.l1z3,this.a1.x+=S*this.a1x1+P*this.a1x2+V*this.a1x3,this.a1.y+=S*this.a1y1+P*this.a1y2+V*this.a1y3,this.a1.z+=S*this.a1z1+P*this.a1z2+V*this.a1z3,this.l2.x-=S*this.l2x1+P*this.l2x2+V*this.l2x3,this.l2.y-=S*this.l2y1+P*this.l2y2+V*this.l2y3,this.l2.z-=S*this.l2z1+P*this.l2z2+V*this.l2z3,this.a2.x-=S*this.a2x1+P*this.a2x2+V*this.a2x3,this.a2.y-=S*this.a2y1+P*this.a2y2+V*this.a2y3,this.a2.z-=S*this.a2z1+P*this.a2z2+V*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,a=t*this.ax3+i*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,a+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,x=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,f=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=f;var N=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,a+=y*this.k20,N|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,a+=d*this.k21,N|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-x,h+=f*this.k02,e+=f*this.k12,N|=4);var z;switch(N){case 1:z=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*z,f=(-this.k21*e+this.k11*a)*z;break;case 2:z=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*z,f=(-this.k20*h+this.k00*a)*z;break;case 3:f=a/this.k22;break;case 4:z=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*z,d=(-this.k10*h+this.k00*e)*z;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=p+y,this.limitImpulse2=u+d,this.limitImpulse3=x+f;var v=l+y,b=c+d,k=m+f;this.l1.x+=v*this.l1x1+b*this.l1x2+k*this.l1x3,this.l1.y+=v*this.l1y1+b*this.l1y2+k*this.l1y3,this.l1.z+=v*this.l1z1+b*this.l1z2+k*this.l1z3,this.a1.x+=v*this.a1x1+b*this.a1x2+k*this.a1x3,this.a1.y+=v*this.a1y1+b*this.a1y2+k*this.a1y3,this.a1.z+=v*this.a1z1+b*this.a1z2+k*this.a1z3,this.l2.x-=v*this.l2x1+b*this.l2x2+k*this.l2x3,this.l2.y-=v*this.l2y1+b*this.l2y2+k*this.l2y3,this.l2.z-=v*this.l2z1+b*this.l2z2+k*this.l2z3,this.a2.x-=v*this.a2x1+b*this.a2x2+k*this.a2x3,this.a2.y-=v*this.a2y1+b*this.a2y2+k*this.a2y3,this.a2.z-=v*this.a2z1+b*this.a2z2+k*this.a2z3}},K.prototype={constructor:K,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax+a*this.ay+o*this.az,r=this.limitMotor.frequency,l=r>0,c=this.lowerLimit<=this.upperLimit;(l&&n>20||n<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,l||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var m=n*this.ax,p=n*this.ay,u=n*this.az,x=this.m1/(this.m1+this.m2),y=1-x;if(this.r1x=this.r1.x+m*x,this.r1y=this.r1.y+p*x,this.r1z=this.r1.z+u*x,this.r2x=this.r2.x-m*y,this.r2y=this.r2.y-p*y,this.r2z=this.r2.z-u*y,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var d=6.2831853*r,f=d*d*t,N=i/(f+2*this.limitMotor.dampingRatio*d);this.cfm=this.motorDenom*N,this.limitVelocity*=f*N}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var z=this.limitImpulse+this.motorImpulse;this.l1.x+=z*this.l1x,this.l1.y+=z*this.l1y,this.l1.z+=z*this.l1z,this.a1.x+=z*this.a1x,this.a1.y+=z*this.a1y,this.a1.z+=z*this.a1z,this.l2.x-=z*this.l2x,this.l2.y-=z*this.l2y,this.l2.z-=z*this.l2z,this.a2.x-=z*this.a2x,this.a2.y-=z*this.a2y,this.a2.z-=z*this.a2z},solve:function(){var t,i=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var a=h+t;this.l1.x+=a*this.l1x,this.l1.y+=a*this.l1y,this.l1.z+=a*this.l1z,this.a1.x+=a*this.a1x,this.a1.y+=a*this.a1y,this.a1.z+=a*this.a1z,this.l2.x-=a*this.l2x,this.l2.y-=a*this.l2y,this.l2.z-=a*this.l2z,this.a2.x-=a*this.a2x,this.a2.y-=a*this.a2y,this.a2.z-=a*this.a2z}},tt.prototype=Object.create(U.prototype),tt.prototype.constructor=tt,tt.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},tt.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},tt.prototype.detach=function(){var t=this.b1Link.prev,i=this.b1Link.next;null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,i=this.b2Link.next,null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},tt.prototype.awake=function(){this.body1.awake(),this.body2.awake()},tt.prototype.preSolve=function(t,i){},tt.prototype.solve=function(){},tt.prototype.postSolve=function(){},tt.prototype.remove=function(){this.dispose()},tt.prototype.dispose=function(){this.parent.removeJoint(this)},tt.prototype.getPosition=function(){var t=(new i).scale(this.anchorPoint1,this.scale),s=(new i).scale(this.anchorPoint2,this.scale);return[t,s]},tt.prototype.getMatrix=function(){var t=this.matrix.elements,i=this.anchorPoint1,s=this.anchorPoint2;return t[0]=i.x*this.scale,t[1]=i.y*this.scale,t[2]=i.z*this.scale,t[3]=0,t[4]=s.x*this.scale,t[5]=s.y*this.scale,t[6]=s.z*this.scale,t[7]=0,t},st.prototype={constructor:st,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}},ht.prototype=Object.create(tt.prototype),ht.prototype.constructor=ht,ht.prototype.preSolve=function(t,i){var s,h,e,a;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),a=Tt.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-a:this.limitMotor.angle=a,s=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,h=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*s+this.tan.y*h+this.tan.z*e,this.r3.limitMotor3.angle=this.bin.x*s+this.bin.y*h+this.bin.z*e,this.r3.preSolve(t,i),this.lc.preSolve(t,i)},ht.prototype.solve=function(){this.r3.solve(),this.lc.solve()},ht.prototype.postSolve=function(){},et.prototype=Object.create(tt.prototype),et.prototype.constructor=et,et.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},et.prototype.solve=function(){this.lc.solve()},et.prototype.postSolve=function(){},at.prototype=Object.create(tt.prototype),at.prototype.constructor=at,at.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(t,i)},at.prototype.solve=function(){this.t.solve()},at.prototype.postSolve=function(){},ot.prototype=Object.create(tt.prototype),ot.prototype.constructor=ot,ot.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var n=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],r=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],l=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],c=e*this.body2.inverseMass+n*this.body1.inverseMass,m=a*this.body2.inverseMass+r*this.body1.inverseMass,p=o*this.body2.inverseMass+l*this.body1.inverseMass;h=Tt.sqrt(c*c+m*m+p*p),h>0&&(h=1/h),c*=h,m*=h,p*=h;var u=m*c-p*p,x=-p*m-c*c,y=c*p+m*m;h=1/Tt.sqrt(u*u+x*x+y*y),u*=h,x*=h,y*=h;var d=m*y-p*x,f=p*u-c*y,N=c*x-m*u;this.nor.init(c,m,p),this.tan.init(u,x,y),this.bin.init(d,f,N),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},ot.prototype.solve=function(){this.ac.solve(),this.t3.solve()},ot.prototype.postSolve=function(){},nt.prototype=Object.create(tt.prototype),nt.prototype.constructor=nt,nt.prototype.preSolve=function(t,i){var s,h,e,a;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],n=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],r=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],l=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],c=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],m=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var p=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],u=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],x=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],y=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],d=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],f=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],N=o*this.body2.inverseMass+p*this.body1.inverseMass,z=n*this.body2.inverseMass+u*this.body1.inverseMass,v=r*this.body2.inverseMass+x*this.body1.inverseMass;h=Tt.sqrt(N*N+z*z+v*v),h>0&&(h=1/h),N*=h,z*=h,v*=h;var b=z*N-v*v,k=-v*z-N*N,A=N*v+z*z;h=1/Tt.sqrt(b*b+k*k+A*A),b*=h,k*=h,A*=h;var w=z*A-v*k,g=v*b-N*A,I=N*k-z*b;this.nor.init(N,z,v),this.tan.init(b,k,A),this.bin.init(w,g,I),N*(c*f-m*d)+z*(m*y-l*f)+v*(l*d-c*y)<0?this.rotationalLimitMotor.angle=-Tt.acosClamp(l*y+c*d+m*f):this.rotationalLimitMotor.angle=Tt.acosClamp(l*y+c*d+m*f),h=n*x-r*u,e=r*p-o*x,a=o*u-n*p,this.r3.limitMotor2.angle=b*h+k*e+A*a,this.r3.limitMotor3.angle=w*h+g*e+I*a,this.r3.preSolve(t,i),this.t3.preSolve(t,i)},nt.prototype.solve=function(){this.r3.solve(),this.t3.solve()},nt.prototype.postSolve=function(){},rt.prototype=Object.create(tt.prototype),rt.prototype.constructor=rt,rt.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],n=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],r=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],l=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var c=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],m=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],p=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],u=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],x=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],y=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=e*c+a*m+o*p,e*(r*p-l*m)+a*(l*c-n*p)+o*(n*m-r*c)<0?this.rotationalLimitMotor1.angle=-Tt.acosClamp(n*c+r*m+l*p):this.rotationalLimitMotor1.angle=Tt.acosClamp(n*c+r*m+l*p),c*(x*o-y*a)+m*(y*e-u*o)+p*(u*a-x*e)<0?this.rotationalLimitMotor2.angle=Tt.acosClamp(u*e+x*a+y*o):this.rotationalLimitMotor2.angle=-Tt.acosClamp(u*e+x*a+y*o);var d=m*o-p*a,f=p*e-c*o,N=c*a-m*e;h=Tt.sqrt(d*d+f*f+N*N),h>0&&(h=1/h),d*=h,f*=h,N*=h;var z=f*p-N*m,v=N*c-d*p,b=d*m-f*c;h=Tt.sqrt(z*z+v*v+b*b),h>0&&(h=1/h),z*=h,v*=h,b*=h;var k=a*N-o*f,A=o*d-e*N,w=e*f-a*d;h=Tt.sqrt(k*k+A*A+w*w),h>0&&(h=1/h),k*=h,A*=h,w*=h,this.nor.init(d,f,N),this.tan.init(z,v,b),this.bin.init(k,A,w),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},rt.prototype.solve=function(){this.r3.solve(),this.t3.solve()},rt.prototype.postSolve=function(){},lt.prototype={constructor:lt,addShape:function(t){t.parent&&e("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var s=i.prev,h=i.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==i&&(this.shapes=h),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,s){var e=void 0===s||s;this.type=t||ft,this.isDynamic=this.type==ft,this.isStatic=this.type==Nt,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var a=this.localInertia.elements,o=new h,n=new i,r=this.shapes;null!=r;r=r.next){r.calculateMassInfo(this.massInfo);var l=this.massInfo.mass,c=r.relativePosition.x,m=r.relativePosition.y,p=r.relativePosition.z;n.addScale(r.relativePosition,l),this.mass+=l,this.rotateInertia(r.relativeRotation,this.massInfo.inertia,o),this.localInertia.addEqual(o),a[0]+=l*(m*m+p*p),a[4]+=l*(c*c+p*p),a[8]+=l*(c*c+m*m);var u=l*c*m,x=l*m*p,y=l*p*c;a[1]-=u,a[3]-=u,a[2]-=x,a[6]-=x,a[5]-=y,a[7]-=y}if(this.inverseMass=1/this.mass,n.scaleEqual(this.inverseMass),e){for(this.position.addEqual(n),r=this.shapes;null!=r;r=r.next)r.relativePosition.subEqual(n);c=n.x,m=n.y,p=n.z,a[0]-=this.mass*(m*m+p*p),a[4]-=this.mass*(c*c+p*p),a[8]-=this.mass*(c*c+m*m),u=this.mass*c*m,x=this.mass*m*p,y=this.mass*p*c,a[1]+=u,a[3]+=u,a[2]+=x,a[6]+=x,a[5]+=y,a[7]+=y}this.inverseLocalInertia.invert(this.localInertia),this.type==Nt&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case Nt:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case ft:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/t,this.linearVelocity.y=(this.newPosition.y-this.position.y)/t,this.linearVelocity.z=(this.newPosition.z-this.position.z)/t,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t);break;default:e("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(t,i,s){var h=t.elements,e=i.elements,a=h[0],o=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],x=e[0],y=e[3],d=e[6],f=e[1],N=e[4],z=e[7],v=e[2],b=e[5],k=e[8],A=a*x+r*y+m*d,w=a*f+r*N+m*z,g=a*v+r*b+m*k,I=o*x+l*y+p*d,M=o*f+l*N+p*z,L=o*v+l*b+p*k,S=n*x+c*y+u*d,P=n*f+c*N+u*z,V=n*v+c*b+u*k,T=s.elements;T[0]=A*a+w*r+g*m,T[1]=A*o+w*l+g*p,T[2]=A*n+w*c+g*u,T[3]=I*a+M*r+L*m,T[4]=I*o+M*l+L*p,T[5]=I*n+M*c+L*u,T[6]=S*a+P*r+V*m,T[7]=S*o+P*l+V*p,T[8]=S*n+P*c+V*u},syncShapes:function(){var t=this.orientation.w,i=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*i,a=2*s,o=2*h,n=i*e,r=s*a,l=h*o,c=i*a,m=s*o,p=i*o,u=t*e,x=t*a,y=t*o,d=this.rotation.elements;d[0]=1-r-l,d[1]=c-y,d[2]=p+x,d[3]=c+y,d[4]=1-n-l,d[5]=m-u,d[6]=p-x,d[7]=m+u,d[8]=1-n-r,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var f=this.shapes;null!=f;f=f.next)f.position.mul(this.position,f.relativePosition,this.rotation),f.rotation.mul(this.rotation,f.relativeRotation),f.updateProxy()},applyImpulse:function(t,s){this.linearVelocity.addScale(s,this.inverseMass);var h=new i;h.sub(t,this.position).cross(h,s).mulMat(this.inverseInertia,h),this.angularVelocity.addEqual(h)},rotationVectToQuad:function(t){var i=Tt.EulerToAxis(t.x*Tt.degtorad,t.y*Tt.degtorad,t.z*Tt.degtorad);return(new s).setFromAxis(i[0],i[1],i[2],i[3])},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(this.invScale),this.controlPos=!0},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0},setRotation:function(t){this.newOrientation=this.rotationVectToQuad(t),this.controlRot=!0},resetPosition:function(t,i,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,s).multiplyScalar(this.invScale),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new s(t.x,t.y,t.z,t.w),this.awake()},resetRotation:function(t,s,h){this.angularVelocity.set(0,0,0),this.orientation=this.rotationVectToQuad(new i(t,s,h)),this.awake()},getPosition:function(){return(new i).scale(this.position,this.scale)},getRotation:function(){return(new r).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new s).setFromRotationMatrix(this.rotation)},getMatrix:function(){var t,i,s=this.matrix.elements;return this.sleeping?s[15]=1:(t=this.rotation.elements,s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=0,s[4]=t[1],s[5]=t[4],s[6]=t[7],s[7]=0,s[8]=t[2],s[9]=t[5],s[10]=t[8],s[11]=0,i=this.position,s[12]=i.x*this.scale,s[13]=i.y*this.scale,s[14]=i.z*this.scale,s[15]=0),s}},ct.prototype={constructor:ct,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies)},addRigidBody:function(t){t.parent&&e("World","It is not possible to be added to more than one world one of the rigid body"),t.parent=this,t.awake();for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var s=i.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=t.shapes;null!==e;e=e.next)this.removeShape(e);var a=i.prev,o=i.next;null!==a&&(a.next=o),null!==o&&(o.prev=a),this.rigidBodies==i&&(this.rigidBodies=o),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=null,s=this.rigidBodies;null!==s;)" "!==s.name&&s.name===t&&(i=s),s=s.next;for(var h=this.joints;null!==h;)""!==h.name&&h.name===t&&(i=h),h=h.next;return i},addShape:function(t){t.parent&&t.parent.parent||e("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&e("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.parent=this,this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){
var i=t,s=i.prev,h=i.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==i&&(this.joints=h),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},worldscale:function(t){this.scale=100,this.invScale=1/this.scale},addContact:function(t,i){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new O,s.attach(t,i),s.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(t){var i=t.prev,s=t.next;s&&(s.prev=i),i&&(i.next=s),this.contacts==t&&(this.contacts=s),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},checkContact:function(t,i){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==t&&h==i||h==t&&s==i)return!!e.touching;e=e.next}return!1},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t,s,h,e,a=!this.isNoStat;a&&(t=performance.now());for(var o=this.rigidBodies;null!==o;)o.addedToIsland=!1,o.sleeping&&(o.linearVelocity.testZero()||o.angularVelocity.testZero()||o.position.testDiff(o.sleepPosition)||o.orientation.testDiff(o.sleepOrientation))&&o.awake(),o=o.next;a&&(s=performance.now()),this.broadPhase.detectPairs();for(var n=this.broadPhase.pairs,r=this.broadPhase.numPairs;r--;){var l,c,m=n[r];m.shape1.id<m.shape2.id?(l=m.shape1,c=m.shape2):(l=m.shape2,c=m.shape1);var p;p=l.numContacts<c.numContacts?l.contactLink:c.contactLink;for(var u=!1;p;){var x=p.contact;if(x.shape1==l&&x.shape2==c){x.persisting=!0,u=!0;break}p=p.next}u||this.addContact(l,c)}for(a&&(h=performance.now(),this.performance.broadPhaseTime=h-s),this.numContactPoints=0,x=this.contacts;null!==x;)if(x.persisting||!x.shape1.aabb.intersectTest(x.shape2.aabb)){var y=x.body1,d=x.body2;(y.isDynamic&&!y.sleeping||d.isDynamic&&!d.sleeping)&&x.updateManifold(),this.numContactPoints+=x.manifold.numPoints,x.persisting=!1,x.constraint.addedToIsland=!1,x=x.next}else{var f=x.next;this.removeContact(x),x=f}a&&(e=performance.now(),this.performance.narrowPhaseTime=e-h);var N,z,v=1/this.timeStep;for(N=this.joints;null!==N;N=N.next)N.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],s=performance.now(),this.numIslands=0;for(var b=this.rigidBodies;null!==b;b=b.next)if(!(b.addedToIsland||b.isStatic||b.sleeping))if(b.isLonely())b.isDynamic&&b.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(b)?(b.sleepTime+=this.timeStep,b.sleepTime>.5?b.sleep():b.updatePosition(this.timeStep)):(b.sleepTime=0,b.updatePosition(this.timeStep)),this.numIslands++;else{var k=0,A=0,w=1;this.islandStack[0]=b,b.addedToIsland=!0;do if(o=this.islandStack[--w],this.islandStack[w]=null,o.sleeping=!1,this.islandRigidBodies[k++]=o,!o.isStatic){for(var g=o.contactLink;null!==g;g=g.next){var x=g.contact;if(z=x.constraint,!z.addedToIsland&&x.touching){this.islandConstraints[A++]=z,z.addedToIsland=!0;var f=g.body;f.addedToIsland||(this.islandStack[w++]=f,f.addedToIsland=!0)}}for(var I=o.jointLink;null!==I;I=I.next)z=I.joint,z.addedToIsland||(this.islandConstraints[A++]=z,z.addedToIsland=!0,f=I.body,!f.addedToIsland&&f.isDynamic&&(this.islandStack[w++]=f,f.addedToIsland=!0))}while(0!=w);for(var M=(new i).addTime(this.gravity,this.timeStep),L=k;L--;)o=this.islandRigidBodies[L],o.isDynamic&&o.linearVelocity.addEqual(M);if(this.enableRandomizer)for(L=A;L--;)if(0!==L){var S=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*L|0;z=this.islandConstraints[L],this.islandConstraints[L]=this.islandConstraints[S],this.islandConstraints[S]=z}for(L=A;L--;)this.islandConstraints[L].preSolve(this.timeStep,v);for(var P=this.numIterations;P--;)for(L=A;L--;)this.islandConstraints[L].solve();for(L=A;L--;)this.islandConstraints[L].postSolve(),this.islandConstraints[L]=null;var V=10;for(L=k;L--;)o=this.islandRigidBodies[L],this.callSleep(o)?(o.sleepTime+=this.timeStep,o.sleepTime<V&&(V=o.sleepTime)):(o.sleepTime=0,V=0);if(V>.5)for(L=k;L--;)this.islandRigidBodies[L].sleep(),this.islandRigidBodies[L]=null;else for(L=k;L--;)this.islandRigidBodies[L].updatePosition(this.timeStep),this.islandRigidBodies[L]=null;this.numIslands++}a&&(h=performance.now(),this.performance.solvingTime=h-s,h=performance.now(),this.performance.upfps(),this.performance.totalTime=h-t)},add:function(t){t=t||{};var h=this.invScale,e=t.type||"box";if("string"==typeof e&&(e=[e]),"joint"==e[0].substring(0,5)){"joint"===e[0]&&(e[0]="jointHinge");var a=t.axe1||[1,0,0],o=t.axe2||[1,0,0],n=t.pos1||[0,0,0],r=t.pos2||[0,0,0];n=n.map(function(t){return t*h}),r=r.map(function(t){return t*h});var l,c;"jointDistance"===e[0]?(l=t.min||0,c=t.max||10,l*=h,c*=h):(l=t.min||57.29578,c=t.max||0,l*=Tt.degtorad,c*=Tt.degtorad);var m=t.limit||null,p=t.spring||null,u=t.motor||null,x=new it;x.scale=this.scale,x.invScale=this.invScale,x.allowCollision=t.collision||!1,x.localAxis1.init(a[0],a[1],a[2]),x.localAxis2.init(o[0],o[1],o[2]),x.localAnchorPoint1.init(n[0],n[1],n[2]),x.localAnchorPoint2.init(r[0],r[1],r[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=this.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=this.getByName(t.body2)),x.body1=t.body1,x.body2=t.body2;var y;switch(e[0]){case"jointDistance":y=new at(x,l,c),null!==p&&y.limitMotor.setSpring(p[0],p[1]),null!==u&&y.limitMotor.setMotor(u[0],u[1]);break;case"jointHinge":y=new ht(x,l,c),null!==p&&y.limitMotor.setSpring(p[0],p[1]),null!==u&&y.limitMotor.setMotor(u[0],u[1]);break;case"jointPrisme":y=new ot(x,l,c);break;case"jointSlide":y=new nt(x,l,c);break;case"jointBall":y=new et(x);break;case"jointWheel":y=new rt(x),null!==m&&y.rotationalLimitMotor1.setLimit(m[0],m[1]),null!==p&&y.rotationalLimitMotor1.setSpring(p[0],p[1]),null!==u&&y.rotationalLimitMotor1.setMotor(u[0],u[1])}return y.name=t.name||"",this.addJoint(y),y}var d=t.move||!1,f=t.noSleep||!1,N=t.pos||[0,0,0];N=N.map(function(t){return t*h});var z=t.size||[1,1,1];z=z.map(function(t){return t*h});var v=t.rot||[0,0,0];v=v.map(function(t){return t*Tt.degtorad});for(var b=[],k=0;k<v.length/3;k++){var A=Tt.EulerToAxis(v[k+0],v[k+1],v[k+2]);b.push(A[0]),b.push(A[1]),b.push(A[2]),b.push(A[3])}var w=new X;void 0!==t.sc&&(w=t.sc),t.config&&(w.density=void 0===t.config[0]?1:t.config[0],w.friction=void 0===t.config[1]?.4:t.config[1],w.restitution=void 0===t.config[2]?.2:t.config[2],w.belongsTo=t.config[3]||1,w.collidesWith=t.config[4]||4294967295),void 0!==t.density&&(w.density=t.density),void 0!==t.friction&&(w.friction=t.friction),void 0!==t.restitution&&(w.restitution=t.restitution),void 0!==t.belongsTo&&(w.belongsTo=t.belongsTo),void 0!==t.collidesWith&&(w.collidesWith=t.collidesWith),t.massPos&&(t.massPos=t.massPos.map(function(t){return t*h}),w.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(t){return t*degtorad}),w.relativeRotation=Tt.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2]));for(var g,I,M=new lt(N[0],N[1],N[2],b[0],b[1],b[2],b[3],this.scale,this.invScale),L=[],k=0;k<e.length;k++){switch(g=3*k,I=4*k,e[k]){case"sphere":L[k]=new D(w,z[g]);break;case"cylinder":L[k]=new _(w,z[g],z[g+1]);break;case"box":L[k]=new C(w,z[g],z[g+1],z[g+2])}if(M.addShape(L[k]),k>0&&(L[k].relativePosition=new i(N[g],N[g+1],N[g+2]),b[I+0])){var S=(new s).setFromAxis(b[I],b[I+1],b[I+2],b[I+3]);L[k].relativeRotation=(new OIMO.Mat33).setQuat(S)}}return d?(t.massPos||t.massRot?M.setupMass(1,!1):M.setupMass(1,!0),f?M.allowSleep=!1:M.allowSleep=!0):M.setupMass(2),M.name=t.name||" ",this.addRigidBody(M),M}},t.Math=Tt,t.Vec3=i,t.Euler=r,t.Quat=s,t.Mat33=h,t.Mat44=l,t.AABB=c,t.BasicProxy=u,t.Pair=x,t.BroadPhase=y,t.BruteForceBroadPhase=d,t.DBVTNode=f,t.DBVT=N,t.DBVTProxy=z,t.DBVTBroadPhase=v,t.SAPAxis=b,t.SAPElement=k,t.SAPProxy=A,t.SAPBroadPhase=w,t.CollisionDetector=g,t.BoxBoxCollisionDetector=I,t.BoxCylinderCollisionDetector=M,t.CylinderCylinderCollisionDetector=L,t.SphereBoxCollisionDetector=S,t.SphereCylinderCollisionDetector=P,t.SphereSphereCollisionDetector=V,t.MassInfo=T,t.ShapeConfig=X,t.Shape=Z,t.BoxShape=C,t.SphereShape=D,t.CylinderShape=_,t.Constraint=U,t.ContactLink=E,t.ImpulseDataBuffer=q,t.ContactPointDataBuffer=F,t.ManifoldPoint=j,t.ContactConstraint=R,t.ContactManifold=B,t.Contact=O,t.AngularConstraint=J,t.LinearConstraint=H,t.Rotational3Constraint=W,t.RotationalConstraint=Q,t.Translational3Constraint=G,t.TranslationalConstraint=K,t.Joint=tt,t.JointLink=$,t.JointConfig=it,t.LimitMotor=st,t.HingeJoint=ht,t.BallAndSocketJoint=et,t.DistanceJoint=at,t.PrismaticJoint=ot,t.SliderJoint=nt,t.WheelJoint=rt,t.World=ct,t.RigidBody=lt,t.REVISION=mt,t.BR_NULL=pt,t.BR_BRUTE_FORCE=ut,t.BR_SWEEP_AND_PRUNE=xt,t.BR_BOUNDING_VOLUME_TREE=yt,t.BODY_NULL=dt,t.BODY_DYNAMIC=ft,t.BODY_STATIC=Nt,t.SHAPE_NULL=zt,t.SHAPE_SPHERE=vt,t.SHAPE_BOX=bt,t.SHAPE_CYLINDER=kt,t.SHAPE_TETRA=At,t.JOINT_NULL=wt,t.JOINT_DISTANCE=gt,t.JOINT_BALL_AND_SOCKET=It,t.JOINT_HINGE=Mt,t.JOINT_WHEEL=Lt,t.JOINT_SLIDER=St,t.JOINT_PRISMATIC=Pt,t.AABB_PROX=Vt,t.Error=e,t.Performance=a,t.Link=o,t.Body=n,t.ProxyIdCount=m,t.Proxy=p,Object.defineProperty(t,"__esModule",{value:!0})});
