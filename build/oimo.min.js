// lo-th.github.io/Oimo.js/license
!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(i.OIMO=i.OIMO||{})}(this,function(i){"use strict";function t(i,t,s){this.x=i||0,this.y=t||0,this.z=s||0}function s(i,t,s,h){this.x=i||0,this.y=t||0,this.z=s||0,this.w=void 0!==h?h:1}function h(i,t,s,h,e,a,o,n,r){this.elements=new Float32Array(9),this.init(void 0!==i?i:1,t||0,s||0,h||0,void 0!==e?e:1,a||0,o||0,n||0,void 0!==r?r:1)}function e(i,t){console.error(i,t)}function a(i){this.parent=i,this.infos=new Float32Array(13),this.f=[0,0,0],this.times=[0,0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=oi,this.fps=0,this.tt=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0,this.updateTime=0,this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0}function o(i,t,s,h,e,a){this.elements=new Float32Array(6);var o=this.elements;o[0]=i||0,o[1]=s||0,o[2]=e||0,o[3]=t||0,o[4]=h||0,o[5]=a||0}function n(){return Pi++}function r(i){this.type=di,this.id=n(),this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new t,this.rotation=new h,this.relativePosition=(new t).copy(i.relativePosition),this.relativeRotation=(new h).copy(i.relativeRotation),this.aabb=new o,this.density=i.density,this.friction=i.friction,this.restitution=i.restitution,this.belongsTo=i.belongsTo,this.collidesWith=i.collidesWith}function l(i,t,s,h){r.call(this,i),this.type=Ni,this.width=t,this.height=s,this.depth=h,this.halfWidth=.5*t,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new Float32Array(18),this.elements=new Float32Array(24)}function c(i,t){r.call(this,i),this.type=fi,this.radius=t}function m(i,s,h){r.call(this,i),this.type=vi,this.radius=s,this.height=h,this.halfHeight=.5*h,this.normalDirection=new t,this.halfDirection=new t}function p(){this.relativePosition=new t,this.relativeRotation=new h,this.friction=.2,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295}function x(i,t){t=t||!1,this.axis=i,this.angle=0,this.lowerLimit=t?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0}function u(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1}function y(i){this.prev=null,this.next=null,this.body=null,this.joint=i}function d(i){u.call(this),this.scale=i.scale,this.invScale=i.invScale,this.name="",this.type=zi,this.prev=null,this.next=null,this.body1=i.body1,this.body2=i.body2,this.localAnchorPoint1=(new t).copy(i.localAnchorPoint1),this.localAnchorPoint2=(new t).copy(i.localAnchorPoint2),this.relativeAnchorPoint1=new t,this.relativeAnchorPoint2=new t,this.anchorPoint1=new t,this.anchorPoint2=new t,this.allowCollision=i.allowCollision,this.b1Link=new y(this),this.b2Link=new y(this)}function f(i){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=i,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.b1=i.body1,this.b2=i.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0}function N(i,t,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=t,this.limitMotor2=s,this.limitMotor3=h,this.b1=i.body1,this.b2=i.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0}function v(i,e,a){d.call(this,i),this.type=wi,this.localAxis1=i.localAxis1.clone().norm(),this.localAxis2=i.localAxis2.clone().norm(),this.localAngle1=new t(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var o=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new t).mulMat(o,this.localAngle1),this.nor=new t,this.tan=new t,this.bin=new t,this.ax1=new t,this.ax2=new t,this.an1=new t,this.an2=new t,this.limitMotor=new x(this.nor,!1),this.limitMotor.lowerLimit=e,this.limitMotor.upperLimit=a,this.lc=new f(this),this.r3=new N(this,this.limitMotor,new x(this.tan,!0),new x(this.bin,!0))}function b(i){d.call(this,i),this.type=Ai,this.lc=new f(this)}function z(i,t){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=t,this.b1=i.body1,this.b2=i.body2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0}function k(i,s,h){d.call(this,i),this.type=ki,this.normal=new t,this.nr=new t,this.limitMotor=new x(this.normal,!0),this.limitMotor.lowerLimit=s,this.limitMotor.upperLimit=h,this.t=new z(this,this.limitMotor)}function A(i,h){this.joint=i,this.targetOrientation=(new s).invert(h),this.relativeOrientation=new s,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new t,this.imp=new t,this.rn0=new t,this.rn1=new t,this.rn2=new t,this.b1=i.body1,this.b2=i.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia}function w(i,t,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=t,this.limitMotor2=s,this.limitMotor3=h,this.b1=i.body1,this.b2=i.body2,this.p1=i.anchorPoint1,this.p2=i.anchorPoint2,this.r1=i.relativeAnchorPoint1,this.r2=i.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1}function g(i,h,e){d.call(this,i),this.type=Mi,this.localAxis1=(new t).normalize(i.localAxis1),this.localAxis2=(new t).normalize(i.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new t,this.tan=new t,this.bin=new t,this.ac=new A(this,(new s).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new x(this.nor,!0),this.limitMotor.lowerLimit=h,this.limitMotor.upperLimit=e,this.t3=new w(this,this.limitMotor,new x(this.tan,!0),new x(this.bin,!0))}function I(i,e,a){d.call(this,i),this.type=Ii,this.localAxis1=(new t).normalize(i.localAxis1),this.localAxis2=(new t).normalize(i.localAxis2);var o;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,o=1/Si.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=o,this.localAngAxis1Y*=o,this.localAngAxis1Z*=o,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var n=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2)),r=n.elements;this.localAngAxis2X=this.localAngAxis1X*r[0]+this.localAngAxis1Y*r[1]+this.localAngAxis1Z*r[2],this.localAngAxis2Y=this.localAngAxis1X*r[3]+this.localAngAxis1Y*r[4]+this.localAngAxis1Z*r[5],this.localAngAxis2Z=this.localAngAxis1X*r[6]+this.localAngAxis1Y*r[7]+this.localAngAxis1Z*r[8],this.nor=new t,this.tan=new t,this.bin=new t,this.rotationalLimitMotor=new x(this.nor,!1),this.r3=new N(this,this.rotationalLimitMotor,new x(this.tan,!0),new x(this.bin,!0)),this.translationalLimitMotor=new x(this.nor,!0),this.translationalLimitMotor.lowerLimit=e,this.translationalLimitMotor.upperLimit=a,this.t3=new w(this,this.translationalLimitMotor,new x(this.tan,!0),new x(this.bin,!0))}function M(i){d.call(this,i),this.type=gi,this.localAxis1=(new t).normalize(i.localAxis1),this.localAxis2=(new t).normalize(i.localAxis2);var e;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(a>-1&&a<1)this.localAngAxis1X=this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,e=1/Si.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e,e=1/Si.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=e,this.localAngAxis2Y*=e,this.localAngAxis2Z*=e;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,e=1/Si.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e;var o=(new h).setQuat((new s).arc(this.localAxis1,this.localAxis2)),n=o.elements;this.localAngAxis2X=this.localAngAxis1X*n[0]+this.localAngAxis1Y*n[1]+this.localAngAxis1Z*n[2],this.localAngAxis2Y=this.localAngAxis1X*n[3]+this.localAngAxis1Y*n[4]+this.localAngAxis1Z*n[5],this.localAngAxis2Z=this.localAngAxis1X*n[6]+this.localAngAxis1Y*n[7]+this.localAngAxis1Z*n[8]}this.nor=new t,this.tan=new t,this.bin=new t,this.translationalLimitMotor=new x(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new x(this.tan,!1),this.rotationalLimitMotor2=new x(this.bin,!1),this.t3=new w(this,new x(this.nor,!0),this.translationalLimitMotor,new x(this.bin,!0)),this.t3.weight=1,this.r3=new N(this,new x(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)}function L(){this.scale=1,this.invScale=1,this.body1=null,this.body2=null,this.localAnchorPoint1=new t,this.localAnchorPoint2=new t,this.localAxis1=new t,this.localAxis2=new t,this.allowCollision=!1}function S(){this.mass=0,this.inertia=new h}function P(i){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=i}function T(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN}function V(){this.warmStarted=!1,this.position=new t,this.localPoint1=new t,this.localPoint2=new t,this.normal=new t,this.tangent=new t,this.binormal=new t,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0}function Y(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[new V,new V,new V,new V]}function X(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1}function Z(i){u.call(this),this.manifold=i,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=i.points,this.cs=new X,this.cs.next=new X,this.cs.next.next=new X,this.cs.next.next.next=new X}function U(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new P(this),this.b2Link=new P(this),this.s1Link=new P(this),this.s2Link=new P(this),this.manifold=new Y,this.buffer=[new T,new T,new T,new T],this.points=this.manifold.points,this.constraint=new Z(this.manifold)}function D(i,e,a,o){this.position=i||new t,this.orientation=e||new s,this.scale=a||1,this.invScale=o||1,this.name="",this.prev=null,this.next=null,this.type=mi,this.massInfo=new S,this.newPosition=new t,this.controlPos=!1,this.newOrientation=new s,this.newRotation=new t,this.currentRotation=new t,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new t,this.angularVelocity=new t,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new t,this.sleepOrientation=new s,this.isStatic=!1,this.isDynamic=!1,this.rotation=new h,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new h,this.localInertia=new h,this.inverseLocalInertia=new h,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1}function C(i,t){this.shape1=i||null,this.shape2=t||null}function j(){this.types=ni,this.numPairChecks=0,this.numPairs=0,this.pairs=[]}function O(){return Ti++}function q(i){this.shape=i,this.aabb=i.aabb}function E(i){q.call(this,i),this.id=O()}function F(){j.call(this),this.types=ri,this.proxies=[]}function B(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new Float32Array(64)}function R(i,t){this.proxy=i,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=t,this.value=0}function W(i,t){q.call(this,t),this.belongsTo=0,this.max=[],this.min=[],this.sap=i,this.min[0]=new R(this,!1),this.max[0]=new R(this,!0),this.min[1]=new R(this,!1),this.max[1]=new R(this,!0),this.min[2]=new R(this,!1),this.max[2]=new R(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]}function _(){j.call(this),this.types=li,this.numElementsD=0,this.numElementsS=0,this.axesD=[new B,new B,new B],this.axesS=[new B,new B,new B],this.index1=0,this.index2=1}function J(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new o}function H(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new o}function Q(i){q.call(this,i),this.leaf=new J,this.leaf.proxy=this}function G(){j.call(this),this.types=ci,this.tree=new H,this.stack=[],this.leaves=[],this.numLeaves=0}function K(){this.flip=!1}function $(){K.call(this),this.clipVertices1=new Float32Array(24),this.clipVertices2=new Float32Array(24),this.used=new Float32Array(8),this.INF=1/0}function ii(i){K.call(this),this.flip=i}function ti(){K.call(this)}function si(i){K.call(this),this.flip=i}function hi(i){K.call(this),this.flip=i}function ei(){K.call(this)}function ai(i){switch(i instanceof Object||(i={}),this.scale=i.worldscale||1,this.invScale=1/this.scale,this.timeStep=i.timestep||.01666,this.numIterations=i.iterations||8,i.broadphase||2){case 1:this.broadPhase=new F;break;case 2:default:this.broadPhase=new _;break;case 3:this.broadPhase=new G}this.performance=null,this.isStat=void 0!==i.info&&i.info,this.isStat&&(this.performance=new a(this)),this.enableRandomizer=void 0===i.random||i.random,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new t(0,-9.8,0),void 0!==i.gravity&&this.gravity.fromArray(i.gravity);var s=5;this.detectors=[],this.detectors.length=s;for(var h=s;h--;)this.detectors[h]=[],this.detectors[h].length=s;this.detectors[fi][fi]=new ei,this.detectors[fi][Ni]=new si(!1),this.detectors[Ni][fi]=new si(!0),this.detectors[Ni][Ni]=new $,this.detectors[vi][vi]=new ti,this.detectors[vi][Ni]=new ii(!0),this.detectors[Ni][vi]=new ii(!1),this.detectors[vi][fi]=new hi(!0),this.detectors[fi][vi]=new hi(!1),this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(i){return i<0?-1:i>0?1:+i}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&!function(){Object.assign=function(i){if(void 0===i||null===i)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(i),s=1;s<arguments.length;s++){var h=arguments[s];if(void 0!==h&&null!==h)for(var e in h)Object.prototype.hasOwnProperty.call(h,e)&&(t[e]=h[e])}return t}}();var oi="1.0.3",ni=0,ri=1,li=2,ci=3,mi=0,pi=1,xi=2,ui=3,yi=4,di=0,fi=1,Ni=2,vi=3,bi=4,zi=0,ki=1,Ai=2,wi=3,gi=4,Ii=5,Mi=6,Li=.005;Object.assign(t.prototype,{Vec3:!0,init:function(i,t,s){return this.x=i||0,this.y=t||0,this.z=s||0,this},set:function(i,t,s){return this.x=i,this.y=t,this.z=s,this},add:function(i,t){return this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},addEqual:function(i){return this.x+=i.x,this.y+=i.y,this.z+=i.z,this},addTime:function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this},sub:function(i,t){return this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},subEqual:function(i){return this.x-=i.x,this.y-=i.y,this.z-=i.z,this},addScale:function(i,t){return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this},scale:function(i,t){return this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},scaleEqual:function(i){return this.x*=i,this.y*=i,this.z*=i,this},cross:function(i,t){var s=i.x,h=i.y,e=i.z,a=t.x,o=t.y,n=t.z;return this.x=h*n-e*o,this.y=e*a-s*n,this.z=s*o-h*a,this},mul:function(i,t,s){var h=s.elements;return this.x=i.x+t.x*h[0]+t.y*h[1]+t.z*h[2],this.y=i.y+t.x*h[3]+t.y*h[4]+t.z*h[5],this.z=i.z+t.x*h[6]+t.y*h[7]+t.z*h[8],this},mulMat:function(i,t){var s=i.elements;return this.x=s[0]*t.x+s[1]*t.y+s[2]*t.z,this.y=s[3]*t.x+s[4]*t.y+s[5]*t.z,this.z=s[6]*t.x+s[7]*t.y+s[8]*t.z,this},mulManifold:function(i,t){var s=i.elements;return this.x=s[0]*t.x+s[3]*t.y+s[6]*t.z,this.y=s[1]*t.x+s[4]*t.y+s[7]*t.z,this.z=s[2]*t.x+s[5]*t.y+s[8]*t.z,this},normalize:function(i){var t=i.x,s=i.y,h=i.z,e=t*t+s*s+h*h;return e>0&&(e=1/Si.sqrt(e),this.x=t*e,this.y=s*e,this.z=h*e),this},invert:function(i){return this.x=-i.x,this.y=-i.y,this.z=-i.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(i){return this.x*i.x+this.y*i.y+this.z*i.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Si.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},applyQuaternion:function(i){var t=this.x,s=this.y,h=this.z,e=i.x,a=i.y,o=i.z,n=i.w,r=n*t+a*h-o*s,l=n*s+o*t-e*h,c=n*h+e*s-a*t,m=-e*t-a*s-o*h;return this.x=r*n+m*-e+l*-o-c*-a,this.y=l*n+m*-a+c*-e-r*-o,this.z=c*n+m*-o+r*-a-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(i){return i.x!==this.x||i.y!==this.y||i.z!==this.z},equals:function(i){return i.x===this.x&&i.y===this.y&&i.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(i){return isFinite(i)?(this.x*=i,this.y*=i,this.z*=i):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(i){return this.multiplyScalar(1/i)},norm:function(){return this.divideScalar(this.length())},toArray:function(i,t){void 0===t&&(t=0),i[t]=this.x,i[t+1]=this.y,i[t+2]=this.z},fromArray:function(i,t){return void 0===t&&(t=0),this.x=i[t],this.y=i[t+1],this.z=i[t+2],this}}),Object.assign(s.prototype,{Quat:!0,set:function(i,t,s,h){return this.x=i,this.y=t,this.z=s,this.w=h,this},init:function(i,t,s,h){return this.w=void 0!==i?i:1,this.x=t||0,this.y=s||0,this.z=h||0,this},add:function(i,t){return this.w=i.w+t.w,this.x=i.x+t.x,this.y=i.y+t.y,this.z=i.z+t.z,this},addTime:function(i,t){var s=i.x,h=i.y,e=i.z,a=this.w,o=this.x,n=this.y,r=this.z;t*=.5;var l=(-s*o-h*n-e*r)*t,c=(s*a+h*r-e*n)*t,m=(-s*r+h*a+e*o)*t,p=(s*n-h*o+e*a)*t;a+=l,o+=c,n+=m,r+=p;var x=1/Si.sqrt(a*a+o*o+n*n+r*r);return this.w=a*x,this.x=o*x,this.y=n*x,this.z=r*x,this},sub:function(i,t){return this.w=i.w-t.w,this.x=i.x-t.x,this.y=i.y-t.y,this.z=i.z-t.z,this},scale:function(i,t){return this.w=i.w*t,this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},mul:function(i,t){var s=i.x,h=i.y,e=i.z,a=i.w,o=t.x,n=t.y,r=t.z,l=t.w;return this.x=s*l+a*o+h*r-e*n,this.y=h*l+a*n+e*o-s*r,this.z=e*l+a*r+s*n-h*o,this.w=a*l-s*o-h*n-e*r,this},arc:function(i,t){var s=i.x,h=i.y,e=i.z,a=t.x,o=t.y,n=t.z,r=s*a+h*o+e*n;if(r==-1)return a=h*s-e*e,o=-e*h-s*s,n=s*e+h*h,r=1/Si.sqrt(a*a+o*o+n*n),this.w=0,this.x=a*r,this.y=o*r,this.z=n*r,this;var l=h*n-e*o,c=e*a-s*n,m=s*o-h*a;return this.w=Si.sqrt(.5*(1+r)),r=.5/this.w,this.x=l*r,this.y=c*r,this.z=m*r,this},normalize:function(i){var t=Si.sqrt(i.w*i.w+i.x*i.x+i.y*i.y+i.z*i.z);return t>0&&(t=1/t),this.w=i.w*t,this.x=i.x*t,this.y=i.y*t,this.z=i.z*t,this},invert:function(i){return this.w=i.w,this.x=-i.x,this.y=-i.y,this.z=-i.z,this},length:function(){return Si.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(i){return this.w=i.w,this.x=i.x,this.y=i.y,this.z=i.z,this},testDiff:function(i){return this.w!==i.w||this.x!==i.x||this.y!==i.y||this.z!==i.z},clone:function(i){return new s(this.x,this.y,this.z,this.w)},toString:function(){return"Quat["+this.x.toFixed(4)+", ("+this.y.toFixed(4)+", "+this.z.toFixed(4)+", "+this.w.toFixed(4)+")]"},setFromEuler:function(i,t,s){var h=Math.cos(.5*i),e=Math.cos(.5*t),a=Math.cos(.5*s),o=Math.sin(.5*i),n=Math.sin(.5*t),r=Math.sin(.5*s);return this.x=o*e*a+h*n*r,this.y=h*n*a-o*e*r,this.z=h*e*r+o*n*a,this.w=h*e*a-o*n*r,this},setFromAxis:function(i,t,s,h){var e=t*t+s*s+h*h;e>0&&(e=1/Si.sqrt(e),t*=e,s*=e,h*=e);var a=Si.sin(.5*i);return this.x=a*t,this.y=a*s,this.z=a*h,this.w=Si.cos(.5*i),this},setFromRotationMatrix:function(i){var t,s=i.elements,h=s[0],e=s[1],a=s[2],o=s[3],n=s[4],r=s[5],l=s[6],c=s[7],m=s[8],p=h+n+m;return p>0?(t=.5/Si.sqrt(p+1),this.w=.25/t,this.x=(c-r)*t,this.y=(a-l)*t,this.z=(o-e)*t):h>n&&h>m?(t=2*Si.sqrt(1+h-n-m),this.w=(c-r)/t,this.x=.25*t,this.y=(e+o)/t,this.z=(a+l)/t):n>m?(t=2*Si.sqrt(1+n-h-m),this.w=(a-l)/t,this.x=(e+o)/t,this.y=.25*t,this.z=(r+c)/t):(t=2*Si.sqrt(1+m-h-n),this.w=(o-e)/t,this.x=(a+l)/t,this.y=(r+c)/t,this.z=.25*t),this},toArray:function(i,t){t=t||0,i[t]=this.x,i[t+1]=this.y,i[t+2]=this.z,i[t+3]=this.w},fromArray:function(i,t){return t=t||0,this.set(i[t],i[t+1],i[t+2],i[t+3]),this}}),Object.assign(h.prototype,{Mat33:!0,set:function(i,t,s,h,e,a,o,n,r){var l=this.elements;return l[0]=i,l[1]=t,l[2]=s,l[3]=h,l[4]=e,l[5]=a,l[6]=o,l[7]=n,l[8]=r,this},init:function(i,t,s,h,e,a,o,n,r){var l=this.elements;return l[0]=i,l[1]=t,l[2]=s,l[3]=h,l[4]=e,l[5]=a,l[6]=o,l[7]=n,l[8]=r,this},multiply:function(i){var t=this.elements;return t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i,t[4]*=i,t[5]*=i,t[6]*=i,t[7]*=i,t[8]*=i,this},add:function(i,t){var s=this.elements,h=i.elements,e=t.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(i){var t=this.elements,s=i.elements;return t[0]+=s[0],t[1]+=s[1],t[2]+=s[2],t[3]+=s[3],t[4]+=s[4],t[5]+=s[5],t[6]+=s[6],t[7]+=s[7],t[8]+=s[8],this},sub:function(i,t){var s=this.elements,h=i.elements,e=t.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(i){var t=this.elements,s=i.elements;return t[0]-=s[0],t[1]-=s[1],t[2]-=s[2],t[3]-=s[3],t[4]-=s[4],t[5]-=s[5],t[6]-=s[6],t[7]-=s[7],t[8]-=s[8],this},scale:function(i,t){var s=this.elements,h=i.elements;return s[0]=h[0]*t,s[1]=h[1]*t,s[2]=h[2]*t,s[3]=h[3]*t,s[4]=h[4]*t,s[5]=h[5]*t,s[6]=h[6]*t,s[7]=h[7]*t,s[8]=h[8]*t,this},scaleEqual:function(i){var t=this.elements;return t[0]*=i,t[1]*=i,t[2]*=i,t[3]*=i,t[4]*=i,t[5]*=i,t[6]*=i,t[7]*=i,t[8]*=i,this},mul:function(i,t){var s=this.elements,h=i.elements,e=t.elements,a=h[0],o=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],x=h[8],u=e[0],y=e[3],d=e[6],f=e[1],N=e[4],v=e[7],b=e[2],z=e[5],k=e[8];return s[0]=a*u+r*y+m*d,s[1]=a*f+r*N+m*v,s[2]=a*b+r*z+m*k,s[3]=o*u+l*y+p*d,s[4]=o*f+l*N+p*v,s[5]=o*b+l*z+p*k,s[6]=n*u+c*y+x*d,s[7]=n*f+c*N+x*v,s[8]=n*b+c*z+x*k,this},mulScale:function(i,t,s,h,e){var a=e||!1,o=this.elements,n=i.elements;return a?(o[0]=t*n[0],o[1]=t*n[1],o[2]=t*n[2],o[3]=s*n[3],o[4]=s*n[4],o[5]=s*n[5],o[6]=h*n[6],o[7]=h*n[7],o[8]=h*n[8]):(o[0]=n[0]*t,o[1]=n[1]*s,o[2]=n[2]*h,o[3]=n[3]*t,o[4]=n[4]*s,o[5]=n[5]*h,o[6]=n[6]*t,o[7]=n[7]*s,o[8]=n[8]*h),this},mulRotate:function(i,t,s,h,e,a){var o=a||!1,n=Si.sin(t),r=Si.cos(t),l=1-r,c=s*s*l+r,m=s*h*l-e*n,p=s*e*l+h*n,x=h*s*l+e*n,u=h*h*l+r,y=h*e*l-s*n,d=e*s*l-h*n,f=e*h*l+s*n,N=e*e*l+r,v=i.elements,b=v[0],z=v[3],k=v[6],A=v[1],w=v[4],g=v[7],I=v[2],M=v[5],L=v[8],S=this.elements;return o?(S[0]=c*b+m*z+p*k,S[1]=c*A+m*w+p*g,S[2]=c*I+m*M+p*L,S[3]=x*b+u*z+y*k,
S[4]=x*A+u*w+y*g,S[5]=x*I+u*M+y*L,S[6]=d*b+f*z+N*k,S[7]=d*A+f*w+N*g,S[8]=d*I+f*M+N*L):(S[0]=b*c+A*x+I*d,S[1]=b*m+A*u+I*f,S[2]=b*p+A*y+I*N,S[3]=z*c+w*x+M*d,S[4]=z*m+w*u+M*f,S[5]=z*p+w*y+M*N,S[6]=k*c+g*x+L*d,S[7]=k*m+g*u+L*f,S[8]=k*p+g*y+L*N),this},transpose:function(i){var t=this.elements,s=i.elements;return t[0]=s[0],t[1]=s[3],t[2]=s[6],t[3]=s[1],t[4]=s[4],t[5]=s[7],t[6]=s[2],t[7]=s[5],t[8]=s[8],this},setQuat:function(i){var t=this.elements,s=2*i.x,h=2*i.y,e=2*i.z,a=i.x*s,o=i.y*h,n=i.z*e,r=i.x*h,l=i.y*e,c=i.x*e,m=i.w*s,p=i.w*h,x=i.w*e;return t[0]=1-o-n,t[1]=r-x,t[2]=c+p,t[3]=r+x,t[4]=1-a-n,t[5]=l-m,t[6]=c-p,t[7]=l+m,t[8]=1-a-o,this},invert:function(i){var t=this.elements,s=i.elements,h=s[0],e=s[3],a=s[6],o=s[1],n=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=n*m-r*c,x=r*l-o*m,u=o*c-n*l,y=h*p+e*x+a*u;return 0!=y&&(y=1/y),t[0]=y*p,t[1]=y*x,t[2]=y*u,t[3]=y*(c*a-e*m),t[4]=y*(h*m-l*a),t[5]=y*(l*e-h*c),t[6]=y*(e*r-n*a),t[7]=y*(o*a-h*r),t[8]=y*(h*n-o*e),this},addOffset:function(i,t){var s=t.x,h=t.y,e=t.z,a=this.elements;a[0]+=i*(h*h+e*e),a[4]+=i*(s*s+e*e),a[8]+=i*(s*s+h*h);var o=i*s*h,n=i*h*e,r=i*e*s;a[1]-=o,a[3]-=o,a[2]-=n,a[6]-=n,a[5]-=r,a[7]-=r},subOffset:function(i,t){var s=t.x,h=t.y,e=t.z,a=this.elements;a[0]-=i*(h*h+e*e),a[4]-=i*(s*s+e*e),a[8]-=i*(s*s+h*h);var o=i*s*h,n=i*h*e,r=i*e*s;a[1]+=o,a[3]+=o,a[2]+=n,a[6]+=n,a[5]+=r,a[7]+=r},toString:function(){var i=this.elements,t="Mat33|"+i[0].toFixed(4)+", "+i[1].toFixed(4)+", "+i[2].toFixed(4)+"|\n     |"+i[3].toFixed(4)+", "+i[4].toFixed(4)+", "+i[5].toFixed(4)+"|\n     |"+i[6].toFixed(4)+", "+i[7].toFixed(4)+", "+i[8].toFixed(4)+"|";return t},multiplyScalar:function(i){var t=this.elements;return t[0]*=i,t[3]*=i,t[6]*=i,t[1]*=i,t[4]*=i,t[7]*=i,t[2]*=i,t[5]*=i,t[8]*=i,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(i){var t=i.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},fromArray:function(i,t){void 0===t&&(t=0);for(var s=0;s<9;s++)this.elements[s]=i[s+t];return this},toArray:function(i,t){void 0===i&&(i=[]),void 0===t&&(t=0);var s=this.elements;return i[t]=s[0],i[t+1]=s[1],i[t+2]=s[2],i[t+3]=s[3],i[t+4]=s[4],i[t+5]=s[5],i[t+6]=s[6],i[t+7]=s[7],i[t+8]=s[8],i}});var Si={sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(i,t,s){return(1-s)*i+s*t},randInt:function(i,t){return i+Si.floor(Si.random()*(t-i+1))},rand:function(i,t){return i+Si.random()*(t-i)},int:function(i){return Si.floor(i)},fix:function(i,t){return i.toFixed(t||3,10)},clamp:function(i,t,s){return Si.max(t,Si.min(s,i))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,distance:function(i,t){var s=t[0]-i[0],h=t[1]-i[1],e=t[2]-i[2];return Si.sqrt(s*s+h*h+e*e)},acosClamp:function(i){return i>1?0:i<-1?Si.PI:Si.acos(i)}};Object.assign(a.prototype,{Performance:!0,setTime:function(i){this.times[i||0]=performance.now()},resetMax:function(){this.MaxBroadPhaseTime=0,this.MaxNarrowPhaseTime=0,this.MaxSolvingTime=0,this.MaxTotalTime=0,this.MaxUpdateTime=0},calcBroadPhase:function(){this.setTime(2),this.broadPhaseTime=this.times[2]-this.times[1]},calcNarrowPhase:function(){this.setTime(3),this.narrowPhaseTime=this.times[3]-this.times[2]},calcEnd:function(){this.setTime(2),this.solvingTime=this.times[2]-this.times[1],this.totalTime=this.times[2]-this.times[0],this.updateTime=this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime),100===this.tt&&this.resetMax(),this.tt>100&&(this.broadPhaseTime>this.MaxBroadPhaseTime&&(this.MaxBroadPhaseTime=this.broadPhaseTime),this.narrowPhaseTime>this.MaxNarrowPhaseTime&&(this.MaxNarrowPhaseTime=this.narrowPhaseTime),this.solvingTime>this.MaxSolvingTime&&(this.MaxSolvingTime=this.solvingTime),this.totalTime>this.MaxTotalTime&&(this.MaxTotalTime=this.totalTime),this.updateTime>this.MaxUpdateTime&&(this.MaxUpdateTime=this.updateTime)),this.upfps(),this.tt++,this.tt>500&&(this.tt=0)},upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},show:function(){var i=["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broadphase &nbsp;"+Si.fix(this.broadPhaseTime)+" | "+Si.fix(this.MaxBroadPhaseTime)+"<br>","narrowphase "+Si.fix(this.narrowPhaseTime)+" | "+Si.fix(this.MaxNarrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;"+Si.fix(this.solvingTime)+" | "+Si.fix(this.MaxSolvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+Si.fix(this.totalTime)+" | "+Si.fix(this.MaxTotalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;"+Si.fix(this.updateTime)+" | "+Si.fix(this.MaxUpdateTime)+"<br>"].join("\n");return i},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updateTime,this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}}),Object.assign(o.prototype,{AABB:!0,set:function(i,t,s,h,e,a){var o=this.elements;return o[0]=i,o[3]=t,o[1]=s,o[4]=h,o[2]=e,o[5]=a,this},intersectTest:function(i){var t=this.elements,s=i.elements;return t[0]>s[3]||t[1]>s[4]||t[2]>s[5]||t[3]<s[0]||t[4]<s[1]||t[5]<s[2]},intersectTestTwo:function(i){var t=this.elements,s=i.elements;return t[0]<s[0]||t[1]<s[1]||t[2]<s[2]||t[3]>s[3]||t[4]>s[4]||t[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(i,t){var s=t||0,h=i.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(i){return this.elements.set(i),this},combine:function(i,t){var s=i.elements,h=t.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var i=this.elements,t=i[3]-i[0],s=i[4]-i[1],h=i[5]-i[2];return 2*(t*(s+h)+s*h)},intersectsWithPoint:function(i,t,s){var h=this.elements;return i>=h[0]&&i<=h[3]&&t>=h[1]&&t<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(i){this.makeEmpty();for(var t=0;t<i.length;t++)this.expandByPoint(i[t])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(i){var t=this.elements;this.set(Si.min(t[0],i.x),Si.min(t[1],i.y),Si.min(t[2],i.z),Si.max(t[3],i.x),Si.max(t[4],i.y),Si.max(t[5],i.z))},expandByScalar:function(i){var t=this.elements;t[0]+=-i,t[1]+=-i,t[2]+=-i,t[3]+=i,t[4]+=i,t[5]+=i}});var Pi=0;Object.assign(r.prototype,{Shape:!0,calculateMassInfo:function(i){e("Shape","Inheritance error.")},updateProxy:function(){e("Shape","Inheritance error.")}}),l.prototype=Object.create(r.prototype),l.prototype.constructor=l,l.prototype.calculateMassInfo=function(i){var t=this.width*this.height*this.depth*this.density,s=1/12;i.mass=t,i.inertia.set(t*(this.height*this.height+this.depth*this.depth)*s,0,0,0,t*(this.width*this.width+this.depth*this.depth)*s,0,0,0,t*(this.width*this.width+this.height*this.height)*s)},l.prototype.updateProxy=function(){var i=this.rotation.elements,t=this.dimentions;t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8],t[9]=i[0]*this.halfWidth,t[10]=i[3]*this.halfWidth,t[11]=i[6]*this.halfWidth,t[12]=i[1]*this.halfHeight,t[13]=i[4]*this.halfHeight,t[14]=i[7]*this.halfHeight,t[15]=i[2]*this.halfDepth,t[16]=i[5]*this.halfDepth,t[17]=i[8]*this.halfDepth;var s=t[9],h=t[10],e=t[11],a=t[12],o=t[13],n=t[14],r=t[15],l=t[16],c=t[17],m=this.position.x,p=this.position.y,x=this.position.z,u=this.elements;u[0]=m+s+a+r,u[1]=p+h+o+l,u[2]=x+e+n+c,u[3]=m+s+a-r,u[4]=p+h+o-l,u[5]=x+e+n-c,u[6]=m+s-a+r,u[7]=p+h-o+l,u[8]=x+e-n+c,u[9]=m+s-a-r,u[10]=p+h-o-l,u[11]=x+e-n-c,u[12]=m-s+a+r,u[13]=p-h+o+l,u[14]=x-e+n+c,u[15]=m-s+a-r,u[16]=p-h+o-l,u[17]=x-e+n-c,u[18]=m-s-a+r,u[19]=p-h-o+l,u[20]=x-e-n+c,u[21]=m-s-a-r,u[22]=p-h-o-l,u[23]=x-e-n-c;var y=t[9]<0?-t[9]:t[9],d=t[10]<0?-t[10]:t[10],f=t[11]<0?-t[11]:t[11];y=t[12]<0?y-t[12]:y+t[12],d=t[13]<0?d-t[13]:d+t[13],f=t[14]<0?f-t[14]:f+t[14],y=t[15]<0?y-t[15]:y+t[15],d=t[16]<0?d-t[16]:d+t[16],f=t[17]<0?f-t[17]:f+t[17];var N=Li;this.aabb.set(this.position.x-y-N,this.position.x+y+N,this.position.y-d-N,this.position.y+d+N,this.position.z-f-N,this.position.z+f+N),null!=this.proxy&&this.proxy.update()},c.prototype=Object.create(r.prototype),c.prototype.constructor=c,c.prototype.calculateMassInfo=function(i){var t=1.333*Si.PI*this.radius*this.radius*this.radius*this.density;i.mass=t;var s=t*this.radius*this.radius*.4;i.inertia.set(s,0,0,0,s,0,0,0,s)},c.prototype.updateProxy=function(){var i=Li;this.aabb.set(this.position.x-this.radius-i,this.position.x+this.radius+i,this.position.y-this.radius-i,this.position.y+this.radius+i,this.position.z-this.radius-i,this.position.z+this.radius+i),null!=this.proxy&&this.proxy.update()},m.prototype=Object.create(r.prototype),m.prototype.constructor=m,m.prototype.calculateMassInfo=function(i){var t=this.radius*this.radius,s=Si.PI*t*this.height*this.density,h=(.25*t+.0833*this.height*this.height)*s,e=.5*t;i.mass=s,i.inertia.set(h,0,0,0,e,0,0,0,h)},m.prototype.updateProxy=function(){var i,t,s,h,e,a,o,n,r,l,c,m=this.rotation.elements;e=m[1]*m[1],a=m[4]*m[4],o=m[7]*m[7],this.normalDirection.set(m[1],m[4],m[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),t=1-e,i=Si.sqrt(t*t+e*a+e*o),i>0&&(i=this.radius/i),t*=i,s=1-a,i=Si.sqrt(a*e+s*s+a*o),i>0&&(i=this.radius/i),s*=i,h=1-o,i=Si.sqrt(o*e+o*a+h*h),i>0&&(i=this.radius/i),h*=i,n=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,r=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,l=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,n=t<0?n-t:n+t,r=s<0?r-s:r+s,l=h<0?l-h:l+h,c=Li,this.aabb.set(this.position.x-n-c,this.position.x+n+c,this.position.y-r-c,this.position.y+r+c,this.position.z-l-c,this.position.z+l+c),null!=this.proxy&&this.proxy.update()},x.prototype={constructor:x,setLimit:function(i,t){this.lowerLimit=i,this.upperLimit=t},setMotor:function(i,t){this.motorSpeed=i,this.maxMotorForce=t},setSpring:function(i,t){this.frequency=i,this.dampingRatio=t}},Object.assign(u.prototype,{Constraint:!0,preSolve:function(i,t){e("Constraint","Inheritance error.")},solve:function(){e("Constraint","Inheritance error.")},postSolve:function(){e("Constraint","Inheritance error.")}}),d.prototype=Object.create(u.prototype),d.prototype.constructor=d,d.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},d.prototype.attach=function(i){this.b1Link.body=this.body2,this.b2Link.body=this.body1,i?(this.body1.jointLink.push(this.b1Link),this.body2.jointLink.push(this.b2Link)):(null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++)},d.prototype.detach=function(i){if(i)this.body1.jointLink.splice(this.body1.jointLink.indexOf(this.b1Link),1),this.body2.jointLink.splice(this.body2.jointLink.indexOf(this.b2Link),1);else{var t=this.b1Link.prev,s=this.b1Link.next;null!=t&&(t.next=s),null!=s&&(s.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=s),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,s=this.b2Link.next,null!=t&&(t.next=s),null!=s&&(s.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=s),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--}this.b1Link.body=null,this.b2Link.body=null},d.prototype.awake=function(){this.body1.awake(),this.body2.awake()},d.prototype.preSolve=function(i,t){},d.prototype.solve=function(){},d.prototype.postSolve=function(){},d.prototype.remove=function(){this.dispose()},d.prototype.dispose=function(){this.parent.removeJoint(this)},d.prototype.getPosition=function(){var i=(new t).scale(this.anchorPoint1,this.scale),s=(new t).scale(this.anchorPoint2,this.scale);return[i,s]},Object.assign(f.prototype,{LinearConstraint:!0,preSolve:function(i,t){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,e=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*e[1]+-this.r2y*e[2],this.ax2y=this.r2z*e[4]+-this.r2y*e[5],this.ax2z=this.r2z*e[7]+-this.r2y*e[8],this.ay2x=-this.r2z*e[0]+this.r2x*e[2],this.ay2y=-this.r2z*e[3]+this.r2x*e[5],this.ay2z=-this.r2z*e[6]+this.r2x*e[8],this.az2x=this.r2y*e[0]+-this.r2x*e[1],this.az2y=this.r2y*e[3]+-this.r2x*e[4],this.az2z=this.r2y*e[6]+-this.r2x*e[7];var a=this.m1+this.m2,o=new h(a,0,0,0,a,0,0,0,a),n=o.elements;n[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,n[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,n[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,n[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,n[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,n[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,n[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,n[0]+=e[4]*this.r2z*this.r2z-(e[7]+e[5])*this.r2y*this.r2z+e[8]*this.r2y*this.r2y,n[1]+=(e[6]*this.r2y+e[5]*this.r2x)*this.r2z-e[3]*this.r2z*this.r2z-e[8]*this.r2x*this.r2y,n[2]+=(e[3]*this.r2y-e[4]*this.r2x)*this.r2z-e[6]*this.r2y*this.r2y+e[7]*this.r2x*this.r2y,n[3]+=(e[2]*this.r2y+e[7]*this.r2x)*this.r2z-e[1]*this.r2z*this.r2z-e[8]*this.r2x*this.r2y,n[4]+=e[0]*this.r2z*this.r2z-(e[6]+e[2])*this.r2x*this.r2z+e[8]*this.r2x*this.r2x,n[5]+=(e[1]*this.r2x-e[0]*this.r2y)*this.r2z-e[7]*this.r2x*this.r2x+e[6]*this.r2x*this.r2y,n[6]+=(e[1]*this.r2y-e[4]*this.r2x)*this.r2z-e[2]*this.r2y*this.r2y+e[5]*this.r2x*this.r2y,n[7]+=(e[3]*this.r2x-e[0]*this.r2y)*this.r2z-e[5]*this.r2x*this.r2x+e[2]*this.r2x*this.r2y,n[8]+=e[0]*this.r2y*this.r2y-(e[3]+e[1])*this.r2x*this.r2y+e[4]*this.r2x*this.r2x;var r=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2]));this.dd=new h(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).multiply(r),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var l=Si.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);l>.005?(l=(.005-l)/l*t*.05,this.velx*=l,this.vely*=l,this.velz*=l):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var i=this.dd.elements,t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=t*i[0]+s*i[1]+h*i[2],a=t*i[3]+s*i[4]+h*i[5],o=t*i[6]+s*i[7]+h*i[8];this.impx+=e,this.impy+=a,this.impz+=o,this.l1.x+=e*this.m1,this.l1.y+=a*this.m1,this.l1.z+=o*this.m1,this.a1.x+=e*this.ax1x+a*this.ay1x+o*this.az1x,this.a1.y+=e*this.ax1y+a*this.ay1y+o*this.az1y,this.a1.z+=e*this.ax1z+a*this.ay1z+o*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=a*this.m2,this.l2.z-=o*this.m2,this.a2.x-=e*this.ax2x+a*this.ay2x+o*this.az2x,this.a2.y-=e*this.ax2y+a*this.ay2y+o*this.az2y,this.a2.z-=e*this.ax2z+a*this.ay2z+o*this.az2z}}),Object.assign(N.prototype,{Rotational3Constraint:!0,preSolve:function(i,t){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,a=this.limitMotor2.frequency,o=this.limitMotor3.frequency,n=e>0,r=a>0,l=o>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,x=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-x):x<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-x):x>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-x):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),n||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var u=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-u):u>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-u):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var y=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-y):y>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-y):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||n)?this.maxMotorImpulse1=this.maxMotorForce1*i:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*i:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*i:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,n&&2!=this.limitState1){var d=6.2831853*e,f=d*d*i,N=t/(f+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*N,this.limitVelocity1*=f*N}else this.cfm1=0,this.limitVelocity1*=.05*t;r&&2!=this.limitState2?(d=6.2831853*a,f=d*d*i,N=t/(f+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*N,this.limitVelocity2*=f*N):(this.cfm2=0,this.limitVelocity2*=.05*t),l&&2!=this.limitState3?(d=6.2831853*o,f=d*d*i,N=t/(f+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*N,this.limitVelocity3*=f*N):(this.cfm3=0,this.limitVelocity3*=.05*t),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var v=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*v,this.d01=(this.k02*this.k21-this.k01*this.k22)*v,this.d02=(this.k01*this.k12-this.k02*this.k11)*v,this.d10=(this.k12*this.k20-this.k10*this.k22)*v,this.d11=(this.k00*this.k22-this.k02*this.k20)*v,this.d12=(this.k02*this.k10-this.k00*this.k12)*v,this.d20=(this.k10*this.k21-this.k11*this.k20)*v,this.d21=(this.k01*this.k20-this.k00*this.k21)*v,this.d22=(this.k00*this.k11-this.k01*this.k10)*v,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var b=this.limitImpulse1+this.motorImpulse1,z=this.limitImpulse2+this.motorImpulse2,k=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+z*this.a1x2+k*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+k*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+k*this.a1z3,this.a2.x-=b*this.a2x1+z*this.a2x2+k*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+k*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+k*this.a2z3},solve_:function(){var i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=i*this.ax1+t*this.ay1+s*this.az1-this.limitVelocity1,e=i*this.ax2+t*this.ay2+s*this.az2-this.limitVelocity2,a=i*this.ax3+t*this.ay3+s*this.az3-this.limitVelocity3,o=h*this.d00+e*this.d01+a*this.d02,n=h*this.d10+e*this.d11+a*this.d12,r=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=o,this.limitImpulse2+=n,this.limitImpulse3+=r,this.a1.x+=o*this.a1x1+n*this.a1x2+r*this.a1x3,this.a1.y+=o*this.a1y1+n*this.a1y2+r*this.a1y3,this.a1.z+=o*this.a1z1+n*this.a1z2+r*this.a1z3,this.a2.x-=o*this.a2x1+n*this.a2x2+r*this.a2x3,this.a2.y-=o*this.a2y1+n*this.a2y2+r*this.a2y3,this.a2.z-=o*this.a2z1+n*this.a2z2+r*this.a2z3},solve:function(){var i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=i*this.ax1+t*this.ay1+s*this.az1,e=i*this.ax2+t*this.ay2+s*this.az2,a=i*this.ax3+t*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,a+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,x=this.limitImpulse2,u=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,f=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=f;var N=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,a+=y*this.k20,N|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-x,h+=d*this.k01,a+=d*this.k21,N|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-u,h+=f*this.k02,e+=f*this.k12,N|=4);var v;switch(N){case 1:v=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*v,f=(-this.k21*e+this.k11*a)*v;break;case 2:v=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*v,f=(-this.k20*h+this.k00*a)*v;break;case 3:f=a/this.k22;break;case 4:v=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*v,d=(-this.k10*h+this.k00*e)*v;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=y+p,this.limitImpulse2=d+x,this.limitImpulse3=f+u;var b=l+y,z=c+d,k=m+f;this.a1.x+=b*this.a1x1+z*this.a1x2+k*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+k*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+k*this.a1z3,this.a2.x-=b*this.a2x1+z*this.a2x2+k*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+k*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+k*this.a2z3,i=this.a2.x-this.a1.x,t=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=i*this.ax2+t*this.ay2+s*this.az2}}),v.prototype=Object.create(d.prototype),v.prototype.constructor=v,v.prototype.preSolve=function(i,t){var s,h,e,a;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),a=Si.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-a:this.limitMotor.angle=a,s=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,h=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*s+this.tan.y*h+this.tan.z*e,this.r3.limitMotor3.angle=this.bin.x*s+this.bin.y*h+this.bin.z*e,this.r3.preSolve(i,t),this.lc.preSolve(i,t)},v.prototype.solve=function(){this.r3.solve(),this.lc.solve()},v.prototype.postSolve=function(){},b.prototype=Object.create(d.prototype),b.prototype.constructor=b,b.prototype.preSolve=function(i,t){this.updateAnchorPoints(),this.lc.preSolve(i,t)},b.prototype.solve=function(){this.lc.solve()},b.prototype.postSolve=function(){},Object.assign(z.prototype,{TranslationalConstraint:!0,preSolve:function(i,t){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax+a*this.ay+o*this.az,r=this.limitMotor.frequency,l=r>0,c=this.lowerLimit<=this.upperLimit;
(l&&n>20||n<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-n,l||(n=this.lowerLimit)):n>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-n,l||(n=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*i:(this.motorImpulse=0,this.maxMotorImpulse=0);var m=n*this.ax,p=n*this.ay,x=n*this.az,u=this.m1/(this.m1+this.m2),y=1-u;if(this.r1x=this.r1.x+m*u,this.r1y=this.r1.y+p*u,this.r1z=this.r1.z+x*u,this.r2x=this.r2.x-m*y,this.r2y=this.r2.y-p*y,this.r2z=this.r2.z-x*y,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var d=6.2831853*r,f=d*d*i,N=t/(f+2*this.limitMotor.dampingRatio*d);this.cfm=this.motorDenom*N,this.limitVelocity*=f*N}else this.cfm=0,this.limitVelocity*=.05*t;this.invDenom=1/(this.motorDenom+this.cfm);var v=this.limitImpulse+this.motorImpulse;this.l1.x+=v*this.l1x,this.l1.y+=v*this.l1y,this.l1.z+=v*this.l1z,this.a1.x+=v*this.a1x,this.a1.y+=v*this.a1y,this.a1.z+=v*this.a1z,this.l2.x-=v*this.l2x,this.l2.y-=v*this.l2y,this.l2.z-=v*this.l2z,this.a2.x-=v*this.a2x,this.a2.y-=v*this.a2y,this.a2.z-=v*this.a2z},solve:function(){var i,t=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){i=(t-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=i,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),i=this.motorImpulse-s,t-=i*this.motorDenom}else i=0;var h;if(2!=this.limitState){h=(t-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var a=h+i;this.l1.x+=a*this.l1x,this.l1.y+=a*this.l1y,this.l1.z+=a*this.l1z,this.a1.x+=a*this.a1x,this.a1.y+=a*this.a1y,this.a1.z+=a*this.a1z,this.l2.x-=a*this.l2x,this.l2.y-=a*this.l2y,this.l2.z-=a*this.l2z,this.a2.x-=a*this.a2x,this.a2.y-=a*this.a2y,this.a2.z-=a*this.a2z}}),k.prototype=Object.create(d.prototype),k.prototype.constructor=k,k.prototype.preSolve=function(i,t){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(i,t)},k.prototype.solve=function(){this.t.solve()},k.prototype.postSolve=function(){},Object.assign(A.prototype,{AngularConstraint:!0,preSolve:function(i,t){var s,e,a;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),a=(new h).add(this.ii1,this.ii2).elements,s=1/(a[0]*(a[4]*a[8]-a[7]*a[5])+a[3]*(a[7]*a[2]-a[1]*a[8])+a[6]*(a[1]*a[5]-a[4]*a[2])),this.dd=new h(a[4]*a[8]-a[5]*a[7],a[2]*a[7]-a[1]*a[8],a[1]*a[5]-a[2]*a[4],a[5]*a[6]-a[3]*a[8],a[0]*a[8]-a[2]*a[6],a[2]*a[3]-a[0]*a[5],a[3]*a[7]-a[4]*a[6],a[1]*a[6]-a[0]*a[7],a[0]*a[4]-a[1]*a[3]).multiply(s),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),s=2*this.relativeOrientation.w,this.vel.scale(this.relativeOrientation,s),e=this.vel.length(),e>.02?(e=(.02-e)/e*t*.05,this.vel.scaleEqual(e)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var i=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,i),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}}),Object.assign(w.prototype,{Translational3Constraint:!0,preSolve:function(i,t){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,a=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,n=e*this.ax1+a*this.ay1+o*this.az1,r=e*this.ax2+a*this.ay2+o*this.az2,l=e*this.ax3+a*this.ay3+o*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,x=c>0,u=m>0,y=p>0,d=this.lowerLimit1<=this.upperLimit1,f=this.lowerLimit2<=this.upperLimit2,N=this.lowerLimit3<=this.upperLimit3;(x&&n>20||n<-20)&&(x=!1),(u&&r>20||r<-20)&&(u=!1),(y&&l>20||l<-20)&&(y=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,x||(n=this.lowerLimit1)):n<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n,x||(n=this.lowerLimit1)):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n,x||(n=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),x||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),f?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,u||(r=this.lowerLimit2)):r<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,u||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,u||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),u||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),N?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,y||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,y||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),y||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||x)?this.maxMotorImpulse1=this.maxMotorForce1*i:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||u)?this.maxMotorImpulse2=this.maxMotorForce2*i:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||y)?this.maxMotorImpulse3=this.maxMotorForce3*i:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var v=n*this.ax1+r*this.ax2+l*this.ax2,b=n*this.ay1+r*this.ay2+l*this.ay2,z=n*this.az1+r*this.az2+l*this.az2,k=this.m2/(this.m1+this.m2);this.weight>=0&&(k=this.weight);var A=1-k;this.r1x=this.r1.x+v*k,this.r1y=this.r1.y+b*k,this.r1z=this.r1.z+z*k,this.r2x=this.r2.x-v*A,this.r2y=this.r2.y-b*A,this.r2z=this.r2.z-z*A,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var w=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*w,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*w,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*w,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*w,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*w,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*w,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*w,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*w,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*w,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,x&&2!=this.limitState1){var g=6.2831853*c,I=g*g*i,M=t/(I+2*this.limitMotor1.dampingRatio*g);this.cfm1=this.kv00*M,this.limitVelocity1*=I*M}else this.cfm1=0,this.limitVelocity1*=.05*t;u&&2!=this.limitState2?(g=6.2831853*m,I=g*g*i,M=t/(I+2*this.limitMotor2.dampingRatio*g),this.cfm2=this.kv11*M,this.limitVelocity2*=I*M):(this.cfm2=0,this.limitVelocity2*=.05*t),y&&2!=this.limitState3?(g=6.2831853*p,I=g*g*i,M=t/(I+2*this.limitMotor3.dampingRatio*g),this.cfm3=this.kv22*M,this.limitVelocity3*=I*M):(this.cfm3=0,this.limitVelocity3*=.05*t),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var L=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*L,this.d01=(this.k02*this.k21-this.k01*this.k22)*L,this.d02=(this.k01*this.k12-this.k02*this.k11)*L,this.d10=(this.k12*this.k20-this.k10*this.k22)*L,this.d11=(this.k00*this.k22-this.k02*this.k20)*L,this.d12=(this.k02*this.k10-this.k00*this.k12)*L,this.d20=(this.k10*this.k21-this.k11*this.k20)*L,this.d21=(this.k01*this.k20-this.k00*this.k21)*L,this.d22=(this.k00*this.k11-this.k01*this.k10)*L;var S=this.limitImpulse1+this.motorImpulse1,P=this.limitImpulse2+this.motorImpulse2,T=this.limitImpulse3+this.motorImpulse3;this.l1.x+=S*this.l1x1+P*this.l1x2+T*this.l1x3,this.l1.y+=S*this.l1y1+P*this.l1y2+T*this.l1y3,this.l1.z+=S*this.l1z1+P*this.l1z2+T*this.l1z3,this.a1.x+=S*this.a1x1+P*this.a1x2+T*this.a1x3,this.a1.y+=S*this.a1y1+P*this.a1y2+T*this.a1y3,this.a1.z+=S*this.a1z1+P*this.a1z2+T*this.a1z3,this.l2.x-=S*this.l2x1+P*this.l2x2+T*this.l2x3,this.l2.y-=S*this.l2y1+P*this.l2y2+T*this.l2y3,this.l2.z-=S*this.l2z1+P*this.l2z2+T*this.l2z3,this.a2.x-=S*this.a2x1+P*this.a2x2+T*this.a2x3,this.a2.y-=S*this.a2y1+P*this.a2y2+T*this.a2y3,this.a2.z-=S*this.a2z1+P*this.a2z2+T*this.a2z3},solve:function(){var i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,t=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=i*this.ax1+t*this.ay1+s*this.az1,e=i*this.ax2+t*this.ay2+s*this.az2,a=i*this.ax3+t*this.ay3+s*this.az3,o=this.motorImpulse1,n=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-n),this.enableMotor3&&(m=(a-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,a+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,a-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,x=this.limitImpulse2,u=this.limitImpulse3,y=h*this.d00+e*this.d01+a*this.d02,d=h*this.d10+e*this.d11+a*this.d12,f=h*this.d20+e*this.d21+a*this.d22;this.limitImpulse1+=y,this.limitImpulse2+=d,this.limitImpulse3+=f;var N=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(y=-p,e+=y*this.k10,a+=y*this.k20,N|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-x,h+=d*this.k01,a+=d*this.k21,N|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-u,h+=f*this.k02,e+=f*this.k12,N|=4);var v;switch(N){case 1:v=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*a)*v,f=(-this.k21*e+this.k11*a)*v;break;case 2:v=1/(this.k00*this.k22-this.k02*this.k20),y=(this.k22*h+-this.k02*a)*v,f=(-this.k20*h+this.k00*a)*v;break;case 3:f=a/this.k22;break;case 4:v=1/(this.k00*this.k11-this.k01*this.k10),y=(this.k11*h+-this.k01*e)*v,d=(-this.k10*h+this.k00*e)*v;break;case 5:d=e/this.k11;break;case 6:y=h/this.k00}this.limitImpulse1=p+y,this.limitImpulse2=x+d,this.limitImpulse3=u+f;var b=l+y,z=c+d,k=m+f;this.l1.x+=b*this.l1x1+z*this.l1x2+k*this.l1x3,this.l1.y+=b*this.l1y1+z*this.l1y2+k*this.l1y3,this.l1.z+=b*this.l1z1+z*this.l1z2+k*this.l1z3,this.a1.x+=b*this.a1x1+z*this.a1x2+k*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+k*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+k*this.a1z3,this.l2.x-=b*this.l2x1+z*this.l2x2+k*this.l2x3,this.l2.y-=b*this.l2y1+z*this.l2y2+k*this.l2y3,this.l2.z-=b*this.l2z1+z*this.l2z2+k*this.l2z3,this.a2.x-=b*this.a2x1+z*this.a2x2+k*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+k*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+k*this.a2z3}}),g.prototype=Object.create(d.prototype),g.prototype.constructor=g,g.prototype.preSolve=function(i,t){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var n=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],r=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],l=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],c=e*this.body2.inverseMass+n*this.body1.inverseMass,m=a*this.body2.inverseMass+r*this.body1.inverseMass,p=o*this.body2.inverseMass+l*this.body1.inverseMass;h=Si.sqrt(c*c+m*m+p*p),h>0&&(h=1/h),c*=h,m*=h,p*=h;var x=m*c-p*p,u=-p*m-c*c,y=c*p+m*m;h=1/Si.sqrt(x*x+u*u+y*y),x*=h,u*=h,y*=h;var d=m*y-p*u,f=p*x-c*y,N=c*u-m*x;this.nor.init(c,m,p),this.tan.init(x,u,y),this.bin.init(d,f,N),this.ac.preSolve(i,t),this.t3.preSolve(i,t)},g.prototype.solve=function(){this.ac.solve(),this.t3.solve()},g.prototype.postSolve=function(){},I.prototype=Object.create(d.prototype),I.prototype.constructor=I,I.prototype.preSolve=function(i,t){var s,h,e,a;this.updateAnchorPoints(),s=this.body1.rotation.elements;var o=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],n=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],r=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],l=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],c=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],m=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var p=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],x=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],y=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],d=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],f=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],N=o*this.body2.inverseMass+p*this.body1.inverseMass,v=n*this.body2.inverseMass+x*this.body1.inverseMass,b=r*this.body2.inverseMass+u*this.body1.inverseMass;h=Si.sqrt(N*N+v*v+b*b),h>0&&(h=1/h),N*=h,v*=h,b*=h;var z=v*N-b*b,k=-b*v-N*N,A=N*b+v*v;h=1/Si.sqrt(z*z+k*k+A*A),z*=h,k*=h,A*=h;var w=v*A-b*k,g=b*z-N*A,I=N*k-v*z;this.nor.init(N,v,b),this.tan.init(z,k,A),this.bin.init(w,g,I),N*(c*f-m*d)+v*(m*y-l*f)+b*(l*d-c*y)<0?this.rotationalLimitMotor.angle=-Si.acosClamp(l*y+c*d+m*f):this.rotationalLimitMotor.angle=Si.acosClamp(l*y+c*d+m*f),h=n*u-r*x,e=r*p-o*u,a=o*x-n*p,this.r3.limitMotor2.angle=z*h+k*e+A*a,this.r3.limitMotor3.angle=w*h+g*e+I*a,this.r3.preSolve(i,t),this.t3.preSolve(i,t)},I.prototype.solve=function(){this.r3.solve(),this.t3.solve()},I.prototype.postSolve=function(){},M.prototype=Object.create(d.prototype),M.prototype.constructor=M,M.prototype.preSolve=function(i,t){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],a=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],o=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],n=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],r=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],l=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var c=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],m=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],p=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],x=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],u=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],y=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=e*c+a*m+o*p,e*(r*p-l*m)+a*(l*c-n*p)+o*(n*m-r*c)<0?this.rotationalLimitMotor1.angle=-Si.acosClamp(n*c+r*m+l*p):this.rotationalLimitMotor1.angle=Si.acosClamp(n*c+r*m+l*p),c*(u*o-y*a)+m*(y*e-x*o)+p*(x*a-u*e)<0?this.rotationalLimitMotor2.angle=Si.acosClamp(x*e+u*a+y*o):this.rotationalLimitMotor2.angle=-Si.acosClamp(x*e+u*a+y*o);var d=m*o-p*a,f=p*e-c*o,N=c*a-m*e;h=Si.sqrt(d*d+f*f+N*N),h>0&&(h=1/h),d*=h,f*=h,N*=h;var v=f*p-N*m,b=N*c-d*p,z=d*m-f*c;h=Si.sqrt(v*v+b*b+z*z),h>0&&(h=1/h),v*=h,b*=h,z*=h;var k=a*N-o*f,A=o*d-e*N,w=e*f-a*d;h=Si.sqrt(k*k+A*A+w*w),h>0&&(h=1/h),k*=h,A*=h,w*=h,this.nor.init(d,f,N),this.tan.init(v,b,z),this.bin.init(k,A,w),this.r3.preSolve(i,t),this.t3.preSolve(i,t)},M.prototype.solve=function(){this.r3.solve(),this.t3.solve()},M.prototype.postSolve=function(){},Y.prototype={constructor:Y,reset:function(i,t){this.body1=i.parent,this.body2=t.parent,this.numPoints=0},addPoint:function(i,s,h,e,a,o,n,r){var l=this.points[this.numPoints++];l.position.set(i,s,h),l.localPoint1.mulManifold(this.body1.rotation,(new t).sub(l.position,this.body1.position)),l.localPoint2.mulManifold(this.body2.rotation,(new t).sub(l.position,this.body2.position)),l.normalImpulse=0,l.normal.set(e,a,o),r&&l.normal.negate(),l.penetration=n,l.warmStarted=!1}},Z.prototype=Object.create(u.prototype),Z.prototype.constructor=Z,Z.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},Z.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},Z.prototype.preSolve=function(i,t){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements,e=this.p1.x,a=this.p1.y,o=this.p1.z,n=this.p2.x,r=this.p2.y,l=this.p2.z,c=this.m1+this.m2;this.num=this.manifold.numPoints;for(var m=this.cs,p=0;p<this.num;p++){var x,u,y,d,f,N,v=this.ps[p];x=v.position.x,u=v.position.y,y=v.position.z;var b=x-e,z=u-a,k=y-o,A=x-n,w=u-r,g=y-l;m.rp1X=b,m.rp1Y=z,m.rp1Z=k,m.rp2X=A,m.rp2Y=w,m.rp2Z=g,m.norImp=v.normalImpulse,m.tanImp=v.tangentImpulse,m.binImp=v.binormalImpulse;var I=v.normal.x,M=v.normal.y,L=v.normal.z,S=this.lv2.x+this.av2.y*g-this.av2.z*w-(this.lv1.x+this.av1.y*k-this.av1.z*z),P=this.lv2.y+this.av2.z*A-this.av2.x*g-(this.lv1.y+this.av1.z*b-this.av1.x*k),T=this.lv2.z+this.av2.x*w-this.av2.y*A-(this.lv1.z+this.av1.x*z-this.av1.y*b),V=I*S+M*P+L*T,Y=S-V*I,X=P-V*M,Z=T-V*L,U=Y*Y+X*X+Z*Z;U>.04?U=1/Si.sqrt(U):(Y=M*I-L*L,X=-L*M-I*I,Z=I*L+M*M,U=1/Si.sqrt(Y*Y+X*X+Z*Z)),Y*=U,X*=U,Z*=U;var D=M*Z-L*X,C=L*Y-I*Z,j=I*X-M*Y;m.norX=I,m.norY=M,m.norZ=L,m.tanX=Y,m.tanY=X,m.tanZ=Z,m.binX=D,m.binY=C,m.binZ=j,m.norU1X=I*this.m1,m.norU1Y=M*this.m1,m.norU1Z=L*this.m1,m.norU2X=I*this.m2,m.norU2Y=M*this.m2,m.norU2Z=L*this.m2,m.tanU1X=Y*this.m1,m.tanU1Y=X*this.m1,m.tanU1Z=Z*this.m1,m.tanU2X=Y*this.m2,m.tanU2Y=X*this.m2,m.tanU2Z=Z*this.m2,m.binU1X=D*this.m1,m.binU1Y=C*this.m1,m.binU1Z=j*this.m1,m.binU2X=D*this.m2,m.binU2Y=C*this.m2,m.binU2Z=j*this.m2;var O=z*L-k*M,q=k*I-b*L,E=b*M-z*I,F=w*L-g*M,B=g*I-A*L,R=A*M-w*I,W=z*Z-k*X,_=k*Y-b*Z,J=b*X-z*Y,H=w*Z-g*X,Q=g*Y-A*Z,G=A*X-w*Y,K=z*j-k*C,$=k*D-b*j,ii=b*C-z*D,ti=w*j-g*C,si=g*D-A*j,hi=A*C-w*D,ei=O*s[0]+q*s[1]+E*s[2],ai=O*s[3]+q*s[4]+E*s[5],oi=O*s[6]+q*s[7]+E*s[8],ni=F*h[0]+B*h[1]+R*h[2],ri=F*h[3]+B*h[4]+R*h[5],li=F*h[6]+B*h[7]+R*h[8],ci=W*s[0]+_*s[1]+J*s[2],mi=W*s[3]+_*s[4]+J*s[5],pi=W*s[6]+_*s[7]+J*s[8],xi=H*h[0]+Q*h[1]+G*h[2],ui=H*h[3]+Q*h[4]+G*h[5],yi=H*h[6]+Q*h[7]+G*h[8],di=K*s[0]+$*s[1]+ii*s[2],fi=K*s[3]+$*s[4]+ii*s[5],Ni=K*s[6]+$*s[7]+ii*s[8],vi=ti*h[0]+si*h[1]+hi*h[2],bi=ti*h[3]+si*h[4]+hi*h[5],zi=ti*h[6]+si*h[7]+hi*h[8];m.norT1X=O,m.norT1Y=q,m.norT1Z=E,m.tanT1X=W,m.tanT1Y=_,m.tanT1Z=J,m.binT1X=K,m.binT1Y=$,m.binT1Z=ii,m.norT2X=F,m.norT2Y=B,m.norT2Z=R,m.tanT2X=H,m.tanT2Y=Q,m.tanT2Z=G,m.binT2X=ti,m.binT2Y=si,m.binT2Z=hi,m.norTU1X=ei,m.norTU1Y=ai,m.norTU1Z=oi,m.tanTU1X=ci,m.tanTU1Y=mi,m.tanTU1Z=pi,m.binTU1X=di,m.binTU1Y=fi,m.binTU1Z=Ni,m.norTU2X=ni,m.norTU2Y=ri,m.norTU2Z=li,m.tanTU2X=xi,m.tanTU2Y=ui,m.tanTU2Z=yi,m.binTU2X=vi,m.binTU2Y=bi,m.binTU2Z=zi,x=O*s[0]+q*s[1]+E*s[2],u=O*s[3]+q*s[4]+E*s[5],y=O*s[6]+q*s[7]+E*s[8],d=u*k-y*z,f=y*b-x*k,N=x*z-u*b,x=F*h[0]+B*h[1]+R*h[2],u=F*h[3]+B*h[4]+R*h[5],y=F*h[6]+B*h[7]+R*h[8],d+=u*g-y*w,f+=y*A-x*g,N+=x*w-u*A;var ki=1/(c+I*d+M*f+L*N);x=W*s[0]+_*s[1]+J*s[2],u=W*s[3]+_*s[4]+J*s[5],y=W*s[6]+_*s[7]+J*s[8],d=u*k-y*z,f=y*b-x*k,N=x*z-u*b,x=H*h[0]+Q*h[1]+G*h[2],u=H*h[3]+Q*h[4]+G*h[5],y=H*h[6]+Q*h[7]+G*h[8],d+=u*g-y*w,f+=y*A-x*g,N+=x*w-u*A;var Ai=1/(c+Y*d+X*f+Z*N);x=K*s[0]+$*s[1]+ii*s[2],u=K*s[3]+$*s[4]+ii*s[5],y=K*s[6]+$*s[7]+ii*s[8],d=u*k-y*z,f=y*b-x*k,N=x*z-u*b,x=ti*h[0]+si*h[1]+hi*h[2],u=ti*h[3]+si*h[4]+hi*h[5],y=ti*h[6]+si*h[7]+hi*h[8],d+=u*g-y*w,f+=y*A-x*g,N+=x*w-u*A;var wi=1/(c+D*d+C*f+j*N);if(m.norDen=ki,m.tanDen=Ai,m.binDen=wi,v.warmStarted){var gi=v.normalImpulse;this.lv1.x+=m.norU1X*gi,this.lv1.y+=m.norU1Y*gi,this.lv1.z+=m.norU1Z*gi,this.av1.x+=ei*gi,this.av1.y+=ai*gi,this.av1.z+=oi*gi,this.lv2.x-=m.norU2X*gi,this.lv2.y-=m.norU2Y*gi,this.lv2.z-=m.norU2Z*gi,this.av2.x-=ni*gi,this.av2.y-=ri*gi,this.av2.z-=li*gi,m.norImp=gi,m.tanImp=0,m.binImp=0,V=0}else m.norImp=0,m.tanImp=0,m.binImp=0;V>-1&&(V=0);var Ii=this.restitution*-V,Mi=-(v.penetration+.005)*t*.05;Ii<Mi&&(Ii=Mi),m.norTar=Ii,m.last=p==this.num-1,m=m.next}},Z.prototype.solve=function(){for(var i=this.lv1.x,t=this.lv1.y,s=this.lv1.z,h=this.lv2.x,e=this.lv2.y,a=this.lv2.z,o=this.av1.x,n=this.av1.y,r=this.av1.z,l=this.av2.x,c=this.av2.y,m=this.av2.z,p=this.cs;;){var x,u,y,d,f,N=p.norImp,v=p.tanImp,b=p.binImp,z=-N*this.friction,k=h-i,A=e-t,w=a-s;f=k*p.tanX+A*p.tanY+w*p.tanZ+l*p.tanT2X+c*p.tanT2Y+m*p.tanT2Z-o*p.tanT1X-n*p.tanT1Y-r*p.tanT1Z,x=v,u=f*p.tanDen,v+=u,f=k*p.binX+A*p.binY+w*p.binZ+l*p.binT2X+c*p.binT2Y+m*p.binT2Z-o*p.binT1X-n*p.binT1Y-r*p.binT1Z,y=b,d=f*p.binDen,b+=d;var g=v*v+b*b;if(g>z*z&&(g=z/Si.sqrt(g),v*=g,b*=g),u=v-x,d=b-y,i+=p.tanU1X*u+p.binU1X*d,t+=p.tanU1Y*u+p.binU1Y*d,s+=p.tanU1Z*u+p.binU1Z*d,o+=p.tanTU1X*u+p.binTU1X*d,n+=p.tanTU1Y*u+p.binTU1Y*d,r+=p.tanTU1Z*u+p.binTU1Z*d,h-=p.tanU2X*u+p.binU2X*d,e-=p.tanU2Y*u+p.binU2Y*d,a-=p.tanU2Z*u+p.binU2Z*d,l-=p.tanTU2X*u+p.binTU2X*d,c-=p.tanTU2Y*u+p.binTU2Y*d,m-=p.tanTU2Z*u+p.binTU2Z*d,f=(h-i)*p.norX+(e-t)*p.norY+(a-s)*p.norZ+l*p.norT2X+c*p.norT2Y+m*p.norT2Z-o*p.norT1X-n*p.norT1Y-r*p.norT1Z,x=N,u=(f-p.norTar)*p.norDen,N+=u,N>0&&(N=0),u=N-x,i+=p.norU1X*u,t+=p.norU1Y*u,s+=p.norU1Z*u,o+=p.norTU1X*u,n+=p.norTU1Y*u,r+=p.norTU1Z*u,h-=p.norU2X*u,e-=p.norU2Y*u,a-=p.norU2Z*u,l-=p.norTU2X*u,c-=p.norTU2Y*u,m-=p.norTU2Z*u,p.norImp=N,p.tanImp=v,p.binImp=b,p.last)break;p=p.next}this.lv1.x=i,this.lv1.y=t,this.lv1.z=s,this.lv2.x=h,this.lv2.y=e,this.lv2.z=a,this.av1.x=o,this.av1.y=n,this.av1.z=r,this.av2.x=l,this.av2.y=c,this.av2.z=m},Z.prototype.postSolve=function(){for(var i=this.cs,t=this.num;t--;){var s=this.ps[t];s.normal.x=i.norX,s.normal.y=i.norY,s.normal.z=i.norZ,s.tangent.x=i.tanX,s.tangent.y=i.tanY,s.tangent.z=i.tanZ,s.binormal.x=i.binX,s.binormal.y=i.binY,s.binormal.z=i.binZ,s.normalImpulse=i.norImp,s.tangentImpulse=i.tanImp,s.binormalImpulse=i.binImp,s.normalDenominator=i.norDen,s.tangentDenominator=i.tanDen,s.binormalDenominator=i.binDen,i=i.next}},Object.assign(U.prototype,{Contact:!0,mixRestitution:function(i,t){return Si.sqrt(i*t)},mixFriction:function(i,t){return Si.sqrt(i*t)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var i=this.manifold.numPoints,t=i;t--;){var s=this.buffer[t],h=this.points[t];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,
t=e;t--;){h=this.points[t];for(var a=h.localPoint1.x,o=h.localPoint1.y,n=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,x=i;x--;){s=this.buffer[x];var u=s.lp1X-a,y=s.lp1Y-o,d=s.lp1Z-n,f=u*u+y*y+d*d;u=s.lp2X-r,y=s.lp2Y-l,d=s.lp2Z-c;var N=u*u+y*y+d*d;f<N?f<p&&(p=f,m=x):N<p&&(p=N,m=x)}if(m!=-1){var v=this.buffer[m];this.buffer[m]=this.buffer[--i],this.buffer[i]=v,h.normalImpulse=v.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(i,t){this.shape1=i,this.shape2=t,this.body1=i.parent,this.body2=t.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=t,this.s1Link.body=this.body2,this.s2Link.shape=i,this.s2Link.body=this.body1,null!=i.contactLink?(this.s1Link.next=i.contactLink).prev=this.s1Link:this.s1Link.next=null,i.contactLink=this.s1Link,i.numContacts++,null!=t.contactLink?(this.s2Link.next=t.contactLink).prev=this.s2Link:this.s2Link.next=null,t.contactLink=this.s2Link,t.numContacts++,this.b1Link.shape=t,this.b1Link.body=this.body2,this.b2Link.shape=i,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var i=this.s1Link.prev,t=this.s1Link.next;null!==i&&(i.next=t),null!==t&&(t.prev=i),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=t),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,i=this.s2Link.prev,t=this.s2Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=t),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,i=this.b1Link.prev,t=this.b1Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=t),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,i=this.b2Link.prev,t=this.b2Link.next,null!==i&&(i.next=t),null!==t&&(t.prev=i),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=t),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}}),Object.assign(D.prototype,{RigidBody:!0,addShape:function(i){i.parent&&e("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=i).next=this.shapes),this.shapes=i,i.parent=this,this.parent&&this.parent.addShape(i),this.numShapes++},removeShape:function(i){var t=i;if(t.parent==this){var s=t.prev,h=t.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==t&&(this.shapes=h),t.prev=null,t.next=null,t.parent=null,this.parent&&this.parent.removeShape(t),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(i){this.parent.checkContact(this.name,i)},setupMass:function(i,s){var e=void 0===s||s;this.type=i||xi,this.isDynamic=this.type===pi,this.isStatic=this.type===xi,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var a=new h,o=new t,n=this.shapes;null!==n;n=n.next){n.calculateMassInfo(this.massInfo);var r=this.massInfo.mass;o.addScale(n.relativePosition,r),this.mass+=r,this.rotateInertia(n.relativeRotation,this.massInfo.inertia,a),this.localInertia.addEqual(a),this.localInertia.addOffset(r,n.relativePosition)}if(this.inverseMass=1/this.mass,o.scaleEqual(this.inverseMass),e){for(this.position.addEqual(o),n=this.shapes;null!==n;n=n.next)n.relativePosition.subEqual(o);this.localInertia.subOffset(this.mass,o)}this.inverseLocalInertia.invert(this.localInertia),this.type===xi&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var i=this.contactLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var t=this.jointLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var i=this.shapes;null!=i;i=i.next)i.updateProxy()}},testWakeUp:function(){(this.linearVelocity.testZero()||this.angularVelocity.testZero()||this.position.testDiff(this.sleepPosition)||this.orientation.testDiff(this.sleepOrientation))&&this.awake()},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(i){switch(this.type){case xi:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case pi:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/i,this.linearVelocity.y=(this.newPosition.y-this.position.y)/i,this.linearVelocity.z=(this.newPosition.z-this.position.z)/i,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,i),this.orientation.addTime(this.angularVelocity,i);break;default:e("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(i,t,s){var h=i.elements,e=t.elements,a=h[0],o=h[3],n=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],x=h[8],u=e[0],y=e[3],d=e[6],f=e[1],N=e[4],v=e[7],b=e[2],z=e[5],k=e[8],A=a*u+r*y+m*d,w=a*f+r*N+m*v,g=a*b+r*z+m*k,I=o*u+l*y+p*d,M=o*f+l*N+p*v,L=o*b+l*z+p*k,S=n*u+c*y+x*d,P=n*f+c*N+x*v,T=n*b+c*z+x*k,V=s.elements;V[0]=A*a+w*r+g*m,V[1]=A*o+w*l+g*p,V[2]=A*n+w*c+g*x,V[3]=I*a+M*r+L*m,V[4]=I*o+M*l+L*p,V[5]=I*n+M*c+L*x,V[6]=S*a+P*r+T*m,V[7]=S*o+P*l+T*p,V[8]=S*n+P*c+T*x},syncShapes:function(){var i=this.orientation.w,t=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*t,a=2*s,o=2*h,n=t*e,r=s*a,l=h*o,c=t*a,m=s*o,p=t*o,x=i*e,u=i*a,y=i*o,d=this.rotation.elements;d[0]=1-r-l,d[1]=c-y,d[2]=p+u,d[3]=c+y,d[4]=1-n-l,d[5]=m-x,d[6]=p-u,d[7]=m+x,d[8]=1-n-r,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var f=this.shapes;null!=f;f=f.next)f.position.mul(this.position,f.relativePosition,this.rotation),f.rotation.mul(this.rotation,f.relativeRotation),f.updateProxy()},applyImpulse:function(i,s){this.linearVelocity.addScale(s,this.inverseMass);var h=new t;h.sub(i,this.position).cross(h,s).mulMat(this.inverseInertia,h),this.angularVelocity.addEqual(h)},setPosition:function(i){this.newPosition.copy(i).multiplyScalar(this.invScale),this.controlPos=!0},setQuaternion:function(i){this.newOrientation.set(i.x,i.y,i.z,i.w),this.controlRot=!0},setRotation:function(i){this.newOrientation=(new s).setFromEuler(i.x*Si.degtorad,i.y*Si.degtorad,i.y*Si.degtorad),this.controlRot=!0},resetPosition:function(i,t,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(i,t,s).multiplyScalar(this.invScale),this.awake()},resetQuaternion:function(i){this.angularVelocity.set(0,0,0),this.orientation=new s(i.x,i.y,i.z,i.w),this.awake()},resetRotation:function(i,t,h){this.angularVelocity.set(0,0,0),this.orientation=(new s).setFromEuler(i*Si.degtorad,t*Si.degtorad,h*Si.degtorad),this.awake()},getPosition:function(){return(new t).scale(this.position,this.scale)},getQuaternion:function(){return(new s).setFromRotationMatrix(this.rotation)}}),Object.assign(j.prototype,{BroadPhase:!0,createProxy:function(i){e("BroadPhase","Inheritance error.")},addProxy:function(i){e("BroadPhase","Inheritance error.")},removeProxy:function(i){e("BroadPhase","Inheritance error.")},isAvailablePair:function(i,t){var s=i.parent,h=t.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(i.belongsTo&t.collidesWith)||0==(t.belongsTo&i.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!==e;){var a=e.joint;if(!a.allowCollision&&(a.body1==s&&a.body2==h||a.body1==h&&a.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){e("BroadPhase","Inheritance error.")},addPair:function(i,t){var s=new C(i,t);this.pairs.push(s),this.numPairs++}});var Ti=0;Object.assign(q.prototype,{Proxy:!0,update:function(){e("Proxy","Inheritance error.")}}),E.prototype=Object.create(q.prototype),E.prototype.constructor=E,E.prototype.update=function(){},F.prototype=Object.create(j.prototype),F.prototype.constructor=F,F.prototype.createProxy=function(i){return new E(i)},F.prototype.addProxy=function(i){this.proxies.push(i)},F.prototype.removeProxy=function(i){var t=this.proxies.indexOf(i);t>-1&&this.proxies.splice(t,1)},F.prototype.collectPairs=function(){var i,t,s,h=0,e=this.proxies,a=e.length;for(this.numPairChecks=a*(a-1)>>1;h<a;)for(t=e[h++],i=h+1;i<a;)s=e[i++],!t.aabb.intersectTest(s.aabb)&&this.isAvailablePair(t.shape,s.shape)&&this.addPair(t.shape,s.shape)},Object.assign(B.prototype,{SAPAxis:!0,addElements:function(i,t){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=i,this.elements[this.numElements++]=t},removeElements:function(i,t){for(var s=-1,h=-1,e=0,a=this.numElements;e<a;e++){var o=this.elements[e];if(o==i||o==t){if(s!=-1){h=e;break}s=e}}for(e=s+1,a=h;e<a;e++)this.elements[e-1]=this.elements[e];for(e=h+1,a=this.numElements;e<a;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var i=0,t=1;this.numElements>>t!=0;)t++;t=t*this.numElements>>2,i=0;for(var s=!1,h=this.elements,e=1,a=this.numElements;e<a;e++){var o=h[e],n=o.value,r=h[e-1];if(r.value>n){var l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);if(h[l]=o,i+=e-l,i>t){s=!0;break}}}if(s){i=2;var c=this.stack;for(c[0]=0,c[1]=this.numElements-1;i>0;){var m=c[--i],p=c[--i],x=m-p;if(x>16){var u=p+Si.floor(.5*x);for(o=h[u],h[u]=h[m],h[m]=o,n=o.value,e=p-1,l=m;;){var y,d;do y=h[++e];while(y.value<n);do d=h[--l];while(n<d.value&&l!=p);if(e>=l)break;h[e]=d,h[l]=y}h[m]=h[e],h[e]=o,e-p>m-e?(c[i++]=p,c[i++]=e-1,c[i++]=e+1,c[i++]=m):(c[i++]=e+1,c[i++]=m,c[i++]=p,c[i++]=e-1)}else for(e=p+1;e<=m;e++)if(o=h[e],n=o.value,r=h[e-1],r.value>n){l=e;do{if(h[l]=r,0==--l)break;r=h[l-1]}while(r.value>n);h[l]=o}}}},calculateTestCount:function(){for(var i=1,t=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?i--:(t+=i,i++);return t}}),W.prototype=Object.create(q.prototype),W.prototype.constructor=W,W.prototype.isDynamic=function(){var i=this.shape.parent;return i.isDynamic&&!i.sleeping},W.prototype.update=function(){var i=this.aabb.elements;this.min[0].value=i[0],this.min[1].value=i[1],this.min[2].value=i[2],this.max[0].value=i[3],this.max[1].value=i[4],this.max[2].value=i[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},_.prototype=Object.create(j.prototype),_.prototype.constructor=_,_.prototype.createProxy=function(i){return new W(this,i)},_.prototype.addProxy=function(i){var t=i;t.isDynamic()?(this.axesD[0].addElements(t.min[0],t.max[0]),this.axesD[1].addElements(t.min[1],t.max[1]),this.axesD[2].addElements(t.min[2],t.max[2]),t.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(t.min[0],t.max[0]),this.axesS[1].addElements(t.min[1],t.max[1]),this.axesS[2].addElements(t.min[2],t.max[2]),t.belongsTo=2,this.numElementsS+=2)},_.prototype.removeProxy=function(i){var t=i;if(0!=t.belongsTo){switch(t.belongsTo){case 1:this.axesD[0].removeElements(t.min[0],t.max[0]),this.axesD[1].removeElements(t.min[1],t.max[1]),this.axesD[2].removeElements(t.min[2],t.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(t.min[0],t.max[0]),this.axesS[1].removeElements(t.min[1],t.max[1]),this.axesS[2].removeElements(t.min[2],t.max[2]),this.numElementsS-=2}t.belongsTo=0}},_.prototype.collectPairs=function(){if(0!=this.numElementsD){var i=this.axesD[this.index1],t=this.axesD[this.index2];i.sort(),t.sort();var s,h,e=i.calculateTestCount(),a=t.calculateTestCount();e<=a?(t=this.axesS[this.index1],t.sort(),s=i.elements,h=t.elements):(i=this.axesS[this.index2],i.sort(),s=t.elements,h=i.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var o,n,r=0,l=0;r<this.numElementsD;){var c,m;if(l==this.numElementsS)c=s[r],m=!0,r++;else{var p=s[r],x=h[l];p.value<x.value?(c=p,m=!0,r++):(c=x,m=!1,l++)}if(c.max){var u=c.pair;if(m){if(u==o){o=o.pair;continue}c=o}else{if(u==n){n=n.pair;continue}c=n}do{if(b=c.pair,b==u){c.pair=b.pair;break}c=b}while(null!=c)}else{for(var y=c.proxy.shape,d=c.min1.value,f=c.max1.value,N=c.min2.value,v=c.max2.value,b=o;null!=b;b=b.pair){var z=b.proxy.shape;this.numPairChecks++,d>b.max1.value||f<b.min1.value||N>b.max2.value||v<b.min2.value||!this.isAvailablePair(y,z)||this.addPair(y,z)}if(m){for(b=n;null!=b;b=b.pair)z=b.proxy.shape,this.numPairChecks++,d>b.max1.value||f<b.min1.value||N>b.max2.value||v<b.min2.value||!this.isAvailablePair(y,z)||this.addPair(y,z);c.pair=o,o=c}else c.pair=n,n=c}}this.index2=3^(this.index1|this.index2)}},Object.assign(H.prototype,{DBVT:!0,moveLeaf:function(i){this.deleteLeaf(i),this.insertLeaf(i)},insertLeaf:function(i){if(null==this.root)return void(this.root=i);for(var t,s,h=i.aabb,e=this.root;null==e.proxy;){var a=e.child1,o=e.child2,n=e.aabb,r=a.aabb,l=o.aabb;t=n.surfaceArea(),this.aabb.combine(h,n),s=this.aabb.surfaceArea();var c=2*s,m=2*(s-t),p=m;this.aabb.combine(h,r),p+=null!=a.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-r.surfaceArea();var x=m;if(this.aabb.combine(h,l),x+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea(),p<x){if(c<p)break;e=a}else{if(c<x)break;e=o}}var u,y=e.parent;u=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new J,u.parent=y,u.child1=i,u.child2=e,u.aabb.combine(i.aabb,e.aabb),u.height=e.height+1,e.parent=u,i.parent=u,e==this.root?this.root=u:y.child1==e?y.child1=u:y.child2=u;do u=this.balance(u),this.fix(u),u=u.parent;while(null!=u)},getBalance:function(i){return null!=i.proxy?0:i.child1.height-i.child2.height},deleteLeaf:function(i){if(i==this.root)return void(this.root=null);var t,s=i.parent;if(t=s.child1==i?s.child2:s.child1,s==this.root)return this.root=t,void(t.parent=null);var h=s.parent;t.parent=h,h.child1==s?h.child1=t:h.child2=t,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do h=this.balance(h),this.fix(h),h=h.parent;while(null!=h)},balance:function(i){var t=i.height;if(t<2)return i;var s,h=i.parent,e=i.child1,a=i.child2,o=e.height,n=a.height,r=o-n;if(r>1){var l=e.child1,c=e.child2,m=l.height,p=c.height;return m>p?(e.child2=i,i.parent=e,i.child1=c,c.parent=i,i.aabb.combine(c.aabb,a.aabb),s=p-n,i.height=p-(s&s>>31)+1,e.aabb.combine(l.aabb,i.aabb),s=m-t,e.height=m-(s&s>>31)+1):(e.child1=i,i.parent=e,i.child1=l,l.parent=i,i.aabb.combine(l.aabb,a.aabb),s=m-n,i.height=m-(s&s>>31)+1,e.aabb.combine(i.aabb,c.aabb),s=t-p,e.height=t-(s&s>>31)+1),null!=h?h.child1==i?h.child1=e:h.child2=e:this.root=e,e.parent=h,e}if(r<-1){var x=a.child1,u=a.child2,y=x.height,d=u.height;return y>d?(a.child2=i,i.parent=a,i.child2=u,u.parent=i,i.aabb.combine(e.aabb,u.aabb),s=o-d,i.height=o-(s&s>>31)+1,a.aabb.combine(x.aabb,i.aabb),s=y-t,a.height=y-(s&s>>31)+1):(a.child1=i,i.parent=a,i.child2=x,x.parent=i,i.aabb.combine(e.aabb,x.aabb),s=o-y,i.height=o-(s&s>>31)+1,a.aabb.combine(i.aabb,u.aabb),s=t-d,a.height=t-(s&s>>31)+1),null!=h?h.child1==i?h.child1=a:h.child2=a:this.root=a,a.parent=h,a}return i},fix:function(i){var t=i.child1,s=i.child2;i.aabb.combine(t.aabb,s.aabb),i.height=t.height<s.height?s.height+1:t.height+1}}),Q.prototype=Object.create(q.prototype),Q.prototype.constructor=Q,Q.prototype.update=function(){},G.prototype=Object.create(j.prototype),G.prototype.constructor=G,G.prototype.createProxy=function(i){return new Q(i)},G.prototype.addProxy=function(i){this.tree.insertLeaf(i.leaf),this.leaves.push(i.leaf),this.numLeaves++},G.prototype.removeProxy=function(i){this.tree.deleteLeaf(i.leaf);var t=this.leaves.indexOf(i.leaf);t>-1&&(this.leaves.splice(t,1),this.numLeaves--)},G.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var i,t=.1,s=this.numLeaves;s--;)i=this.leaves[s],i.proxy.aabb.intersectTestTwo(i.aabb)&&(i.aabb.copy(i.proxy.aabb,t),this.tree.deleteLeaf(i),this.tree.insertLeaf(i),this.collide(i,this.tree.root))},G.prototype.collide=function(i,t){var s,h,e,a,o,n,r=2;for(this.stack[0]=i,this.stack[1]=t;r>0;)if(e=this.stack[--r],a=this.stack[--r],o=null!=e.proxy,n=null!=a.proxy,this.numPairChecks++,o&&n){if(s=e.proxy.shape,h=a.proxy.shape,s==h||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(a.aabb))continue;n||!o&&e.aabb.surfaceArea()>a.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=a,this.stack[r++]=e.child2,this.stack[r++]=a):(this.stack[r++]=e,this.stack[r++]=a.child1,this.stack[r++]=e,this.stack[r++]=a.child2)}},Object.assign(K.prototype,{CollisionDetector:!0,detectCollision:function(i,t,s){e("CollisionDetector","Inheritance error.")}}),$.prototype=Object.create(K.prototype),$.prototype.constructor=$,$.prototype.detectCollision=function(i,t,s){var h,e;i.id<t.id?(h=i,e=t):(h=t,e=i);var a,o,n,r,l,c,m,p,x,u,y,d,f,N,v,b,z,k,A,w,g,I,M,L,S,P,T,V,Y,X,Z,U,D,C,j,O,q=h.elements,E=e.elements,F=h.dimentions,B=e.dimentions,R=h.position,W=e.position,_=R.x,J=R.y,H=R.z,Q=W.x,G=W.y,K=W.z,$=Q-_,ii=G-J,ti=K-H,si=h.halfWidth,hi=h.halfHeight,ei=h.halfDepth,ai=e.halfWidth,oi=e.halfHeight,ni=e.halfDepth,ri=F[0],li=F[1],ci=F[2],mi=F[3],pi=F[4],xi=F[5],ui=F[6],yi=F[7],di=F[8],fi=F[9],Ni=F[10],vi=F[11],bi=F[12],zi=F[13],ki=F[14],Ai=F[15],wi=F[16],gi=F[17],Ii=B[0],Mi=B[1],Li=B[2],Pi=B[3],Ti=B[4],Vi=B[5],Yi=B[6],Xi=B[7],Zi=B[8],Ui=B[9],Di=B[10],Ci=B[11],ji=B[12],Oi=B[13],qi=B[14],Ei=B[15],Fi=B[16],Bi=B[17],Ri=li*Li-ci*Mi,Wi=ci*Ii-ri*Li,_i=ri*Mi-li*Ii,Ji=li*Vi-ci*Ti,Hi=ci*Pi-ri*Vi,Qi=ri*Ti-li*Pi,Gi=li*Zi-ci*Xi,Ki=ci*Yi-ri*Zi,$i=ri*Xi-li*Yi,it=pi*Li-xi*Mi,tt=xi*Ii-mi*Li,st=mi*Mi-pi*Ii,ht=pi*Vi-xi*Ti,et=xi*Pi-mi*Vi,at=mi*Ti-pi*Pi,ot=pi*Zi-xi*Xi,nt=xi*Yi-mi*Zi,rt=mi*Xi-pi*Yi,lt=yi*Li-di*Mi,ct=di*Ii-ui*Li,mt=ui*Mi-yi*Ii,pt=yi*Vi-di*Ti,xt=di*Pi-ui*Vi,ut=ui*Ti-yi*Pi,yt=yi*Zi-di*Xi,dt=di*Yi-ui*Zi,ft=ui*Xi-yi*Yi,Nt=!1,vt=!1,bt=!1,zt=!1,kt=!1,At=!1,wt=!1,gt=!1,It=!1;if(Z=ri*$+li*ii+ci*ti,a=Z>0,a||(Z=-Z),U=si,C=ri*Ii+li*Mi+ci*Li,j=ri*Pi+li*Ti+ci*Vi,O=ri*Yi+li*Xi+ci*Zi,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),D=C*ai+j*oi+O*ni,b=Z-U-D,!(b>0||(Z=mi*$+pi*ii+xi*ti,o=Z>0,o||(Z=-Z),U=hi,C=mi*Ii+pi*Mi+xi*Li,j=mi*Pi+pi*Ti+xi*Vi,O=mi*Yi+pi*Xi+xi*Zi,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),D=C*ai+j*oi+O*ni,z=Z-U-D,z>0||(Z=ui*$+yi*ii+di*ti,n=Z>0,n||(Z=-Z),U=ei,C=ui*Ii+yi*Mi+di*Li,j=ui*Pi+yi*Ti+di*Vi,O=ui*Yi+yi*Xi+di*Zi,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),D=C*ai+j*oi+O*ni,k=Z-U-D,k>0||(Z=Ii*$+Mi*ii+Li*ti,r=Z>0,r||(Z=-Z),C=Ii*ri+Mi*li+Li*ci,j=Ii*mi+Mi*pi+Li*xi,O=Ii*ui+Mi*yi+Li*di,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),U=C*si+j*hi+O*ei,D=ai,A=1*(Z-U-D),A>0||(Z=Pi*$+Ti*ii+Vi*ti,l=Z>0,l||(Z=-Z),C=Pi*ri+Ti*li+Vi*ci,j=Pi*mi+Ti*pi+Vi*xi,O=Pi*ui+Ti*yi+Vi*di,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),U=C*si+j*hi+O*ei,D=oi,w=1*(Z-U-D),w>0||(Z=Yi*$+Xi*ii+Zi*ti,c=Z>0,c||(Z=-Z),C=Yi*ri+Xi*li+Zi*ci,j=Yi*mi+Xi*pi+Zi*xi,O=Yi*ui+Xi*yi+Zi*di,C<0&&(C=-C),j<0&&(j=-j),O<0&&(O=-O),U=C*si+j*hi+O*ei,D=ni,g=1*(Z-U-D),g>0))))))){if(Z=Ri*Ri+Wi*Wi+_i*_i,Z>1e-5){if(Z=1/Si.sqrt(Z),Ri*=Z,Wi*=Z,_i*=Z,Z=Ri*$+Wi*ii+_i*ti,m=Z>0,m||(Z=-Z),C=Ri*mi+Wi*pi+_i*xi,j=Ri*ui+Wi*yi+_i*di,C<0&&(C=-C),j<0&&(j=-j),U=C*hi+j*ei,C=Ri*Pi+Wi*Ti+_i*Vi,j=Ri*Yi+Wi*Xi+_i*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*oi+j*ni,I=Z-U-D,I>0)return}else m=!1,I=0,Nt=!0;if(Z=Ji*Ji+Hi*Hi+Qi*Qi,Z>1e-5){if(Z=1/Si.sqrt(Z),Ji*=Z,Hi*=Z,Qi*=Z,Z=Ji*$+Hi*ii+Qi*ti,p=Z>0,p||(Z=-Z),C=Ji*mi+Hi*pi+Qi*xi,j=Ji*ui+Hi*yi+Qi*di,C<0&&(C=-C),j<0&&(j=-j),U=C*hi+j*ei,C=Ji*Ii+Hi*Mi+Qi*Li,j=Ji*Yi+Hi*Xi+Qi*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*ni,M=Z-U-D,M>0)return}else p=!1,M=0,vt=!0;if(Z=Gi*Gi+Ki*Ki+$i*$i,Z>1e-5){if(Z=1/Si.sqrt(Z),Gi*=Z,Ki*=Z,$i*=Z,Z=Gi*$+Ki*ii+$i*ti,x=Z>0,x||(Z=-Z),C=Gi*mi+Ki*pi+$i*xi,j=Gi*ui+Ki*yi+$i*di,C<0&&(C=-C),j<0&&(j=-j),U=C*hi+j*ei,C=Gi*Ii+Ki*Mi+$i*Li,j=Gi*Pi+Ki*Ti+$i*Vi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*oi,L=Z-U-D,L>0)return}else x=!1,L=0,bt=!0;if(Z=it*it+tt*tt+st*st,Z>1e-5){if(Z=1/Si.sqrt(Z),it*=Z,tt*=Z,st*=Z,Z=it*$+tt*ii+st*ti,u=Z>0,u||(Z=-Z),C=it*ri+tt*li+st*ci,j=it*ui+tt*yi+st*di,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*ei,C=it*Pi+tt*Ti+st*Vi,j=it*Yi+tt*Xi+st*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*oi+j*ni,S=Z-U-D,S>0)return}else u=!1,S=0,zt=!0;if(Z=ht*ht+et*et+at*at,Z>1e-5){if(Z=1/Si.sqrt(Z),ht*=Z,et*=Z,at*=Z,Z=ht*$+et*ii+at*ti,y=Z>0,y||(Z=-Z),C=ht*ri+et*li+at*ci,j=ht*ui+et*yi+at*di,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*ei,C=ht*Ii+et*Mi+at*Li,j=ht*Yi+et*Xi+at*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*ni,P=Z-U-D,P>0)return}else y=!1,P=0,kt=!0;if(Z=ot*ot+nt*nt+rt*rt,Z>1e-5){if(Z=1/Si.sqrt(Z),ot*=Z,nt*=Z,rt*=Z,Z=ot*$+nt*ii+rt*ti,d=Z>0,d||(Z=-Z),C=ot*ri+nt*li+rt*ci,j=ot*ui+nt*yi+rt*di,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*ei,C=ot*Ii+nt*Mi+rt*Li,j=ot*Pi+nt*Ti+rt*Vi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*oi,T=Z-U-D,T>0)return}else d=!1,T=0,At=!0;if(Z=lt*lt+ct*ct+mt*mt,Z>1e-5){if(Z=1/Si.sqrt(Z),lt*=Z,ct*=Z,mt*=Z,Z=lt*$+ct*ii+mt*ti,f=Z>0,f||(Z=-Z),C=lt*ri+ct*li+mt*ci,j=lt*mi+ct*pi+mt*xi,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*hi,C=lt*Pi+ct*Ti+mt*Vi,j=lt*Yi+ct*Xi+mt*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*oi+j*ni,V=Z-U-D,V>0)return}else f=!1,V=0,wt=!0;if(Z=pt*pt+xt*xt+ut*ut,Z>1e-5){if(Z=1/Si.sqrt(Z),pt*=Z,xt*=Z,ut*=Z,Z=pt*$+xt*ii+ut*ti,N=Z>0,N||(Z=-Z),C=pt*ri+xt*li+ut*ci,j=pt*mi+xt*pi+ut*xi,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*hi,C=pt*Ii+xt*Mi+ut*Li,j=pt*Yi+xt*Xi+ut*Zi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*ni,Y=Z-U-D,Y>0)return}else N=!1,Y=0,gt=!0;if(Z=yt*yt+dt*dt+ft*ft,Z>1e-5){if(Z=1/Si.sqrt(Z),yt*=Z,dt*=Z,ft*=Z,Z=yt*$+dt*ii+ft*ti,v=Z>0,v||(Z=-Z),C=yt*ri+dt*li+ft*ci,j=yt*mi+dt*pi+ft*xi,C<0&&(C=-C),j<0&&(j=-j),U=C*si+j*hi,C=yt*Ii+dt*Mi+ft*Li,j=yt*Pi+dt*Ti+ft*Vi,C<0&&(C=-C),j<0&&(j=-j),D=C*ai+j*oi,X=Z-U-D,X>0)return}else v=!1,X=0,It=!0;var Mt=b,Lt=b,St=0,Pt=a;z>Lt&&(Mt=z,Lt=z,St=1,Pt=o),k>Lt&&(Mt=k,Lt=k,St=2,Pt=n),A>Lt&&(Mt=A,Lt=A,St=3,Pt=r),w>Lt&&(Mt=w,Lt=w,St=4,Pt=l),g>Lt&&(Mt=g,Lt=g,St=5,Pt=c),I-.01>Lt&&!Nt&&(Mt=I,Lt=I-.01,St=6,Pt=m),M-.01>Lt&&!vt&&(Mt=M,Lt=M-.01,St=7,Pt=p),L-.01>Lt&&!bt&&(Mt=L,Lt=L-.01,St=8,Pt=x),S-.01>Lt&&!zt&&(Mt=S,Lt=S-.01,St=9,Pt=u),P-.01>Lt&&!kt&&(Mt=P,Lt=P-.01,St=10,Pt=y),T-.01>Lt&&!At&&(Mt=T,Lt=T-.01,St=11,Pt=d),V-.01>Lt&&!wt&&(Mt=V,Lt=V-.01,St=12,Pt=f),Y-.01>Lt&&!gt&&(Mt=Y,Lt=Y-.01,St=13,Pt=N),X-.01>Lt&&!It&&(Mt=X,St=14,Pt=v);var Tt=0,Vt=0,Yt=0,Xt=0,Zt=0,Ut=0,Dt=0,Ct=0,jt=0,Ot=0,qt=0,Et=0,Ft=0,Bt=0,Rt=0,Wt=0,_t=0,Jt=0,Ht=!1;if(0==St?(Pt?(Ot=_+fi,qt=J+Ni,Et=H+vi,Tt=ri,Vt=li,Yt=ci):(Ot=_-fi,qt=J-Ni,Et=H-vi,Tt=-ri,Vt=-li,Yt=-ci),Ft=bi,Bt=zi,Rt=ki,Xt=-mi,Zt=-pi,Ut=-xi,Wt=Ai,_t=wi,Jt=gi,Dt=-ui,Ct=-yi,jt=-di):1==St?(Pt?(Ot=_+bi,qt=J+zi,Et=H+ki,Tt=mi,Vt=pi,Yt=xi):(Ot=_-bi,qt=J-zi,Et=H-ki,Tt=-mi,Vt=-pi,Yt=-xi),Ft=fi,Bt=Ni,Rt=vi,Xt=-ri,Zt=-li,Ut=-ci,Wt=Ai,_t=wi,Jt=gi,Dt=-ui,Ct=-yi,jt=-di):2==St?(Pt?(Ot=_+Ai,qt=J+wi,Et=H+gi,Tt=ui,Vt=yi,Yt=di):(Ot=_-Ai,qt=J-wi,Et=H-gi,Tt=-ui,Vt=-yi,Yt=-di),Ft=fi,Bt=Ni,Rt=vi,Xt=-ri,Zt=-li,Ut=-ci,Wt=bi,_t=zi,Jt=ki,Dt=-mi,Ct=-pi,jt=-xi):3==St?(Ht=!0,Pt?(Ot=Q-Ui,qt=G-Di,Et=K-Ci,Tt=-Ii,Vt=-Mi,Yt=-Li):(Ot=Q+Ui,qt=G+Di,Et=K+Ci,Tt=Ii,Vt=Mi,Yt=Li),Ft=ji,Bt=Oi,Rt=qi,Xt=-Pi,Zt=-Ti,Ut=-Vi,Wt=Ei,_t=Fi,Jt=Bi,Dt=-Yi,Ct=-Xi,jt=-Zi):4==St?(Ht=!0,Pt?(Ot=Q-ji,qt=G-Oi,Et=K-qi,Tt=-Pi,Vt=-Ti,Yt=-Vi):(Ot=Q+ji,qt=G+Oi,Et=K+qi,Tt=Pi,Vt=Ti,Yt=Vi),Ft=Ui,Bt=Di,Rt=Ci,Xt=-Ii,Zt=-Mi,Ut=-Li,Wt=Ei,_t=Fi,Jt=Bi,Dt=-Yi,Ct=-Xi,jt=-Zi):5==St?(Ht=!0,Pt?(Ot=Q-Ei,qt=G-Fi,Et=K-Bi,Tt=-Yi,Vt=-Xi,Yt=-Zi):(Ot=Q+Ei,qt=G+Fi,Et=K+Bi,Tt=Yi,Vt=Xi,Yt=Zi),Ft=Ui,Bt=Di,Rt=Ci,Xt=-Ii,Zt=-Mi,Ut=-Li,Wt=ji,_t=Oi,Jt=qi,Dt=-Pi,Ct=-Ti,jt=-Vi):6==St?(Tt=Ri,Vt=Wi,Yt=_i,Xt=ri,Zt=li,Ut=ci,Dt=Ii,Ct=Mi,jt=Li):7==St?(Tt=Ji,Vt=Hi,Yt=Qi,Xt=ri,Zt=li,Ut=ci,Dt=Pi,Ct=Ti,jt=Vi):8==St?(Tt=Gi,Vt=Ki,Yt=$i,Xt=ri,Zt=li,Ut=ci,Dt=Yi,Ct=Xi,jt=Zi):9==St?(Tt=it,Vt=tt,Yt=st,Xt=mi,Zt=pi,Ut=xi,Dt=Ii,Ct=Mi,jt=Li):10==St?(Tt=ht,Vt=et,Yt=at,Xt=mi,Zt=pi,Ut=xi,Dt=Pi,Ct=Ti,jt=Vi):11==St?(Tt=ot,Vt=nt,Yt=rt,Xt=mi,Zt=pi,Ut=xi,Dt=Yi,Ct=Xi,jt=Zi):12==St?(Tt=lt,Vt=ct,Yt=mt,Xt=ui,Zt=yi,Ut=di,Dt=Ii,Ct=Mi,jt=Li):13==St?(Tt=pt,Vt=xt,Yt=ut,Xt=ui,Zt=yi,Ut=di,Dt=Pi,Ct=Ti,jt=Vi):14==St&&(Tt=yt,Vt=dt,Yt=ft,Xt=ui,Zt=yi,Ut=di,Dt=Yi,Ct=Xi,jt=Zi),St>5){Pt||(Tt=-Tt,Vt=-Vt,Yt=-Yt);var Qt,Gt,Kt,$t,is,ts,ss,hs,es,as,os;ts=q[0],ss=q[1],hs=q[2],Gt=Tt*ts+Vt*ss+Yt*hs,Kt=q[3],$t=q[4],is=q[5],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[6],$t=q[7],is=q[8],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[9],$t=q[10],is=q[11],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[12],$t=q[13],is=q[14],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[15],$t=q[16],is=q[17],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[18],$t=q[19],is=q[20],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),Kt=q[21],$t=q[22],is=q[23],Qt=Tt*Kt+Vt*$t+Yt*is,Qt>Gt&&(Gt=Qt,ts=Kt,ss=$t,hs=is),es=E[0],as=E[1],os=E[2],Gt=Tt*es+Vt*as+Yt*os,Kt=E[3],$t=E[4],is=E[5],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[6],$t=E[7],is=E[8],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[9],$t=E[10],is=E[11],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[12],$t=E[13],is=E[14],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[15],$t=E[16],is=E[17],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[18],$t=E[19],is=E[20],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=E[21],$t=E[22],is=E[23],Qt=Tt*Kt+Vt*$t+Yt*is,Qt<Gt&&(Gt=Qt,es=Kt,as=$t,os=is),Kt=es-ts,$t=as-ss,is=os-hs,C=Xt*Dt+Zt*Ct+Ut*jt;var ns=(Kt*(Xt-Dt*C)+$t*(Zt-Ct*C)+is*(Ut-jt*C))/(1-C*C);return void s.addPoint(ts+Xt*ns+Tt*Mt*.5,ss+Zt*ns+Vt*Mt*.5,hs+Ut*ns+Yt*Mt*.5,Tt,Vt,Yt,Mt,!1)}var rs,ls,cs,ms,ps,xs,us,ys,ds,fs,Ns,vs,bs=1,zs=0,ks=0;Ht?(zs=ri*Tt+li*Vt+ci*Yt,zs<bs&&(bs=zs,ks=0),-zs<bs&&(bs=-zs,ks=1),zs=mi*Tt+pi*Vt+xi*Yt,zs<bs&&(bs=zs,ks=2),-zs<bs&&(bs=-zs,ks=3),zs=ui*Tt+yi*Vt+di*Yt,zs<bs&&(bs=zs,ks=4),-zs<bs&&(bs=-zs,ks=5),0==ks?(rs=q[0],ls=q[1],cs=q[2],ms=q[6],ps=q[7],xs=q[8],us=q[9],ys=q[10],ds=q[11],fs=q[3],Ns=q[4],vs=q[5]):1==ks?(rs=q[15],ls=q[16],cs=q[17],ms=q[21],ps=q[22],xs=q[23],us=q[18],ys=q[19],ds=q[20],fs=q[12],Ns=q[13],vs=q[14]):2==ks?(rs=q[12],ls=q[13],cs=q[14],ms=q[0],ps=q[1],xs=q[2],us=q[3],ys=q[4],ds=q[5],fs=q[15],Ns=q[16],vs=q[17]):3==ks?(rs=q[21],ls=q[22],cs=q[23],ms=q[9],ps=q[10],xs=q[11],us=q[6],ys=q[7],ds=q[8],fs=q[18],Ns=q[19],vs=q[20]):4==ks?(rs=q[12],ls=q[13],cs=q[14],ms=q[18],ps=q[19],xs=q[20],us=q[6],ys=q[7],ds=q[8],fs=q[0],Ns=q[1],vs=q[2]):5==ks&&(rs=q[3],ls=q[4],cs=q[5],ms=q[6],ps=q[7],xs=q[8],us=q[21],ys=q[22],ds=q[23],fs=q[15],Ns=q[16],vs=q[17])):(zs=Ii*Tt+Mi*Vt+Li*Yt,zs<bs&&(bs=zs,ks=0),-zs<bs&&(bs=-zs,ks=1),zs=Pi*Tt+Ti*Vt+Vi*Yt,zs<bs&&(bs=zs,ks=2),-zs<bs&&(bs=-zs,ks=3),zs=Yi*Tt+Xi*Vt+Zi*Yt,zs<bs&&(bs=zs,ks=4),-zs<bs&&(bs=-zs,ks=5),0==ks?(rs=E[0],ls=E[1],cs=E[2],ms=E[6],ps=E[7],xs=E[8],us=E[9],ys=E[10],ds=E[11],fs=E[3],Ns=E[4],vs=E[5]):1==ks?(rs=E[15],ls=E[16],cs=E[17],ms=E[21],ps=E[22],xs=E[23],us=E[18],ys=E[19],ds=E[20],fs=E[12],Ns=E[13],vs=E[14]):2==ks?(rs=E[12],ls=E[13],cs=E[14],ms=E[0],ps=E[1],xs=E[2],us=E[3],ys=E[4],ds=E[5],fs=E[15],Ns=E[16],vs=E[17]):3==ks?(rs=E[21],ls=E[22],cs=E[23],ms=E[9],ps=E[10],xs=E[11],us=E[6],ys=E[7],ds=E[8],fs=E[18],Ns=E[19],vs=E[20]):4==ks?(rs=E[12],ls=E[13],cs=E[14],ms=E[18],ps=E[19],xs=E[20],us=E[6],ys=E[7],ds=E[8],fs=E[0],Ns=E[1],vs=E[2]):5==ks&&(rs=E[3],ls=E[4],cs=E[5],ms=E[9],ps=E[10],xs=E[11],us=E[21],ys=E[22],ds=E[23],fs=E[15],Ns=E[16],vs=E[17]));var As,ws,gs,Is,Ms,Ls,Ss,Ps,Ts;this.clipVertices1[0]=rs,this.clipVertices1[1]=ls,this.clipVertices1[2]=cs,this.clipVertices1[3]=ms,this.clipVertices1[4]=ps,this.clipVertices1[5]=xs,this.clipVertices1[6]=us,this.clipVertices1[7]=ys,this.clipVertices1[8]=ds,this.clipVertices1[9]=fs,this.clipVertices1[10]=Ns,this.clipVertices1[11]=vs,ws=0,Is=this.clipVertices1[9],Ms=this.clipVertices1[10],Ls=this.clipVertices1[11],C=(Is-Ot-Ft)*Xt+(Ms-qt-Bt)*Zt+(Ls-Et-Rt)*Ut;for(var Vs=0;Vs<4;Vs++)gs=3*Vs,Ss=this.clipVertices1[gs],Ps=this.clipVertices1[gs+1],Ts=this.clipVertices1[gs+2],j=(Ss-Ot-Ft)*Xt+(Ps-qt-Bt)*Zt+(Ts-Et-Rt)*Ut,C>0?j>0?(gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Ts):(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Ts-Ls)*ns):j>0&&(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Ts-Ls)*ns,gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Ts),Is=Ss,Ms=Ps,Ls=Ts,C=j;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Ls=this.clipVertices2[gs+2],C=(Is-Ot-Wt)*Dt+(Ms-qt-_t)*Ct+(Ls-Et-Jt)*jt,Vs=0;Vs<As;Vs++)gs=3*Vs,Ss=this.clipVertices2[gs],Ps=this.clipVertices2[gs+1],Ts=this.clipVertices2[gs+2],j=(Ss-Ot-Wt)*Dt+(Ps-qt-_t)*Ct+(Ts-Et-Jt)*jt,C>0?j>0?(gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Ts):(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Ts-Ls)*ns):j>0&&(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Ts-Ls)*ns,gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Ts),Is=Ss,Ms=Ps,Ls=Ts,C=j;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],C=(Is-Ot+Ft)*-Xt+(Ms-qt+Bt)*-Zt+(Ls-Et+Rt)*-Ut,Vs=0;Vs<As;Vs++)gs=3*Vs,Ss=this.clipVertices1[gs],Ps=this.clipVertices1[gs+1],Ts=this.clipVertices1[gs+2],j=(Ss-Ot+Ft)*-Xt+(Ps-qt+Bt)*-Zt+(Ts-Et+Rt)*-Ut,C>0?j>0?(gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Ts):(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Ts-Ls)*ns):j>0&&(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices2[gs]=Is+(Ss-Is)*ns,this.clipVertices2[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices2[gs+2]=Ls+(Ts-Ls)*ns,gs=3*ws,ws++,this.clipVertices2[gs]=Ss,this.clipVertices2[gs+1]=Ps,this.clipVertices2[gs+2]=Ts),Is=Ss,Ms=Ps,Ls=Ts,C=j;if(As=ws,0!=As){for(ws=0,gs=3*(As-1),Is=this.clipVertices2[gs],Ms=this.clipVertices2[gs+1],Ls=this.clipVertices2[gs+2],C=(Is-Ot+Wt)*-Dt+(Ms-qt+_t)*-Ct+(Ls-Et+Jt)*-jt,Vs=0;Vs<As;Vs++)gs=3*Vs,Ss=this.clipVertices2[gs],Ps=this.clipVertices2[gs+1],Ts=this.clipVertices2[gs+2],j=(Ss-Ot+Wt)*-Dt+(Ps-qt+_t)*-Ct+(Ts-Et+Jt)*-jt,C>0?j>0?(gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Ts):(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Ts-Ls)*ns):j>0&&(gs=3*ws,ws++,ns=C/(C-j),this.clipVertices1[gs]=Is+(Ss-Is)*ns,this.clipVertices1[gs+1]=Ms+(Ps-Ms)*ns,this.clipVertices1[gs+2]=Ls+(Ts-Ls)*ns,gs=3*ws,ws++,this.clipVertices1[gs]=Ss,this.clipVertices1[gs+1]=Ps,this.clipVertices1[gs+2]=Ts),Is=Ss,
Ms=Ps,Ls=Ts,C=j;if(As=ws,Ht){var Ys=h;h=e,e=Ys}if(0!=As){var Xs=h!=i;if(As>4){Is=.25*(rs+ms+us+fs),Ms=.25*(ls+ps+ys+Ns),Ls=.25*(cs+xs+ds+vs),Xt=rs-Is,Zt=ls-Ms,Ut=cs-Ls,Dt=ms-Is,Ct=ps-Ms,jt=xs-Ls;var Zs=0,Us=0,Ds=0,Cs=0,js=-this.INF;for(bs=this.INF,Vs=0;Vs<As;Vs++)this.used[Vs]=!1,gs=3*Vs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=Is*Xt+Ms*Zt+Ls*Ut,zs<bs&&(bs=zs,Zs=Vs),zs>js&&(js=zs,Ds=Vs);for(this.used[Zs]=!0,this.used[Ds]=!0,js=-this.INF,bs=this.INF,Vs=0;Vs<As;Vs++)this.used[Vs]||(gs=3*Vs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=Is*Dt+Ms*Ct+Ls*jt,zs<bs&&(bs=zs,Us=Vs),zs>js&&(js=zs,Cs=Vs));gs=3*Zs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=(Is-Ot)*Tt+(Ms-qt)*Vt+(Ls-Et)*Yt,zs<0&&s.addPoint(Is,Ms,Ls,Tt,Vt,Yt,zs,Xs),gs=3*Us,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=(Is-Ot)*Tt+(Ms-qt)*Vt+(Ls-Et)*Yt,zs<0&&s.addPoint(Is,Ms,Ls,Tt,Vt,Yt,zs,Xs),gs=3*Ds,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=(Is-Ot)*Tt+(Ms-qt)*Vt+(Ls-Et)*Yt,zs<0&&s.addPoint(Is,Ms,Ls,Tt,Vt,Yt,zs,Xs),gs=3*Cs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=(Is-Ot)*Tt+(Ms-qt)*Vt+(Ls-Et)*Yt,zs<0&&s.addPoint(Is,Ms,Ls,Tt,Vt,Yt,zs,Xs)}else for(Vs=0;Vs<As;Vs++)gs=3*Vs,Is=this.clipVertices1[gs],Ms=this.clipVertices1[gs+1],Ls=this.clipVertices1[gs+2],zs=(Is-Ot)*Tt+(Ms-qt)*Vt+(Ls-Et)*Yt,zs<0&&s.addPoint(Is,Ms,Ls,Tt,Vt,Yt,zs,Xs)}}}}}},ii.prototype=Object.create(K.prototype),ii.prototype.constructor=ii,ii.prototype.getSep=function(i,s,h,e,a){var o,n,r,l,c,m,p,x,u,y,d,f,N,v=new t,b=i.position.x,z=i.position.y,k=i.position.z,A=s.position.x,w=s.position.y,g=s.position.z,I=A-b,M=w-z,L=g-k;I*I+M*M+L*L==0&&(M=.001);var S=-I,P=-M,T=-L;this.supportPointB(i,-S,-P,-T,v);var V=v.x,Y=v.y,X=v.z;this.supportPointC(s,S,P,T,v);var Z=v.x,U=v.y,D=v.z,C=Z-V,j=U-Y,O=D-X;if(C*S+j*P+O*T<=0)return!1;if(S=j*L-O*M,P=O*I-C*L,T=C*M-j*I,S*S+P*P+T*T==0)return h.init(C-I,j-M,O-L),h.normalize(h),e.init(.5*(V+Z),.5*(Y+U),.5*(X+D)),!0;this.supportPointB(i,-S,-P,-T,v);var q=v.x,E=v.y,F=v.z;this.supportPointC(s,S,P,T,v);var B=v.x,R=v.y,W=v.z,_=B-q,J=R-E,H=W-F;if(_*S+J*P+H*T<=0)return!1;o=C-I,n=j-M,r=O-L,l=_-I,c=J-M,m=H-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l,S*I+P*M+T*L>0&&(o=C,n=j,r=O,C=_,j=J,O=H,_=o,J=n,H=r,o=V,n=Y,r=X,V=q,Y=E,X=F,q=o,E=n,F=r,o=Z,n=U,r=D,Z=B,U=R,D=W,B=o,R=n,W=r,S=-S,P=-P,T=-T);for(var Q=0;;){if(++Q>100)return!1;this.supportPointB(i,-S,-P,-T,v);var G=v.x,K=v.y,$=v.z;this.supportPointC(s,S,P,T,v);var ii=v.x,ti=v.y,si=v.z,hi=ii-G,ei=ti-K,ai=si-$;if(hi*S+ei*P+ai*T<=0)return!1;if((j*ai-O*ei)*I+(O*hi-C*ai)*M+(C*ei-j*hi)*L<0)_=hi,J=ei,H=ai,q=G,E=K,F=$,B=ii,R=ti,W=si,o=C-I,n=j-M,r=O-L,l=hi-I,c=ei-M,m=ai-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l;else if((ei*H-ai*J)*I+(ai*_-hi*H)*M+(hi*J-ei*_)*L<0)C=hi,j=ei,O=ai,V=G,Y=K,X=$,Z=ii,U=ti,D=si,o=hi-I,n=ei-M,r=ai-L,l=_-I,c=J-M,m=H-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l;else for(var oi=!1;;){if(o=_-C,n=J-j,r=H-O,l=hi-C,c=ei-j,m=ai-O,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l,p=1/Si.sqrt(S*S+P*P+T*T),S*=p,P*=p,T*=p,S*C+P*j+T*O>=0&&!oi){var ni=(j*H-O*J)*hi+(O*_-C*H)*ei+(C*J-j*_)*ai,ri=(ei*H-ai*J)*I+(ai*_-hi*H)*M+(hi*J-ei*_)*L,li=(M*O-L*j)*hi+(L*C-I*O)*ei+(I*j-M*C)*ai,ci=(J*O-H*j)*I+(H*C-_*O)*M+(_*j-J*C)*L,mi=ni+ri+li+ci;mi<=0&&(ni=0,ri=(J*ai-H*ei)*S+(H*hi-_*ai)*P+(_*ei-J*hi)*T,li=(ei*H-ai*J)*S+(ai*_-hi*H)*P+(hi*J-ei*_)*T,ci=(j*H-O*J)*S+(O*_-C*H)*P+(C*J-j*_)*T,mi=ri+li+ci);var pi=1/mi;x=(b*ni+V*ri+q*li+G*ci)*pi,u=(z*ni+Y*ri+E*li+K*ci)*pi,y=(k*ni+X*ri+F*li+$*ci)*pi,d=(A*ni+Z*ri+B*li+ii*ci)*pi,f=(w*ni+U*ri+R*li+ti*ci)*pi,N=(g*ni+D*ri+W*li+si*ci)*pi,oi=!0}this.supportPointB(i,-S,-P,-T,v);var xi=v.x,ui=v.y,yi=v.z;this.supportPointC(s,S,P,T,v);var di=v.x,fi=v.y,Ni=v.z,vi=di-xi,bi=fi-ui,zi=Ni-yi,ki=-(vi*S+bi*P+zi*T);if((vi-hi)*S+(bi-ei)*P+(zi-ai)*T<=.01||ki>=0)return!!oi&&(h.init(-S,-P,-T),e.init(.5*(x+d),.5*(u+f),.5*(y+N)),a.x=ki,!0);(bi*O-zi*j)*I+(zi*C-vi*O)*M+(vi*j-bi*C)*L<0?(bi*H-zi*J)*I+(zi*_-vi*H)*M+(vi*J-bi*_)*L<0?(C=vi,j=bi,O=zi,V=xi,Y=ui,X=yi,Z=di,U=fi,D=Ni):(hi=vi,ei=bi,ai=zi,G=xi,K=ui,$=yi,ii=di,ti=fi,si=Ni):(bi*ai-zi*ei)*I+(zi*hi-vi*ai)*M+(vi*ei-bi*hi)*L<0?(_=vi,J=bi,H=zi,q=xi,E=ui,F=yi,B=di,R=fi,W=Ni):(C=vi,j=bi,O=zi,V=xi,Y=ui,X=yi,Z=di,U=fi,D=Ni)}}},ii.prototype.supportPointB=function(i,t,s,h,e){var a,o,n,r=i.rotation.elements,l=r[0]*t+r[3]*s+r[6]*h,c=r[1]*t+r[4]*s+r[7]*h,m=r[2]*t+r[5]*s+r[8]*h,p=i.halfWidth,x=i.halfHeight,u=i.halfDepth;a=l<0?-p:p,o=c<0?-x:x,n=m<0?-u:u,l=r[0]*a+r[1]*o+r[2]*n+i.position.x,c=r[3]*a+r[4]*o+r[5]*n+i.position.y,m=r[6]*a+r[7]*o+r[8]*n+i.position.z,e.init(l,c,m)},ii.prototype.supportPointC=function(i,t,s,h,e){var a,o,n,r=i.rotation.elements,l=r[0]*t+r[3]*s+r[6]*h,c=r[1]*t+r[4]*s+r[7]*h,m=r[2]*t+r[5]*s+r[8]*h,p=l,x=m,u=p*p+x*x,y=i.radius,d=i.halfHeight;0==u?c<0?(a=y,o=-d,n=0):(a=y,o=d,n=0):(u=i.radius/Si.sqrt(u),c<0?(a=p*u,o=-d,n=x*u):(a=p*u,o=d,n=x*u)),l=r[0]*a+r[1]*o+r[2]*n+i.position.x,c=r[3]*a+r[4]*o+r[5]*n+i.position.y,m=r[6]*a+r[7]*o+r[8]*n+i.position.z,e.init(l,c,m)},ii.prototype.detectCollision=function(i,s,h){var e,a;this.flip?(e=s,a=i):(e=i,a=s);var o=new t,n=new t,r=new t;if(this.getSep(e,a,o,n,r)){var l=e.position.x,c=e.position.y,m=e.position.z,p=a.position.x,x=a.position.y,u=a.position.z,y=e.halfWidth,d=e.halfHeight,f=e.halfDepth,N=a.halfHeight,v=a.radius,b=e.dimentions,z=b[0],k=b[1],A=b[2],w=b[3],g=b[4],I=b[5],M=b[6],L=b[7],S=b[8],P=b[9],T=b[10],V=b[11],Y=b[12],X=b[13],Z=b[14],U=b[15],D=b[16],C=b[17],j=a.normalDirection.x,O=a.normalDirection.y,q=a.normalDirection.z,E=a.halfDirection.x,F=a.halfDirection.y,B=a.halfDirection.z,R=o.x,W=o.y,_=o.z,J=R*z+W*k+_*A,H=R*w+W*g+_*I,Q=R*M+W*L+_*S,G=R*j+W*O+_*q,K=J>0,$=H>0,ii=Q>0,ti=G>0;K||(J=-J),$||(H=-H),ii||(Q=-Q),ti||(G=-G);var si=0;G>.999?si=J>.999?J>G?1:4:H>.999?H>G?2:4:Q>.999&&Q>G?3:4:J>.999?si=1:H>.999?si=2:Q>.999&&(si=3);var hi,ei,ai,oi,ni,ri,li,ci,mi,pi,xi,ui,yi,di,fi,Ni,vi,bi,zi,ki,Ai,wi,gi,Ii,Mi,Li,Pi,Ti,Vi,Yi,Xi,Zi,Ui,Di,Ci,ji,Oi,qi,Ei,Fi,Bi,Ri,Wi,_i,Ji,Hi,Qi,Gi,Ki,$i,it,tt,st;if(0==si)h.addPoint(n.x,n.y,n.z,R,W,_,r.x,this.flip);else if(4==si){ti?(oi=p-E,ni=x-F,ri=u-B,R=-j,W=-O,_=-q):(oi=p+E,ni=x+F,ri=u+B,R=j,W=O,_=q);var ht,et,at,ot,nt,rt,lt,ct,mt,pt,xt,ut;ki=1,si=0,Wi=z*R+k*W+A*_,Wi<ki&&(ki=Wi,si=0),-Wi<ki&&(ki=-Wi,si=1),Wi=w*R+g*W+I*_,Wi<ki&&(ki=Wi,si=2),-Wi<ki&&(ki=-Wi,si=3),Wi=M*R+L*W+S*_,Wi<ki&&(ki=Wi,si=4),-Wi<ki&&(ki=-Wi,si=5);var yt=e.elements;switch(si){case 0:ht=yt[0],et=yt[1],at=yt[2],ot=yt[6],nt=yt[7],rt=yt[8],lt=yt[9],ct=yt[10],mt=yt[11],pt=yt[3],xt=yt[4],ut=yt[5];break;case 1:ht=yt[15],et=yt[16],at=yt[17],ot=yt[21],nt=yt[22],rt=yt[23],lt=yt[18],ct=yt[19],mt=yt[20],pt=yt[12],xt=yt[13],ut=yt[14];break;case 2:ht=yt[12],et=yt[13],at=yt[14],ot=yt[0],nt=yt[1],rt=yt[2],lt=yt[3],ct=yt[4],mt=yt[5],pt=yt[15],xt=yt[16],ut=yt[17];break;case 3:ht=yt[21],et=yt[22],at=yt[23],ot=yt[9],nt=yt[10],rt=yt[11],lt=yt[6],ct=yt[7],mt=yt[8],pt=yt[18],xt=yt[19],ut=yt[20];break;case 4:ht=yt[12],et=yt[13],at=yt[14],ot=yt[18],nt=yt[19],rt=yt[20],lt=yt[6],ct=yt[7],mt=yt[8],pt=yt[0],xt=yt[1],ut=yt[2];break;case 5:ht=yt[3],et=yt[4],at=yt[5],ot=yt[9],nt=yt[10],rt=yt[11],lt=yt[21],ct=yt[22],mt=yt[23],pt=yt[15],xt=yt[16],ut=yt[17]}zi=R*(ht-oi)+W*(et-ni)+_*(at-ri),zi<=0&&h.addPoint(ht,et,at,-R,-W,-_,zi,this.flip),zi=R*(ot-oi)+W*(nt-ni)+_*(rt-ri),zi<=0&&h.addPoint(ot,nt,rt,-R,-W,-_,zi,this.flip),zi=R*(lt-oi)+W*(ct-ni)+_*(mt-ri),zi<=0&&h.addPoint(lt,ct,mt,-R,-W,-_,zi,this.flip),zi=R*(pt-oi)+W*(xt-ni)+_*(ut-ri),zi<=0&&h.addPoint(pt,xt,ut,-R,-W,-_,zi,this.flip)}else{switch(si){case 1:K?(hi=l+P,ei=c+T,ai=m+V,R=z,W=k,_=A):(hi=l-P,ei=c-T,ai=m-V,R=-z,W=-k,_=-A),Hi=w,Qi=g,Gi=I,tt=d,Ki=M,$i=L,it=S,st=f;break;case 2:$?(hi=l+Y,ei=c+X,ai=m+Z,R=w,W=g,_=I):(hi=l-Y,ei=c-X,ai=m-Z,R=-w,W=-g,_=-I),Hi=z,Qi=k,Gi=A,tt=y,Ki=M,$i=L,it=S,st=f;break;case 3:ii?(hi=l+U,ei=c+D,ai=m+C,R=M,W=L,_=S):(hi=l-U,ei=c-D,ai=m-C,R=-M,W=-L,_=-S),Hi=z,Qi=k,Gi=A,tt=y,Ki=w,$i=g,it=I,st=d}if(ki=R*j+W*O+_*q,Ai=ki<0?N:-N,oi=p+Ai*j,ni=x+Ai*O,ri=u+Ai*q,G>=.999999?(wi=-W,gi=_,Ii=R):(wi=R,gi=W,Ii=_),Ai=wi*j+gi*O+Ii*q,Li=Ai*j-wi,Pi=Ai*O-gi,Ti=Ai*q-Ii,Ai=Si.sqrt(Li*Li+Pi*Pi+Ti*Ti),0==Ai)return;if(Ai=v/Ai,Li*=Ai,Pi*=Ai,Ti*=Ai,wi=oi+Li,gi=ni+Pi,Ii=ri+Ti,ki<-.96||ki>.96)li=j*j*1.5-.5,ci=j*O*1.5-.866025403*q,mi=j*q*1.5+.866025403*O,pi=O*j*1.5+.866025403*q,xi=O*O*1.5-.5,ui=O*q*1.5-.866025403*j,yi=q*j*1.5-.866025403*O,di=q*O*1.5+.866025403*j,fi=q*q*1.5-.5,Ni=wi,vi=gi,bi=Ii,zi=R*(Ni-hi)+W*(vi-ei)+_*(bi-ai),wi=Ni-zi*R-hi,gi=vi-zi*W-ei,Ii=bi-zi*_-ai,qi=Hi*wi+Qi*gi+Gi*Ii,Ri=Ki*wi+$i*gi+it*Ii,qi<-tt?qi=-tt:qi>tt&&(qi=tt),Ri<-st?Ri=-st:Ri>st&&(Ri=st),wi=qi*Hi+Ri*Ki,gi=qi*Qi+Ri*$i,Ii=qi*Gi+Ri*it,Ni=hi+wi,vi=ei+gi,bi=ai+Ii,h.addPoint(Ni,vi,bi,R,W,_,zi,this.flip),Ni=Li*li+Pi*ci+Ti*mi,vi=Li*pi+Pi*xi+Ti*ui,bi=Li*yi+Pi*di+Ti*fi,Ni=(Li=Ni)+oi,vi=(Pi=vi)+ni,bi=(Ti=bi)+ri,zi=R*(Ni-hi)+W*(vi-ei)+_*(bi-ai),zi<=0&&(wi=Ni-zi*R-hi,gi=vi-zi*W-ei,Ii=bi-zi*_-ai,qi=Hi*wi+Qi*gi+Gi*Ii,Ri=Ki*wi+$i*gi+it*Ii,qi<-tt?qi=-tt:qi>tt&&(qi=tt),Ri<-st?Ri=-st:Ri>st&&(Ri=st),wi=qi*Hi+Ri*Ki,gi=qi*Qi+Ri*$i,Ii=qi*Gi+Ri*it,Ni=hi+wi,vi=ei+gi,bi=ai+Ii,h.addPoint(Ni,vi,bi,R,W,_,zi,this.flip)),Ni=Li*li+Pi*ci+Ti*mi,vi=Li*pi+Pi*xi+Ti*ui,bi=Li*yi+Pi*di+Ti*fi,Ni=(Li=Ni)+oi,vi=(Pi=vi)+ni,bi=(Ti=bi)+ri,zi=R*(Ni-hi)+W*(vi-ei)+_*(bi-ai),zi<=0&&(wi=Ni-zi*R-hi,gi=vi-zi*W-ei,Ii=bi-zi*_-ai,qi=Hi*wi+Qi*gi+Gi*Ii,Ri=Ki*wi+$i*gi+it*Ii,qi<-tt?qi=-tt:qi>tt&&(qi=tt),Ri<-st?Ri=-st:Ri>st&&(Ri=st),wi=qi*Hi+Ri*Ki,gi=qi*Qi+Ri*$i,Ii=qi*Gi+Ri*it,Ni=hi+wi,vi=ei+gi,bi=ai+Ii,h.addPoint(Ni,vi,bi,R,W,_,zi,this.flip));else{if(Ci=wi,ji=gi,Oi=Ii,qi=R*(Ci-hi)+W*(ji-ei)+_*(Oi-ai),Ci-=qi*R,ji-=qi*W,Oi-=qi*_,ki>0?(Ei=wi+2*E,Fi=gi+2*F,Bi=Ii+2*B):(Ei=wi-2*E,Fi=gi-2*F,Bi=Ii-2*B),Ri=R*(Ei-hi)+W*(Fi-ei)+_*(Bi-ai),Ei-=Ri*R,Fi-=Ri*W,Bi-=Ri*_,Vi=Ci-hi,Yi=ji-ei,Xi=Oi-ai,Zi=Ei-hi,Ui=Fi-ei,Di=Bi-ai,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi,J=Vi*Hi+Yi*Qi+Xi*Gi,H=Zi*Hi+Ui*Qi+Di*Gi,Wi=J-tt,_i=H-tt,Wi>0){if(_i>0)return;Ji=Wi/(Wi-_i),Ci+=wi*Ji,ji+=gi*Ji,Oi+=Ii*Ji,qi+=Mi*Ji,Vi=Ci-hi,Yi=ji-ei,Xi=Oi-ai,J=Vi*Hi+Yi*Qi+Xi*Gi,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi}else _i>0&&(Ji=Wi/(Wi-_i),Ei=Ci+wi*Ji,Fi=ji+gi*Ji,Bi=Oi+Ii*Ji,Ri=qi+Mi*Ji,Zi=Ei-hi,Ui=Fi-ei,Di=Bi-ai,H=Zi*Hi+Ui*Qi+Di*Gi,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi);if(Wi=J+tt,_i=H+tt,Wi<0){if(_i<0)return;Ji=Wi/(Wi-_i),Ci+=wi*Ji,ji+=gi*Ji,Oi+=Ii*Ji,qi+=Mi*Ji,Vi=Ci-hi,Yi=ji-ei,Xi=Oi-ai,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi}else _i<0&&(Ji=Wi/(Wi-_i),Ei=Ci+wi*Ji,Fi=ji+gi*Ji,Bi=Oi+Ii*Ji,Ri=qi+Mi*Ji,Zi=Ei-hi,Ui=Fi-ei,Di=Bi-ai,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi);if(J=Vi*Ki+Yi*$i+Xi*it,H=Zi*Ki+Ui*$i+Di*it,Wi=J-st,_i=H-st,Wi>0){if(_i>0)return;Ji=Wi/(Wi-_i),Ci+=wi*Ji,ji+=gi*Ji,Oi+=Ii*Ji,qi+=Mi*Ji,Vi=Ci-hi,Yi=ji-ei,Xi=Oi-ai,J=Vi*Ki+Yi*$i+Xi*it,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi}else _i>0&&(Ji=Wi/(Wi-_i),Ei=Ci+wi*Ji,Fi=ji+gi*Ji,Bi=Oi+Ii*Ji,Ri=qi+Mi*Ji,Zi=Ei-hi,Ui=Fi-ei,Di=Bi-ai,H=Zi*Ki+Ui*$i+Di*it,wi=Ei-Ci,gi=Fi-ji,Ii=Bi-Oi,Mi=Ri-qi);if(Wi=J+st,_i=H+st,Wi<0){if(_i<0)return;Ji=Wi/(Wi-_i),Ci+=wi*Ji,ji+=gi*Ji,Oi+=Ii*Ji,qi+=Mi*Ji}else _i<0&&(Ji=Wi/(Wi-_i),Ei=Ci+wi*Ji,Fi=ji+gi*Ji,Bi=Oi+Ii*Ji,Ri=qi+Mi*Ji);qi<0&&h.addPoint(Ci,ji,Oi,R,W,_,qi,this.flip),Ri<0&&h.addPoint(Ei,Fi,Bi,R,W,_,Ri,this.flip)}}}},ti.prototype=Object.create(K.prototype),ti.prototype.constructor=ti,ti.prototype.getSep=function(i,s,h,e,a){var o,n,r,l,c,m,p,x,u,y,d,f,N,v=new t,b=i.position.x,z=i.position.y,k=i.position.z,A=s.position.x,w=s.position.y,g=s.position.z,I=A-b,M=w-z,L=g-k;I*I+M*M+L*L==0&&(M=.001);var S=-I,P=-M,T=-L;this.supportPoint(i,-S,-P,-T,v);var V=v.x,Y=v.y,X=v.z;this.supportPoint(s,S,P,T,v);var Z=v.x,U=v.y,D=v.z,C=Z-V,j=U-Y,O=D-X;if(C*S+j*P+O*T<=0)return!1;if(S=j*L-O*M,P=O*I-C*L,T=C*M-j*I,S*S+P*P+T*T==0)return h.init(C-I,j-M,O-L),h.normalize(h),e.init(.5*(V+Z),.5*(Y+U),.5*(X+D)),!0;this.supportPoint(i,-S,-P,-T,v);var q=v.x,E=v.y,F=v.z;this.supportPoint(s,S,P,T,v);var B=v.x,R=v.y,W=v.z,_=B-q,J=R-E,H=W-F;if(_*S+J*P+H*T<=0)return!1;o=C-I,n=j-M,r=O-L,l=_-I,c=J-M,m=H-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l,S*I+P*M+T*L>0&&(o=C,n=j,r=O,C=_,j=J,O=H,_=o,J=n,H=r,o=V,n=Y,r=X,V=q,Y=E,X=F,q=o,E=n,F=r,o=Z,n=U,r=D,Z=B,U=R,D=W,B=o,R=n,W=r,S=-S,P=-P,T=-T);for(var Q=0;;){if(++Q>100)return!1;this.supportPoint(i,-S,-P,-T,v);var G=v.x,K=v.y,$=v.z;this.supportPoint(s,S,P,T,v);var ii=v.x,ti=v.y,si=v.z,hi=ii-G,ei=ti-K,ai=si-$;if(hi*S+ei*P+ai*T<=0)return!1;if((j*ai-O*ei)*I+(O*hi-C*ai)*M+(C*ei-j*hi)*L<0)_=hi,J=ei,H=ai,q=G,E=K,F=$,B=ii,R=ti,W=si,o=C-I,n=j-M,r=O-L,l=hi-I,c=ei-M,m=ai-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l;else if((ei*H-ai*J)*I+(ai*_-hi*H)*M+(hi*J-ei*_)*L<0)C=hi,j=ei,O=ai,V=G,Y=K,X=$,Z=ii,U=ti,D=si,o=hi-I,n=ei-M,r=ai-L,l=_-I,c=J-M,m=H-L,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l;else for(var oi=!1;;){if(o=_-C,n=J-j,r=H-O,l=hi-C,c=ei-j,m=ai-O,S=n*m-r*c,P=r*l-o*m,T=o*c-n*l,p=1/Si.sqrt(S*S+P*P+T*T),S*=p,P*=p,T*=p,S*C+P*j+T*O>=0&&!oi){var ni=(j*H-O*J)*hi+(O*_-C*H)*ei+(C*J-j*_)*ai,ri=(ei*H-ai*J)*I+(ai*_-hi*H)*M+(hi*J-ei*_)*L,li=(M*O-L*j)*hi+(L*C-I*O)*ei+(I*j-M*C)*ai,ci=(J*O-H*j)*I+(H*C-_*O)*M+(_*j-J*C)*L,mi=ni+ri+li+ci;mi<=0&&(ni=0,ri=(J*ai-H*ei)*S+(H*hi-_*ai)*P+(_*ei-J*hi)*T,li=(ei*H-ai*J)*S+(ai*_-hi*H)*P+(hi*J-ei*_)*T,ci=(j*H-O*J)*S+(O*_-C*H)*P+(C*J-j*_)*T,mi=ri+li+ci);var pi=1/mi;x=(b*ni+V*ri+q*li+G*ci)*pi,u=(z*ni+Y*ri+E*li+K*ci)*pi,y=(k*ni+X*ri+F*li+$*ci)*pi,d=(A*ni+Z*ri+B*li+ii*ci)*pi,f=(w*ni+U*ri+R*li+ti*ci)*pi,N=(g*ni+D*ri+W*li+si*ci)*pi,oi=!0}this.supportPoint(i,-S,-P,-T,v);var xi=v.x,ui=v.y,yi=v.z;this.supportPoint(s,S,P,T,v);var di=v.x,fi=v.y,Ni=v.z,vi=di-xi,bi=fi-ui,zi=Ni-yi,ki=-(vi*S+bi*P+zi*T);if((vi-hi)*S+(bi-ei)*P+(zi-ai)*T<=.01||ki>=0)return!!oi&&(h.init(-S,-P,-T),e.init(.5*(x+d),.5*(u+f),.5*(y+N)),a.x=ki,!0);(bi*O-zi*j)*I+(zi*C-vi*O)*M+(vi*j-bi*C)*L<0?(bi*H-zi*J)*I+(zi*_-vi*H)*M+(vi*J-bi*_)*L<0?(C=vi,j=bi,O=zi,V=xi,Y=ui,X=yi,Z=di,U=fi,D=Ni):(hi=vi,ei=bi,ai=zi,G=xi,K=ui,$=yi,ii=di,ti=fi,si=Ni):(bi*ai-zi*ei)*I+(zi*hi-vi*ai)*M+(vi*ei-bi*hi)*L<0?(_=vi,J=bi,H=zi,q=xi,E=ui,F=yi,B=di,R=fi,W=Ni):(C=vi,j=bi,O=zi,V=xi,Y=ui,X=yi,Z=di,U=fi,D=Ni)}}},ti.prototype.supportPoint=function(i,t,s,h,e){var a,o,n,r=i.rotation.elements,l=r[0]*t+r[3]*s+r[6]*h,c=r[1]*t+r[4]*s+r[7]*h,m=r[2]*t+r[5]*s+r[8]*h,p=l,x=m,u=p*p+x*x,y=i.radius,d=i.halfHeight;0==u?c<0?(a=y,o=-d,n=0):(a=y,o=d,n=0):(u=i.radius/Si.sqrt(u),c<0?(a=p*u,o=-d,n=x*u):(a=p*u,o=d,n=x*u)),l=r[0]*a+r[1]*o+r[2]*n+i.position.x,c=r[3]*a+r[4]*o+r[5]*n+i.position.y,m=r[6]*a+r[7]*o+r[8]*n+i.position.z,e.init(l,c,m)},ti.prototype.detectCollision=function(i,s,h){var e,a;i.id<s.id?(e=i,a=s):(e=s,a=i);var o,n,r,l,c,m,p,x,u,y,d,f,N,v,b,z,k,A,w,g,I,M=e.position,L=a.position,S=M.x,P=M.y,T=M.z,V=L.x,Y=L.y,X=L.z,Z=e.halfHeight,U=a.halfHeight,D=e.normalDirection,C=a.normalDirection,j=e.halfDirection,O=a.halfDirection,q=e.radius,E=a.radius,F=D.x,B=D.y,R=D.z,W=C.x,_=C.y,J=C.z,H=j.x,Q=j.y,G=j.z,K=O.x,$=O.y,ii=O.z,ti=S-V,si=P-Y,hi=T-X,ei=new t,ai=new t,oi=new t;if(this.getSep(e,a,ei,ai,oi)){var ni=ei.x*F+ei.y*B+ei.z*R,ri=ei.x*W+ei.y*_+ei.z*J,li=ni>0,ci=ri>0;li||(ni=-ni),ci||(ri=-ri);var mi=0;(ni>.999||ri>.999)&&(mi=ni>ri?1:2);var pi,xi,ui,yi,di,fi,Ni,vi,bi,zi,ki,Ai,wi,gi,Ii,Mi,Li,Pi,Ti,Vi,Yi=oi.x;switch(pi=ei.x,xi=ei.y,ui=ei.z,mi){case 0:h.addPoint(ai.x,ai.y,ai.z,pi,xi,ui,Yi,!1);break;case 1:if(li?(n=S+H,r=P+Q,l=T+G,pi=F,xi=B,ui=R):(n=S-H,r=P-Q,l=T-G,pi=-F,xi=-B,ui=-R),w=pi*W+xi*_+ui*J,o=w<0?U:-U,c=V+o*W,m=Y+o*_,p=X+o*J,ri>=.999999?(x=-xi,u=ui,y=pi):(x=pi,u=xi,y=ui),o=x*W+u*_+y*J,ti=o*W-x,si=o*_-u,hi=o*J-y,o=Si.sqrt(ti*ti+si*si+hi*hi),0==o)break;if(o=E/o,ti*=o,si*=o,hi*=o,x=c+ti,u=m+si,y=p+hi,w<-.96||w>.96)yi=W*W*1.5-.5,di=W*_*1.5-.866025403*J,fi=W*J*1.5+.866025403*_,Ni=_*W*1.5+.866025403*J,vi=_*_*1.5-.5,bi=_*J*1.5-.866025403*W,zi=J*W*1.5-.866025403*_,ki=J*_*1.5+.866025403*W,Ai=J*J*1.5-.5,wi=x,gi=u,Ii=y,Mi=pi*(wi-n)+xi*(gi-r)+ui*(Ii-l),x=wi-Mi*pi-n,u=gi-Mi*xi-r,y=Ii-Mi*ui-l,o=x*x+u*u+y*y,o>q*q&&(o=q/Si.sqrt(o),x*=o,u*=o,y*=o),wi=n+x,gi=r+u,Ii=l+y,h.addPoint(wi,gi,Ii,pi,xi,ui,Mi,!1),wi=ti*yi+si*di+hi*fi,gi=ti*Ni+si*vi+hi*bi,Ii=ti*zi+si*ki+hi*Ai,wi=(ti=wi)+c,gi=(si=gi)+m,Ii=(hi=Ii)+p,Mi=pi*(wi-n)+xi*(gi-r)+ui*(Ii-l),Mi<=0&&(x=wi-Mi*pi-n,u=gi-Mi*xi-r,y=Ii-Mi*ui-l,o=x*x+u*u+y*y,o>q*q&&(o=q/Si.sqrt(o),x*=o,u*=o,y*=o),wi=n+x,gi=r+u,Ii=l+y,h.addPoint(wi,gi,Ii,pi,xi,ui,Mi,!1)),wi=ti*yi+si*di+hi*fi,gi=ti*Ni+si*vi+hi*bi,Ii=ti*zi+si*ki+hi*Ai,wi=(ti=wi)+c,gi=(si=gi)+m,Ii=(hi=Ii)+p,Mi=pi*(wi-n)+xi*(gi-r)+ui*(Ii-l),Mi<=0&&(x=wi-Mi*pi-n,u=gi-Mi*xi-r,y=Ii-Mi*ui-l,o=x*x+u*u+y*y,o>q*q&&(o=q/Si.sqrt(o),x*=o,u*=o,y*=o),wi=n+x,gi=r+u,Ii=l+y,h.addPoint(wi,gi,Ii,pi,xi,ui,Mi,!1));else{if(d=x,f=u,N=y,k=pi*(d-n)+xi*(f-r)+ui*(N-l),d-=k*pi,f-=k*xi,N-=k*ui,w>0?(v=x+W*U*2,b=u+_*U*2,z=y+J*U*2):(v=x-W*U*2,b=u-_*U*2,z=y-J*U*2),A=pi*(v-n)+xi*(b-r)+ui*(z-l),v-=A*pi,b-=A*xi,z-=A*ui,ti=n-d,si=r-f,hi=l-N,x=v-d,u=b-f,y=z-N,Li=ti*ti+si*si+hi*hi,Pi=ti*x+si*u+hi*y,Ti=x*x+u*u+y*y,Vi=Pi*Pi-Ti*(Li-q*q),Vi<0)break;Vi=Si.sqrt(Vi),g=(Pi+Vi)/Ti,I=(Pi-Vi)/Ti,I<g&&(o=g,g=I,I=o),I>1&&(I=1),g<0&&(g=0),x=d+(v-d)*g,u=f+(b-f)*g,y=N+(z-N)*g,v=d+(v-d)*I,b=f+(b-f)*I,z=N+(z-N)*I,d=x,f=u,N=y,o=k+(A-k)*g,A=k+(A-k)*I,k=o,k<0&&h.addPoint(d,f,N,pi,xi,ui,Mi,!1),A<0&&h.addPoint(v,b,z,pi,xi,ui,Mi,!1)}break;case 2:if(ci?(c=V-K,m=Y-$,p=X-ii,pi=-W,xi=-_,ui=-J):(c=V+K,m=Y+$,p=X+ii,pi=W,xi=_,ui=J),w=pi*F+xi*B+ui*R,o=w<0?Z:-Z,n=S+o*F,r=P+o*B,l=T+o*R,ni>=.999999?(x=-xi,u=ui,y=pi):(x=pi,u=xi,y=ui),o=x*F+u*B+y*R,ti=o*F-x,si=o*B-u,hi=o*R-y,o=Si.sqrt(ti*ti+si*si+hi*hi),0==o)break;if(o=q/o,ti*=o,si*=o,hi*=o,x=n+ti,u=r+si,y=l+hi,w<-.96||w>.96)yi=F*F*1.5-.5,di=F*B*1.5-.866025403*R,fi=F*R*1.5+.866025403*B,Ni=B*F*1.5+.866025403*R,vi=B*B*1.5-.5,bi=B*R*1.5-.866025403*F,zi=R*F*1.5-.866025403*B,ki=R*B*1.5+.866025403*F,Ai=R*R*1.5-.5,wi=x,gi=u,Ii=y,Mi=pi*(wi-c)+xi*(gi-m)+ui*(Ii-p),x=wi-Mi*pi-c,u=gi-Mi*xi-m,y=Ii-Mi*ui-p,o=x*x+u*u+y*y,o>E*E&&(o=E/Si.sqrt(o),x*=o,u*=o,y*=o),wi=c+x,gi=m+u,Ii=p+y,h.addPoint(wi,gi,Ii,-pi,-xi,-ui,Mi,!1),wi=ti*yi+si*di+hi*fi,gi=ti*Ni+si*vi+hi*bi,Ii=ti*zi+si*ki+hi*Ai,wi=(ti=wi)+n,gi=(si=gi)+r,Ii=(hi=Ii)+l,Mi=pi*(wi-c)+xi*(gi-m)+ui*(Ii-p),Mi<=0&&(x=wi-Mi*pi-c,u=gi-Mi*xi-m,y=Ii-Mi*ui-p,o=x*x+u*u+y*y,o>E*E&&(o=E/Si.sqrt(o),x*=o,u*=o,y*=o),wi=c+x,gi=m+u,Ii=p+y,h.addPoint(wi,gi,Ii,-pi,-xi,-ui,Mi,!1)),wi=ti*yi+si*di+hi*fi,gi=ti*Ni+si*vi+hi*bi,Ii=ti*zi+si*ki+hi*Ai,wi=(ti=wi)+n,gi=(si=gi)+r,Ii=(hi=Ii)+l,Mi=pi*(wi-c)+xi*(gi-m)+ui*(Ii-p),Mi<=0&&(x=wi-Mi*pi-c,u=gi-Mi*xi-m,y=Ii-Mi*ui-p,o=x*x+u*u+y*y,o>E*E&&(o=E/Si.sqrt(o),x*=o,u*=o,y*=o),wi=c+x,gi=m+u,Ii=p+y,h.addPoint(wi,gi,Ii,-pi,-xi,-ui,Mi,!1));else{if(d=x,f=u,N=y,k=pi*(d-c)+xi*(f-m)+ui*(N-p),d-=k*pi,f-=k*xi,N-=k*ui,w>0?(v=x+F*Z*2,b=u+B*Z*2,z=y+R*Z*2):(v=x-F*Z*2,b=u-B*Z*2,z=y-R*Z*2),A=pi*(v-c)+xi*(b-m)+ui*(z-p),v-=A*pi,b-=A*xi,z-=A*ui,ti=c-d,si=m-f,hi=p-N,x=v-d,u=b-f,y=z-N,Li=ti*ti+si*si+hi*hi,Pi=ti*x+si*u+hi*y,Ti=x*x+u*u+y*y,Vi=Pi*Pi-Ti*(Li-E*E),Vi<0)break;Vi=Si.sqrt(Vi),g=(Pi+Vi)/Ti,I=(Pi-Vi)/Ti,I<g&&(o=g,g=I,I=o),I>1&&(I=1),g<0&&(g=0),x=d+(v-d)*g,u=f+(b-f)*g,y=N+(z-N)*g,v=d+(v-d)*I,b=f+(b-f)*I,z=N+(z-N)*I,d=x,f=u,N=y,o=k+(A-k)*g,A=k+(A-k)*I,k=o,k<0&&h.addPoint(d,f,N,-pi,-xi,-ui,k,!1),A<0&&h.addPoint(v,b,z,-pi,-xi,-ui,A,!1)}}}},si.prototype=Object.create(K.prototype),si.prototype.constructor=si,si.prototype.detectCollision=function(i,t,s){var h,e;this.flip?(h=t,e=i):(h=i,e=t);var a,o,n,r,l,c=e.dimentions,m=h.position,p=m.x,x=m.y,u=m.z,y=e.position,d=y.x,f=y.y,N=y.z,v=h.radius,b=e.halfWidth,z=e.halfHeight,k=e.halfDepth,A=p-d,w=x-f,g=u-N,I=c[0]*A+c[1]*w+c[2]*g,M=c[3]*A+c[4]*w+c[5]*g,L=c[6]*A+c[7]*w+c[8]*g,S=0;I>b?I=b:I<-b?I=-b:S=1,M>z?M=z:M<-z?M=-z:S|=2,L>k?L=k:L<-k?L=-k:S|=4,7==S?(A=I<0?b+I:b-I,w=M<0?z+M:z-M,g=L<0?k+L:k-L,A<w?A<g?(r=A-b,I<0?(I=-b,A=c[0],w=c[1],g=c[2]):(I=b,A=-c[0],w=-c[1],g=-c[2])):(r=g-k,L<0?(L=-k,A=c[6],w=c[7],g=c[8]):(L=k,A=-c[6],w=-c[7],g=-c[8])):w<g?(r=w-z,M<0?(M=-z,A=c[3],w=c[4],g=c[5]):(M=z,A=-c[3],w=-c[4],g=-c[5])):(r=g-k,L<0?(L=-k,A=c[6],w=c[7],g=c[8]):(L=k,A=-c[6],w=-c[7],g=-c[8])),a=d+I*c[0]+M*c[3]+L*c[6],o=f+I*c[1]+M*c[4]+L*c[7],n=N+I*c[2]+M*c[5]+L*c[8],s.addPoint(p+v*A,x+v*w,u+v*g,A,w,g,r-v,this.flip)):(a=d+I*c[0]+M*c[3]+L*c[6],o=f+I*c[1]+M*c[4]+L*c[7],n=N+I*c[2]+M*c[5]+L*c[8],A=a-m.x,w=o-m.y,g=n-m.z,r=A*A+w*w+g*g,r>0&&r<v*v&&(r=Si.sqrt(r),l=1/r,A*=l,w*=l,g*=l,s.addPoint(p+v*A,x+v*w,u+v*g,A,w,g,r-v,this.flip)))},hi.prototype=Object.create(K.prototype),hi.prototype.constructor=hi,hi.prototype.detectCollision=function(i,t,s){var h,e;this.flip?(h=t,e=i):(h=i,e=t);var a=h.position,o=a.x,n=a.y,r=a.z,l=e.position,c=l.x,m=l.y,p=l.z,x=e.normalDirection.x,u=e.normalDirection.y,y=e.normalDirection.z,d=h.radius,f=e.radius,N=d+f,v=e.halfHeight,b=o-c,z=n-m,k=r-p,A=b*x+z*u+k*y;if(!(A<-v-d||A>v+d)){var w=c+A*x,g=m+A*u,I=p+A*y,M=o-w,L=n-g,S=r-I,P=M*M+L*L+S*S;if(!(P>N*N)){P>f*f&&(P=f/Si.sqrt(P),M*=P,L*=P,S*=P),A<-v?A=-v:A>v&&(A=v),w=c+A*x+M,g=m+A*u+L,I=p+A*y+S,b=w-o,z=g-n,k=I-r,P=b*b+z*z+k*k;var T;P>0&&P<d*d&&(P=Si.sqrt(P),T=1/P,b*=T,z*=T,k*=T,s.addPoint(o+b*d,n+z*d,r+k*d,b,z,k,P-d,this.flip))}}},ei.prototype=Object.create(K.prototype),ei.prototype.constructor=ei,ei.prototype.detectCollision=function(i,t,s){var h=i,e=t,a=h.position,o=e.position,n=o.x-a.x,r=o.y-a.y,l=o.z-a.z,c=n*n+r*r+l*l,m=h.radius,p=e.radius,x=m+p;if(c>0&&c<x*x){c=Si.sqrt(c);var u=1/c;n*=u,r*=u,l*=u,s.addPoint(a.x+n*m,a.y+r*m,a.z+l*m,n,r,l,c-x,!1)}},Object.assign(ai.prototype,{World:!0,getInfo:function(){return this.isStat?this.performance.show():""},clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies)},addRigidBody:function(i){i.parent&&e("World","It is not possible to be added to more than one world one of the rigid body"),i.parent=this,i.awake();for(var t=i.shapes;null!==t;t=t.next)this.addShape(t);null!==this.rigidBodies&&((this.rigidBodies.prev=i).next=this.rigidBodies),this.rigidBodies=i,this.numRigidBodies++},removeRigidBody:function(i){var t=i;if(t.parent===this){t.awake();for(var s=t.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=i.shapes;null!==e;e=e.next)this.removeShape(e);var a=t.prev,o=t.next;null!==a&&(a.next=o),null!==o&&(o.prev=a),this.rigidBodies==t&&(this.rigidBodies=o),t.prev=null,t.next=null,t.parent=null,this.numRigidBodies--}},getByName:function(i){for(var t=this.rigidBodies;null!==t;){if(t.name===i)return t;t=t.next}for(var s=this.joints;null!==s;){if(s.name===i)return s;s=s.next}return null},addShape:function(i){i.parent&&i.parent.parent||e("World","It is not possible to be added alone to shape world"),i.proxy=this.broadPhase.createProxy(i),i.updateProxy(),this.broadPhase.addProxy(i.proxy)},removeShape:function(i){this.broadPhase.removeProxy(i.proxy),i.proxy=null},addJoint:function(i){i.parent&&e("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=i).next=this.joints),this.joints=i,i.parent=this,this.numJoints++,i.awake(),i.attach()},removeJoint:function(i){var t=i,s=t.prev,h=t.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==t&&(this.joints=h),t.prev=null,t.next=null,this.numJoints--,t.awake(),t.detach(),t.parent=null},addContact:function(i,t){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new U,s.attach(i,t),s.detector=this.detectors[i.type][t.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(i){var t=i.prev,s=i.next;s&&(s.prev=t),t&&(t.next=s),this.contacts==i&&(this.contacts=s),i.prev=null,i.next=null,i.detach(),i.next=this.unusedContacts,this.unusedContacts=i,this.numContacts--},checkContact:function(i,t){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==i&&h==t||h==i&&s==t)return!!e.touching;e=e.next}return!1},callSleep:function(i){return!!i.allowSleep&&(!(i.linearVelocity.lengthSq()>.04)&&!(i.angularVelocity.lengthSq()>.25))},step:function(){var i=this.isStat;i&&this.performance.setTime(0);for(var s=this.rigidBodies;null!==s;)s.addedToIsland=!1,s.sleeping&&s.testWakeUp(),s=s.next;i&&this.performance.setTime(1),this.broadPhase.detectPairs();for(var h=this.broadPhase.pairs,e=this.broadPhase.numPairs;e--;){var a,o,n=h[e];n.shape1.id<n.shape2.id?(a=n.shape1,o=n.shape2):(a=n.shape2,o=n.shape1);var r;r=a.numContacts<o.numContacts?a.contactLink:o.contactLink;for(var l=!1;r;){var c=r.contact;if(c.shape1==a&&c.shape2==o){c.persisting=!0,l=!0;break}r=r.next}l||this.addContact(a,o)}for(i&&this.performance.calcBroadPhase(),this.numContactPoints=0,c=this.contacts;null!==c;)if(c.persisting||!c.shape1.aabb.intersectTest(c.shape2.aabb)){var m=c.body1,p=c.body2;(m.isDynamic&&!m.sleeping||p.isDynamic&&!p.sleeping)&&c.updateManifold(),this.numContactPoints+=c.manifold.numPoints,c.persisting=!1,c.constraint.addedToIsland=!1,c=c.next}else{var x=c.next;this.removeContact(c),c=x}i&&this.performance.calcNarrowPhase();var u,y,d=1/this.timeStep;for(u=this.joints;null!==u;u=u.next)u.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],i&&this.performance.setTime(1),this.numIslands=0;for(var f=this.rigidBodies;null!==f;f=f.next)if(!(f.addedToIsland||f.isStatic||f.sleeping))if(f.isLonely())f.isDynamic&&f.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(f)?(f.sleepTime+=this.timeStep,f.sleepTime>.5?f.sleep():f.updatePosition(this.timeStep)):(f.sleepTime=0,f.updatePosition(this.timeStep)),this.numIslands++;else{var N=0,v=0,b=1;this.islandStack[0]=f,f.addedToIsland=!0;do if(s=this.islandStack[--b],this.islandStack[b]=null,s.sleeping=!1,this.islandRigidBodies[N++]=s,!s.isStatic){for(var z=s.contactLink;null!==z;z=z.next){var c=z.contact;if(y=c.constraint,!y.addedToIsland&&c.touching){this.islandConstraints[v++]=y,y.addedToIsland=!0;var x=z.body;x.addedToIsland||(this.islandStack[b++]=x,x.addedToIsland=!0)}}for(var k=s.jointLink;null!==k;k=k.next)y=k.joint,y.addedToIsland||(this.islandConstraints[v++]=y,y.addedToIsland=!0,x=k.body,!x.addedToIsland&&x.isDynamic&&(this.islandStack[b++]=x,x.addedToIsland=!0))}while(0!=b);for(var A=(new t).addTime(this.gravity,this.timeStep),w=N;w--;)s=this.islandRigidBodies[w],s.isDynamic&&s.linearVelocity.addEqual(A);if(this.enableRandomizer)for(w=v;w--;)if(0!==w){var g=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*w|0;y=this.islandConstraints[w],this.islandConstraints[w]=this.islandConstraints[g],this.islandConstraints[g]=y}for(w=v;w--;)this.islandConstraints[w].preSolve(this.timeStep,d);for(var I=this.numIterations;I--;)for(w=v;w--;)this.islandConstraints[w].solve();for(w=v;w--;)this.islandConstraints[w].postSolve(),this.islandConstraints[w]=null;var M=10;for(w=N;w--;)s=this.islandRigidBodies[w],this.callSleep(s)?(s.sleepTime+=this.timeStep,s.sleepTime<M&&(M=s.sleepTime)):(s.sleepTime=0,M=0);if(M>.5)for(w=N;w--;)this.islandRigidBodies[w].sleep(),this.islandRigidBodies[w]=null;else for(w=N;w--;)this.islandRigidBodies[w].updatePosition(this.timeStep),this.islandRigidBodies[w]=null;this.numIslands++}i&&this.performance.calcEnd()},add:function(i){i=i||{};var a=this.invScale,o=i.type||"box";if("string"==typeof o&&(o=[o]),"joint"===o[0].substring(0,5)){"joint"===o[0]&&(o[0]="jointHinge");var n=i.axe1||[1,0,0],r=i.axe2||[1,0,0],x=i.pos1||[0,0,0],u=i.pos2||[0,0,0];x=x.map(function(i){return i*a}),u=u.map(function(i){return i*a});var y,d;"jointDistance"===o[0]?(y=i.min||0,d=i.max||10,y*=a,d*=a):(y=i.min||57.29578,d=i.max||0,y*=Si.degtorad,d*=Si.degtorad);var f=i.limit||null,N=i.spring||null,z=i.motor||null,A=new L;A.scale=this.scale,A.invScale=this.invScale,A.allowCollision=i.collision||!1,A.localAxis1.init(n[0],n[1],n[2]),A.localAxis2.init(r[0],r[1],r[2]),A.localAnchorPoint1.init(x[0],x[1],x[2]),A.localAnchorPoint2.init(u[0],u[1],u[2]);var w=null,S=null;if(void 0===i.body1||void 0===i.body2)return e("World","Can't add joint if attach rigidbodys not define !");if(i.body1.constructor===String?w=this.getByName(i.body1):i.body1.constructor===Number?w=this.getByName(i.body1):i.body1.constructor===D&&(w=i.body1),i.body2.constructor===String?S=this.getByName(i.body2):i.body2.constructor===Number?S=this.getByName(i.body2):i.body2.constructor===D&&(S=i.body2),null===w||null===S)return e("World","Can't add joint attach rigidbodys not find !");A.body1=w,A.body2=S;var P;switch(o[0]){case"jointDistance":P=new k(A,y,d),null!==N&&P.limitMotor.setSpring(N[0],N[1]),null!==z&&P.limitMotor.setMotor(z[0],z[1]);break;case"jointHinge":P=new v(A,y,d),null!==N&&P.limitMotor.setSpring(N[0],N[1]),null!==z&&P.limitMotor.setMotor(z[0],z[1]);break;case"jointPrisme":P=new g(A,y,d);break;case"jointSlide":P=new I(A,y,d);break;case"jointBall":P=new b(A);break;case"jointWheel":P=new M(A),null!==f&&P.rotationalLimitMotor1.setLimit(f[0],f[1]),null!==N&&P.rotationalLimitMotor1.setSpring(N[0],N[1]),null!==z&&P.rotationalLimitMotor1.setMotor(z[0],z[1])}return P.name=i.name||"",this.addJoint(P),P}var T=i.move||!1,V=i.noSleep||!1,Y=i.pos||[0,0,0];Y=Y.map(function(i){return i*a});var X=void 0===i.size?[1,1,1]:i.size;1===X.length&&(X[1]=X[0]),2===X.length&&(X[2]=X[0]),X=X.map(function(i){return i*a});var Z=i.rot||[0,0,0];Z=Z.map(function(i){return i*Si.degtorad});var U=new p;if(void 0!==i.density&&(U.density=i.density),void 0!==i.friction&&(U.friction=i.friction),void 0!==i.restitution&&(U.restitution=i.restitution),void 0!==i.belongsTo&&(U.belongsTo=i.belongsTo),void 0!==i.collidesWith&&(U.collidesWith=i.collidesWith),void 0!==i.config&&(void 0!==i.config[0]&&(U.density=i.config[0]),void 0!==i.config[1]&&(U.friction=i.config[1]),void 0!==i.config[2]&&(U.restitution=i.config[2]),void 0!==i.config[3]&&(U.belongsTo=i.config[3]),void 0!==i.config[4]&&(U.collidesWith=i.config[4])),i.massPos&&(i.massPos=i.massPos.map(function(i){return i*a}),U.relativePosition.init(i.massPos[0],i.massPos[1],i.massPos[2])),i.massRot){i.massRot=i.massRot.map(function(i){return i*Si.degtorad});var C=(new s).setFromEuler(i.massRot[0],i.massRot[1],i.massRot[2]);U.relativeRotation=(new h).setQuat(C)}for(var j,O=new t(Y[0],Y[1],Y[2]),q=(new s).setFromEuler(Z[0],Z[1],Z[2]),E=new D(O,q,this.scale,this.invScale),F=[],B=0;B<o.length;B++){switch(j=3*B,o[B]){case"sphere":F[B]=new c(U,X[j]);break;case"cylinder":F[B]=new m(U,X[j],X[j+1]);break;case"box":F[B]=new l(U,X[j],X[j+1],X[j+2])}if(E.addShape(F[B]),B>0&&(Y[j]&&(F[B].relativePosition=new t(Y[j],Y[j+1],Y[j+2])),Z[j])){var C=(new s).setFromEuler(Z[j],Z[j+1],Z[j+2]);F[B].relativeRotation=(new h).setQuat(C)}}return T?(i.massPos||i.massRot?E.setupMass(pi,!1):E.setupMass(pi,!0),V?E.allowSleep=!1:E.allowSleep=!0):E.setupMass(xi),void 0!==i.name?E.name=i.name:T&&(E.name=this.numRigidBodies-1),this.addRigidBody(E),E}}),i.Math=Si,i.Vec3=t,i.Quat=s,i.Mat33=h,i.Shape=r,i.BoxShape=l,i.SphereShape=c,i.CylinderShape=m,i.ShapeConfig=p,i.LimitMotor=x,i.HingeJoint=v,i.BallAndSocketJoint=b,i.DistanceJoint=k,i.PrismaticJoint=g,i.SliderJoint=I,i.WheelJoint=M,i.JointConfig=L,i.RigidBody=D,i.World=ai,i.REVISION=oi,i.BR_NULL=ni,i.BR_BRUTE_FORCE=ri,i.BR_SWEEP_AND_PRUNE=li,i.BR_BOUNDING_VOLUME_TREE=ci,i.BODY_NULL=mi,i.BODY_DYNAMIC=pi,i.BODY_STATIC=xi,i.BODY_KINEMATIC=ui,i.BODY_GHOST=yi,i.SHAPE_NULL=di,i.SHAPE_SPHERE=fi,i.SHAPE_BOX=Ni,i.SHAPE_CYLINDER=vi,i.SHAPE_TETRA=bi,i.JOINT_NULL=zi,i.JOINT_DISTANCE=ki,i.JOINT_BALL_AND_SOCKET=Ai,i.JOINT_HINGE=wi,i.JOINT_WHEEL=gi,i.JOINT_SLIDER=Ii,i.JOINT_PRISMATIC=Mi,i.AABB_PROX=Li,i.Error=e,i.Performance=a,Object.defineProperty(i,"__esModule",{value:!0})});
