'use strict';var OIMO={REVISION:"DEV.1.1.2b",SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,WORLD_SCALE:100,INV_SCALE:0.01,TO_RAD:0.017453292519943295,AABB_PROX:0.005};OIMO.sqrt=Math.sqrt;OIMO.abs=Math.abs;OIMO.floor=Math.floor;OIMO.cos=Math.cos;OIMO.sin=Math.sin;OIMO.acos=Math.acos;OIMO.asin=Math.asin;OIMO.atan2=Math.atan2;OIMO.round=Math.round;OIMO.pow=Math.pow;OIMO.max=Math.max;OIMO.min=Math.min;OIMO.random=Math.random;OIMO.lerp=function(a,c,b){return a+(c-a)*b};
OIMO.rand=function(a,c){return OIMO.lerp(a,c,OIMO.random())};OIMO.randInt=function(a,c,b){return 1*OIMO.lerp(a,c,OIMO.random()).toFixed(b||0)};OIMO.degtorad=0.017453292519943295;OIMO.radtodeg=57.29577951308232;OIMO.PI=3.141592653589793;OIMO.TwoPI=6.283185307179586;OIMO.PI90=1.570796326794896;OIMO.PI270=4.712388980384689;OIMO.nextID=0;var OIMO_ARRAY_TYPE;OIMO_ARRAY_TYPE||(OIMO_ARRAY_TYPE="undefined"!==typeof Float32Array?Float32Array:Array);OIMO.World=function(a,c,b,d){this.timeStep=a||1/60;this.numIterations=b||8;switch(c||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.enableRandomizer=!0;this.isNoStat=d||!1;this.rigidBodies=null;this.numRigidBodies=0;this.unusedContacts=this.contacts=null;this.numContactPoints=this.numContacts=0;this.joints=null;this.numIslands=this.numJoints=0;this.gravity=new OIMO.Vec3(0,-9.80665,
0);this.performance=null;this.isNoStat||(this.performance=new OIMO.Performance(this));this.detectors=[];for(a=this.detectors.length=4;a--;)this.detectors[a]=[],this.detectors[a].length=4;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=
new OIMO.BoxBoxCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector(!1);this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector(!0);this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector(!1);
this.randX=65535;this.randA=98765;this.randB=123456789;this.maxIslandRigidBodies=64;this.islandRigidBodies=[];this.islandRigidBodies.length=this.maxIslandRigidBodies;this.islandStack=[];this.islandStack.length=this.maxIslandRigidBodies;this.maxIslandConstraints=128;this.islandConstraints=[];this.islandConstraints.length=this.maxIslandConstraints};
OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0},addRigidBody:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the rigid body");a.parent=this;a.awake();for(var c=a.shapes;null!==c;c=c.next)this.addShape(c);null!==this.rigidBodies&&
((this.rigidBodies.prev=a).next=this.rigidBodies);this.rigidBodies=a;this.numRigidBodies++},removeRigidBody:function(a){if(a.parent===this){a.awake();for(var c=a.jointLink;null!=c;){var b=c.joint,c=c.next;this.removeJoint(b)}for(c=a.shapes;null!==c;c=c.next)this.removeShape(c);c=a.prev;b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.rigidBodies==a&&(this.rigidBodies=b);a.prev=null;a.next=null;a.parent=null;this.numRigidBodies--}},getByName:function(a){for(var c=null,b=this.rigidBodies;null!==
b;)" "!==b.name&&b.name===a&&(c=b),b=b.next;for(b=this.joints;null!==b;)""!==b.name&&b.name===a&&(c=b),b=b.next;return c},addShape:function(a){if(!a.parent||!a.parent.parent)throw Error("It is not possible to be added alone to shape world");a.proxy=this.broadPhase.createProxy(a);a.updateProxy();this.broadPhase.addProxy(a.proxy)},removeShape:function(a){this.broadPhase.removeProxy(a.proxy);a.proxy=null},addJoint:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the joint");
null!=this.joints&&((this.joints.prev=a).next=this.joints);this.joints=a;a.parent=this;this.numJoints++;a.awake();a.attach()},removeJoint:function(a){var c=a.prev,b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.joints==a&&(this.joints=b);a.prev=null;a.next=null;this.numJoints--;a.awake();a.detach();a.parent=null},worldscale:function(a){OIMO.WORLD_SCALE=a||100;OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},step:function(){var a,c,b;this.isNoStat||(a=Date.now());for(var d=this.rigidBodies;null!==d;)d.addedToIsland=
!1,d.sleeping&&(d.linearVelocity.testZero()||d.position.testDiff(d.sleepPosition)||d.orientation.testDiff(d.sleepOrientation))&&d.awake(),d=d.next;this.isNoStat||(c=Date.now());this.broadPhase.detectPairs();for(var e=this.broadPhase.pairs,f=this.broadPhase.numPairs;f--;){var g=e[f],k;g.shape1.id<g.shape2.id?(k=g.shape1,d=g.shape2):(k=g.shape2,d=g.shape1);var h;h=k.numContacts<d.numContacts?k.contactLink:d.contactLink;for(var l=!1;h;){g=h.contact;if(g.shape1==k&&g.shape2==d){l=g.persisting=!0;break}h=
h.next}l||this.addContact(k,d)}this.isNoStat||(b=Date.now(),this.performance.broadPhaseTime=b-c);this.numContactPoints=0;for(g=this.contacts;null!==g;){if(!g.persisting&&(c=g.shape1.aabb,e=g.shape2.aabb,c.minX>e.maxX||c.maxX<e.minX||c.minY>e.maxY||c.maxY<e.minY||c.minZ>e.maxZ||c.maxZ<e.minZ)){h=g.next;this.removeContact(g);g=h;continue}c=g.body1;e=g.body2;(c.isDynamic&&!c.sleeping||e.isDynamic&&!e.sleeping)&&g.updateManifold();this.numContactPoints+=g.manifold.numPoints;g.persisting=!1;g.constraint.addedToIsland=
!1;g=g.next}this.isNoStat||(c=Date.now(),this.performance.narrowPhaseTime=c-b);b=1/this.timeStep;for(c=this.joints;null!==c;c=c.next)c.addedToIsland=!1;this.maxIslandRigidBodies<this.numRigidBodies&&(this.maxIslandRigidBodies=this.numRigidBodies<<1,this.islandRigidBodies=[],this.islandStack=[],this.islandRigidBodies.length=this.maxIslandRigidBodies,this.islandStack.length=this.maxIslandRigidBodies);c=this.numJoints+this.numContacts;this.maxIslandConstraints<c&&(this.maxIslandConstraints=c<<1,this.islandConstraints=
[],this.islandConstraints.length=this.maxIslandConstraints);c=Date.now();this.numIslands=0;for(e=this.rigidBodies;null!==e;e=e.next)if(!(e.addedToIsland||e.isStatic||e.sleeping)){if(e.isLonely())e.isDynamic&&e.linearVelocity.addTime(this.gravity,this.timeStep),this.calSleep(e)?(e.sleepTime+=this.timeStep,0.5<e.sleepTime?e.sleep():e.updatePosition(this.timeStep)):(e.sleepTime=0,e.updatePosition(this.timeStep));else{k=f=0;l=1;this.islandStack[0]=e;e.addedToIsland=!0;do if(d=this.islandStack[--l],this.islandStack[l]=
null,d.sleeping=!1,this.islandRigidBodies[f++]=d,!d.isStatic){for(var m=d.contactLink;null!==m;m=m.next)g=m.contact,h=g.constraint,!h.addedToIsland&&g.touching&&(this.islandConstraints[k++]=h,h.addedToIsland=!0,h=m.body,h.addedToIsland||(this.islandStack[l++]=h,h.addedToIsland=!0));for(g=d.jointLink;null!==g;g=g.next)h=g.joint,h.addedToIsland||(this.islandConstraints[k++]=h,h.addedToIsland=!0,h=g.body,!h.addedToIsland&&h.isDynamic&&(this.islandStack[l++]=h,h.addedToIsland=!0))}while(0!=l);h=(new OIMO.Vec3).addTime(this.gravity,
this.timeStep);for(g=f;g--;)d=this.islandRigidBodies[g],d.isDynamic&&d.linearVelocity.addEqual(h);if(this.enableRandomizer)for(g=k;g--;)0!==g&&(d=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*g|0,h=this.islandConstraints[g],this.islandConstraints[g]=this.islandConstraints[d],this.islandConstraints[d]=h);for(g=k;g--;)this.islandConstraints[g].preSolve(this.timeStep,b);for(d=this.numIterations;d--;)for(g=k;g--;)this.islandConstraints[g].solve();for(g=k;g--;)this.islandConstraints[g].postSolve(),
this.islandConstraints[g]=null;k=10;for(g=f;g--;)d=this.islandRigidBodies[g],this.calSleep(d)?(d.sleepTime+=this.timeStep,d.sleepTime<k&&(k=d.sleepTime)):k=d.sleepTime=0;if(0.5<k)for(g=f;g--;)this.islandRigidBodies[g].sleep(),this.islandRigidBodies[g]=null;else for(g=f;g--;)this.islandRigidBodies[g].updatePosition(this.timeStep),this.islandRigidBodies[g]=null}this.numIslands++}this.isNoStat||(b=Date.now(),this.performance.solvingTime=b-c,b=Date.now(),this.performance.upfps(),this.performance.totalTime=
b-a,this.performance.updatingTime=this.performance.totalTime-(this.performance.broadPhaseTime+this.performance.narrowPhaseTime+this.performance.solvingTime))},addContact:function(a,c){var b;null!==this.unusedContacts?(b=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):b=new OIMO.Contact;b.attach(a,c);b.detector=this.detectors[a.type][c.type];this.contacts&&((this.contacts.prev=b).next=this.contacts);this.contacts=b;this.numContacts++},removeContact:function(a){var c=a.prev,b=a.next;
b&&(b.prev=c);c&&(c.next=b);this.contacts==a&&(this.contacts=b);a.prev=null;a.next=null;a.detach();a.next=this.unusedContacts;this.unusedContacts=a;this.numContacts--},checkContact:function(a,c){for(var b,d,e=this.contacts;null!==e;)if(b=e.body1.name||" ",d=e.body2.name||" ",b==a&&d==c||d==a&&b==c){if(e.touching)return!0;break}else e=e.next;return!1},calSleep:function(a){return!a.allowSleep||0.04<a.linearVelocity.len()||0.25<a.angularVelocity.len()?!1:!0}};OIMO.RigidBody=function(a,c,b,d,e,f,g){d=d||0;e=e||0;f=f||0;g=g||0;a=a||0;c=c||0;b=b||0;this.name=" ";this.BODY_DYNAMIC=1;this.BODY_STATIC=2;this.MAX_SHAPES=64;this.next=this.prev=null;this.type=0;this.massInfo=new OIMO.MassInfo;this.position=new OIMO.Vec3(a,c,b);this.newPosition=new OIMO.Vec3(0,0,0);this.controlPos=!1;this.newOrientation=new OIMO.Quat;this.newRotation=new OIMO.Vec3(0,0,0);this.currentRotation=new OIMO.Vec3(0,0,0);this.controlRotInTime=this.controlRot=!1;this.orientation=this.rotationAxisToQuad(d,
e,f,g);this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;this.matrix=new OIMO.Mat44;this.contactLink=this.parent=null;this.numContacts=0;this.shapes=null;this.numShapes=0;this.jointLink=null;this.numJoints=0;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.isDynamic=this.isStatic=!1;this.rotation=new OIMO.Mat33;this.inverseMass=this.mass=NaN;this.inverseInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.inverseLocalInertia=new OIMO.Mat33;this.addedToIsland=
!1;this.allowSleep=!0;this.sleepTime=0;this.sleeping=!1};
OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(a){if(a.parent)throw Error("It is not possible that you add to the multi-rigid body the shape of one");null!=this.shapes&&((this.shapes.prev=a).next=this.shapes);this.shapes=a;a.parent=this;this.parent&&this.parent.addShape(a);this.numShapes++},removeShape:function(a){if(a.parent==this){var c=a.prev,b=a.next;null!=c&&(c.next=b);null!=b&&(b.prev=c);this.shapes==a&&(this.shapes=b);a.prev=null;a.next=null;a.parent=null;this.parent&&
this.parent.removeShape(a);this.numShapes--}},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(a){this.parent.checkContact(this.name,a)},setupMass:function(a,c){var b=void 0!==c?c:!0,d=a||this.BODY_DYNAMIC;this.type=d;this.isDynamic=d==this.BODY_DYNAMIC;this.isStatic=d==this.BODY_STATIC;this.mass=0;this.localInertia.init(0,0,0,0,0,0,0,0,0);for(var e=this.localInertia.elements,f=new OIMO.Mat33,g=new OIMO.Vec3,k=this.shapes;null!=k;k=k.next){k.calculateMassInfo(this.massInfo);
var h=this.massInfo.mass,l=k.relativePosition.x,m=k.relativePosition.y,n=k.relativePosition.z;g.addScale(k.relativePosition,h);this.mass+=h;this.rotateInertia(k.relativeRotation,this.massInfo.inertia,f);this.localInertia.addEqual(f);e[0]+=h*(m*m+n*n);e[4]+=h*(l*l+n*n);e[8]+=h*(l*l+m*m);var p=h*l*m,m=h*m*n,h=h*n*l;e[1]-=p;e[3]-=p;e[2]-=m;e[6]-=m;e[5]-=h;e[7]-=h}this.inverseMass=1/this.mass;g.scaleEqual(this.inverseMass);if(b){this.position.addEqual(g);for(k=this.shapes;null!=k;k=k.next)k.relativePosition.subEqual(g);
l=g.x;m=g.y;n=g.z;e[0]-=this.mass*(m*m+n*n);e[4]-=this.mass*(l*l+n*n);e[8]-=this.mass*(l*l+m*m);p=this.mass*l*m;m=this.mass*m*n;h=this.mass*n*l;e[1]+=p;e[3]+=p;e[2]+=m;e[6]+=m;e[5]+=h;e[7]+=h}this.inverseLocalInertia.invert(this.localInertia);d==this.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.init(0,0,0,0,0,0,0,0,0));this.syncShapes();this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1;this.sleepTime=0;for(var a=this.contactLink;null!=a;)a.body.sleepTime=
0,a.body.sleeping=!1,a=a.next;for(a=this.jointLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;for(a=this.shapes;null!=a;a=a.next)a.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.init();this.angularVelocity.init();this.sleepPosition.copy(this.position);this.sleepOrientation.copy(this.orientation);this.sleepTime=0;this.sleeping=!0;for(var a=this.shapes;null!=a;a=a.next)a.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},
updatePosition:function(a){switch(this.type){case this.BODY_STATIC:this.linearVelocity.init();this.angularVelocity.init();this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1);this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case this.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.init(),this.linearVelocity.init(),this.linearVelocity.x=(this.newPosition.x-this.position.x)/a,this.linearVelocity.y=(this.newPosition.y-this.position.y)/a,
this.linearVelocity.z=(this.newPosition.z-this.position.z)/a,this.controlPos=!1);this.controlRot&&(this.angularVelocity.init(),this.orientation.copy(this.newOrientation),this.controlRot=!1);this.position.addTime(this.linearVelocity,a);this.orientation.addTime(this.angularVelocity,a);break;default:throw Error("Invalid type.");}this.syncShapes()},rotateInertia:function(a,c,b){var d=a.elements,e=c.elements;c=d[0];a=d[3];var f=d[6],g=d[1],k=d[4],h=d[7],l=d[2],m=d[5],d=d[8],n=e[0],p=e[3],r=e[6],q=e[1],
t=e[4],s=e[7],u=e[2],y=e[5],B=e[8],e=c*n+g*p+l*r,I=c*q+g*t+l*s,G=c*u+g*y+l*B,C=a*n+k*p+m*r,J=a*q+k*t+m*s,K=a*u+k*y+m*B,n=f*n+h*p+d*r,q=f*q+h*t+d*s,u=f*u+h*y+d*B;b=b.elements;b[0]=e*c+I*g+G*l;b[1]=e*a+I*k+G*m;b[2]=e*f+I*h+G*d;b[3]=C*c+J*g+K*l;b[4]=C*a+J*k+K*m;b[5]=C*f+J*h+K*d;b[6]=n*c+q*g+u*l;b[7]=n*a+q*k+u*m;b[8]=n*f+q*h+u*d},syncShapes:function(){var a=this.orientation.s,c=this.orientation.x,b=this.orientation.y,d=this.orientation.z,e=2*c,f=2*b,g=2*d,k=c*e,h=b*f,d=d*g,l=c*f,b=b*g,c=c*g,e=a*e,f=a*
f,a=a*g,g=this.rotation.elements;g[0]=1-h-d;g[1]=l-a;g[2]=c+f;g[3]=l+a;g[4]=1-k-d;g[5]=b-e;g[6]=c-f;g[7]=b+e;g[8]=1-k-h;this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(k=this.shapes;null!=k;k=k.next)k.position.mul(this.position,k.relativePosition,this.rotation),k.rotation.mul(k.relativeRotation,this.rotation),k.updateProxy()},applyImpulse:function(a,c){this.linearVelocity.addScale(c,this.inverseMass);var b=new OIMO.Vec3;b.sub(a,this.position).cross(b,c).mulMat(this.inverseInertia,
b);this.angularVelocity.addEqual(b)},rotationVectToQuad:function(a){a=OIMO.EulerToAxis(a.x*OIMO.degtorad,a.y*OIMO.degtorad,a.z*OIMO.degtorad);return this.rotationAxisToQuad(a[0],a[1],a[2],a[3])},rotationAxisToQuad:function(a,c,b,d){var e=c*c+b*b+d*d;0<e&&(e=1/OIMO.sqrt(e),c*=e,b*=e,d*=e);e=OIMO.sin(0.5*a);a=OIMO.cos(0.5*a);return new OIMO.Quat(a,e*c,e*b,e*d)},setPosition:function(a){this.newPosition.init(a.x*OIMO.INV_SCALE,a.y*OIMO.INV_SCALE,a.z*OIMO.INV_SCALE);this.controlPos=!0},setQuaternion:function(a){this.newOrientation.init(a.w,
a.x,a.y,a.z);this.controlRot=!0},setRotation:function(a){this.newOrientation=this.rotationVectToQuad(a);this.controlRot=!0},resetPosition:function(a,c,b){this.linearVelocity.init();this.angularVelocity.init();this.position.init(a*OIMO.INV_SCALE,c*OIMO.INV_SCALE,b*OIMO.INV_SCALE);this.awake()},resetQuaternion:function(a){this.angularVelocity.init();this.orientation=new OIMO.Quat(a.w,a.x,a.y,a.z);this.awake()},resetRotation:function(a,c,b){this.angularVelocity.init();this.orientation=this.rotationVectToQuad(new OIMO.Vec3(a,
c,b));this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var a=this.matrix.elements,c;this.sleeping?a[15]=1:(c=this.rotation.elements,a[0]=c[0],a[1]=c[3],a[2]=c[6],a[3]=0,a[4]=c[1],a[5]=c[4],a[6]=c[7],a[7]=0,a[8]=c[2],a[9]=c[5],a[10]=c[8],a[11]=0,c=this.position,
a[12]=c.x*OIMO.WORLD_SCALE,a[13]=c.y*OIMO.WORLD_SCALE,a[14]=c.z*OIMO.WORLD_SCALE,a[15]=0);return a}};OIMO.Body=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="box"),this.name=a.name||"",this.body=a.world.add(a))};
OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(a){this.body.setPosition(a)},setQuaternion:function(a){this.body.setQuaternion(a)},setRotation:function(a){this.body.setRotation(a)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(a,c,b){this.body.resetPosition(a,
c,b)},resetRotation:function(a,c,b){this.body.resetRotation(a,c,b)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(a){this.body.checkContact(a)}};OIMO.Link=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="jointHinge"),this.name=a.name||"",this.joint=a.world.add(a))};OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}};OIMO.Performance=function(a){this.parent=a;this.infos=new OIMO_ARRAY_TYPE(13);this.f=[0,0,0];this.totalTime=this.updatingTime=this.solvingTime=this.narrowPhaseTime=this.broadPhaseTime=this.fps=0};
OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now();this.f[1]-1E3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0);this.f[2]++},show:function(){return["Oimo.js DEV.1.1.2a<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","contact &nbsp;&nbsp;"+this.parent.numContactPoints+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+
"<br><br>","Time in ms <br>","broad-phase &nbsp;"+this.broadPhaseTime+"<br>","narrow-phase "+this.narrowPhaseTime+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.solvingTime+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.totalTime].join("\n")},toArray:function(){this.infos[0]=this.parent.broadPhase.types;this.infos[1]=this.parent.numRigidBodies;this.infos[2]=this.parent.numContacts;this.infos[3]=this.parent.broadPhase.numPairChecks;
this.infos[4]=this.parent.numContactPoints;this.infos[5]=this.parent.numIslands;this.infos[6]=this.broadPhaseTime;this.infos[7]=this.narrowPhaseTime;this.infos[8]=this.solvingTime;this.infos[9]=this.updatingTime;this.infos[10]=this.totalTime;this.infos[11]=this.fps;return this.infos}};OIMO.Mat44=function(a,c,b,d,e,f,g,k,h,l,m,n,p,r,q,t){var s=this.elements=new OIMO_ARRAY_TYPE(16);s[0]=void 0!==a?a:1;s[4]=c||0;s[8]=b||0;s[12]=d||0;s[1]=e||0;s[5]=void 0!==f?f:1;s[9]=g||0;s[13]=k||0;s[2]=h||0;s[6]=l||0;s[10]=void 0!==m?m:1;s[14]=n||0;s[3]=p||0;s[7]=r||0;s[11]=q||0;s[15]=void 0!==t?t:1};
OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(a,c,b,d,e,f,g,k,h,l,m,n,p,r,q,t){var s=this.elements;s[0]=a;s[4]=c;s[8]=b;s[12]=d;s[1]=e;s[5]=f;s[9]=g;s[13]=k;s[2]=h;s[6]=l;s[10]=m;s[14]=n;s[3]=p;s[7]=r;s[11]=q;s[15]=t;return this}};OIMO.Mat33=function(a,c,b,d,e,f,g,k,h){this.elements=new OIMO_ARRAY_TYPE(9);this.init(void 0!==a?a:1,c||0,b||0,d||0,void 0!==e?e:1,f||0,g||0,k||0,void 0!==h?h:1)};
OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(a,c,b,d,e,f,g,k,h){var l=this.elements;l[0]=a;l[1]=c;l[2]=b;l[3]=d;l[4]=e;l[5]=f;l[6]=g;l[7]=k;l[8]=h;return this},add:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]+e[0];b[1]=d[1]+e[1];b[2]=d[2]+e[2];b[3]=d[3]+e[3];b[4]=d[4]+e[4];b[5]=d[5]+e[5];b[6]=d[6]+e[6];b[7]=d[7]+e[7];b[8]=d[8]+e[8];return this},addEqual:function(a){var c=this.elements;a=a.elements;c[0]+=a[0];c[1]+=a[1];c[2]+=a[2];c[3]+=a[3];c[4]+=a[4];c[5]+=
a[5];c[6]+=a[6];c[7]+=a[7];c[8]+=a[8];return this},sub:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]-e[0];b[1]=d[1]-e[1];b[2]=d[2]-e[2];b[3]=d[3]-e[3];b[4]=d[4]-e[4];b[5]=d[5]-e[5];b[6]=d[6]-e[6];b[7]=d[7]-e[7];b[8]=d[8]-e[8];return this},subEqual:function(a){var c=this.elements;a=a.elements;c[0]-=a[0];c[1]-=a[1];c[2]-=a[2];c[3]-=a[3];c[4]-=a[4];c[5]-=a[5];c[6]-=a[6];c[7]-=a[7];c[8]-=a[8];return this},scale:function(a,c){var b=this.elements,d=a.elements;b[0]=d[0]*c;b[1]=d[1]*
c;b[2]=d[2]*c;b[3]=d[3]*c;b[4]=d[4]*c;b[5]=d[5]*c;b[6]=d[6]*c;b[7]=d[7]*c;b[8]=d[8]*c;return this},scaleEqual:function(a){var c=this.elements;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=a;c[4]*=a;c[5]*=a;c[6]*=a;c[7]*=a;c[8]*=a;return this},mul:function(a,c){var b=this.elements,d=a.elements,e=c.elements,f=d[0],g=d[3],k=d[6],h=d[1],l=d[4],m=d[7],n=d[2],p=d[5],d=d[8],r=e[0],q=e[3],t=e[6],s=e[1],u=e[4],y=e[7],B=e[2],I=e[5],e=e[8];b[0]=f*r+h*q+n*t;b[1]=f*s+h*u+n*y;b[2]=f*B+h*I+n*e;b[3]=g*r+l*q+p*t;b[4]=g*s+l*u+p*y;
b[5]=g*B+l*I+p*e;b[6]=k*r+m*q+d*t;b[7]=k*s+m*u+d*y;b[8]=k*B+m*I+d*e;return this},mulScale:function(a,c,b,d,e){var f=this.elements;a=a.elements;e?(f[0]=c*a[0],f[1]=c*a[1],f[2]=c*a[2],f[3]=b*a[3],f[4]=b*a[4],f[5]=b*a[5],f[6]=d*a[6],f[7]=d*a[7],f[8]=d*a[8]):(f[0]=a[0]*c,f[1]=a[1]*b,f[2]=a[2]*d,f[3]=a[3]*c,f[4]=a[4]*b,f[5]=a[5]*d,f[6]=a[6]*c,f[7]=a[7]*b,f[8]=a[8]*d);return this},mulRotate:function(a,c,b,d,e,f){f=f||!1;var g=Math.sin(c),k=Math.cos(c),h=1-k;c=b*b*h+k;var l=b*d*h-e*g,m=b*e*h+d*g,n=d*b*h+
e*g,p=d*d*h+k,r=d*e*h-b*g,q=e*b*h-d*g;b=e*d*h+b*g;e=e*e*h+k;var t=a.elements;a=t[0];d=t[3];var g=t[6],k=t[1],h=t[4],s=t[7],u=t[2],y=t[5],t=t[8],B=this.elements;f?(B[0]=c*a+l*d+m*g,B[1]=c*k+l*h+m*s,B[2]=c*u+l*y+m*t,B[3]=n*a+p*d+r*g,B[4]=n*k+p*h+r*s,B[5]=n*u+p*y+r*t,B[6]=q*a+b*d+e*g,B[7]=q*k+b*h+e*s,B[8]=q*u+b*y+e*t):(B[0]=a*c+k*n+u*q,B[1]=a*l+k*p+u*b,B[2]=a*m+k*r+u*e,B[3]=d*c+h*n+y*q,B[4]=d*l+h*p+y*b,B[5]=d*m+h*r+y*e,B[6]=g*c+s*n+t*q,B[7]=g*l+s*p+t*b,B[8]=g*m+s*r+t*e);return this},transpose:function(a){var c=
this.elements;a=a.elements;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];return this},setQuat:function(a){var c=this.elements,b=2*a.x,d=2*a.y,e=2*a.z,f=a.x*b,g=a.y*d,k=a.z*e,h=a.x*d,l=a.y*e,m=a.x*e,b=a.s*b,d=a.s*d;a=a.s*e;c[0]=1-g-k;c[1]=h-a;c[2]=m+d;c[3]=h+a;c[4]=1-f-k;c[5]=l-b;c[6]=m-d;c[7]=l+b;c[8]=1-f-g;return this},invert:function(a){var c=this.elements,b=a.elements;a=b[0];var d=b[3],e=b[6],f=b[1],g=b[4],k=b[7],h=b[2],l=b[5],b=b[8],m=g*b-k*l,n=k*h-
f*b,p=f*l-g*h,r=a*m+d*n+e*p;0!=r&&(r=1/r);c[0]=r*m;c[1]=r*n;c[2]=r*p;c[3]=r*(l*e-d*b);c[4]=r*(a*b-h*e);c[5]=r*(h*d-a*l);c[6]=r*(d*k-g*e);c[7]=r*(f*e-a*k);c[8]=r*(a*g-f*d);return this},copy:function(a){var c=this.elements;a=a.elements;c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];return this},toEuler:function(){var a=this.elements,c=a[0],b=a[3],d=a[6],e=a[4],f=a[7],g=a[5],a=a[8],k=new OIMO.Vec3;new OIMO.Quat;k.y=Math.asin(Math.min(Math.max(d,-1),1));0.99999>
Math.abs(d)?(k.x=Math.atan2(-f,a),k.z=Math.atan2(-b,c)):(k.x=Math.atan2(g,e),k.z=0);return k},clone:function(){var a=this.elements;return new OIMO.Mat33(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},toString:function(){var a=this.elements;return"Mat33|"+a[0].toFixed(4)+", "+a[1].toFixed(4)+", "+a[2].toFixed(4)+"|\n     |"+a[3].toFixed(4)+", "+a[4].toFixed(4)+", "+a[5].toFixed(4)+"|\n     |"+a[6].toFixed(4)+", "+a[7].toFixed(4)+", "+a[8].toFixed(4)+"|"}};OIMO.Quat=function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0};
OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0;return this},add:function(a,c){this.s=a.s+c.s;this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addTime:function(a,c){var b=a.x,d=a.y,e=a.z,f=this.s,g=this.x,k=this.y,h=this.z;c*=0.5;var l=(b*f+d*h-e*k)*c,m=(-b*h+d*f+e*g)*c,n=(b*k-d*g+e*f)*c,f=f+(-b*g-d*k-e*h)*c,g=g+l,k=k+m,h=h+n,b=1/Math.sqrt(f*f+g*g+k*k+h*h);this.s=f*b;this.x=g*b;this.y=k*b;this.z=h*b;return this},
sub:function(a,c){this.s=a.s-c.s;this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},scale:function(a,c){this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},mul:function(a,c){var b=a.x,d=a.y,e=a.z,f=a.s,g=c.x,k=c.y,h=c.z,l=c.s;this.x=b*l+f*g+d*h-e*k;this.y=d*l+f*k+e*g-b*h;this.z=e*l+f*h+b*k-d*g;this.s=f*l-b*g-d*k-e*h;return this},arc:function(a,c){var b=a.x,d=a.y,e=a.z,f=c.x,g=c.y,k=c.z,h=b*f+d*g+e*k;if(-1==h)return f=d*b-e*e,g=-e*d-b*b,k=b*e+d*d,h=1/Math.sqrt(f*f+g*g+k*k),this.s=
0,this.x=f*h,this.y=g*h,this.z=k*h,this;var l=d*k-e*g,e=e*f-b*k,b=b*g-d*f;this.s=Math.sqrt(0.5*(1+h));h=0.5/this.s;this.x=l*h;this.y=e*h;this.z=b*h;return this},normalize:function(a){var c=Math.sqrt(a.s*a.s+a.x*a.x+a.y*a.y+a.z*a.z);0<c&&(c=1/c);this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},invert:function(a){this.s=a.s;this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.s=
a.s;this.x=a.x;this.y=a.y;this.z=a.z;return this},testDiff:function(a){return this.s!==a.s||this.x!==a.x||this.y!==a.y||this.z!==a.z?!0:!1},clone:function(a){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}};OIMO.Quaternion=function(a,c,b,d){this.x=a||0;this.y=c||0;this.z=b||0;this.w=void 0!==d?d:1};
OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(a){var c=a.elements,b=c[0];a=c[1];var d=c[2],e=c[3],f=c[4],g=c[5],k=c[6],h=c[7],c=c[8],l=b+f+c;0<l?(b=0.5/Math.sqrt(l+1),this.w=0.25/b,this.x=(h-g)*b,this.y=(d-k)*b,this.z=(e-a)*b):b>f&&b>c?(b=2*Math.sqrt(1+b-f-c),this.w=(h-g)/b,this.x=0.25*b,this.y=(a+e)/b,this.z=(d+k)/b):f>c?(b=2*Math.sqrt(1+f-b-c),this.w=(d-k)/b,this.x=(a+e)/b,this.y=0.25*b,this.z=(g+h)/b):(b=2*Math.sqrt(1+c-b-f),this.w=(e-a)/b,this.x=(d+k)/b,
this.y=(g+h)/b,this.z=0.25*b);return this}};OIMO.Vec3=function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0};
OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},set:function(a,c,b){this.x=a;this.y=c;this.z=b;return this},add:function(a,c){this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addEqual:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addTime:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},subEqual:function(a){this.x-=
a.x;this.y-=a.y;this.z-=a.z;return this},addScale:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},scale:function(a,c){this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},scaleEqual:function(a){this.x*=a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a,c){var b=a.x,d=a.y,e=a.z,f=c.x,g=c.y,k=c.z;this.x=d*k-e*g;this.y=e*f-b*k;this.z=b*g-d*f;return this},mul:function(a,c,b){b=b.elements;this.x=a.x+c.x*b[0]+c.y*b[1]+c.z*b[2];
this.y=a.y+c.x*b[3]+c.y*b[4]+c.z*b[5];this.z=a.z+c.x*b[6]+c.y*b[7]+c.z*b[8];return this},mulMat:function(a,c){var b=a.elements,d=b[3]*c.x+b[4]*c.y+b[5]*c.z,e=b[6]*c.x+b[7]*c.y+b[8]*c.z;this.x=b[0]*c.x+b[1]*c.y+b[2]*c.z;this.y=d;this.z=e;return this},normalize:function(a){var c=a.x,b=a.y;a=a.z;var d=c*c+b*b+a*a;0<d&&(d=1/Math.sqrt(d),this.x=c*d,this.y=b*d,this.z=a*d);return this},invert:function(a){this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){var a=this.x,c=this.y,b=this.z;return Math.sqrt(a*
a+c*c+b*b)},len:function(){var a=this.x,c=this.y,b=this.z;return a*a+c*c+b*b},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},applyQuaternion:function(a){var c=this.x,b=this.y,d=this.z,e=a.x,f=a.y,g=a.z;a=a.s;var k=a*c+f*d-g*b,h=a*b+g*c-e*d,l=a*d+e*b-f*c,c=-e*c-f*b-g*d;this.x=k*a+c*-e+h*-g-l*-f;this.y=h*a+c*-f+l*-e-k*-g;this.z=l*a+c*-g+k*-f-h*-e;return this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z?!0:!1},testDiff:function(a){return this.x!==a.x||this.y!==a.y||
this.z!==a.z?!0:!1},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}};OIMO.Euler=function(a,c,b,d){this._x=a||0;this._y=c||0;this._z=b||0;this._order=d||OIMO.Euler.DefaultOrder};OIMO.Euler.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" ");OIMO.Euler.DefaultOrder="XYZ";OIMO.clamp=function(a,c,b){return a<c?c:a>b?b:a};
OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(a){this._x=a;this.onChangeCallback()},get y(){return this._y},set y(a){this._y=a;this.onChangeCallback()},get z(){return this._z},set z(a){this._z=a;this.onChangeCallback()},get order(){return this._order},set order(a){this._order=a;this.onChangeCallback()},set:function(a,c,b,d){this._x=a;this._y=c;this._z=b;this._order=d||this._order;this.onChangeCallback();return this},copy:function(a){this._x=
a._x;this._y=a._y;this._z=a._z;this._order=a._order;this.onChangeCallback();return this},setFromRotationMatrix:function(a,c){var b=OIMO.clamp,d=a.elements,e=d[0],f=d[1],g=d[2],k=d[3],h=d[4],l=d[5],m=d[6],n=d[7],d=d[8];c=c||this._order;"XYZ"===c?(this._y=Math.asin(b(g,-1,1)),0.99999>Math.abs(g)?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-f,e)):(this._x=Math.atan2(n,h),this._z=0)):"YXZ"===c?(this._x=Math.asin(-b(l,-1,1)),0.99999>Math.abs(l)?(this._y=Math.atan2(g,d),this._z=Math.atan2(k,h)):(this._y=
Math.atan2(-m,e),this._z=0)):"ZXY"===c?(this._x=Math.asin(b(n,-1,1)),0.99999>Math.abs(n)?(this._y=Math.atan2(-m,d),this._z=Math.atan2(-f,h)):(this._y=0,this._z=Math.atan2(k,e))):"ZYX"===c?(this._y=Math.asin(-b(m,-1,1)),0.99999>Math.abs(m)?(this._x=Math.atan2(n,d),this._z=Math.atan2(k,e)):(this._x=0,this._z=Math.atan2(-f,h))):"YZX"===c?(this._z=Math.asin(b(k,-1,1)),0.99999>Math.abs(k)?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-m,e)):(this._x=0,this._y=Math.atan2(g,d))):"XZY"===c?(this._z=Math.asin(-b(f,
-1,1)),0.99999>Math.abs(f)?(this._x=Math.atan2(n,h),this._y=Math.atan2(g,e)):(this._x=Math.atan2(-l,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+c);this._order=c;this.onChangeCallback();return this},setFromQuaternion:function(a,c,b){var d=OIMO.clamp,e=a.x*a.x,f=a.y*a.y,g=a.z*a.z,k=a.s*a.s;c=c||this._order;"XYZ"===c?(this._x=Math.atan2(2*(a.x*a.s-a.y*a.z),k-e-f+g),this._y=Math.asin(d(2*(a.x*a.z+a.y*a.s),-1,1)),this._z=Math.atan2(2*(a.z*a.s-a.x*a.y),
k+e-f-g)):"YXZ"===c?(this._x=Math.asin(d(2*(a.x*a.s-a.y*a.z),-1,1)),this._y=Math.atan2(2*(a.x*a.z+a.y*a.s),k-e-f+g),this._z=Math.atan2(2*(a.x*a.y+a.z*a.s),k-e+f-g)):"ZXY"===c?(this._x=Math.asin(d(2*(a.x*a.s+a.y*a.z),-1,1)),this._y=Math.atan2(2*(a.y*a.s-a.z*a.x),k-e-f+g),this._z=Math.atan2(2*(a.z*a.s-a.x*a.y),k-e+f-g)):"ZYX"===c?(this._x=Math.atan2(2*(a.x*a.s+a.z*a.y),k-e-f+g),this._y=Math.asin(d(2*(a.y*a.s-a.x*a.z),-1,1)),this._z=Math.atan2(2*(a.x*a.y+a.z*a.s),k+e-f-g)):"YZX"===c?(this._x=Math.atan2(2*
(a.x*a.s-a.z*a.y),k-e+f-g),this._y=Math.atan2(2*(a.y*a.s-a.x*a.z),k+e-f-g),this._z=Math.asin(d(2*(a.x*a.y+a.z*a.s),-1,1))):"XZY"===c?(this._x=Math.atan2(2*(a.x*a.s+a.y*a.z),k-e+f-g),this._y=Math.atan2(2*(a.x*a.z+a.y*a.s),k+e-f-g),this._z=Math.asin(d(2*(a.z*a.s-a.x*a.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+c);this._order=c;if(!1!==b)this.onChangeCallback();return this},reorder:function(){var a=new OIMO.Quat;return function(c){a.setFromEuler(this);this.setFromQuaternion(a,
c)}}(),equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._order===this._order},fromArray:function(a){this._x=a[0];this._y=a[1];this._z=a[2];void 0!==a[3]&&(this._order=a[3]);this.onChangeCallback();return this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(a){this.onChangeCallback=a;return this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}};OIMO.EulerToAxis=function(a,c,b){var d=Math.cos(0.5*c);c=Math.sin(0.5*c);var e=Math.cos(0.5*b),f=Math.sin(0.5*b),g=Math.cos(0.5*a),k=Math.sin(0.5*a),h=d*e,l=c*f;a=h*k+l*g;b=c*e*g+d*f*k;d=d*f*g-c*e*k;c=2*Math.acos(h*g-l*k);e=a*a+b*b+d*d;0.001>e?(a=1,b=d=0):(e=Math.sqrt(e),a/=e,b/=e,d/=e);return[c,a,b,d]};
OIMO.EulerToMatrix=function(a,c,b){var d=Math.cos(c);c=Math.sin(c);var e=Math.cos(b);b=Math.sin(b);var f=Math.cos(a);a=Math.sin(a);var g=new OIMO.Mat33,k=g.elements;k[0]=d*e;k[1]=c*a-d*b*f;k[2]=d*b*a+c*f;k[3]=b;k[4]=e*f;k[5]=-e*a;k[6]=-c*e;k[7]=c*b*f+d*a;k[8]=-c*b*a+d*f;return g};
OIMO.MatrixToEuler=function(a){var c=a.elements,b;0.998<c[3]?(b=Math.atan2(c[2],c[8]),c=Math.PI/2,a=0):-0.998>c[3]?(b=Math.atan2(c[2],c[8]),c=-Math.PI/2,a=0):(b=Math.atan2(-c[6],c[0]),a=Math.atan2(-c[5],c[4]),c=Math.asin(c[3]));return[a,b,c]};OIMO.unwrapDegrees=function(a){a%=360;180<a&&(a-=360);-180>a&&(a+=360);return a};OIMO.unwrapRadian=function(a){a%=OIMO.TwoPI;a>Math.PI&&(a-=OIMO.TwoPI);a<-Math.PI&&(a+=OIMO.TwoPI);return a};OIMO.Distance3d=function(a,c){var b=c[0]-a[0],d=c[1]-a[1],e=c[2]-a[2];return Math.sqrt(b*b+d*d+e*e)};OIMO.Constraint=function(){this.body2=this.body1=this.parent=null;this.addedToIsland=!1};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(a,c){throw Error("Inheritance error.");},solve:function(){throw Error("Inheritance error.");},postSolve:function(){throw Error("Inheritance error.");}};OIMO.Joint=function(a){OIMO.Constraint.call(this);this.name="";this.JOINT_DISTANCE=1;this.JOINT_BALL_AND_SOCKET=2;this.JOINT_HINGE=3;this.JOINT_WHEEL=4;this.JOINT_SLIDER=5;this.JOINT_PRISMATIC=6;this.type=0;this.next=this.prev=null;this.body1=a.body1;this.body2=a.body2;this.localAnchorPoint1=(new OIMO.Vec3).copy(a.localAnchorPoint1);this.localAnchorPoint2=(new OIMO.Vec3).copy(a.localAnchorPoint2);this.relativeAnchorPoint1=new OIMO.Vec3;this.relativeAnchorPoint2=new OIMO.Vec3;this.anchorPoint1=new OIMO.Vec3;
this.anchorPoint2=new OIMO.Vec3;this.allowCollision=a.allowCollision;this.b1Link=new OIMO.JointLink(this);this.b2Link=new OIMO.JointLink(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);
OIMO.Joint.prototype.updateAnchorPoints=function(){var a=this.body1.position,c=this.body2.position,b=this.body1.rotation.elements,d=this.body2.rotation.elements,e=this.localAnchorPoint1.x,f=this.localAnchorPoint1.y,g=this.localAnchorPoint1.z,k=this.localAnchorPoint2.x,h=this.localAnchorPoint2.y,l=this.localAnchorPoint2.z,m=e*b[0]+f*b[1]+g*b[2],n=e*b[3]+f*b[4]+g*b[5],f=e*b[6]+f*b[7]+g*b[8],e=k*d[0]+h*d[1]+l*d[2],b=k*d[3]+h*d[4]+l*d[5],d=k*d[6]+h*d[7]+l*d[8];this.relativeAnchorPoint1.x=m;this.relativeAnchorPoint1.y=
n;this.relativeAnchorPoint1.z=f;this.relativeAnchorPoint2.x=e;this.relativeAnchorPoint2.y=b;this.relativeAnchorPoint2.z=d;n+=a.y;k=f+a.z;h=e+c.x;l=b+c.y;c=d+c.z;this.anchorPoint1.x=m+a.x;this.anchorPoint1.y=n;this.anchorPoint1.z=k;this.anchorPoint2.x=h;this.anchorPoint2.y=l;this.anchorPoint2.z=c};
OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2;this.b2Link.body=this.body1;null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null;this.body1.jointLink=this.b1Link;this.body1.numJoints++;null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null;this.body2.jointLink=this.b2Link;this.body2.numJoints++};
OIMO.Joint.prototype.detach=function(){var a=this.b1Link.prev,c=this.b1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body1.jointLink==this.b1Link&&(this.body1.jointLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.body=null;this.body1.numJoints--;a=this.b2Link.prev;c=this.b2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body2.jointLink==this.b2Link&&(this.body2.jointLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.body=null;this.body2.numJoints--;this.b1Link.body=
null;this.b2Link.body=null};OIMO.Joint.prototype.awake=function(){this.body1.awake();this.body2.awake()};OIMO.Joint.prototype.preSolve=function(a,c){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};OIMO.Joint.prototype.dispose=function(){this.parent.removeJoint(this)};OIMO.Joint.prototype.getPosition=function(){var a=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE),c=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[a,c]};
OIMO.Joint.prototype.getMatrix=function(){var a=this.matrix.elements,c=this.anchorPoint1,b=this.anchorPoint2;a[0]=c.x*OIMO.WORLD_SCALE;a[1]=c.y*OIMO.WORLD_SCALE;a[2]=c.z*OIMO.WORLD_SCALE;a[3]=0;a[4]=b.x*OIMO.WORLD_SCALE;a[5]=b.y*OIMO.WORLD_SCALE;a[6]=b.z*OIMO.WORLD_SCALE;a[7]=0;return a};OIMO.JointConfig=function(){this.body2=this.body1=null;this.localAnchorPoint1=new OIMO.Vec3;this.localAnchorPoint2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=!1};OIMO.JointLink=function(a){this.body=this.next=this.prev=null;this.joint=a};OIMO.LimitMotor=function(a,c){this.axis=a;this.angle=0;this.lowerLimit=c?0:1;this.dampingRatio=this.frequency=this.maxMotorForce=this.motorSpeed=this.upperLimit=0};OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(a,c){this.lowerLimit=a;this.upperLimit=c},setMotor:function(a,c){this.motorSpeed=a;this.maxMotorForce=c},setSpring:function(a,c){this.frequency=a;this.dampingRatio=c}};OIMO.BallAndSocketJoint=function(a){OIMO.Joint.call(this,a);this.type=this.JOINT_BALL_AND_SOCKET;this.lc=new OIMO.LinearConstraint(this)};OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallAndSocketJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();this.lc.preSolve(a,c)};OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()};OIMO.BallAndSocketJoint.prototype.postSolve=function(){};OIMO.DistanceJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_DISTANCE;this.normal=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.normal,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.DistanceJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();var b=this.anchorPoint2.x-this.anchorPoint1.x,d=this.anchorPoint2.y-this.anchorPoint1.y,e=this.anchorPoint2.z-this.anchorPoint1.z,f=Math.sqrt(b*b+d*d+e*e);0<f&&(f=1/f);this.normal.init(b*f,d*f,e*f);this.t.preSolve(a,c)};OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_HINGE;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*
this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*
a[1]+this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.nor,!1);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.lc=new OIMO.LinearConstraint(this);this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,
!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.HingeJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var g=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],k=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],h=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],m=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],p=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],q=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],t=e*this.body2.inverseMass+l*this.body1.inverseMass,s=f*this.body2.inverseMass+m*this.body1.inverseMass,u=d*this.body2.inverseMass+n*this.body1.inverseMass;b=Math.sqrt(t*t+s*s+u*u);0<b&&(b=1/b);var t=t*b,s=s*b,u=u*b,y=s*t-u*u,B=-u*s-t*t,I=t*u+s*s;b=1/Math.sqrt(y*y+B*B+I*I);var y=y*b,B=B*b,I=I*b,G=s*I-u*B,C=u*y-t*I,J=t*B-s*y;this.nor.init(t,s,u);this.tan.init(y,B,I);this.bin.init(G,C,J);this.limitMotor.angle=0>t*(k*q-h*r)+s*(h*p-g*q)+u*(g*r-k*p)?-this.acosClamp(g*p+k*r+h*q):this.acosClamp(g*p+
k*r+h*q);b=f*n-d*m;d=d*l-e*n;e=e*m-f*l;this.r3.limitMotor2.angle=y*b+B*d+I*e;this.r3.limitMotor3.angle=G*b+C*d+J*e;this.r3.preSolve(a,c);this.lc.preSolve(a,c)};OIMO.HingeJoint.prototype.solve=function(){this.r3.solve();this.lc.solve()};OIMO.HingeJoint.prototype.postSolve=function(){};OIMO.HingeJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.PrismaticJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_PRISMATIC;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ac=new OIMO.AngularConstraint(this,
(new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.limitMotor=new OIMO.LimitMotor(this.nor,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.PrismaticJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],g=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];b=this.body2.rotation.elements;e=e*this.body2.inverseMass+(this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2])*this.body1.inverseMass;f=f*this.body2.inverseMass+
(this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5])*this.body1.inverseMass;b=g*this.body2.inverseMass+(this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8])*this.body1.inverseMass;d=Math.sqrt(e*e+f*f+b*b);0<d&&(d=1/d);e*=d;f*=d;b*=d;var g=f*e-b*b,k=-b*f-e*e,h=e*b+f*f;d=1/Math.sqrt(g*g+k*k+h*h);g*=d;k*=d;h*=d;d=f*h-b*k;var l=b*g-e*h,m=e*k-f*g;this.nor.init(e,f,b);this.tan.init(g,k,h);this.bin.init(d,l,m);this.ac.preSolve(a,c);this.t3.preSolve(a,c)};
OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve();this.t3.solve()};OIMO.PrismaticJoint.prototype.postSolve=function(){};OIMO.SliderJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_SLIDER;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*
this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*
a[1]+this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,!1);this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0));this.translationalLimitMotor=
new OIMO.LimitMotor(this.nor,!0);this.translationalLimitMotor.lowerLimit=c;this.translationalLimitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.SliderJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var g=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],k=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],h=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],m=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],p=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],q=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],t=e*this.body2.inverseMass+l*this.body1.inverseMass,s=f*this.body2.inverseMass+m*this.body1.inverseMass,u=d*this.body2.inverseMass+n*this.body1.inverseMass;b=Math.sqrt(t*t+s*s+u*u);0<b&&(b=1/b);var t=t*b,s=s*b,u=u*b,y=s*t-u*u,B=-u*s-t*t,I=t*u+s*s;b=1/Math.sqrt(y*y+B*B+I*I);var y=y*b,B=B*b,I=I*b,G=s*I-u*B,C=u*y-t*I,J=t*B-s*y;this.nor.init(t,s,u);this.tan.init(y,B,I);this.bin.init(G,C,J);this.rotationalLimitMotor.angle=0>t*(k*q-h*r)+s*(h*p-g*q)+u*(g*r-k*p)?-this.acosClamp(g*p+k*r+h*q):this.acosClamp(g*
p+k*r+h*q);b=f*n-d*m;d=d*l-e*n;e=e*m-f*l;this.r3.limitMotor2.angle=y*b+B*d+I*e;this.r3.limitMotor3.angle=G*b+C*d+J*e;this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.SliderJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.SliderJoint.prototype.postSolve=function(){};OIMO.SliderJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.WheelJoint=function(a){OIMO.Joint.call(this,a);this.type=this.JOINT_WHEEL;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;
-1<a&&1>a?(this.localAngAxis1X=this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=
a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=a,this.localAngAxis2Y*=a,this.localAngAxis2Z*=a):(this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*
this.localAxis1Y,a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements,this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],
this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8]);this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,!0);this.translationalLimitMotor.frequency=8;this.translationalLimitMotor.dampingRatio=1;this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,!1);this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,!1);this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,
!0),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,!0));this.t3.weight=1;this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)};OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.WheelJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],g=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];d=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2];var k=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],h=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],m=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],p=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5];b=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8];this.r3.limitMotor1.angle=e*l+f*m+g*n;this.rotationalLimitMotor1.angle=0>e*(k*n-h*m)+f*(h*l-d*n)+g*(d*m-k*l)?-this.acosClamp(d*l+k*m+h*n):this.acosClamp(d*l+k*m+h*n);this.rotationalLimitMotor2.angle=0>l*(r*g-b*f)+m*(b*e-p*g)+n*(p*f-r*e)?this.acosClamp(p*e+r*f+b*g):-this.acosClamp(p*e+r*f+b*g);k=m*g-n*f;h=n*e-l*g;p=l*f-m*e;d=Math.sqrt(k*k+h*h+p*p);0<d&&(d=1/d);k*=d;h*=d;p*=d;r=h*n-p*m;n=p*l-k*n;l=k*m-h*l;d=Math.sqrt(r*r+n*n+l*l);0<d&&(d=1/d);r*=d;n*=d;l*=d;m=f*p-g*h;g=g*k-e*p;e=e*h-f*k;d=Math.sqrt(m*
m+g*g+e*e);0<d&&(d=1/d);m*=d;g*=d;e*=d;this.nor.init(k,h,p);this.tan.init(r,n,l);this.bin.init(m,g,e);this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.WheelJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.WheelJoint.prototype.postSolve=function(){};OIMO.WheelJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.AngularConstraint=function(a,c){this.velz=this.vely=this.velx=this.az=this.ay=this.ax=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.joint=a;this.targetOrientation=(new OIMO.Quat).invert(c);this.relativeOrientation=new OIMO.Quat;this.b1=a.body1;this.b2=a.body2;
this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(a,c){var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.i1e00+this.i2e00,d=this.i1e01+this.i2e01,e=this.i1e02+this.i2e02,f=this.i1e10+
this.i2e10,g=this.i1e11+this.i2e11,k=this.i1e12+this.i2e12,h=this.i1e20+this.i2e20,l=this.i1e21+this.i2e21,m=this.i1e22+this.i2e22,n=1/(b*(g*m-l*k)+f*(l*e-d*m)+h*(d*k-g*e));this.d00=(g*m-k*l)*n;this.d01=(e*l-d*m)*n;this.d02=(d*k-e*g)*n;this.d10=(k*h-f*m)*n;this.d11=(b*m-e*h)*n;this.d12=(e*f-b*k)*n;this.d20=(f*l-g*h)*n;this.d21=(d*h-b*l)*n;this.d22=(b*g-d*f)*n;this.relativeOrientation.invert(this.b1.orientation);this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation);this.relativeOrientation.mul(this.b2.orientation,
this.relativeOrientation);n=2*this.relativeOrientation.s;this.velx=this.relativeOrientation.x*n;this.vely=this.relativeOrientation.y*n;this.velz=this.relativeOrientation.z*n;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.02<b?(b=(0.02-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.a1.x+=this.impx*this.i1e00+this.impy*this.i1e01+this.impz*this.i1e02;this.a1.y+=this.impx*this.i1e10+this.impy*this.i1e11+this.impz*this.i1e12;this.a1.z+=
this.impx*this.i1e20+this.impy*this.i1e21+this.impz*this.i1e22;this.a2.x-=this.impx*this.i2e00+this.impy*this.i2e01+this.impz*this.i2e02;this.a2.y-=this.impx*this.i2e10+this.impy*this.i2e11+this.impz*this.i2e12;this.a2.z-=this.impx*this.i2e20+this.impy*this.i2e21+this.impz*this.i2e22},solve:function(){var a=this.a2.x-this.a1.x-this.velx,c=this.a2.y-this.a1.y-this.vely,b=this.a2.z-this.a1.z-this.velz,d=a*this.d00+c*this.d01+b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;
this.impx+=d;this.impy+=e;this.impz+=a;this.a1.x+=d*this.i1e00+e*this.i1e01+a*this.i1e02;this.a1.y+=d*this.i1e10+e*this.i1e11+a*this.i1e12;this.a1.z+=d*this.i1e20+e*this.i1e21+a*this.i1e22;this.a2.x-=d*this.i2e00+e*this.i2e01+a*this.i2e02;this.a2.y-=d*this.i2e10+e*this.i2e11+a*this.i2e12;this.a2.z-=d*this.i2e20+e*this.i2e21+a*this.i2e22}};OIMO.LinearConstraint=function(a){this.velz=this.vely=this.velx=this.vel=this.az2z=this.az2y=this.az2x=this.ay2z=this.ay2y=this.ay2x=this.ax2z=this.ax2y=this.ax2x=this.az1z=this.az1y=this.az1x=this.ay1z=this.ay1y=this.ay1x=this.ax1z=this.ax1y=this.ax1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.joint=a;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.b1=a.body1;this.b2=a.body2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(a,c){this.r1x=this.r1.x;this.r1y=this.r1.y;this.r1z=this.r1.z;this.r2x=this.r2.x;this.r2y=this.r2.y;this.r2z=this.r2.z;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=
d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];this.ax1x=this.r1z*this.i1e01+-this.r1y*this.i1e02;this.ax1y=this.r1z*this.i1e11+-this.r1y*this.i1e12;this.ax1z=this.r1z*this.i1e21+-this.r1y*this.i1e22;this.ay1x=-this.r1z*this.i1e00+this.r1x*this.i1e02;this.ay1y=-this.r1z*this.i1e10+this.r1x*this.i1e12;this.ay1z=-this.r1z*this.i1e20+this.r1x*this.i1e22;this.az1x=this.r1y*this.i1e00+-this.r1x*this.i1e01;this.az1y=this.r1y*this.i1e10+-this.r1x*this.i1e11;this.az1z=
this.r1y*this.i1e20+-this.r1x*this.i1e21;this.ax2x=this.r2z*this.i2e01+-this.r2y*this.i2e02;this.ax2y=this.r2z*this.i2e11+-this.r2y*this.i2e12;this.ax2z=this.r2z*this.i2e21+-this.r2y*this.i2e22;this.ay2x=-this.r2z*this.i2e00+this.r2x*this.i2e02;this.ay2y=-this.r2z*this.i2e10+this.r2x*this.i2e12;this.ay2z=-this.r2z*this.i2e20+this.r2x*this.i2e22;this.az2x=this.r2y*this.i2e00+-this.r2x*this.i2e01;this.az2y=this.r2y*this.i2e10+-this.r2x*this.i2e11;this.az2z=this.r2y*this.i2e20+-this.r2x*this.i2e21;var b=
this.m1+this.m2,e,f,g=b,k,h,l,m=b,b=b+(this.i1e11*this.r1z*this.r1z-(this.i1e21+this.i1e12)*this.r1y*this.r1z+this.i1e22*this.r1y*this.r1y),d=0+((this.i1e20*this.r1y+this.i1e12*this.r1x)*this.r1z-this.i1e10*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);e=0+((this.i1e10*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e20*this.r1y*this.r1y+this.i1e21*this.r1x*this.r1y);f=0+((this.i1e02*this.r1y+this.i1e21*this.r1x)*this.r1z-this.i1e01*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);g+=this.i1e00*this.r1z*
this.r1z-(this.i1e20+this.i1e02)*this.r1x*this.r1z+this.i1e22*this.r1x*this.r1x;k=0+((this.i1e01*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e21*this.r1x*this.r1x+this.i1e20*this.r1x*this.r1y);h=0+((this.i1e01*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e02*this.r1y*this.r1y+this.i1e12*this.r1x*this.r1y);l=0+((this.i1e10*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e12*this.r1x*this.r1x+this.i1e02*this.r1x*this.r1y);m+=this.i1e00*this.r1y*this.r1y-(this.i1e10+this.i1e01)*this.r1x*this.r1y+this.i1e11*
this.r1x*this.r1x;b+=this.i2e11*this.r2z*this.r2z-(this.i2e21+this.i2e12)*this.r2y*this.r2z+this.i2e22*this.r2y*this.r2y;d+=(this.i2e20*this.r2y+this.i2e12*this.r2x)*this.r2z-this.i2e10*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;e+=(this.i2e10*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e20*this.r2y*this.r2y+this.i2e21*this.r2x*this.r2y;f+=(this.i2e02*this.r2y+this.i2e21*this.r2x)*this.r2z-this.i2e01*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;g+=this.i2e00*this.r2z*this.r2z-(this.i2e20+
this.i2e02)*this.r2x*this.r2z+this.i2e22*this.r2x*this.r2x;k+=(this.i2e01*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e21*this.r2x*this.r2x+this.i2e20*this.r2x*this.r2y;h+=(this.i2e01*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e02*this.r2y*this.r2y+this.i2e12*this.r2x*this.r2y;l+=(this.i2e10*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e12*this.r2x*this.r2x+this.i2e02*this.r2x*this.r2y;var m=m+(this.i2e00*this.r2y*this.r2y-(this.i2e10+this.i2e01)*this.r2x*this.r2y+this.i2e11*this.r2x*this.r2x),
n=1/(b*(g*m-l*k)+f*(l*e-d*m)+h*(d*k-g*e));this.d00=(g*m-k*l)*n;this.d01=(e*l-d*m)*n;this.d02=(d*k-e*g)*n;this.d10=(k*h-f*m)*n;this.d11=(b*m-e*h)*n;this.d12=(e*f-b*k)*n;this.d20=(f*l-g*h)*n;this.d21=(d*h-b*l)*n;this.d22=(b*g-d*f)*n;this.velx=this.p2.x-this.p1.x;this.vely=this.p2.y-this.p1.y;this.velz=this.p2.z-this.p1.z;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.005<b?(b=(0.005-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.impx*=
0.95;this.impy*=0.95;this.impz*=0.95;this.l1.x+=this.impx*this.m1;this.l1.y+=this.impy*this.m1;this.l1.z+=this.impz*this.m1;this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x;this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y;this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z;this.l2.x-=this.impx*this.m2;this.l2.y-=this.impy*this.m2;this.l2.z-=this.impz*this.m2;this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x;this.a2.y-=
this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y;this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,d=a*this.d00+c*this.d01+
b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;this.impx+=d;this.impy+=e;this.impz+=a;this.l1.x+=d*this.m1;this.l1.y+=e*this.m1;this.l1.z+=a*this.m1;this.a1.x+=d*this.ax1x+e*this.ay1x+a*this.az1x;this.a1.y+=d*this.ax1y+e*this.ay1y+a*this.az1y;this.a1.z+=d*this.ax1z+e*this.ay1z+a*this.az1z;this.l2.x-=d*this.m2;this.l2.y-=e*this.m2;this.l2.z-=a*this.m2;this.a2.x-=d*this.ax2x+e*this.ay2x+a*this.az2x;this.a2.y-=d*this.ax2y+e*this.ay2y+a*this.az2y;this.a2.z-=d*this.ax2z+
e*this.ay2z+a*this.az2z}};OIMO.Rotational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=this.a1y1=this.a1x1=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=
this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm3=this.cfm2=this.cfm1=NaN;this.limitState1=0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=
this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=
this.motorImpulse1=this.limitImpulse1=0};
OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,f=0<e,g=0<b,k=0<d,h=this.lowerLimit2<=this.upperLimit2,
l=this.lowerLimit3<=this.upperLimit3,m=this.limitMotor1.angle;this.lowerLimit1<=this.upperLimit1?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-m):m<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-m):m>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-m):(this.limitState1=
2,this.limitVelocity1=this.limitImpulse1=0),f||(this.limitVelocity1=0.02<this.limitVelocity1?this.limitVelocity1-0.02:-0.02>this.limitVelocity1?this.limitVelocity1+0.02:0)):(this.limitState1=2,this.limitImpulse1=0);m=this.limitMotor2.angle;h?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-m):m<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-
m):m>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-m):(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),g||(this.limitVelocity2=0.02<this.limitVelocity2?this.limitVelocity2-0.02:-0.02>this.limitVelocity2?this.limitVelocity2+0.02:0)):(this.limitState2=2,this.limitImpulse2=0);h=this.limitMotor3.angle;l?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=
this.lowerLimit3-h):h<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-h):h>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-h):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),k||(this.limitVelocity3=0.02<this.limitVelocity3?this.limitVelocity3-0.02:-0.02>this.limitVelocity3?this.limitVelocity3+0.02:0)):(this.limitState3=2,this.limitImpulse3=0);
this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||f)?this.maxMotorForce1*a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||g)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||k)?this.maxMotorForce3*a:this.motorImpulse3=0;this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02;this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12;this.a1z1=this.ax1*this.i1e20+this.ay1*
this.i1e21+this.az1*this.i1e22;this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02;this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12;this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22;this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02;this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12;this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22;this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+
this.az2*this.i2e02;this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12;this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22;this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02;this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12;this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22;this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02;this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12;
this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22;this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1);this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2);this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3);this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1);this.k11=this.ax2*(this.a1x2+
this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2);this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3);this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1);this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2);this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3);this.kv00=this.k00;this.kv11=
this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;f&&2!=this.limitState1?(f=6.2831853*e,e=f*f*a,f=c/(e+2*this.limitMotor1.dampingRatio*f),this.cfm1=this.kv00*f,this.limitVelocity1=this.limitVelocity1*e*f):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);g&&2!=this.limitState2?(f=6.2831853*b,e=f*f*a,f=c/(e+2*this.limitMotor2.dampingRatio*f),this.cfm2=this.kv11*f,this.limitVelocity2=this.limitVelocity2*e*f):(this.cfm2=0,this.limitVelocity2=0.05*
this.limitVelocity2*c);k&&2!=this.limitState3?(f=6.2831853*d,e=f*f*a,f=c/(e+2*this.limitMotor3.dampingRatio*f),this.cfm3=this.kv22*f,this.limitVelocity3=this.limitVelocity3*e*f):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*b;this.d01=
(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;this.limitImpulse1*=0.95;this.motorImpulse1*=0.95;this.limitImpulse2*=0.95;this.motorImpulse2*=0.95;this.limitImpulse3*=
0.95;this.motorImpulse3*=0.95;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;g=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+d*this.a1x2+g*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+g*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+g*this.a1z3;this.a2.x-=b*this.a2x1+d*this.a2x2+g*this.a2x3;this.a2.y-=b*this.a2y1+d*this.a2y2+g*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+g*this.a2z3},solve_:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=
this.a2.z-this.a1.z;this.limitVelocity3=30;var d=a*this.ax1+c*this.ay1+b*this.az1-this.limitVelocity1,e=a*this.ax2+c*this.ay2+b*this.az2-this.limitVelocity2,b=a*this.ax3+c*this.ay3+b*this.az3-this.limitVelocity3,a=d*this.d00+e*this.d01+b*this.d02,c=d*this.d10+e*this.d11+b*this.d12,d=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=a;this.limitImpulse2+=c;this.limitImpulse3+=d;this.a1.x+=a*this.a1x1+c*this.a1x2+d*this.a1x3;this.a1.y+=a*this.a1y1+c*this.a1y2+d*this.a1y3;this.a1.z+=a*this.a1z1+c*
this.a1z2+d*this.a1z3;this.a2.x-=a*this.a2x1+c*this.a2x2+d*this.a2x3;this.a2.y-=a*this.a2y1+c*this.a2y2+d*this.a2y3;this.a2.z-=a*this.a2z1+c*this.a2z2+d*this.a2z3},solve:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=this.a2.z-this.a1.z,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,f=this.motorImpulse1,g=this.motorImpulse2,k=this.motorImpulse3,h=0,a=c=0;this.enableMotor1&&(h=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=
h,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),h=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-g);this.enableMotor3&&(a=(b-this.motorSpeed3)*
this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-k);var d=d+(h*this.kv00+c*this.k01+a*this.k02),e=e+(h*this.k10+c*this.kv11+a*this.k12),b=b+(h*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*
this.cfm3),k=this.limitImpulse1,l=this.limitImpulse2,m=this.limitImpulse3,n=d*this.d00+e*this.d01+b*this.d02,g=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=n;this.limitImpulse2+=g;this.limitImpulse3+=f;var p=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)n=-k,e+=n*this.k10,b+=n*this.k20,p|=1;if(2==this.limitState2||0>this.limitImpulse2*this.limitState2)g=-l,d+=g*this.k01,b+=g*this.k21,p|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=
-m,d+=f*this.k02,e+=f*this.k12,p|=4;switch(p){case 1:p=1/(this.k11*this.k22-this.k12*this.k21);g=(this.k22*e+-this.k12*b)*p;f=(-this.k21*e+this.k11*b)*p;break;case 2:p=1/(this.k00*this.k22-this.k02*this.k20);n=(this.k22*d+-this.k02*b)*p;f=(-this.k20*d+this.k00*b)*p;break;case 3:f=b/this.k22;break;case 4:p=1/(this.k00*this.k11-this.k01*this.k10);n=(this.k11*d+-this.k01*e)*p;g=(-this.k10*d+this.k00*e)*p;break;case 5:g=e/this.k11;break;case 6:n=d/this.k00}this.limitImpulse1=n+k;this.limitImpulse2=g+
l;this.limitImpulse3=f+m;d=h+n;e=c+g;a+=f;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.RotationalConstraint=function(a,c){this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm=NaN;this.enableLimit=!1;this.limitVelocity=this.upperLimit=this.lowerLimit=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=
this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=
b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.limitMotor.frequency,d=0<b,e=this.limitMotor.angle;this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=
-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.02<this.limitVelocity?this.limitVelocity-0.02:-0.02>this.limitVelocity?this.limitVelocity+0.02:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=
0;this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02;this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12;this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22;this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02;this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12;this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22;this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z);this.invMotorDenom=
1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);this.limitImpulse*=0.95;this.motorImpulse*=0.95;b=this.limitImpulse+this.motorImpulse;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=
this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z),c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,
this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Translational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.l2z3=this.l2y3=this.l2x3=this.l1z3=this.l1y3=this.l1x3=this.t2z3=this.t2y3=this.t2x3=this.t1z3=this.t1y3=this.t1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.l2z2=this.l2y2=this.l2x2=this.l1z2=this.l1y2=this.l1x2=this.t2z2=this.t2y2=this.t2x2=this.t1z2=this.t1y2=this.t1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=
this.a1y1=this.a1x1=this.l2z1=this.l2y1=this.l2x1=this.l1z1=this.l1y1=this.l1x1=this.t2z1=this.t2y1=this.t2x1=this.t1z1=this.t1y1=this.t1x1=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.limitState1=
0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=
this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;
this.cfm3=this.cfm2=this.cfm1=this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=this.motorImpulse1=this.limitImpulse1=0;this.weight=-1};
OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p2.x-this.p1.x,d=this.p2.y-this.p1.y,e=this.p2.z-this.p1.z,f=b*this.ax1+
d*this.ay1+e*this.az1,g=b*this.ax2+d*this.ay2+e*this.az2,k=b*this.ax3+d*this.ay3+e*this.az3,h=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,l=0<h,e=0<b,m=0<d,n=this.lowerLimit1<=this.upperLimit1,p=this.lowerLimit2<=this.upperLimit2,r=this.lowerLimit3<=this.upperLimit3;if(l&&20<f||-20>f)l=!1;if(e&&20<g||-20>g)e=!1;if(m&&20<k||-20>k)m=!1;n?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-
f,l||(f=this.lowerLimit1)):f<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-f,l||(f=this.lowerLimit1)):f>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-f,l||(f=this.upperLimit1)):(this.limitState1=2,this.limitVelocity1=this.limitImpulse1=0),l||(this.limitVelocity1=0.005<this.limitVelocity1?this.limitVelocity1-0.005:-0.005>this.limitVelocity1?this.limitVelocity1+
0.005:0)):(this.limitState1=2,this.limitImpulse1=0);p?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-g,e||(g=this.lowerLimit2)):g<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-g,e||(g=this.lowerLimit2)):g>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-g,e||(g=this.upperLimit2)):
(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),e||(this.limitVelocity2=0.005<this.limitVelocity2?this.limitVelocity2-0.005:-0.005>this.limitVelocity2?this.limitVelocity2+0.005:0)):(this.limitState2=2,this.limitImpulse2=0);r?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=this.lowerLimit3-k,m||(k=this.lowerLimit3)):k<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=
this.lowerLimit3-k,m||(k=this.lowerLimit3)):k>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-k,m||(k=this.upperLimit3)):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),m||(this.limitVelocity3=0.005<this.limitVelocity3?this.limitVelocity3-0.005:-0.005>this.limitVelocity3?this.limitVelocity3+0.005:0)):(this.limitState3=2,this.limitImpulse3=0);this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||l)?this.maxMotorForce1*
a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||e)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||m)?this.maxMotorForce3*a:this.motorImpulse3=0;n=f*this.ax1+g*this.ax2+k*this.ax2;p=f*this.ay1+g*this.ay2+k*this.ay2;f=f*this.az1+g*this.az2+k*this.az2;g=this.m2/(this.m1+this.m2);0<=this.weight&&(g=this.weight);k=1-g;this.r1x=this.r1.x+n*g;this.r1y=this.r1.y+p*g;this.r1z=this.r1.z+f*g;this.r2x=this.r2.x-n*
k;this.r2y=this.r2.y-p*k;this.r2z=this.r2.z-f*k;this.t1x1=this.r1y*this.az1-this.r1z*this.ay1;this.t1y1=this.r1z*this.ax1-this.r1x*this.az1;this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1;this.t2x1=this.r2y*this.az1-this.r2z*this.ay1;this.t2y1=this.r2z*this.ax1-this.r2x*this.az1;this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1;this.l1x1=this.ax1*this.m1;this.l1y1=this.ay1*this.m1;this.l1z1=this.az1*this.m1;this.l2x1=this.ax1*this.m2;this.l2y1=this.ay1*this.m2;this.l2z1=this.az1*this.m2;this.a1x1=this.t1x1*
this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02;this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12;this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22;this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02;this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12;this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22;this.t1x2=this.r1y*this.az2-this.r1z*this.ay2;this.t1y2=this.r1z*this.ax2-this.r1x*
this.az2;this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2;this.t2x2=this.r2y*this.az2-this.r2z*this.ay2;this.t2y2=this.r2z*this.ax2-this.r2x*this.az2;this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2;this.l1x2=this.ax2*this.m1;this.l1y2=this.ay2*this.m1;this.l1z2=this.az2*this.m1;this.l2x2=this.ax2*this.m2;this.l2y2=this.ay2*this.m2;this.l2z2=this.az2*this.m2;this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02;this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12;
this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22;this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02;this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12;this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22;this.t1x3=this.r1y*this.az3-this.r1z*this.ay3;this.t1y3=this.r1z*this.ax3-this.r1x*this.az3;this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3;this.t2x3=this.r2y*this.az3-this.r2z*this.ay3;this.t2y3=this.r2z*this.ax3-
this.r2x*this.az3;this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3;this.l1x3=this.ax3*this.m1;this.l1y3=this.ay3*this.m1;this.l1z3=this.az3*this.m1;this.l2x3=this.ax3*this.m2;this.l2y3=this.ay3*this.m2;this.l2z3=this.az3*this.m2;this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02;this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12;this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22;this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*
this.i2e02;this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12;this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;f=this.m1+this.m2;this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*f;this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*f;this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*f;this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*f;this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*
f;this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*f;this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*f;this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*f;this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*f;this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1;this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2;this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3;this.k10+=this.t1x2*this.a1x1+
this.t1y2*this.a1y1+this.t1z2*this.a1z1;this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2;this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3;this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1;this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2;this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3;this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1;this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+
this.t2z1*this.a2z2;this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3;this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1;this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2;this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3;this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1;this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2;this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3;
this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;l&&2!=this.limitState1?(l=6.2831853*h,h=l*l*a,l=c/(h+2*this.limitMotor1.dampingRatio*l),this.cfm1=this.kv00*l,this.limitVelocity1=this.limitVelocity1*h*l):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);e&&2!=this.limitState2?(l=6.2831853*b,h=l*l*a,l=c/(h+2*this.limitMotor2.dampingRatio*l),this.cfm2=this.kv11*l,this.limitVelocity2=this.limitVelocity2*h*l):(this.cfm2=
0,this.limitVelocity2=0.05*this.limitVelocity2*c);m&&2!=this.limitState3?(l=6.2831853*d,h=l*l*a,l=c/(h+2*this.limitMotor3.dampingRatio*l),this.cfm3=this.kv22*l,this.limitVelocity3=this.limitVelocity3*h*l):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-
this.k12*this.k21)*b;this.d01=(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;e=this.limitImpulse3+
this.motorImpulse3;this.l1.x+=b*this.l1x1+d*this.l1x2+e*this.l1x3;this.l1.y+=b*this.l1y1+d*this.l1y2+e*this.l1y3;this.l1.z+=b*this.l1z1+d*this.l1z2+e*this.l1z3;this.a1.x+=b*this.a1x1+d*this.a1x2+e*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+e*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+e*this.a1z3;this.l2.x-=b*this.l2x1+d*this.l2x2+e*this.l2x3;this.l2.y-=b*this.l2y1+d*this.l2y2+e*this.l2y3;this.l2.z-=b*this.l2z1+d*this.l2z2+e*this.l2z3;this.a2.x-=b*this.a2x1+d*this.a2x2+e*this.a2x3;this.a2.y-=b*
this.a2y1+d*this.a2y2+e*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+e*this.a2z3},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,
f=this.motorImpulse1,g=this.motorImpulse2,k=this.motorImpulse3,h=0,a=c=0;this.enableMotor1&&(h=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=h,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),h=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<
-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-g);this.enableMotor3&&(a=(b-this.motorSpeed3)*this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-k);var d=d+(h*this.kv00+c*this.k01+a*this.k02),e=e+(h*this.k10+c*this.kv11+a*this.k12),b=b+(h*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+
this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*this.cfm3),k=this.limitImpulse1,l=this.limitImpulse2,m=this.limitImpulse3,n=d*this.d00+e*this.d01+b*this.d02,g=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=n;this.limitImpulse2+=g;this.limitImpulse3+=f;var p=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)n=-k,e+=n*this.k10,b+=n*this.k20,p|=1;if(2==this.limitState2||
0>this.limitImpulse2*this.limitState2)g=-l,d+=g*this.k01,b+=g*this.k21,p|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=-m,d+=f*this.k02,e+=f*this.k12,p|=4;switch(p){case 1:p=1/(this.k11*this.k22-this.k12*this.k21);g=(this.k22*e+-this.k12*b)*p;f=(-this.k21*e+this.k11*b)*p;break;case 2:p=1/(this.k00*this.k22-this.k02*this.k20);n=(this.k22*d+-this.k02*b)*p;f=(-this.k20*d+this.k00*b)*p;break;case 3:f=b/this.k22;break;case 4:p=1/(this.k00*this.k11-this.k01*this.k10);n=(this.k11*d+
-this.k01*e)*p;g=(-this.k10*d+this.k00*e)*p;break;case 5:g=e/this.k11;break;case 6:n=d/this.k00}this.limitImpulse1=k+n;this.limitImpulse2=l+g;this.limitImpulse3=m+f;d=h+n;e=c+g;a+=f;this.l1.x+=d*this.l1x1+e*this.l1x2+a*this.l1x3;this.l1.y+=d*this.l1y1+e*this.l1y2+a*this.l1y3;this.l1.z+=d*this.l1z1+e*this.l1z2+a*this.l1z3;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.l2.x-=d*this.l2x1+e*this.l2x2+a*
this.l2x3;this.l2.y-=d*this.l2y1+e*this.l2y2+a*this.l2y3;this.l2.z-=d*this.l2z1+e*this.l2z2+a*this.l2z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.TranslationalConstraint=function(a,c){this.limitVelocity=this.upperLimit=this.lowerLimit=this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.l2z=this.l2y=this.l2x=this.l1z=this.l1y=this.l1x=this.t2z=this.t2y=this.t2x=this.t1z=this.t1y=this.t1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=this.cfm=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;
this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;
this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=(this.p2.x-this.p1.x)*this.ax+(this.p2.y-this.p1.y)*this.ay+(this.p2.z-this.p1.z)*this.az,b=this.limitMotor.frequency,d=0<b,f=this.lowerLimit<=this.upperLimit;if(d&&20<e||-20>e)d=!1;f?(this.lowerLimit==this.upperLimit?
(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e,d||(e=this.upperLimit)):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.005<this.limitVelocity?
this.limitVelocity-0.005:-0.005>this.limitVelocity?this.limitVelocity+0.005:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=0;var f=e*this.ax,g=e*this.ay,e=e*this.az,k=this.m1/(this.m1+this.m2),h=1-k;this.r1x=this.r1.x+f*k;this.r1y=this.r1.y+g*k;this.r1z=this.r1.z+e*k;this.r2x=this.r2.x-f*h;this.r2y=this.r2.y-g*h;this.r2z=this.r2.z-e*h;this.t1x=this.r1y*this.az-this.r1z*this.ay;this.t1y=this.r1z*this.ax-
this.r1x*this.az;this.t1z=this.r1x*this.ay-this.r1y*this.ax;this.t2x=this.r2y*this.az-this.r2z*this.ay;this.t2y=this.r2z*this.ax-this.r2x*this.az;this.t2z=this.r2x*this.ay-this.r2y*this.ax;this.l1x=this.ax*this.m1;this.l1y=this.ay*this.m1;this.l1z=this.az*this.m1;this.l2x=this.ax*this.m2;this.l2y=this.ay*this.m2;this.l2z=this.az*this.m2;this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02;this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12;this.a1z=this.t1x*this.i1e20+
this.t1y*this.i1e21+this.t1z*this.i1e22;this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02;this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12;this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22;this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-
this.a2y*this.r2x);this.invMotorDenom=1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);b=this.limitImpulse+this.motorImpulse;this.l1.x+=b*this.l1x;this.l1.y+=b*this.l1y;this.l1.z+=b*this.l1z;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.l2.x-=b*this.l2x;
this.l2.y-=b*this.l2y;this.l2.z-=b*this.l2z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z,c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=
this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.l1.x+=c*this.l1x;this.l1.y+=c*this.l1y;this.l1.z+=c*this.l1z;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;
this.l2.x-=c*this.l2x;this.l2.y-=c*this.l2y;this.l2.z-=c*this.l2z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Contact=function(){this.next=this.prev=this.body2=this.body1=this.shape2=this.shape1=null;this.sleeping=this.persisting=!1;this.constraint=this.detector=null;this.touching=!1;this.b1Link=new OIMO.ContactLink(this);this.b2Link=new OIMO.ContactLink(this);this.s1Link=new OIMO.ContactLink(this);this.s2Link=new OIMO.ContactLink(this);this.manifold=new OIMO.ContactManifold;this.buffer=[];this.buffer.length=4;this.buffer[0]=new OIMO.ImpulseDataBuffer;this.buffer[1]=new OIMO.ImpulseDataBuffer;this.buffer[2]=
new OIMO.ImpulseDataBuffer;this.buffer[3]=new OIMO.ImpulseDataBuffer;this.points=this.manifold.points;this.constraint=new OIMO.ContactConstraint(this.manifold)};
OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(a,c){return Math.sqrt(a*c)},mixFriction:function(a,c){return Math.sqrt(a*c)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution);this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var a=this.manifold.numPoints,c=a;c--;){var b=this.buffer[c],d=this.points[c];b.lp1X=d.localPoint1.x;b.lp1Y=d.localPoint1.y;b.lp1Z=d.localPoint1.z;
b.lp2X=d.localPoint2.x;b.lp2Y=d.localPoint2.y;b.lp2Z=d.localPoint2.z;b.impulse=d.normalImpulse}this.manifold.numPoints=0;this.detector.detectCollision(this.shape1,this.shape2,this.manifold);c=this.manifold.numPoints;if(0==c)this.touching=!1;else for(this.touching=!0;c--;){for(var d=this.points[c],e=d.localPoint1.x,f=d.localPoint1.y,g=d.localPoint1.z,k=d.localPoint2.x,h=d.localPoint2.y,l=d.localPoint2.z,m=-1,n=4E-4,p=a;p--;){var b=this.buffer[p],r=b.lp1X-e,q=b.lp1Y-f,t=b.lp1Z-g,s=r*r+q*q+t*t,r=b.lp2X-
k,q=b.lp2Y-h,t=b.lp2Z-l,b=r*r+q*q+t*t;s<b?s<n&&(n=s,m=p):b<n&&(n=b,m=p)}-1!=m?(e=this.buffer[m],this.buffer[m]=this.buffer[--a],this.buffer[a]=e,d.normalImpulse=e.impulse,d.warmStarted=!0):(d.normalImpulse=0,d.warmStarted=!1)}},attach:function(a,c){this.shape1=a;this.shape2=c;this.body1=a.parent;this.body2=c.parent;this.manifold.body1=this.body1;this.manifold.body2=this.body2;this.constraint.body1=this.body1;this.constraint.body2=this.body2;this.constraint.attach();this.s1Link.shape=c;this.s1Link.body=
this.body2;this.s2Link.shape=a;this.s2Link.body=this.body1;null!=a.contactLink?(this.s1Link.next=a.contactLink).prev=this.s1Link:this.s1Link.next=null;a.contactLink=this.s1Link;a.numContacts++;null!=c.contactLink?(this.s2Link.next=c.contactLink).prev=this.s2Link:this.s2Link.next=null;c.contactLink=this.s2Link;c.numContacts++;this.b1Link.shape=c;this.b1Link.body=this.body2;this.b2Link.shape=a;this.b2Link.body=this.body1;null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:
this.b1Link.next=null;this.body1.contactLink=this.b1Link;this.body1.numContacts++;null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null;this.body2.contactLink=this.b2Link;this.body2.numContacts++;this.next=this.prev=null;this.persisting=!0;this.sleeping=this.body1.sleeping&&this.body2.sleeping;this.manifold.numPoints=0},detach:function(){var a=this.s1Link.prev,c=this.s1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape1.contactLink==
this.s1Link&&(this.shape1.contactLink=c);this.s1Link.prev=null;this.s1Link.next=null;this.s1Link.shape=null;this.s1Link.body=null;this.shape1.numContacts--;a=this.s2Link.prev;c=this.s2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=c);this.s2Link.prev=null;this.s2Link.next=null;this.s2Link.shape=null;this.s2Link.body=null;this.shape2.numContacts--;a=this.b1Link.prev;c=this.b1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body1.contactLink==
this.b1Link&&(this.body1.contactLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.shape=null;this.b1Link.body=null;this.body1.numContacts--;a=this.b2Link.prev;c=this.b2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body2.contactLink==this.b2Link&&(this.body2.contactLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.shape=null;this.b2Link.body=null;this.body2.numContacts--;this.manifold.body1=null;this.manifold.body2=null;this.constraint.body1=null;this.constraint.body2=
null;this.constraint.detach();this.body2=this.body1=this.shape2=this.shape1=null}};OIMO.ContactConstraint=function(a){OIMO.Constraint.call(this);this.manifold=a;this.friction=this.restitution=NaN;this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null;this.m2=this.m1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.num=0;this.ps=a.points;this.cs=new OIMO.ContactPointDataBuffer;this.cs.next=new OIMO.ContactPointDataBuffer;
this.cs.next.next=new OIMO.ContactPointDataBuffer;this.cs.next.next.next=new OIMO.ContactPointDataBuffer};OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position;this.p2=this.body2.position;this.lv1=this.body1.linearVelocity;this.av1=this.body1.angularVelocity;this.lv2=this.body2.linearVelocity;this.av2=this.body2.angularVelocity;this.i1=this.body1.inverseInertia;this.i2=this.body2.inverseInertia};
OIMO.ContactConstraint.prototype.detach=function(){this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null};
OIMO.ContactConstraint.prototype.preSolve=function(a,c){this.m1=this.body1.inverseMass;this.m2=this.body2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p1.x,d=this.p1.y,e=this.p1.z,f=this.p2.x,g=
this.p2.y,k=this.p2.z,h=this.m1+this.m2;this.num=this.manifold.numPoints;for(var l=this.cs,m=0;m<this.num;m++){var n=this.ps[m],p,r,q,t,s,u;p=n.position.x;r=n.position.y;q=n.position.z;var y=p-b,B=r-d,I=q-e,G=p-f,C=r-g,J=q-k;l.rp1X=y;l.rp1Y=B;l.rp1Z=I;l.rp2X=G;l.rp2Y=C;l.rp2Z=J;l.norImp=n.normalImpulse;l.tanImp=n.tangentImpulse;l.binImp=n.binormalImpulse;var K=n.normal.x,x=n.normal.y,F=n.normal.z,v=this.lv2.x+this.av2.y*J-this.av2.z*C-(this.lv1.x+this.av1.y*I-this.av1.z*B),M=this.lv2.y+this.av2.z*
G-this.av2.x*J-(this.lv1.y+this.av1.z*y-this.av1.x*I),P=this.lv2.z+this.av2.x*C-this.av2.y*G-(this.lv1.z+this.av1.x*B-this.av1.y*y),L=K*v+x*M+F*P,v=v-L*K,Q=M-L*x,T=P-L*F,P=v*v+Q*Q+T*T;0.04<P?P=1/Math.sqrt(P):(v=x*K-F*F,Q=-F*x-K*K,T=K*F+x*x,P=1/Math.sqrt(v*v+Q*Q+T*T));var v=v*P,Q=Q*P,T=T*P,N=x*T-F*Q,O=F*v-K*T,U=K*Q-x*v;l.norX=K;l.norY=x;l.norZ=F;l.tanX=v;l.tanY=Q;l.tanZ=T;l.binX=N;l.binY=O;l.binZ=U;l.norU1X=K*this.m1;l.norU1Y=x*this.m1;l.norU1Z=F*this.m1;l.norU2X=K*this.m2;l.norU2Y=x*this.m2;l.norU2Z=
F*this.m2;l.tanU1X=v*this.m1;l.tanU1Y=Q*this.m1;l.tanU1Z=T*this.m1;l.tanU2X=v*this.m2;l.tanU2Y=Q*this.m2;l.tanU2Z=T*this.m2;l.binU1X=N*this.m1;l.binU1Y=O*this.m1;l.binU1Z=U*this.m1;l.binU2X=N*this.m2;l.binU2Y=O*this.m2;l.binU2Z=U*this.m2;q=B*F-I*x;t=I*K-y*F;s=y*x-B*K;var V=C*F-J*x,Ya=J*K-G*F,Ca=G*x-C*K,Da=B*T-I*Q,Ea=I*v-y*T,Ka=y*Q-B*v,La=C*T-J*Q,X=J*v-G*T,D=G*Q-C*v,E=B*U-I*O,R=I*N-y*U,Y=y*O-B*N,Z=C*U-J*O,ha=J*N-G*U,da=G*O-C*N,P=q*this.i1e00+t*this.i1e01+s*this.i1e02,M=q*this.i1e10+t*this.i1e11+s*
this.i1e12,pa=q*this.i1e20+t*this.i1e21+s*this.i1e22,qa=V*this.i2e00+Ya*this.i2e01+Ca*this.i2e02,ea=V*this.i2e10+Ya*this.i2e11+Ca*this.i2e12,fa=V*this.i2e20+Ya*this.i2e21+Ca*this.i2e22;p=Da*this.i1e00+Ea*this.i1e01+Ka*this.i1e02;r=Da*this.i1e10+Ea*this.i1e11+Ka*this.i1e12;u=Da*this.i1e20+Ea*this.i1e21+Ka*this.i1e22;var W=La*this.i2e00+X*this.i2e01+D*this.i2e02,$=La*this.i2e10+X*this.i2e11+D*this.i2e12,sa=La*this.i2e20+X*this.i2e21+D*this.i2e22,ta=E*this.i1e00+R*this.i1e01+Y*this.i1e02,ya=E*this.i1e10+
R*this.i1e11+Y*this.i1e12,za=E*this.i1e20+R*this.i1e21+Y*this.i1e22,Aa=Z*this.i2e00+ha*this.i2e01+da*this.i2e02,yb=Z*this.i2e10+ha*this.i2e11+da*this.i2e12,Nb=Z*this.i2e20+ha*this.i2e21+da*this.i2e22;l.norT1X=q;l.norT1Y=t;l.norT1Z=s;l.tanT1X=Da;l.tanT1Y=Ea;l.tanT1Z=Ka;l.binT1X=E;l.binT1Y=R;l.binT1Z=Y;l.norT2X=V;l.norT2Y=Ya;l.norT2Z=Ca;l.tanT2X=La;l.tanT2Y=X;l.tanT2Z=D;l.binT2X=Z;l.binT2Y=ha;l.binT2Z=da;l.norTU1X=P;l.norTU1Y=M;l.norTU1Z=pa;l.tanTU1X=p;l.tanTU1Y=r;l.tanTU1Z=u;l.binTU1X=ta;l.binTU1Y=
ya;l.binTU1Z=za;l.norTU2X=qa;l.norTU2Y=ea;l.norTU2Z=fa;l.tanTU2X=W;l.tanTU2Y=$;l.tanTU2Z=sa;l.binTU2X=Aa;l.binTU2Y=yb;l.binTU2Z=Nb;p=q*this.i1e00+t*this.i1e01+s*this.i1e02;r=q*this.i1e10+t*this.i1e11+s*this.i1e12;q=q*this.i1e20+t*this.i1e21+s*this.i1e22;t=r*I-q*B;s=q*y-p*I;u=p*B-r*y;p=V*this.i2e00+Ya*this.i2e01+Ca*this.i2e02;r=V*this.i2e10+Ya*this.i2e11+Ca*this.i2e12;q=V*this.i2e20+Ya*this.i2e21+Ca*this.i2e22;t+=r*J-q*C;s+=q*G-p*J;u+=p*C-r*G;K=1/(h+K*t+x*s+F*u);p=Da*this.i1e00+Ea*this.i1e01+Ka*this.i1e02;
r=Da*this.i1e10+Ea*this.i1e11+Ka*this.i1e12;q=Da*this.i1e20+Ea*this.i1e21+Ka*this.i1e22;t=r*I-q*B;s=q*y-p*I;u=p*B-r*y;p=La*this.i2e00+X*this.i2e01+D*this.i2e02;r=La*this.i2e10+X*this.i2e11+D*this.i2e12;q=La*this.i2e20+X*this.i2e21+D*this.i2e22;t+=r*J-q*C;s+=q*G-p*J;u+=p*C-r*G;x=1/(h+v*t+Q*s+T*u);p=E*this.i1e00+R*this.i1e01+Y*this.i1e02;r=E*this.i1e10+R*this.i1e11+Y*this.i1e12;q=E*this.i1e20+R*this.i1e21+Y*this.i1e22;t=r*I-q*B;s=q*y-p*I;u=p*B-r*y;p=Z*this.i2e00+ha*this.i2e01+da*this.i2e02;r=Z*this.i2e10+
ha*this.i2e11+da*this.i2e12;q=Z*this.i2e20+ha*this.i2e21+da*this.i2e22;t+=r*J-q*C;s+=q*G-p*J;u+=p*C-r*G;y=1/(h+N*t+O*s+U*u);l.norDen=K;l.tanDen=x;l.binDen=y;n.warmStarted?(L=n.normalImpulse,this.lv1.x+=l.norU1X*L,this.lv1.y+=l.norU1Y*L,this.lv1.z+=l.norU1Z*L,this.av1.x+=P*L,this.av1.y+=M*L,this.av1.z+=pa*L,this.lv2.x-=l.norU2X*L,this.lv2.y-=l.norU2Y*L,this.lv2.z-=l.norU2Z*L,this.av2.x-=qa*L,this.av2.y-=ea*L,this.av2.z-=fa*L,l.norImp=L,l.tanImp=0,L=l.binImp=0):(l.norImp=0,l.tanImp=0,l.binImp=0);-1<
L&&(L=0);L=this.restitution*-L;n=-(n.penetration+0.005)*c*0.05;L<n&&(L=n);l.norTar=L;l.last=m==this.num-1;l=l.next}};
OIMO.ContactConstraint.prototype.solve=function(){for(var a=this.lv1.x,c=this.lv1.y,b=this.lv1.z,d=this.lv2.x,e=this.lv2.y,f=this.lv2.z,g=this.av1.x,k=this.av1.y,h=this.av1.z,l=this.av2.x,m=this.av2.y,n=this.av2.z,p=this.cs;;){var r,q,t,s,u=p.norImp,y=p.tanImp,B=p.binImp,I=-u*this.friction;t=d-a;s=e-c;var G=f-b;q=t*p.tanX+s*p.tanY+G*p.tanZ+l*p.tanT2X+m*p.tanT2Y+n*p.tanT2Z-g*p.tanT1X-k*p.tanT1Y-h*p.tanT1Z;r=y;q*=p.tanDen;y+=q;q=t*p.binX+s*p.binY+G*p.binZ+l*p.binT2X+m*p.binT2Y+n*p.binT2Z-g*p.binT1X-
k*p.binT1Y-h*p.binT1Z;t=B;s=q*p.binDen;B+=s;q=y*y+B*B;q>I*I&&(q=I/Math.sqrt(q),y*=q,B*=q);q=y-r;s=B-t;a+=p.tanU1X*q+p.binU1X*s;c+=p.tanU1Y*q+p.binU1Y*s;b+=p.tanU1Z*q+p.binU1Z*s;g+=p.tanTU1X*q+p.binTU1X*s;k+=p.tanTU1Y*q+p.binTU1Y*s;h+=p.tanTU1Z*q+p.binTU1Z*s;d-=p.tanU2X*q+p.binU2X*s;e-=p.tanU2Y*q+p.binU2Y*s;f-=p.tanU2Z*q+p.binU2Z*s;l-=p.tanTU2X*q+p.binTU2X*s;m-=p.tanTU2Y*q+p.binTU2Y*s;n-=p.tanTU2Z*q+p.binTU2Z*s;q=(d-a)*p.norX+(e-c)*p.norY+(f-b)*p.norZ+l*p.norT2X+m*p.norT2Y+n*p.norT2Z-g*p.norT1X-k*
p.norT1Y-h*p.norT1Z;r=u;q=(q-p.norTar)*p.norDen;u+=q;0<u&&(u=0);q=u-r;a+=p.norU1X*q;c+=p.norU1Y*q;b+=p.norU1Z*q;g+=p.norTU1X*q;k+=p.norTU1Y*q;h+=p.norTU1Z*q;d-=p.norU2X*q;e-=p.norU2Y*q;f-=p.norU2Z*q;l-=p.norTU2X*q;m-=p.norTU2Y*q;n-=p.norTU2Z*q;p.norImp=u;p.tanImp=y;p.binImp=B;if(p.last)break;p=p.next}this.lv1.x=a;this.lv1.y=c;this.lv1.z=b;this.lv2.x=d;this.lv2.y=e;this.lv2.z=f;this.av1.x=g;this.av1.y=k;this.av1.z=h;this.av2.x=l;this.av2.y=m;this.av2.z=n};
OIMO.ContactConstraint.prototype.postSolve=function(){for(var a=this.cs,c=this.num;c--;){var b=this.ps[c];b.normal.x=a.norX;b.normal.y=a.norY;b.normal.z=a.norZ;b.tangent.x=a.tanX;b.tangent.y=a.tanY;b.tangent.z=a.tanZ;b.binormal.x=a.binX;b.binormal.y=a.binY;b.binormal.z=a.binZ;b.normalImpulse=a.norImp;b.tangentImpulse=a.tanImp;b.binormalImpulse=a.binImp;b.normalDenominator=a.norDen;b.tangentDenominator=a.tanDen;b.binormalDenominator=a.binDen;a=a.next}};OIMO.ContactLink=function(a){this.body=this.shape=this.next=this.prev=null;this.contact=a};OIMO.ContactManifold=function(){this.body2=this.body1=null;this.numPoints=0;this.points=[];this.points.length=4;this.points[0]=new OIMO.ManifoldPoint;this.points[1]=new OIMO.ManifoldPoint;this.points[2]=new OIMO.ManifoldPoint;this.points[3]=new OIMO.ManifoldPoint};
OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(a,c){this.body1=a.parent;this.body2=c.parent;this.numPoints=0},addPoint:function(a,c,b,d,e,f,g,k){var h=this.points[this.numPoints++];h.position.x=a;h.position.y=c;h.position.z=b;var l=a-this.body1.position.x,m=c-this.body1.position.y,n=b-this.body1.position.z,p=this.body1.rotation.elements;h.localPoint1.x=l*p[0]+m*p[3]+n*p[6];h.localPoint1.y=l*p[1]+m*p[4]+n*p[7];h.localPoint1.z=l*p[2]+m*p[5]+n*p[8];l=a-this.body2.position.x;
m=c-this.body2.position.y;n=b-this.body2.position.z;h.localPoint2.x=l*p[0]+m*p[3]+n*p[6];h.localPoint2.y=l*p[1]+m*p[4]+n*p[7];h.localPoint2.z=l*p[2]+m*p[5]+n*p[8];h.normalImpulse=0;k?(h.normal.x=-d,h.normal.y=-e,h.normal.z=-f):(h.normal.x=d,h.normal.y=e,h.normal.z=f);h.penetration=g;h.warmStarted=!1}};OIMO.ContactPointDataBuffer=function(){this.norTar=this.binDen=this.tanDen=this.norDen=this.binImp=this.tanImp=this.norImp=this.binTU2Z=this.binTU2Y=this.binTU2X=this.binTU1Z=this.binTU1Y=this.binTU1X=this.tanTU2Z=this.tanTU2Y=this.tanTU2X=this.tanTU1Z=this.tanTU1Y=this.tanTU1X=this.norTU2Z=this.norTU2Y=this.norTU2X=this.norTU1Z=this.norTU1Y=this.norTU1X=this.binT2Z=this.binT2Y=this.binT2X=this.binT1Z=this.binT1Y=this.binT1X=this.tanT2Z=this.tanT2Y=this.tanT2X=this.tanT1Z=this.tanT1Y=this.tanT1X=
this.norT2Z=this.norT2Y=this.norT2X=this.norT1Z=this.norT1Y=this.norT1X=this.binU2Z=this.binU2Y=this.binU2X=this.binU1Z=this.binU1Y=this.binU1X=this.tanU2Z=this.tanU2Y=this.tanU2X=this.tanU1Z=this.tanU1Y=this.tanU1X=this.norU2Z=this.norU2Y=this.norU2X=this.norU1Z=this.norU1Y=this.norU1X=this.rp2Z=this.rp2Y=this.rp2X=this.rp1Z=this.rp1Y=this.rp1X=this.binZ=this.binY=this.binX=this.tanZ=this.tanY=this.tanX=this.norZ=this.norY=this.norX=NaN;this.next=null;this.last=!1};OIMO.ImpulseDataBuffer=function(){this.impulse=this.lp2Z=this.lp2Y=this.lp2X=this.lp1Z=this.lp1Y=this.lp1X=NaN};OIMO.ManifoldPoint=function(){this.warmStarted=!1;this.position=new OIMO.Vec3;this.localPoint1=new OIMO.Vec3;this.localPoint2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.penetration=this.binormalDenominator=this.tangentDenominator=this.normalDenominator=this.binormalImpulse=this.tangentImpulse=this.normalImpulse=0};OIMO.MassInfo=function(){this.mass=0;this.inertia=new OIMO.Mat33};OIMO.Shape=function(a){this.id=OIMO.nextID++;this.next=this.prev=null;this.type=0;this.contactLink=this.parent=this.proxy=null;this.numContacts=0;this.position=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.relativePosition=(new OIMO.Vec3).copy(a.relativePosition);this.relativeRotation=(new OIMO.Mat33).copy(a.relativeRotation);this.aabb=new OIMO.AABB;this.density=a.density;this.friction=a.friction;this.restitution=a.restitution;this.belongsTo=a.belongsTo;this.collidesWith=a.collidesWith};
OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(a){throw Error("Inheritance error.");},updateProxy:function(){throw Error("Inheritance error.");}};OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3;this.relativeRotation=new OIMO.Mat33;this.friction=0.4;this.restitution=0.2;this.belongsTo=this.density=1;this.collidesWith=4294967295};OIMO.BoxShape=function(a,c,b,d){OIMO.Shape.call(this,a);this.width=c;this.height=b;this.depth=d;this.halfWidth=0.5*c;this.halfHeight=0.5*b;this.halfDepth=0.5*d;this.dimentions=new OIMO_ARRAY_TYPE(18);this.elements=new OIMO_ARRAY_TYPE(24);this.type=OIMO.SHAPE_BOX};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);
OIMO.BoxShape.prototype.calculateMassInfo=function(a){var c=this.width*this.height*this.depth*this.density;a.mass=c;a.inertia.init(c*(this.height*this.height+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.height*this.height)/12)};
OIMO.BoxShape.prototype.updateProxy=function(){var a=this.rotation.elements,c=this.dimentions;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];c[9]=a[0]*this.halfWidth;c[10]=a[3]*this.halfWidth;c[11]=a[6]*this.halfWidth;c[12]=a[1]*this.halfHeight;c[13]=a[4]*this.halfHeight;c[14]=a[7]*this.halfHeight;c[15]=a[2]*this.halfDepth;c[16]=a[5]*this.halfDepth;c[17]=a[8]*this.halfDepth;var a=c[9],b=c[10],d=c[11],e=c[12],f=c[13],g=c[14],k=c[15],h=c[16],l=c[17],m=this.position.x,
n=this.position.y,p=this.position.z,r=this.elements;r[0]=m+a+e+k;r[1]=n+b+f+h;r[2]=p+d+g+l;r[3]=m+a+e-k;r[4]=n+b+f-h;r[5]=p+d+g-l;r[6]=m+a-e+k;r[7]=n+b-f+h;r[8]=p+d-g+l;r[9]=m+a-e-k;r[10]=n+b-f-h;r[11]=p+d-g-l;r[12]=m-a+e+k;r[13]=n-b+f+h;r[14]=p-d+g+l;r[15]=m-a+e-k;r[16]=n-b+f-h;r[17]=p-d+g-l;r[18]=m-a-e+k;r[19]=n-b-f+h;r[20]=p-d-g+l;r[21]=m-a-e-k;r[22]=n-b-f-h;r[23]=p-d-g-l;a=0>c[9]?-c[9]:c[9];b=0>c[10]?-c[10]:c[10];d=0>c[11]?-c[11]:c[11];a=0>c[12]?a-c[12]:a+c[12];b=0>c[13]?b-c[13]:b+c[13];d=0>c[14]?
d-c[14]:d+c[14];a=0>c[15]?a-c[15]:a+c[15];b=0>c[16]?b-c[16]:b+c[16];d=0>c[17]?d-c[17]:d+c[17];c=OIMO.AABB_PROX;this.aabb.init(this.position.x-a-c,this.position.x+a+c,this.position.y-b-c,this.position.y+b+c,this.position.z-d-c,this.position.z+d+c);null!==this.proxy&&this.proxy.update()};OIMO.SphereShape=function(a,c){OIMO.Shape.call(this,a);this.radius=c;this.type=OIMO.SHAPE_SPHERE};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.calculateMassInfo=function(a){var c=4/3*OIMO.PI*this.radius*this.radius*this.radius*this.density;a.mass=c;c=c*this.radius*this.radius*2/5;a.inertia.init(c,0,0,0,c,0,0,0,c)};
OIMO.SphereShape.prototype.updateProxy=function(){var a=OIMO.AABB_PROX;this.aabb.init(this.position.x-this.radius-a,this.position.x+this.radius+a,this.position.y-this.radius-a,this.position.y+this.radius+a,this.position.z-this.radius-a,this.position.z+this.radius+a);null!==this.proxy&&this.proxy.update()};OIMO.CylinderShape=function(a,c,b){OIMO.Shape.call(this,a);this.radius=c;this.height=b;this.halfHeight=0.5*b;this.normalDirection=new OIMO.Vec3;this.halfDirection=new OIMO.Vec3;this.type=OIMO.SHAPE_CYLINDER};OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype);
OIMO.CylinderShape.prototype.calculateMassInfo=function(a){var c=OIMO.PI*this.radius*this.radius*this.height*this.density,b=(0.25*this.radius*this.radius+1/12*this.height*this.height)*c,d=0.5*this.radius*this.radius;a.mass=c;a.inertia.init(b,0,0,0,d,0,0,0,b)};
OIMO.CylinderShape.prototype.updateProxy=function(){var a=this.rotation.elements,c,b,d;b=a[1];d=a[4];var a=a[7],e=b*b,f=d*d,g=a*a;this.normalDirection.x=b;this.normalDirection.y=d;this.normalDirection.z=a;this.halfDirection.x=b*this.halfHeight;this.halfDirection.y=d*this.halfHeight;this.halfDirection.z=a*this.halfHeight;b=1-b*b;c=OIMO.sqrt(b*b+e*f+e*g);0<c&&(c=this.radius/c);b*=c;d=1-d*d;c=OIMO.sqrt(f*e+d*d+f*g);0<c&&(c=this.radius/c);d*=c;a=1-a*a;c=OIMO.sqrt(g*e+g*f+a*a);0<c&&(c=this.radius/c);a*=
c;e=0>this.halfDirection.x?-this.halfDirection.x:this.halfDirection.x;f=0>this.halfDirection.x?-this.halfDirection.y:this.halfDirection.y;g=0>this.halfDirection.x?-this.halfDirection.z:this.halfDirection.z;e=0>b?e-b:e+b;f=0>d?f-d:f+d;g=0>a?g-a:g+a;b=OIMO.AABB_PROX;this.aabb.init(this.position.x-e-b,this.position.x+e+b,this.position.y-f-b,this.position.y+f+b,this.position.z-g-b,this.position.z+g+b);null!==this.proxy&&this.proxy.update()};OIMO.CollisionDetector=function(){this.flip=!1};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(a,c,b){throw Error("Inheritance error.");}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=new OIMO_ARRAY_TYPE(24);this.clipVertices2=new OIMO_ARRAY_TYPE(24);this.used=new OIMO_ARRAY_TYPE(8);this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);var f=d.elements,g=e.elements,k=d.dimentions,h=e.dimentions,l=d.position,m=e.position,n=l.x,p=l.y,r=l.z,q=m.x,t=m.y,s=m.z,u=q-n,y=t-p,B=s-r,I=d.halfWidth,G=d.halfHeight,C=d.halfDepth,J=e.halfWidth,K=e.halfHeight,x=e.halfDepth,F=k[0],v=k[1],M=k[2],P=k[3],L=k[4],Q=k[5],T=k[6],N=k[7],O=k[8],U=k[9],V=k[10],Ya=k[11],Ca=k[12],Da=k[13],Ea=k[14],Ka=k[15],La=k[16],X=k[17],D=h[0],E=h[1],R=h[2],Y=h[3],
Z=h[4],ha=h[5],da=h[6],pa=h[7],qa=h[8],ea=h[9],fa=h[10],W=h[11],$=h[12],sa=h[13],ta=h[14],ya=h[15],za=h[16],Aa=h[17],yb=v*R-M*E,Nb=M*D-F*R,bc=F*E-v*D,cc=v*ha-M*Z,dc=M*Y-F*ha,ec=F*Z-v*Y,fc=v*qa-M*pa,gc=M*da-F*qa,hc=F*pa-v*da,Pa=L*R-Q*E,Qa=Q*D-P*R,Ra=P*E-L*D,Ga=L*ha-Q*Z,Za=Q*Y-P*ha,db=P*Z-L*Y,ja=L*qa-Q*pa,ka=Q*da-P*qa,la=P*pa-L*da,eb=N*R-O*E,fb=O*D-T*R,gb=T*E-N*D,hb=N*ha-O*Z,Ab=O*Y-T*ha,Bb=T*Z-N*Y,Cb=N*qa-O*pa,Db=O*da-T*qa,Eb=T*pa-N*da,qc,Ma,Na,Oa,ia,nb,ib,jb,ra,Ba,ob,ua,Kb,Lb,Mb,Fb,Gb,Hb,pb,qb,pc,
Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,ic,rc=!1,sc=!1,S=!1,Kc=!1,Lc=!1,Mc=!1,Nc=!1,Oc=!1,Pc=!1,A,Sa,Ta,w,z,Ua;A=F*u+v*y+M*B;(qc=0<A)||(A=-A);Sa=I;w=F*D+v*E+M*R;z=F*Y+v*Z+M*ha;Ua=F*da+v*pa+M*qa;0>w&&(w=-w);0>z&&(z=-z);0>Ua&&(Ua=-Ua);Ta=w*J+z*K+Ua*x;Fb=A-Sa-Ta;if(!(0<Fb||(A=P*u+L*y+Q*B,(Ma=0<A)||(A=-A),Sa=G,w=P*D+L*E+Q*R,z=P*Y+L*Z+Q*ha,Ua=P*da+L*pa+Q*qa,0>w&&(w=-w),0>z&&(z=-z),0>Ua&&(Ua=-Ua),Ta=w*J+z*K+Ua*x,Gb=A-Sa-Ta,0<Gb||(A=T*u+N*y+O*B,(Na=0<A)||(A=-A),Sa=C,w=T*D+N*E+O*R,z=T*Y+N*Z+O*ha,Ua=T*da+N*pa+O*qa,0>w&&(w=
-w),0>z&&(z=-z),0>Ua&&(Ua=-Ua),Ta=w*J+z*K+Ua*x,Hb=A-Sa-Ta,0<Hb||(A=D*u+E*y+R*B,(Oa=0<A)||(A=-A),w=D*F+E*v+R*M,z=D*P+E*L+R*Q,Ua=D*T+E*N+R*O,0>w&&(w=-w),0>z&&(z=-z),0>Ua&&(Ua=-Ua),Sa=w*I+z*G+Ua*C,Ta=J,pb=1*(A-Sa-Ta),0<pb||(A=Y*u+Z*y+ha*B,(ia=0<A)||(A=-A),w=Y*F+Z*v+ha*M,z=Y*P+Z*L+ha*Q,Ua=Y*T+Z*N+ha*O,0>w&&(w=-w),0>z&&(z=-z),0>Ua&&(Ua=-Ua),Sa=w*I+z*G+Ua*C,Ta=K,qb=1*(A-Sa-Ta),0<qb||(A=da*u+pa*y+qa*B,(nb=0<A)||(A=-A),w=da*F+pa*v+qa*M,z=da*P+pa*L+qa*Q,Ua=da*T+pa*N+qa*O,0>w&&(w=-w),0>z&&(z=-z),0>Ua&&(Ua=
-Ua),Sa=w*I+z*G+Ua*C,Ta=x,pc=1*(A-Sa-Ta),0<pc))))))){A=yb*yb+Nb*Nb+bc*bc;if(1E-5<A){if(A=1/Math.sqrt(A),yb*=A,Nb*=A,bc*=A,A=yb*u+Nb*y+bc*B,(ib=0<A)||(A=-A),w=yb*P+Nb*L+bc*Q,z=yb*T+Nb*N+bc*O,0>w&&(w=-w),0>z&&(z=-z),Sa=w*G+z*C,w=yb*Y+Nb*Z+bc*ha,z=yb*da+Nb*pa+bc*qa,0>w&&(w=-w),0>z&&(z=-z),Ta=w*K+z*x,Ob=A-Sa-Ta,0<Ob)return}else ib=!1,Ob=0,rc=!0;A=cc*cc+dc*dc+ec*ec;if(1E-5<A){if(A=1/Math.sqrt(A),cc*=A,dc*=A,ec*=A,A=cc*u+dc*y+ec*B,(jb=0<A)||(A=-A),w=cc*P+dc*L+ec*Q,z=cc*T+dc*N+ec*O,0>w&&(w=-w),0>z&&(z=-z),
Sa=w*G+z*C,w=cc*D+dc*E+ec*R,z=cc*da+dc*pa+ec*qa,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*x,Pb=A-Sa-Ta,0<Pb)return}else jb=!1,Pb=0,sc=!0;A=fc*fc+gc*gc+hc*hc;if(1E-5<A){if(A=1/Math.sqrt(A),fc*=A,gc*=A,hc*=A,A=fc*u+gc*y+hc*B,(ra=0<A)||(A=-A),w=fc*P+gc*L+hc*Q,z=fc*T+gc*N+hc*O,0>w&&(w=-w),0>z&&(z=-z),Sa=w*G+z*C,w=fc*D+gc*E+hc*R,z=fc*Y+gc*Z+hc*ha,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*K,Qb=A-Sa-Ta,0<Qb)return}else ra=!1,Qb=0,S=!0;A=Pa*Pa+Qa*Qa+Ra*Ra;if(1E-5<A){if(A=1/Math.sqrt(A),Pa*=A,Qa*=A,Ra*=A,A=Pa*u+Qa*y+Ra*B,(Ba=
0<A)||(A=-A),w=Pa*F+Qa*v+Ra*M,z=Pa*T+Qa*N+Ra*O,0>w&&(w=-w),0>z&&(z=-z),Sa=w*I+z*C,w=Pa*Y+Qa*Z+Ra*ha,z=Pa*da+Qa*pa+Ra*qa,0>w&&(w=-w),0>z&&(z=-z),Ta=w*K+z*x,Rb=A-Sa-Ta,0<Rb)return}else Ba=!1,Rb=0,Kc=!0;A=Ga*Ga+Za*Za+db*db;if(1E-5<A){if(A=1/Math.sqrt(A),Ga*=A,Za*=A,db*=A,A=Ga*u+Za*y+db*B,(ob=0<A)||(A=-A),w=Ga*F+Za*v+db*M,z=Ga*T+Za*N+db*O,0>w&&(w=-w),0>z&&(z=-z),Sa=w*I+z*C,w=Ga*D+Za*E+db*R,z=Ga*da+Za*pa+db*qa,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*x,Sb=A-Sa-Ta,0<Sb)return}else ob=!1,Sb=0,Lc=!0;A=ja*ja+ka*ka+
la*la;if(1E-5<A){if(A=1/Math.sqrt(A),ja*=A,ka*=A,la*=A,A=ja*u+ka*y+la*B,(ua=0<A)||(A=-A),w=ja*F+ka*v+la*M,z=ja*T+ka*N+la*O,0>w&&(w=-w),0>z&&(z=-z),Sa=w*I+z*C,w=ja*D+ka*E+la*R,z=ja*Y+ka*Z+la*ha,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*K,Tb=A-Sa-Ta,0<Tb)return}else ua=!1,Tb=0,Mc=!0;A=eb*eb+fb*fb+gb*gb;if(1E-5<A){if(A=1/Math.sqrt(A),eb*=A,fb*=A,gb*=A,A=eb*u+fb*y+gb*B,(Kb=0<A)||(A=-A),w=eb*F+fb*v+gb*M,z=eb*P+fb*L+gb*Q,0>w&&(w=-w),0>z&&(z=-z),Sa=w*I+z*G,w=eb*Y+fb*Z+gb*ha,z=eb*da+fb*pa+gb*qa,0>w&&(w=-w),0>z&&(z=
-z),Ta=w*K+z*x,Ub=A-Sa-Ta,0<Ub)return}else Kb=!1,Ub=0,Nc=!0;A=hb*hb+Ab*Ab+Bb*Bb;if(1E-5<A){if(A=1/Math.sqrt(A),hb*=A,Ab*=A,Bb*=A,A=hb*u+Ab*y+Bb*B,(Lb=0<A)||(A=-A),w=hb*F+Ab*v+Bb*M,z=hb*P+Ab*L+Bb*Q,0>w&&(w=-w),0>z&&(z=-z),Sa=w*I+z*G,w=hb*D+Ab*E+Bb*R,z=hb*da+Ab*pa+Bb*qa,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*x,Vb=A-Sa-Ta,0<Vb)return}else Lb=!1,Vb=0,Oc=!0;A=Cb*Cb+Db*Db+Eb*Eb;if(1E-5<A){if(A=1/Math.sqrt(A),Cb*=A,Db*=A,Eb*=A,A=Cb*u+Db*y+Eb*B,(Mb=0<A)||(A=-A),w=Cb*F+Db*v+Eb*M,z=Cb*P+Db*L+Eb*Q,0>w&&(w=-w),0>z&&
(z=-z),Sa=w*I+z*G,w=Cb*D+Db*E+Eb*R,z=Cb*Y+Db*Z+Eb*ha,0>w&&(w=-w),0>z&&(z=-z),Ta=w*J+z*K,ic=A-Sa-Ta,0<ic)return}else Mb=!1,ic=0,Pc=!0;var Ib=Fb,cb=Fb,Va=0,zb=qc;Gb>cb&&(cb=Ib=Gb,Va=1,zb=Ma);Hb>cb&&(cb=Ib=Hb,Va=2,zb=Na);pb>cb&&(cb=Ib=pb,Va=3,zb=Oa);qb>cb&&(cb=Ib=qb,Va=4,zb=ia);pc>cb&&(cb=Ib=pc,Va=5,zb=nb);Ob-0.01>cb&&!rc&&(Ib=Ob,cb=Ob-0.01,Va=6,zb=ib);Pb-0.01>cb&&!sc&&(Ib=Pb,cb=Pb-0.01,Va=7,zb=jb);Qb-0.01>cb&&!S&&(Ib=Qb,cb=Qb-0.01,Va=8,zb=ra);Rb-0.01>cb&&!Kc&&(Ib=Rb,cb=Rb-0.01,Va=9,zb=Ba);Sb-0.01>cb&&
!Lc&&(Ib=Sb,cb=Sb-0.01,Va=10,zb=ob);Tb-0.01>cb&&!Mc&&(Ib=Tb,cb=Tb-0.01,Va=11,zb=ua);Ub-0.01>cb&&!Nc&&(Ib=Ub,cb=Ub-0.01,Va=12,zb=Kb);Vb-0.01>cb&&!Oc&&(Ib=Vb,cb=Vb-0.01,Va=13,zb=Lb);ic-0.01>cb&&!Pc&&(Ib=ic,Va=14,zb=Mb);var aa=0,ba=0,ca=0,rb=0,sb=0,tb=0,vb=0,wb=0,xb=0,kb=0,lb=0,mb=0,wc=0,xc=0,yc=0,zc=0,Ac=0,Bc=0,Fc=!1;0==Va?(zb?(kb=n+U,lb=p+V,mb=r+Ya,aa=F,ba=v,ca=M):(kb=n-U,lb=p-V,mb=r-Ya,aa=-F,ba=-v,ca=-M),wc=Ca,xc=Da,yc=Ea,rb=-P,sb=-L,tb=-Q,zc=Ka,Ac=La,Bc=X,vb=-T,wb=-N,xb=-O):1==Va?(zb?(kb=n+Ca,lb=
p+Da,mb=r+Ea,aa=P,ba=L,ca=Q):(kb=n-Ca,lb=p-Da,mb=r-Ea,aa=-P,ba=-L,ca=-Q),wc=U,xc=V,yc=Ya,rb=-F,sb=-v,tb=-M,zc=Ka,Ac=La,Bc=X,vb=-T,wb=-N,xb=-O):2==Va?(zb?(kb=n+Ka,lb=p+La,mb=r+X,aa=T,ba=N,ca=O):(kb=n-Ka,lb=p-La,mb=r-X,aa=-T,ba=-N,ca=-O),wc=U,xc=V,yc=Ya,rb=-F,sb=-v,tb=-M,zc=Ca,Ac=Da,Bc=Ea,vb=-P,wb=-L,xb=-Q):3==Va?(Fc=!0,zb?(kb=q-ea,lb=t-fa,mb=s-W,aa=-D,ba=-E,ca=-R):(kb=q+ea,lb=t+fa,mb=s+W,aa=D,ba=E,ca=R),wc=$,xc=sa,yc=ta,rb=-Y,sb=-Z,tb=-ha,zc=ya,Ac=za,Bc=Aa,vb=-da,wb=-pa,xb=-qa):4==Va?(Fc=!0,zb?(kb=
q-$,lb=t-sa,mb=s-ta,aa=-Y,ba=-Z,ca=-ha):(kb=q+$,lb=t+sa,mb=s+ta,aa=Y,ba=Z,ca=ha),wc=ea,xc=fa,yc=W,rb=-D,sb=-E,tb=-R,zc=ya,Ac=za,Bc=Aa,vb=-da,wb=-pa,xb=-qa):5==Va?(Fc=!0,zb?(kb=q-ya,lb=t-za,mb=s-Aa,aa=-da,ba=-pa,ca=-qa):(kb=q+ya,lb=t+za,mb=s+Aa,aa=da,ba=pa,ca=qa),wc=ea,xc=fa,yc=W,rb=-D,sb=-E,tb=-R,zc=$,Ac=sa,Bc=ta,vb=-Y,wb=-Z,xb=-ha):6==Va?(aa=yb,ba=Nb,ca=bc,rb=F,sb=v,tb=M,vb=D,wb=E,xb=R):7==Va?(aa=cc,ba=dc,ca=ec,rb=F,sb=v,tb=M,vb=Y,wb=Z,xb=ha):8==Va?(aa=fc,ba=gc,ca=hc,rb=F,sb=v,tb=M,vb=da,wb=pa,xb=
qa):9==Va?(aa=Pa,ba=Qa,ca=Ra,rb=P,sb=L,tb=Q,vb=D,wb=E,xb=R):10==Va?(aa=Ga,ba=Za,ca=db,rb=P,sb=L,tb=Q,vb=Y,wb=Z,xb=ha):11==Va?(aa=ja,ba=ka,ca=la,rb=P,sb=L,tb=Q,vb=da,wb=pa,xb=qa):12==Va?(aa=eb,ba=fb,ca=gb,rb=T,sb=N,tb=O,vb=D,wb=E,xb=R):13==Va?(aa=hb,ba=Ab,ca=Bb,rb=T,sb=N,tb=O,vb=Y,wb=Z,xb=ha):14==Va&&(aa=Cb,ba=Db,ca=Eb,rb=T,sb=N,tb=O,vb=da,wb=pa,xb=qa);if(5<Va){zb||(aa=-aa,ba=-ba,ca=-ca);var Fa,Wa,va,wa,xa,tc,uc,vc,Cc,Dc,Ec;tc=f[0];uc=f[1];vc=f[2];Wa=aa*tc+ba*uc+ca*vc;va=f[3];wa=f[4];xa=f[5];Fa=aa*
va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[6];wa=f[7];xa=f[8];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[9];wa=f[10];xa=f[11];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[12];wa=f[13];xa=f[14];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[15];wa=f[16];xa=f[17];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[18];wa=f[19];xa=f[20];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&(Wa=Fa,tc=va,uc=wa,vc=xa);va=f[21];wa=f[22];xa=f[23];Fa=aa*va+ba*wa+ca*xa;Fa>Wa&&
(Wa=Fa,tc=va,uc=wa,vc=xa);Cc=g[0];Dc=g[1];Ec=g[2];Wa=aa*Cc+ba*Dc+ca*Ec;va=g[3];wa=g[4];xa=g[5];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[6];wa=g[7];xa=g[8];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[9];wa=g[10];xa=g[11];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[12];wa=g[13];xa=g[14];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[15];wa=g[16];xa=g[17];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[18];wa=g[19];xa=g[20];Fa=aa*
va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[21];wa=g[22];xa=g[23];Fa=aa*va+ba*wa+ca*xa;Fa<Wa&&(Wa=Fa,Cc=va,Dc=wa,Ec=xa);va=Cc-tc;wa=Dc-uc;xa=Ec-vc;w=rb*vb+sb*wb+tb*xb;var Ia=(va*(rb-vb*w)+wa*(sb-wb*w)+xa*(tb-xb*w))/(1-w*w);b.addPoint(tc+rb*Ia+aa*Ib*0.5,uc+sb*Ia+ba*Ib*0.5,vc+tb*Ia+ca*Ib*0.5,aa,ba,ca,Ib,!1)}else{var Wb,Xb,Yb,Zb,$b,ac,jc,kc,lc,mc,nc,oc,Xa=1,ga=0,ub=0;Fc?(ga=F*aa+v*ba+M*ca,ga<Xa&&(Xa=ga,ub=0),-ga<Xa&&(Xa=-ga,ub=1),ga=P*aa+L*ba+Q*ca,ga<Xa&&(Xa=ga,ub=2),-ga<Xa&&(Xa=-ga,ub=3),ga=
T*aa+N*ba+O*ca,ga<Xa&&(Xa=ga,ub=4),-ga<Xa&&(Xa=-ga,ub=5),0==ub?(Wb=f[0],Xb=f[1],Yb=f[2],Zb=f[6],$b=f[7],ac=f[8],jc=f[9],kc=f[10],lc=f[11],mc=f[3],nc=f[4],oc=f[5]):1==ub?(Wb=f[15],Xb=f[16],Yb=f[17],Zb=f[21],$b=f[22],ac=f[23],jc=f[18],kc=f[19],lc=f[20],mc=f[12],nc=f[13],oc=f[14]):2==ub?(Wb=f[12],Xb=f[13],Yb=f[14],Zb=f[0],$b=f[1],ac=f[2],jc=f[3],kc=f[4],lc=f[5],mc=f[15],nc=f[16],oc=f[17]):3==ub?(Wb=f[21],Xb=f[22],Yb=f[23],Zb=f[9],$b=f[10],ac=f[11],jc=f[6],kc=f[7],lc=f[8],mc=f[18],nc=f[19],oc=f[20]):
4==ub?(Wb=f[12],Xb=f[13],Yb=f[14],Zb=f[18],$b=f[19],ac=f[20],jc=f[6],kc=f[7],lc=f[8],mc=f[0],nc=f[1],oc=f[2]):5==ub&&(Wb=f[3],Xb=f[4],Yb=f[5],Zb=f[6],$b=f[7],ac=f[8],jc=f[21],kc=f[22],lc=f[23],mc=f[15],nc=f[16],oc=f[17])):(ga=D*aa+E*ba+R*ca,ga<Xa&&(Xa=ga,ub=0),-ga<Xa&&(Xa=-ga,ub=1),ga=Y*aa+Z*ba+ha*ca,ga<Xa&&(Xa=ga,ub=2),-ga<Xa&&(Xa=-ga,ub=3),ga=da*aa+pa*ba+qa*ca,ga<Xa&&(Xa=ga,ub=4),-ga<Xa&&(Xa=-ga,ub=5),0==ub?(Wb=g[0],Xb=g[1],Yb=g[2],Zb=g[6],$b=g[7],ac=g[8],jc=g[9],kc=g[10],lc=g[11],mc=g[3],nc=g[4],
oc=g[5]):1==ub?(Wb=g[15],Xb=g[16],Yb=g[17],Zb=g[21],$b=g[22],ac=g[23],jc=g[18],kc=g[19],lc=g[20],mc=g[12],nc=g[13],oc=g[14]):2==ub?(Wb=g[12],Xb=g[13],Yb=g[14],Zb=g[0],$b=g[1],ac=g[2],jc=g[3],kc=g[4],lc=g[5],mc=g[15],nc=g[16],oc=g[17]):3==ub?(Wb=g[21],Xb=g[22],Yb=g[23],Zb=g[9],$b=g[10],ac=g[11],jc=g[6],kc=g[7],lc=g[8],mc=g[18],nc=g[19],oc=g[20]):4==ub?(Wb=g[12],Xb=g[13],Yb=g[14],Zb=g[18],$b=g[19],ac=g[20],jc=g[6],kc=g[7],lc=g[8],mc=g[0],nc=g[1],oc=g[2]):5==ub&&(Wb=g[3],Xb=g[4],Yb=g[5],Zb=g[9],$b=g[10],
ac=g[11],jc=g[21],kc=g[22],lc=g[23],mc=g[15],nc=g[16],oc=g[17]));var Jb,Ha,H,ma,na,oa,$a,ab,bb;this.clipVertices1[0]=Wb;this.clipVertices1[1]=Xb;this.clipVertices1[2]=Yb;this.clipVertices1[3]=Zb;this.clipVertices1[4]=$b;this.clipVertices1[5]=ac;this.clipVertices1[6]=jc;this.clipVertices1[7]=kc;this.clipVertices1[8]=lc;this.clipVertices1[9]=mc;this.clipVertices1[10]=nc;this.clipVertices1[11]=oc;Ha=0;ma=this.clipVertices1[9];na=this.clipVertices1[10];oa=this.clipVertices1[11];w=(ma-kb-wc)*rb+(na-lb-
xc)*sb+(oa-mb-yc)*tb;for(var Ja=0;4>Ja;Ja++)H=3*Ja,$a=this.clipVertices1[H],ab=this.clipVertices1[H+1],bb=this.clipVertices1[H+2],z=($a-kb-wc)*rb+(ab-lb-xc)*sb+(bb-mb-yc)*tb,0<w?0<z?(H=3*Ha,Ha++,this.clipVertices2[H]=$a,this.clipVertices2[H+1]=ab,this.clipVertices2[H+2]=bb):(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices2[H]=ma+($a-ma)*Ia,this.clipVertices2[H+1]=na+(ab-na)*Ia,this.clipVertices2[H+2]=oa+(bb-oa)*Ia):0<z&&(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices2[H]=ma+($a-ma)*Ia,this.clipVertices2[H+1]=
na+(ab-na)*Ia,this.clipVertices2[H+2]=oa+(bb-oa)*Ia,H=3*Ha,Ha++,this.clipVertices2[H]=$a,this.clipVertices2[H+1]=ab,this.clipVertices2[H+2]=bb),ma=$a,na=ab,oa=bb,w=z;Jb=Ha;if(0!=Jb){Ha=0;H=3*(Jb-1);ma=this.clipVertices2[H];na=this.clipVertices2[H+1];oa=this.clipVertices2[H+2];w=(ma-kb-zc)*vb+(na-lb-Ac)*wb+(oa-mb-Bc)*xb;for(Ja=0;Ja<Jb;Ja++)H=3*Ja,$a=this.clipVertices2[H],ab=this.clipVertices2[H+1],bb=this.clipVertices2[H+2],z=($a-kb-zc)*vb+(ab-lb-Ac)*wb+(bb-mb-Bc)*xb,0<w?0<z?(H=3*Ha,Ha++,this.clipVertices1[H]=
$a,this.clipVertices1[H+1]=ab,this.clipVertices1[H+2]=bb):(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices1[H]=ma+($a-ma)*Ia,this.clipVertices1[H+1]=na+(ab-na)*Ia,this.clipVertices1[H+2]=oa+(bb-oa)*Ia):0<z&&(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices1[H]=ma+($a-ma)*Ia,this.clipVertices1[H+1]=na+(ab-na)*Ia,this.clipVertices1[H+2]=oa+(bb-oa)*Ia,H=3*Ha,Ha++,this.clipVertices1[H]=$a,this.clipVertices1[H+1]=ab,this.clipVertices1[H+2]=bb),ma=$a,na=ab,oa=bb,w=z;Jb=Ha;if(0!=Jb){Ha=0;H=3*(Jb-1);ma=this.clipVertices1[H];
na=this.clipVertices1[H+1];oa=this.clipVertices1[H+2];w=(ma-kb+wc)*-rb+(na-lb+xc)*-sb+(oa-mb+yc)*-tb;for(Ja=0;Ja<Jb;Ja++)H=3*Ja,$a=this.clipVertices1[H],ab=this.clipVertices1[H+1],bb=this.clipVertices1[H+2],z=($a-kb+wc)*-rb+(ab-lb+xc)*-sb+(bb-mb+yc)*-tb,0<w?0<z?(H=3*Ha,Ha++,this.clipVertices2[H]=$a,this.clipVertices2[H+1]=ab,this.clipVertices2[H+2]=bb):(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices2[H]=ma+($a-ma)*Ia,this.clipVertices2[H+1]=na+(ab-na)*Ia,this.clipVertices2[H+2]=oa+(bb-oa)*Ia):0<z&&(H=3*
Ha,Ha++,Ia=w/(w-z),this.clipVertices2[H]=ma+($a-ma)*Ia,this.clipVertices2[H+1]=na+(ab-na)*Ia,this.clipVertices2[H+2]=oa+(bb-oa)*Ia,H=3*Ha,Ha++,this.clipVertices2[H]=$a,this.clipVertices2[H+1]=ab,this.clipVertices2[H+2]=bb),ma=$a,na=ab,oa=bb,w=z;Jb=Ha;if(0!=Jb){Ha=0;H=3*(Jb-1);ma=this.clipVertices2[H];na=this.clipVertices2[H+1];oa=this.clipVertices2[H+2];w=(ma-kb+zc)*-vb+(na-lb+Ac)*-wb+(oa-mb+Bc)*-xb;for(Ja=0;Ja<Jb;Ja++)H=3*Ja,$a=this.clipVertices2[H],ab=this.clipVertices2[H+1],bb=this.clipVertices2[H+
2],z=($a-kb+zc)*-vb+(ab-lb+Ac)*-wb+(bb-mb+Bc)*-xb,0<w?0<z?(H=3*Ha,Ha++,this.clipVertices1[H]=$a,this.clipVertices1[H+1]=ab,this.clipVertices1[H+2]=bb):(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices1[H]=ma+($a-ma)*Ia,this.clipVertices1[H+1]=na+(ab-na)*Ia,this.clipVertices1[H+2]=oa+(bb-oa)*Ia):0<z&&(H=3*Ha,Ha++,Ia=w/(w-z),this.clipVertices1[H]=ma+($a-ma)*Ia,this.clipVertices1[H+1]=na+(ab-na)*Ia,this.clipVertices1[H+2]=oa+(bb-oa)*Ia,H=3*Ha,Ha++,this.clipVertices1[H]=$a,this.clipVertices1[H+1]=ab,this.clipVertices1[H+
2]=bb),ma=$a,na=ab,oa=bb,w=z;Jb=Ha;if(Fc){var Sc=d;d=e;e=Sc}if(0!=Jb){var Gc=d!=a;if(4<Jb){ma=0.25*(Wb+Zb+jc+mc);na=0.25*(Xb+$b+kc+nc);oa=0.25*(Yb+ac+lc+oc);for(var rb=Wb-ma,sb=Xb-na,tb=Yb-oa,vb=Zb-ma,wb=$b-na,xb=ac-oa,Ic=0,Qc=0,Jc=0,Rc=0,Hc=-this.INF,Xa=this.INF,Ja=0;Ja<Jb;Ja++)this.used[Ja]=!1,H=3*Ja,ma=this.clipVertices1[H],na=this.clipVertices1[H+1],oa=this.clipVertices1[H+2],ga=ma*rb+na*sb+oa*tb,ga<Xa&&(Xa=ga,Ic=Ja),ga>Hc&&(Hc=ga,Jc=Ja);this.used[Ic]=!0;this.used[Jc]=!0;Hc=-this.INF;Xa=this.INF;
for(Ja=0;Ja<Jb;Ja++)this.used[Ja]||(H=3*Ja,ma=this.clipVertices1[H],na=this.clipVertices1[H+1],oa=this.clipVertices1[H+2],ga=ma*vb+na*wb+oa*xb,ga<Xa&&(Xa=ga,Qc=Ja),ga>Hc&&(Hc=ga,Rc=Ja));H=3*Ic;ma=this.clipVertices1[H];na=this.clipVertices1[H+1];oa=this.clipVertices1[H+2];ga=(ma-kb)*aa+(na-lb)*ba+(oa-mb)*ca;0>ga&&b.addPoint(ma,na,oa,aa,ba,ca,ga,Gc);H=3*Qc;ma=this.clipVertices1[H];na=this.clipVertices1[H+1];oa=this.clipVertices1[H+2];ga=(ma-kb)*aa+(na-lb)*ba+(oa-mb)*ca;0>ga&&b.addPoint(ma,na,oa,aa,
ba,ca,ga,Gc);H=3*Jc;ma=this.clipVertices1[H];na=this.clipVertices1[H+1];oa=this.clipVertices1[H+2];ga=(ma-kb)*aa+(na-lb)*ba+(oa-mb)*ca;0>ga&&b.addPoint(ma,na,oa,aa,ba,ca,ga,Gc);H=3*Rc;ma=this.clipVertices1[H];na=this.clipVertices1[H+1];oa=this.clipVertices1[H+2];ga=(ma-kb)*aa+(na-lb)*ba+(oa-mb)*ca;0>ga&&b.addPoint(ma,na,oa,aa,ba,ca,ga,Gc)}else for(Ja=0;Ja<Jb;Ja++)H=3*Ja,ma=this.clipVertices1[H],na=this.clipVertices1[H+1],oa=this.clipVertices1[H+2],ga=(ma-kb)*aa+(na-lb)*ba+(oa-mb)*ca,0>ga&&b.addPoint(ma,
na,oa,aa,ba,ca,ga,Gc)}}}}}}};OIMO.SphereBoxCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=e.dimentions,g=d.position;a=g.x;c=g.y;var k=g.z,h=e.position,l=h.x,m=h.y,h=h.z;d=d.radius;var n=e.halfWidth,p=e.halfHeight,r=e.halfDepth;e=a-l;var q=c-m,t=k-h,s=f[0]*e+f[1]*q+f[2]*t,u=f[3]*e+f[4]*q+f[5]*t,y=f[6]*e+f[7]*q+f[8]*t;e=0;s>n?s=n:s<-n?s=-n:e=1;u>p?u=p:u<-p?u=-p:e|=2;y>r?y=r:y<-r?y=-r:e|=4;7==e?(e=0>s?n+s:n-s,q=0>u?p+u:p-u,t=0>y?r+y:r-y,e<q?e<t?(g=e-n,0>s?(e=f[0],q=f[1],t=
f[2]):(e=-f[0],q=-f[1],t=-f[2])):(g=t-r,0>y?(e=f[6],q=f[7],t=f[8]):(e=-f[6],q=-f[7],t=-f[8])):q<t?(g=q-p,0>u?(e=f[3],q=f[4],t=f[5]):(e=-f[3],q=-f[4],t=-f[5])):(g=t-r,0>y?(e=f[6],q=f[7],t=f[8]):(e=-f[6],q=-f[7],t=-f[8])),b.addPoint(a+d*e,c+d*q,k+d*t,e,q,t,g-d,this.flip)):(l=l+s*f[0]+u*f[3]+y*f[6],m=m+s*f[1]+u*f[4]+y*f[7],f=h+s*f[2]+u*f[5]+y*f[8],e=l-g.x,q=m-g.y,t=f-g.z,g=e*e+q*q+t*t,0<g&&g<d*d&&(g=OIMO.sqrt(g),f=1/g,e*=f,q*=f,t*=f,b.addPoint(a+d*e,c+d*q,k+d*t,e,q,t,g-d,this.flip)))};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(a,c,b){var d=a.position,e=c.position,f=e.x-d.x,g=e.y-d.y,e=e.z-d.z,k=f*f+g*g+e*e;a=a.radius;c=a+c.radius;if(0<k&&k<c*c){var k=OIMO.sqrt(k),h=1/k,f=f*h,g=g*h,e=e*h;b.addPoint(d.x+f*a,d.y+g*a,d.z+e*a,f,g,e,k-c,!1)}};OIMO.BoxCylinderCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(a,c,b,d,e){var f,g,k,h,l,m,n=new OIMO.Vec3,p,r,q,t,s,u,y=a.position.x,B=a.position.y,I=a.position.z,G=c.position.x,C=c.position.y,J=c.position.z,K=G-y,x=C-B,F=J-I;0==K*K+x*x+F*F&&(x=0.001);var v=-K;m=-x;h=-F;this.supportPointB(a,-v,-m,-h,n);var M=n.x,P=n.y,L=n.z;this.supportPointC(c,v,m,h,n);var Q=n.x,T=n.y,N=n.z,O=Q-M,U=T-P,V=N-L;if(0>=O*v+U*m+V*h)return!1;v=U*F-V*x;m=V*K-O*F;h=O*x-U*K;if(0==v*v+m*m+h*h)return b.init(O-K,U-x,V-F),b.normalize(b),
d.init(0.5*(M+Q),0.5*(P+T),0.5*(L+N)),!0;this.supportPointB(a,-v,-m,-h,n);var Ya=n.x,Ca=n.y,Da=n.z;this.supportPointC(c,v,m,h,n);var Ea=n.x,Ka=n.y,La=n.z,X=Ea-Ya,D=Ka-Ca,E=La-Da;if(0>=X*v+D*m+E*h)return!1;f=O-K;g=U-x;k=V-F;h=X-K;l=D-x;m=E-F;v=g*m-k*l;m=k*h-f*m;h=f*l-g*h;0<v*K+m*x+h*F&&(f=O,g=U,k=V,O=X,U=D,V=E,X=f,D=g,E=k,f=M,g=P,k=L,M=Ya,P=Ca,L=Da,Ya=f,Ca=g,Da=k,f=Q,g=T,k=N,Q=Ea,T=Ka,N=La,Ea=f,Ka=g,La=k,v=-v,m=-m,h=-h);for(var R=0;;){if(100<++R)return!1;this.supportPointB(a,-v,-m,-h,n);var Y=n.x,
Z=n.y,ha=n.z;this.supportPointC(c,v,m,h,n);var da=n.x,pa=n.y,qa=n.z,ea=da-Y,fa=pa-Z,W=qa-ha;if(0>=ea*v+fa*m+W*h)return!1;if(0>(U*W-V*fa)*K+(V*ea-O*W)*x+(O*fa-U*ea)*F)X=ea,D=fa,E=W,Ya=Y,Ca=Z,Da=ha,Ea=da,Ka=pa,La=qa,f=O-K,g=U-x,k=V-F,h=ea-K,l=fa-x,m=W-F,v=g*m-k*l,m=k*h-f*m,h=f*l-g*h;else if(0>(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*F)O=ea,U=fa,V=W,M=Y,P=Z,L=ha,Q=da,T=pa,N=qa,f=ea-K,g=fa-x,k=W-F,h=X-K,l=D-x,m=E-F,v=g*m-k*l,m=k*h-f*m,h=f*l-g*h;else for(var $=!1;;){f=X-O;g=D-U;k=E-V;h=ea-O;l=fa-U;m=W-V;
v=g*m-k*l;m=k*h-f*m;h=f*l-g*h;f=1/OIMO.sqrt(v*v+m*m+h*h);v*=f;m*=f;h*=f;0<=v*O+m*U+h*V&&!$&&(u=(U*E-V*D)*ea+(V*X-O*E)*fa+(O*D-U*X)*W,$=(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*F,f=(x*V-F*U)*ea+(F*O-K*V)*fa+(K*U-x*O)*W,g=(D*V-E*U)*K+(E*O-X*V)*x+(X*U-D*O)*F,p=u+$+f+g,0>=p&&(u=0,$=(D*W-E*fa)*v+(E*ea-X*W)*m+(X*fa-D*ea)*h,f=(fa*E-W*D)*v+(W*X-ea*E)*m+(ea*D-fa*X)*h,g=(U*E-V*D)*v+(V*X-O*E)*m+(O*D-U*X)*h,p=$+f+g),k=1/p,p=(y*u+M*$+Ya*f+Y*g)*k,r=(B*u+P*$+Ca*f+Z*g)*k,q=(I*u+L*$+Da*f+ha*g)*k,t=(G*u+Q*$+Ea*f+da*g)*
k,s=(C*u+T*$+Ka*f+pa*g)*k,u=(J*u+N*$+La*f+qa*g)*k,$=!0);this.supportPointB(a,-v,-m,-h,n);f=n.x;g=n.y;k=n.z;this.supportPointC(c,v,m,h,n);l=n.x;var sa=n.y,ta=n.z,ya=l-f,za=sa-g,Aa=ta-k,yb=-(ya*v+za*m+Aa*h);if(0.01>=(ya-ea)*v+(za-fa)*m+(Aa-W)*h||0<=yb)return $?(b.init(-v,-m,-h),d.init(0.5*(p+t),0.5*(r+s),0.5*(q+u)),e.x=yb,!0):!1;0>(za*V-Aa*U)*K+(Aa*O-ya*V)*x+(ya*U-za*O)*F?0>(za*E-Aa*D)*K+(Aa*X-ya*E)*x+(ya*D-za*X)*F?(O=ya,U=za,V=Aa,M=f,P=g,L=k,Q=l,T=sa,N=ta):(ea=ya,fa=za,W=Aa,Y=f,Z=g,ha=k,da=l,pa=sa,
qa=ta):0>(za*W-Aa*fa)*K+(Aa*ea-ya*W)*x+(ya*fa-za*ea)*F?(X=ya,D=za,E=Aa,Ya=f,Ca=g,Da=k,Ea=l,Ka=sa,La=ta):(O=ya,U=za,V=Aa,M=f,P=g,L=k,Q=l,T=sa,N=ta)}}};
OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,k=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;d=a.halfWidth;var h=a.halfHeight;b=a.halfDepth;d=0>g?-d:d;h=0>k?-h:h;c=0>c?-b:b;g=f[0]*d+f[1]*h+f[2]*c+a.position.x;k=f[3]*d+f[4]*h+f[5]*c+a.position.y;c=f[6]*d+f[7]*h+f[8]*c+a.position.z;e.init(g,k,c)};
OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,k=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;b=g;g=c;c=b*b+g*g;var h=a.radius;d=a.halfHeight;0==c?(0>k?(b=h,d=-d):b=h,c=0):(c=a.radius/OIMO.sqrt(c),0>k?(b*=c,d=-d):b*=c,c*=g);g=f[0]*b+f[1]*d+f[2]*c+a.position.x;k=f[3]*b+f[4]*d+f[5]*c+a.position.y;c=f[6]*b+f[7]*d+f[8]*c+a.position.z;e.init(g,k,c)};
OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=new OIMO.Vec3,g=new OIMO.Vec3,k=new OIMO.Vec3;if(this.getSep(d,e,f,g,k)){var h=d.position.x,l=d.position.y,m=d.position.z,n=e.position.x,p=e.position.y,r=e.position.z,q=d.halfWidth,t=d.halfHeight,s=d.halfDepth,u=e.halfHeight,y=e.radius,B=d.dimentions,I=B[0],G=B[1],C=B[2],J=B[3],K=B[4],x=B[5],F=B[6],v=B[7],M=B[8],P=B[9],L=B[10],Q=B[11],T=B[12],N=B[13],O=B[14],U=B[15],V=B[16],Ya=B[17],
Ca=e.normalDirection.x,Da=e.normalDirection.y,Ea=e.normalDirection.z,Ka=e.halfDirection.x,La=e.halfDirection.y,X=e.halfDirection.z,D=f.x,E=f.y,R=f.z,Y=D*I+E*G+R*C,Z=D*J+E*K+R*x,ha=D*F+E*v+R*M,da=D*Ca+E*Da+R*Ea,pa=0<Y,qa=0<Z,ea=0<ha,fa=0<da;pa||(Y=-Y);qa||(Z=-Z);ea||(ha=-ha);fa||(da=-da);var W=0;0.999<da?W=0.999<Y?Y>da?1:4:0.999<Z?Z>da?2:4:0.999<ha?ha>da?3:4:4:0.999<Y?W=1:0.999<Z?W=2:0.999<ha&&(W=3);var $,sa,ta,ya,za,Aa,yb,Nb,bc,cc,dc,ec,fc,gc,hc,Pa,Qa,Ra,Ga,Za,db,ja,ka,la,eb,fb,gb,hb,Ab,Bb,Cb,Db,
Eb,qc,Ma,Na,Oa,ia,nb,ib,jb,ra,Ba,ob,ua,Kb,Lb,Mb,Fb,Gb,Hb,pb,qb;if(0==W)b.addPoint(g.x,g.y,g.z,D,E,R,k.x,this.flip);else if(4==W){fa?(ya=n-Ka,za=p-La,Aa=r-X,D=-Ca,E=-Da,R=-Ea):(ya=n+Ka,za=p+La,Aa=r+X,D=Ca,E=Da,R=Ea);var pc,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,ic,rc,sc;Za=1;W=0;Ba=I*D+G*E+C*R;Ba<Za&&(Za=Ba,W=0);-Ba<Za&&(Za=-Ba,W=1);Ba=J*D+K*E+x*R;Ba<Za&&(Za=Ba,W=2);-Ba<Za&&(Za=-Ba,W=3);Ba=F*D+v*E+M*R;Ba<Za&&(Za=Ba,W=4);-Ba<Za&&(Za=-Ba,W=5);var S=d.elements;switch(W){case 0:pc=S[0];Ob=S[1];Pb=S[2];Qb=S[6];Rb=S[7];
Sb=S[8];Tb=S[9];Ub=S[10];Vb=S[11];ic=S[3];rc=S[4];sc=S[5];break;case 1:pc=S[15];Ob=S[16];Pb=S[17];Qb=S[21];Rb=S[22];Sb=S[23];Tb=S[18];Ub=S[19];Vb=S[20];ic=S[12];rc=S[13];sc=S[14];break;case 2:pc=S[12];Ob=S[13];Pb=S[14];Qb=S[0];Rb=S[1];Sb=S[2];Tb=S[3];Ub=S[4];Vb=S[5];ic=S[15];rc=S[16];sc=S[17];break;case 3:pc=S[21];Ob=S[22];Pb=S[23];Qb=S[9];Rb=S[10];Sb=S[11];Tb=S[6];Ub=S[7];Vb=S[8];ic=S[18];rc=S[19];sc=S[20];break;case 4:pc=S[12];Ob=S[13];Pb=S[14];Qb=S[18];Rb=S[19];Sb=S[20];Tb=S[6];Ub=S[7];Vb=S[8];
ic=S[0];rc=S[1];sc=S[2];break;case 5:pc=S[3],Ob=S[4],Pb=S[5],Qb=S[9],Rb=S[10],Sb=S[11],Tb=S[21],Ub=S[22],Vb=S[23],ic=S[15],rc=S[16],sc=S[17]}Ga=D*(pc-ya)+E*(Ob-za)+R*(Pb-Aa);0>=Ga&&b.addPoint(pc,Ob,Pb,-D,-E,-R,Ga,this.flip);Ga=D*(Qb-ya)+E*(Rb-za)+R*(Sb-Aa);0>=Ga&&b.addPoint(Qb,Rb,Sb,-D,-E,-R,Ga,this.flip);Ga=D*(Tb-ya)+E*(Ub-za)+R*(Vb-Aa);0>=Ga&&b.addPoint(Tb,Ub,Vb,-D,-E,-R,Ga,this.flip);Ga=D*(ic-ya)+E*(rc-za)+R*(sc-Aa);0>=Ga&&b.addPoint(ic,rc,sc,-D,-E,-R,Ga,this.flip)}else{switch(W){case 1:pa?($=
h+P,sa=l+L,ta=m+Q,D=I,E=G,R=C):($=h-P,sa=l-L,ta=m-Q,D=-I,E=-G,R=-C);Kb=J;Lb=K;Mb=x;pb=t;Fb=F;Gb=v;Hb=M;qb=s;break;case 2:qa?($=h+T,sa=l+N,ta=m+O,D=J,E=K,R=x):($=h-T,sa=l-N,ta=m-O,D=-J,E=-K,R=-x);Kb=I;Lb=G;Mb=C;pb=q;Fb=F;Gb=v;Hb=M;qb=s;break;case 3:ea?($=h+U,sa=l+V,ta=m+Ya,D=F,E=v,R=M):($=h-U,sa=l-V,ta=m-Ya,D=-F,E=-v,R=-M),Kb=I,Lb=G,Mb=C,pb=q,Fb=J,Gb=K,Hb=x,qb=t}Za=D*Ca+E*Da+R*Ea;db=0>Za?u:-u;ya=n+db*Ca;za=p+db*Da;Aa=r+db*Ea;0.999999<=da?(ja=-E,ka=R,la=D):(ja=D,ka=E,la=R);db=ja*Ca+ka*Da+la*Ea;fb=db*
Ca-ja;gb=db*Da-ka;hb=db*Ea-la;db=OIMO.sqrt(fb*fb+gb*gb+hb*hb);if(0!=db)if(db=y/db,fb*=db,gb*=db,hb*=db,ja=ya+fb,ka=za+gb,la=Aa+hb,-0.96>Za||0.96<Za)yb=Ca*Ca*1.5-0.5,Nb=Ca*Da*1.5-0.866025403*Ea,bc=Ca*Ea*1.5+0.866025403*Da,cc=Da*Ca*1.5+0.866025403*Ea,dc=Da*Da*1.5-0.5,ec=Da*Ea*1.5-0.866025403*Ca,fc=Ea*Ca*1.5-0.866025403*Da,gc=Ea*Da*1.5+0.866025403*Ca,hc=Ea*Ea*1.5-0.5,Pa=ja,Qa=ka,Ra=la,Ga=D*(Pa-$)+E*(Qa-sa)+R*(Ra-ta),ja=Pa-Ga*D-$,ka=Qa-Ga*E-sa,la=Ra-Ga*R-ta,ia=Kb*ja+Lb*ka+Mb*la,ra=Fb*ja+Gb*ka+Hb*la,ia<
-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),ja=ia*Kb+ra*Fb,ka=ia*Lb+ra*Gb,la=ia*Mb+ra*Hb,Pa=$+ja,Qa=sa+ka,Ra=ta+la,b.addPoint(Pa,Qa,Ra,D,E,R,Ga,this.flip),Pa=fb*yb+gb*Nb+hb*bc,Qa=fb*cc+gb*dc+hb*ec,Ra=fb*fc+gb*gc+hb*hc,Pa=(fb=Pa)+ya,Qa=(gb=Qa)+za,Ra=(hb=Ra)+Aa,Ga=D*(Pa-$)+E*(Qa-sa)+R*(Ra-ta),0>=Ga&&(ja=Pa-Ga*D-$,ka=Qa-Ga*E-sa,la=Ra-Ga*R-ta,ia=Kb*ja+Lb*ka+Mb*la,ra=Fb*ja+Gb*ka+Hb*la,ia<-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),ja=ia*Kb+ra*Fb,ka=ia*Lb+ra*Gb,la=ia*Mb+ra*Hb,Pa=$+
ja,Qa=sa+ka,Ra=ta+la,b.addPoint(Pa,Qa,Ra,D,E,R,Ga,this.flip)),Pa=fb*yb+gb*Nb+hb*bc,Qa=fb*cc+gb*dc+hb*ec,Ra=fb*fc+gb*gc+hb*hc,Pa=(fb=Pa)+ya,Qa=(gb=Qa)+za,Ra=(hb=Ra)+Aa,Ga=D*(Pa-$)+E*(Qa-sa)+R*(Ra-ta),0>=Ga&&(ja=Pa-Ga*D-$,ka=Qa-Ga*E-sa,la=Ra-Ga*R-ta,ia=Kb*ja+Lb*ka+Mb*la,ra=Fb*ja+Gb*ka+Hb*la,ia<-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),ja=ia*Kb+ra*Fb,ka=ia*Lb+ra*Gb,la=ia*Mb+ra*Hb,Pa=$+ja,Qa=sa+ka,Ra=ta+la,b.addPoint(Pa,Qa,Ra,D,E,R,Ga,this.flip));else{Ma=ja;Na=ka;Oa=la;ia=D*(Ma-$)+E*(Na-
sa)+R*(Oa-ta);Ma-=ia*D;Na-=ia*E;Oa-=ia*R;0<Za?(nb=ja+2*Ka,ib=ka+2*La,jb=la+2*X):(nb=ja-2*Ka,ib=ka-2*La,jb=la-2*X);ra=D*(nb-$)+E*(ib-sa)+R*(jb-ta);nb-=ra*D;ib-=ra*E;jb-=ra*R;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Db=nb-$;Eb=ib-sa;qc=jb-ta;ja=nb-Ma;ka=ib-Na;la=jb-Oa;eb=ra-ia;Y=Ab*Kb+Bb*Lb+Cb*Mb;Z=Db*Kb+Eb*Lb+qc*Mb;Ba=Y-pb;ob=Z-pb;if(0<Ba){if(0<ob)return;ua=Ba/(Ba-ob);Ma+=ja*ua;Na+=ka*ua;Oa+=la*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Y=Ab*Kb+Bb*Lb+Cb*Mb;ja=nb-Ma;ka=ib-Na;la=jb-Oa;eb=ra-ia}else 0<ob&&(ua=Ba/(Ba-ob),
nb=Ma+ja*ua,ib=Na+ka*ua,jb=Oa+la*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,Z=Db*Kb+Eb*Lb+qc*Mb,ja=nb-Ma,ka=ib-Na,la=jb-Oa,eb=ra-ia);Ba=Y+pb;ob=Z+pb;if(0>Ba){if(0>ob)return;ua=Ba/(Ba-ob);Ma+=ja*ua;Na+=ka*ua;Oa+=la*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;ja=nb-Ma;ka=ib-Na;la=jb-Oa;eb=ra-ia}else 0>ob&&(ua=Ba/(Ba-ob),nb=Ma+ja*ua,ib=Na+ka*ua,jb=Oa+la*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,ja=nb-Ma,ka=ib-Na,la=jb-Oa,eb=ra-ia);Y=Ab*Fb+Bb*Gb+Cb*Hb;Z=Db*Fb+Eb*Gb+qc*Hb;Ba=Y-qb;ob=Z-qb;if(0<Ba){if(0<ob)return;
ua=Ba/(Ba-ob);Ma+=ja*ua;Na+=ka*ua;Oa+=la*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Y=Ab*Fb+Bb*Gb+Cb*Hb;ja=nb-Ma;ka=ib-Na;la=jb-Oa;eb=ra-ia}else 0<ob&&(ua=Ba/(Ba-ob),nb=Ma+ja*ua,ib=Na+ka*ua,jb=Oa+la*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,Z=Db*Fb+Eb*Gb+qc*Hb,ja=nb-Ma,ka=ib-Na,la=jb-Oa,eb=ra-ia);Ba=Y+qb;ob=Z+qb;if(0>Ba){if(0>ob)return;ua=Ba/(Ba-ob);Ma+=ja*ua;Na+=ka*ua;Oa+=la*ua;ia+=eb*ua}else 0>ob&&(ua=Ba/(Ba-ob),nb=Ma+ja*ua,ib=Na+ka*ua,jb=Oa+la*ua,ra=ia+eb*ua);0>ia&&b.addPoint(Ma,Na,Oa,D,E,R,ia,this.flip);
0>ra&&b.addPoint(nb,ib,jb,D,E,R,ra,this.flip)}}}};OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(a,c,b,d,e){var f,g,k,h,l,m,n=new OIMO.Vec3,p,r,q,t,s,u,y=a.position.x,B=a.position.y,I=a.position.z,G=c.position.x,C=c.position.y,J=c.position.z,K=G-y,x=C-B,F=J-I;0==K*K+x*x+F*F&&(x=0.001);var v=-K;m=-x;h=-F;this.supportPoint(a,-v,-m,-h,n);var M=n.x,P=n.y,L=n.z;this.supportPoint(c,v,m,h,n);var Q=n.x,T=n.y,N=n.z,O=Q-M,U=T-P,V=N-L;if(0>=O*v+U*m+V*h)return!1;v=U*F-V*x;m=V*K-O*F;h=O*x-U*K;if(0==v*v+m*m+h*h)return b.init(O-K,U-x,V-F),b.normalize(b),
d.init(0.5*(M+Q),0.5*(P+T),0.5*(L+N)),!0;this.supportPoint(a,-v,-m,-h,n);var Ya=n.x,Ca=n.y,Da=n.z;this.supportPoint(c,v,m,h,n);var Ea=n.x,Ka=n.y,La=n.z,X=Ea-Ya,D=Ka-Ca,E=La-Da;if(0>=X*v+D*m+E*h)return!1;f=O-K;g=U-x;k=V-F;h=X-K;l=D-x;m=E-F;v=g*m-k*l;m=k*h-f*m;h=f*l-g*h;0<v*K+m*x+h*F&&(f=O,g=U,k=V,O=X,U=D,V=E,X=f,D=g,E=k,f=M,g=P,k=L,M=Ya,P=Ca,L=Da,Ya=f,Ca=g,Da=k,f=Q,g=T,k=N,Q=Ea,T=Ka,N=La,Ea=f,Ka=g,La=k,v=-v,m=-m,h=-h);for(var R=0;;){if(100<++R)return!1;this.supportPoint(a,-v,-m,-h,n);var Y=n.x,Z=n.y,
ha=n.z;this.supportPoint(c,v,m,h,n);var da=n.x,pa=n.y,qa=n.z,ea=da-Y,fa=pa-Z,W=qa-ha;if(0>=ea*v+fa*m+W*h)return!1;if(0>(U*W-V*fa)*K+(V*ea-O*W)*x+(O*fa-U*ea)*F)X=ea,D=fa,E=W,Ya=Y,Ca=Z,Da=ha,Ea=da,Ka=pa,La=qa,f=O-K,g=U-x,k=V-F,h=ea-K,l=fa-x,m=W-F,v=g*m-k*l,m=k*h-f*m,h=f*l-g*h;else if(0>(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*F)O=ea,U=fa,V=W,M=Y,P=Z,L=ha,Q=da,T=pa,N=qa,f=ea-K,g=fa-x,k=W-F,h=X-K,l=D-x,m=E-F,v=g*m-k*l,m=k*h-f*m,h=f*l-g*h;else for(var $=!1;;){f=X-O;g=D-U;k=E-V;h=ea-O;l=fa-U;m=W-V;v=g*m-k*
l;m=k*h-f*m;h=f*l-g*h;f=1/OIMO.sqrt(v*v+m*m+h*h);v*=f;m*=f;h*=f;0<=v*O+m*U+h*V&&!$&&(u=(U*E-V*D)*ea+(V*X-O*E)*fa+(O*D-U*X)*W,$=(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*F,f=(x*V-F*U)*ea+(F*O-K*V)*fa+(K*U-x*O)*W,g=(D*V-E*U)*K+(E*O-X*V)*x+(X*U-D*O)*F,p=u+$+f+g,0>=p&&(u=0,$=(D*W-E*fa)*v+(E*ea-X*W)*m+(X*fa-D*ea)*h,f=(fa*E-W*D)*v+(W*X-ea*E)*m+(ea*D-fa*X)*h,g=(U*E-V*D)*v+(V*X-O*E)*m+(O*D-U*X)*h,p=$+f+g),k=1/p,p=(y*u+M*$+Ya*f+Y*g)*k,r=(B*u+P*$+Ca*f+Z*g)*k,q=(I*u+L*$+Da*f+ha*g)*k,t=(G*u+Q*$+Ea*f+da*g)*k,s=(C*
u+T*$+Ka*f+pa*g)*k,u=(J*u+N*$+La*f+qa*g)*k,$=!0);this.supportPoint(a,-v,-m,-h,n);f=n.x;g=n.y;k=n.z;this.supportPoint(c,v,m,h,n);l=n.x;var sa=n.y,ta=n.z,ya=l-f,za=sa-g,Aa=ta-k,yb=-(ya*v+za*m+Aa*h);if(0.01>=(ya-ea)*v+(za-fa)*m+(Aa-W)*h||0<=yb)return $?(b.init(-v,-m,-h),d.init(0.5*(p+t),0.5*(r+s),0.5*(q+u)),e.x=yb,!0):!1;0>(za*V-Aa*U)*K+(Aa*O-ya*V)*x+(ya*U-za*O)*F?0>(za*E-Aa*D)*K+(Aa*X-ya*E)*x+(ya*D-za*X)*F?(O=ya,U=za,V=Aa,M=f,P=g,L=k,Q=l,T=sa,N=ta):(ea=ya,fa=za,W=Aa,Y=f,Z=g,ha=k,da=l,pa=sa,qa=ta):0>
(za*W-Aa*fa)*K+(Aa*ea-ya*W)*x+(ya*fa-za*ea)*F?(X=ya,D=za,E=Aa,Ya=f,Ca=g,Da=k,Ea=l,Ka=sa,La=ta):(O=ya,U=za,V=Aa,M=f,P=g,L=k,Q=l,T=sa,N=ta)}}};
OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,k=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;b=g;g=c;c=b*b+g*g;var h=a.radius;d=a.halfHeight;0==c?(0>k?(b=h,d=-d):b=h,c=0):(c=a.radius/OIMO.sqrt(c),0>k?(b*=c,d=-d):b*=c,c*=g);g=f[0]*b+f[1]*d+f[2]*c+a.position.x;k=f[3]*b+f[4]*d+f[5]*c+a.position.y;c=f[6]*b+f[7]*d+f[8]*c+a.position.z;e.init(g,k,c)};
OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);c=d.position;a=e.position;var f=c.x,g=c.y,k=c.z,h=a.x,l=a.y,m=a.z,n=d.halfHeight,p=e.halfHeight,r=d.normalDirection,q=e.normalDirection,t=d.halfDirection,s=e.halfDirection;a=d.radius;c=e.radius;var u=r.x,y=r.y,r=r.z,B=q.x,I=q.y,q=q.z,G=t.x,C=t.y,J=t.z,K=s.x,x=s.y,F=s.z,t=f-h,v=g-l,M=k-m,P,L,Q,s=new OIMO.Vec3,M=new OIMO.Vec3,T=new OIMO.Vec3;if(this.getSep(d,e,s,M,T)){t=s.x*u+s.y*y+
s.z*r;v=s.x*B+s.y*I+s.z*q;P=0<t;L=0<v;P||(t=-t);L||(v=-v);Q=0;if(0.999<t||0.999<v)Q=t>v?1:2;var T=T.x,N;d=s.x;e=s.y;s=s.z;switch(Q){case 0:b.addPoint(M.x,M.y,M.z,d,e,s,T,!1);break;case 1:P?(f+=G,g+=C,k+=J,d=u,e=y,s=r):(f-=G,g-=C,k-=J,d=-u,e=-y,s=-r);Q=d*B+e*I+s*q;C=0>Q?p:-p;h+=C*B;l+=C*I;m+=C*q;0.999999<=v?(J=-e,G=s,x=d):(J=d,G=e,x=s);C=J*B+G*I+x*q;t=C*B-J;v=C*I-G;M=C*q-x;C=OIMO.sqrt(t*t+v*v+M*M);if(0==C)break;C=c/C;t*=C;v*=C;M*=C;J=h+t;G=l+v;x=m+M;if(-0.96>Q||0.96<Q)n=B*B*1.5-0.5,p=B*I*1.5-0.866025403*
q,F=B*q*1.5+0.866025403*I,K=I*B*1.5+0.866025403*q,P=I*I*1.5-0.5,L=I*q*1.5-0.866025403*B,Q=q*B*1.5-0.866025403*I,y=q*I*1.5+0.866025403*B,r=q*q*1.5-0.5,q=J,u=G,I=x,N=d*(q-f)+e*(u-g)+s*(I-k),J=q-N*d-f,G=u-N*e-g,x=I-N*s-k,C=J*J+G*G+x*x,C>a*a&&(C=a/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(f+J,g+G,k+x,d,e,s,N,!1),u=t*K+v*P+M*L,I=t*Q+v*y+M*r,q=(t=t*n+v*p+M*F)+h,u=(v=u)+l,I=(M=I)+m,N=d*(q-f)+e*(u-g)+s*(I-k),0>=N&&(J=q-N*d-f,G=u-N*e-g,x=I-N*s-k,C=J*J+G*G+x*x,C>a*a&&(C=a/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(f+
J,g+G,k+x,d,e,s,N,!1)),q=t*n+v*p+M*F+h,u=t*K+v*P+M*L+l,I=t*Q+v*y+M*r+m,N=d*(q-f)+e*(u-g)+s*(I-k),0>=N&&(J=q-N*d-f,G=u-N*e-g,x=I-N*s-k,C=J*J+G*G+x*x,C>a*a&&(C=a/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(f+J,g+G,k+x,d,e,s,N,!1));else{F=J;K=G;P=x;L=d*(F-f)+e*(K-g)+s*(P-k);F-=L*d;K-=L*e;P-=L*s;0<Q?(u=J+B*p*2,y=G+I*p*2,r=x+q*p*2):(u=J-B*p*2,y=G-I*p*2,r=x-q*p*2);q=d*(u-f)+e*(y-g)+s*(r-k);u-=q*d;y-=q*e;r-=q*s;t=f-F;v=g-K;M=k-P;J=u-F;G=y-K;x=r-P;I=t*J+v*G+M*x;B=J*J+G*G+x*x;c=I*I-B*(t*t+v*v+M*M-a*a);if(0>c)break;
c=OIMO.sqrt(c);a=(I+c)/B;c=(I-c)/B;c<a&&(C=a,a=c,c=C);1<c&&(c=1);0>a&&(a=0);J=F+(u-F)*a;G=K+(y-K)*a;x=P+(r-P)*a;u=F+(u-F)*c;y=K+(y-K)*c;r=P+(r-P)*c;C=L+(q-L)*a;q=L+(q-L)*c;0>C&&b.addPoint(J,G,x,d,e,s,N,!1);0>q&&b.addPoint(u,y,r,d,e,s,N,!1)}break;case 2:L?(h-=K,l-=x,m-=F,d=-B,e=-I,s=-q):(h+=K,l+=x,m+=F,d=B,e=I,s=q);Q=d*u+e*y+s*r;C=0>Q?n:-n;f+=C*u;g+=C*y;k+=C*r;0.999999<=t?(J=-e,G=s,x=d):(J=d,G=e,x=s);C=J*u+G*y+x*r;t=C*u-J;v=C*y-G;M=C*r-x;C=OIMO.sqrt(t*t+v*v+M*M);if(0==C)break;C=a/C;t*=C;v*=C;M*=C;
J=f+t;G=g+v;x=k+M;if(-0.96>Q||0.96<Q)n=u*u*1.5-0.5,p=u*y*1.5-0.866025403*r,F=u*r*1.5+0.866025403*y,K=y*u*1.5+0.866025403*r,P=y*y*1.5-0.5,L=y*r*1.5-0.866025403*u,Q=r*u*1.5-0.866025403*y,y=r*y*1.5+0.866025403*u,r=r*r*1.5-0.5,q=J,u=G,I=x,N=d*(q-h)+e*(u-l)+s*(I-m),J=q-N*d-h,G=u-N*e-l,x=I-N*s-m,C=J*J+G*G+x*x,C>c*c&&(C=c/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(h+J,l+G,m+x,-d,-e,-s,N,!1),u=t*K+v*P+M*L,I=t*Q+v*y+M*r,q=(t=t*n+v*p+M*F)+f,u=(v=u)+g,I=(M=I)+k,N=d*(q-h)+e*(u-l)+s*(I-m),0>=N&&(J=q-N*d-h,G=u-N*
e-l,x=I-N*s-m,C=J*J+G*G+x*x,C>c*c&&(C=c/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(h+J,l+G,m+x,-d,-e,-s,N,!1)),q=t*n+v*p+M*F+f,u=t*K+v*P+M*L+g,I=t*Q+v*y+M*r+k,N=d*(q-h)+e*(u-l)+s*(I-m),0>=N&&(J=q-N*d-h,G=u-N*e-l,x=I-N*s-m,C=J*J+G*G+x*x,C>c*c&&(C=c/OIMO.sqrt(C),J*=C,G*=C,x*=C),b.addPoint(h+J,l+G,m+x,-d,-e,-s,N,!1));else{F=J;K=G;P=x;L=d*(F-h)+e*(K-l)+s*(P-m);F-=L*d;K-=L*e;P-=L*s;0<Q?(u=J+u*n*2,y=G+y*n*2,r=x+r*n*2):(u=J-u*n*2,y=G-y*n*2,r=x-r*n*2);q=d*(u-h)+e*(y-l)+s*(r-m);u-=q*d;y-=q*e;r-=q*s;t=h-F;v=l-
K;M=m-P;J=u-F;G=y-K;x=r-P;I=t*J+v*G+M*x;B=J*J+G*G+x*x;c=I*I-B*(t*t+v*v+M*M-c*c);if(0>c)break;c=OIMO.sqrt(c);a=(I+c)/B;c=(I-c)/B;c<a&&(C=a,a=c,c=C);1<c&&(c=1);0>a&&(a=0);J=F+(u-F)*a;G=K+(y-K)*a;x=P+(r-P)*a;u=F+(u-F)*c;y=K+(y-K)*c;r=P+(r-P)*c;C=L+(q-L)*a;q=L+(q-L)*c;L=C;0>L&&b.addPoint(J,G,x,-d,-e,-s,L,!1);0>q&&b.addPoint(u,y,r,-d,-e,-s,q,!1)}}}};OIMO.SphereCylinderCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=d.position;a=f.x;c=f.y;var f=f.z,g=e.position,k=g.x,h=g.y,g=g.z,l=e.normalDirection.x,m=e.normalDirection.y,n=e.normalDirection.z;d=d.radius;var p=e.radius,r=d+p,q=e.halfHeight,t=(a-k)*l+(c-h)*m+(f-g)*n;if(!(t<-q-d||t>q+d)){var s=a-(k+t*l),u=c-(h+t*m),y=f-(g+t*n);e=s*s+u*u+y*y;e>r*r||(e>p*p&&(e=p/OIMO.sqrt(e),s*=e,u*=e,y*=e),t<-q?t=-q:t>q&&(t=q),k=k+t*l+s-a,h=h+t*m+u-c,g=g+t*
n+y-f,e=k*k+h*h+g*g,0<e&&e<d*d&&(e=OIMO.sqrt(e),n=1/e,k*=n,h*=n,g*=n,b.addPoint(a+k*d,c+h*d,f+g*d,k,h,g,e-d,this.flip)))}};OIMO.AABB=function(a,c,b,d,e,f){this.minX=a||0;this.maxX=c||0;this.minY=b||0;this.maxY=d||0;this.minZ=e||0;this.maxZ=f||0};
OIMO.AABB.prototype={constructor:OIMO.AABB,init:function(a,c,b,d,e,f){this.minX=a;this.maxX=c;this.minY=b;this.maxY=d;this.minZ=e;this.maxZ=f},combine:function(a,c){this.minX=a.minX<c.minX?a.minX:c.minX;this.maxX=a.maxX>c.maxX?a.maxX:c.maxX;this.minY=a.minY<c.minY?a.minY:c.minY;this.maxY=a.maxY>c.maxY?a.maxY:c.maxY;this.minZ=a.minZ<c.minZ?a.minZ:c.minZ;this.maxZ=a.maxZ>c.maxZ?a.maxZ:c.maxZ},surfaceArea:function(){var a=this.maxY-this.minY,c=this.maxZ-this.minZ;return 2*((this.maxX-this.minX)*(a+c)+
a*c)},intersectsWithPoint:function(a,c,b){return a>=this.minX&&a<=this.maxX&&c>=this.minY&&c<=this.maxY&&b>=this.minZ&&b<=this.maxZ}};OIMO.Proxy=function(a){this.shape=a;this.aabb=a.aabb};OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){throw Error("Inheritance error.");}};OIMO.BasicProxy=function(a){OIMO.Proxy.call(this,a)};OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.BasicProxy.prototype.update=function(){};OIMO.BroadPhase=function(){this.numPairs=this.numPairChecks=this.types=0;this.pairs=[]};
OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(a){throw Error("Inheritance error.");},addProxy:function(a){throw Error("Inheritance error.");},removeProxy:function(a){throw Error("Inheritance error.");},isAvailablePair:function(a,c){var b=a.parent,d=c.parent;if(b==d||!b.isDynamic&&!d.isDynamic||0==(a.belongsTo&c.collidesWith)||0==(c.belongsTo&a.collidesWith))return!1;var e;for(e=b.numJoints<d.numJoints?b.jointLink:d.jointLink;null!=e;){var f=e.joint;if(!f.allowCollision&&
(f.body1==b&&f.body2==d||f.body1==d&&f.body2==b))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[];this.numPairChecks=this.numPairs=0;this.collectPairs()},collectPairs:function(){throw Error("Inheritance error.");},addPair:function(a,c){var b=new OIMO.Pair(a,c);this.pairs.push(b);this.numPairs++}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=1;this.numProxies=0;this.maxProxies=256;this.proxies=[];this.proxies.length=256};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.createProxy=function(a){return new OIMO.BasicProxy(a)};
OIMO.BruteForceBroadPhase.prototype.addProxy=function(a){if(this.numProxies==this.maxProxies){this.maxProxies*=2;var c=[];c.length=this.maxProxies;for(var b=this.numProxies;b--;)c[b]=this.proxies[b];this.proxies=c}this.proxies[this.numProxies++]=a};OIMO.BruteForceBroadPhase.prototype.removeProxy=function(a){for(var c=this.numProxies;c--;)if(this.proxies[c]==a){this.proxies[c]=this.proxies[--this.numProxies];this.proxies[this.numProxies]=null;break}};
OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){this.numPairChecks=this.numProxies*(this.numProxies-1)>>1;for(var a=this.numProxies;a--;)for(var c=this.proxies[a],b=c.aabb,c=c.shape,d=this.numProxies;d--;)if(d!==a){var e=this.proxies[d],f=e.aabb,e=e.shape;b.maxX<f.minX||b.minX>f.maxX||b.maxY<f.minY||b.minY>f.maxY||b.maxZ<f.minZ||b.minZ>f.maxZ||!this.isAvailablePair(c,e)||this.addPair(c,e)}};OIMO.Pair=function(a,c){this.shape1=a||null;this.shape2=c||null};OIMO.SAPAxis=function(){this.numElements=0;this.bufferSize=256;this.elements=[];this.elements.length=this.bufferSize;this.stack=new OIMO_ARRAY_TYPE(64)};
OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(a,c){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var b=this.numElements;b--;);}this.elements[this.numElements++]=a;this.elements[this.numElements++]=c},removeElements:function(a,c){for(var b=-1,d=-1,e=0,f=this.numElements;e<f;e++){var g=this.elements[e];if(g==a||g==c)if(-1==b)b=e;else{d=e;break}}e=b+1;for(f=d;e<f;e++)this.elements[e-1]=this.elements[e];e=d+1;for(f=this.numElements;e<f;e++)this.elements[e-2]=this.elements[e];
this.elements[--this.numElements]=null;this.elements[--this.numElements]=null},sort:function(){for(var a=0,c=1;0!=this.numElements>>c;)c++;for(var c=c*this.numElements>>2,a=0,b=!1,d=this.elements,e=1,f=this.numElements;e<f;e++){var g=d[e],k=g.value,h=d[e-1];if(h.value>k){var l=e;do{d[l]=h;if(0==--l)break;h=d[l-1]}while(h.value>k);d[l]=g;a+=e-l;if(a>c){b=!0;break}}}if(b)for(a=2,c=this.stack,c[0]=0,c[1]=this.numElements-1;0<a;)if(b=c[--a],h=c[--a],g=b-h,16<g){e=h+Math.floor(0.5*g);g=d[e];d[e]=d[b];
d[b]=g;k=g.value;e=h-1;for(l=b;;){var m;do f=d[++e];while(f.value<k);do m=d[--l];while(k<m.value&&l!=h);if(e>=l)break;d[e]=m;d[l]=f}d[b]=d[e];d[e]=g;e-h>b-e?(c[a++]=h,c[a++]=e-1,c[a++]=e+1,c[a++]=b):(c[a++]=e+1,c[a++]=b,c[a++]=h,c[a++]=e-1)}else for(e=h+1;e<=b;e++)if(g=d[e],k=g.value,h=d[e-1],h.value>k){l=e;do{d[l]=h;if(0==--l)break;h=d[l-1]}while(h.value>k);d[l]=g}},calculateTestCount:function(){for(var a=1,c=0,b=1,d=this.numElements;b<d;b++)this.elements[b].max?a--:(c+=a,a++);return c}};OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=2;this.numElementsS=this.numElementsD=0;this.axesD=[];this.axesS=[];this.axesD.length=3;this.axesS.length=3;this.axesD[0]=new OIMO.SAPAxis;this.axesD[1]=new OIMO.SAPAxis;this.axesD[2]=new OIMO.SAPAxis;this.axesS[0]=new OIMO.SAPAxis;this.axesS[1]=new OIMO.SAPAxis;this.axesS[2]=new OIMO.SAPAxis;this.index1=0;this.index2=1};OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);
OIMO.SAPBroadPhase.prototype.createProxy=function(a){return new OIMO.SAPProxy(this,a)};OIMO.SAPBroadPhase.prototype.addProxy=function(a){a.isDynamic()?(this.axesD[0].addElements(a.min[0],a.max[0]),this.axesD[1].addElements(a.min[1],a.max[1]),this.axesD[2].addElements(a.min[2],a.max[2]),a.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(a.min[0],a.max[0]),this.axesS[1].addElements(a.min[1],a.max[1]),this.axesS[2].addElements(a.min[2],a.max[2]),a.belongsTo=2,this.numElementsS+=2)};
OIMO.SAPBroadPhase.prototype.removeProxy=function(a){if(0!=a.belongsTo){switch(a.belongsTo){case 1:this.axesD[0].removeElements(a.min[0],a.max[0]);this.axesD[1].removeElements(a.min[1],a.max[1]);this.axesD[2].removeElements(a.min[2],a.max[2]);this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(a.min[0],a.max[0]),this.axesS[1].removeElements(a.min[1],a.max[1]),this.axesS[2].removeElements(a.min[2],a.max[2]),this.numElementsS-=2}a.belongsTo=0}};
OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var a=this.axesD[this.index1],c=this.axesD[this.index2];a.sort();c.sort();var b=a.calculateTestCount(),d=c.calculateTestCount();b<=d?(c=this.axesS[this.index1],c.sort(),b=a.elements,a=c.elements):(a=this.axesS[this.index2],a.sort(),b=c.elements,a=a.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var e,f,d=c=0;c<this.numElementsD;){var g,k;d==this.numElementsS?(g=b[c],k=!0,c++):(g=
b[c],k=a[d],g.value<k.value?(k=!0,c++):(g=k,k=!1,d++));if(g.max){var h=g.pair;if(k)if(h==e){e=e.pair;continue}else g=e;else if(h==f){f=f.pair;continue}else g=f;do{r=g.pair;if(r===h){g.pair=r.pair;break}g=r}while(null!==g)}else{for(var h=g.proxy.shape,l=g.min1.value,m=g.max1.value,n=g.min2.value,p=g.max2.value,r=e;null!=r;r=r.pair){var q=r.proxy.shape;this.numPairChecks++;l>r.max1.value||m<r.min1.value||n>r.max2.value||p<r.min2.value||!this.isAvailablePair(h,q)||this.addPair(h,q)}if(k){for(r=f;null!=
r;r=r.pair)q=r.proxy.shape,this.numPairChecks++,l>r.max1.value||m<r.min1.value||n>r.max2.value||p<r.min2.value||!this.isAvailablePair(h,q)||this.addPair(h,q);g.pair=e;e=g}else g.pair=f,f=g}}this.index2=(this.index1|this.index2)^3}};OIMO.SAPElement=function(a,c){this.proxy=a;this.max2=this.min2=this.max1=this.min1=this.pair=null;this.max=c;this.value=0};OIMO.SAPProxy=function(a,c){OIMO.Proxy.call(this,c);this.belongsTo=0;this.max=[];this.min=[];this.sap=a;this.min[0]=new OIMO.SAPElement(this,!1);this.max[0]=new OIMO.SAPElement(this,!0);this.min[1]=new OIMO.SAPElement(this,!1);this.max[1]=new OIMO.SAPElement(this,!0);this.min[2]=new OIMO.SAPElement(this,!1);this.max[2]=new OIMO.SAPElement(this,!0);this.max[0].pair=this.min[0];this.max[1].pair=this.min[1];this.max[2].pair=this.min[2];this.min[0].min1=this.min[1];this.min[0].max1=this.max[1];this.min[0].min2=
this.min[2];this.min[0].max2=this.max[2];this.min[1].min1=this.min[0];this.min[1].max1=this.max[0];this.min[1].min2=this.min[2];this.min[1].max2=this.max[2];this.min[2].min1=this.min[0];this.min[2].max1=this.max[0];this.min[2].min2=this.min[1];this.min[2].max2=this.max[1]};OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.SAPProxy.prototype.isDynamic=function(){var a=this.shape.parent;return a.isDynamic&&!a.sleeping};
OIMO.SAPProxy.prototype.update=function(){this.min[0].value=this.aabb.minX;this.max[0].value=this.aabb.maxX;this.min[1].value=this.aabb.minY;this.max[1].value=this.aabb.maxY;this.min[2].value=this.aabb.minZ;this.max[2].value=this.aabb.maxZ;if(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())this.sap.removeProxy(this),this.sap.addProxy(this)};OIMO.DBVT=function(){this.root=null;this.freeNodes=[];this.freeNodes.length=16384;this.numFreeNodes=0;this.aabb=new OIMO.AABB};
OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(a){this.deleteLeaf(a);this.insertLeaf(a)},insertLeaf:function(a){if(null==this.root)this.root=a;else{for(var c=a.aabb,b=this.root,d,e;null==b.proxy;){var f=b.child1,g=b.child2,k=b.aabb,h=f.aabb,l=g.aabb;d=k.surfaceArea();this.aabb.combine(c,k);e=this.aabb.surfaceArea();k=2*e;d=e=2*(e-d);this.aabb.combine(c,h);d=null!=f.proxy?d+this.aabb.surfaceArea():d+(this.aabb.surfaceArea()-h.surfaceArea());h=e;this.aabb.combine(c,l);h=null!=g.proxy?
h+this.aabb.surfaceArea():h+(this.aabb.surfaceArea()-l.surfaceArea());if(d<h)if(k<d)break;else b=f;else if(k<h)break;else b=g}c=b.parent;f=0<this.numFreeNodes?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode;f.parent=c;f.child1=a;f.child2=b;f.aabb.combine(a.aabb,b.aabb);f.height=b.height+1;b.parent=f;a.parent=f;b==this.root?this.root=f:c.child1==b?c.child1=f:c.child2=f;do f=this.balance(f),this.fix(f),f=f.parent;while(null!=f)}},getBalance:function(a){return null!=a.proxy?0:a.child1.height-a.child2.height},
print:function(a,c,b){var d=null==a.proxy;d&&(b=this.print(a.child1,c+1,b));for(var e=2*c;0<=e;e--)b+=" ";b+=(d?this.getBalance(a):"["+a.proxy.aabb.minX+"]")+"\n";d&&(b=this.print(a.child2,c+1,b));return b},deleteLeaf:function(a){if(a==this.root)this.root=null;else{var c=a.parent;a=c.child1==a?c.child2:c.child1;if(c==this.root)this.root=a,a.parent=null;else{var b=c.parent;a.parent=b;b.child1==c?b.child1=a:b.child2=a;16384>this.numFreeNodes&&(this.freeNodes[this.numFreeNodes++]=c);do b=this.balance(b),
this.fix(b),b=b.parent;while(null!=b)}}},balance:function(a){var c=a.height;if(2>c)return a;var b=a.parent,d=a.child1,e=a.child2,f=d.height,g=e.height,k=f-g;if(1<k){var f=d.child1,k=d.child2,h=f.height,l=k.height;h>l?(d.child2=a,a.parent=d,a.child1=k,k.parent=a,a.aabb.combine(k.aabb,e.aabb),g=l-g,a.height=l-(g&g>>31)+1,d.aabb.combine(f.aabb,a.aabb),g=h-c,d.height=h-(g&g>>31)+1):(d.child1=a,a.parent=d,a.child1=f,f.parent=a,a.aabb.combine(f.aabb,e.aabb),g=h-g,a.height=h-(g&g>>31)+1,d.aabb.combine(a.aabb,
k.aabb),g=c-l,d.height=c-(g&g>>31)+1);null!=b?b.child1==a?b.child1=d:b.child2=d:this.root=d;d.parent=b;return d}if(-1>k){var k=e.child1,h=e.child2,l=k.height,m=h.height;l>m?(e.child2=a,a.parent=e,a.child2=h,h.parent=a,a.aabb.combine(d.aabb,h.aabb),g=f-m,a.height=f-(g&g>>31)+1,e.aabb.combine(k.aabb,a.aabb),g=l-c,e.height=l-(g&g>>31)+1):(e.child1=a,a.parent=e,a.child2=k,k.parent=a,a.aabb.combine(d.aabb,k.aabb),g=f-l,a.height=f-(g&g>>31)+1,e.aabb.combine(a.aabb,h.aabb),g=c-m,e.height=c-(g&g>>31)+1);
null!=b?b.child1==a?b.child1=e:b.child2=e:this.root=e;e.parent=b;return e}return a},fix:function(a){var c=a.child1,b=a.child2;a.aabb.combine(c.aabb,b.aabb);c=c.height;b=b.height;a.height=c<b?b+1:c+1}};OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=3;this.maxLeaves=this.numLeaves=0;this.tree=new OIMO.DBVT;this.maxStack=256;this.stack=[];this.stack.length=this.maxStack;this.maxLeaves=256;this.leaves=[];this.leaves.length=this.maxLeaves};OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.DBVTBroadPhase.prototype.createProxy=function(a){return new OIMO.DBVTProxy(a)};
OIMO.DBVTBroadPhase.prototype.addProxy=function(a){this.tree.insertLeaf(a.leaf);if(this.numLeaves==this.maxLeaves){this.maxLeaves*=2;var c=[];c.length=this.maxLeaves;for(var b=0;b<this.numLeaves;b++)c[b]=this.leaves[b];this.leaves=c}this.leaves[this.numLeaves++]=a.leaf};OIMO.DBVTBroadPhase.prototype.removeProxy=function(a){this.tree.deleteLeaf(a.leaf);for(var c=0;c<this.numLeaves;c++)if(this.leaves[c]==a.leaf){this.leaves[c]=this.leaves[--this.numLeaves];this.leaves[this.numLeaves]=null;break}};
OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(2>this.numLeaves))for(var a=0;a<this.numLeaves;a++){var c=this.leaves[a],b=c.proxy.aabb,d=c.aabb;if(b.minX<d.minX||b.maxX>d.maxX||b.minY<d.minY||b.maxY>d.maxY||b.minZ<d.minZ||b.maxZ>d.maxZ)this.tree.deleteLeaf(c),d.minX=b.minX-0.1,d.maxX=b.maxX+0.1,d.minY=b.minY-0.1,d.maxY=b.maxY+0.1,d.minZ=b.minZ-0.1,d.maxZ=b.maxZ+0.1,this.tree.insertLeaf(c),this.collide(c,this.tree.root)}};
OIMO.DBVTBroadPhase.prototype.collide=function(a,c){var b=2;this.stack[0]=a;for(this.stack[1]=c;0<b;){var d=this.stack[--b],e=this.stack[--b],f=null!=d.proxy,g=null!=e.proxy;this.numPairChecks++;if(f&&g){var d=d.proxy.shape,e=e.proxy.shape,k=d.aabb,h=e.aabb;d==e||k.maxX<h.minX||k.minX>h.maxX||k.maxY<h.minY||k.minY>h.maxY||k.maxZ<h.minZ||k.minZ>h.maxZ||!this.isAvailablePair(d,e)||this.addPair(d,e)}else if(k=d.aabb,h=e.aabb,!(k.maxX<h.minX||k.minX>h.maxX||k.maxY<h.minY||k.minY>h.maxY||k.maxZ<h.minZ||
k.minZ>h.maxZ)){if(b+4>=this.maxStack){this.maxStack*=2;k=[];k.length=this.maxStack;for(h=0;h<b;h++)k[h]=this.stack[h];this.stack=k}g||!f&&d.aabb.surfaceArea()>e.aabb.surfaceArea()?(this.stack[b++]=d.child1,this.stack[b++]=e,this.stack[b++]=d.child2,this.stack[b++]=e):(this.stack[b++]=d,this.stack[b++]=e.child1,this.stack[b++]=d,this.stack[b++]=e.child2)}}};OIMO.DBVTNode=function(){this.proxy=this.parent=this.child2=this.child1=null;this.height=0;this.aabb=new OIMO.AABB};OIMO.DBVTProxy=function(a){OIMO.Proxy.call(this,a);this.leaf=new OIMO.DBVTNode;this.leaf.proxy=this};OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.DBVTProxy.prototype.update=function(){};OIMO.World.prototype.add=function(a){a=a||{};var c=a.type||"box";"string"===typeof c&&(c=[c]);if("joint"==c[0].substring(0,5)){var b=a.axe1||[1,0,0],d=a.axe2||[1,0,0],e=a.pos1||[0,0,0],f=a.pos2||[0,0,0],e=e.map(function(a){return a*OIMO.INV_SCALE}),f=f.map(function(a){return a*OIMO.INV_SCALE}),g,k;"jointDistance"===c[0]?(g=a.min||0,k=a.max||10,g*=OIMO.INV_SCALE,k*=OIMO.INV_SCALE):(g=a.min||57.29578,k=a.max||0,g*=OIMO.degtorad,k*=OIMO.degtorad);var h=a.limit||null,l=a.spring||null,m=a.motor||null,
n=new OIMO.JointConfig;n.allowCollision=a.collision||!1;n.localAxis1.init(b[0],b[1],b[2]);n.localAxis2.init(d[0],d[1],d[2]);n.localAnchorPoint1.init(e[0],e[1],e[2]);n.localAnchorPoint2.init(f[0],f[1],f[2]);if("string"==typeof a.body1||a.body1 instanceof String)a.body1=a.world.getByName(a.body1);if("string"==typeof a.body2||a.body2 instanceof String)a.body2=a.world.getByName(a.body2);n.body1=a.body1;n.body2=a.body2;var p;switch(c[0]){case "jointDistance":p=new OIMO.DistanceJoint(n,g,k);null!==l&&p.limitMotor.setSpring(l[0],
l[1]);null!==m&&p.limitMotor.setSpring(m[0],m[1]);break;case "jointHinge":p=new OIMO.HingeJoint(n,g,k);null!==l&&p.limitMotor.setSpring(l[0],l[1]);null!==m&&p.limitMotor.setSpring(m[0],m[1]);break;case "jointPrisme":p=new OIMO.PrismaticJoint(n,g,k);break;case "jointSlide":p=new OIMO.SliderJoint(n,g,k);break;case "jointBall":p=new OIMO.BallAndSocketJoint(n);break;case "jointWheel":p=new OIMO.WheelJoint(n),null!==h&&p.rotationalLimitMotor1.setLimit(h[0],h[1]),null!==l&&p.rotationalLimitMotor1.setSpring(l[0],
l[1]),null!==m&&p.rotationalLimitMotor1.setSpring(m[0],m[1])}p.name=a.name||"";this.addJoint(p);return p}b=a.move||!1;d=a.noSleep||!1;e=a.pos||[0,0,0];e=e.map(function(a){return a*OIMO.INV_SCALE});f=a.size||[1,1,1];f=f.map(function(a){return a*OIMO.INV_SCALE});h=a.rot||[0,0,0];h=h.map(function(a){return a*OIMO.degtorad});g=[];for(k=0;k<h.length/3;k++)l=OIMO.EulerToAxis(h[k+0],h[k+1],h[k+2]),g.push(l[0]),g.push(l[1]),g.push(l[2]),g.push(l[3]);h=a.sc||new OIMO.ShapeConfig;a.config&&(h.density=void 0===
a.config[0]?1:a.config[0],h.friction=void 0===a.config[1]?0.4:a.config[1],h.restitution=void 0===a.config[2]?0.2:a.config[2],h.belongsTo=a.config[3]||1,h.collidesWith=a.config[4]||4294967295);a.massPos&&(a.massPos=a.massPos.map(function(a){return a*OIMO.INV_SCALE}),h.relativePosition.init(a.massPos[0],a.massPos[1],a.massPos[2]));a.massRot&&(a.massRot=a.massRot.map(function(a){return a*OIMO.degtorad}),h.relativeRotation=OIMO.EulerToMatrix(a.massRot[0],a.massRot[1],a.massRot[2]));l=new OIMO.RigidBody(e[0],
e[1],e[2],g[0],g[1],g[2],g[3]);m=[];for(k=0;k<c.length;k++){n=3*k;p=4*k;switch(c[k]){case "sphere":m[k]=new OIMO.SphereShape(h,f[n]);break;case "cylinder":m[k]=new OIMO.BoxShape(h,f[n],f[n+1],f[n]);break;case "cylinderTrue":m[k]=new OIMO.CylinderShape(h,f[n],f[n+1]);break;case "box":m[k]=new OIMO.BoxShape(h,f[n],f[n+1],f[n+2])}l.addShape(m[k]);0<k&&(m[k].relativePosition=new OIMO.Vec3(e[n],e[n+1],e[n+2]),g[p+0]&&(m[k].relativeRotation=[g[p],g[p+1],g[p+2],g[p+3]]))}b?(a.massPos||a.massRot?l.setupMass(1,
!1):l.setupMass(1,!0),l.allowSleep=d?!1:!0):l.setupMass(2);l.name=a.name||"";this.addRigidBody(l);return l};
