'use strict';var OIMO={REVISION:"DEV.1.1.2b",SHAPE_SPHERE:1,SHAPE_BOX:2,WORLD_SCALE:100,INV_SCALE:0.01,TO_RAD:0.017453292519943295,AABB_PROX:0.005};OIMO.sqrt=Math.sqrt;OIMO.abs=Math.abs;OIMO.floor=Math.floor;OIMO.cos=Math.cos;OIMO.sin=Math.sin;OIMO.acos=Math.acos;OIMO.asin=Math.asin;OIMO.atan2=Math.atan2;OIMO.round=Math.round;OIMO.pow=Math.pow;OIMO.max=Math.max;OIMO.min=Math.min;OIMO.random=Math.random;OIMO.lerp=function(a,c,b){return a+(c-a)*b};OIMO.rand=function(a,c){return OIMO.lerp(a,c,OIMO.random())};
OIMO.randInt=function(a,c,b){return 1*OIMO.lerp(a,c,OIMO.random()).toFixed(b||0)};OIMO.degtorad=0.017453292519943295;OIMO.radtodeg=57.29577951308232;OIMO.PI=3.141592653589793;OIMO.TwoPI=6.283185307179586;OIMO.PI90=1.570796326794896;OIMO.PI270=4.712388980384689;OIMO.nextID=0;var OIMO_ARRAY_TYPE;OIMO_ARRAY_TYPE||(OIMO_ARRAY_TYPE="undefined"!==typeof Float32Array?Float32Array:Array);OIMO.World=function(a,c,b,d){this.timeStep=a||1/60;this.numIterations=b||8;switch(c||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.enableRandomizer=!0;this.isNoStat=d||!1;this.rigidBodies=null;this.numRigidBodies=0;this.unusedContacts=this.contacts=null;this.numContactPoints=this.numContacts=0;this.joints=null;this.numIslands=this.numJoints=0;this.gravity=new OIMO.Vec3(0,-9.80665,
0);this.performance=null;this.isNoStat||(this.performance=new OIMO.Performance(this));this.detectors=[];for(a=this.detectors.length=3;a--;)this.detectors[a]=[],this.detectors[a].length=3;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=
new OIMO.BoxBoxCollisionDetector;this.randX=65535;this.randA=98765;this.randB=123456789;this.maxIslandRigidBodies=64;this.islandRigidBodies=[];this.islandRigidBodies.length=this.maxIslandRigidBodies;this.islandStack=[];this.islandStack.length=this.maxIslandRigidBodies;this.maxIslandConstraints=128;this.islandConstraints=[];this.islandConstraints.length=this.maxIslandConstraints};
OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0},addRigidBody:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the rigid body");a.parent=this;a.awake();for(var c=a.shapes;null!==c;c=c.next)this.addShape(c);null!==this.rigidBodies&&
((this.rigidBodies.prev=a).next=this.rigidBodies);this.rigidBodies=a;this.numRigidBodies++},removeRigidBody:function(a){if(a.parent===this){a.awake();for(var c=a.jointLink;null!=c;){var b=c.joint,c=c.next;this.removeJoint(b)}for(c=a.shapes;null!==c;c=c.next)this.removeShape(c);c=a.prev;b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.rigidBodies==a&&(this.rigidBodies=b);a.prev=null;a.next=null;a.parent=null;this.numRigidBodies--}},getByName:function(a){for(var c=null,b=this.rigidBodies;null!==
b;)" "!==b.name&&b.name===a&&(c=b),b=b.next;for(b=this.joints;null!==b;)""!==b.name&&b.name===a&&(c=b),b=b.next;return c},addShape:function(a){if(!a.parent||!a.parent.parent)throw Error("It is not possible to be added alone to shape world");a.proxy=this.broadPhase.createProxy(a);a.updateProxy();this.broadPhase.addProxy(a.proxy)},removeShape:function(a){this.broadPhase.removeProxy(a.proxy);a.proxy=null},addJoint:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the joint");
null!=this.joints&&((this.joints.prev=a).next=this.joints);this.joints=a;a.parent=this;this.numJoints++;a.awake();a.attach()},removeJoint:function(a){var c=a.prev,b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.joints==a&&(this.joints=b);a.prev=null;a.next=null;this.numJoints--;a.awake();a.detach();a.parent=null},worldscale:function(a){OIMO.WORLD_SCALE=a||100;OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},step:function(){var a,c,b;this.isNoStat||(a=Date.now());for(var d=this.rigidBodies;null!==d;)d.addedToIsland=
!1,d.sleeping&&(d.linearVelocity.testZero()||d.position.testDiff(d.sleepPosition)||d.orientation.testDiff(d.sleepOrientation))&&d.awake(),d=d.next;this.isNoStat||(c=Date.now());this.broadPhase.detectPairs();for(var e=this.broadPhase.pairs,g=this.broadPhase.numPairs;g--;){var f=e[g],h;f.shape1.id<f.shape2.id?(h=f.shape1,d=f.shape2):(h=f.shape2,d=f.shape1);var k;k=h.numContacts<d.numContacts?h.contactLink:d.contactLink;for(var l=!1;k;){f=k.contact;if(f.shape1==h&&f.shape2==d){l=f.persisting=!0;break}k=
k.next}l||this.addContact(h,d)}this.isNoStat||(b=Date.now(),this.performance.broadPhaseTime=b-c);this.numContactPoints=0;for(f=this.contacts;null!==f;){if(!f.persisting&&(c=f.shape1.aabb,e=f.shape2.aabb,c.minX>e.maxX||c.maxX<e.minX||c.minY>e.maxY||c.maxY<e.minY||c.minZ>e.maxZ||c.maxZ<e.minZ)){k=f.next;this.removeContact(f);f=k;continue}c=f.body1;e=f.body2;(c.isDynamic&&!c.sleeping||e.isDynamic&&!e.sleeping)&&f.updateManifold();this.numContactPoints+=f.manifold.numPoints;f.persisting=!1;f.constraint.addedToIsland=
!1;f=f.next}this.isNoStat||(c=Date.now(),this.performance.narrowPhaseTime=c-b);b=1/this.timeStep;for(c=this.joints;null!==c;c=c.next)c.addedToIsland=!1;this.maxIslandRigidBodies<this.numRigidBodies&&(this.maxIslandRigidBodies=this.numRigidBodies<<1,this.islandRigidBodies=[],this.islandStack=[],this.islandRigidBodies.length=this.maxIslandRigidBodies,this.islandStack.length=this.maxIslandRigidBodies);c=this.numJoints+this.numContacts;this.maxIslandConstraints<c&&(this.maxIslandConstraints=c<<1,this.islandConstraints=
[],this.islandConstraints.length=this.maxIslandConstraints);c=Date.now();this.numIslands=0;for(e=this.rigidBodies;null!==e;e=e.next)if(!(e.addedToIsland||e.isStatic||e.sleeping)){if(e.isLonely())e.isDynamic&&e.linearVelocity.addTime(this.gravity,this.timeStep),this.calSleep(e)?(e.sleepTime+=this.timeStep,0.5<e.sleepTime?e.sleep():e.updatePosition(this.timeStep)):(e.sleepTime=0,e.updatePosition(this.timeStep));else{h=g=0;l=1;this.islandStack[0]=e;e.addedToIsland=!0;do if(d=this.islandStack[--l],this.islandStack[l]=
null,d.sleeping=!1,this.islandRigidBodies[g++]=d,!d.isStatic){for(var p=d.contactLink;null!==p;p=p.next)f=p.contact,k=f.constraint,!k.addedToIsland&&f.touching&&(this.islandConstraints[h++]=k,k.addedToIsland=!0,k=p.body,k.addedToIsland||(this.islandStack[l++]=k,k.addedToIsland=!0));for(f=d.jointLink;null!==f;f=f.next)k=f.joint,k.addedToIsland||(this.islandConstraints[h++]=k,k.addedToIsland=!0,k=f.body,!k.addedToIsland&&k.isDynamic&&(this.islandStack[l++]=k,k.addedToIsland=!0))}while(0!=l);k=(new OIMO.Vec3).addTime(this.gravity,
this.timeStep);for(f=g;f--;)d=this.islandRigidBodies[f],d.isDynamic&&d.linearVelocity.addEqual(k);if(this.enableRandomizer)for(f=h;f--;)0!==f&&(d=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*f|0,k=this.islandConstraints[f],this.islandConstraints[f]=this.islandConstraints[d],this.islandConstraints[d]=k);for(f=h;f--;)this.islandConstraints[f].preSolve(this.timeStep,b);for(d=this.numIterations;d--;)for(f=h;f--;)this.islandConstraints[f].solve();for(f=h;f--;)this.islandConstraints[f].postSolve(),
this.islandConstraints[f]=null;h=10;for(f=g;f--;)d=this.islandRigidBodies[f],this.calSleep(d)?(d.sleepTime+=this.timeStep,d.sleepTime<h&&(h=d.sleepTime)):h=d.sleepTime=0;if(0.5<h)for(f=g;f--;)this.islandRigidBodies[f].sleep(),this.islandRigidBodies[f]=null;else for(f=g;f--;)this.islandRigidBodies[f].updatePosition(this.timeStep),this.islandRigidBodies[f]=null}this.numIslands++}this.isNoStat||(b=Date.now(),this.performance.solvingTime=b-c,b=Date.now(),this.performance.upfps(),this.performance.totalTime=
b-a,this.performance.updatingTime=this.performance.totalTime-(this.performance.broadPhaseTime+this.performance.narrowPhaseTime+this.performance.solvingTime))},addContact:function(a,c){var b;null!==this.unusedContacts?(b=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):b=new OIMO.Contact;b.attach(a,c);b.detector=this.detectors[a.type][c.type];this.contacts&&((this.contacts.prev=b).next=this.contacts);this.contacts=b;this.numContacts++},removeContact:function(a){var c=a.prev,b=a.next;
b&&(b.prev=c);c&&(c.next=b);this.contacts==a&&(this.contacts=b);a.prev=null;a.next=null;a.detach();a.next=this.unusedContacts;this.unusedContacts=a;this.numContacts--},checkContact:function(a,c){for(var b,d,e=this.contacts;null!==e;)if(b=e.body1.name||" ",d=e.body2.name||" ",b==a&&d==c||d==a&&b==c){if(e.touching)return!0;break}else e=e.next;return!1},calSleep:function(a){return!a.allowSleep||0.04<a.linearVelocity.len()||0.25<a.angularVelocity.len()?!1:!0}};OIMO.RigidBody=function(a,c,b,d,e,g,f){d=d||0;e=e||0;g=g||0;f=f||0;a=a||0;c=c||0;b=b||0;this.name=" ";this.BODY_DYNAMIC=1;this.BODY_STATIC=2;this.MAX_SHAPES=64;this.next=this.prev=null;this.type=0;this.massInfo=new OIMO.MassInfo;this.position=new OIMO.Vec3(a,c,b);this.newPosition=new OIMO.Vec3(0,0,0);this.controlPos=!1;this.newOrientation=new OIMO.Quat;this.newRotation=new OIMO.Vec3(0,0,0);this.currentRotation=new OIMO.Vec3(0,0,0);this.controlRotInTime=this.controlRot=!1;this.orientation=this.rotationAxisToQuad(d,
e,g,f);this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;this.matrix=new OIMO.Mat44;this.contactLink=this.parent=null;this.numContacts=0;this.shapes=null;this.numShapes=0;this.jointLink=null;this.numJoints=0;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.isDynamic=this.isStatic=!1;this.rotation=new OIMO.Mat33;this.inverseMass=this.mass=NaN;this.inverseInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.inverseLocalInertia=new OIMO.Mat33;this.addedToIsland=
!1;this.allowSleep=!0;this.sleepTime=0;this.sleeping=!1};
OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(a){if(a.parent)throw Error("It is not possible that you add to the multi-rigid body the shape of one");null!=this.shapes&&((this.shapes.prev=a).next=this.shapes);this.shapes=a;a.parent=this;this.parent&&this.parent.addShape(a);this.numShapes++},removeShape:function(a){if(a.parent==this){var c=a.prev,b=a.next;null!=c&&(c.next=b);null!=b&&(b.prev=c);this.shapes==a&&(this.shapes=b);a.prev=null;a.next=null;a.parent=null;this.parent&&
this.parent.removeShape(a);this.numShapes--}},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(a){this.parent.checkContact(this.name,a)},setupMass:function(a,c){var b=void 0!==c?c:!0,d=a||this.BODY_DYNAMIC;this.type=d;this.isDynamic=d==this.BODY_DYNAMIC;this.isStatic=d==this.BODY_STATIC;this.mass=0;this.localInertia.init(0,0,0,0,0,0,0,0,0);for(var e=this.localInertia.elements,g=new OIMO.Mat33,f=new OIMO.Vec3,h=this.shapes;null!=h;h=h.next){h.calculateMassInfo(this.massInfo);
var k=this.massInfo.mass,l=h.relativePosition.x,p=h.relativePosition.y,n=h.relativePosition.z;f.addScale(h.relativePosition,k);this.mass+=k;this.rotateInertia(h.relativeRotation,this.massInfo.inertia,g);this.localInertia.addEqual(g);e[0]+=k*(p*p+n*n);e[4]+=k*(l*l+n*n);e[8]+=k*(l*l+p*p);var m=k*l*p,p=k*p*n,k=k*n*l;e[1]-=m;e[3]-=m;e[2]-=p;e[6]-=p;e[5]-=k;e[7]-=k}this.inverseMass=1/this.mass;f.scaleEqual(this.inverseMass);if(b){this.position.addEqual(f);for(h=this.shapes;null!=h;h=h.next)h.relativePosition.subEqual(f);
l=f.x;p=f.y;n=f.z;e[0]-=this.mass*(p*p+n*n);e[4]-=this.mass*(l*l+n*n);e[8]-=this.mass*(l*l+p*p);m=this.mass*l*p;p=this.mass*p*n;k=this.mass*n*l;e[1]+=m;e[3]+=m;e[2]+=p;e[6]+=p;e[5]+=k;e[7]+=k}this.inverseLocalInertia.invert(this.localInertia);d==this.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.init(0,0,0,0,0,0,0,0,0));this.syncShapes();this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1;this.sleepTime=0;for(var a=this.contactLink;null!=a;)a.body.sleepTime=
0,a.body.sleeping=!1,a=a.next;for(a=this.jointLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;for(a=this.shapes;null!=a;a=a.next)a.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.init();this.angularVelocity.init();this.sleepPosition.copy(this.position);this.sleepOrientation.copy(this.orientation);this.sleepTime=0;this.sleeping=!0;for(var a=this.shapes;null!=a;a=a.next)a.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},
updatePosition:function(a){switch(this.type){case this.BODY_STATIC:this.linearVelocity.init();this.angularVelocity.init();this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1);this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case this.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.init(),this.linearVelocity.init(),this.linearVelocity.x=(this.newPosition.x-this.position.x)/a,this.linearVelocity.y=(this.newPosition.y-this.position.y)/a,
this.linearVelocity.z=(this.newPosition.z-this.position.z)/a,this.controlPos=!1);this.controlRot&&(this.angularVelocity.init(),this.orientation.copy(this.newOrientation),this.controlRot=!1);this.position.addTime(this.linearVelocity,a);this.orientation.addTime(this.angularVelocity,a);break;default:throw Error("Invalid type.");}this.syncShapes()},rotateInertia:function(a,c,b){var d=a.elements,e=c.elements;c=d[0];a=d[3];var g=d[6],f=d[1],h=d[4],k=d[7],l=d[2],p=d[5],d=d[8],n=e[0],m=e[3],r=e[6],s=e[1],
w=e[4],u=e[7],y=e[2],z=e[5],A=e[8],e=c*n+f*m+l*r,E=c*s+f*w+l*u,U=c*y+f*z+l*A,V=a*n+h*m+p*r,W=a*s+h*w+p*u,ga=a*y+h*z+p*A,n=g*n+k*m+d*r,s=g*s+k*w+d*u,y=g*y+k*z+d*A;b=b.elements;b[0]=e*c+E*f+U*l;b[1]=e*a+E*h+U*p;b[2]=e*g+E*k+U*d;b[3]=V*c+W*f+ga*l;b[4]=V*a+W*h+ga*p;b[5]=V*g+W*k+ga*d;b[6]=n*c+s*f+y*l;b[7]=n*a+s*h+y*p;b[8]=n*g+s*k+y*d},syncShapes:function(){var a=this.orientation.s,c=this.orientation.x,b=this.orientation.y,d=this.orientation.z,e=2*c,g=2*b,f=2*d,h=c*e,k=b*g,d=d*f,l=c*g,b=b*f,c=c*f,e=a*e,
g=a*g,a=a*f,f=this.rotation.elements;f[0]=1-k-d;f[1]=l-a;f[2]=c+g;f[3]=l+a;f[4]=1-h-d;f[5]=b-e;f[6]=c-g;f[7]=b+e;f[8]=1-h-k;this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(h=this.shapes;null!=h;h=h.next)h.position.mul(this.position,h.relativePosition,this.rotation),h.rotation.mul(h.relativeRotation,this.rotation),h.updateProxy()},applyImpulse:function(a,c){this.linearVelocity.addScale(c,this.inverseMass);var b=new OIMO.Vec3;b.sub(a,this.position).cross(b,c).mulMat(this.inverseInertia,
b);this.angularVelocity.addEqual(b)},rotationVectToQuad:function(a){a=OIMO.EulerToAxis(a.x*OIMO.degtorad,a.y*OIMO.degtorad,a.z*OIMO.degtorad);return this.rotationAxisToQuad(a[0],a[1],a[2],a[3])},rotationAxisToQuad:function(a,c,b,d){var e=c*c+b*b+d*d;0<e&&(e=1/OIMO.sqrt(e),c*=e,b*=e,d*=e);e=OIMO.sin(0.5*a);a=OIMO.cos(0.5*a);return new OIMO.Quat(a,e*c,e*b,e*d)},setPosition:function(a){this.newPosition.init(a.x*OIMO.INV_SCALE,a.y*OIMO.INV_SCALE,a.z*OIMO.INV_SCALE);this.controlPos=!0},setQuaternion:function(a){this.newOrientation.init(a.w,
a.x,a.y,a.z);this.controlRot=!0},setRotation:function(a){this.newOrientation=this.rotationVectToQuad(a);this.controlRot=!0},resetPosition:function(a,c,b){this.linearVelocity.init();this.angularVelocity.init();this.position.init(a*OIMO.INV_SCALE,c*OIMO.INV_SCALE,b*OIMO.INV_SCALE);this.awake()},resetQuaternion:function(a){this.angularVelocity.init();this.orientation=new OIMO.Quat(a.w,a.x,a.y,a.z);this.awake()},resetRotation:function(a,c,b){this.angularVelocity.init();this.orientation=this.rotationVectToQuad(new OIMO.Vec3(a,
c,b));this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var a=this.matrix.elements,c;this.sleeping?a[15]=1:(c=this.rotation.elements,a[0]=c[0],a[1]=c[3],a[2]=c[6],a[3]=0,a[4]=c[1],a[5]=c[4],a[6]=c[7],a[7]=0,a[8]=c[2],a[9]=c[5],a[10]=c[8],a[11]=0,c=this.position,
a[12]=c.x*OIMO.WORLD_SCALE,a[13]=c.y*OIMO.WORLD_SCALE,a[14]=c.z*OIMO.WORLD_SCALE,a[15]=0);return a}};OIMO.Body=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="box"),this.name=a.name||"",this.body=a.world.add(a))};
OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(a){this.body.setPosition(a)},setQuaternion:function(a){this.body.setQuaternion(a)},setRotation:function(a){this.body.setRotation(a)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(a,c,b){this.body.resetPosition(a,
c,b)},resetRotation:function(a,c,b){this.body.resetRotation(a,c,b)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(a){this.body.checkContact(a)}};OIMO.Link=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="jointHinge"),this.name=a.name||"",this.joint=a.world.add(a))};OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}};OIMO.Performance=function(a){this.parent=a;this.infos=new OIMO_ARRAY_TYPE(13);this.f=[0,0,0];this.totalTime=this.updatingTime=this.solvingTime=this.narrowPhaseTime=this.broadPhaseTime=this.fps=0};
OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now();this.f[1]-1E3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0);this.f[2]++},show:function(){return["Oimo.js DEV.1.1.2a<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","contact &nbsp;&nbsp;"+this.parent.numContactPoints+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+
"<br><br>","Time in ms <br>","broad-phase &nbsp;"+this.broadPhaseTime+"<br>","narrow-phase "+this.narrowPhaseTime+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.solvingTime+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+this.totalTime].join("\n")},toArray:function(){this.infos[0]=this.parent.broadPhase.types;this.infos[1]=this.parent.numRigidBodies;this.infos[2]=this.parent.numContacts;this.infos[3]=this.parent.broadPhase.numPairChecks;
this.infos[4]=this.parent.numContactPoints;this.infos[5]=this.parent.numIslands;this.infos[6]=this.broadPhaseTime;this.infos[7]=this.narrowPhaseTime;this.infos[8]=this.solvingTime;this.infos[9]=this.updatingTime;this.infos[10]=this.totalTime;this.infos[11]=this.fps;return this.infos}};OIMO.Mat44=function(a,c,b,d,e,g,f,h,k,l,p,n,m,r,s,w){var u=this.elements=new OIMO_ARRAY_TYPE(16);u[0]=void 0!==a?a:1;u[4]=c||0;u[8]=b||0;u[12]=d||0;u[1]=e||0;u[5]=void 0!==g?g:1;u[9]=f||0;u[13]=h||0;u[2]=k||0;u[6]=l||0;u[10]=void 0!==p?p:1;u[14]=n||0;u[3]=m||0;u[7]=r||0;u[11]=s||0;u[15]=void 0!==w?w:1};
OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(a,c,b,d,e,g,f,h,k,l,p,n,m,r,s,w){var u=this.elements;u[0]=a;u[4]=c;u[8]=b;u[12]=d;u[1]=e;u[5]=g;u[9]=f;u[13]=h;u[2]=k;u[6]=l;u[10]=p;u[14]=n;u[3]=m;u[7]=r;u[11]=s;u[15]=w;return this}};OIMO.Mat33=function(a,c,b,d,e,g,f,h,k){this.elements=new OIMO_ARRAY_TYPE(9);this.init(void 0!==a?a:1,c||0,b||0,d||0,void 0!==e?e:1,g||0,f||0,h||0,void 0!==k?k:1)};
OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(a,c,b,d,e,g,f,h,k){var l=this.elements;l[0]=a;l[1]=c;l[2]=b;l[3]=d;l[4]=e;l[5]=g;l[6]=f;l[7]=h;l[8]=k;return this},add:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]+e[0];b[1]=d[1]+e[1];b[2]=d[2]+e[2];b[3]=d[3]+e[3];b[4]=d[4]+e[4];b[5]=d[5]+e[5];b[6]=d[6]+e[6];b[7]=d[7]+e[7];b[8]=d[8]+e[8];return this},addEqual:function(a){var c=this.elements;a=a.elements;c[0]+=a[0];c[1]+=a[1];c[2]+=a[2];c[3]+=a[3];c[4]+=a[4];c[5]+=
a[5];c[6]+=a[6];c[7]+=a[7];c[8]+=a[8];return this},sub:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]-e[0];b[1]=d[1]-e[1];b[2]=d[2]-e[2];b[3]=d[3]-e[3];b[4]=d[4]-e[4];b[5]=d[5]-e[5];b[6]=d[6]-e[6];b[7]=d[7]-e[7];b[8]=d[8]-e[8];return this},subEqual:function(a){var c=this.elements;a=a.elements;c[0]-=a[0];c[1]-=a[1];c[2]-=a[2];c[3]-=a[3];c[4]-=a[4];c[5]-=a[5];c[6]-=a[6];c[7]-=a[7];c[8]-=a[8];return this},scale:function(a,c){var b=this.elements,d=a.elements;b[0]=d[0]*c;b[1]=d[1]*
c;b[2]=d[2]*c;b[3]=d[3]*c;b[4]=d[4]*c;b[5]=d[5]*c;b[6]=d[6]*c;b[7]=d[7]*c;b[8]=d[8]*c;return this},scaleEqual:function(a){var c=this.elements;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=a;c[4]*=a;c[5]*=a;c[6]*=a;c[7]*=a;c[8]*=a;return this},mul:function(a,c){var b=this.elements,d=a.elements,e=c.elements,g=d[0],f=d[3],h=d[6],k=d[1],l=d[4],p=d[7],n=d[2],m=d[5],d=d[8],r=e[0],s=e[3],w=e[6],u=e[1],y=e[4],z=e[7],A=e[2],E=e[5],e=e[8];b[0]=g*r+k*s+n*w;b[1]=g*u+k*y+n*z;b[2]=g*A+k*E+n*e;b[3]=f*r+l*s+m*w;b[4]=f*u+l*y+m*z;
b[5]=f*A+l*E+m*e;b[6]=h*r+p*s+d*w;b[7]=h*u+p*y+d*z;b[8]=h*A+p*E+d*e;return this},mulScale:function(a,c,b,d,e){var g=this.elements;a=a.elements;e?(g[0]=c*a[0],g[1]=c*a[1],g[2]=c*a[2],g[3]=b*a[3],g[4]=b*a[4],g[5]=b*a[5],g[6]=d*a[6],g[7]=d*a[7],g[8]=d*a[8]):(g[0]=a[0]*c,g[1]=a[1]*b,g[2]=a[2]*d,g[3]=a[3]*c,g[4]=a[4]*b,g[5]=a[5]*d,g[6]=a[6]*c,g[7]=a[7]*b,g[8]=a[8]*d);return this},mulRotate:function(a,c,b,d,e,g){g=g||!1;var f=Math.sin(c),h=Math.cos(c),k=1-h;c=b*b*k+h;var l=b*d*k-e*f,p=b*e*k+d*f,n=d*b*k+
e*f,m=d*d*k+h,r=d*e*k-b*f,s=e*b*k-d*f;b=e*d*k+b*f;e=e*e*k+h;var w=a.elements;a=w[0];d=w[3];var f=w[6],h=w[1],k=w[4],u=w[7],y=w[2],z=w[5],w=w[8],A=this.elements;g?(A[0]=c*a+l*d+p*f,A[1]=c*h+l*k+p*u,A[2]=c*y+l*z+p*w,A[3]=n*a+m*d+r*f,A[4]=n*h+m*k+r*u,A[5]=n*y+m*z+r*w,A[6]=s*a+b*d+e*f,A[7]=s*h+b*k+e*u,A[8]=s*y+b*z+e*w):(A[0]=a*c+h*n+y*s,A[1]=a*l+h*m+y*b,A[2]=a*p+h*r+y*e,A[3]=d*c+k*n+z*s,A[4]=d*l+k*m+z*b,A[5]=d*p+k*r+z*e,A[6]=f*c+u*n+w*s,A[7]=f*l+u*m+w*b,A[8]=f*p+u*r+w*e);return this},transpose:function(a){var c=
this.elements;a=a.elements;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];return this},setQuat:function(a){var c=this.elements,b=2*a.x,d=2*a.y,e=2*a.z,g=a.x*b,f=a.y*d,h=a.z*e,k=a.x*d,l=a.y*e,p=a.x*e,b=a.s*b,d=a.s*d;a=a.s*e;c[0]=1-f-h;c[1]=k-a;c[2]=p+d;c[3]=k+a;c[4]=1-g-h;c[5]=l-b;c[6]=p-d;c[7]=l+b;c[8]=1-g-f;return this},invert:function(a){var c=this.elements,b=a.elements;a=b[0];var d=b[3],e=b[6],g=b[1],f=b[4],h=b[7],k=b[2],l=b[5],b=b[8],p=f*b-h*l,n=h*k-
g*b,m=g*l-f*k,r=a*p+d*n+e*m;0!=r&&(r=1/r);c[0]=r*p;c[1]=r*n;c[2]=r*m;c[3]=r*(l*e-d*b);c[4]=r*(a*b-k*e);c[5]=r*(k*d-a*l);c[6]=r*(d*h-f*e);c[7]=r*(g*e-a*h);c[8]=r*(a*f-g*d);return this},copy:function(a){var c=this.elements;a=a.elements;c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];return this},toEuler:function(){var a=this.elements,c=a[0],b=a[3],d=a[6],e=a[4],g=a[7],f=a[5],a=a[8],h=new OIMO.Vec3;new OIMO.Quat;h.y=Math.asin(Math.min(Math.max(d,-1),1));0.99999>
Math.abs(d)?(h.x=Math.atan2(-g,a),h.z=Math.atan2(-b,c)):(h.x=Math.atan2(f,e),h.z=0);return h},clone:function(){var a=this.elements;return new OIMO.Mat33(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},toString:function(){var a=this.elements;return"Mat33|"+a[0].toFixed(4)+", "+a[1].toFixed(4)+", "+a[2].toFixed(4)+"|\n     |"+a[3].toFixed(4)+", "+a[4].toFixed(4)+", "+a[5].toFixed(4)+"|\n     |"+a[6].toFixed(4)+", "+a[7].toFixed(4)+", "+a[8].toFixed(4)+"|"}};OIMO.Quat=function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0};
OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0;return this},add:function(a,c){this.s=a.s+c.s;this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addTime:function(a,c){var b=a.x,d=a.y,e=a.z,g=this.s,f=this.x,h=this.y,k=this.z;c*=0.5;var l=(b*g+d*k-e*h)*c,p=(-b*k+d*g+e*f)*c,n=(b*h-d*f+e*g)*c,g=g+(-b*f-d*h-e*k)*c,f=f+l,h=h+p,k=k+n,b=1/Math.sqrt(g*g+f*f+h*h+k*k);this.s=g*b;this.x=f*b;this.y=h*b;this.z=k*b;return this},
sub:function(a,c){this.s=a.s-c.s;this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},scale:function(a,c){this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},mul:function(a,c){var b=a.x,d=a.y,e=a.z,g=a.s,f=c.x,h=c.y,k=c.z,l=c.s;this.x=b*l+g*f+d*k-e*h;this.y=d*l+g*h+e*f-b*k;this.z=e*l+g*k+b*h-d*f;this.s=g*l-b*f-d*h-e*k;return this},arc:function(a,c){var b=a.x,d=a.y,e=a.z,g=c.x,f=c.y,h=c.z,k=b*g+d*f+e*h;if(-1==k)return g=d*b-e*e,f=-e*d-b*b,h=b*e+d*d,k=1/Math.sqrt(g*g+f*f+h*h),this.s=
0,this.x=g*k,this.y=f*k,this.z=h*k,this;var l=d*h-e*f,e=e*g-b*h,b=b*f-d*g;this.s=Math.sqrt(0.5*(1+k));k=0.5/this.s;this.x=l*k;this.y=e*k;this.z=b*k;return this},normalize:function(a){var c=Math.sqrt(a.s*a.s+a.x*a.x+a.y*a.y+a.z*a.z);0<c&&(c=1/c);this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},invert:function(a){this.s=a.s;this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.s=
a.s;this.x=a.x;this.y=a.y;this.z=a.z;return this},testDiff:function(a){return this.s!==a.s||this.x!==a.x||this.y!==a.y||this.z!==a.z?!0:!1},clone:function(a){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}};OIMO.Quaternion=function(a,c,b,d){this.x=a||0;this.y=c||0;this.z=b||0;this.w=void 0!==d?d:1};
OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(a){var c=a.elements,b=c[0];a=c[1];var d=c[2],e=c[3],g=c[4],f=c[5],h=c[6],k=c[7],c=c[8],l=b+g+c;0<l?(b=0.5/Math.sqrt(l+1),this.w=0.25/b,this.x=(k-f)*b,this.y=(d-h)*b,this.z=(e-a)*b):b>g&&b>c?(b=2*Math.sqrt(1+b-g-c),this.w=(k-f)/b,this.x=0.25*b,this.y=(a+e)/b,this.z=(d+h)/b):g>c?(b=2*Math.sqrt(1+g-b-c),this.w=(d-h)/b,this.x=(a+e)/b,this.y=0.25*b,this.z=(f+k)/b):(b=2*Math.sqrt(1+c-b-g),this.w=(e-a)/b,this.x=(d+h)/b,
this.y=(f+k)/b,this.z=0.25*b);return this}};OIMO.Vec3=function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0};
OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},set:function(a,c,b){this.x=a;this.y=c;this.z=b;return this},add:function(a,c){this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addEqual:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addTime:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},subEqual:function(a){this.x-=
a.x;this.y-=a.y;this.z-=a.z;return this},addScale:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},scale:function(a,c){this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},scaleEqual:function(a){this.x*=a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a,c){var b=a.x,d=a.y,e=a.z,g=c.x,f=c.y,h=c.z;this.x=d*h-e*f;this.y=e*g-b*h;this.z=b*f-d*g;return this},mul:function(a,c,b){b=b.elements;this.x=a.x+c.x*b[0]+c.y*b[1]+c.z*b[2];
this.y=a.y+c.x*b[3]+c.y*b[4]+c.z*b[5];this.z=a.z+c.x*b[6]+c.y*b[7]+c.z*b[8];return this},mulMat:function(a,c){var b=a.elements,d=b[3]*c.x+b[4]*c.y+b[5]*c.z,e=b[6]*c.x+b[7]*c.y+b[8]*c.z;this.x=b[0]*c.x+b[1]*c.y+b[2]*c.z;this.y=d;this.z=e;return this},normalize:function(a){var c=a.x,b=a.y;a=a.z;var d=c*c+b*b+a*a;0<d&&(d=1/Math.sqrt(d),this.x=c*d,this.y=b*d,this.z=a*d);return this},invert:function(a){this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){var a=this.x,c=this.y,b=this.z;return Math.sqrt(a*
a+c*c+b*b)},len:function(){var a=this.x,c=this.y,b=this.z;return a*a+c*c+b*b},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},applyQuaternion:function(a){var c=this.x,b=this.y,d=this.z,e=a.x,g=a.y,f=a.z;a=a.s;var h=a*c+g*d-f*b,k=a*b+f*c-e*d,l=a*d+e*b-g*c,c=-e*c-g*b-f*d;this.x=h*a+c*-e+k*-f-l*-g;this.y=k*a+c*-g+l*-e-h*-f;this.z=l*a+c*-f+h*-g-k*-e;return this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z?!0:!1},testDiff:function(a){return this.x!==a.x||this.y!==a.y||
this.z!==a.z?!0:!1},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}};OIMO.Euler=function(a,c,b,d){this._x=a||0;this._y=c||0;this._z=b||0;this._order=d||OIMO.Euler.DefaultOrder};OIMO.Euler.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" ");OIMO.Euler.DefaultOrder="XYZ";OIMO.clamp=function(a,c,b){return a<c?c:a>b?b:a};
OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(a){this._x=a;this.onChangeCallback()},get y(){return this._y},set y(a){this._y=a;this.onChangeCallback()},get z(){return this._z},set z(a){this._z=a;this.onChangeCallback()},get order(){return this._order},set order(a){this._order=a;this.onChangeCallback()},set:function(a,c,b,d){this._x=a;this._y=c;this._z=b;this._order=d||this._order;this.onChangeCallback();return this},copy:function(a){this._x=
a._x;this._y=a._y;this._z=a._z;this._order=a._order;this.onChangeCallback();return this},setFromRotationMatrix:function(a,c){var b=OIMO.clamp,d=a.elements,e=d[0],g=d[1],f=d[2],h=d[3],k=d[4],l=d[5],p=d[6],n=d[7],d=d[8];c=c||this._order;"XYZ"===c?(this._y=Math.asin(b(f,-1,1)),0.99999>Math.abs(f)?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-g,e)):(this._x=Math.atan2(n,k),this._z=0)):"YXZ"===c?(this._x=Math.asin(-b(l,-1,1)),0.99999>Math.abs(l)?(this._y=Math.atan2(f,d),this._z=Math.atan2(h,k)):(this._y=
Math.atan2(-p,e),this._z=0)):"ZXY"===c?(this._x=Math.asin(b(n,-1,1)),0.99999>Math.abs(n)?(this._y=Math.atan2(-p,d),this._z=Math.atan2(-g,k)):(this._y=0,this._z=Math.atan2(h,e))):"ZYX"===c?(this._y=Math.asin(-b(p,-1,1)),0.99999>Math.abs(p)?(this._x=Math.atan2(n,d),this._z=Math.atan2(h,e)):(this._x=0,this._z=Math.atan2(-g,k))):"YZX"===c?(this._z=Math.asin(b(h,-1,1)),0.99999>Math.abs(h)?(this._x=Math.atan2(-l,k),this._y=Math.atan2(-p,e)):(this._x=0,this._y=Math.atan2(f,d))):"XZY"===c?(this._z=Math.asin(-b(g,
-1,1)),0.99999>Math.abs(g)?(this._x=Math.atan2(n,k),this._y=Math.atan2(f,e)):(this._x=Math.atan2(-l,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+c);this._order=c;this.onChangeCallback();return this},setFromQuaternion:function(a,c,b){var d=OIMO.clamp,e=a.x*a.x,g=a.y*a.y,f=a.z*a.z,h=a.s*a.s;c=c||this._order;"XYZ"===c?(this._x=Math.atan2(2*(a.x*a.s-a.y*a.z),h-e-g+f),this._y=Math.asin(d(2*(a.x*a.z+a.y*a.s),-1,1)),this._z=Math.atan2(2*(a.z*a.s-a.x*a.y),
h+e-g-f)):"YXZ"===c?(this._x=Math.asin(d(2*(a.x*a.s-a.y*a.z),-1,1)),this._y=Math.atan2(2*(a.x*a.z+a.y*a.s),h-e-g+f),this._z=Math.atan2(2*(a.x*a.y+a.z*a.s),h-e+g-f)):"ZXY"===c?(this._x=Math.asin(d(2*(a.x*a.s+a.y*a.z),-1,1)),this._y=Math.atan2(2*(a.y*a.s-a.z*a.x),h-e-g+f),this._z=Math.atan2(2*(a.z*a.s-a.x*a.y),h-e+g-f)):"ZYX"===c?(this._x=Math.atan2(2*(a.x*a.s+a.z*a.y),h-e-g+f),this._y=Math.asin(d(2*(a.y*a.s-a.x*a.z),-1,1)),this._z=Math.atan2(2*(a.x*a.y+a.z*a.s),h+e-g-f)):"YZX"===c?(this._x=Math.atan2(2*
(a.x*a.s-a.z*a.y),h-e+g-f),this._y=Math.atan2(2*(a.y*a.s-a.x*a.z),h+e-g-f),this._z=Math.asin(d(2*(a.x*a.y+a.z*a.s),-1,1))):"XZY"===c?(this._x=Math.atan2(2*(a.x*a.s+a.y*a.z),h-e+g-f),this._y=Math.atan2(2*(a.x*a.z+a.y*a.s),h+e-g-f),this._z=Math.asin(d(2*(a.z*a.s-a.x*a.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+c);this._order=c;if(!1!==b)this.onChangeCallback();return this},reorder:function(){var a=new OIMO.Quat;return function(c){a.setFromEuler(this);this.setFromQuaternion(a,
c)}}(),equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._order===this._order},fromArray:function(a){this._x=a[0];this._y=a[1];this._z=a[2];void 0!==a[3]&&(this._order=a[3]);this.onChangeCallback();return this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(a){this.onChangeCallback=a;return this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}};OIMO.EulerToAxis=function(a,c,b){var d=Math.cos(0.5*c);c=Math.sin(0.5*c);var e=Math.cos(0.5*b),g=Math.sin(0.5*b),f=Math.cos(0.5*a),h=Math.sin(0.5*a),k=d*e,l=c*g;a=k*h+l*f;b=c*e*f+d*g*h;d=d*g*f-c*e*h;c=2*Math.acos(k*f-l*h);e=a*a+b*b+d*d;0.001>e?(a=1,b=d=0):(e=Math.sqrt(e),a/=e,b/=e,d/=e);return[c,a,b,d]};
OIMO.EulerToMatrix=function(a,c,b){var d=Math.cos(c);c=Math.sin(c);var e=Math.cos(b);b=Math.sin(b);var g=Math.cos(a);a=Math.sin(a);var f=new OIMO.Mat33,h=f.elements;h[0]=d*e;h[1]=c*a-d*b*g;h[2]=d*b*a+c*g;h[3]=b;h[4]=e*g;h[5]=-e*a;h[6]=-c*e;h[7]=c*b*g+d*a;h[8]=-c*b*a+d*g;return f};
OIMO.MatrixToEuler=function(a){var c=a.elements,b;0.998<c[3]?(b=Math.atan2(c[2],c[8]),c=Math.PI/2,a=0):-0.998>c[3]?(b=Math.atan2(c[2],c[8]),c=-Math.PI/2,a=0):(b=Math.atan2(-c[6],c[0]),a=Math.atan2(-c[5],c[4]),c=Math.asin(c[3]));return[a,b,c]};OIMO.unwrapDegrees=function(a){a%=360;180<a&&(a-=360);-180>a&&(a+=360);return a};OIMO.unwrapRadian=function(a){a%=OIMO.TwoPI;a>Math.PI&&(a-=OIMO.TwoPI);a<-Math.PI&&(a+=OIMO.TwoPI);return a};OIMO.Distance3d=function(a,c){var b=c[0]-a[0],d=c[1]-a[1],e=c[2]-a[2];return Math.sqrt(b*b+d*d+e*e)};OIMO.Constraint=function(){this.body2=this.body1=this.parent=null;this.addedToIsland=!1};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(a,c){throw Error("Inheritance error.");},solve:function(){throw Error("Inheritance error.");},postSolve:function(){throw Error("Inheritance error.");}};OIMO.Joint=function(a){OIMO.Constraint.call(this);this.name="";this.JOINT_DISTANCE=1;this.JOINT_BALL_AND_SOCKET=2;this.JOINT_HINGE=3;this.JOINT_WHEEL=4;this.JOINT_SLIDER=5;this.JOINT_PRISMATIC=6;this.type=0;this.next=this.prev=null;this.body1=a.body1;this.body2=a.body2;this.localAnchorPoint1=(new OIMO.Vec3).copy(a.localAnchorPoint1);this.localAnchorPoint2=(new OIMO.Vec3).copy(a.localAnchorPoint2);this.relativeAnchorPoint1=new OIMO.Vec3;this.relativeAnchorPoint2=new OIMO.Vec3;this.anchorPoint1=new OIMO.Vec3;
this.anchorPoint2=new OIMO.Vec3;this.allowCollision=a.allowCollision;this.b1Link=new OIMO.JointLink(this);this.b2Link=new OIMO.JointLink(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);
OIMO.Joint.prototype.updateAnchorPoints=function(){var a=this.body1.position,c=this.body2.position,b=this.body1.rotation.elements,d=this.body2.rotation.elements,e=this.localAnchorPoint1.x,g=this.localAnchorPoint1.y,f=this.localAnchorPoint1.z,h=this.localAnchorPoint2.x,k=this.localAnchorPoint2.y,l=this.localAnchorPoint2.z,p=e*b[0]+g*b[1]+f*b[2],n=e*b[3]+g*b[4]+f*b[5],g=e*b[6]+g*b[7]+f*b[8],e=h*d[0]+k*d[1]+l*d[2],b=h*d[3]+k*d[4]+l*d[5],d=h*d[6]+k*d[7]+l*d[8];this.relativeAnchorPoint1.x=p;this.relativeAnchorPoint1.y=
n;this.relativeAnchorPoint1.z=g;this.relativeAnchorPoint2.x=e;this.relativeAnchorPoint2.y=b;this.relativeAnchorPoint2.z=d;n+=a.y;h=g+a.z;k=e+c.x;l=b+c.y;c=d+c.z;this.anchorPoint1.x=p+a.x;this.anchorPoint1.y=n;this.anchorPoint1.z=h;this.anchorPoint2.x=k;this.anchorPoint2.y=l;this.anchorPoint2.z=c};
OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2;this.b2Link.body=this.body1;null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null;this.body1.jointLink=this.b1Link;this.body1.numJoints++;null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null;this.body2.jointLink=this.b2Link;this.body2.numJoints++};
OIMO.Joint.prototype.detach=function(){var a=this.b1Link.prev,c=this.b1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body1.jointLink==this.b1Link&&(this.body1.jointLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.body=null;this.body1.numJoints--;a=this.b2Link.prev;c=this.b2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body2.jointLink==this.b2Link&&(this.body2.jointLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.body=null;this.body2.numJoints--;this.b1Link.body=
null;this.b2Link.body=null};OIMO.Joint.prototype.awake=function(){this.body1.awake();this.body2.awake()};OIMO.Joint.prototype.preSolve=function(a,c){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};OIMO.Joint.prototype.dispose=function(){this.parent.removeJoint(this)};OIMO.Joint.prototype.getPosition=function(){var a=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE),c=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[a,c]};
OIMO.Joint.prototype.getMatrix=function(){var a=this.matrix.elements,c=this.anchorPoint1,b=this.anchorPoint2;a[0]=c.x*OIMO.WORLD_SCALE;a[1]=c.y*OIMO.WORLD_SCALE;a[2]=c.z*OIMO.WORLD_SCALE;a[3]=0;a[4]=b.x*OIMO.WORLD_SCALE;a[5]=b.y*OIMO.WORLD_SCALE;a[6]=b.z*OIMO.WORLD_SCALE;a[7]=0;return a};OIMO.JointConfig=function(){this.body2=this.body1=null;this.localAnchorPoint1=new OIMO.Vec3;this.localAnchorPoint2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=!1};OIMO.JointLink=function(a){this.body=this.next=this.prev=null;this.joint=a};OIMO.LimitMotor=function(a,c){this.axis=a;this.angle=0;this.lowerLimit=c?0:1;this.dampingRatio=this.frequency=this.maxMotorForce=this.motorSpeed=this.upperLimit=0};OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(a,c){this.lowerLimit=a;this.upperLimit=c},setMotor:function(a,c){this.motorSpeed=a;this.maxMotorForce=c},setSpring:function(a,c){this.frequency=a;this.dampingRatio=c}};OIMO.BallAndSocketJoint=function(a){OIMO.Joint.call(this,a);this.type=this.JOINT_BALL_AND_SOCKET;this.lc=new OIMO.LinearConstraint(this)};OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallAndSocketJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();this.lc.preSolve(a,c)};OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()};OIMO.BallAndSocketJoint.prototype.postSolve=function(){};OIMO.DistanceJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_DISTANCE;this.normal=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.normal,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.DistanceJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();var b=this.anchorPoint2.x-this.anchorPoint1.x,d=this.anchorPoint2.y-this.anchorPoint1.y,e=this.anchorPoint2.z-this.anchorPoint1.z,g=Math.sqrt(b*b+d*d+e*e);0<g&&(g=1/g);this.normal.init(b*g,d*g,e*g);this.t.preSolve(a,c)};OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_HINGE;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*
this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*
a[1]+this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.nor,!1);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.lc=new OIMO.LinearConstraint(this);this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,
!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.HingeJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var g=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var f=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],h=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],k=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],m=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],s=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],w=e*this.body2.inverseMass+l*this.body1.inverseMass,u=g*this.body2.inverseMass+p*this.body1.inverseMass,y=d*this.body2.inverseMass+n*this.body1.inverseMass;b=Math.sqrt(w*w+u*u+y*y);0<b&&(b=1/b);var w=w*b,u=u*b,y=y*b,z=u*w-y*y,A=-y*u-w*w,E=w*y+u*u;b=1/Math.sqrt(z*z+A*A+E*E);var z=z*b,A=A*b,E=E*b,U=u*E-y*A,V=y*z-w*E,W=w*A-u*z;this.nor.init(w,u,y);this.tan.init(z,A,E);this.bin.init(U,V,W);this.limitMotor.angle=0>w*(h*s-k*r)+u*(k*m-f*s)+y*(f*r-h*m)?-this.acosClamp(f*m+h*r+k*s):this.acosClamp(f*m+
h*r+k*s);b=g*n-d*p;d=d*l-e*n;e=e*p-g*l;this.r3.limitMotor2.angle=z*b+A*d+E*e;this.r3.limitMotor3.angle=U*b+V*d+W*e;this.r3.preSolve(a,c);this.lc.preSolve(a,c)};OIMO.HingeJoint.prototype.solve=function(){this.r3.solve();this.lc.solve()};OIMO.HingeJoint.prototype.postSolve=function(){};OIMO.HingeJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.PrismaticJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_PRISMATIC;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ac=new OIMO.AngularConstraint(this,
(new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.limitMotor=new OIMO.LimitMotor(this.nor,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.PrismaticJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],g=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],f=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];b=this.body2.rotation.elements;e=e*this.body2.inverseMass+(this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2])*this.body1.inverseMass;g=g*this.body2.inverseMass+
(this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5])*this.body1.inverseMass;b=f*this.body2.inverseMass+(this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8])*this.body1.inverseMass;d=Math.sqrt(e*e+g*g+b*b);0<d&&(d=1/d);e*=d;g*=d;b*=d;var f=g*e-b*b,h=-b*g-e*e,k=e*b+g*g;d=1/Math.sqrt(f*f+h*h+k*k);f*=d;h*=d;k*=d;d=g*k-b*h;var l=b*f-e*k,p=e*h-g*f;this.nor.init(e,g,b);this.tan.init(f,h,k);this.bin.init(d,l,p);this.ac.preSolve(a,c);this.t3.preSolve(a,c)};
OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve();this.t3.solve()};OIMO.PrismaticJoint.prototype.postSolve=function(){};OIMO.SliderJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_SLIDER;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*
this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*
a[1]+this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,!1);this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0));this.translationalLimitMotor=
new OIMO.LimitMotor(this.nor,!0);this.translationalLimitMotor.lowerLimit=c;this.translationalLimitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.SliderJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var g=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var f=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],h=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],k=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],m=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],s=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],w=e*this.body2.inverseMass+l*this.body1.inverseMass,u=g*this.body2.inverseMass+p*this.body1.inverseMass,y=d*this.body2.inverseMass+n*this.body1.inverseMass;b=Math.sqrt(w*w+u*u+y*y);0<b&&(b=1/b);var w=w*b,u=u*b,y=y*b,z=u*w-y*y,A=-y*u-w*w,E=w*y+u*u;b=1/Math.sqrt(z*z+A*A+E*E);var z=z*b,A=A*b,E=E*b,U=u*E-y*A,V=y*z-w*E,W=w*A-u*z;this.nor.init(w,u,y);this.tan.init(z,A,E);this.bin.init(U,V,W);this.rotationalLimitMotor.angle=0>w*(h*s-k*r)+u*(k*m-f*s)+y*(f*r-h*m)?-this.acosClamp(f*m+h*r+k*s):this.acosClamp(f*
m+h*r+k*s);b=g*n-d*p;d=d*l-e*n;e=e*p-g*l;this.r3.limitMotor2.angle=z*b+A*d+E*e;this.r3.limitMotor3.angle=U*b+V*d+W*e;this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.SliderJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.SliderJoint.prototype.postSolve=function(){};OIMO.SliderJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.WheelJoint=function(a){OIMO.Joint.call(this,a);this.type=this.JOINT_WHEEL;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;
-1<a&&1>a?(this.localAngAxis1X=this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=
a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=a,this.localAngAxis2Y*=a,this.localAngAxis2Z*=a):(this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*
this.localAxis1Y,a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements,this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],
this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8]);this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,!0);this.translationalLimitMotor.frequency=8;this.translationalLimitMotor.dampingRatio=1;this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,!1);this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,!1);this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,
!0),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,!0));this.t3.weight=1;this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)};OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.WheelJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],g=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],f=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];d=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2];var h=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],k=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],n=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],m=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],r=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5];b=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8];this.r3.limitMotor1.angle=e*l+g*p+f*n;this.rotationalLimitMotor1.angle=0>e*(h*n-k*p)+g*(k*l-d*n)+f*(d*p-h*l)?-this.acosClamp(d*l+h*p+k*n):this.acosClamp(d*l+h*p+k*n);this.rotationalLimitMotor2.angle=0>l*(r*f-b*g)+p*(b*e-m*f)+n*(m*g-r*e)?this.acosClamp(m*e+r*g+b*f):-this.acosClamp(m*e+r*g+b*f);h=p*f-n*g;k=n*e-l*f;m=l*g-p*e;d=Math.sqrt(h*h+k*k+m*m);0<d&&(d=1/d);h*=d;k*=d;m*=d;r=k*n-m*p;n=m*l-h*n;l=h*p-k*l;d=Math.sqrt(r*r+n*n+l*l);0<d&&(d=1/d);r*=d;n*=d;l*=d;p=g*m-f*k;f=f*h-e*m;e=e*k-g*h;d=Math.sqrt(p*
p+f*f+e*e);0<d&&(d=1/d);p*=d;f*=d;e*=d;this.nor.init(h,k,m);this.tan.init(r,n,l);this.bin.init(p,f,e);this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.WheelJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.WheelJoint.prototype.postSolve=function(){};OIMO.WheelJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.AngularConstraint=function(a,c){this.velz=this.vely=this.velx=this.az=this.ay=this.ax=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.joint=a;this.targetOrientation=(new OIMO.Quat).invert(c);this.relativeOrientation=new OIMO.Quat;this.b1=a.body1;this.b2=a.body2;
this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(a,c){var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.i1e00+this.i2e00,d=this.i1e01+this.i2e01,e=this.i1e02+this.i2e02,g=this.i1e10+
this.i2e10,f=this.i1e11+this.i2e11,h=this.i1e12+this.i2e12,k=this.i1e20+this.i2e20,l=this.i1e21+this.i2e21,p=this.i1e22+this.i2e22,n=1/(b*(f*p-l*h)+g*(l*e-d*p)+k*(d*h-f*e));this.d00=(f*p-h*l)*n;this.d01=(e*l-d*p)*n;this.d02=(d*h-e*f)*n;this.d10=(h*k-g*p)*n;this.d11=(b*p-e*k)*n;this.d12=(e*g-b*h)*n;this.d20=(g*l-f*k)*n;this.d21=(d*k-b*l)*n;this.d22=(b*f-d*g)*n;this.relativeOrientation.invert(this.b1.orientation);this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation);this.relativeOrientation.mul(this.b2.orientation,
this.relativeOrientation);n=2*this.relativeOrientation.s;this.velx=this.relativeOrientation.x*n;this.vely=this.relativeOrientation.y*n;this.velz=this.relativeOrientation.z*n;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.02<b?(b=(0.02-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.a1.x+=this.impx*this.i1e00+this.impy*this.i1e01+this.impz*this.i1e02;this.a1.y+=this.impx*this.i1e10+this.impy*this.i1e11+this.impz*this.i1e12;this.a1.z+=
this.impx*this.i1e20+this.impy*this.i1e21+this.impz*this.i1e22;this.a2.x-=this.impx*this.i2e00+this.impy*this.i2e01+this.impz*this.i2e02;this.a2.y-=this.impx*this.i2e10+this.impy*this.i2e11+this.impz*this.i2e12;this.a2.z-=this.impx*this.i2e20+this.impy*this.i2e21+this.impz*this.i2e22},solve:function(){var a=this.a2.x-this.a1.x-this.velx,c=this.a2.y-this.a1.y-this.vely,b=this.a2.z-this.a1.z-this.velz,d=a*this.d00+c*this.d01+b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;
this.impx+=d;this.impy+=e;this.impz+=a;this.a1.x+=d*this.i1e00+e*this.i1e01+a*this.i1e02;this.a1.y+=d*this.i1e10+e*this.i1e11+a*this.i1e12;this.a1.z+=d*this.i1e20+e*this.i1e21+a*this.i1e22;this.a2.x-=d*this.i2e00+e*this.i2e01+a*this.i2e02;this.a2.y-=d*this.i2e10+e*this.i2e11+a*this.i2e12;this.a2.z-=d*this.i2e20+e*this.i2e21+a*this.i2e22}};OIMO.LinearConstraint=function(a){this.velz=this.vely=this.velx=this.vel=this.az2z=this.az2y=this.az2x=this.ay2z=this.ay2y=this.ay2x=this.ax2z=this.ax2y=this.ax2x=this.az1z=this.az1y=this.az1x=this.ay1z=this.ay1y=this.ay1x=this.ax1z=this.ax1y=this.ax1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.joint=a;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.b1=a.body1;this.b2=a.body2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(a,c){this.r1x=this.r1.x;this.r1y=this.r1.y;this.r1z=this.r1.z;this.r2x=this.r2.x;this.r2y=this.r2.y;this.r2z=this.r2.z;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=
d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];this.ax1x=this.r1z*this.i1e01+-this.r1y*this.i1e02;this.ax1y=this.r1z*this.i1e11+-this.r1y*this.i1e12;this.ax1z=this.r1z*this.i1e21+-this.r1y*this.i1e22;this.ay1x=-this.r1z*this.i1e00+this.r1x*this.i1e02;this.ay1y=-this.r1z*this.i1e10+this.r1x*this.i1e12;this.ay1z=-this.r1z*this.i1e20+this.r1x*this.i1e22;this.az1x=this.r1y*this.i1e00+-this.r1x*this.i1e01;this.az1y=this.r1y*this.i1e10+-this.r1x*this.i1e11;this.az1z=
this.r1y*this.i1e20+-this.r1x*this.i1e21;this.ax2x=this.r2z*this.i2e01+-this.r2y*this.i2e02;this.ax2y=this.r2z*this.i2e11+-this.r2y*this.i2e12;this.ax2z=this.r2z*this.i2e21+-this.r2y*this.i2e22;this.ay2x=-this.r2z*this.i2e00+this.r2x*this.i2e02;this.ay2y=-this.r2z*this.i2e10+this.r2x*this.i2e12;this.ay2z=-this.r2z*this.i2e20+this.r2x*this.i2e22;this.az2x=this.r2y*this.i2e00+-this.r2x*this.i2e01;this.az2y=this.r2y*this.i2e10+-this.r2x*this.i2e11;this.az2z=this.r2y*this.i2e20+-this.r2x*this.i2e21;var b=
this.m1+this.m2,e,g,f=b,h,k,l,p=b,b=b+(this.i1e11*this.r1z*this.r1z-(this.i1e21+this.i1e12)*this.r1y*this.r1z+this.i1e22*this.r1y*this.r1y),d=0+((this.i1e20*this.r1y+this.i1e12*this.r1x)*this.r1z-this.i1e10*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);e=0+((this.i1e10*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e20*this.r1y*this.r1y+this.i1e21*this.r1x*this.r1y);g=0+((this.i1e02*this.r1y+this.i1e21*this.r1x)*this.r1z-this.i1e01*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);f+=this.i1e00*this.r1z*
this.r1z-(this.i1e20+this.i1e02)*this.r1x*this.r1z+this.i1e22*this.r1x*this.r1x;h=0+((this.i1e01*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e21*this.r1x*this.r1x+this.i1e20*this.r1x*this.r1y);k=0+((this.i1e01*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e02*this.r1y*this.r1y+this.i1e12*this.r1x*this.r1y);l=0+((this.i1e10*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e12*this.r1x*this.r1x+this.i1e02*this.r1x*this.r1y);p+=this.i1e00*this.r1y*this.r1y-(this.i1e10+this.i1e01)*this.r1x*this.r1y+this.i1e11*
this.r1x*this.r1x;b+=this.i2e11*this.r2z*this.r2z-(this.i2e21+this.i2e12)*this.r2y*this.r2z+this.i2e22*this.r2y*this.r2y;d+=(this.i2e20*this.r2y+this.i2e12*this.r2x)*this.r2z-this.i2e10*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;e+=(this.i2e10*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e20*this.r2y*this.r2y+this.i2e21*this.r2x*this.r2y;g+=(this.i2e02*this.r2y+this.i2e21*this.r2x)*this.r2z-this.i2e01*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;f+=this.i2e00*this.r2z*this.r2z-(this.i2e20+
this.i2e02)*this.r2x*this.r2z+this.i2e22*this.r2x*this.r2x;h+=(this.i2e01*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e21*this.r2x*this.r2x+this.i2e20*this.r2x*this.r2y;k+=(this.i2e01*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e02*this.r2y*this.r2y+this.i2e12*this.r2x*this.r2y;l+=(this.i2e10*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e12*this.r2x*this.r2x+this.i2e02*this.r2x*this.r2y;var p=p+(this.i2e00*this.r2y*this.r2y-(this.i2e10+this.i2e01)*this.r2x*this.r2y+this.i2e11*this.r2x*this.r2x),
n=1/(b*(f*p-l*h)+g*(l*e-d*p)+k*(d*h-f*e));this.d00=(f*p-h*l)*n;this.d01=(e*l-d*p)*n;this.d02=(d*h-e*f)*n;this.d10=(h*k-g*p)*n;this.d11=(b*p-e*k)*n;this.d12=(e*g-b*h)*n;this.d20=(g*l-f*k)*n;this.d21=(d*k-b*l)*n;this.d22=(b*f-d*g)*n;this.velx=this.p2.x-this.p1.x;this.vely=this.p2.y-this.p1.y;this.velz=this.p2.z-this.p1.z;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.005<b?(b=(0.005-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.impx*=
0.95;this.impy*=0.95;this.impz*=0.95;this.l1.x+=this.impx*this.m1;this.l1.y+=this.impy*this.m1;this.l1.z+=this.impz*this.m1;this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x;this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y;this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z;this.l2.x-=this.impx*this.m2;this.l2.y-=this.impy*this.m2;this.l2.z-=this.impz*this.m2;this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x;this.a2.y-=
this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y;this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,d=a*this.d00+c*this.d01+
b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;this.impx+=d;this.impy+=e;this.impz+=a;this.l1.x+=d*this.m1;this.l1.y+=e*this.m1;this.l1.z+=a*this.m1;this.a1.x+=d*this.ax1x+e*this.ay1x+a*this.az1x;this.a1.y+=d*this.ax1y+e*this.ay1y+a*this.az1y;this.a1.z+=d*this.ax1z+e*this.ay1z+a*this.az1z;this.l2.x-=d*this.m2;this.l2.y-=e*this.m2;this.l2.z-=a*this.m2;this.a2.x-=d*this.ax2x+e*this.ay2x+a*this.az2x;this.a2.y-=d*this.ax2y+e*this.ay2y+a*this.az2y;this.a2.z-=d*this.ax2z+
e*this.ay2z+a*this.az2z}};OIMO.Rotational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=this.a1y1=this.a1x1=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=
this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm3=this.cfm2=this.cfm1=NaN;this.limitState1=0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=
this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=
this.motorImpulse1=this.limitImpulse1=0};
OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,g=0<e,f=0<b,h=0<d,k=this.lowerLimit2<=this.upperLimit2,
l=this.lowerLimit3<=this.upperLimit3,p=this.limitMotor1.angle;this.lowerLimit1<=this.upperLimit1?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-p):p<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-p):p>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-p):(this.limitState1=
2,this.limitVelocity1=this.limitImpulse1=0),g||(this.limitVelocity1=0.02<this.limitVelocity1?this.limitVelocity1-0.02:-0.02>this.limitVelocity1?this.limitVelocity1+0.02:0)):(this.limitState1=2,this.limitImpulse1=0);p=this.limitMotor2.angle;k?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-p):p<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-
p):p>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-p):(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),f||(this.limitVelocity2=0.02<this.limitVelocity2?this.limitVelocity2-0.02:-0.02>this.limitVelocity2?this.limitVelocity2+0.02:0)):(this.limitState2=2,this.limitImpulse2=0);k=this.limitMotor3.angle;l?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=
this.lowerLimit3-k):k<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-k):k>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-k):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),h||(this.limitVelocity3=0.02<this.limitVelocity3?this.limitVelocity3-0.02:-0.02>this.limitVelocity3?this.limitVelocity3+0.02:0)):(this.limitState3=2,this.limitImpulse3=0);
this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||g)?this.maxMotorForce1*a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||f)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||h)?this.maxMotorForce3*a:this.motorImpulse3=0;this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02;this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12;this.a1z1=this.ax1*this.i1e20+this.ay1*
this.i1e21+this.az1*this.i1e22;this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02;this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12;this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22;this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02;this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12;this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22;this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+
this.az2*this.i2e02;this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12;this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22;this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02;this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12;this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22;this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02;this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12;
this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22;this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1);this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2);this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3);this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1);this.k11=this.ax2*(this.a1x2+
this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2);this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3);this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1);this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2);this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3);this.kv00=this.k00;this.kv11=
this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;g&&2!=this.limitState1?(g=6.2831853*e,e=g*g*a,g=c/(e+2*this.limitMotor1.dampingRatio*g),this.cfm1=this.kv00*g,this.limitVelocity1=this.limitVelocity1*e*g):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);f&&2!=this.limitState2?(g=6.2831853*b,e=g*g*a,g=c/(e+2*this.limitMotor2.dampingRatio*g),this.cfm2=this.kv11*g,this.limitVelocity2=this.limitVelocity2*e*g):(this.cfm2=0,this.limitVelocity2=0.05*
this.limitVelocity2*c);h&&2!=this.limitState3?(g=6.2831853*d,e=g*g*a,g=c/(e+2*this.limitMotor3.dampingRatio*g),this.cfm3=this.kv22*g,this.limitVelocity3=this.limitVelocity3*e*g):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*b;this.d01=
(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;this.limitImpulse1*=0.95;this.motorImpulse1*=0.95;this.limitImpulse2*=0.95;this.motorImpulse2*=0.95;this.limitImpulse3*=
0.95;this.motorImpulse3*=0.95;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;f=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+d*this.a1x2+f*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+f*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+f*this.a1z3;this.a2.x-=b*this.a2x1+d*this.a2x2+f*this.a2x3;this.a2.y-=b*this.a2y1+d*this.a2y2+f*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+f*this.a2z3},solve_:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=
this.a2.z-this.a1.z;this.limitVelocity3=30;var d=a*this.ax1+c*this.ay1+b*this.az1-this.limitVelocity1,e=a*this.ax2+c*this.ay2+b*this.az2-this.limitVelocity2,b=a*this.ax3+c*this.ay3+b*this.az3-this.limitVelocity3,a=d*this.d00+e*this.d01+b*this.d02,c=d*this.d10+e*this.d11+b*this.d12,d=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=a;this.limitImpulse2+=c;this.limitImpulse3+=d;this.a1.x+=a*this.a1x1+c*this.a1x2+d*this.a1x3;this.a1.y+=a*this.a1y1+c*this.a1y2+d*this.a1y3;this.a1.z+=a*this.a1z1+c*
this.a1z2+d*this.a1z3;this.a2.x-=a*this.a2x1+c*this.a2x2+d*this.a2x3;this.a2.y-=a*this.a2y1+c*this.a2y2+d*this.a2y3;this.a2.z-=a*this.a2z1+c*this.a2z2+d*this.a2z3},solve:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=this.a2.z-this.a1.z,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,g=this.motorImpulse1,f=this.motorImpulse2,h=this.motorImpulse3,k=0,a=c=0;this.enableMotor1&&(k=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=
k,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),k=this.motorImpulse1-g);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-f);this.enableMotor3&&(a=(b-this.motorSpeed3)*
this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-h);var d=d+(k*this.kv00+c*this.k01+a*this.k02),e=e+(k*this.k10+c*this.kv11+a*this.k12),b=b+(k*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*
this.cfm3),h=this.limitImpulse1,l=this.limitImpulse2,p=this.limitImpulse3,n=d*this.d00+e*this.d01+b*this.d02,f=d*this.d10+e*this.d11+b*this.d12,g=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=n;this.limitImpulse2+=f;this.limitImpulse3+=g;var m=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)n=-h,e+=n*this.k10,b+=n*this.k20,m|=1;if(2==this.limitState2||0>this.limitImpulse2*this.limitState2)f=-l,d+=f*this.k01,b+=f*this.k21,m|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)g=
-p,d+=g*this.k02,e+=g*this.k12,m|=4;switch(m){case 1:m=1/(this.k11*this.k22-this.k12*this.k21);f=(this.k22*e+-this.k12*b)*m;g=(-this.k21*e+this.k11*b)*m;break;case 2:m=1/(this.k00*this.k22-this.k02*this.k20);n=(this.k22*d+-this.k02*b)*m;g=(-this.k20*d+this.k00*b)*m;break;case 3:g=b/this.k22;break;case 4:m=1/(this.k00*this.k11-this.k01*this.k10);n=(this.k11*d+-this.k01*e)*m;f=(-this.k10*d+this.k00*e)*m;break;case 5:f=e/this.k11;break;case 6:n=d/this.k00}this.limitImpulse1=n+h;this.limitImpulse2=f+
l;this.limitImpulse3=g+p;d=k+n;e=c+f;a+=g;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.RotationalConstraint=function(a,c){this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm=NaN;this.enableLimit=!1;this.limitVelocity=this.upperLimit=this.lowerLimit=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=
this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=
b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.limitMotor.frequency,d=0<b,e=this.limitMotor.angle;this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=
-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.02<this.limitVelocity?this.limitVelocity-0.02:-0.02>this.limitVelocity?this.limitVelocity+0.02:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=
0;this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02;this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12;this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22;this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02;this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12;this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22;this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z);this.invMotorDenom=
1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);this.limitImpulse*=0.95;this.motorImpulse*=0.95;b=this.limitImpulse+this.motorImpulse;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=
this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z),c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,
this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Translational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.l2z3=this.l2y3=this.l2x3=this.l1z3=this.l1y3=this.l1x3=this.t2z3=this.t2y3=this.t2x3=this.t1z3=this.t1y3=this.t1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.l2z2=this.l2y2=this.l2x2=this.l1z2=this.l1y2=this.l1x2=this.t2z2=this.t2y2=this.t2x2=this.t1z2=this.t1y2=this.t1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=
this.a1y1=this.a1x1=this.l2z1=this.l2y1=this.l2x1=this.l1z1=this.l1y1=this.l1x1=this.t2z1=this.t2y1=this.t2x1=this.t1z1=this.t1y1=this.t1x1=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.limitState1=
0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=
this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;
this.cfm3=this.cfm2=this.cfm1=this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=this.motorImpulse1=this.limitImpulse1=0;this.weight=-1};
OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p2.x-this.p1.x,d=this.p2.y-this.p1.y,e=this.p2.z-this.p1.z,g=b*this.ax1+
d*this.ay1+e*this.az1,f=b*this.ax2+d*this.ay2+e*this.az2,h=b*this.ax3+d*this.ay3+e*this.az3,k=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,l=0<k,e=0<b,p=0<d,n=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,r=this.lowerLimit3<=this.upperLimit3;if(l&&20<g||-20>g)l=!1;if(e&&20<f||-20>f)e=!1;if(p&&20<h||-20>h)p=!1;n?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-
g,l||(g=this.lowerLimit1)):g<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-g,l||(g=this.lowerLimit1)):g>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-g,l||(g=this.upperLimit1)):(this.limitState1=2,this.limitVelocity1=this.limitImpulse1=0),l||(this.limitVelocity1=0.005<this.limitVelocity1?this.limitVelocity1-0.005:-0.005>this.limitVelocity1?this.limitVelocity1+
0.005:0)):(this.limitState1=2,this.limitImpulse1=0);m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-f,e||(f=this.lowerLimit2)):f<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-f,e||(f=this.lowerLimit2)):f>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-f,e||(f=this.upperLimit2)):
(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),e||(this.limitVelocity2=0.005<this.limitVelocity2?this.limitVelocity2-0.005:-0.005>this.limitVelocity2?this.limitVelocity2+0.005:0)):(this.limitState2=2,this.limitImpulse2=0);r?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=this.lowerLimit3-h,p||(h=this.lowerLimit3)):h<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=
this.lowerLimit3-h,p||(h=this.lowerLimit3)):h>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-h,p||(h=this.upperLimit3)):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),p||(this.limitVelocity3=0.005<this.limitVelocity3?this.limitVelocity3-0.005:-0.005>this.limitVelocity3?this.limitVelocity3+0.005:0)):(this.limitState3=2,this.limitImpulse3=0);this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||l)?this.maxMotorForce1*
a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||e)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||p)?this.maxMotorForce3*a:this.motorImpulse3=0;n=g*this.ax1+f*this.ax2+h*this.ax2;m=g*this.ay1+f*this.ay2+h*this.ay2;g=g*this.az1+f*this.az2+h*this.az2;f=this.m2/(this.m1+this.m2);0<=this.weight&&(f=this.weight);h=1-f;this.r1x=this.r1.x+n*f;this.r1y=this.r1.y+m*f;this.r1z=this.r1.z+g*f;this.r2x=this.r2.x-n*
h;this.r2y=this.r2.y-m*h;this.r2z=this.r2.z-g*h;this.t1x1=this.r1y*this.az1-this.r1z*this.ay1;this.t1y1=this.r1z*this.ax1-this.r1x*this.az1;this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1;this.t2x1=this.r2y*this.az1-this.r2z*this.ay1;this.t2y1=this.r2z*this.ax1-this.r2x*this.az1;this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1;this.l1x1=this.ax1*this.m1;this.l1y1=this.ay1*this.m1;this.l1z1=this.az1*this.m1;this.l2x1=this.ax1*this.m2;this.l2y1=this.ay1*this.m2;this.l2z1=this.az1*this.m2;this.a1x1=this.t1x1*
this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02;this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12;this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22;this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02;this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12;this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22;this.t1x2=this.r1y*this.az2-this.r1z*this.ay2;this.t1y2=this.r1z*this.ax2-this.r1x*
this.az2;this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2;this.t2x2=this.r2y*this.az2-this.r2z*this.ay2;this.t2y2=this.r2z*this.ax2-this.r2x*this.az2;this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2;this.l1x2=this.ax2*this.m1;this.l1y2=this.ay2*this.m1;this.l1z2=this.az2*this.m1;this.l2x2=this.ax2*this.m2;this.l2y2=this.ay2*this.m2;this.l2z2=this.az2*this.m2;this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02;this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12;
this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22;this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02;this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12;this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22;this.t1x3=this.r1y*this.az3-this.r1z*this.ay3;this.t1y3=this.r1z*this.ax3-this.r1x*this.az3;this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3;this.t2x3=this.r2y*this.az3-this.r2z*this.ay3;this.t2y3=this.r2z*this.ax3-
this.r2x*this.az3;this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3;this.l1x3=this.ax3*this.m1;this.l1y3=this.ay3*this.m1;this.l1z3=this.az3*this.m1;this.l2x3=this.ax3*this.m2;this.l2y3=this.ay3*this.m2;this.l2z3=this.az3*this.m2;this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02;this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12;this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22;this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*
this.i2e02;this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12;this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;g=this.m1+this.m2;this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*g;this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*g;this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*g;this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*g;this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*
g;this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*g;this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*g;this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*g;this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*g;this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1;this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2;this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3;this.k10+=this.t1x2*this.a1x1+
this.t1y2*this.a1y1+this.t1z2*this.a1z1;this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2;this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3;this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1;this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2;this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3;this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1;this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+
this.t2z1*this.a2z2;this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3;this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1;this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2;this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3;this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1;this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2;this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3;
this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;l&&2!=this.limitState1?(l=6.2831853*k,k=l*l*a,l=c/(k+2*this.limitMotor1.dampingRatio*l),this.cfm1=this.kv00*l,this.limitVelocity1=this.limitVelocity1*k*l):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);e&&2!=this.limitState2?(l=6.2831853*b,k=l*l*a,l=c/(k+2*this.limitMotor2.dampingRatio*l),this.cfm2=this.kv11*l,this.limitVelocity2=this.limitVelocity2*k*l):(this.cfm2=
0,this.limitVelocity2=0.05*this.limitVelocity2*c);p&&2!=this.limitState3?(l=6.2831853*d,k=l*l*a,l=c/(k+2*this.limitMotor3.dampingRatio*l),this.cfm3=this.kv22*l,this.limitVelocity3=this.limitVelocity3*k*l):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-
this.k12*this.k21)*b;this.d01=(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;e=this.limitImpulse3+
this.motorImpulse3;this.l1.x+=b*this.l1x1+d*this.l1x2+e*this.l1x3;this.l1.y+=b*this.l1y1+d*this.l1y2+e*this.l1y3;this.l1.z+=b*this.l1z1+d*this.l1z2+e*this.l1z3;this.a1.x+=b*this.a1x1+d*this.a1x2+e*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+e*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+e*this.a1z3;this.l2.x-=b*this.l2x1+d*this.l2x2+e*this.l2x3;this.l2.y-=b*this.l2y1+d*this.l2y2+e*this.l2y3;this.l2.z-=b*this.l2z1+d*this.l2z2+e*this.l2z3;this.a2.x-=b*this.a2x1+d*this.a2x2+e*this.a2x3;this.a2.y-=b*
this.a2y1+d*this.a2y2+e*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+e*this.a2z3},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,
g=this.motorImpulse1,f=this.motorImpulse2,h=this.motorImpulse3,k=0,a=c=0;this.enableMotor1&&(k=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=k,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),k=this.motorImpulse1-g);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<
-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-f);this.enableMotor3&&(a=(b-this.motorSpeed3)*this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-h);var d=d+(k*this.kv00+c*this.k01+a*this.k02),e=e+(k*this.k10+c*this.kv11+a*this.k12),b=b+(k*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+
this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*this.cfm3),h=this.limitImpulse1,l=this.limitImpulse2,p=this.limitImpulse3,n=d*this.d00+e*this.d01+b*this.d02,f=d*this.d10+e*this.d11+b*this.d12,g=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=n;this.limitImpulse2+=f;this.limitImpulse3+=g;var m=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)n=-h,e+=n*this.k10,b+=n*this.k20,m|=1;if(2==this.limitState2||
0>this.limitImpulse2*this.limitState2)f=-l,d+=f*this.k01,b+=f*this.k21,m|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)g=-p,d+=g*this.k02,e+=g*this.k12,m|=4;switch(m){case 1:m=1/(this.k11*this.k22-this.k12*this.k21);f=(this.k22*e+-this.k12*b)*m;g=(-this.k21*e+this.k11*b)*m;break;case 2:m=1/(this.k00*this.k22-this.k02*this.k20);n=(this.k22*d+-this.k02*b)*m;g=(-this.k20*d+this.k00*b)*m;break;case 3:g=b/this.k22;break;case 4:m=1/(this.k00*this.k11-this.k01*this.k10);n=(this.k11*d+
-this.k01*e)*m;f=(-this.k10*d+this.k00*e)*m;break;case 5:f=e/this.k11;break;case 6:n=d/this.k00}this.limitImpulse1=h+n;this.limitImpulse2=l+f;this.limitImpulse3=p+g;d=k+n;e=c+f;a+=g;this.l1.x+=d*this.l1x1+e*this.l1x2+a*this.l1x3;this.l1.y+=d*this.l1y1+e*this.l1y2+a*this.l1y3;this.l1.z+=d*this.l1z1+e*this.l1z2+a*this.l1z3;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.l2.x-=d*this.l2x1+e*this.l2x2+a*
this.l2x3;this.l2.y-=d*this.l2y1+e*this.l2y2+a*this.l2y3;this.l2.z-=d*this.l2z1+e*this.l2z2+a*this.l2z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.TranslationalConstraint=function(a,c){this.limitVelocity=this.upperLimit=this.lowerLimit=this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.l2z=this.l2y=this.l2x=this.l1z=this.l1y=this.l1x=this.t2z=this.t2y=this.t2x=this.t1z=this.t1y=this.t1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=this.cfm=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;
this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;
this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=(this.p2.x-this.p1.x)*this.ax+(this.p2.y-this.p1.y)*this.ay+(this.p2.z-this.p1.z)*this.az,b=this.limitMotor.frequency,d=0<b,g=this.lowerLimit<=this.upperLimit;if(d&&20<e||-20>e)d=!1;g?(this.lowerLimit==this.upperLimit?
(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e,d||(e=this.upperLimit)):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.005<this.limitVelocity?
this.limitVelocity-0.005:-0.005>this.limitVelocity?this.limitVelocity+0.005:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=0;var g=e*this.ax,f=e*this.ay,e=e*this.az,h=this.m1/(this.m1+this.m2),k=1-h;this.r1x=this.r1.x+g*h;this.r1y=this.r1.y+f*h;this.r1z=this.r1.z+e*h;this.r2x=this.r2.x-g*k;this.r2y=this.r2.y-f*k;this.r2z=this.r2.z-e*k;this.t1x=this.r1y*this.az-this.r1z*this.ay;this.t1y=this.r1z*this.ax-
this.r1x*this.az;this.t1z=this.r1x*this.ay-this.r1y*this.ax;this.t2x=this.r2y*this.az-this.r2z*this.ay;this.t2y=this.r2z*this.ax-this.r2x*this.az;this.t2z=this.r2x*this.ay-this.r2y*this.ax;this.l1x=this.ax*this.m1;this.l1y=this.ay*this.m1;this.l1z=this.az*this.m1;this.l2x=this.ax*this.m2;this.l2y=this.ay*this.m2;this.l2z=this.az*this.m2;this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02;this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12;this.a1z=this.t1x*this.i1e20+
this.t1y*this.i1e21+this.t1z*this.i1e22;this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02;this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12;this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22;this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-
this.a2y*this.r2x);this.invMotorDenom=1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);b=this.limitImpulse+this.motorImpulse;this.l1.x+=b*this.l1x;this.l1.y+=b*this.l1y;this.l1.z+=b*this.l1z;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.l2.x-=b*this.l2x;
this.l2.y-=b*this.l2y;this.l2.z-=b*this.l2z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z,c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=
this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.l1.x+=c*this.l1x;this.l1.y+=c*this.l1y;this.l1.z+=c*this.l1z;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;
this.l2.x-=c*this.l2x;this.l2.y-=c*this.l2y;this.l2.z-=c*this.l2z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Contact=function(){this.next=this.prev=this.body2=this.body1=this.shape2=this.shape1=null;this.sleeping=this.persisting=!1;this.constraint=this.detector=null;this.touching=!1;this.b1Link=new OIMO.ContactLink(this);this.b2Link=new OIMO.ContactLink(this);this.s1Link=new OIMO.ContactLink(this);this.s2Link=new OIMO.ContactLink(this);this.manifold=new OIMO.ContactManifold;this.buffer=[];this.buffer.length=4;this.buffer[0]=new OIMO.ImpulseDataBuffer;this.buffer[1]=new OIMO.ImpulseDataBuffer;this.buffer[2]=
new OIMO.ImpulseDataBuffer;this.buffer[3]=new OIMO.ImpulseDataBuffer;this.points=this.manifold.points;this.constraint=new OIMO.ContactConstraint(this.manifold)};
OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(a,c){return Math.sqrt(a*c)},mixFriction:function(a,c){return Math.sqrt(a*c)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution);this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var a=this.manifold.numPoints,c=a;c--;){var b=this.buffer[c],d=this.points[c];b.lp1X=d.localPoint1.x;b.lp1Y=d.localPoint1.y;b.lp1Z=d.localPoint1.z;
b.lp2X=d.localPoint2.x;b.lp2Y=d.localPoint2.y;b.lp2Z=d.localPoint2.z;b.impulse=d.normalImpulse}this.manifold.numPoints=0;this.detector.detectCollision(this.shape1,this.shape2,this.manifold);c=this.manifold.numPoints;if(0==c)this.touching=!1;else for(this.touching=!0;c--;){for(var d=this.points[c],e=d.localPoint1.x,g=d.localPoint1.y,f=d.localPoint1.z,h=d.localPoint2.x,k=d.localPoint2.y,l=d.localPoint2.z,p=-1,n=4E-4,m=a;m--;){var b=this.buffer[m],r=b.lp1X-e,s=b.lp1Y-g,w=b.lp1Z-f,u=r*r+s*s+w*w,r=b.lp2X-
h,s=b.lp2Y-k,w=b.lp2Z-l,b=r*r+s*s+w*w;u<b?u<n&&(n=u,p=m):b<n&&(n=b,p=m)}-1!=p?(e=this.buffer[p],this.buffer[p]=this.buffer[--a],this.buffer[a]=e,d.normalImpulse=e.impulse,d.warmStarted=!0):(d.normalImpulse=0,d.warmStarted=!1)}},attach:function(a,c){this.shape1=a;this.shape2=c;this.body1=a.parent;this.body2=c.parent;this.manifold.body1=this.body1;this.manifold.body2=this.body2;this.constraint.body1=this.body1;this.constraint.body2=this.body2;this.constraint.attach();this.s1Link.shape=c;this.s1Link.body=
this.body2;this.s2Link.shape=a;this.s2Link.body=this.body1;null!=a.contactLink?(this.s1Link.next=a.contactLink).prev=this.s1Link:this.s1Link.next=null;a.contactLink=this.s1Link;a.numContacts++;null!=c.contactLink?(this.s2Link.next=c.contactLink).prev=this.s2Link:this.s2Link.next=null;c.contactLink=this.s2Link;c.numContacts++;this.b1Link.shape=c;this.b1Link.body=this.body2;this.b2Link.shape=a;this.b2Link.body=this.body1;null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:
this.b1Link.next=null;this.body1.contactLink=this.b1Link;this.body1.numContacts++;null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null;this.body2.contactLink=this.b2Link;this.body2.numContacts++;this.next=this.prev=null;this.persisting=!0;this.sleeping=this.body1.sleeping&&this.body2.sleeping;this.manifold.numPoints=0},detach:function(){var a=this.s1Link.prev,c=this.s1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape1.contactLink==
this.s1Link&&(this.shape1.contactLink=c);this.s1Link.prev=null;this.s1Link.next=null;this.s1Link.shape=null;this.s1Link.body=null;this.shape1.numContacts--;a=this.s2Link.prev;c=this.s2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=c);this.s2Link.prev=null;this.s2Link.next=null;this.s2Link.shape=null;this.s2Link.body=null;this.shape2.numContacts--;a=this.b1Link.prev;c=this.b1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body1.contactLink==
this.b1Link&&(this.body1.contactLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.shape=null;this.b1Link.body=null;this.body1.numContacts--;a=this.b2Link.prev;c=this.b2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body2.contactLink==this.b2Link&&(this.body2.contactLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.shape=null;this.b2Link.body=null;this.body2.numContacts--;this.manifold.body1=null;this.manifold.body2=null;this.constraint.body1=null;this.constraint.body2=
null;this.constraint.detach();this.body2=this.body1=this.shape2=this.shape1=null}};OIMO.ContactConstraint=function(a){OIMO.Constraint.call(this);this.manifold=a;this.friction=this.restitution=NaN;this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null;this.m2=this.m1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.num=0;this.ps=a.points;this.cs=new OIMO.ContactPointDataBuffer;this.cs.next=new OIMO.ContactPointDataBuffer;
this.cs.next.next=new OIMO.ContactPointDataBuffer;this.cs.next.next.next=new OIMO.ContactPointDataBuffer};OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position;this.p2=this.body2.position;this.lv1=this.body1.linearVelocity;this.av1=this.body1.angularVelocity;this.lv2=this.body2.linearVelocity;this.av2=this.body2.angularVelocity;this.i1=this.body1.inverseInertia;this.i2=this.body2.inverseInertia};
OIMO.ContactConstraint.prototype.detach=function(){this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null};
OIMO.ContactConstraint.prototype.preSolve=function(a,c){this.m1=this.body1.inverseMass;this.m2=this.body2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p1.x,d=this.p1.y,e=this.p1.z,g=this.p2.x,f=
this.p2.y,h=this.p2.z,k=this.m1+this.m2;this.num=this.manifold.numPoints;for(var l=this.cs,p=0;p<this.num;p++){var n=this.ps[p],m,r,s,w,u,y;m=n.position.x;r=n.position.y;s=n.position.z;var z=m-b,A=r-d,E=s-e,U=m-g,V=r-f,W=s-h;l.rp1X=z;l.rp1Y=A;l.rp1Z=E;l.rp2X=U;l.rp2Y=V;l.rp2Z=W;l.norImp=n.normalImpulse;l.tanImp=n.tangentImpulse;l.binImp=n.binormalImpulse;var ga=n.normal.x,ra=n.normal.y,N=n.normal.z,K=this.lv2.x+this.av2.y*W-this.av2.z*V-(this.lv1.x+this.av1.y*E-this.av1.z*A),ha=this.lv2.y+this.av2.z*
U-this.av2.x*W-(this.lv1.y+this.av1.z*z-this.av1.x*E),S=this.lv2.z+this.av2.x*V-this.av2.y*U-(this.lv1.z+this.av1.x*A-this.av1.y*z),G=ga*K+ra*ha+N*S,K=K-G*ga,L=ha-G*ra,M=S-G*N,S=K*K+L*L+M*M;0.04<S?S=1/Math.sqrt(S):(K=ra*ga-N*N,L=-N*ra-ga*ga,M=ga*N+ra*ra,S=1/Math.sqrt(K*K+L*L+M*M));var K=K*S,L=L*S,M=M*S,X=ra*M-N*L,Y=N*K-ga*M,Va=ga*L-ra*K;l.norX=ga;l.norY=ra;l.norZ=N;l.tanX=K;l.tanY=L;l.tanZ=M;l.binX=X;l.binY=Y;l.binZ=Va;l.norU1X=ga*this.m1;l.norU1Y=ra*this.m1;l.norU1Z=N*this.m1;l.norU2X=ga*this.m2;
l.norU2Y=ra*this.m2;l.norU2Z=N*this.m2;l.tanU1X=K*this.m1;l.tanU1Y=L*this.m1;l.tanU1Z=M*this.m1;l.tanU2X=K*this.m2;l.tanU2Y=L*this.m2;l.tanU2Z=M*this.m2;l.binU1X=X*this.m1;l.binU1Y=Y*this.m1;l.binU1Z=Va*this.m1;l.binU2X=X*this.m2;l.binU2Y=Y*this.m2;l.binU2Z=Va*this.m2;s=A*N-E*ra;w=E*ga-z*N;u=z*ra-A*ga;var Wa=V*N-W*ra,Xa=W*ga-U*N,Ya=U*ra-V*ga,Za=A*M-E*L,$a=E*K-z*M,ab=z*L-A*K,bb=V*M-W*L,cb=W*K-U*M,Z=U*L-V*K,$=A*Va-E*Y,aa=E*X-z*Va,ba=z*Y-A*X,ca=V*Va-W*Y,da=W*X-U*Va,ea=U*Y-V*X,S=s*this.i1e00+w*this.i1e01+
u*this.i1e02,ha=s*this.i1e10+w*this.i1e11+u*this.i1e12,ja=s*this.i1e20+w*this.i1e21+u*this.i1e22,ka=Wa*this.i2e00+Xa*this.i2e01+Ya*this.i2e02,Qb=Wa*this.i2e10+Xa*this.i2e11+Ya*this.i2e12,Rb=Wa*this.i2e20+Xa*this.i2e21+Ya*this.i2e22;m=Za*this.i1e00+$a*this.i1e01+ab*this.i1e02;r=Za*this.i1e10+$a*this.i1e11+ab*this.i1e12;y=Za*this.i1e20+$a*this.i1e21+ab*this.i1e22;var Sb=bb*this.i2e00+cb*this.i2e01+Z*this.i2e02,Tb=bb*this.i2e10+cb*this.i2e11+Z*this.i2e12,Ub=bb*this.i2e20+cb*this.i2e21+Z*this.i2e22,Vb=
$*this.i1e00+aa*this.i1e01+ba*this.i1e02,Wb=$*this.i1e10+aa*this.i1e11+ba*this.i1e12,Xb=$*this.i1e20+aa*this.i1e21+ba*this.i1e22,Yb=ca*this.i2e00+da*this.i2e01+ea*this.i2e02,db=ca*this.i2e10+da*this.i2e11+ea*this.i2e12,eb=ca*this.i2e20+da*this.i2e21+ea*this.i2e22;l.norT1X=s;l.norT1Y=w;l.norT1Z=u;l.tanT1X=Za;l.tanT1Y=$a;l.tanT1Z=ab;l.binT1X=$;l.binT1Y=aa;l.binT1Z=ba;l.norT2X=Wa;l.norT2Y=Xa;l.norT2Z=Ya;l.tanT2X=bb;l.tanT2Y=cb;l.tanT2Z=Z;l.binT2X=ca;l.binT2Y=da;l.binT2Z=ea;l.norTU1X=S;l.norTU1Y=ha;l.norTU1Z=
ja;l.tanTU1X=m;l.tanTU1Y=r;l.tanTU1Z=y;l.binTU1X=Vb;l.binTU1Y=Wb;l.binTU1Z=Xb;l.norTU2X=ka;l.norTU2Y=Qb;l.norTU2Z=Rb;l.tanTU2X=Sb;l.tanTU2Y=Tb;l.tanTU2Z=Ub;l.binTU2X=Yb;l.binTU2Y=db;l.binTU2Z=eb;m=s*this.i1e00+w*this.i1e01+u*this.i1e02;r=s*this.i1e10+w*this.i1e11+u*this.i1e12;s=s*this.i1e20+w*this.i1e21+u*this.i1e22;w=r*E-s*A;u=s*z-m*E;y=m*A-r*z;m=Wa*this.i2e00+Xa*this.i2e01+Ya*this.i2e02;r=Wa*this.i2e10+Xa*this.i2e11+Ya*this.i2e12;s=Wa*this.i2e20+Xa*this.i2e21+Ya*this.i2e22;w+=r*W-s*V;u+=s*U-m*W;
y+=m*V-r*U;ga=1/(k+ga*w+ra*u+N*y);m=Za*this.i1e00+$a*this.i1e01+ab*this.i1e02;r=Za*this.i1e10+$a*this.i1e11+ab*this.i1e12;s=Za*this.i1e20+$a*this.i1e21+ab*this.i1e22;w=r*E-s*A;u=s*z-m*E;y=m*A-r*z;m=bb*this.i2e00+cb*this.i2e01+Z*this.i2e02;r=bb*this.i2e10+cb*this.i2e11+Z*this.i2e12;s=bb*this.i2e20+cb*this.i2e21+Z*this.i2e22;w+=r*W-s*V;u+=s*U-m*W;y+=m*V-r*U;ra=1/(k+K*w+L*u+M*y);m=$*this.i1e00+aa*this.i1e01+ba*this.i1e02;r=$*this.i1e10+aa*this.i1e11+ba*this.i1e12;s=$*this.i1e20+aa*this.i1e21+ba*this.i1e22;
w=r*E-s*A;u=s*z-m*E;y=m*A-r*z;m=ca*this.i2e00+da*this.i2e01+ea*this.i2e02;r=ca*this.i2e10+da*this.i2e11+ea*this.i2e12;s=ca*this.i2e20+da*this.i2e21+ea*this.i2e22;w+=r*W-s*V;u+=s*U-m*W;y+=m*V-r*U;z=1/(k+X*w+Y*u+Va*y);l.norDen=ga;l.tanDen=ra;l.binDen=z;n.warmStarted?(G=n.normalImpulse,this.lv1.x+=l.norU1X*G,this.lv1.y+=l.norU1Y*G,this.lv1.z+=l.norU1Z*G,this.av1.x+=S*G,this.av1.y+=ha*G,this.av1.z+=ja*G,this.lv2.x-=l.norU2X*G,this.lv2.y-=l.norU2Y*G,this.lv2.z-=l.norU2Z*G,this.av2.x-=ka*G,this.av2.y-=
Qb*G,this.av2.z-=Rb*G,l.norImp=G,l.tanImp=0,G=l.binImp=0):(l.norImp=0,l.tanImp=0,l.binImp=0);-1<G&&(G=0);G=this.restitution*-G;n=-(n.penetration+0.005)*c*0.05;G<n&&(G=n);l.norTar=G;l.last=p==this.num-1;l=l.next}};
OIMO.ContactConstraint.prototype.solve=function(){for(var a=this.lv1.x,c=this.lv1.y,b=this.lv1.z,d=this.lv2.x,e=this.lv2.y,g=this.lv2.z,f=this.av1.x,h=this.av1.y,k=this.av1.z,l=this.av2.x,p=this.av2.y,n=this.av2.z,m=this.cs;;){var r,s,w,u,y=m.norImp,z=m.tanImp,A=m.binImp,E=-y*this.friction;w=d-a;u=e-c;var U=g-b;s=w*m.tanX+u*m.tanY+U*m.tanZ+l*m.tanT2X+p*m.tanT2Y+n*m.tanT2Z-f*m.tanT1X-h*m.tanT1Y-k*m.tanT1Z;r=z;s*=m.tanDen;z+=s;s=w*m.binX+u*m.binY+U*m.binZ+l*m.binT2X+p*m.binT2Y+n*m.binT2Z-f*m.binT1X-
h*m.binT1Y-k*m.binT1Z;w=A;u=s*m.binDen;A+=u;s=z*z+A*A;s>E*E&&(s=E/Math.sqrt(s),z*=s,A*=s);s=z-r;u=A-w;a+=m.tanU1X*s+m.binU1X*u;c+=m.tanU1Y*s+m.binU1Y*u;b+=m.tanU1Z*s+m.binU1Z*u;f+=m.tanTU1X*s+m.binTU1X*u;h+=m.tanTU1Y*s+m.binTU1Y*u;k+=m.tanTU1Z*s+m.binTU1Z*u;d-=m.tanU2X*s+m.binU2X*u;e-=m.tanU2Y*s+m.binU2Y*u;g-=m.tanU2Z*s+m.binU2Z*u;l-=m.tanTU2X*s+m.binTU2X*u;p-=m.tanTU2Y*s+m.binTU2Y*u;n-=m.tanTU2Z*s+m.binTU2Z*u;s=(d-a)*m.norX+(e-c)*m.norY+(g-b)*m.norZ+l*m.norT2X+p*m.norT2Y+n*m.norT2Z-f*m.norT1X-h*
m.norT1Y-k*m.norT1Z;r=y;s=(s-m.norTar)*m.norDen;y+=s;0<y&&(y=0);s=y-r;a+=m.norU1X*s;c+=m.norU1Y*s;b+=m.norU1Z*s;f+=m.norTU1X*s;h+=m.norTU1Y*s;k+=m.norTU1Z*s;d-=m.norU2X*s;e-=m.norU2Y*s;g-=m.norU2Z*s;l-=m.norTU2X*s;p-=m.norTU2Y*s;n-=m.norTU2Z*s;m.norImp=y;m.tanImp=z;m.binImp=A;if(m.last)break;m=m.next}this.lv1.x=a;this.lv1.y=c;this.lv1.z=b;this.lv2.x=d;this.lv2.y=e;this.lv2.z=g;this.av1.x=f;this.av1.y=h;this.av1.z=k;this.av2.x=l;this.av2.y=p;this.av2.z=n};
OIMO.ContactConstraint.prototype.postSolve=function(){for(var a=this.cs,c=this.num;c--;){var b=this.ps[c];b.normal.x=a.norX;b.normal.y=a.norY;b.normal.z=a.norZ;b.tangent.x=a.tanX;b.tangent.y=a.tanY;b.tangent.z=a.tanZ;b.binormal.x=a.binX;b.binormal.y=a.binY;b.binormal.z=a.binZ;b.normalImpulse=a.norImp;b.tangentImpulse=a.tanImp;b.binormalImpulse=a.binImp;b.normalDenominator=a.norDen;b.tangentDenominator=a.tanDen;b.binormalDenominator=a.binDen;a=a.next}};OIMO.ContactLink=function(a){this.body=this.shape=this.next=this.prev=null;this.contact=a};OIMO.ContactManifold=function(){this.body2=this.body1=null;this.numPoints=0;this.points=[];this.points.length=4;this.points[0]=new OIMO.ManifoldPoint;this.points[1]=new OIMO.ManifoldPoint;this.points[2]=new OIMO.ManifoldPoint;this.points[3]=new OIMO.ManifoldPoint};
OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(a,c){this.body1=a.parent;this.body2=c.parent;this.numPoints=0},addPoint:function(a,c,b,d,e,g,f,h){var k=this.points[this.numPoints++];k.position.x=a;k.position.y=c;k.position.z=b;var l=a-this.body1.position.x,p=c-this.body1.position.y,n=b-this.body1.position.z,m=this.body1.rotation.elements;k.localPoint1.x=l*m[0]+p*m[3]+n*m[6];k.localPoint1.y=l*m[1]+p*m[4]+n*m[7];k.localPoint1.z=l*m[2]+p*m[5]+n*m[8];l=a-this.body2.position.x;
p=c-this.body2.position.y;n=b-this.body2.position.z;k.localPoint2.x=l*m[0]+p*m[3]+n*m[6];k.localPoint2.y=l*m[1]+p*m[4]+n*m[7];k.localPoint2.z=l*m[2]+p*m[5]+n*m[8];k.normalImpulse=0;h?(k.normal.x=-d,k.normal.y=-e,k.normal.z=-g):(k.normal.x=d,k.normal.y=e,k.normal.z=g);k.penetration=f;k.warmStarted=!1}};OIMO.ContactPointDataBuffer=function(){this.norTar=this.binDen=this.tanDen=this.norDen=this.binImp=this.tanImp=this.norImp=this.binTU2Z=this.binTU2Y=this.binTU2X=this.binTU1Z=this.binTU1Y=this.binTU1X=this.tanTU2Z=this.tanTU2Y=this.tanTU2X=this.tanTU1Z=this.tanTU1Y=this.tanTU1X=this.norTU2Z=this.norTU2Y=this.norTU2X=this.norTU1Z=this.norTU1Y=this.norTU1X=this.binT2Z=this.binT2Y=this.binT2X=this.binT1Z=this.binT1Y=this.binT1X=this.tanT2Z=this.tanT2Y=this.tanT2X=this.tanT1Z=this.tanT1Y=this.tanT1X=
this.norT2Z=this.norT2Y=this.norT2X=this.norT1Z=this.norT1Y=this.norT1X=this.binU2Z=this.binU2Y=this.binU2X=this.binU1Z=this.binU1Y=this.binU1X=this.tanU2Z=this.tanU2Y=this.tanU2X=this.tanU1Z=this.tanU1Y=this.tanU1X=this.norU2Z=this.norU2Y=this.norU2X=this.norU1Z=this.norU1Y=this.norU1X=this.rp2Z=this.rp2Y=this.rp2X=this.rp1Z=this.rp1Y=this.rp1X=this.binZ=this.binY=this.binX=this.tanZ=this.tanY=this.tanX=this.norZ=this.norY=this.norX=NaN;this.next=null;this.last=!1};OIMO.ImpulseDataBuffer=function(){this.impulse=this.lp2Z=this.lp2Y=this.lp2X=this.lp1Z=this.lp1Y=this.lp1X=NaN};OIMO.ManifoldPoint=function(){this.warmStarted=!1;this.position=new OIMO.Vec3;this.localPoint1=new OIMO.Vec3;this.localPoint2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.penetration=this.binormalDenominator=this.tangentDenominator=this.normalDenominator=this.binormalImpulse=this.tangentImpulse=this.normalImpulse=0};OIMO.MassInfo=function(){this.mass=0;this.inertia=new OIMO.Mat33};OIMO.Shape=function(a){this.id=OIMO.nextID++;this.next=this.prev=null;this.type=0;this.contactLink=this.parent=this.proxy=null;this.numContacts=0;this.position=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.relativePosition=(new OIMO.Vec3).copy(a.relativePosition);this.relativeRotation=(new OIMO.Mat33).copy(a.relativeRotation);this.aabb=new OIMO.AABB;this.density=a.density;this.friction=a.friction;this.restitution=a.restitution;this.belongsTo=a.belongsTo;this.collidesWith=a.collidesWith};
OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(a){throw Error("Inheritance error.");},updateProxy:function(){throw Error("Inheritance error.");}};OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3;this.relativeRotation=new OIMO.Mat33;this.friction=0.4;this.restitution=0.2;this.belongsTo=this.density=1;this.collidesWith=4294967295};OIMO.BoxShape=function(a,c,b,d){OIMO.Shape.call(this,a);this.width=c;this.height=b;this.depth=d;this.halfWidth=0.5*c;this.halfHeight=0.5*b;this.halfDepth=0.5*d;this.dimentions=new OIMO_ARRAY_TYPE(18);this.elements=new OIMO_ARRAY_TYPE(24);this.type=OIMO.SHAPE_BOX};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);
OIMO.BoxShape.prototype.calculateMassInfo=function(a){var c=this.width*this.height*this.depth*this.density;a.mass=c;a.inertia.init(c*(this.height*this.height+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.height*this.height)/12)};
OIMO.BoxShape.prototype.updateProxy=function(){var a=this.rotation.elements,c=this.dimentions;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];c[9]=a[0]*this.halfWidth;c[10]=a[3]*this.halfWidth;c[11]=a[6]*this.halfWidth;c[12]=a[1]*this.halfHeight;c[13]=a[4]*this.halfHeight;c[14]=a[7]*this.halfHeight;c[15]=a[2]*this.halfDepth;c[16]=a[5]*this.halfDepth;c[17]=a[8]*this.halfDepth;var a=c[9],b=c[10],d=c[11],e=c[12],g=c[13],f=c[14],h=c[15],k=c[16],l=c[17],p=this.position.x,
n=this.position.y,m=this.position.z,r=this.elements;r[0]=p+a+e+h;r[1]=n+b+g+k;r[2]=m+d+f+l;r[3]=p+a+e-h;r[4]=n+b+g-k;r[5]=m+d+f-l;r[6]=p+a-e+h;r[7]=n+b-g+k;r[8]=m+d-f+l;r[9]=p+a-e-h;r[10]=n+b-g-k;r[11]=m+d-f-l;r[12]=p-a+e+h;r[13]=n-b+g+k;r[14]=m-d+f+l;r[15]=p-a+e-h;r[16]=n-b+g-k;r[17]=m-d+f-l;r[18]=p-a-e+h;r[19]=n-b-g+k;r[20]=m-d-f+l;r[21]=p-a-e-h;r[22]=n-b-g-k;r[23]=m-d-f-l;a=0>c[9]?-c[9]:c[9];b=0>c[10]?-c[10]:c[10];d=0>c[11]?-c[11]:c[11];a=0>c[12]?a-c[12]:a+c[12];b=0>c[13]?b-c[13]:b+c[13];d=0>c[14]?
d-c[14]:d+c[14];a=0>c[15]?a-c[15]:a+c[15];b=0>c[16]?b-c[16]:b+c[16];d=0>c[17]?d-c[17]:d+c[17];this.aabb.init(this.position.x-a-0.005,this.position.x+a+0.005,this.position.y-b-0.005,this.position.y+b+0.005,this.position.z-d-0.005,this.position.z+d+0.005);null!==this.proxy&&this.proxy.update()};OIMO.SphereShape=function(a,c){OIMO.Shape.call(this,a);this.radius=c;this.type=OIMO.SHAPE_SPHERE};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.calculateMassInfo=function(a){var c=4/3*Math.PI*this.radius*this.radius*this.radius*this.density;a.mass=c;c=c*this.radius*this.radius*2/5;a.inertia.init(c,0,0,0,c,0,0,0,c)};
OIMO.SphereShape.prototype.updateProxy=function(){this.aabb.init(this.position.x-this.radius-0.005,this.position.x+this.radius+0.005,this.position.y-this.radius-0.005,this.position.y+this.radius+0.005,this.position.z-this.radius-0.005,this.position.z+this.radius+0.005);null!==this.proxy&&this.proxy.update()};OIMO.CollisionDetector=function(){this.flip=!1};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(a,c,b){throw Error("Inheritance error.");}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=new OIMO_ARRAY_TYPE(24);this.clipVertices2=new OIMO_ARRAY_TYPE(24);this.used=new OIMO_ARRAY_TYPE(8);this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);var g=d.elements,f=e.elements,h=d.dimentions,k=e.dimentions,l=d.position,p=e.position,n=l.x,m=l.y,r=l.z,s=p.x,w=p.y,u=p.z,y=s-n,z=w-m,A=u-r,E=d.halfWidth,U=d.halfHeight,V=d.halfDepth,W=e.halfWidth,ga=e.halfHeight,ra=e.halfDepth,N=h[0],K=h[1],ha=h[2],S=h[3],G=h[4],L=h[5],M=h[6],X=h[7],Y=h[8],Va=h[9],Wa=h[10],Xa=h[11],Ya=h[12],Za=h[13],$a=h[14],ab=h[15],bb=h[16],cb=h[17],Z=k[0],$=k[1],aa=k[2],
ba=k[3],ca=k[4],da=k[5],ea=k[6],ja=k[7],ka=k[8],Qb=k[9],Rb=k[10],Sb=k[11],Tb=k[12],Ub=k[13],Vb=k[14],Wb=k[15],Xb=k[16],Yb=k[17],db=K*aa-ha*$,eb=ha*Z-N*aa,ib=N*$-K*Z,jb=K*da-ha*ca,kb=ha*ba-N*da,lb=N*ca-K*ba,mb=K*ka-ha*ja,nb=ha*ea-N*ka,ob=N*ja-K*ea,pb=G*aa-L*$,qb=L*Z-S*aa,rb=S*$-G*Z,sb=G*da-L*ca,tb=L*ba-S*da,ub=S*ca-G*ba,vb=G*ka-L*ja,wb=L*ea-S*ka,xb=S*ja-G*ea,yb=X*aa-Y*$,zb=Y*Z-M*aa,Ab=M*$-X*Z,Bb=X*da-Y*ca,Cb=Y*ba-M*da,Db=M*ca-X*ba,Eb=X*ka-Y*ja,Fb=Y*ea-M*ka,Gb=M*ja-X*ea,Bc,Cc,Dc,Ec,Fc,Gc,qc,rc,sc,tc,
uc,vc,wc,xc,yc,kc,lc,mc,nc,oc,pc,Zb,$b,ac,bc,cc,dc,ec,fc,gc,Hc=!1,Ic=!1,Jc=!1,Kc=!1,Lc=!1,Mc=!1,Nc=!1,Oc=!1,Pc=!1,v,la,ma,q,t,na;v=N*y+K*z+ha*A;(Bc=0<v)||(v=-v);la=E;q=N*Z+K*$+ha*aa;t=N*ba+K*ca+ha*da;na=N*ea+K*ja+ha*ka;0>q&&(q=-q);0>t&&(t=-t);0>na&&(na=-na);ma=q*W+t*ga+na*ra;kc=v-la-ma;if(!(0<kc||(v=S*y+G*z+L*A,(Cc=0<v)||(v=-v),la=U,q=S*Z+G*$+L*aa,t=S*ba+G*ca+L*da,na=S*ea+G*ja+L*ka,0>q&&(q=-q),0>t&&(t=-t),0>na&&(na=-na),ma=q*W+t*ga+na*ra,lc=v-la-ma,0<lc||(v=M*y+X*z+Y*A,(Dc=0<v)||(v=-v),la=V,q=M*Z+
X*$+Y*aa,t=M*ba+X*ca+Y*da,na=M*ea+X*ja+Y*ka,0>q&&(q=-q),0>t&&(t=-t),0>na&&(na=-na),ma=q*W+t*ga+na*ra,mc=v-la-ma,0<mc||(v=Z*y+$*z+aa*A,(Ec=0<v)||(v=-v),q=Z*N+$*K+aa*ha,t=Z*S+$*G+aa*L,na=Z*M+$*X+aa*Y,0>q&&(q=-q),0>t&&(t=-t),0>na&&(na=-na),la=q*E+t*U+na*V,ma=W,nc=1*(v-la-ma),0<nc||(v=ba*y+ca*z+da*A,(Fc=0<v)||(v=-v),q=ba*N+ca*K+da*ha,t=ba*S+ca*G+da*L,na=ba*M+ca*X+da*Y,0>q&&(q=-q),0>t&&(t=-t),0>na&&(na=-na),la=q*E+t*U+na*V,ma=ga,oc=1*(v-la-ma),0<oc||(v=ea*y+ja*z+ka*A,(Gc=0<v)||(v=-v),q=ea*N+ja*K+ka*ha,
t=ea*S+ja*G+ka*L,na=ea*M+ja*X+ka*Y,0>q&&(q=-q),0>t&&(t=-t),0>na&&(na=-na),la=q*E+t*U+na*V,ma=ra,pc=1*(v-la-ma),0<pc))))))){v=db*db+eb*eb+ib*ib;if(1E-5<v){if(v=1/Math.sqrt(v),db*=v,eb*=v,ib*=v,v=db*y+eb*z+ib*A,(qc=0<v)||(v=-v),q=db*S+eb*G+ib*L,t=db*M+eb*X+ib*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*U+t*V,q=db*ba+eb*ca+ib*da,t=db*ea+eb*ja+ib*ka,0>q&&(q=-q),0>t&&(t=-t),ma=q*ga+t*ra,Zb=v-la-ma,0<Zb)return}else qc=!1,Zb=0,Hc=!0;v=jb*jb+kb*kb+lb*lb;if(1E-5<v){if(v=1/Math.sqrt(v),jb*=v,kb*=v,lb*=v,v=jb*y+kb*z+lb*
A,(rc=0<v)||(v=-v),q=jb*S+kb*G+lb*L,t=jb*M+kb*X+lb*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*U+t*V,q=jb*Z+kb*$+lb*aa,t=jb*ea+kb*ja+lb*ka,0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ra,$b=v-la-ma,0<$b)return}else rc=!1,$b=0,Ic=!0;v=mb*mb+nb*nb+ob*ob;if(1E-5<v){if(v=1/Math.sqrt(v),mb*=v,nb*=v,ob*=v,v=mb*y+nb*z+ob*A,(sc=0<v)||(v=-v),q=mb*S+nb*G+ob*L,t=mb*M+nb*X+ob*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*U+t*V,q=mb*Z+nb*$+ob*aa,t=mb*ba+nb*ca+ob*da,0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ga,ac=v-la-ma,0<ac)return}else sc=!1,ac=0,Jc=!0;v=pb*
pb+qb*qb+rb*rb;if(1E-5<v){if(v=1/Math.sqrt(v),pb*=v,qb*=v,rb*=v,v=pb*y+qb*z+rb*A,(tc=0<v)||(v=-v),q=pb*N+qb*K+rb*ha,t=pb*M+qb*X+rb*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*V,q=pb*ba+qb*ca+rb*da,t=pb*ea+qb*ja+rb*ka,0>q&&(q=-q),0>t&&(t=-t),ma=q*ga+t*ra,bc=v-la-ma,0<bc)return}else tc=!1,bc=0,Kc=!0;v=sb*sb+tb*tb+ub*ub;if(1E-5<v){if(v=1/Math.sqrt(v),sb*=v,tb*=v,ub*=v,v=sb*y+tb*z+ub*A,(uc=0<v)||(v=-v),q=sb*N+tb*K+ub*ha,t=sb*M+tb*X+ub*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*V,q=sb*Z+tb*$+ub*aa,t=sb*ea+tb*ja+ub*ka,
0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ra,cc=v-la-ma,0<cc)return}else uc=!1,cc=0,Lc=!0;v=vb*vb+wb*wb+xb*xb;if(1E-5<v){if(v=1/Math.sqrt(v),vb*=v,wb*=v,xb*=v,v=vb*y+wb*z+xb*A,(vc=0<v)||(v=-v),q=vb*N+wb*K+xb*ha,t=vb*M+wb*X+xb*Y,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*V,q=vb*Z+wb*$+xb*aa,t=vb*ba+wb*ca+xb*da,0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ga,dc=v-la-ma,0<dc)return}else vc=!1,dc=0,Mc=!0;v=yb*yb+zb*zb+Ab*Ab;if(1E-5<v){if(v=1/Math.sqrt(v),yb*=v,zb*=v,Ab*=v,v=yb*y+zb*z+Ab*A,(wc=0<v)||(v=-v),q=yb*N+zb*K+Ab*ha,t=yb*S+
zb*G+Ab*L,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*U,q=yb*ba+zb*ca+Ab*da,t=yb*ea+zb*ja+Ab*ka,0>q&&(q=-q),0>t&&(t=-t),ma=q*ga+t*ra,ec=v-la-ma,0<ec)return}else wc=!1,ec=0,Nc=!0;v=Bb*Bb+Cb*Cb+Db*Db;if(1E-5<v){if(v=1/Math.sqrt(v),Bb*=v,Cb*=v,Db*=v,v=Bb*y+Cb*z+Db*A,(xc=0<v)||(v=-v),q=Bb*N+Cb*K+Db*ha,t=Bb*S+Cb*G+Db*L,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*U,q=Bb*Z+Cb*$+Db*aa,t=Bb*ea+Cb*ja+Db*ka,0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ra,fc=v-la-ma,0<fc)return}else xc=!1,fc=0,Oc=!0;v=Eb*Eb+Fb*Fb+Gb*Gb;if(1E-5<v){if(v=1/Math.sqrt(v),
Eb*=v,Fb*=v,Gb*=v,v=Eb*y+Fb*z+Gb*A,(yc=0<v)||(v=-v),q=Eb*N+Fb*K+Gb*ha,t=Eb*S+Fb*G+Gb*L,0>q&&(q=-q),0>t&&(t=-t),la=q*E+t*U,q=Eb*Z+Fb*$+Gb*aa,t=Eb*ba+Fb*ca+Gb*da,0>q&&(q=-q),0>t&&(t=-t),ma=q*W+t*ga,gc=v-la-ma,0<gc)return}else yc=!1,gc=0,Pc=!0;var Ha=kc,va=kc,oa=0,Ga=Bc;lc>va&&(va=Ha=lc,oa=1,Ga=Cc);mc>va&&(va=Ha=mc,oa=2,Ga=Dc);nc>va&&(va=Ha=nc,oa=3,Ga=Ec);oc>va&&(va=Ha=oc,oa=4,Ga=Fc);pc>va&&(va=Ha=pc,oa=5,Ga=Gc);Zb-0.01>va&&!Hc&&(Ha=Zb,va=Zb-0.01,oa=6,Ga=qc);$b-0.01>va&&!Ic&&(Ha=$b,va=$b-0.01,oa=7,Ga=
rc);ac-0.01>va&&!Jc&&(Ha=ac,va=ac-0.01,oa=8,Ga=sc);bc-0.01>va&&!Kc&&(Ha=bc,va=bc-0.01,oa=9,Ga=tc);cc-0.01>va&&!Lc&&(Ha=cc,va=cc-0.01,oa=10,Ga=uc);dc-0.01>va&&!Mc&&(Ha=dc,va=dc-0.01,oa=11,Ga=vc);ec-0.01>va&&!Nc&&(Ha=ec,va=ec-0.01,oa=12,Ga=wc);fc-0.01>va&&!Oc&&(Ha=fc,va=fc-0.01,oa=13,Ga=xc);gc-0.01>va&&!Pc&&(Ha=gc,oa=14,Ga=yc);var B=0,C=0,D=0,za=0,Aa=0,Ba=0,Da=0,Ea=0,Fa=0,wa=0,xa=0,ya=0,Hb=0,Ib=0,Jb=0,Kb=0,Lb=0,Mb=0,hc=!1;0==oa?(Ga?(wa=n+Va,xa=m+Wa,ya=r+Xa,B=N,C=K,D=ha):(wa=n-Va,xa=m-Wa,ya=r-Xa,B=-N,
C=-K,D=-ha),Hb=Ya,Ib=Za,Jb=$a,za=-S,Aa=-G,Ba=-L,Kb=ab,Lb=bb,Mb=cb,Da=-M,Ea=-X,Fa=-Y):1==oa?(Ga?(wa=n+Ya,xa=m+Za,ya=r+$a,B=S,C=G,D=L):(wa=n-Ya,xa=m-Za,ya=r-$a,B=-S,C=-G,D=-L),Hb=Va,Ib=Wa,Jb=Xa,za=-N,Aa=-K,Ba=-ha,Kb=ab,Lb=bb,Mb=cb,Da=-M,Ea=-X,Fa=-Y):2==oa?(Ga?(wa=n+ab,xa=m+bb,ya=r+cb,B=M,C=X,D=Y):(wa=n-ab,xa=m-bb,ya=r-cb,B=-M,C=-X,D=-Y),Hb=Va,Ib=Wa,Jb=Xa,za=-N,Aa=-K,Ba=-ha,Kb=Ya,Lb=Za,Mb=$a,Da=-S,Ea=-G,Fa=-L):3==oa?(hc=!0,Ga?(wa=s-Qb,xa=w-Rb,ya=u-Sb,B=-Z,C=-$,D=-aa):(wa=s+Qb,xa=w+Rb,ya=u+Sb,B=Z,C=$,
D=aa),Hb=Tb,Ib=Ub,Jb=Vb,za=-ba,Aa=-ca,Ba=-da,Kb=Wb,Lb=Xb,Mb=Yb,Da=-ea,Ea=-ja,Fa=-ka):4==oa?(hc=!0,Ga?(wa=s-Tb,xa=w-Ub,ya=u-Vb,B=-ba,C=-ca,D=-da):(wa=s+Tb,xa=w+Ub,ya=u+Vb,B=ba,C=ca,D=da),Hb=Qb,Ib=Rb,Jb=Sb,za=-Z,Aa=-$,Ba=-aa,Kb=Wb,Lb=Xb,Mb=Yb,Da=-ea,Ea=-ja,Fa=-ka):5==oa?(hc=!0,Ga?(wa=s-Wb,xa=w-Xb,ya=u-Yb,B=-ea,C=-ja,D=-ka):(wa=s+Wb,xa=w+Xb,ya=u+Yb,B=ea,C=ja,D=ka),Hb=Qb,Ib=Rb,Jb=Sb,za=-Z,Aa=-$,Ba=-aa,Kb=Tb,Lb=Ub,Mb=Vb,Da=-ba,Ea=-ca,Fa=-da):6==oa?(B=db,C=eb,D=ib,za=N,Aa=K,Ba=ha,Da=Z,Ea=$,Fa=aa):7==oa?
(B=jb,C=kb,D=lb,za=N,Aa=K,Ba=ha,Da=ba,Ea=ca,Fa=da):8==oa?(B=mb,C=nb,D=ob,za=N,Aa=K,Ba=ha,Da=ea,Ea=ja,Fa=ka):9==oa?(B=pb,C=qb,D=rb,za=S,Aa=G,Ba=L,Da=Z,Ea=$,Fa=aa):10==oa?(B=sb,C=tb,D=ub,za=S,Aa=G,Ba=L,Da=ba,Ea=ca,Fa=da):11==oa?(B=vb,C=wb,D=xb,za=S,Aa=G,Ba=L,Da=ea,Ea=ja,Fa=ka):12==oa?(B=yb,C=zb,D=Ab,za=M,Aa=X,Ba=Y,Da=Z,Ea=$,Fa=aa):13==oa?(B=Bb,C=Cb,D=Db,za=M,Aa=X,Ba=Y,Da=ba,Ea=ca,Fa=da):14==oa&&(B=Eb,C=Fb,D=Gb,za=M,Aa=X,Ba=Y,Da=ea,Ea=ja,Fa=ka);if(5<oa){Ga||(B=-B,C=-C,D=-D);var R,pa,O,P,Q,fb,gb,hb,Nb,
Ob,Pb;fb=g[0];gb=g[1];hb=g[2];pa=B*fb+C*gb+D*hb;O=g[3];P=g[4];Q=g[5];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[6];P=g[7];Q=g[8];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[9];P=g[10];Q=g[11];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[12];P=g[13];Q=g[14];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[15];P=g[16];Q=g[17];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[18];P=g[19];Q=g[20];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);O=g[21];P=g[22];Q=g[23];R=B*O+C*P+D*Q;R>pa&&(pa=R,fb=O,gb=P,hb=Q);
Nb=f[0];Ob=f[1];Pb=f[2];pa=B*Nb+C*Ob+D*Pb;O=f[3];P=f[4];Q=f[5];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[6];P=f[7];Q=f[8];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[9];P=f[10];Q=f[11];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[12];P=f[13];Q=f[14];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[15];P=f[16];Q=f[17];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[18];P=f[19];Q=f[20];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=f[21];P=f[22];Q=f[23];R=B*O+C*P+D*Q;R<pa&&(pa=R,Nb=O,Ob=P,Pb=Q);O=Nb-
fb;P=Ob-gb;Q=Pb-hb;q=za*Da+Aa*Ea+Ba*Fa;var fa=(O*(za-Da*q)+P*(Aa-Ea*q)+Q*(Ba-Fa*q))/(1-q*q);b.addPoint(fb+za*fa+B*Ha*0.5,gb+Aa*fa+C*Ha*0.5,hb+Ba*fa+D*Ha*0.5,B,C,D,Ha,!1)}else{var Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,qa=1,F=0,Ca=0;hc?(F=N*B+K*C+ha*D,F<qa&&(qa=F,Ca=0),-F<qa&&(qa=-F,Ca=1),F=S*B+G*C+L*D,F<qa&&(qa=F,Ca=2),-F<qa&&(qa=-F,Ca=3),F=M*B+X*C+Y*D,F<qa&&(qa=F,Ca=4),-F<qa&&(qa=-F,Ca=5),0==Ca?(Ja=g[0],Ka=g[1],La=g[2],Ma=g[6],Na=g[7],Oa=g[8],Pa=g[9],Qa=g[10],Ra=g[11],Sa=g[3],Ta=g[4],Ua=g[5]):1==Ca?
(Ja=g[15],Ka=g[16],La=g[17],Ma=g[21],Na=g[22],Oa=g[23],Pa=g[18],Qa=g[19],Ra=g[20],Sa=g[12],Ta=g[13],Ua=g[14]):2==Ca?(Ja=g[12],Ka=g[13],La=g[14],Ma=g[0],Na=g[1],Oa=g[2],Pa=g[3],Qa=g[4],Ra=g[5],Sa=g[15],Ta=g[16],Ua=g[17]):3==Ca?(Ja=g[21],Ka=g[22],La=g[23],Ma=g[9],Na=g[10],Oa=g[11],Pa=g[6],Qa=g[7],Ra=g[8],Sa=g[18],Ta=g[19],Ua=g[20]):4==Ca?(Ja=g[12],Ka=g[13],La=g[14],Ma=g[18],Na=g[19],Oa=g[20],Pa=g[6],Qa=g[7],Ra=g[8],Sa=g[0],Ta=g[1],Ua=g[2]):5==Ca&&(Ja=g[3],Ka=g[4],La=g[5],Ma=g[6],Na=g[7],Oa=g[8],Pa=
g[21],Qa=g[22],Ra=g[23],Sa=g[15],Ta=g[16],Ua=g[17])):(F=Z*B+$*C+aa*D,F<qa&&(qa=F,Ca=0),-F<qa&&(qa=-F,Ca=1),F=ba*B+ca*C+da*D,F<qa&&(qa=F,Ca=2),-F<qa&&(qa=-F,Ca=3),F=ea*B+ja*C+ka*D,F<qa&&(qa=F,Ca=4),-F<qa&&(qa=-F,Ca=5),0==Ca?(Ja=f[0],Ka=f[1],La=f[2],Ma=f[6],Na=f[7],Oa=f[8],Pa=f[9],Qa=f[10],Ra=f[11],Sa=f[3],Ta=f[4],Ua=f[5]):1==Ca?(Ja=f[15],Ka=f[16],La=f[17],Ma=f[21],Na=f[22],Oa=f[23],Pa=f[18],Qa=f[19],Ra=f[20],Sa=f[12],Ta=f[13],Ua=f[14]):2==Ca?(Ja=f[12],Ka=f[13],La=f[14],Ma=f[0],Na=f[1],Oa=f[2],Pa=f[3],
Qa=f[4],Ra=f[5],Sa=f[15],Ta=f[16],Ua=f[17]):3==Ca?(Ja=f[21],Ka=f[22],La=f[23],Ma=f[9],Na=f[10],Oa=f[11],Pa=f[6],Qa=f[7],Ra=f[8],Sa=f[18],Ta=f[19],Ua=f[20]):4==Ca?(Ja=f[12],Ka=f[13],La=f[14],Ma=f[18],Na=f[19],Oa=f[20],Pa=f[6],Qa=f[7],Ra=f[8],Sa=f[0],Ta=f[1],Ua=f[2]):5==Ca&&(Ja=f[3],Ka=f[4],La=f[5],Ma=f[9],Na=f[10],Oa=f[11],Pa=f[21],Qa=f[22],Ra=f[23],Sa=f[15],Ta=f[16],Ua=f[17]));var Ia,T,x,H,I,J,sa,ta,ua;this.clipVertices1[0]=Ja;this.clipVertices1[1]=Ka;this.clipVertices1[2]=La;this.clipVertices1[3]=
Ma;this.clipVertices1[4]=Na;this.clipVertices1[5]=Oa;this.clipVertices1[6]=Pa;this.clipVertices1[7]=Qa;this.clipVertices1[8]=Ra;this.clipVertices1[9]=Sa;this.clipVertices1[10]=Ta;this.clipVertices1[11]=Ua;T=0;H=this.clipVertices1[9];I=this.clipVertices1[10];J=this.clipVertices1[11];q=(H-wa-Hb)*za+(I-xa-Ib)*Aa+(J-ya-Jb)*Ba;for(var ia=0;4>ia;ia++)x=3*ia,sa=this.clipVertices1[x],ta=this.clipVertices1[x+1],ua=this.clipVertices1[x+2],t=(sa-wa-Hb)*za+(ta-xa-Ib)*Aa+(ua-ya-Jb)*Ba,0<q?0<t?(x=3*T,T++,this.clipVertices2[x]=
sa,this.clipVertices2[x+1]=ta,this.clipVertices2[x+2]=ua):(x=3*T,T++,fa=q/(q-t),this.clipVertices2[x]=H+(sa-H)*fa,this.clipVertices2[x+1]=I+(ta-I)*fa,this.clipVertices2[x+2]=J+(ua-J)*fa):0<t&&(x=3*T,T++,fa=q/(q-t),this.clipVertices2[x]=H+(sa-H)*fa,this.clipVertices2[x+1]=I+(ta-I)*fa,this.clipVertices2[x+2]=J+(ua-J)*fa,x=3*T,T++,this.clipVertices2[x]=sa,this.clipVertices2[x+1]=ta,this.clipVertices2[x+2]=ua),H=sa,I=ta,J=ua,q=t;Ia=T;if(0!=Ia){T=0;x=3*(Ia-1);H=this.clipVertices2[x];I=this.clipVertices2[x+
1];J=this.clipVertices2[x+2];q=(H-wa-Kb)*Da+(I-xa-Lb)*Ea+(J-ya-Mb)*Fa;for(ia=0;ia<Ia;ia++)x=3*ia,sa=this.clipVertices2[x],ta=this.clipVertices2[x+1],ua=this.clipVertices2[x+2],t=(sa-wa-Kb)*Da+(ta-xa-Lb)*Ea+(ua-ya-Mb)*Fa,0<q?0<t?(x=3*T,T++,this.clipVertices1[x]=sa,this.clipVertices1[x+1]=ta,this.clipVertices1[x+2]=ua):(x=3*T,T++,fa=q/(q-t),this.clipVertices1[x]=H+(sa-H)*fa,this.clipVertices1[x+1]=I+(ta-I)*fa,this.clipVertices1[x+2]=J+(ua-J)*fa):0<t&&(x=3*T,T++,fa=q/(q-t),this.clipVertices1[x]=H+(sa-
H)*fa,this.clipVertices1[x+1]=I+(ta-I)*fa,this.clipVertices1[x+2]=J+(ua-J)*fa,x=3*T,T++,this.clipVertices1[x]=sa,this.clipVertices1[x+1]=ta,this.clipVertices1[x+2]=ua),H=sa,I=ta,J=ua,q=t;Ia=T;if(0!=Ia){T=0;x=3*(Ia-1);H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];q=(H-wa+Hb)*-za+(I-xa+Ib)*-Aa+(J-ya+Jb)*-Ba;for(ia=0;ia<Ia;ia++)x=3*ia,sa=this.clipVertices1[x],ta=this.clipVertices1[x+1],ua=this.clipVertices1[x+2],t=(sa-wa+Hb)*-za+(ta-xa+Ib)*-Aa+(ua-ya+Jb)*-Ba,0<q?0<t?(x=
3*T,T++,this.clipVertices2[x]=sa,this.clipVertices2[x+1]=ta,this.clipVertices2[x+2]=ua):(x=3*T,T++,fa=q/(q-t),this.clipVertices2[x]=H+(sa-H)*fa,this.clipVertices2[x+1]=I+(ta-I)*fa,this.clipVertices2[x+2]=J+(ua-J)*fa):0<t&&(x=3*T,T++,fa=q/(q-t),this.clipVertices2[x]=H+(sa-H)*fa,this.clipVertices2[x+1]=I+(ta-I)*fa,this.clipVertices2[x+2]=J+(ua-J)*fa,x=3*T,T++,this.clipVertices2[x]=sa,this.clipVertices2[x+1]=ta,this.clipVertices2[x+2]=ua),H=sa,I=ta,J=ua,q=t;Ia=T;if(0!=Ia){T=0;x=3*(Ia-1);H=this.clipVertices2[x];
I=this.clipVertices2[x+1];J=this.clipVertices2[x+2];q=(H-wa+Kb)*-Da+(I-xa+Lb)*-Ea+(J-ya+Mb)*-Fa;for(ia=0;ia<Ia;ia++)x=3*ia,sa=this.clipVertices2[x],ta=this.clipVertices2[x+1],ua=this.clipVertices2[x+2],t=(sa-wa+Kb)*-Da+(ta-xa+Lb)*-Ea+(ua-ya+Mb)*-Fa,0<q?0<t?(x=3*T,T++,this.clipVertices1[x]=sa,this.clipVertices1[x+1]=ta,this.clipVertices1[x+2]=ua):(x=3*T,T++,fa=q/(q-t),this.clipVertices1[x]=H+(sa-H)*fa,this.clipVertices1[x+1]=I+(ta-I)*fa,this.clipVertices1[x+2]=J+(ua-J)*fa):0<t&&(x=3*T,T++,fa=q/(q-
t),this.clipVertices1[x]=H+(sa-H)*fa,this.clipVertices1[x+1]=I+(ta-I)*fa,this.clipVertices1[x+2]=J+(ua-J)*fa,x=3*T,T++,this.clipVertices1[x]=sa,this.clipVertices1[x+1]=ta,this.clipVertices1[x+2]=ua),H=sa,I=ta,J=ua,q=t;Ia=T;if(hc){var Sc=d;d=e;e=Sc}if(0!=Ia){var ic=d!=a;if(4<Ia){H=0.25*(Ja+Ma+Pa+Sa);I=0.25*(Ka+Na+Qa+Ta);J=0.25*(La+Oa+Ra+Ua);for(var za=Ja-H,Aa=Ka-I,Ba=La-J,Da=Ma-H,Ea=Na-I,Fa=Oa-J,zc=0,Qc=0,Ac=0,Rc=0,jc=-this.INF,qa=this.INF,ia=0;ia<Ia;ia++)this.used[ia]=!1,x=3*ia,H=this.clipVertices1[x],
I=this.clipVertices1[x+1],J=this.clipVertices1[x+2],F=H*za+I*Aa+J*Ba,F<qa&&(qa=F,zc=ia),F>jc&&(jc=F,Ac=ia);this.used[zc]=!0;this.used[Ac]=!0;jc=-this.INF;qa=this.INF;for(ia=0;ia<Ia;ia++)this.used[ia]||(x=3*ia,H=this.clipVertices1[x],I=this.clipVertices1[x+1],J=this.clipVertices1[x+2],F=H*Da+I*Ea+J*Fa,F<qa&&(qa=F,Qc=ia),F>jc&&(jc=F,Rc=ia));x=3*zc;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];F=(H-wa)*B+(I-xa)*C+(J-ya)*D;0>F&&b.addPoint(H,I,J,B,C,D,F,ic);x=3*Qc;H=this.clipVertices1[x];
I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];F=(H-wa)*B+(I-xa)*C+(J-ya)*D;0>F&&b.addPoint(H,I,J,B,C,D,F,ic);x=3*Ac;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];F=(H-wa)*B+(I-xa)*C+(J-ya)*D;0>F&&b.addPoint(H,I,J,B,C,D,F,ic);x=3*Rc;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];F=(H-wa)*B+(I-xa)*C+(J-ya)*D;0>F&&b.addPoint(H,I,J,B,C,D,F,ic)}else for(ia=0;ia<Ia;ia++)x=3*ia,H=this.clipVertices1[x],I=this.clipVertices1[x+1],J=this.clipVertices1[x+
2],F=(H-wa)*B+(I-xa)*C+(J-ya)*D,0>F&&b.addPoint(H,I,J,B,C,D,F,ic)}}}}}}};OIMO.SphereBoxCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var g=e.dimentions,f=d.position;a=f.x;c=f.y;var h=f.z,k=e.position,l=k.x,p=k.y,k=k.z;d=d.radius;var n=e.halfWidth,m=e.halfHeight,r=e.halfDepth;e=a-l;var s=c-p,w=h-k,u=g[0]*e+g[1]*s+g[2]*w,y=g[3]*e+g[4]*s+g[5]*w,z=g[6]*e+g[7]*s+g[8]*w;e=0;u>n?u=n:u<-n?u=-n:e=1;y>m?y=m:y<-m?y=-m:e|=2;z>r?z=r:z<-r?z=-r:e|=4;7==e?(e=0>u?n+u:n-u,s=0>y?m+y:m-y,w=0>z?r+z:r-z,e<s?e<w?(f=e-n,0>u?(e=g[0],s=g[1],w=
g[2]):(e=-g[0],s=-g[1],w=-g[2])):(f=w-r,0>z?(e=g[6],s=g[7],w=g[8]):(e=-g[6],s=-g[7],w=-g[8])):s<w?(f=s-m,0>y?(e=g[3],s=g[4],w=g[5]):(e=-g[3],s=-g[4],w=-g[5])):(f=w-r,0>z?(e=g[6],s=g[7],w=g[8]):(e=-g[6],s=-g[7],w=-g[8])),b.addPoint(a+d*e,c+d*s,h+d*w,e,s,w,f-d,this.flip)):(l=l+u*g[0]+y*g[3]+z*g[6],p=p+u*g[1]+y*g[4]+z*g[7],g=k+u*g[2]+y*g[5]+z*g[8],e=l-f.x,s=p-f.y,w=g-f.z,f=e*e+s*s+w*w,0<f&&f<d*d&&(f=Math.sqrt(f),g=1/f,e*=g,s*=g,w*=g,b.addPoint(a+d*e,c+d*s,h+d*w,e,s,w,f-d,this.flip)))};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(a,c,b){var d=a.position,e=c.position,g=e.x-d.x,f=e.y-d.y,e=e.z-d.z,h=g*g+f*f+e*e;a=a.radius;c=a+c.radius;if(0<h&&h<c*c){var h=Math.sqrt(h),k=1/h,g=g*k,f=f*k,e=e*k;b.addPoint(d.x+g*a,d.y+f*a,d.z+e*a,g,f,e,h-c,!1)}};OIMO.AABB=function(a,c,b,d,e,g){this.minX=a||0;this.maxX=c||0;this.minY=b||0;this.maxY=d||0;this.minZ=e||0;this.maxZ=g||0};
OIMO.AABB.prototype={constructor:OIMO.AABB,init:function(a,c,b,d,e,g){this.minX=a;this.maxX=c;this.minY=b;this.maxY=d;this.minZ=e;this.maxZ=g},combine:function(a,c){this.minX=a.minX<c.minX?a.minX:c.minX;this.maxX=a.maxX>c.maxX?a.maxX:c.maxX;this.minY=a.minY<c.minY?a.minY:c.minY;this.maxY=a.maxY>c.maxY?a.maxY:c.maxY;this.minZ=a.minZ<c.minZ?a.minZ:c.minZ;this.maxZ=a.maxZ>c.maxZ?a.maxZ:c.maxZ},surfaceArea:function(){var a=this.maxY-this.minY,c=this.maxZ-this.minZ;return 2*((this.maxX-this.minX)*(a+c)+
a*c)},intersectsWithPoint:function(a,c,b){return a>=this.minX&&a<=this.maxX&&c>=this.minY&&c<=this.maxY&&b>=this.minZ&&b<=this.maxZ}};OIMO.Proxy=function(a){this.shape=a;this.aabb=a.aabb};OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){throw Error("Inheritance error.");}};OIMO.BasicProxy=function(a){OIMO.Proxy.call(this,a)};OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.BasicProxy.prototype.update=function(){};OIMO.BroadPhase=function(){this.numPairs=this.numPairChecks=this.types=0;this.pairs=[]};
OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(a){throw Error("Inheritance error.");},addProxy:function(a){throw Error("Inheritance error.");},removeProxy:function(a){throw Error("Inheritance error.");},isAvailablePair:function(a,c){var b=a.parent,d=c.parent;if(b==d||!b.isDynamic&&!d.isDynamic||0==(a.belongsTo&c.collidesWith)||0==(c.belongsTo&a.collidesWith))return!1;var e;for(e=b.numJoints<d.numJoints?b.jointLink:d.jointLink;null!=e;){var g=e.joint;if(!g.allowCollision&&
(g.body1==b&&g.body2==d||g.body1==d&&g.body2==b))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[];this.numPairChecks=this.numPairs=0;this.collectPairs()},collectPairs:function(){throw Error("Inheritance error.");},addPair:function(a,c){var b=new OIMO.Pair(a,c);this.pairs.push(b);this.numPairs++}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=1;this.numProxies=0;this.maxProxies=256;this.proxies=[];this.proxies.length=256};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.createProxy=function(a){return new OIMO.BasicProxy(a)};
OIMO.BruteForceBroadPhase.prototype.addProxy=function(a){if(this.numProxies==this.maxProxies){this.maxProxies*=2;var c=[];c.length=this.maxProxies;for(var b=this.numProxies;b--;)c[b]=this.proxies[b];this.proxies=c}this.proxies[this.numProxies++]=a};OIMO.BruteForceBroadPhase.prototype.removeProxy=function(a){for(var c=this.numProxies;c--;)if(this.proxies[c]==a){this.proxies[c]=this.proxies[--this.numProxies];this.proxies[this.numProxies]=null;break}};
OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){this.numPairChecks=this.numProxies*(this.numProxies-1)>>1;for(var a=this.numProxies;a--;)for(var c=this.proxies[a],b=c.aabb,c=c.shape,d=this.numProxies;d--;)if(d!==a){var e=this.proxies[d],g=e.aabb,e=e.shape;b.maxX<g.minX||b.minX>g.maxX||b.maxY<g.minY||b.minY>g.maxY||b.maxZ<g.minZ||b.minZ>g.maxZ||!this.isAvailablePair(c,e)||this.addPair(c,e)}};OIMO.Pair=function(a,c){this.shape1=a||null;this.shape2=c||null};OIMO.SAPAxis=function(){this.numElements=0;this.bufferSize=256;this.elements=[];this.elements.length=this.bufferSize;this.stack=new OIMO_ARRAY_TYPE(64)};
OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(a,c){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var b=this.numElements;b--;);}this.elements[this.numElements++]=a;this.elements[this.numElements++]=c},removeElements:function(a,c){for(var b=-1,d=-1,e=0,g=this.numElements;e<g;e++){var f=this.elements[e];if(f==a||f==c)if(-1==b)b=e;else{d=e;break}}e=b+1;for(g=d;e<g;e++)this.elements[e-1]=this.elements[e];e=d+1;for(g=this.numElements;e<g;e++)this.elements[e-2]=this.elements[e];
this.elements[--this.numElements]=null;this.elements[--this.numElements]=null},sort:function(){for(var a=0,c=1;0!=this.numElements>>c;)c++;for(var c=c*this.numElements>>2,a=0,b=!1,d=this.elements,e=1,g=this.numElements;e<g;e++){var f=d[e],h=f.value,k=d[e-1];if(k.value>h){var l=e;do{d[l]=k;if(0==--l)break;k=d[l-1]}while(k.value>h);d[l]=f;a+=e-l;if(a>c){b=!0;break}}}if(b)for(a=2,c=this.stack,c[0]=0,c[1]=this.numElements-1;0<a;)if(b=c[--a],k=c[--a],f=b-k,16<f){e=k+Math.floor(0.5*f);f=d[e];d[e]=d[b];
d[b]=f;h=f.value;e=k-1;for(l=b;;){var p;do g=d[++e];while(g.value<h);do p=d[--l];while(h<p.value&&l!=k);if(e>=l)break;d[e]=p;d[l]=g}d[b]=d[e];d[e]=f;e-k>b-e?(c[a++]=k,c[a++]=e-1,c[a++]=e+1,c[a++]=b):(c[a++]=e+1,c[a++]=b,c[a++]=k,c[a++]=e-1)}else for(e=k+1;e<=b;e++)if(f=d[e],h=f.value,k=d[e-1],k.value>h){l=e;do{d[l]=k;if(0==--l)break;k=d[l-1]}while(k.value>h);d[l]=f}},calculateTestCount:function(){for(var a=1,c=0,b=1,d=this.numElements;b<d;b++)this.elements[b].max?a--:(c+=a,a++);return c}};OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=2;this.numElementsS=this.numElementsD=0;this.axesD=[];this.axesS=[];this.axesD.length=3;this.axesS.length=3;this.axesD[0]=new OIMO.SAPAxis;this.axesD[1]=new OIMO.SAPAxis;this.axesD[2]=new OIMO.SAPAxis;this.axesS[0]=new OIMO.SAPAxis;this.axesS[1]=new OIMO.SAPAxis;this.axesS[2]=new OIMO.SAPAxis;this.index1=0;this.index2=1};OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);
OIMO.SAPBroadPhase.prototype.createProxy=function(a){return new OIMO.SAPProxy(this,a)};OIMO.SAPBroadPhase.prototype.addProxy=function(a){a.isDynamic()?(this.axesD[0].addElements(a.min[0],a.max[0]),this.axesD[1].addElements(a.min[1],a.max[1]),this.axesD[2].addElements(a.min[2],a.max[2]),a.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(a.min[0],a.max[0]),this.axesS[1].addElements(a.min[1],a.max[1]),this.axesS[2].addElements(a.min[2],a.max[2]),a.belongsTo=2,this.numElementsS+=2)};
OIMO.SAPBroadPhase.prototype.removeProxy=function(a){if(0!=a.belongsTo){switch(a.belongsTo){case 1:this.axesD[0].removeElements(a.min[0],a.max[0]);this.axesD[1].removeElements(a.min[1],a.max[1]);this.axesD[2].removeElements(a.min[2],a.max[2]);this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(a.min[0],a.max[0]),this.axesS[1].removeElements(a.min[1],a.max[1]),this.axesS[2].removeElements(a.min[2],a.max[2]),this.numElementsS-=2}a.belongsTo=0}};
OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var a=this.axesD[this.index1],c=this.axesD[this.index2];a.sort();c.sort();var b=a.calculateTestCount(),d=c.calculateTestCount();b<=d?(c=this.axesS[this.index1],c.sort(),b=a.elements,a=c.elements):(a=this.axesS[this.index2],a.sort(),b=c.elements,a=a.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var e,g,d=c=0;c<this.numElementsD;){var f,h;d==this.numElementsS?(f=b[c],h=!0,c++):(f=
b[c],h=a[d],f.value<h.value?(h=!0,c++):(f=h,h=!1,d++));if(f.max){var k=f.pair;if(h)if(k==e){e=e.pair;continue}else f=e;else if(k==g){g=g.pair;continue}else f=g;do{r=f.pair;if(r===k){f.pair=r.pair;break}f=r}while(null!==f)}else{for(var k=f.proxy.shape,l=f.min1.value,p=f.max1.value,n=f.min2.value,m=f.max2.value,r=e;null!=r;r=r.pair){var s=r.proxy.shape;this.numPairChecks++;l>r.max1.value||p<r.min1.value||n>r.max2.value||m<r.min2.value||!this.isAvailablePair(k,s)||this.addPair(k,s)}if(h){for(r=g;null!=
r;r=r.pair)s=r.proxy.shape,this.numPairChecks++,l>r.max1.value||p<r.min1.value||n>r.max2.value||m<r.min2.value||!this.isAvailablePair(k,s)||this.addPair(k,s);f.pair=e;e=f}else f.pair=g,g=f}}this.index2=(this.index1|this.index2)^3}};OIMO.SAPElement=function(a,c){this.proxy=a;this.max2=this.min2=this.max1=this.min1=this.pair=null;this.max=c;this.value=0};OIMO.SAPProxy=function(a,c){OIMO.Proxy.call(this,c);this.belongsTo=0;this.max=[];this.min=[];this.sap=a;this.min[0]=new OIMO.SAPElement(this,!1);this.max[0]=new OIMO.SAPElement(this,!0);this.min[1]=new OIMO.SAPElement(this,!1);this.max[1]=new OIMO.SAPElement(this,!0);this.min[2]=new OIMO.SAPElement(this,!1);this.max[2]=new OIMO.SAPElement(this,!0);this.max[0].pair=this.min[0];this.max[1].pair=this.min[1];this.max[2].pair=this.min[2];this.min[0].min1=this.min[1];this.min[0].max1=this.max[1];this.min[0].min2=
this.min[2];this.min[0].max2=this.max[2];this.min[1].min1=this.min[0];this.min[1].max1=this.max[0];this.min[1].min2=this.min[2];this.min[1].max2=this.max[2];this.min[2].min1=this.min[0];this.min[2].max1=this.max[0];this.min[2].min2=this.min[1];this.min[2].max2=this.max[1]};OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.SAPProxy.prototype.isDynamic=function(){var a=this.shape.parent;return a.isDynamic&&!a.sleeping};
OIMO.SAPProxy.prototype.update=function(){this.min[0].value=this.aabb.minX;this.max[0].value=this.aabb.maxX;this.min[1].value=this.aabb.minY;this.max[1].value=this.aabb.maxY;this.min[2].value=this.aabb.minZ;this.max[2].value=this.aabb.maxZ;if(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())this.sap.removeProxy(this),this.sap.addProxy(this)};OIMO.DBVT=function(){this.root=null;this.freeNodes=[];this.freeNodes.length=16384;this.numFreeNodes=0;this.aabb=new OIMO.AABB};
OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(a){this.deleteLeaf(a);this.insertLeaf(a)},insertLeaf:function(a){if(null==this.root)this.root=a;else{for(var c=a.aabb,b=this.root,d,e;null==b.proxy;){var g=b.child1,f=b.child2,h=b.aabb,k=g.aabb,l=f.aabb;d=h.surfaceArea();this.aabb.combine(c,h);e=this.aabb.surfaceArea();h=2*e;d=e=2*(e-d);this.aabb.combine(c,k);d=null!=g.proxy?d+this.aabb.surfaceArea():d+(this.aabb.surfaceArea()-k.surfaceArea());k=e;this.aabb.combine(c,l);k=null!=f.proxy?
k+this.aabb.surfaceArea():k+(this.aabb.surfaceArea()-l.surfaceArea());if(d<k)if(h<d)break;else b=g;else if(h<k)break;else b=f}c=b.parent;g=0<this.numFreeNodes?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode;g.parent=c;g.child1=a;g.child2=b;g.aabb.combine(a.aabb,b.aabb);g.height=b.height+1;b.parent=g;a.parent=g;b==this.root?this.root=g:c.child1==b?c.child1=g:c.child2=g;do g=this.balance(g),this.fix(g),g=g.parent;while(null!=g)}},getBalance:function(a){return null!=a.proxy?0:a.child1.height-a.child2.height},
print:function(a,c,b){var d=null==a.proxy;d&&(b=this.print(a.child1,c+1,b));for(var e=2*c;0<=e;e--)b+=" ";b+=(d?this.getBalance(a):"["+a.proxy.aabb.minX+"]")+"\n";d&&(b=this.print(a.child2,c+1,b));return b},deleteLeaf:function(a){if(a==this.root)this.root=null;else{var c=a.parent;a=c.child1==a?c.child2:c.child1;if(c==this.root)this.root=a,a.parent=null;else{var b=c.parent;a.parent=b;b.child1==c?b.child1=a:b.child2=a;16384>this.numFreeNodes&&(this.freeNodes[this.numFreeNodes++]=c);do b=this.balance(b),
this.fix(b),b=b.parent;while(null!=b)}}},balance:function(a){var c=a.height;if(2>c)return a;var b=a.parent,d=a.child1,e=a.child2,g=d.height,f=e.height,h=g-f;if(1<h){var g=d.child1,h=d.child2,k=g.height,l=h.height;k>l?(d.child2=a,a.parent=d,a.child1=h,h.parent=a,a.aabb.combine(h.aabb,e.aabb),f=l-f,a.height=l-(f&f>>31)+1,d.aabb.combine(g.aabb,a.aabb),f=k-c,d.height=k-(f&f>>31)+1):(d.child1=a,a.parent=d,a.child1=g,g.parent=a,a.aabb.combine(g.aabb,e.aabb),f=k-f,a.height=k-(f&f>>31)+1,d.aabb.combine(a.aabb,
h.aabb),f=c-l,d.height=c-(f&f>>31)+1);null!=b?b.child1==a?b.child1=d:b.child2=d:this.root=d;d.parent=b;return d}if(-1>h){var h=e.child1,k=e.child2,l=h.height,p=k.height;l>p?(e.child2=a,a.parent=e,a.child2=k,k.parent=a,a.aabb.combine(d.aabb,k.aabb),f=g-p,a.height=g-(f&f>>31)+1,e.aabb.combine(h.aabb,a.aabb),f=l-c,e.height=l-(f&f>>31)+1):(e.child1=a,a.parent=e,a.child2=h,h.parent=a,a.aabb.combine(d.aabb,h.aabb),f=g-l,a.height=g-(f&f>>31)+1,e.aabb.combine(a.aabb,k.aabb),f=c-p,e.height=c-(f&f>>31)+1);
null!=b?b.child1==a?b.child1=e:b.child2=e:this.root=e;e.parent=b;return e}return a},fix:function(a){var c=a.child1,b=a.child2;a.aabb.combine(c.aabb,b.aabb);c=c.height;b=b.height;a.height=c<b?b+1:c+1}};OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=3;this.maxLeaves=this.numLeaves=0;this.tree=new OIMO.DBVT;this.maxStack=256;this.stack=[];this.stack.length=this.maxStack;this.maxLeaves=256;this.leaves=[];this.leaves.length=this.maxLeaves};OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.DBVTBroadPhase.prototype.createProxy=function(a){return new OIMO.DBVTProxy(a)};
OIMO.DBVTBroadPhase.prototype.addProxy=function(a){this.tree.insertLeaf(a.leaf);if(this.numLeaves==this.maxLeaves){this.maxLeaves*=2;var c=[];c.length=this.maxLeaves;for(var b=0;b<this.numLeaves;b++)c[b]=this.leaves[b];this.leaves=c}this.leaves[this.numLeaves++]=a.leaf};OIMO.DBVTBroadPhase.prototype.removeProxy=function(a){this.tree.deleteLeaf(a.leaf);for(var c=0;c<this.numLeaves;c++)if(this.leaves[c]==a.leaf){this.leaves[c]=this.leaves[--this.numLeaves];this.leaves[this.numLeaves]=null;break}};
OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(2>this.numLeaves))for(var a=0;a<this.numLeaves;a++){var c=this.leaves[a],b=c.proxy.aabb,d=c.aabb;if(b.minX<d.minX||b.maxX>d.maxX||b.minY<d.minY||b.maxY>d.maxY||b.minZ<d.minZ||b.maxZ>d.maxZ)this.tree.deleteLeaf(c),d.minX=b.minX-0.1,d.maxX=b.maxX+0.1,d.minY=b.minY-0.1,d.maxY=b.maxY+0.1,d.minZ=b.minZ-0.1,d.maxZ=b.maxZ+0.1,this.tree.insertLeaf(c),this.collide(c,this.tree.root)}};
OIMO.DBVTBroadPhase.prototype.collide=function(a,c){var b=2;this.stack[0]=a;for(this.stack[1]=c;0<b;){var d=this.stack[--b],e=this.stack[--b],g=null!=d.proxy,f=null!=e.proxy;this.numPairChecks++;if(g&&f){var d=d.proxy.shape,e=e.proxy.shape,h=d.aabb,k=e.aabb;d==e||h.maxX<k.minX||h.minX>k.maxX||h.maxY<k.minY||h.minY>k.maxY||h.maxZ<k.minZ||h.minZ>k.maxZ||!this.isAvailablePair(d,e)||this.addPair(d,e)}else if(h=d.aabb,k=e.aabb,!(h.maxX<k.minX||h.minX>k.maxX||h.maxY<k.minY||h.minY>k.maxY||h.maxZ<k.minZ||
h.minZ>k.maxZ)){if(b+4>=this.maxStack){this.maxStack*=2;h=[];h.length=this.maxStack;for(k=0;k<b;k++)h[k]=this.stack[k];this.stack=h}f||!g&&d.aabb.surfaceArea()>e.aabb.surfaceArea()?(this.stack[b++]=d.child1,this.stack[b++]=e,this.stack[b++]=d.child2,this.stack[b++]=e):(this.stack[b++]=d,this.stack[b++]=e.child1,this.stack[b++]=d,this.stack[b++]=e.child2)}}};OIMO.DBVTNode=function(){this.proxy=this.parent=this.child2=this.child1=null;this.height=0;this.aabb=new OIMO.AABB};OIMO.DBVTProxy=function(a){OIMO.Proxy.call(this,a);this.leaf=new OIMO.DBVTNode;this.leaf.proxy=this};OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.DBVTProxy.prototype.update=function(){};OIMO.World.prototype.add=function(a){a=a||{};var c=a.type||"box";"string"===typeof c&&(c=[c]);if("joint"==c[0].substring(0,5)){var b=a.axe1||[1,0,0],d=a.axe2||[1,0,0],e=a.pos1||[0,0,0],g=a.pos2||[0,0,0],e=e.map(function(a){return a*OIMO.INV_SCALE}),g=g.map(function(a){return a*OIMO.INV_SCALE}),f,h;"jointDistance"===c[0]?(f=a.min||0,h=a.max||10,f*=OIMO.INV_SCALE,h*=OIMO.INV_SCALE):(f=a.min||57.29578,h=a.max||0,f*=OIMO.degtorad,h*=OIMO.degtorad);var k=a.limit||null,l=a.spring||null,p=a.motor||null,
n=new OIMO.JointConfig;n.allowCollision=a.collision||!1;n.localAxis1.init(b[0],b[1],b[2]);n.localAxis2.init(d[0],d[1],d[2]);n.localAnchorPoint1.init(e[0],e[1],e[2]);n.localAnchorPoint2.init(g[0],g[1],g[2]);if("string"==typeof a.body1||a.body1 instanceof String)a.body1=a.world.getByName(a.body1);if("string"==typeof a.body2||a.body2 instanceof String)a.body2=a.world.getByName(a.body2);n.body1=a.body1;n.body2=a.body2;var m;switch(c[0]){case "jointDistance":m=new OIMO.DistanceJoint(n,f,h);null!==l&&m.limitMotor.setSpring(l[0],
l[1]);null!==p&&m.limitMotor.setSpring(p[0],p[1]);break;case "jointHinge":m=new OIMO.HingeJoint(n,f,h);null!==l&&m.limitMotor.setSpring(l[0],l[1]);null!==p&&m.limitMotor.setSpring(p[0],p[1]);break;case "jointPrisme":m=new OIMO.PrismaticJoint(n,f,h);break;case "jointSlide":m=new OIMO.SliderJoint(n,f,h);break;case "jointBall":m=new OIMO.BallAndSocketJoint(n);break;case "jointWheel":m=new OIMO.WheelJoint(n),null!==k&&m.rotationalLimitMotor1.setLimit(k[0],k[1]),null!==l&&m.rotationalLimitMotor1.setSpring(l[0],
l[1]),null!==p&&m.rotationalLimitMotor1.setSpring(p[0],p[1])}m.name=a.name||"";this.addJoint(m);return m}b=a.move||!1;d=a.noSleep||!1;e=a.pos||[0,0,0];e=e.map(function(a){return a*OIMO.INV_SCALE});g=a.size||[1,1,1];g=g.map(function(a){return a*OIMO.INV_SCALE});k=a.rot||[0,0,0];k=k.map(function(a){return a*OIMO.degtorad});f=[];for(h=0;h<k.length/3;h++)l=OIMO.EulerToAxis(k[h+0],k[h+1],k[h+2]),f.push(l[0]),f.push(l[1]),f.push(l[2]),f.push(l[3]);k=a.sc||new OIMO.ShapeConfig;a.config&&(k.density=void 0===
a.config[0]?1:a.config[0],k.friction=void 0===a.config[1]?0.4:a.config[1],k.restitution=void 0===a.config[2]?0.2:a.config[2],k.belongsTo=a.config[3]||1,k.collidesWith=a.config[4]||4294967295);a.massPos&&(a.massPos=a.massPos.map(function(a){return a*OIMO.INV_SCALE}),k.relativePosition.init(a.massPos[0],a.massPos[1],a.massPos[2]));a.massRot&&(a.massRot=a.massRot.map(function(a){return a*OIMO.degtorad}),k.relativeRotation=OIMO.EulerToMatrix(a.massRot[0],a.massRot[1],a.massRot[2]));l=new OIMO.RigidBody(e[0],
e[1],e[2],f[0],f[1],f[2],f[3]);p=[];for(h=0;h<c.length;h++){n=3*h;m=4*h;switch(c[h]){case "sphere":p[h]=new OIMO.SphereShape(k,g[n+0]);break;case "cylinder":p[h]=new OIMO.BoxShape(k,g[n+0],g[n+1],g[n+2]);break;case "box":p[h]=new OIMO.BoxShape(k,g[n+0],g[n+1],g[n+2])}l.addShape(p[h]);0<h&&(p[h].relativePosition=new OIMO.Vec3(e[n+0],e[n+1],e[n+2]),f[m+0]&&(p[h].relativeRotation=[f[m+0],f[m+1],f[m+2],f[m+3]]))}b?(a.massPos||a.massRot?l.setupMass(1,!1):l.setupMass(1,!0),l.allowSleep=d?!1:!0):l.setupMass(2);
l.name=a.name||"";this.addRigidBody(l);return l};
