// oimo.js - https://github.com/lo-th/Oimo.js
'use strict';var OIMO={REVISION:"DEV.1.1.0a",SHAPE_SPHERE:1,SHAPE_BOX:2,WORLD_SCALE:100,INV_SCALE:0.01};OIMO.TO_RAD=Math.PI/180;OIMO.nextID=0;OIMO.World=function(a,c,b){this.timeStep=a||1/60;this.numIterations=b||8;this.rigidBodies=null;this.numRigidBodies=0;this.unusedContacts=this.contacts=null;this.numContactPoints=this.numContacts=0;this.joints=null;this.numIslands=this.numJoints=0;switch(c||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.gravity=new OIMO.Vec3(0,-9.80665,0);this.performance=new OIMO.Performance;this.detectors=
[];this.detectors.length=3;for(a=0;3>a;a++)this.detectors[a]=[],this.detectors[a].length=3;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=new OIMO.BoxBoxCollisionDetector;this.randX=65535;this.randA=98765;this.randB=123456789;this.maxIslandRigidBodies=
64;this.islandRigidBodies=[];this.islandRigidBodies.length=this.maxIslandRigidBodies;this.islandStack=[];this.islandStack.length=this.maxIslandRigidBodies;this.maxIslandConstraints=128;this.islandConstraints=[];this.islandConstraints.length=this.maxIslandConstraints;this.enableRandomizer=!0};
OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0},addRigidBody:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the rigid body");a.parent=this;a.awake();for(var c=a.shapes;null!==c;c=c.next)this.addShape(c);null!==this.rigidBodies&&
((this.rigidBodies.prev=a).next=this.rigidBodies);this.rigidBodies=a;this.numRigidBodies++},removeRigidBody:function(a){if(a.parent===this){a.awake();for(var c=a.jointLink;null!=c;){var b=c.joint,c=c.next;this.removeJoint(b)}for(c=a.shapes;null!==c;c=c.next)this.removeShape(c);c=a.prev;b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.rigidBodies===a&&(this.rigidBodies=b);a.prev=null;a.next=null;a.parent=null;this.numRigidBodies--}},getByName:function(a){for(var c=null,b=this.rigidBodies;null!==
b;)""!==b.name&&b.name===a&&(c=b),b=b.next;for(b=this.joints;null!==b;)""!==b.name&&b.name===a&&(c=b),b=b.next;return c},addShape:function(a){if(!a.parent||!a.parent.parent)throw Error("It is not possible to be added alone to shape world");a.proxy=this.broadPhase.createProxy(a);a.updateProxy();this.broadPhase.addProxy(a.proxy)},removeShape:function(a){this.broadPhase.removeProxy(a.proxy);a.proxy=null},addJoint:function(a){if(a.parent)throw Error("It is not possible to be added to more than one world one of the joint");
null!=this.joints&&((this.joints.prev=a).next=this.joints);this.joints=a;a.parent=this;this.numJoints++;a.awake();a.attach()},removeJoint:function(a){var c=a.prev,b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.joints==a&&(this.joints=b);a.prev=null;a.next=null;this.numJoints--;a.awake();a.detach();a.parent=null},step:function(){for(var a=Date.now(),c=this.rigidBodies;null!==c;){c.addedToIsland=!1;if(c.sleeping){var b=c.linearVelocity,d=c.linearVelocity,e=c.position,f=c.sleepPosition,h=c.orientation,
g=c.sleepOrientation;0===b.x&&0===b.y&&0===b.z&&0===d.x&&0===d.y&&0===d.z&&e.x===f.x&&e.y===f.y&&e.z===f.z&&h.s===g.s&&h.x===g.x&&h.y===g.y&&h.z===g.z||c.awake()}c=c.next}this.updateContacts();this.solveIslands();c=Date.now();c-1E3>this.performance.time_prev&&(this.performance.time_prev=c,this.performance.fpsint=this.performance.fps,this.performance.fps=0);this.performance.fps++;this.performance.totalTime=c-a;this.performance.updatingTime=this.performance.totalTime-(this.performance.broadPhaseTime+
this.performance.narrowPhaseTime+this.performance.solvingTime)},updateContacts:function(){var a=Date.now();this.broadPhase.detectPairs();for(var c=this.broadPhase.pairs,b=this.broadPhase.numPairs;b--;){var d=c[b],e,f;d.shape1.id<d.shape2.id?(e=d.shape1,f=d.shape2):(e=d.shape2,f=d.shape1);var h;h=e.numContacts<f.numContacts?e.contactLink:f.contactLink;for(var g=!1;h;){d=h.contact;if(d.shape1==e&&d.shape2==f){g=d.persisting=!0;break}h=h.next}g||this.addContact(e,f)}c=Date.now();this.performance.broadPhaseTime=
c-a;this.numContactPoints=0;for(d=this.contacts;null!==d;){if(!d.persisting&&(a=d.shape1.aabb,b=d.shape2.aabb,a.minX>b.maxX||a.maxX<b.minX||a.minY>b.maxY||a.maxY<b.minY||a.minZ>b.maxZ||a.maxZ<b.minZ)){a=d.next;this.removeContact(d);d=a;continue}a=d.body1;b=d.body2;(a.isDynamic&&!a.sleeping||b.isDynamic&&!b.sleeping)&&d.updateManifold();this.numContactPoints+=d.manifold.numPoints;d.persisting=!1;d.constraint.addedToIsland=!1;d=d.next}d=Date.now();this.performance.narrowPhaseTime=d-c},addContact:function(a,
c){var b;null!==this.unusedContacts?(b=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):b=new OIMO.Contact;b.attach(a,c);b.detector=this.detectors[a.type][c.type];this.contacts&&((this.contacts.prev=b).next=this.contacts);this.contacts=b;this.numContacts++},removeContact:function(a){var c=a.prev,b=a.next;b&&(b.prev=c);c&&(c.next=b);this.contacts===a&&(this.contacts=b);a.prev=null;a.next=null;a.detach();a.next=this.unusedContacts;this.unusedContacts=a;this.numContacts--},calSleep:function(a){if(!a.allowSleep)return!1;
var c=a.linearVelocity;if(0.04<c.x*c.x+c.y*c.y+c.z*c.z)return!1;c=a.angularVelocity;return 0.25<c.x*c.x+c.y*c.y+c.z*c.z?!1:!0},solveIslands:function(){var a=1/this.timeStep,c,b,d;for(b=this.joints;null!==b;b=b.next)b.addedToIsland=!1;this.maxIslandRigidBodies<this.numRigidBodies&&(this.maxIslandRigidBodies=2*this.numRigidBodies,this.islandRigidBodies=[],this.islandStack=[],this.islandRigidBodies.length=this.maxIslandRigidBodies,this.islandStack.length=this.maxIslandRigidBodies);b=this.numJoints+this.numContacts;
this.maxIslandConstraints<b&&(this.maxIslandConstraints=2*b,this.islandConstraints=[],this.islandConstraints.length=this.maxIslandConstraints);b=Date.now();this.numIslands=0;for(var e=this.rigidBodies;null!==e;e=e.next)if(!(e.addedToIsland||e.isStatic||e.sleeping)){if(e.isLonely())e.isDynamic&&(e.linearVelocity.x+=this.gravity.x*this.timeStep,e.linearVelocity.y+=this.gravity.y*this.timeStep,e.linearVelocity.z+=this.gravity.z*this.timeStep),this.calSleep(e)?(e.sleepTime+=this.timeStep,0.5<e.sleepTime?
e.sleep():e.updatePosition(this.timeStep)):(e.sleepTime=0,e.updatePosition(this.timeStep));else{var f=0,h=0,g=1;this.islandStack[0]=e;e.addedToIsland=!0;do if(c=this.islandStack[--g],this.islandStack[g]=null,c.sleeping=!1,this.islandRigidBodies[f++]=c,!c.isStatic){for(var l=c.contactLink;null!==l;l=l.next){var k=l.contact;d=k.constraint;!d.addedToIsland&&k.touching&&(this.islandConstraints[h++]=d,d.addedToIsland=!0,d=l.body,d.addedToIsland||(this.islandStack[g++]=d,d.addedToIsland=!0))}for(c=c.jointLink;null!==
c;c=c.next)d=c.joint,d.addedToIsland||(this.islandConstraints[h++]=d,d.addedToIsland=!0,d=c.body,!d.addedToIsland&&d.isDynamic&&(this.islandStack[g++]=d,d.addedToIsland=!0))}while(0!=g);d=this.gravity.x*this.timeStep;l=this.gravity.y*this.timeStep;k=this.gravity.z*this.timeStep;for(g=f;g--;)c=this.islandRigidBodies[g],c.isDynamic&&(c.linearVelocity.x+=d,c.linearVelocity.y+=l,c.linearVelocity.z+=k);if(this.enableRandomizer)for(g=h;g--;)0!==g&&(c=(this.randX=this.randX*this.randA+this.randB&2147483647)/
2147483648*g|0,d=this.islandConstraints[g],this.islandConstraints[g]=this.islandConstraints[c],this.islandConstraints[c]=d);for(g=h;g--;)this.islandConstraints[g].preSolve(this.timeStep,a);for(c=this.numIterations;c--;)for(g=h;g--;)this.islandConstraints[g].solve();for(g=h;g--;)this.islandConstraints[g].postSolve(),this.islandConstraints[g]=null;h=10;for(g=f;g--;)c=this.islandRigidBodies[g],this.calSleep(c)?(c.sleepTime+=this.timeStep,c.sleepTime<h&&(h=c.sleepTime)):h=c.sleepTime=0;if(0.5<h)for(g=
f;g--;)this.islandRigidBodies[g].sleep(),this.islandRigidBodies[g]=null;else for(g=f;g--;)this.islandRigidBodies[g].updatePosition(this.timeStep),this.islandRigidBodies[g]=null}this.numIslands++}a=Date.now();this.performance.solvingTime=a-b}};OIMO.RigidBody=function(a,c,b,d,e,f,h){d=d||0;e=e||0;f=f||0;h=h||0;a=a||0;c=c||0;b=b||0;this.name="";this.BODY_DYNAMIC=1;this.BODY_STATIC=2;this.MAX_SHAPES=64;this.next=this.prev=null;this.type=0;this.isStatic=this.isDynamic=!1;this.position=null;this.inverseMass=this.mass=NaN;this.shapes=null;this.numShapes=0;this.contactLink=this.parent=null;this.numContacts=0;this.jointLink=null;this.numJoints=0;this.sleeping=this.addedToIsland=!1;this.massInfo=new OIMO.MassInfo;var g=e*e+f*f+h*h;this.position=
new OIMO.Vec3(a,c,b);0<g&&(g=1/Math.sqrt(g),e*=g,f*=g,h*=g);b=Math.sin(0.5*d);d=Math.cos(0.5*d);this.orientation=new OIMO.Quat(d,b*e,b*f,b*h);this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.rotation=new OIMO.Mat33;this.inverseInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.inverseLocalInertia=new OIMO.Mat33;this.matrix=new OIMO.Mat44;this.allowSleep=!0;this.sleepTime=0};
OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(a){if(a.parent)throw Error("It is not possible that you add to the multi-rigid body the shape of one");null!=this.shapes&&((this.shapes.prev=a).next=this.shapes);this.shapes=a;a.parent=this;this.parent&&this.parent.addShape(a);this.numShapes++},removeShape:function(a){if(a.parent==this){var c=a.prev,b=a.next;null!=c&&(c.next=b);null!=b&&(b.prev=c);this.shapes==a&&(this.shapes=b);a.prev=null;a.next=null;a.parent=null;this.parent&&
this.parent.removeShape(a);this.numShapes--}},setupMass:function(a,c){var b=void 0!==c?c:!0,d=a||this.BODY_DYNAMIC;this.type=d;this.isDynamic=d==this.BODY_DYNAMIC;this.isStatic=d==this.BODY_STATIC;this.mass=0;this.localInertia.init(0,0,0,0,0,0,0,0,0);for(var e=this.localInertia.elements,f=new OIMO.Mat33,h=new OIMO.Vec3,g=this.shapes;null!=g;g=g.next){g.calculateMassInfo(this.massInfo);var l=this.massInfo.mass,k=g.relativePosition.x,p=g.relativePosition.y,q=g.relativePosition.z;h.x+=k*l;h.y+=p*l;h.z+=
q*l;this.mass+=l;this.rotateInertia(g.relativeRotation,this.massInfo.inertia,f);this.localInertia.addEqual(f);e[0]+=l*(p*p+q*q);e[4]+=l*(k*k+q*q);e[8]+=l*(k*k+p*p);var n=l*k*p,p=l*p*q,l=l*q*k;e[1]-=n;e[3]-=n;e[2]-=p;e[6]-=p;e[5]-=l;e[7]-=l}this.inverseMass=1/this.mass;h.scaleEqual(this.inverseMass);if(b){this.position.addEqual(h);for(g=this.shapes;null!=g;g=g.next)g.relativePosition.subEqual(h);k=h.x;p=h.y;q=h.z;e[0]-=this.mass*(p*p+q*q);e[4]-=this.mass*(k*k+q*q);e[8]-=this.mass*(k*k+p*p);n=this.mass*
k*p;p=this.mass*p*q;l=this.mass*q*k;e[1]+=n;e[3]+=n;e[2]+=p;e[6]+=p;e[5]+=l;e[7]+=l}this.inverseLocalInertia.invert(this.localInertia);d===this.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.init(0,0,0,0,0,0,0,0,0));this.syncShapes();this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1;this.sleepTime=0;for(var a=this.contactLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;for(a=this.jointLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;
for(a=this.shapes;null!=a;a=a.next)a.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.x=0;this.linearVelocity.y=0;this.linearVelocity.z=0;this.angularVelocity.x=0;this.angularVelocity.y=0;this.angularVelocity.z=0;this.sleepPosition.x=this.position.x;this.sleepPosition.y=this.position.y;this.sleepPosition.z=this.position.z;this.sleepOrientation.s=this.orientation.s;this.sleepOrientation.x=this.orientation.x;this.sleepOrientation.y=this.orientation.y;this.sleepOrientation.z=
this.orientation.z;this.sleepTime=0;this.sleeping=!0;for(var a=this.shapes;null!=a;a=a.next)a.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(a){switch(this.type){case this.BODY_STATIC:this.linearVelocity.x=0;this.linearVelocity.y=0;this.linearVelocity.z=0;this.angularVelocity.x=0;this.angularVelocity.y=0;this.angularVelocity.z=0;break;case this.BODY_DYNAMIC:var c=this.linearVelocity.x,b=this.linearVelocity.y,d=this.linearVelocity.z;this.position.x+=
c*a;this.position.y+=b*a;this.position.z+=d*a;var c=this.angularVelocity.x,b=this.angularVelocity.y,d=this.angularVelocity.z,e=this.orientation.s,f=this.orientation.x,h=this.orientation.y,g=this.orientation.z;a*=0.5;var l=(c*e+b*g-d*h)*a,k=(-c*g+b*e+d*f)*a,p=(c*h-b*f+d*e)*a,e=e+(-c*f-b*h-d*g)*a,f=f+l,h=h+k,g=g+p;a=1/Math.sqrt(e*e+f*f+h*h+g*g);this.orientation.s=e*a;this.orientation.x=f*a;this.orientation.y=h*a;this.orientation.z=g*a;break;default:throw Error("Invalid type.");}this.syncShapes()},rotateInertia:function(a,
c,b){var d=a.elements,e=c.elements;c=d[0];a=d[3];var f=d[6],h=d[1],g=d[4],l=d[7],k=d[2],p=d[5],d=d[8],q=e[0],n=e[3],w=e[6],u=e[1],y=e[4],r=e[7],z=e[2],B=e[5],A=e[8],e=c*q+h*n+k*w,C=c*u+h*y+k*r,P=c*z+h*B+k*A,ca=a*q+g*n+p*w,da=a*u+g*y+p*r,ua=a*z+g*B+p*A,q=f*q+l*n+d*w,u=f*u+l*y+d*r,z=f*z+l*B+d*A;b=b.elements;b[0]=e*c+C*h+P*k;b[1]=e*a+C*g+P*p;b[2]=e*f+C*l+P*d;b[3]=ca*c+da*h+ua*k;b[4]=ca*a+da*g+ua*p;b[5]=ca*f+da*l+ua*d;b[6]=q*c+u*h+z*k;b[7]=q*a+u*g+z*p;b[8]=q*f+u*l+z*d},syncShapes:function(){var a=this.orientation.s,
c=this.orientation.x,b=this.orientation.y,d=this.orientation.z,e=2*c,f=2*b,h=2*d,g=c*e,l=b*f,d=d*h,k=c*f,b=b*h,c=c*h,e=a*e,f=a*f,h=a*h,a=this.rotation.elements;a[0]=1-l-d;a[1]=k-h;a[2]=c+f;a[3]=k+h;a[4]=1-g-d;a[5]=b-e;a[6]=c-f;a[7]=b+e;a[8]=1-g-l;this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(g=this.shapes;null!=g;g=g.next)b=g.relativePosition,l=g.relativeRotation,d=g.rotation,k=b.x,h=b.y,b=b.z,g.position.x=this.position.x+k*a[0]+h*a[1]+b*a[2],g.position.y=this.position.y+
k*a[3]+h*a[4]+b*a[5],g.position.z=this.position.z+k*a[6]+h*a[7]+b*a[8],d.mul(l,this.rotation),g.updateProxy()},applyImpulse:function(a,c){this.linearVelocity.x+=c.x*this.inverseMass;this.linearVelocity.y+=c.y*this.inverseMass;this.linearVelocity.z+=c.z*this.inverseMass;var b=new OIMO.Vec3;b.sub(a,this.position).cross(b,c).mulMat(this.inverseInertia,b);this.angularVelocity.x+=b.x;this.angularVelocity.y+=b.y;this.angularVelocity.z+=b.z},setPosition:function(a,c,b){this.position.init(a*OIMO.INV_SCALE,
c*OIMO.INV_SCALE,b*OIMO.INV_SCALE);this.linearVelocity.init();this.angularVelocity.init()},setRotation:function(a,c,b){},getMatrix:function(){var a=this.matrix.elements,c;this.sleeping?a[15]=1:(c=this.rotation.elements,a[0]=c[0],a[1]=c[3],a[2]=c[6],a[3]=0,a[4]=c[1],a[5]=c[4],a[6]=c[7],a[7]=0,a[8]=c[2],a[9]=c[5],a[10]=c[8],a[11]=0,c=this.position,a[12]=c.x*OIMO.WORLD_SCALE,a[13]=c.y*OIMO.WORLD_SCALE,a[14]=c.z*OIMO.WORLD_SCALE,a[15]=0);return a}};OIMO.Body=function(a){a=a||{};if(a.world){this.name=a.name||"";for(var c=a.move||!1,b=a.noSleep||!1,d=a.pos||[0,0,0],d=d.map(function(a){return a*OIMO.INV_SCALE}),e=a.size||[1,1,1],e=e.map(function(a){return a*OIMO.INV_SCALE}),f=a.rot||[0,0,0],f=f.map(function(a){return a*OIMO.TO_RAD}),h=[],g=0;g<f.length/3;g++){var l=OIMO.EulerToAxis(f[g+0],f[g+1],f[g+2]);h.push(l[0]);h.push(l[1]);h.push(l[2]);h.push(l[3])}f=a.sc||new OIMO.ShapeConfig;a.config&&(f.density=a.config[0]||1,f.friction=a.config[1]||0.4,
f.restitution=a.config[2]||0.2,f.belongsTo=a.config[3]||1,f.collidesWith=a.config[4]||4294967295);a.massPos&&(a.massPos=a.massPos.map(function(a){return a*OIMO.INV_SCALE}),f.relativePosition.init(a.massPos[0],a.massPos[1],a.massPos[2]));a.massRot&&(a.massRot=a.massRot.map(function(a){return a*OIMO.TO_RAD}),f.relativeRotation=OIMO.EulerToMatrix(a.massRot[0],a.massRot[1],a.massRot[2]));this.body=new OIMO.RigidBody(d[0],d[1],d[2],h[0],h[1],h[2],h[3]);var l=[],k=a.type||"box";"string"===typeof k&&(k=
[k]);for(var p,q,g=0;g<k.length;g++){p=3*g;q=4*g;switch(k[g]){case "sphere":l[g]=new OIMO.SphereShape(f,e[p+0]);break;case "cylinder":l[g]=new OIMO.BoxShape(f,e[p+0],e[p+1],e[p+2]);break;case "box":l[g]=new OIMO.BoxShape(f,e[p+0],e[p+1],e[p+2])}this.body.addShape(l[g]);0<g&&(l[g].relativePosition=new OIMO.Vec3(d[p+0],d[p+1],d[p+2]),h[q+0]&&(l[g].relativeRotation=[h[q+0],h[q+1],h[q+2],h[q+3]]))}c?(a.massPos||a.massRot?this.body.setupMass(1,!1):this.body.setupMass(1,!0),this.body.allowSleep=b?!1:!0):
this.body.setupMass(2);this.body.name=this.name;a.world.addRigidBody(this.body)}};OIMO.Link=function(a){a=a||{};if(a.world){this.name=a.name||"";var c=a.type||"jointHinge",b=a.axe1||[1,0,0],d=a.axe2||[1,0,0],e=a.pos1||[0,0,0],f=a.pos2||[0,0,0],e=e.map(function(a){return a*OIMO.INV_SCALE}),f=f.map(function(a){return a*OIMO.INV_SCALE}),h,g;"jointDistance"===c?(h=a.min||0,g=a.max||10,h*=OIMO.INV_SCALE,g*=OIMO.INV_SCALE):(h=a.min||57.29578,g=a.max||0,h*=OIMO.TO_RAD,g*=OIMO.TO_RAD);var l=a.limit||null,k=a.spring||null,p=new OIMO.JointConfig;p.allowCollision=a.collision||!1;p.localAxis1.init(b[0],
b[1],b[2]);p.localAxis2.init(d[0],d[1],d[2]);p.localAnchorPoint1.init(e[0],e[1],e[2]);p.localAnchorPoint2.init(f[0],f[1],f[2]);if("string"==typeof a.body1||a.body1 instanceof String)a.body1=a.world.getByName(a.body1);if("string"==typeof a.body2||a.body2 instanceof String)a.body2=a.world.getByName(a.body2);p.body1=a.body1;p.body2=a.body2;switch(c){case "jointDistance":this.joint=new OIMO.DistanceJoint(p,h,g);null!==k&&this.joint.limitMotor.setSpring(k[0],k[1]);break;case "jointHinge":this.joint=new OIMO.HingeJoint(p,
h,g);null!==k&&this.joint.limitMotor.setSpring(k[0],k[1]);break;case "jointPrisme":this.joint=new OIMO.PrismaticJoint(p,h,g);break;case "jointSlide":this.joint=new OIMO.SliderJoint(p,h,g);break;case "jointBall":this.joint=new OIMO.BallAndSocketJoint(p);break;case "jointWheel":this.joint=new OIMO.WheelJoint(p),null!==l&&this.joint.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==k&&this.joint.rotationalLimitMotor1.setSpring(k[0],k[1])}this.joint.name=this.name;a.world.addJoint(this.joint)}};OIMO.Performance=function(){this.totalTime=this.updatingTime=this.solvingTime=this.narrowPhaseTime=this.broadPhaseTime=this.fps=this.fpsint=this.time_prev=0};OIMO.Mat44=function(a,c,b,d,e,f,h,g,l,k,p,q,n,w,u,y){var r=this.elements=new Float32Array(16);r[0]=void 0!==a?a:1;r[4]=c||0;r[8]=b||0;r[12]=d||0;r[1]=e||0;r[5]=void 0!==f?f:1;r[9]=h||0;r[13]=g||0;r[2]=l||0;r[6]=k||0;r[10]=void 0!==p?p:1;r[14]=q||0;r[3]=n||0;r[7]=w||0;r[11]=u||0;r[15]=void 0!==y?y:1};
OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(a,c,b,d,e,f,h,g,l,k,p,q,n,w,u,y){var r=this.elements;r[0]=a;r[4]=c;r[8]=b;r[12]=d;r[1]=e;r[5]=f;r[9]=h;r[13]=g;r[2]=l;r[6]=k;r[10]=p;r[14]=q;r[3]=n;r[7]=w;r[11]=u;r[15]=y;return this}};OIMO.Mat33=function(a,c,b,d,e,f,h,g,l){this.elements=new Float32Array(9);this.init(void 0!==a?a:1,c||0,b||0,d||0,void 0!==e?e:1,f||0,h||0,g||0,void 0!==l?l:1)};
OIMO.Mat33.prototype={constructor:OIMO.Mat33,init:function(a,c,b,d,e,f,h,g,l){var k=this.elements;k[0]=a;k[1]=c;k[2]=b;k[3]=d;k[4]=e;k[5]=f;k[6]=h;k[7]=g;k[8]=l;return this},add:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]+e[0];b[1]=d[1]+e[1];b[2]=d[2]+e[2];b[3]=d[3]+e[3];b[4]=d[4]+e[4];b[5]=d[5]+e[5];b[6]=d[6]+e[6];b[7]=d[7]+e[7];b[8]=d[8]+e[8];return this},addEqual:function(a){var c=this.elements;a=a.elements;c[0]+=a[0];c[1]+=a[1];c[2]+=a[2];c[3]+=a[3];c[4]+=a[4];c[5]+=
a[5];c[6]+=a[6];c[7]+=a[7];c[8]+=a[8];return this},sub:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]-e[0];b[1]=d[1]-e[1];b[2]=d[2]-e[2];b[3]=d[3]-e[3];b[4]=d[4]-e[4];b[5]=d[5]-e[5];b[6]=d[6]-e[6];b[7]=d[7]-e[7];b[8]=d[8]-e[8];return this},subEqual:function(a){var c=this.elements;a=a.elements;c[0]-=a[0];c[1]-=a[1];c[2]-=a[2];c[3]-=a[3];c[4]-=a[4];c[5]-=a[5];c[6]-=a[6];c[7]-=a[7];c[8]-=a[8];return this},scale:function(a,c){var b=this.elements,d=a.elements;b[0]=d[0]*c;b[1]=d[1]*
c;b[2]=d[2]*c;b[3]=d[3]*c;b[4]=d[4]*c;b[5]=d[5]*c;b[6]=d[6]*c;b[7]=d[7]*c;b[8]=d[8]*c;return this},scaleEqual:function(a){var c=this.elements;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=a;c[4]*=a;c[5]*=a;c[6]*=a;c[7]*=a;c[8]*=a;return this},mul:function(a,c){var b=this.elements,d=a.elements,e=c.elements,f=d[0],h=d[3],g=d[6],l=d[1],k=d[4],p=d[7],q=d[2],n=d[5],d=d[8],w=e[0],u=e[3],y=e[6],r=e[1],z=e[4],B=e[7],A=e[2],C=e[5],e=e[8];b[0]=f*w+l*u+q*y;b[1]=f*r+l*z+q*B;b[2]=f*A+l*C+q*e;b[3]=h*w+k*u+n*y;b[4]=h*r+k*z+n*B;
b[5]=h*A+k*C+n*e;b[6]=g*w+p*u+d*y;b[7]=g*r+p*z+d*B;b[8]=g*A+p*C+d*e;return this},mulScale:function(a,c,b,d,e){var f=this.elements;a=a.elements;e?(f[0]=c*a[0],f[1]=c*a[1],f[2]=c*a[2],f[3]=b*a[3],f[4]=b*a[4],f[5]=b*a[5],f[6]=d*a[6],f[7]=d*a[7],f[8]=d*a[8]):(f[0]=a[0]*c,f[1]=a[1]*b,f[2]=a[2]*d,f[3]=a[3]*c,f[4]=a[4]*b,f[5]=a[5]*d,f[6]=a[6]*c,f[7]=a[7]*b,f[8]=a[8]*d);return this},mulRotate:function(a,c,b,d,e,f){f=f||!1;var h=Math.sin(c),g=Math.cos(c),l=1-g;c=b*b*l+g;var k=b*d*l-e*h,p=b*e*l+d*h,q=d*b*l+
e*h,n=d*d*l+g,w=d*e*l-b*h,u=e*b*l-d*h;b=e*d*l+b*h;e=e*e*l+g;var y=a.elements;a=y[0];d=y[3];var h=y[6],g=y[1],l=y[4],r=y[7],z=y[2],B=y[5],y=y[8],A=this.elements;f?(A[0]=c*a+k*d+p*h,A[1]=c*g+k*l+p*r,A[2]=c*z+k*B+p*y,A[3]=q*a+n*d+w*h,A[4]=q*g+n*l+w*r,A[5]=q*z+n*B+w*y,A[6]=u*a+b*d+e*h,A[7]=u*g+b*l+e*r,A[8]=u*z+b*B+e*y):(A[0]=a*c+g*q+z*u,A[1]=a*k+g*n+z*b,A[2]=a*p+g*w+z*e,A[3]=d*c+l*q+B*u,A[4]=d*k+l*n+B*b,A[5]=d*p+l*w+B*e,A[6]=h*c+r*q+y*u,A[7]=h*k+r*n+y*b,A[8]=h*p+r*w+y*e);return this},transpose:function(a){var c=
this.elements;a=a.elements;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];return this},setQuat:function(a){var c=2*a.x,b=2*a.y,d=2*a.z,e=a.x*c,f=a.y*b,h=a.z*d,g=a.x*b,l=a.y*d,k=a.x*d,c=a.s*c,b=a.s*b;a=a.s*d;d=this.elements;d[0]=1-f-h;d[1]=g-a;d[2]=k+b;d[3]=g+a;d[4]=1-e-h;d[5]=l-c;d[6]=k-b;d[7]=l+c;d[8]=1-e-f;return this},invert:function(a){var c=this.elements,b=a.elements;a=b[0];var d=b[3],e=b[6],f=b[1],h=b[4],g=b[7],l=b[2],k=b[5],b=b[8],p=a*(h*b-g*k)+d*
(g*l-f*b)+e*(f*k-h*l);0!=p&&(p=1/p);c[0]=p*(h*b-k*g);c[1]=p*(l*g-f*b);c[2]=p*(f*k-l*h);c[3]=p*(k*e-d*b);c[4]=p*(a*b-l*e);c[5]=p*(l*d-a*k);c[6]=p*(d*g-h*e);c[7]=p*(f*e-a*g);c[8]=p*(a*h-f*d);return this},copy:function(a){var c=this.elements;a=a.elements;c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];return this},toEuler:function(){var a=this.elements,c=a[0],b=a[3],d=a[6],e=a[4],f=a[7],h=a[5],a=a[8],g=new OIMO.Vec3;new OIMO.Quat;g.y=Math.asin(Math.min(Math.max(d,
-1),1));0.99999>Math.abs(d)?(g.x=Math.atan2(-f,a),g.z=Math.atan2(-b,c)):(g.x=Math.atan2(h,e),g.z=0);return g},clone:function(){var a=this.elements;return new OIMO.Mat33(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},toString:function(){var a=this.elements;return"Mat33|"+a[0].toFixed(4)+", "+a[1].toFixed(4)+", "+a[2].toFixed(4)+"|\n     |"+a[3].toFixed(4)+", "+a[4].toFixed(4)+", "+a[5].toFixed(4)+"|\n     |"+a[6].toFixed(4)+", "+a[7].toFixed(4)+", "+a[8].toFixed(4)+"|"}};OIMO.Quat=function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0};
OIMO.Quat.prototype={constructor:OIMO.Quat,init:function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0;return this},add:function(a,c){this.s=a.s+c.s;this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},sub:function(a,c){this.s=a.s-c.s;this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},scale:function(a,c){this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},mul:function(a,c){var b=a.s*c.x+a.x*c.s+a.y*c.z-a.z*c.y,d=a.s*c.y-a.x*c.z+a.y*c.s+a.z*c.x,e=a.s*c.z+
a.x*c.y-a.y*c.x+a.z*c.s;this.s=a.s*c.s-a.x*c.x-a.y*c.y-a.z*c.z;this.x=b;this.y=d;this.z=e;return this},arc:function(a,c){var b=a.x,d=a.y,e=a.z,f=c.x,h=c.y,g=c.z,l=b*f+d*h+e*g;if(-1==l)return f=d*b-e*e,h=-e*d-b*b,g=b*e+d*d,l=1/Math.sqrt(f*f+h*h+g*g),this.s=0,this.x=f*l,this.y=h*l,this.z=g*l,this;var k=d*g-e*h,e=e*f-b*g,b=b*h-d*f;this.s=Math.sqrt(0.5*(1+l));l=0.5/this.s;this.x=k*l;this.y=e*l;this.z=b*l;return this},normalize:function(a){var c=Math.sqrt(a.s*a.s+a.x*a.x+a.y*a.y+a.z*a.z);0<c&&(c=1/c);
this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},invert:function(a){this.s=a.s;this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){return Math.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.s=a.s;this.x=a.x;this.y=a.y;this.z=a.z;return this},clone:function(a){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+
")]"}};OIMO.Vec3=function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0};
OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},add:function(a,c){this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addEqual:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},subEqual:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},scale:function(a,c){this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},scaleEqual:function(a){this.x*=
a;this.y*=a;this.z*=a;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a,c){var b=a.z*c.x-a.x*c.z,d=a.x*c.y-a.y*c.x;this.x=a.y*c.z-a.z*c.y;this.y=b;this.z=d;return this},mulMat:function(a,c){var b=a.elements,d=b[3]*c.x+b[4]*c.y+b[5]*c.z,e=b[6]*c.x+b[7]*c.y+b[8]*c.z;this.x=b[0]*c.x+b[1]*c.y+b[2]*c.z;this.y=d;this.z=e;return this},normalize:function(a){var c=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);0<c&&(c=1/c);this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},invert:function(a){this.x=
-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},clone:function(){return new OIMO.Vec3(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"}};OIMO.EulerToAxis=function(a,c,b){var d=Math.cos(0.5*c);c=Math.sin(0.5*c);var e=Math.cos(0.5*b),f=Math.sin(0.5*b),h=Math.cos(0.5*a),g=Math.sin(0.5*a),l=d*e,k=c*f;a=l*g+k*h;b=c*e*h+d*f*g;d=d*f*h-c*e*g;c=2*Math.acos(l*h-k*g);e=a*a+b*b+d*d;0.001>e?(a=1,b=d=0):(e=Math.sqrt(e),a/=e,b/=e,d/=e);return[c,a,b,d]};
OIMO.EulerToMatrix=function(a,c,b){var d=Math.cos(c);c=Math.sin(c);var e=Math.cos(b);b=Math.sin(b);var f=Math.cos(a);a=Math.sin(a);var h=new OIMO.Mat33,g=h.elements;g[0]=d*e;g[1]=c*a-d*b*f;g[2]=d*b*a+c*f;g[3]=b;g[4]=e*f;g[5]=-e*a;g[6]=-c*e;g[7]=c*b*f+d*a;g[8]=-c*b*a+d*f;return h};
OIMO.MatrixToEuler=function(a){var c=a.elements,b;0.998<c[3]?(b=Math.atan2(c[2],c[8]),c=Math.PI/2,a=0):-0.998>c[3]?(b=Math.atan2(c[2],c[8]),c=-Math.PI/2,a=0):(b=Math.atan2(-c[6],c[0]),a=Math.atan2(-c[5],c[4]),c=Math.asin(c[3]));return[a,b,c]};OIMO.Distance3d=function(a,c){var b=c[0]-a[0],d=c[1]-a[1],e=c[2]-a[2];return Math.sqrt(b*b+d*d+e*e)};OIMO.Constraint=function(){this.body2=this.body1=this.parent=null;this.addedToIsland=!1};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(a,c){throw Error("Inheritance error.");},solve:function(){throw Error("Inheritance error.");},postSolve:function(){throw Error("Inheritance error.");}};OIMO.Joint=function(a){OIMO.Constraint.call(this);this.name="";this.JOINT_DISTANCE=1;this.JOINT_BALL_AND_SOCKET=2;this.JOINT_HINGE=3;this.JOINT_WHEEL=4;this.JOINT_SLIDER=5;this.JOINT_PRISMATIC=6;this.type=0;this.next=this.prev=null;this.body1=a.body1;this.body2=a.body2;this.localAnchorPoint1=(new OIMO.Vec3).copy(a.localAnchorPoint1);this.localAnchorPoint2=(new OIMO.Vec3).copy(a.localAnchorPoint2);this.relativeAnchorPoint1=new OIMO.Vec3;this.relativeAnchorPoint2=new OIMO.Vec3;this.anchorPoint1=new OIMO.Vec3;
this.anchorPoint2=new OIMO.Vec3;this.allowCollision=a.allowCollision;this.b1Link=new OIMO.JointLink(this);this.b2Link=new OIMO.JointLink(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);
OIMO.Joint.prototype.updateAnchorPoints=function(){var a=this.body1.position,c=this.body2.position,b=this.body1.rotation.elements,d=this.body2.rotation.elements,e=this.localAnchorPoint1.x,f=this.localAnchorPoint1.y,h=this.localAnchorPoint1.z,g=this.localAnchorPoint2.x,l=this.localAnchorPoint2.y,k=this.localAnchorPoint2.z,p=e*b[0]+f*b[1]+h*b[2],q=e*b[3]+f*b[4]+h*b[5],f=e*b[6]+f*b[7]+h*b[8],e=g*d[0]+l*d[1]+k*d[2],b=g*d[3]+l*d[4]+k*d[5],d=g*d[6]+l*d[7]+k*d[8];this.relativeAnchorPoint1.x=p;this.relativeAnchorPoint1.y=
q;this.relativeAnchorPoint1.z=f;this.relativeAnchorPoint2.x=e;this.relativeAnchorPoint2.y=b;this.relativeAnchorPoint2.z=d;q+=a.y;g=f+a.z;l=e+c.x;k=b+c.y;c=d+c.z;this.anchorPoint1.x=p+a.x;this.anchorPoint1.y=q;this.anchorPoint1.z=g;this.anchorPoint2.x=l;this.anchorPoint2.y=k;this.anchorPoint2.z=c};
OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2;this.b2Link.body=this.body1;null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null;this.body1.jointLink=this.b1Link;this.body1.numJoints++;null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null;this.body2.jointLink=this.b2Link;this.body2.numJoints++};
OIMO.Joint.prototype.detach=function(){var a=this.b1Link.prev,c=this.b1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body1.jointLink==this.b1Link&&(this.body1.jointLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.body=null;this.body1.numJoints--;a=this.b2Link.prev;c=this.b2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body2.jointLink==this.b2Link&&(this.body2.jointLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.body=null;this.body2.numJoints--;this.b1Link.body=
null;this.b2Link.body=null};OIMO.Joint.prototype.awake=function(){this.body1.awake();this.body2.awake()};OIMO.Joint.prototype.preSolve=function(a,c){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};
OIMO.Joint.prototype.getMatrix=function(){var a=this.matrix.elements,c=this.anchorPoint1,b=this.anchorPoint2;a[0]=c.x*OIMO.WORLD_SCALE;a[1]=c.y*OIMO.WORLD_SCALE;a[2]=c.z*OIMO.WORLD_SCALE;a[3]=0;a[4]=b.x*OIMO.WORLD_SCALE;a[5]=b.y*OIMO.WORLD_SCALE;a[6]=b.z*OIMO.WORLD_SCALE;a[7]=0;return a};OIMO.JointConfig=function(){this.body2=this.body1=null;this.localAnchorPoint1=new OIMO.Vec3;this.localAnchorPoint2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=!1};OIMO.JointLink=function(a){this.body=this.next=this.prev=null;this.joint=a};OIMO.LimitMotor=function(a,c){this.axis=a;this.angle=0;this.lowerLimit=c?0:1;this.dampingRatio=this.frequency=this.maxMotorForce=this.motorSpeed=this.upperLimit=0};OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(a,c){this.lowerLimit=a;this.upperLimit=c},setMotor:function(a,c){this.motorSpeed=a;this.maxMotorForce=c},setSpring:function(a,c){this.frequency=a;this.dampingRatio=c}};OIMO.BallAndSocketJoint=function(a){OIMO.Joint.call(this,a);this.type=this.JOINT_BALL_AND_SOCKET;this.lc=new OIMO.LinearConstraint(this)};OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallAndSocketJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();this.lc.preSolve(a,c)};OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()};OIMO.BallAndSocketJoint.prototype.postSolve=function(){};OIMO.DistanceJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=this.JOINT_DISTANCE;this.normal=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.normal,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.DistanceJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();var b=this.anchorPoint2.x-this.anchorPoint1.x,d=this.anchorPoint2.y-this.anchorPoint1.y,e=this.anchorPoint2.z-this.anchorPoint1.z,f=Math.sqrt(b*b+d*d+e*e);0<f&&(f=1/f);this.normal.init(b*f,d*f,e*f);this.t.preSolve(a,c)};OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(a,c,b){OIMO.Joint.call(this,a);this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+
this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+
this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.type=this.JOINT_HINGE;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.nor,!1);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.lc=new OIMO.LinearConstraint(this);this.r3=new OIMO.Rotational3Constraint(this,
this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.HingeJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var h=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],g=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],l=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var k=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],q=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],n=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],w=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],u=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],y=e*this.body2.inverseMass+k*this.body1.inverseMass,r=f*this.body2.inverseMass+p*this.body1.inverseMass,z=d*this.body2.inverseMass+q*this.body1.inverseMass;b=Math.sqrt(y*y+r*r+z*z);0<b&&(b=1/b);var y=y*b,r=r*b,z=z*b,B=r*y-z*z,A=-z*r-y*y,C=y*z+r*r;b=1/Math.sqrt(B*B+A*A+C*C);var B=B*b,A=A*b,C=C*b,P=r*C-z*A,ca=z*B-y*C,da=y*A-r*B;this.nor.init(y,r,z);this.tan.init(B,A,C);this.bin.init(P,ca,da);this.limitMotor.angle=0>y*(g*u-l*w)+r*(l*n-h*u)+z*(h*w-g*n)?-this.acosClamp(h*n+g*w+l*u):this.acosClamp(h*
n+g*w+l*u);b=f*q-d*p;d=d*k-e*q;e=e*p-f*k;this.r3.limitMotor2.angle=B*b+A*d+C*e;this.r3.limitMotor3.angle=P*b+ca*d+da*e;this.r3.preSolve(a,c);this.lc.preSolve(a,c)};OIMO.HingeJoint.prototype.solve=function(){this.r3.solve();this.lc.solve()};OIMO.HingeJoint.prototype.postSolve=function(){};OIMO.HingeJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.PrismaticJoint=function(a,c,b){OIMO.Joint.call(this,a);this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.type=this.JOINT_PRISMATIC;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ac=new OIMO.AngularConstraint(this,
(new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.limitMotor=new OIMO.LimitMotor(this.nor,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.PrismaticJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],h=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];b=this.body2.rotation.elements;e=e*this.body2.inverseMass+(this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2])*this.body1.inverseMass;f=f*this.body2.inverseMass+
(this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5])*this.body1.inverseMass;b=h*this.body2.inverseMass+(this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8])*this.body1.inverseMass;d=Math.sqrt(e*e+f*f+b*b);0<d&&(d=1/d);e*=d;f*=d;b*=d;var h=f*e-b*b,g=-b*f-e*e,l=e*b+f*f;d=1/Math.sqrt(h*h+g*g+l*l);h*=d;g*=d;l*=d;d=f*l-b*g;var k=b*h-e*l,p=e*g-f*h;this.nor.init(e,f,b);this.tan.init(h,g,l);this.bin.init(d,k,p);this.ac.preSolve(a,c);this.t3.preSolve(a,c)};
OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve();this.t3.solve()};OIMO.PrismaticJoint.prototype.postSolve=function(){};OIMO.SliderJoint=function(a,c,b){OIMO.Joint.call(this,a);this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+
this.localAxis1Y*this.localAxis1Y;a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+
this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.type=this.joint.Joint.JOINT_SLIDER;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,!1);this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,
!0));this.translationalLimitMotor=new OIMO.LimitMotor(this.nor,!0);this.translationalLimitMotor.lowerLimit=c;this.translationalLimitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.SliderJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var h=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],g=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],l=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var k=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],q=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],n=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],w=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],u=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],y=e*this.body2.inverseMass+k*this.body1.inverseMass,r=f*this.body2.inverseMass+p*this.body1.inverseMass,z=d*this.body2.inverseMass+q*this.body1.inverseMass;b=Math.sqrt(y*y+r*r+z*z);0<b&&(b=1/b);var y=y*b,r=r*b,z=z*b,B=r*y-z*z,A=-z*r-y*y,C=y*z+r*r;b=1/Math.sqrt(B*B+A*A+C*C);var B=B*b,A=A*b,C=C*b,P=r*C-z*A,ca=z*B-y*C,da=y*A-r*B;this.nor.init(y,r,z);this.tan.init(B,A,C);this.bin.init(P,ca,da);this.rotationalLimitMotor.angle=0>y*(g*u-l*w)+r*(l*n-h*u)+z*(h*w-g*n)?-this.acosClamp(h*n+g*w+l*u):this.acosClamp(h*
n+g*w+l*u);b=f*q-d*p;d=d*k-e*q;e=e*p-f*k;this.r3.limitMotor2.angle=B*b+A*d+C*e;this.r3.limitMotor3.angle=P*b+ca*d+da*e;this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.SliderJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.SliderJoint.prototype.postSolve=function(){};OIMO.SliderJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.WheelJoint=function(a){OIMO.Joint.call(this,a);this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;-1<a&&1>a?(this.localAngAxis1X=
this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,a=1/Math.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=
a,a=1/Math.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=a,this.localAngAxis2Y*=a,this.localAngAxis2Z*=a):(this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,a=1/Math.sqrt(this.localAngAxis1X*
this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements,this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*
a[7]+this.localAngAxis1Z*a[8]);this.type=this.JOINT_WHEEL;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,!0);this.translationalLimitMotor.frequency=8;this.translationalLimitMotor.dampingRatio=1;this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,!1);this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,!1);this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.translationalLimitMotor,
new OIMO.LimitMotor(this.bin,!0));this.t3.weight=1;this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)};OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype);
OIMO.WheelJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],h=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];d=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2];var g=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],l=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var k=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],p=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],q=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],n=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],w=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5];b=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8];this.r3.limitMotor1.angle=e*k+f*p+h*q;this.rotationalLimitMotor1.angle=0>e*(g*q-l*p)+f*(l*k-d*q)+h*(d*p-g*k)?-this.acosClamp(d*k+g*p+l*q):this.acosClamp(d*k+g*p+l*q);this.rotationalLimitMotor2.angle=0>k*(w*h-b*f)+p*(b*e-n*h)+q*(n*f-w*e)?this.acosClamp(n*e+w*f+b*h):-this.acosClamp(n*e+w*f+b*h);g=p*h-q*f;l=q*e-k*h;n=k*f-p*e;d=Math.sqrt(g*g+l*l+n*n);0<d&&(d=1/d);g*=d;l*=d;n*=d;w=l*q-n*p;q=n*k-g*q;k=g*p-l*k;d=Math.sqrt(w*w+q*q+k*k);0<d&&(d=1/d);w*=d;q*=d;k*=d;p=f*n-h*l;h=h*g-e*n;e=e*l-f*g;d=Math.sqrt(p*
p+h*h+e*e);0<d&&(d=1/d);p*=d;h*=d;e*=d;this.nor.init(g,l,n);this.tan.init(w,q,k);this.bin.init(p,h,e);this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.WheelJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.WheelJoint.prototype.postSolve=function(){};OIMO.WheelJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?Math.PI:Math.acos(a)};OIMO.AngularConstraint=function(a,c){this.velz=this.vely=this.velx=this.az=this.ay=this.ax=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.joint=a;this.targetOrientation=(new OIMO.Quat).invert(c);this.relativeOrientation=new OIMO.Quat;this.b1=a.body1;this.b2=a.body2;
this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(a,c){var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.i1e00+this.i2e00,d=this.i1e01+this.i2e01,e=this.i1e02+this.i2e02,f=this.i1e10+
this.i2e10,h=this.i1e11+this.i2e11,g=this.i1e12+this.i2e12,l=this.i1e20+this.i2e20,k=this.i1e21+this.i2e21,p=this.i1e22+this.i2e22,q=1/(b*(h*p-k*g)+f*(k*e-d*p)+l*(d*g-h*e));this.d00=(h*p-g*k)*q;this.d01=(e*k-d*p)*q;this.d02=(d*g-e*h)*q;this.d10=(g*l-f*p)*q;this.d11=(b*p-e*l)*q;this.d12=(e*f-b*g)*q;this.d20=(f*k-h*l)*q;this.d21=(d*l-b*k)*q;this.d22=(b*h-d*f)*q;this.relativeOrientation.invert(this.b1.orientation);this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation);this.relativeOrientation.mul(this.b2.orientation,
this.relativeOrientation);q=2*this.relativeOrientation.s;this.velx=this.relativeOrientation.x*q;this.vely=this.relativeOrientation.y*q;this.velz=this.relativeOrientation.z*q;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.02<b?(b=(0.02-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.a1.x+=this.impx*this.i1e00+this.impy*this.i1e01+this.impz*this.i1e02;this.a1.y+=this.impx*this.i1e10+this.impy*this.i1e11+this.impz*this.i1e12;this.a1.z+=
this.impx*this.i1e20+this.impy*this.i1e21+this.impz*this.i1e22;this.a2.x-=this.impx*this.i2e00+this.impy*this.i2e01+this.impz*this.i2e02;this.a2.y-=this.impx*this.i2e10+this.impy*this.i2e11+this.impz*this.i2e12;this.a2.z-=this.impx*this.i2e20+this.impy*this.i2e21+this.impz*this.i2e22},solve:function(){var a=this.a2.x-this.a1.x-this.velx,c=this.a2.y-this.a1.y-this.vely,b=this.a2.z-this.a1.z-this.velz,d=a*this.d00+c*this.d01+b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;
this.impx+=d;this.impy+=e;this.impz+=a;this.a1.x+=d*this.i1e00+e*this.i1e01+a*this.i1e02;this.a1.y+=d*this.i1e10+e*this.i1e11+a*this.i1e12;this.a1.z+=d*this.i1e20+e*this.i1e21+a*this.i1e22;this.a2.x-=d*this.i2e00+e*this.i2e01+a*this.i2e02;this.a2.y-=d*this.i2e10+e*this.i2e11+a*this.i2e12;this.a2.z-=d*this.i2e20+e*this.i2e21+a*this.i2e22}};OIMO.LinearConstraint=function(a){this.velz=this.vely=this.velx=this.vel=this.az2z=this.az2y=this.az2x=this.ay2z=this.ay2y=this.ay2x=this.ax2z=this.ax2y=this.ax2x=this.az1z=this.az1y=this.az1x=this.ay1z=this.ay1y=this.ay1x=this.ax1z=this.ax1y=this.ax1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.joint=a;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.b1=a.body1;this.b2=a.body2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(a,c){this.r1x=this.r1.x;this.r1y=this.r1.y;this.r1z=this.r1.z;this.r2x=this.r2.x;this.r2y=this.r2.y;this.r2z=this.r2.z;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=
d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];this.ax1x=this.r1z*this.i1e01+-this.r1y*this.i1e02;this.ax1y=this.r1z*this.i1e11+-this.r1y*this.i1e12;this.ax1z=this.r1z*this.i1e21+-this.r1y*this.i1e22;this.ay1x=-this.r1z*this.i1e00+this.r1x*this.i1e02;this.ay1y=-this.r1z*this.i1e10+this.r1x*this.i1e12;this.ay1z=-this.r1z*this.i1e20+this.r1x*this.i1e22;this.az1x=this.r1y*this.i1e00+-this.r1x*this.i1e01;this.az1y=this.r1y*this.i1e10+-this.r1x*this.i1e11;this.az1z=
this.r1y*this.i1e20+-this.r1x*this.i1e21;this.ax2x=this.r2z*this.i2e01+-this.r2y*this.i2e02;this.ax2y=this.r2z*this.i2e11+-this.r2y*this.i2e12;this.ax2z=this.r2z*this.i2e21+-this.r2y*this.i2e22;this.ay2x=-this.r2z*this.i2e00+this.r2x*this.i2e02;this.ay2y=-this.r2z*this.i2e10+this.r2x*this.i2e12;this.ay2z=-this.r2z*this.i2e20+this.r2x*this.i2e22;this.az2x=this.r2y*this.i2e00+-this.r2x*this.i2e01;this.az2y=this.r2y*this.i2e10+-this.r2x*this.i2e11;this.az2z=this.r2y*this.i2e20+-this.r2x*this.i2e21;var b=
this.m1+this.m2,e,f,h=b,g,l,k,p=b,b=b+(this.i1e11*this.r1z*this.r1z-(this.i1e21+this.i1e12)*this.r1y*this.r1z+this.i1e22*this.r1y*this.r1y),d=0+((this.i1e20*this.r1y+this.i1e12*this.r1x)*this.r1z-this.i1e10*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);e=0+((this.i1e10*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e20*this.r1y*this.r1y+this.i1e21*this.r1x*this.r1y);f=0+((this.i1e02*this.r1y+this.i1e21*this.r1x)*this.r1z-this.i1e01*this.r1z*this.r1z-this.i1e22*this.r1x*this.r1y);h+=this.i1e00*this.r1z*
this.r1z-(this.i1e20+this.i1e02)*this.r1x*this.r1z+this.i1e22*this.r1x*this.r1x;g=0+((this.i1e01*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e21*this.r1x*this.r1x+this.i1e20*this.r1x*this.r1y);l=0+((this.i1e01*this.r1y-this.i1e11*this.r1x)*this.r1z-this.i1e02*this.r1y*this.r1y+this.i1e12*this.r1x*this.r1y);k=0+((this.i1e10*this.r1x-this.i1e00*this.r1y)*this.r1z-this.i1e12*this.r1x*this.r1x+this.i1e02*this.r1x*this.r1y);p+=this.i1e00*this.r1y*this.r1y-(this.i1e10+this.i1e01)*this.r1x*this.r1y+this.i1e11*
this.r1x*this.r1x;b+=this.i2e11*this.r2z*this.r2z-(this.i2e21+this.i2e12)*this.r2y*this.r2z+this.i2e22*this.r2y*this.r2y;d+=(this.i2e20*this.r2y+this.i2e12*this.r2x)*this.r2z-this.i2e10*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;e+=(this.i2e10*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e20*this.r2y*this.r2y+this.i2e21*this.r2x*this.r2y;f+=(this.i2e02*this.r2y+this.i2e21*this.r2x)*this.r2z-this.i2e01*this.r2z*this.r2z-this.i2e22*this.r2x*this.r2y;h+=this.i2e00*this.r2z*this.r2z-(this.i2e20+
this.i2e02)*this.r2x*this.r2z+this.i2e22*this.r2x*this.r2x;g+=(this.i2e01*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e21*this.r2x*this.r2x+this.i2e20*this.r2x*this.r2y;l+=(this.i2e01*this.r2y-this.i2e11*this.r2x)*this.r2z-this.i2e02*this.r2y*this.r2y+this.i2e12*this.r2x*this.r2y;k+=(this.i2e10*this.r2x-this.i2e00*this.r2y)*this.r2z-this.i2e12*this.r2x*this.r2x+this.i2e02*this.r2x*this.r2y;var p=p+(this.i2e00*this.r2y*this.r2y-(this.i2e10+this.i2e01)*this.r2x*this.r2y+this.i2e11*this.r2x*this.r2x),
q=1/(b*(h*p-k*g)+f*(k*e-d*p)+l*(d*g-h*e));this.d00=(h*p-g*k)*q;this.d01=(e*k-d*p)*q;this.d02=(d*g-e*h)*q;this.d10=(g*l-f*p)*q;this.d11=(b*p-e*l)*q;this.d12=(e*f-b*g)*q;this.d20=(f*k-h*l)*q;this.d21=(d*l-b*k)*q;this.d22=(b*h-d*f)*q;this.velx=this.p2.x-this.p1.x;this.vely=this.p2.y-this.p1.y;this.velz=this.p2.z-this.p1.z;b=Math.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.005<b?(b=(0.005-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.impx*=
0.95;this.impy*=0.95;this.impz*=0.95;this.l1.x+=this.impx*this.m1;this.l1.y+=this.impy*this.m1;this.l1.z+=this.impz*this.m1;this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x;this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y;this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z;this.l2.x-=this.impx*this.m2;this.l2.y-=this.impy*this.m2;this.l2.z-=this.impz*this.m2;this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x;this.a2.y-=
this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y;this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,d=a*this.d00+c*this.d01+
b*this.d02,e=a*this.d10+c*this.d11+b*this.d12,a=a*this.d20+c*this.d21+b*this.d22;this.impx+=d;this.impy+=e;this.impz+=a;this.l1.x+=d*this.m1;this.l1.y+=e*this.m1;this.l1.z+=a*this.m1;this.a1.x+=d*this.ax1x+e*this.ay1x+a*this.az1x;this.a1.y+=d*this.ax1y+e*this.ay1y+a*this.az1y;this.a1.z+=d*this.ax1z+e*this.ay1z+a*this.az1z;this.l2.x-=d*this.m2;this.l2.y-=e*this.m2;this.l2.z-=a*this.m2;this.a2.x-=d*this.ax2x+e*this.ay2x+a*this.az2x;this.a2.y-=d*this.ax2y+e*this.ay2y+a*this.az2y;this.a2.z-=d*this.ax2z+
e*this.ay2z+a*this.az2z}};OIMO.Rotational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=this.a1y1=this.a1x1=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=
this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm3=this.cfm2=this.cfm1=NaN;this.limitState1=0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=
this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=
this.motorImpulse1=this.limitImpulse1=0};
OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,f=0<e,h=0<b,g=0<d,l=this.lowerLimit2<=this.upperLimit2,
k=this.lowerLimit3<=this.upperLimit3,p=this.limitMotor1.angle;this.lowerLimit1<=this.upperLimit1?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-p):p<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-p):p>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-p):(this.limitState1=
2,this.limitVelocity1=this.limitImpulse1=0),f||(this.limitVelocity1=0.02<this.limitVelocity1?this.limitVelocity1-0.02:-0.02>this.limitVelocity1?this.limitVelocity1+0.02:0)):(this.limitState1=2,this.limitImpulse1=0);p=this.limitMotor2.angle;l?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-p):p<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-
p):p>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-p):(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),h||(this.limitVelocity2=0.02<this.limitVelocity2?this.limitVelocity2-0.02:-0.02>this.limitVelocity2?this.limitVelocity2+0.02:0)):(this.limitState2=2,this.limitImpulse2=0);l=this.limitMotor3.angle;k?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=
this.lowerLimit3-l):l<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),g||(this.limitVelocity3=0.02<this.limitVelocity3?this.limitVelocity3-0.02:-0.02>this.limitVelocity3?this.limitVelocity3+0.02:0)):(this.limitState3=2,this.limitImpulse3=0);
this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||f)?this.maxMotorForce1*a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||h)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||g)?this.maxMotorForce3*a:this.motorImpulse3=0;this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02;this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12;this.a1z1=this.ax1*this.i1e20+this.ay1*
this.i1e21+this.az1*this.i1e22;this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02;this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12;this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22;this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02;this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12;this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22;this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+
this.az2*this.i2e02;this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12;this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22;this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02;this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12;this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22;this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02;this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12;
this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22;this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1);this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2);this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3);this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1);this.k11=this.ax2*(this.a1x2+
this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2);this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3);this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1);this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2);this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3);this.kv00=this.k00;this.kv11=
this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;f&&2!=this.limitState1?(f=6.2831853*e,e=f*f*a,f=c/(e+2*this.limitMotor1.dampingRatio*f),this.cfm1=this.kv00*f,this.limitVelocity1=this.limitVelocity1*e*f):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);h&&2!=this.limitState2?(f=6.2831853*b,e=f*f*a,f=c/(e+2*this.limitMotor2.dampingRatio*f),this.cfm2=this.kv11*f,this.limitVelocity2=this.limitVelocity2*e*f):(this.cfm2=0,this.limitVelocity2=0.05*
this.limitVelocity2*c);g&&2!=this.limitState3?(f=6.2831853*d,e=f*f*a,f=c/(e+2*this.limitMotor3.dampingRatio*f),this.cfm3=this.kv22*f,this.limitVelocity3=this.limitVelocity3*e*f):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*b;this.d01=
(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;this.limitImpulse1*=0.95;this.motorImpulse1*=0.95;this.limitImpulse2*=0.95;this.motorImpulse2*=0.95;this.limitImpulse3*=
0.95;this.motorImpulse3*=0.95;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;h=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+d*this.a1x2+h*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+h*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+h*this.a1z3;this.a2.x-=b*this.a2x1+d*this.a2x2+h*this.a2x3;this.a2.y-=b*this.a2y1+d*this.a2y2+h*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+h*this.a2z3},solve_:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=
this.a2.z-this.a1.z;this.limitVelocity3=30;var d=a*this.ax1+c*this.ay1+b*this.az1-this.limitVelocity1,e=a*this.ax2+c*this.ay2+b*this.az2-this.limitVelocity2,b=a*this.ax3+c*this.ay3+b*this.az3-this.limitVelocity3,a=d*this.d00+e*this.d01+b*this.d02,c=d*this.d10+e*this.d11+b*this.d12,d=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=a;this.limitImpulse2+=c;this.limitImpulse3+=d;this.a1.x+=a*this.a1x1+c*this.a1x2+d*this.a1x3;this.a1.y+=a*this.a1y1+c*this.a1y2+d*this.a1y3;this.a1.z+=a*this.a1z1+c*
this.a1z2+d*this.a1z3;this.a2.x-=a*this.a2x1+c*this.a2x2+d*this.a2x3;this.a2.y-=a*this.a2y1+c*this.a2y2+d*this.a2y3;this.a2.z-=a*this.a2z1+c*this.a2z2+d*this.a2z3},solve:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=this.a2.z-this.a1.z,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,f=this.motorImpulse1,h=this.motorImpulse2,g=this.motorImpulse3,l=0,a=c=0;this.enableMotor1&&(l=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=
l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-h);this.enableMotor3&&(a=(b-this.motorSpeed3)*
this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-g);var d=d+(l*this.kv00+c*this.k01+a*this.k02),e=e+(l*this.k10+c*this.kv11+a*this.k12),b=b+(l*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*
this.cfm3),g=this.limitImpulse1,k=this.limitImpulse2,p=this.limitImpulse3,q=d*this.d00+e*this.d01+b*this.d02,h=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=q;this.limitImpulse2+=h;this.limitImpulse3+=f;var n=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)q=-g,e+=q*this.k10,b+=q*this.k20,n|=1;if(2==this.limitState2||0>this.limitImpulse2*this.limitState2)h=-k,d+=h*this.k01,b+=h*this.k21,n|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=
-p,d+=f*this.k02,e+=f*this.k12,n|=4;switch(n){case 1:n=1/(this.k11*this.k22-this.k12*this.k21);h=(this.k22*e+-this.k12*b)*n;f=(-this.k21*e+this.k11*b)*n;break;case 2:n=1/(this.k00*this.k22-this.k02*this.k20);q=(this.k22*d+-this.k02*b)*n;f=(-this.k20*d+this.k00*b)*n;break;case 3:f=b/this.k22;break;case 4:n=1/(this.k00*this.k11-this.k01*this.k10);q=(this.k11*d+-this.k01*e)*n;h=(-this.k10*d+this.k00*e)*n;break;case 5:h=e/this.k11;break;case 6:q=d/this.k00}this.limitImpulse1=q+g;this.limitImpulse2=h+
k;this.limitImpulse3=f+p;d=l+q;e=c+h;a+=f;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.RotationalConstraint=function(a,c){this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm=NaN;this.enableLimit=!1;this.limitVelocity=this.upperLimit=this.lowerLimit=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=
this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=
b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.limitMotor.frequency,d=0<b,e=this.limitMotor.angle;this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=
-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.02<this.limitVelocity?this.limitVelocity-0.02:-0.02>this.limitVelocity?this.limitVelocity+0.02:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=
0;this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02;this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12;this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22;this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02;this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12;this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22;this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z);this.invMotorDenom=
1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);this.limitImpulse*=0.95;this.motorImpulse*=0.95;b=this.limitImpulse+this.motorImpulse;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=
this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z),c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,
this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Translational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.l2z3=this.l2y3=this.l2x3=this.l1z3=this.l1y3=this.l1x3=this.t2z3=this.t2y3=this.t2x3=this.t1z3=this.t1y3=this.t1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.l2z2=this.l2y2=this.l2x2=this.l1z2=this.l1y2=this.l1x2=this.t2z2=this.t2y2=this.t2x2=this.t1z2=this.t1y2=this.t1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=
this.a1y1=this.a1x1=this.l2z1=this.l2y1=this.l2x1=this.l1z1=this.l1y1=this.l1x1=this.t2z1=this.t2y1=this.t2x1=this.t1z1=this.t1y1=this.t1x1=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.limitState1=
0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=
this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;
this.cfm3=this.cfm2=this.cfm1=this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=this.motorImpulse1=this.limitImpulse1=0;this.weight=-1};
OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p2.x-this.p1.x,d=this.p2.y-this.p1.y,e=this.p2.z-this.p1.z,f=b*this.ax1+
d*this.ay1+e*this.az1,h=b*this.ax2+d*this.ay2+e*this.az2,g=b*this.ax3+d*this.ay3+e*this.az3,l=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,k=0<l,e=0<b,p=0<d,q=this.lowerLimit1<=this.upperLimit1,n=this.lowerLimit2<=this.upperLimit2,w=this.lowerLimit3<=this.upperLimit3;if(k&&20<f||-20>f)k=!1;if(e&&20<h||-20>h)e=!1;if(p&&20<g||-20>g)p=!1;q?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-
f,k||(f=this.lowerLimit1)):f<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-f,k||(f=this.lowerLimit1)):f>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-f,k||(f=this.upperLimit1)):(this.limitState1=2,this.limitVelocity1=this.limitImpulse1=0),k||(this.limitVelocity1=0.005<this.limitVelocity1?this.limitVelocity1-0.005:-0.005>this.limitVelocity1?this.limitVelocity1+
0.005:0)):(this.limitState1=2,this.limitImpulse1=0);n?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-h,e||(h=this.lowerLimit2)):h<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-h,e||(h=this.lowerLimit2)):h>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-h,e||(h=this.upperLimit2)):
(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),e||(this.limitVelocity2=0.005<this.limitVelocity2?this.limitVelocity2-0.005:-0.005>this.limitVelocity2?this.limitVelocity2+0.005:0)):(this.limitState2=2,this.limitImpulse2=0);w?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=this.lowerLimit3-g,p||(g=this.lowerLimit3)):g<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=
this.lowerLimit3-g,p||(g=this.lowerLimit3)):g>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-g,p||(g=this.upperLimit3)):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),p||(this.limitVelocity3=0.005<this.limitVelocity3?this.limitVelocity3-0.005:-0.005>this.limitVelocity3?this.limitVelocity3+0.005:0)):(this.limitState3=2,this.limitImpulse3=0);this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||k)?this.maxMotorForce1*
a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||e)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||p)?this.maxMotorForce3*a:this.motorImpulse3=0;q=f*this.ax1+h*this.ax2+g*this.ax2;n=f*this.ay1+h*this.ay2+g*this.ay2;f=f*this.az1+h*this.az2+g*this.az2;h=this.m2/(this.m1+this.m2);0<=this.weight&&(h=this.weight);g=1-h;this.r1x=this.r1.x+q*h;this.r1y=this.r1.y+n*h;this.r1z=this.r1.z+f*h;this.r2x=this.r2.x-q*
g;this.r2y=this.r2.y-n*g;this.r2z=this.r2.z-f*g;this.t1x1=this.r1y*this.az1-this.r1z*this.ay1;this.t1y1=this.r1z*this.ax1-this.r1x*this.az1;this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1;this.t2x1=this.r2y*this.az1-this.r2z*this.ay1;this.t2y1=this.r2z*this.ax1-this.r2x*this.az1;this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1;this.l1x1=this.ax1*this.m1;this.l1y1=this.ay1*this.m1;this.l1z1=this.az1*this.m1;this.l2x1=this.ax1*this.m2;this.l2y1=this.ay1*this.m2;this.l2z1=this.az1*this.m2;this.a1x1=this.t1x1*
this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02;this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12;this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22;this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02;this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12;this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22;this.t1x2=this.r1y*this.az2-this.r1z*this.ay2;this.t1y2=this.r1z*this.ax2-this.r1x*
this.az2;this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2;this.t2x2=this.r2y*this.az2-this.r2z*this.ay2;this.t2y2=this.r2z*this.ax2-this.r2x*this.az2;this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2;this.l1x2=this.ax2*this.m1;this.l1y2=this.ay2*this.m1;this.l1z2=this.az2*this.m1;this.l2x2=this.ax2*this.m2;this.l2y2=this.ay2*this.m2;this.l2z2=this.az2*this.m2;this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02;this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12;
this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22;this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02;this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12;this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22;this.t1x3=this.r1y*this.az3-this.r1z*this.ay3;this.t1y3=this.r1z*this.ax3-this.r1x*this.az3;this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3;this.t2x3=this.r2y*this.az3-this.r2z*this.ay3;this.t2y3=this.r2z*this.ax3-
this.r2x*this.az3;this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3;this.l1x3=this.ax3*this.m1;this.l1y3=this.ay3*this.m1;this.l1z3=this.az3*this.m1;this.l2x3=this.ax3*this.m2;this.l2y3=this.ay3*this.m2;this.l2z3=this.az3*this.m2;this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02;this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12;this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22;this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*
this.i2e02;this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12;this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;f=this.m1+this.m2;this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*f;this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*f;this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*f;this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*f;this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*
f;this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*f;this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*f;this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*f;this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*f;this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1;this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2;this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3;this.k10+=this.t1x2*this.a1x1+
this.t1y2*this.a1y1+this.t1z2*this.a1z1;this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2;this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3;this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1;this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2;this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3;this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1;this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+
this.t2z1*this.a2z2;this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3;this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1;this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2;this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3;this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1;this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2;this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3;
this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;k&&2!=this.limitState1?(k=6.2831853*l,l=k*k*a,k=c/(l+2*this.limitMotor1.dampingRatio*k),this.cfm1=this.kv00*k,this.limitVelocity1=this.limitVelocity1*l*k):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);e&&2!=this.limitState2?(k=6.2831853*b,l=k*k*a,k=c/(l+2*this.limitMotor2.dampingRatio*k),this.cfm2=this.kv11*k,this.limitVelocity2=this.limitVelocity2*l*k):(this.cfm2=
0,this.limitVelocity2=0.05*this.limitVelocity2*c);p&&2!=this.limitState3?(k=6.2831853*d,l=k*k*a,k=c/(l+2*this.limitMotor3.dampingRatio*k),this.cfm3=this.kv22*k,this.limitVelocity3=this.limitVelocity3*l*k):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-
this.k12*this.k21)*b;this.d01=(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;e=this.limitImpulse3+
this.motorImpulse3;this.l1.x+=b*this.l1x1+d*this.l1x2+e*this.l1x3;this.l1.y+=b*this.l1y1+d*this.l1y2+e*this.l1y3;this.l1.z+=b*this.l1z1+d*this.l1z2+e*this.l1z3;this.a1.x+=b*this.a1x1+d*this.a1x2+e*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+e*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+e*this.a1z3;this.l2.x-=b*this.l2x1+d*this.l2x2+e*this.l2x3;this.l2.y-=b*this.l2y1+d*this.l2y2+e*this.l2y3;this.l2.z-=b*this.l2z1+d*this.l2z2+e*this.l2z3;this.a2.x-=b*this.a2x1+d*this.a2x2+e*this.a2x3;this.a2.y-=b*
this.a2y1+d*this.a2y2+e*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+e*this.a2z3},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,
f=this.motorImpulse1,h=this.motorImpulse2,g=this.motorImpulse3,l=0,a=c=0;this.enableMotor1&&(l=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<
-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-h);this.enableMotor3&&(a=(b-this.motorSpeed3)*this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-g);var d=d+(l*this.kv00+c*this.k01+a*this.k02),e=e+(l*this.k10+c*this.kv11+a*this.k12),b=b+(l*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+
this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*this.cfm3),g=this.limitImpulse1,k=this.limitImpulse2,p=this.limitImpulse3,q=d*this.d00+e*this.d01+b*this.d02,h=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=q;this.limitImpulse2+=h;this.limitImpulse3+=f;var n=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)q=-g,e+=q*this.k10,b+=q*this.k20,n|=1;if(2==this.limitState2||
0>this.limitImpulse2*this.limitState2)h=-k,d+=h*this.k01,b+=h*this.k21,n|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=-p,d+=f*this.k02,e+=f*this.k12,n|=4;switch(n){case 1:n=1/(this.k11*this.k22-this.k12*this.k21);h=(this.k22*e+-this.k12*b)*n;f=(-this.k21*e+this.k11*b)*n;break;case 2:n=1/(this.k00*this.k22-this.k02*this.k20);q=(this.k22*d+-this.k02*b)*n;f=(-this.k20*d+this.k00*b)*n;break;case 3:f=b/this.k22;break;case 4:n=1/(this.k00*this.k11-this.k01*this.k10);q=(this.k11*d+
-this.k01*e)*n;h=(-this.k10*d+this.k00*e)*n;break;case 5:h=e/this.k11;break;case 6:q=d/this.k00}this.limitImpulse1=g+q;this.limitImpulse2=k+h;this.limitImpulse3=p+f;d=l+q;e=c+h;a+=f;this.l1.x+=d*this.l1x1+e*this.l1x2+a*this.l1x3;this.l1.y+=d*this.l1y1+e*this.l1y2+a*this.l1y3;this.l1.z+=d*this.l1z1+e*this.l1z2+a*this.l1z3;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.l2.x-=d*this.l2x1+e*this.l2x2+a*
this.l2x3;this.l2.y-=d*this.l2y1+e*this.l2y2+a*this.l2y3;this.l2.z-=d*this.l2z1+e*this.l2z2+a*this.l2z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.TranslationalConstraint=function(a,c){this.limitVelocity=this.upperLimit=this.lowerLimit=this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.l2z=this.l2y=this.l2x=this.l1z=this.l1y=this.l1x=this.t2z=this.t2y=this.t2x=this.t1z=this.t1y=this.t1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=this.cfm=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;
this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;
this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=(this.p2.x-this.p1.x)*this.ax+(this.p2.y-this.p1.y)*this.ay+(this.p2.z-this.p1.z)*this.az,b=this.limitMotor.frequency,d=0<b,f=this.lowerLimit<=this.upperLimit;if(d&&20<e||-20>e)d=!1;f?(this.lowerLimit==this.upperLimit?
(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e,d||(e=this.upperLimit)):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.005<this.limitVelocity?
this.limitVelocity-0.005:-0.005>this.limitVelocity?this.limitVelocity+0.005:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=0;var f=e*this.ax,h=e*this.ay,e=e*this.az,g=this.m1/(this.m1+this.m2),l=1-g;this.r1x=this.r1.x+f*g;this.r1y=this.r1.y+h*g;this.r1z=this.r1.z+e*g;this.r2x=this.r2.x-f*l;this.r2y=this.r2.y-h*l;this.r2z=this.r2.z-e*l;this.t1x=this.r1y*this.az-this.r1z*this.ay;this.t1y=this.r1z*this.ax-
this.r1x*this.az;this.t1z=this.r1x*this.ay-this.r1y*this.ax;this.t2x=this.r2y*this.az-this.r2z*this.ay;this.t2y=this.r2z*this.ax-this.r2x*this.az;this.t2z=this.r2x*this.ay-this.r2y*this.ax;this.l1x=this.ax*this.m1;this.l1y=this.ay*this.m1;this.l1z=this.az*this.m1;this.l2x=this.ax*this.m2;this.l2y=this.ay*this.m2;this.l2z=this.az*this.m2;this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02;this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12;this.a1z=this.t1x*this.i1e20+
this.t1y*this.i1e21+this.t1z*this.i1e22;this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02;this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12;this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22;this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-
this.a2y*this.r2x);this.invMotorDenom=1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);b=this.limitImpulse+this.motorImpulse;this.l1.x+=b*this.l1x;this.l1.y+=b*this.l1y;this.l1.z+=b*this.l1z;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.l2.x-=b*this.l2x;
this.l2.y-=b*this.l2y;this.l2.z-=b*this.l2z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z,c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=
this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.l1.x+=c*this.l1x;this.l1.y+=c*this.l1y;this.l1.z+=c*this.l1z;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;
this.l2.x-=c*this.l2x;this.l2.y-=c*this.l2y;this.l2.z-=c*this.l2z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Contact=function(){this.next=this.prev=this.body2=this.body1=this.shape2=this.shape1=null;this.sleeping=this.persisting=!1;this.constraint=this.detector=null;this.touching=!1;this.b1Link=new OIMO.ContactLink(this);this.b2Link=new OIMO.ContactLink(this);this.s1Link=new OIMO.ContactLink(this);this.s2Link=new OIMO.ContactLink(this);this.manifold=new OIMO.ContactManifold;this.buffer=[];this.buffer.length=4;this.buffer[0]=new OIMO.ImpulseDataBuffer;this.buffer[1]=new OIMO.ImpulseDataBuffer;this.buffer[2]=
new OIMO.ImpulseDataBuffer;this.buffer[3]=new OIMO.ImpulseDataBuffer;this.points=this.manifold.points;this.constraint=new OIMO.ContactConstraint(this.manifold)};
OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(a,c){return Math.sqrt(a*c)},mixFriction:function(a,c){return Math.sqrt(a*c)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution);this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var a=this.manifold.numPoints,c=0;c<a;c++){var b=this.buffer[c],d=this.points[c];b.lp1X=d.localPoint1.x;b.lp1Y=d.localPoint1.y;b.lp1Z=d.localPoint1.z;
b.lp2X=d.localPoint2.x;b.lp2Y=d.localPoint2.y;b.lp2Z=d.localPoint2.z;b.impulse=d.normalImpulse}this.manifold.numPoints=0;this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)this.touching=!1;else for(this.touching=!0,c=0;c<e;c++){for(var d=this.points[c],f=d.localPoint1.x,h=d.localPoint1.y,g=d.localPoint1.z,l=d.localPoint2.x,k=d.localPoint2.y,p=d.localPoint2.z,q=-1,n=4E-4,w=0;w<a;w++){var b=this.buffer[w],u=b.lp1X-f,y=b.lp1Y-h,r=b.lp1Z-g,z=u*u+
y*y+r*r,u=b.lp2X-l,y=b.lp2Y-k,r=b.lp2Z-p,b=u*u+y*y+r*r;z<b?z<n&&(n=z,q=w):b<n&&(n=b,q=w)}-1!=q?(f=this.buffer[q],this.buffer[q]=this.buffer[--a],this.buffer[a]=f,d.normalImpulse=f.impulse,d.warmStarted=!0):(d.normalImpulse=0,d.warmStarted=!1)}},attach:function(a,c){this.shape1=a;this.shape2=c;this.body1=a.parent;this.body2=c.parent;this.manifold.body1=this.body1;this.manifold.body2=this.body2;this.constraint.body1=this.body1;this.constraint.body2=this.body2;this.constraint.attach();this.s1Link.shape=
c;this.s1Link.body=this.body2;this.s2Link.shape=a;this.s2Link.body=this.body1;null!=a.contactLink?(this.s1Link.next=a.contactLink).prev=this.s1Link:this.s1Link.next=null;a.contactLink=this.s1Link;a.numContacts++;null!=c.contactLink?(this.s2Link.next=c.contactLink).prev=this.s2Link:this.s2Link.next=null;c.contactLink=this.s2Link;c.numContacts++;this.b1Link.shape=c;this.b1Link.body=this.body2;this.b2Link.shape=a;this.b2Link.body=this.body1;null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=
this.b1Link:this.b1Link.next=null;this.body1.contactLink=this.b1Link;this.body1.numContacts++;null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null;this.body2.contactLink=this.b2Link;this.body2.numContacts++;this.next=this.prev=null;this.persisting=!0;this.sleeping=this.body1.sleeping&&this.body2.sleeping;this.manifold.numPoints=0},detach:function(){var a=this.s1Link.prev,c=this.s1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.shape1.contactLink==
this.s1Link&&(this.shape1.contactLink=c);this.s1Link.prev=null;this.s1Link.next=null;this.s1Link.shape=null;this.s1Link.body=null;this.shape1.numContacts--;a=this.s2Link.prev;c=this.s2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=c);this.s2Link.prev=null;this.s2Link.next=null;this.s2Link.shape=null;this.s2Link.body=null;this.shape2.numContacts--;a=this.b1Link.prev;c=this.b1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body1.contactLink==
this.b1Link&&(this.body1.contactLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.shape=null;this.b1Link.body=null;this.body1.numContacts--;a=this.b2Link.prev;c=this.b2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body2.contactLink==this.b2Link&&(this.body2.contactLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.shape=null;this.b2Link.body=null;this.body2.numContacts--;this.manifold.body1=null;this.manifold.body2=null;this.constraint.body1=null;this.constraint.body2=
null;this.constraint.detach();this.body2=this.body1=this.shape2=this.shape1=null}};OIMO.ContactConstraint=function(a){OIMO.Constraint.call(this);this.friction=this.restitution=NaN;this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null;this.m2=this.m1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=NaN;this.num=0;this.manifold=a;this.ps=a.points;this.cs=new OIMO.ContactPointDataBuffer;this.cs.next=new OIMO.ContactPointDataBuffer;
this.cs.next.next=new OIMO.ContactPointDataBuffer;this.cs.next.next.next=new OIMO.ContactPointDataBuffer};OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position;this.p2=this.body2.position;this.lv1=this.body1.linearVelocity;this.av1=this.body1.angularVelocity;this.lv2=this.body2.linearVelocity;this.av2=this.body2.angularVelocity;this.i1=this.body1.inverseInertia;this.i2=this.body2.inverseInertia};
OIMO.ContactConstraint.prototype.detach=function(){this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null};
OIMO.ContactConstraint.prototype.preSolve=function(a,c){this.m1=this.body1.inverseMass;this.m2=this.body2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p1.x,d=this.p1.y,e=this.p1.z,f=this.p2.x,h=
this.p2.y,g=this.p2.z,l=this.m1+this.m2;this.num=this.manifold.numPoints;for(var k=this.cs,p=0;p<this.num;p++){var q=this.ps[p],n,w,u,y,r,z;n=q.position.x;w=q.position.y;u=q.position.z;var B=n-b,A=w-d,C=u-e,P=n-f,ca=w-h,da=u-g;k.rp1X=B;k.rp1Y=A;k.rp1Z=C;k.rp2X=P;k.rp2Y=ca;k.rp2Z=da;k.norImp=q.normalImpulse;k.tanImp=q.tangentImpulse;k.binImp=q.binormalImpulse;var ua=q.normal.x,Da=q.normal.y,Ja=q.normal.z,wa=this.lv2.x+this.av2.y*da-this.av2.z*ca-(this.lv1.x+this.av1.y*C-this.av1.z*A),rb=this.lv2.y+
this.av2.z*P-this.av2.x*da-(this.lv1.y+this.av1.z*B-this.av1.x*C),La=this.lv2.z+this.av2.x*ca-this.av2.y*P-(this.lv1.z+this.av1.x*A-this.av1.y*B),ea=ua*wa+Da*rb+Ja*La,wa=wa-ea*ua,Ha=rb-ea*Da,Ia=La-ea*Ja,La=wa*wa+Ha*Ha+Ia*Ia;0.04<La?La=1/Math.sqrt(La):(wa=Da*ua-Ja*Ja,Ha=-Ja*Da-ua*ua,Ia=ua*Ja+Da*Da,La=1/Math.sqrt(wa*wa+Ha*Ha+Ia*Ia));var wa=wa*La,Ha=Ha*La,Ia=Ia*La,bb=Da*Ia-Ja*Ha,cb=Ja*wa-ua*Ia,db=ua*Ha-Da*wa;k.norX=ua;k.norY=Da;k.norZ=Ja;k.tanX=wa;k.tanY=Ha;k.tanZ=Ia;k.binX=bb;k.binY=cb;k.binZ=db;k.norU1X=
ua*this.m1;k.norU1Y=Da*this.m1;k.norU1Z=Ja*this.m1;k.norU2X=ua*this.m2;k.norU2Y=Da*this.m2;k.norU2Z=Ja*this.m2;k.tanU1X=wa*this.m1;k.tanU1Y=Ha*this.m1;k.tanU1Z=Ia*this.m1;k.tanU2X=wa*this.m2;k.tanU2Y=Ha*this.m2;k.tanU2Z=Ia*this.m2;k.binU1X=bb*this.m1;k.binU1Y=cb*this.m1;k.binU1Z=db*this.m1;k.binU2X=bb*this.m2;k.binU2Y=cb*this.m2;k.binU2Z=db*this.m2;u=A*Ja-C*Da;y=C*ua-B*Ja;r=B*Da-A*ua;var eb=ca*Ja-da*Da,fb=da*ua-P*Ja,gb=P*Da-ca*ua,hb=A*Ia-C*Ha,Q=C*wa-B*Ia,R=B*Ha-A*wa,S=ca*Ia-da*Ha,T=da*wa-P*Ia,U=P*
Ha-ca*wa,V=A*db-C*cb,W=C*bb-B*db,X=B*cb-A*bb,Y=ca*db-da*cb,Z=da*bb-P*db,$=P*cb-ca*bb,La=u*this.i1e00+y*this.i1e01+r*this.i1e02,rb=u*this.i1e10+y*this.i1e11+r*this.i1e12,fa=u*this.i1e20+y*this.i1e21+r*this.i1e22,ga=eb*this.i2e00+fb*this.i2e01+gb*this.i2e02,ha=eb*this.i2e10+fb*this.i2e11+gb*this.i2e12,ia=eb*this.i2e20+fb*this.i2e21+gb*this.i2e22;n=hb*this.i1e00+Q*this.i1e01+R*this.i1e02;w=hb*this.i1e10+Q*this.i1e11+R*this.i1e12;z=hb*this.i1e20+Q*this.i1e21+R*this.i1e22;var oa=S*this.i2e00+T*this.i2e01+
U*this.i2e02,pa=S*this.i2e10+T*this.i2e11+U*this.i2e12,qa=S*this.i2e20+T*this.i2e21+U*this.i2e22,ib=V*this.i1e00+W*this.i1e01+X*this.i1e02,jb=V*this.i1e10+W*this.i1e11+X*this.i1e12,kb=V*this.i1e20+W*this.i1e21+X*this.i1e22,lb=Y*this.i2e00+Z*this.i2e01+$*this.i2e02,mb=Y*this.i2e10+Z*this.i2e11+$*this.i2e12,nb=Y*this.i2e20+Z*this.i2e21+$*this.i2e22;k.norT1X=u;k.norT1Y=y;k.norT1Z=r;k.tanT1X=hb;k.tanT1Y=Q;k.tanT1Z=R;k.binT1X=V;k.binT1Y=W;k.binT1Z=X;k.norT2X=eb;k.norT2Y=fb;k.norT2Z=gb;k.tanT2X=S;k.tanT2Y=
T;k.tanT2Z=U;k.binT2X=Y;k.binT2Y=Z;k.binT2Z=$;k.norTU1X=La;k.norTU1Y=rb;k.norTU1Z=fa;k.tanTU1X=n;k.tanTU1Y=w;k.tanTU1Z=z;k.binTU1X=ib;k.binTU1Y=jb;k.binTU1Z=kb;k.norTU2X=ga;k.norTU2Y=ha;k.norTU2Z=ia;k.tanTU2X=oa;k.tanTU2Y=pa;k.tanTU2Z=qa;k.binTU2X=lb;k.binTU2Y=mb;k.binTU2Z=nb;n=u*this.i1e00+y*this.i1e01+r*this.i1e02;w=u*this.i1e10+y*this.i1e11+r*this.i1e12;u=u*this.i1e20+y*this.i1e21+r*this.i1e22;y=w*C-u*A;r=u*B-n*C;z=n*A-w*B;n=eb*this.i2e00+fb*this.i2e01+gb*this.i2e02;w=eb*this.i2e10+fb*this.i2e11+
gb*this.i2e12;u=eb*this.i2e20+fb*this.i2e21+gb*this.i2e22;y+=w*da-u*ca;r+=u*P-n*da;z+=n*ca-w*P;ua=1/(l+ua*y+Da*r+Ja*z);n=hb*this.i1e00+Q*this.i1e01+R*this.i1e02;w=hb*this.i1e10+Q*this.i1e11+R*this.i1e12;u=hb*this.i1e20+Q*this.i1e21+R*this.i1e22;y=w*C-u*A;r=u*B-n*C;z=n*A-w*B;n=S*this.i2e00+T*this.i2e01+U*this.i2e02;w=S*this.i2e10+T*this.i2e11+U*this.i2e12;u=S*this.i2e20+T*this.i2e21+U*this.i2e22;y+=w*da-u*ca;r+=u*P-n*da;z+=n*ca-w*P;Da=1/(l+wa*y+Ha*r+Ia*z);n=V*this.i1e00+W*this.i1e01+X*this.i1e02;w=
V*this.i1e10+W*this.i1e11+X*this.i1e12;u=V*this.i1e20+W*this.i1e21+X*this.i1e22;y=w*C-u*A;r=u*B-n*C;z=n*A-w*B;n=Y*this.i2e00+Z*this.i2e01+$*this.i2e02;w=Y*this.i2e10+Z*this.i2e11+$*this.i2e12;u=Y*this.i2e20+Z*this.i2e21+$*this.i2e22;y+=w*da-u*ca;r+=u*P-n*da;z+=n*ca-w*P;B=1/(l+bb*y+cb*r+db*z);k.norDen=ua;k.tanDen=Da;k.binDen=B;q.warmStarted?(ea=q.normalImpulse,this.lv1.x+=k.norU1X*ea,this.lv1.y+=k.norU1Y*ea,this.lv1.z+=k.norU1Z*ea,this.av1.x+=La*ea,this.av1.y+=rb*ea,this.av1.z+=fa*ea,this.lv2.x-=k.norU2X*
ea,this.lv2.y-=k.norU2Y*ea,this.lv2.z-=k.norU2Z*ea,this.av2.x-=ga*ea,this.av2.y-=ha*ea,this.av2.z-=ia*ea,k.norImp=ea,k.tanImp=0,ea=k.binImp=0):(k.norImp=0,k.tanImp=0,k.binImp=0);-1<ea&&(ea=0);ea=this.restitution*-ea;q=-(q.penetration+0.005)*c*0.05;ea<q&&(ea=q);k.norTar=ea;k.last=p==this.num-1;k=k.next}};
OIMO.ContactConstraint.prototype.solve=function(){for(var a=this.lv1.x,c=this.lv1.y,b=this.lv1.z,d=this.lv2.x,e=this.lv2.y,f=this.lv2.z,h=this.av1.x,g=this.av1.y,l=this.av1.z,k=this.av2.x,p=this.av2.y,q=this.av2.z,n=this.cs;;){var w,u,y,r,z=n.norImp,B=n.tanImp,A=n.binImp,C=-z*this.friction;y=d-a;r=e-c;var P=f-b;u=y*n.tanX+r*n.tanY+P*n.tanZ+k*n.tanT2X+p*n.tanT2Y+q*n.tanT2Z-h*n.tanT1X-g*n.tanT1Y-l*n.tanT1Z;w=B;u*=n.tanDen;B+=u;u=y*n.binX+r*n.binY+P*n.binZ+k*n.binT2X+p*n.binT2Y+q*n.binT2Z-h*n.binT1X-
g*n.binT1Y-l*n.binT1Z;y=A;r=u*n.binDen;A+=r;u=B*B+A*A;u>C*C&&(u=C/Math.sqrt(u),B*=u,A*=u);u=B-w;r=A-y;a+=n.tanU1X*u+n.binU1X*r;c+=n.tanU1Y*u+n.binU1Y*r;b+=n.tanU1Z*u+n.binU1Z*r;h+=n.tanTU1X*u+n.binTU1X*r;g+=n.tanTU1Y*u+n.binTU1Y*r;l+=n.tanTU1Z*u+n.binTU1Z*r;d-=n.tanU2X*u+n.binU2X*r;e-=n.tanU2Y*u+n.binU2Y*r;f-=n.tanU2Z*u+n.binU2Z*r;k-=n.tanTU2X*u+n.binTU2X*r;p-=n.tanTU2Y*u+n.binTU2Y*r;q-=n.tanTU2Z*u+n.binTU2Z*r;u=(d-a)*n.norX+(e-c)*n.norY+(f-b)*n.norZ+k*n.norT2X+p*n.norT2Y+q*n.norT2Z-h*n.norT1X-g*
n.norT1Y-l*n.norT1Z;w=z;u=(u-n.norTar)*n.norDen;z+=u;0<z&&(z=0);u=z-w;a+=n.norU1X*u;c+=n.norU1Y*u;b+=n.norU1Z*u;h+=n.norTU1X*u;g+=n.norTU1Y*u;l+=n.norTU1Z*u;d-=n.norU2X*u;e-=n.norU2Y*u;f-=n.norU2Z*u;k-=n.norTU2X*u;p-=n.norTU2Y*u;q-=n.norTU2Z*u;n.norImp=z;n.tanImp=B;n.binImp=A;if(n.last)break;n=n.next}this.lv1.x=a;this.lv1.y=c;this.lv1.z=b;this.lv2.x=d;this.lv2.y=e;this.lv2.z=f;this.av1.x=h;this.av1.y=g;this.av1.z=l;this.av2.x=k;this.av2.y=p;this.av2.z=q};
OIMO.ContactConstraint.prototype.postSolve=function(){for(var a=this.cs,c=0;c<this.num;c++){var b=this.ps[c];b.normal.x=a.norX;b.normal.y=a.norY;b.normal.z=a.norZ;b.tangent.x=a.tanX;b.tangent.y=a.tanY;b.tangent.z=a.tanZ;b.binormal.x=a.binX;b.binormal.y=a.binY;b.binormal.z=a.binZ;b.normalImpulse=a.norImp;b.tangentImpulse=a.tanImp;b.binormalImpulse=a.binImp;b.normalDenominator=a.norDen;b.tangentDenominator=a.tanDen;b.binormalDenominator=a.binDen;a=a.next}};OIMO.ContactLink=function(a){this.body=this.shape=this.next=this.prev=null;this.contact=a};OIMO.ContactManifold=function(){this.body2=this.body1=null;this.numPoints=0;this.points=[];this.points.length=4;this.points[0]=new OIMO.ManifoldPoint;this.points[1]=new OIMO.ManifoldPoint;this.points[2]=new OIMO.ManifoldPoint;this.points[3]=new OIMO.ManifoldPoint};
OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(a,c){this.body1=a.parent;this.body2=c.parent;this.numPoints=0},addPoint:function(a,c,b,d,e,f,h,g){var l=this.points[this.numPoints++];l.position.x=a;l.position.y=c;l.position.z=b;var k=a-this.body1.position.x,p=c-this.body1.position.y,q=b-this.body1.position.z,n=this.body1.rotation.elements;l.localPoint1.x=k*n[0]+p*n[3]+q*n[6];l.localPoint1.y=k*n[1]+p*n[4]+q*n[7];l.localPoint1.z=k*n[2]+p*n[5]+q*n[8];k=a-this.body2.position.x;
p=c-this.body2.position.y;q=b-this.body2.position.z;l.localPoint2.x=k*n[0]+p*n[3]+q*n[6];l.localPoint2.y=k*n[1]+p*n[4]+q*n[7];l.localPoint2.z=k*n[2]+p*n[5]+q*n[8];l.normalImpulse=0;g?(l.normal.x=-d,l.normal.y=-e,l.normal.z=-f):(l.normal.x=d,l.normal.y=e,l.normal.z=f);l.penetration=h;l.warmStarted=!1}};OIMO.ContactPointDataBuffer=function(){this.norTar=this.binDen=this.tanDen=this.norDen=this.binImp=this.tanImp=this.norImp=this.binTU2Z=this.binTU2Y=this.binTU2X=this.binTU1Z=this.binTU1Y=this.binTU1X=this.tanTU2Z=this.tanTU2Y=this.tanTU2X=this.tanTU1Z=this.tanTU1Y=this.tanTU1X=this.norTU2Z=this.norTU2Y=this.norTU2X=this.norTU1Z=this.norTU1Y=this.norTU1X=this.binT2Z=this.binT2Y=this.binT2X=this.binT1Z=this.binT1Y=this.binT1X=this.tanT2Z=this.tanT2Y=this.tanT2X=this.tanT1Z=this.tanT1Y=this.tanT1X=
this.norT2Z=this.norT2Y=this.norT2X=this.norT1Z=this.norT1Y=this.norT1X=this.binU2Z=this.binU2Y=this.binU2X=this.binU1Z=this.binU1Y=this.binU1X=this.tanU2Z=this.tanU2Y=this.tanU2X=this.tanU1Z=this.tanU1Y=this.tanU1X=this.norU2Z=this.norU2Y=this.norU2X=this.norU1Z=this.norU1Y=this.norU1X=this.rp2Z=this.rp2Y=this.rp2X=this.rp1Z=this.rp1Y=this.rp1X=this.binZ=this.binY=this.binX=this.tanZ=this.tanY=this.tanX=this.norZ=this.norY=this.norX=NaN;this.next=null;this.last=!1};OIMO.ImpulseDataBuffer=function(){this.impulse=this.lp2Z=this.lp2Y=this.lp2X=this.lp1Z=this.lp1Y=this.lp1X=NaN};OIMO.ManifoldPoint=function(){this.warmStarted=!1;this.position=new OIMO.Vec3;this.localPoint1=new OIMO.Vec3;this.localPoint2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.penetration=this.binormalDenominator=this.tangentDenominator=this.normalDenominator=this.binormalImpulse=this.tangentImpulse=this.normalImpulse=0};OIMO.MassInfo=function(){this.mass=0;this.inertia=new OIMO.Mat33};OIMO.Shape=function(a){this.next=this.prev=null;this.type=0;this.contactLink=this.parent=this.proxy=null;this.numContacts=0;this.id=OIMO.nextID++;this.position=new OIMO.Vec3;this.relativePosition=(new OIMO.Vec3).copy(a.relativePosition);this.rotation=new OIMO.Mat33;this.relativeRotation=(new OIMO.Mat33).copy(a.relativeRotation);this.aabb=new OIMO.AABB;this.density=a.density;this.friction=a.friction;this.restitution=a.restitution;this.belongsTo=a.belongsTo;this.collidesWith=a.collidesWith};
OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(a){throw Error("Inheritance error.");},updateProxy:function(){throw Error("Inheritance error.");}};OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3;this.relativeRotation=new OIMO.Mat33;this.friction=0.4;this.restitution=0.2;this.belongsTo=this.density=1;this.collidesWith=4294967295};OIMO.BoxShape=function(a,c,b,d){OIMO.Shape.call(this,a);this.width=c;this.halfWidth=0.5*c;this.height=b;this.halfHeight=0.5*b;this.depth=d;this.halfDepth=0.5*d;this.normalDirectionWidth=new OIMO.Vec3;this.normalDirectionHeight=new OIMO.Vec3;this.normalDirectionDepth=new OIMO.Vec3;this.halfDirectionWidth=new OIMO.Vec3;this.halfDirectionHeight=new OIMO.Vec3;this.halfDirectionDepth=new OIMO.Vec3;this.vertex1=new OIMO.Vec3;this.vertex2=new OIMO.Vec3;this.vertex3=new OIMO.Vec3;this.vertex4=new OIMO.Vec3;
this.vertex5=new OIMO.Vec3;this.vertex6=new OIMO.Vec3;this.vertex7=new OIMO.Vec3;this.vertex8=new OIMO.Vec3;this.type=OIMO.SHAPE_BOX};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.BoxShape.prototype.calculateMassInfo=function(a){var c=this.width*this.height*this.depth*this.density;a.mass=c;a.inertia.init(c*(this.height*this.height+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.depth*this.depth)/12,0,0,0,c*(this.width*this.width+this.height*this.height)/12)};
OIMO.BoxShape.prototype.updateProxy=function(){var a=this.rotation.elements;this.normalDirectionWidth.x=a[0];this.normalDirectionWidth.y=a[3];this.normalDirectionWidth.z=a[6];this.normalDirectionHeight.x=a[1];this.normalDirectionHeight.y=a[4];this.normalDirectionHeight.z=a[7];this.normalDirectionDepth.x=a[2];this.normalDirectionDepth.y=a[5];this.normalDirectionDepth.z=a[8];this.halfDirectionWidth.x=a[0]*this.halfWidth;this.halfDirectionWidth.y=a[3]*this.halfWidth;this.halfDirectionWidth.z=a[6]*this.halfWidth;
this.halfDirectionHeight.x=a[1]*this.halfHeight;this.halfDirectionHeight.y=a[4]*this.halfHeight;this.halfDirectionHeight.z=a[7]*this.halfHeight;this.halfDirectionDepth.x=a[2]*this.halfDepth;this.halfDirectionDepth.y=a[5]*this.halfDepth;this.halfDirectionDepth.z=a[8]*this.halfDepth;var a=this.halfDirectionWidth.x,c=this.halfDirectionWidth.y,b=this.halfDirectionWidth.z,d=this.halfDirectionHeight.x,e=this.halfDirectionHeight.y,f=this.halfDirectionHeight.z,h=this.halfDirectionDepth.x,g=this.halfDirectionDepth.y,
l=this.halfDirectionDepth.z,k=this.position.x,p=this.position.y,q=this.position.z;this.vertex1.x=k+a+d+h;this.vertex1.y=p+c+e+g;this.vertex1.z=q+b+f+l;this.vertex2.x=k+a+d-h;this.vertex2.y=p+c+e-g;this.vertex2.z=q+b+f-l;this.vertex3.x=k+a-d+h;this.vertex3.y=p+c-e+g;this.vertex3.z=q+b-f+l;this.vertex4.x=k+a-d-h;this.vertex4.y=p+c-e-g;this.vertex4.z=q+b-f-l;this.vertex5.x=k-a+d+h;this.vertex5.y=p-c+e+g;this.vertex5.z=q-b+f+l;this.vertex6.x=k-a+d-h;this.vertex6.y=p-c+e-g;this.vertex6.z=q-b+f-l;this.vertex7.x=
k-a-d+h;this.vertex7.y=p-c-e+g;this.vertex7.z=q-b-f+l;this.vertex8.x=k-a-d-h;this.vertex8.y=p-c-e-g;this.vertex8.z=q-b-f-l;a=0>this.halfDirectionWidth.x?-this.halfDirectionWidth.x:this.halfDirectionWidth.x;c=0>this.halfDirectionWidth.y?-this.halfDirectionWidth.y:this.halfDirectionWidth.y;b=0>this.halfDirectionWidth.z?-this.halfDirectionWidth.z:this.halfDirectionWidth.z;a=0>this.halfDirectionHeight.x?a-this.halfDirectionHeight.x:a+this.halfDirectionHeight.x;c=0>this.halfDirectionHeight.y?c-this.halfDirectionHeight.y:
c+this.halfDirectionHeight.y;b=0>this.halfDirectionHeight.z?b-this.halfDirectionHeight.z:b+this.halfDirectionHeight.z;a=0>this.halfDirectionDepth.x?a-this.halfDirectionDepth.x:a+this.halfDirectionDepth.x;c=0>this.halfDirectionDepth.y?c-this.halfDirectionDepth.y:c+this.halfDirectionDepth.y;b=0>this.halfDirectionDepth.z?b-this.halfDirectionDepth.z:b+this.halfDirectionDepth.z;this.aabb.init(this.position.x-a-0.005,this.position.x+a+0.005,this.position.y-c-0.005,this.position.y+c+0.005,this.position.z-
b-0.005,this.position.z+b+0.005);null!==this.proxy&&this.proxy.update()};OIMO.SphereShape=function(a,c){OIMO.Shape.call(this,a);this.radius=c;this.type=OIMO.SHAPE_SPHERE};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.calculateMassInfo=function(a){var c=4/3*Math.PI*this.radius*this.radius*this.radius*this.density;a.mass=c;c=c*this.radius*this.radius*2/5;a.inertia.init(c,0,0,0,c,0,0,0,c)};
OIMO.SphereShape.prototype.updateProxy=function(){this.aabb.init(this.position.x-this.radius-0.005,this.position.x+this.radius+0.005,this.position.y-this.radius-0.005,this.position.y+this.radius+0.005,this.position.z-this.radius-0.005,this.position.z+this.radius+0.005);null!==this.proxy&&this.proxy.update()};OIMO.CollisionDetector=function(){this.flip=!1};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(a,c,b){throw Error("Inheritance error.");}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=[];this.clipVertices2=[];this.clipVertices1.length=24;this.clipVertices2.length=24;this.used=[];this.used.length=8;this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);var f=d.position,h=e.position,g=f.x,l=f.y,k=f.z,p=h.x,q=h.y,n=h.z,w=p-g,u=q-l,y=n-k,r=d.halfWidth,z=d.halfHeight,B=d.halfDepth,A=e.halfWidth,C=e.halfHeight,P=e.halfDepth,ca=d.halfDirectionWidth.x,da=d.halfDirectionWidth.y,ua=d.halfDirectionWidth.z,Da=d.halfDirectionHeight.x,Ja=d.halfDirectionHeight.y,wa=d.halfDirectionHeight.z,rb=d.halfDirectionDepth.x,La=d.halfDirectionDepth.y,ea=d.halfDirectionDepth.z,
Ha=e.halfDirectionWidth.x,Ia=e.halfDirectionWidth.y,bb=e.halfDirectionWidth.z,cb=e.halfDirectionHeight.x,db=e.halfDirectionHeight.y,eb=e.halfDirectionHeight.z,fb=e.halfDirectionDepth.x,gb=e.halfDirectionDepth.y,hb=e.halfDirectionDepth.z,Q=d.normalDirectionWidth.x,R=d.normalDirectionWidth.y,S=d.normalDirectionWidth.z,T=d.normalDirectionHeight.x,U=d.normalDirectionHeight.y,V=d.normalDirectionHeight.z,W=d.normalDirectionDepth.x,X=d.normalDirectionDepth.y,Y=d.normalDirectionDepth.z,Z=e.normalDirectionWidth.x,
$=e.normalDirectionWidth.y,fa=e.normalDirectionWidth.z,ga=e.normalDirectionHeight.x,ha=e.normalDirectionHeight.y,ia=e.normalDirectionHeight.z,oa=e.normalDirectionDepth.x,pa=e.normalDirectionDepth.y,qa=e.normalDirectionDepth.z,ib=R*fa-S*$,jb=S*Z-Q*fa,kb=Q*$-R*Z,lb=R*ia-S*ha,mb=S*ga-Q*ia,nb=Q*ha-R*ga,sb=R*qa-S*pa,tb=S*oa-Q*qa,ub=Q*pa-R*oa,vb=U*fa-V*$,wb=V*Z-T*fa,xb=T*$-U*Z,yb=U*ia-V*ha,zb=V*ga-T*ia,Ab=T*ha-U*ga,Bb=U*qa-V*pa,Cb=V*oa-T*qa,Db=T*pa-U*oa,Eb=X*fa-Y*$,Fb=Y*Z-W*fa,Gb=W*$-X*Z,Hb=X*ia-Y*ha,Ib=
Y*ga-W*ia,Jb=W*ha-X*ga,Kb=X*qa-Y*pa,Lb=Y*oa-W*qa,Mb=W*pa-X*oa,yc,zc,Ac,Bc,Cc,Dc,nc,oc,pc,qc,rc,sc,tc,uc,vc,hc,ic,jc,kc,lc,mc,Wb,Xb,Yb,Zb,$b,ac,bc,cc,dc,Ec=!1,Fc=!1,Gc=!1,Hc=!1,Ic=!1,Jc=!1,Kc=!1,Lc=!1,Mc=!1,v,ja,ka,s,t,la;v=Q*w+R*u+S*y;(yc=0<v)||(v=-v);ja=r;s=Q*Z+R*$+S*fa;t=Q*ga+R*ha+S*ia;la=Q*oa+R*pa+S*qa;0>s&&(s=-s);0>t&&(t=-t);0>la&&(la=-la);ka=s*A+t*C+la*P;hc=v-ja-ka;if(!(0<hc||(v=T*w+U*u+V*y,(zc=0<v)||(v=-v),ja=z,s=T*Z+U*$+V*fa,t=T*ga+U*ha+V*ia,la=T*oa+U*pa+V*qa,0>s&&(s=-s),0>t&&(t=-t),0>la&&
(la=-la),ka=s*A+t*C+la*P,ic=v-ja-ka,0<ic||(v=W*w+X*u+Y*y,(Ac=0<v)||(v=-v),ja=B,s=W*Z+X*$+Y*fa,t=W*ga+X*ha+Y*ia,la=W*oa+X*pa+Y*qa,0>s&&(s=-s),0>t&&(t=-t),0>la&&(la=-la),ka=s*A+t*C+la*P,jc=v-ja-ka,0<jc||(v=Z*w+$*u+fa*y,(Bc=0<v)||(v=-v),s=Z*Q+$*R+fa*S,t=Z*T+$*U+fa*V,la=Z*W+$*X+fa*Y,0>s&&(s=-s),0>t&&(t=-t),0>la&&(la=-la),ja=s*r+t*z+la*B,ka=A,kc=1*(v-ja-ka),0<kc||(v=ga*w+ha*u+ia*y,(Cc=0<v)||(v=-v),s=ga*Q+ha*R+ia*S,t=ga*T+ha*U+ia*V,la=ga*W+ha*X+ia*Y,0>s&&(s=-s),0>t&&(t=-t),0>la&&(la=-la),ja=s*r+t*z+la*
B,ka=C,lc=1*(v-ja-ka),0<lc||(v=oa*w+pa*u+qa*y,(Dc=0<v)||(v=-v),s=oa*Q+pa*R+qa*S,t=oa*T+pa*U+qa*V,la=oa*W+pa*X+qa*Y,0>s&&(s=-s),0>t&&(t=-t),0>la&&(la=-la),ja=s*r+t*z+la*B,ka=P,mc=1*(v-ja-ka),0<mc))))))){v=ib*ib+jb*jb+kb*kb;if(1E-5<v){if(v=1/Math.sqrt(v),ib*=v,jb*=v,kb*=v,v=ib*w+jb*u+kb*y,(nc=0<v)||(v=-v),s=ib*T+jb*U+kb*V,t=ib*W+jb*X+kb*Y,0>s&&(s=-s),0>t&&(t=-t),ja=s*z+t*B,s=ib*ga+jb*ha+kb*ia,t=ib*oa+jb*pa+kb*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*C+t*P,Wb=v-ja-ka,0<Wb)return}else nc=!1,Wb=0,Ec=!0;v=lb*lb+
mb*mb+nb*nb;if(1E-5<v){if(v=1/Math.sqrt(v),lb*=v,mb*=v,nb*=v,v=lb*w+mb*u+nb*y,(oc=0<v)||(v=-v),s=lb*T+mb*U+nb*V,t=lb*W+mb*X+nb*Y,0>s&&(s=-s),0>t&&(t=-t),ja=s*z+t*B,s=lb*Z+mb*$+nb*fa,t=lb*oa+mb*pa+nb*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*A+t*P,Xb=v-ja-ka,0<Xb)return}else oc=!1,Xb=0,Fc=!0;v=sb*sb+tb*tb+ub*ub;if(1E-5<v){if(v=1/Math.sqrt(v),sb*=v,tb*=v,ub*=v,v=sb*w+tb*u+ub*y,(pc=0<v)||(v=-v),s=sb*T+tb*U+ub*V,t=sb*W+tb*X+ub*Y,0>s&&(s=-s),0>t&&(t=-t),ja=s*z+t*B,s=sb*Z+tb*$+ub*fa,t=sb*ga+tb*ha+ub*ia,0>s&&(s=-s),
0>t&&(t=-t),ka=s*A+t*C,Yb=v-ja-ka,0<Yb)return}else pc=!1,Yb=0,Gc=!0;v=vb*vb+wb*wb+xb*xb;if(1E-5<v){if(v=1/Math.sqrt(v),vb*=v,wb*=v,xb*=v,v=vb*w+wb*u+xb*y,(qc=0<v)||(v=-v),s=vb*Q+wb*R+xb*S,t=vb*W+wb*X+xb*Y,0>s&&(s=-s),0>t&&(t=-t),ja=s*r+t*B,s=vb*ga+wb*ha+xb*ia,t=vb*oa+wb*pa+xb*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*C+t*P,Zb=v-ja-ka,0<Zb)return}else qc=!1,Zb=0,Hc=!0;v=yb*yb+zb*zb+Ab*Ab;if(1E-5<v){if(v=1/Math.sqrt(v),yb*=v,zb*=v,Ab*=v,v=yb*w+zb*u+Ab*y,(rc=0<v)||(v=-v),s=yb*Q+zb*R+Ab*S,t=yb*W+zb*X+Ab*Y,0>s&&
(s=-s),0>t&&(t=-t),ja=s*r+t*B,s=yb*Z+zb*$+Ab*fa,t=yb*oa+zb*pa+Ab*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*A+t*P,$b=v-ja-ka,0<$b)return}else rc=!1,$b=0,Ic=!0;v=Bb*Bb+Cb*Cb+Db*Db;if(1E-5<v){if(v=1/Math.sqrt(v),Bb*=v,Cb*=v,Db*=v,v=Bb*w+Cb*u+Db*y,(sc=0<v)||(v=-v),s=Bb*Q+Cb*R+Db*S,t=Bb*W+Cb*X+Db*Y,0>s&&(s=-s),0>t&&(t=-t),ja=s*r+t*B,s=Bb*Z+Cb*$+Db*fa,t=Bb*ga+Cb*ha+Db*ia,0>s&&(s=-s),0>t&&(t=-t),ka=s*A+t*C,ac=v-ja-ka,0<ac)return}else sc=!1,ac=0,Jc=!0;v=Eb*Eb+Fb*Fb+Gb*Gb;if(1E-5<v){if(v=1/Math.sqrt(v),Eb*=v,Fb*=v,
Gb*=v,v=Eb*w+Fb*u+Gb*y,(tc=0<v)||(v=-v),s=Eb*Q+Fb*R+Gb*S,t=Eb*T+Fb*U+Gb*V,0>s&&(s=-s),0>t&&(t=-t),ja=s*r+t*z,s=Eb*ga+Fb*ha+Gb*ia,t=Eb*oa+Fb*pa+Gb*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*C+t*P,bc=v-ja-ka,0<bc)return}else tc=!1,bc=0,Kc=!0;v=Hb*Hb+Ib*Ib+Jb*Jb;if(1E-5<v){if(v=1/Math.sqrt(v),Hb*=v,Ib*=v,Jb*=v,v=Hb*w+Ib*u+Jb*y,(uc=0<v)||(v=-v),s=Hb*Q+Ib*R+Jb*S,t=Hb*T+Ib*U+Jb*V,0>s&&(s=-s),0>t&&(t=-t),ja=s*r+t*z,s=Hb*Z+Ib*$+Jb*fa,t=Hb*oa+Ib*pa+Jb*qa,0>s&&(s=-s),0>t&&(t=-t),ka=s*A+t*P,cc=v-ja-ka,0<cc)return}else uc=
!1,cc=0,Lc=!0;v=Kb*Kb+Lb*Lb+Mb*Mb;if(1E-5<v){if(v=1/Math.sqrt(v),Kb*=v,Lb*=v,Mb*=v,v=Kb*w+Lb*u+Mb*y,(vc=0<v)||(v=-v),s=Kb*Q+Lb*R+Mb*S,t=Kb*T+Lb*U+Mb*V,0>s&&(s=-s),0>t&&(t=-t),ja=s*r+t*z,s=Kb*Z+Lb*$+Mb*fa,t=Kb*ga+Lb*ha+Mb*ia,0>s&&(s=-s),0>t&&(t=-t),ka=s*A+t*C,dc=v-ja-ka,0<dc)return}else vc=!1,dc=0,Mc=!0;var Ma=hc,va=hc,Oa=0,Ka=yc;ic>va&&(va=Ma=ic,Oa=1,Ka=zc);jc>va&&(va=Ma=jc,Oa=2,Ka=Ac);kc>va&&(va=Ma=kc,Oa=3,Ka=Bc);lc>va&&(va=Ma=lc,Oa=4,Ka=Cc);mc>va&&(va=Ma=mc,Oa=5,Ka=Dc);Wb-0.01>va&&!Ec&&(Ma=Wb,va=
Wb-0.01,Oa=6,Ka=nc);Xb-0.01>va&&!Fc&&(Ma=Xb,va=Xb-0.01,Oa=7,Ka=oc);Yb-0.01>va&&!Gc&&(Ma=Yb,va=Yb-0.01,Oa=8,Ka=pc);Zb-0.01>va&&!Hc&&(Ma=Zb,va=Zb-0.01,Oa=9,Ka=qc);$b-0.01>va&&!Ic&&(Ma=$b,va=$b-0.01,Oa=10,Ka=rc);ac-0.01>va&&!Jc&&(Ma=ac,va=ac-0.01,Oa=11,Ka=sc);bc-0.01>va&&!Kc&&(Ma=bc,va=bc-0.01,Oa=12,Ka=tc);cc-0.01>va&&!Lc&&(Ma=cc,va=cc-0.01,Oa=13,Ka=uc);dc-0.01>va&&!Mc&&(Ma=dc,Oa=14,Ka=vc);var D=0,E=0,F=0,Aa=0,Ba=0,Ca=0,Ea=0,Fa=0,Ga=0,xa=0,ya=0,za=0,Nb=0,Ob=0,Pb=0,Qb=0,Rb=0,Sb=0,ec=!1;switch(Oa){case 0:Ka?
(xa=g+ca,ya=l+da,za=k+ua,D=Q,E=R,F=S):(xa=g-ca,ya=l-da,za=k-ua,D=-Q,E=-R,F=-S);Nb=Da;Ob=Ja;Pb=wa;Aa=-T;Ba=-U;Ca=-V;Qb=rb;Rb=La;Sb=ea;Ea=-W;Fa=-X;Ga=-Y;break;case 1:Ka?(xa=g+Da,ya=l+Ja,za=k+wa,D=T,E=U,F=V):(xa=g-Da,ya=l-Ja,za=k-wa,D=-T,E=-U,F=-V);Nb=ca;Ob=da;Pb=ua;Aa=-Q;Ba=-R;Ca=-S;Qb=rb;Rb=La;Sb=ea;Ea=-W;Fa=-X;Ga=-Y;break;case 2:Ka?(xa=g+rb,ya=l+La,za=k+ea,D=W,E=X,F=Y):(xa=g-rb,ya=l-La,za=k-ea,D=-W,E=-X,F=-Y);Nb=ca;Ob=da;Pb=ua;Aa=-Q;Ba=-R;Ca=-S;Qb=Da;Rb=Ja;Sb=wa;Ea=-T;Fa=-U;Ga=-V;break;case 3:ec=
!0;Ka?(xa=p-Ha,ya=q-Ia,za=n-bb,D=-Z,E=-$,F=-fa):(xa=p+Ha,ya=q+Ia,za=n+bb,D=Z,E=$,F=fa);Nb=cb;Ob=db;Pb=eb;Aa=-ga;Ba=-ha;Ca=-ia;Qb=fb;Rb=gb;Sb=hb;Ea=-oa;Fa=-pa;Ga=-qa;break;case 4:ec=!0;Ka?(xa=p-cb,ya=q-db,za=n-eb,D=-ga,E=-ha,F=-ia):(xa=p+cb,ya=q+db,za=n+eb,D=ga,E=ha,F=ia);Nb=Ha;Ob=Ia;Pb=bb;Aa=-Z;Ba=-$;Ca=-fa;Qb=fb;Rb=gb;Sb=hb;Ea=-oa;Fa=-pa;Ga=-qa;break;case 5:ec=!0;Ka?(xa=p-fb,ya=q-gb,za=n-hb,D=-oa,E=-pa,F=-qa):(xa=p+fb,ya=q+gb,za=n+hb,D=oa,E=pa,F=qa);Nb=Ha;Ob=Ia;Pb=bb;Aa=-Z;Ba=-$;Ca=-fa;Qb=cb;Rb=
db;Sb=eb;Ea=-ga;Fa=-ha;Ga=-ia;break;case 6:D=ib;E=jb;F=kb;Aa=Q;Ba=R;Ca=S;Ea=Z;Fa=$;Ga=fa;break;case 7:D=lb;E=mb;F=nb;Aa=Q;Ba=R;Ca=S;Ea=ga;Fa=ha;Ga=ia;break;case 8:D=sb;E=tb;F=ub;Aa=Q;Ba=R;Ca=S;Ea=oa;Fa=pa;Ga=qa;break;case 9:D=vb;E=wb;F=xb;Aa=T;Ba=U;Ca=V;Ea=Z;Fa=$;Ga=fa;break;case 10:D=yb;E=zb;F=Ab;Aa=T;Ba=U;Ca=V;Ea=ga;Fa=ha;Ga=ia;break;case 11:D=Bb;E=Cb;F=Db;Aa=T;Ba=U;Ca=V;Ea=oa;Fa=pa;Ga=qa;break;case 12:D=Eb;E=Fb;F=Gb;Aa=W;Ba=X;Ca=Y;Ea=Z;Fa=$;Ga=fa;break;case 13:D=Hb;E=Ib;F=Jb;Aa=W;Ba=X;Ca=Y;Ea=
ga;Fa=ha;Ga=ia;break;case 14:D=Kb,E=Lb,F=Mb,Aa=W,Ba=X,Ca=Y,Ea=oa,Fa=pa,Ga=qa}var m;if(5<Oa){Ka||(D=-D,E=-E,F=-F);var N,ma,K,L,M,ob,pb,qb,Tb,Ub,Vb;m=d.vertex1;ob=m.x;pb=m.y;qb=m.z;ma=D*ob+E*pb+F*qb;m=d.vertex2;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex3;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex4;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex5;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex6;K=m.x;
L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex7;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=d.vertex8;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N>ma&&(ma=N,ob=K,pb=L,qb=M);m=e.vertex1;Tb=m.x;Ub=m.y;Vb=m.z;ma=D*Tb+E*Ub+F*Vb;m=e.vertex2;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex3;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex4;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex5;K=m.x;L=m.y;M=m.z;N=D*K+
E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex6;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex7;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);m=e.vertex8;K=m.x;L=m.y;M=m.z;N=D*K+E*L+F*M;N<ma&&(ma=N,Tb=K,Ub=L,Vb=M);K=Tb-ob;L=Ub-pb;M=Vb-qb;s=Aa*Ea+Ba*Fa+Ca*Ga;var aa=(K*(Aa-Ea*s)+L*(Ba-Fa*s)+M*(Ca-Ga*s))/(1-s*s);b.addPoint(ob+Aa*aa+D*Ma*0.5,pb+Ba*aa+E*Ma*0.5,qb+Ca*aa+F*Ma*0.5,D,E,F,Ma,!1)}else{var Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,na=1,G=0,ab=0;if(ec)switch(G=
Q*D+R*E+S*F,G<na&&(na=G,ab=0),-G<na&&(na=-G,ab=1),G=T*D+U*E+V*F,G<na&&(na=G,ab=2),-G<na&&(na=-G,ab=3),G=W*D+X*E+Y*F,G<na&&(na=G,ab=4),-G<na&&(na=-G,ab=5),ab){case 0:m=d.vertex1;Pa=m.x;Qa=m.y;Ra=m.z;m=d.vertex3;Sa=m.x;Ta=m.y;Ua=m.z;m=d.vertex4;Va=m.x;Wa=m.y;Xa=m.z;m=d.vertex2;Ya=m.x;Za=m.y;$a=m.z;break;case 1:m=d.vertex6;Pa=m.x;Qa=m.y;Ra=m.z;m=d.vertex8;Sa=m.x;Ta=m.y;Ua=m.z;m=d.vertex7;Va=m.x;Wa=m.y;Xa=m.z;m=d.vertex5;Ya=m.x;Za=m.y;$a=m.z;break;case 2:m=d.vertex5;Pa=m.x;Qa=m.y;Ra=m.z;m=d.vertex1;Sa=
m.x;Ta=m.y;Ua=m.z;m=d.vertex2;Va=m.x;Wa=m.y;Xa=m.z;m=d.vertex6;Ya=m.x;Za=m.y;$a=m.z;break;case 3:m=d.vertex8;Pa=m.x;Qa=m.y;Ra=m.z;m=d.vertex4;Sa=m.x;Ta=m.y;Ua=m.z;m=d.vertex3;Va=m.x;Wa=m.y;Xa=m.z;m=d.vertex7;Ya=m.x;Za=m.y;$a=m.z;break;case 4:m=d.vertex5;Pa=m.x;Qa=m.y;Ra=m.z;m=d.vertex7;Sa=m.x;Ta=m.y;Ua=m.z;m=d.vertex3;Va=m.x;Wa=m.y;Xa=m.z;m=d.vertex1;Ya=m.x;Za=m.y;$a=m.z;break;case 5:m=d.vertex2,Pa=m.x,Qa=m.y,Ra=m.z,m=d.vertex4,Sa=m.x,Ta=m.y,Ua=m.z,m=d.vertex8,Va=m.x,Wa=m.y,Xa=m.z,m=d.vertex6,Ya=
m.x,Za=m.y,$a=m.z}else switch(G=Z*D+$*E+fa*F,G<na&&(na=G,ab=0),-G<na&&(na=-G,ab=1),G=ga*D+ha*E+ia*F,G<na&&(na=G,ab=2),-G<na&&(na=-G,ab=3),G=oa*D+pa*E+qa*F,G<na&&(na=G,ab=4),-G<na&&(na=-G,ab=5),ab){case 0:m=e.vertex1;Pa=m.x;Qa=m.y;Ra=m.z;m=e.vertex3;Sa=m.x;Ta=m.y;Ua=m.z;m=e.vertex4;Va=m.x;Wa=m.y;Xa=m.z;m=e.vertex2;Ya=m.x;Za=m.y;$a=m.z;break;case 1:m=e.vertex6;Pa=m.x;Qa=m.y;Ra=m.z;m=e.vertex8;Sa=m.x;Ta=m.y;Ua=m.z;m=e.vertex7;Va=m.x;Wa=m.y;Xa=m.z;m=e.vertex5;Ya=m.x;Za=m.y;$a=m.z;break;case 2:m=e.vertex5;
Pa=m.x;Qa=m.y;Ra=m.z;m=e.vertex1;Sa=m.x;Ta=m.y;Ua=m.z;m=e.vertex2;Va=m.x;Wa=m.y;Xa=m.z;m=e.vertex6;Ya=m.x;Za=m.y;$a=m.z;break;case 3:m=e.vertex8;Pa=m.x;Qa=m.y;Ra=m.z;m=e.vertex4;Sa=m.x;Ta=m.y;Ua=m.z;m=e.vertex3;Va=m.x;Wa=m.y;Xa=m.z;m=e.vertex7;Ya=m.x;Za=m.y;$a=m.z;break;case 4:m=e.vertex5;Pa=m.x;Qa=m.y;Ra=m.z;m=e.vertex7;Sa=m.x;Ta=m.y;Ua=m.z;m=e.vertex3;Va=m.x;Wa=m.y;Xa=m.z;m=e.vertex1;Ya=m.x;Za=m.y;$a=m.z;break;case 5:m=e.vertex2,Pa=m.x,Qa=m.y,Ra=m.z,m=e.vertex4,Sa=m.x,Ta=m.y,Ua=m.z,m=e.vertex8,
Va=m.x,Wa=m.y,Xa=m.z,m=e.vertex6,Ya=m.x,Za=m.y,$a=m.z}var Na,O,x,H,I,J,ra,sa,ta;this.clipVertices1[0]=Pa;this.clipVertices1[1]=Qa;this.clipVertices1[2]=Ra;this.clipVertices1[3]=Sa;this.clipVertices1[4]=Ta;this.clipVertices1[5]=Ua;this.clipVertices1[6]=Va;this.clipVertices1[7]=Wa;this.clipVertices1[8]=Xa;this.clipVertices1[9]=Ya;this.clipVertices1[10]=Za;this.clipVertices1[11]=$a;O=0;H=this.clipVertices1[9];I=this.clipVertices1[10];J=this.clipVertices1[11];s=(H-xa-Nb)*Aa+(I-ya-Ob)*Ba+(J-za-Pb)*Ca;
for(var ba=0;4>ba;ba++)x=3*ba,ra=this.clipVertices1[x],sa=this.clipVertices1[x+1],ta=this.clipVertices1[x+2],t=(ra-xa-Nb)*Aa+(sa-ya-Ob)*Ba+(ta-za-Pb)*Ca,0<s?0<t?(x=3*O,O++,this.clipVertices2[x]=ra,this.clipVertices2[x+1]=sa,this.clipVertices2[x+2]=ta):(x=3*O,O++,aa=s/(s-t),this.clipVertices2[x]=H+(ra-H)*aa,this.clipVertices2[x+1]=I+(sa-I)*aa,this.clipVertices2[x+2]=J+(ta-J)*aa):0<t&&(x=3*O,O++,aa=s/(s-t),this.clipVertices2[x]=H+(ra-H)*aa,this.clipVertices2[x+1]=I+(sa-I)*aa,this.clipVertices2[x+2]=
J+(ta-J)*aa,x=3*O,O++,this.clipVertices2[x]=ra,this.clipVertices2[x+1]=sa,this.clipVertices2[x+2]=ta),H=ra,I=sa,J=ta,s=t;Na=O;if(0!=Na){O=0;x=3*(Na-1);H=this.clipVertices2[x];I=this.clipVertices2[x+1];J=this.clipVertices2[x+2];s=(H-xa-Qb)*Ea+(I-ya-Rb)*Fa+(J-za-Sb)*Ga;for(ba=0;ba<Na;ba++)x=3*ba,ra=this.clipVertices2[x],sa=this.clipVertices2[x+1],ta=this.clipVertices2[x+2],t=(ra-xa-Qb)*Ea+(sa-ya-Rb)*Fa+(ta-za-Sb)*Ga,0<s?0<t?(x=3*O,O++,this.clipVertices1[x]=ra,this.clipVertices1[x+1]=sa,this.clipVertices1[x+
2]=ta):(x=3*O,O++,aa=s/(s-t),this.clipVertices1[x]=H+(ra-H)*aa,this.clipVertices1[x+1]=I+(sa-I)*aa,this.clipVertices1[x+2]=J+(ta-J)*aa):0<t&&(x=3*O,O++,aa=s/(s-t),this.clipVertices1[x]=H+(ra-H)*aa,this.clipVertices1[x+1]=I+(sa-I)*aa,this.clipVertices1[x+2]=J+(ta-J)*aa,x=3*O,O++,this.clipVertices1[x]=ra,this.clipVertices1[x+1]=sa,this.clipVertices1[x+2]=ta),H=ra,I=sa,J=ta,s=t;Na=O;if(0!=Na){O=0;x=3*(Na-1);H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];s=(H-xa+Nb)*-Aa+(I-
ya+Ob)*-Ba+(J-za+Pb)*-Ca;for(ba=0;ba<Na;ba++)x=3*ba,ra=this.clipVertices1[x],sa=this.clipVertices1[x+1],ta=this.clipVertices1[x+2],t=(ra-xa+Nb)*-Aa+(sa-ya+Ob)*-Ba+(ta-za+Pb)*-Ca,0<s?0<t?(x=3*O,O++,this.clipVertices2[x]=ra,this.clipVertices2[x+1]=sa,this.clipVertices2[x+2]=ta):(x=3*O,O++,aa=s/(s-t),this.clipVertices2[x]=H+(ra-H)*aa,this.clipVertices2[x+1]=I+(sa-I)*aa,this.clipVertices2[x+2]=J+(ta-J)*aa):0<t&&(x=3*O,O++,aa=s/(s-t),this.clipVertices2[x]=H+(ra-H)*aa,this.clipVertices2[x+1]=I+(sa-I)*aa,
this.clipVertices2[x+2]=J+(ta-J)*aa,x=3*O,O++,this.clipVertices2[x]=ra,this.clipVertices2[x+1]=sa,this.clipVertices2[x+2]=ta),H=ra,I=sa,J=ta,s=t;Na=O;if(0!=Na){O=0;x=3*(Na-1);H=this.clipVertices2[x];I=this.clipVertices2[x+1];J=this.clipVertices2[x+2];s=(H-xa+Qb)*-Ea+(I-ya+Rb)*-Fa+(J-za+Sb)*-Ga;for(ba=0;ba<Na;ba++)x=3*ba,ra=this.clipVertices2[x],sa=this.clipVertices2[x+1],ta=this.clipVertices2[x+2],t=(ra-xa+Qb)*-Ea+(sa-ya+Rb)*-Fa+(ta-za+Sb)*-Ga,0<s?0<t?(x=3*O,O++,this.clipVertices1[x]=ra,this.clipVertices1[x+
1]=sa,this.clipVertices1[x+2]=ta):(x=3*O,O++,aa=s/(s-t),this.clipVertices1[x]=H+(ra-H)*aa,this.clipVertices1[x+1]=I+(sa-I)*aa,this.clipVertices1[x+2]=J+(ta-J)*aa):0<t&&(x=3*O,O++,aa=s/(s-t),this.clipVertices1[x]=H+(ra-H)*aa,this.clipVertices1[x+1]=I+(sa-I)*aa,this.clipVertices1[x+2]=J+(ta-J)*aa,x=3*O,O++,this.clipVertices1[x]=ra,this.clipVertices1[x+1]=sa,this.clipVertices1[x+2]=ta),H=ra,I=sa,J=ta,s=t;Na=O;if(ec){var Pc=d;d=e;e=Pc}if(0!=Na){var fc=d!=a;if(4<Na){H=0.25*(Pa+Sa+Va+Ya);I=0.25*(Qa+Ta+
Wa+Za);J=0.25*(Ra+Ua+Xa+$a);for(var Aa=Pa-H,Ba=Qa-I,Ca=Ra-J,Ea=Sa-H,Fa=Ta-I,Ga=Ua-J,wc=0,Nc=0,xc=0,Oc=0,gc=-this.INF,na=this.INF,ba=0;ba<Na;ba++)this.used[ba]=!1,x=3*ba,H=this.clipVertices1[x],I=this.clipVertices1[x+1],J=this.clipVertices1[x+2],G=H*Aa+I*Ba+J*Ca,G<na&&(na=G,wc=ba),G>gc&&(gc=G,xc=ba);this.used[wc]=!0;this.used[xc]=!0;gc=-this.INF;na=this.INF;for(ba=0;ba<Na;ba++)this.used[ba]||(x=3*ba,H=this.clipVertices1[x],I=this.clipVertices1[x+1],J=this.clipVertices1[x+2],G=H*Ea+I*Fa+J*Ga,G<na&&
(na=G,Nc=ba),G>gc&&(gc=G,Oc=ba));x=3*wc;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];G=(H-xa)*D+(I-ya)*E+(J-za)*F;0>G&&b.addPoint(H,I,J,D,E,F,G,fc);x=3*Nc;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];G=(H-xa)*D+(I-ya)*E+(J-za)*F;0>G&&b.addPoint(H,I,J,D,E,F,G,fc);x=3*xc;H=this.clipVertices1[x];I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];G=(H-xa)*D+(I-ya)*E+(J-za)*F;0>G&&b.addPoint(H,I,J,D,E,F,G,fc);x=3*Oc;H=this.clipVertices1[x];
I=this.clipVertices1[x+1];J=this.clipVertices1[x+2];G=(H-xa)*D+(I-ya)*E+(J-za)*F;0>G&&b.addPoint(H,I,J,D,E,F,G,fc)}else for(ba=0;ba<Na;ba++)x=3*ba,H=this.clipVertices1[x],I=this.clipVertices1[x+1],J=this.clipVertices1[x+2],G=(H-xa)*D+(I-ya)*E+(J-za)*F,0>G&&b.addPoint(H,I,J,D,E,F,G,fc)}}}}}}};OIMO.SphereBoxCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);
OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=d.position;a=f.x;c=f.y;var h=f.z,g=e.position,l=g.x,k=g.y,g=g.z;d=d.radius;var p=e.normalDirectionWidth,q=e.normalDirectionHeight,n=e.normalDirectionDepth,w=e.halfWidth,u=e.halfHeight,y=e.halfDepth;e=a-l;var r=c-k,z=h-g,B=p.x*e+p.y*r+p.z*z,A=q.x*e+q.y*r+q.z*z,C=n.x*e+n.y*r+n.z*z;e=0;B>w?B=w:B<-w?B=-w:e=1;A>u?A=u:A<-u?A=-u:e|=2;C>y?C=y:C<-y?C=-y:e|=4;7==e?(e=0>B?w+B:w-B,r=0>A?u+A:u-
A,z=0>C?y+C:y-C,e<r?e<z?(f=e-w,0>B?(e=p.x,r=p.y,z=p.z):(e=-p.x,r=-p.y,z=-p.z)):(f=z-y,0>C?(e=n.x,r=n.y,z=n.z):(e=-n.x,r=-n.y,z=-n.z)):r<z?(f=r-u,0>A?(e=q.x,r=q.y,z=q.z):(e=-q.x,r=-q.y,z=-q.z)):(f=z-y,0>C?(e=n.x,r=n.y,z=n.z):(e=-n.x,r=-n.y,z=-n.z)),b.addPoint(a+d*e,c+d*r,h+d*z,e,r,z,f-d,this.flip)):(l=l+B*p.x+A*q.x+C*n.x,k=k+B*p.y+A*q.y+C*n.y,g=g+B*p.z+A*q.z+C*n.z,e=l-f.x,r=k-f.y,z=g-f.z,f=e*e+r*r+z*z,0<f&&f<d*d&&(f=Math.sqrt(f),k=1/f,e*=k,r*=k,z*=k,b.addPoint(a+d*e,c+d*r,h+d*z,e,r,z,f-d,this.flip)))};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(a,c,b){var d=a.position,e=c.position,f=e.x-d.x,h=e.y-d.y,e=e.z-d.z,g=f*f+h*h+e*e;a=a.radius;c=a+c.radius;if(0<g&&g<c*c){var g=Math.sqrt(g),l=1/g,f=f*l,h=h*l,e=e*l;b.addPoint(d.x+f*a,d.y+h*a,d.z+e*a,f,h,e,g-c,!1)}};OIMO.AABB=function(a,c,b,d,e,f){this.minX=a||0;this.maxX=c||0;this.minY=b||0;this.maxY=d||0;this.minZ=e||0;this.maxZ=f||0};
OIMO.AABB.prototype={constructor:OIMO.AABB,init:function(a,c,b,d,e,f){this.minX=a;this.maxX=c;this.minY=b;this.maxY=d;this.minZ=e;this.maxZ=f},combine:function(a,c){this.minX=a.minX<c.minX?a.minX:c.minX;this.maxX=a.maxX>c.maxX?a.maxX:c.maxX;this.minY=a.minY<c.minY?a.minY:c.minY;this.maxY=a.maxY>c.maxY?a.maxY:c.maxY;this.minZ=a.minZ<c.minZ?a.minZ:c.minZ;this.maxZ=a.maxZ>c.maxZ?a.maxZ:c.maxZ},surfaceArea:function(){var a=this.maxY-this.minY,c=this.maxZ-this.minZ;return 2*((this.maxX-this.minX)*(a+c)+
a*c)},intersectsWithPoint:function(a,c,b){return a>=this.minX&&a<=this.maxX&&c>=this.minY&&c<=this.maxY&&b>=this.minZ&&b<=this.maxZ}};OIMO.Proxy=function(a){this.shape=a;this.aabb=a.aabb};OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){throw Error("Inheritance error.");}};OIMO.BasicProxy=function(a){OIMO.Proxy.call(this,a)};OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.BasicProxy.prototype.update=function(){};OIMO.BroadPhase=function(){this.numPairs=this.numPairChecks=this.types=0;this.bufferSize=256;this.pairs=[];for(var a=this.pairs.length=this.bufferSize;a--;)this.pairs[a]=new OIMO.Pair};
OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(a){throw Error("Inheritance error.");},addProxy:function(a){throw Error("Inheritance error.");},removeProxy:function(a){throw Error("Inheritance error.");},isAvailablePair:function(a,c){var b=a.parent,d=c.parent;if(b==d||!b.isDynamic&&!d.isDynamic||0==(a.belongsTo&c.collidesWith)||0==(c.belongsTo&a.collidesWith))return!1;var e;for(e=b.numJoints<d.numJoints?b.jointLink:d.jointLink;null!=e;){var f=e.joint;if(!f.allowCollision&&
(f.body1==b&&f.body2==d||f.body1==d&&f.body2==b))return!1;e=e.next}return!0},detectPairs:function(){for(;0<this.numPairs;){var a=this.pairs[--this.numPairs];a.shape1=null;a.shape2=null}this.numPairChecks=0;this.collectPairs()},collectPairs:function(){throw Error("Inheritance error.");},addPair:function(a,c){if(this.numPairs==this.bufferSize){for(var b=2*this.bufferSize,d=[],e=d.length=this.bufferSize;e--;)d[e]=this.pairs[e];for(e=this.bufferSize;e<b;e++)d[e]=new OIMO.Pair;this.pairs=d;this.bufferSize=
b}b=this.pairs[this.numPairs++];b.shape1=a;b.shape2=c}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=1;this.numProxies=0;this.maxProxies=256;this.proxies=[];this.proxies.length=256};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.createProxy=function(a){return new OIMO.BasicProxy(a)};
OIMO.BruteForceBroadPhase.prototype.addProxy=function(a){if(this.numProxies==this.maxProxies){this.maxProxies*=2;for(var c=[],b=this.numProxies;b--;)c[b]=this.proxies[b];this.proxies=c}this.proxies[this.numProxies++]=a};OIMO.BruteForceBroadPhase.prototype.removeProxy=function(a){for(var c=0,b=this.numProxies;c<b;c++)if(this.proxies[c]==a){this.proxies[c]=this.proxies[--this.numProxies];this.proxies[this.numProxies]=null;break}};
OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){this.numPairChecks=this.numProxies*(this.numProxies-1)>>1;for(var a=this.numProxies;a--;)for(var c=this.proxies[a],b=c.aabb,c=c.shape,d=this.numProxies;d--;)if(0!==d){var e=this.proxies[d],f=e.aabb,e=e.shape;b.maxX<f.minX||b.minX>f.maxX||b.maxY<f.minY||b.minY>f.maxY||b.maxZ<f.minZ||b.minZ>f.maxZ||!this.isAvailablePair(c,e)||this.addPair(c,e)}};OIMO.Pair=function(){this.shape2=this.shape1=null};OIMO.SAPAxis=function(){this.numElements=0;this.stack=[];this.stack.length=64;this.bufferSize=256;this.elements=[];this.elements.length=this.bufferSize};
OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(a,c){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var b=0,d=this.numElements;b<d;b++);}this.elements[this.numElements++]=a;this.elements[this.numElements++]=c},removeElements:function(a,c){for(var b=-1,d=-1,e=0,f=this.numElements;e<f;e++){var h=this.elements[e];if(h==a||h==c)if(-1==b)b=e;else{d=e;break}}e=b+1;for(f=d;e<f;e++)this.elements[e-1]=this.elements[e];e=d+1;for(f=this.numElements;e<f;e++)this.elements[e-
2]=this.elements[e];this.elements[--this.numElements]=null;this.elements[--this.numElements]=null},sort:function(){for(var a=0,c=1;0!=this.numElements>>c;)c++;for(var c=c*this.numElements>>2,a=0,b=!1,d=this.elements,e=1,f=this.numElements;e<f;e++){var h=d[e],g=h.value,l=d[e-1];if(l.value>g){var k=e;do{d[k]=l;if(0==--k)break;l=d[k-1]}while(l.value>g);d[k]=h;a+=e-k;if(a>c){b=!0;break}}}if(b)for(a=2,c=this.stack,c[0]=0,c[1]=this.numElements-1;0<a;)if(b=c[--a],l=c[--a],h=b-l,16<h){e=l+(h>>1);h=d[e];d[e]=
d[b];d[b]=h;g=h.value;e=l-1;for(k=b;;){var p;do f=d[++e];while(f.value<g);do p=d[--k];while(g<p.value&&k!=l);if(e>=k)break;d[e]=p;d[k]=f}d[b]=d[e];d[e]=h;e-l>b-e?(c[a++]=l,c[a++]=e-1,c[a++]=e+1,c[a++]=b):(c[a++]=e+1,c[a++]=b,c[a++]=l,c[a++]=e-1)}else for(e=l+1;e<=b;e++)if(h=d[e],g=h.value,l=d[e-1],l.value>g){k=e;do{d[k]=l;if(0==--k)break;l=d[k-1]}while(l.value>g);d[k]=h}},calculateTestCount:function(){for(var a=1,c=0,b=1,d=this.numElements;b<d;b++)this.elements[b].max?a--:(c+=a,a++);return c}};OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=2;this.numElementsS=this.numElementsD=0;this.axesD=[];this.axesS=[];this.axesD.length=3;this.axesS.length=3;this.axesD[0]=new OIMO.SAPAxis;this.axesD[1]=new OIMO.SAPAxis;this.axesD[2]=new OIMO.SAPAxis;this.axesS[0]=new OIMO.SAPAxis;this.axesS[1]=new OIMO.SAPAxis;this.axesS[2]=new OIMO.SAPAxis;this.index1=0;this.index2=1};OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);
OIMO.SAPBroadPhase.prototype.createProxy=function(a){return new OIMO.SAPProxy(this,a)};OIMO.SAPBroadPhase.prototype.addProxy=function(a){a.isDynamic()?(this.axesD[0].addElements(a.min[0],a.max[0]),this.axesD[1].addElements(a.min[1],a.max[1]),this.axesD[2].addElements(a.min[2],a.max[2]),a.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(a.min[0],a.max[0]),this.axesS[1].addElements(a.min[1],a.max[1]),this.axesS[2].addElements(a.min[2],a.max[2]),a.belongsTo=2,this.numElementsS+=2)};
OIMO.SAPBroadPhase.prototype.removeProxy=function(a){if(0!=a.belongsTo){switch(a.belongsTo){case 1:this.axesD[0].removeElements(a.min[0],a.max[0]);this.axesD[1].removeElements(a.min[1],a.max[1]);this.axesD[2].removeElements(a.min[2],a.max[2]);this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(a.min[0],a.max[0]),this.axesS[1].removeElements(a.min[1],a.max[1]),this.axesS[2].removeElements(a.min[2],a.max[2]),this.numElementsS-=2}a.belongsTo=0}};
OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var a=this.axesD[this.index1],c=this.axesD[this.index2];a.sort();c.sort();var b=a.calculateTestCount(),d=c.calculateTestCount();b<=d?(c=this.axesS[this.index1],c.sort(),b=a.elements,a=c.elements):(a=this.axesS[this.index2],a.sort(),b=c.elements,a=a.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var e,f,d=c=0;c<this.numElementsD;){var h,g;d==this.numElementsS?(h=b[c],g=!0,c++):(h=
b[c],g=a[d],h.value<g.value?(g=!0,c++):(h=g,g=!1,d++));if(h.max){var l=h.pair;if(g)if(l==e){e=e.pair;continue}else h=e;else if(l==f){f=f.pair;continue}else h=f;do{w=h.pair;if(w==l){h.pair=w.pair;break}h=w}while(null!=h)}else{for(var l=h.proxy.shape,k=h.min1.value,p=h.max1.value,q=h.min2.value,n=h.max2.value,w=e;null!=w;w=w.pair){var u=w.proxy.shape;this.numPairChecks++;k>w.max1.value||p<w.min1.value||q>w.max2.value||n<w.min2.value||!this.isAvailablePair(l,u)||this.addPair(l,u)}if(g){for(w=f;null!=
w;w=w.pair)u=w.proxy.shape,this.numPairChecks++,k>w.max1.value||p<w.min1.value||q>w.max2.value||n<w.min2.value||!this.isAvailablePair(l,u)||this.addPair(l,u);h.pair=e;e=h}else h.pair=f,f=h}}this.index2=(this.index1|this.index2)^3}};OIMO.SAPElement=function(a,c){this.max2=this.min2=this.max1=this.min1=this.pair=null;this.proxy=a;this.max=c;this.value=0};OIMO.SAPProxy=function(a,c){OIMO.Proxy.call(this,c);this.belongsTo=0;this.max=[];this.min=[];this.sap=a;this.min[0]=new OIMO.SAPElement(this,!1);this.max[0]=new OIMO.SAPElement(this,!0);this.min[1]=new OIMO.SAPElement(this,!1);this.max[1]=new OIMO.SAPElement(this,!0);this.min[2]=new OIMO.SAPElement(this,!1);this.max[2]=new OIMO.SAPElement(this,!0);this.max[0].pair=this.min[0];this.max[1].pair=this.min[1];this.max[2].pair=this.min[2];this.min[0].min1=this.min[1];this.min[0].max1=this.max[1];this.min[0].min2=
this.min[2];this.min[0].max2=this.max[2];this.min[1].min1=this.min[0];this.min[1].max1=this.max[0];this.min[1].min2=this.min[2];this.min[1].max2=this.max[2];this.min[2].min1=this.min[0];this.min[2].max1=this.max[0];this.min[2].min2=this.min[1];this.min[2].max2=this.max[1]};OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.SAPProxy.prototype.isDynamic=function(){var a=this.shape.parent;return a.isDynamic&&!a.sleeping};
OIMO.SAPProxy.prototype.update=function(){this.min[0].value=this.aabb.minX;this.max[0].value=this.aabb.maxX;this.min[1].value=this.aabb.minY;this.max[1].value=this.aabb.maxY;this.min[2].value=this.aabb.minZ;this.max[2].value=this.aabb.maxZ;if(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())this.sap.removeProxy(this),this.sap.addProxy(this)};OIMO.DBVT=function(){this.root=null;this.freeNodes=[];this.freeNodes.length=16384;this.numFreeNodes=0;this.aabb=new OIMO.AABB};
OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(a){this.deleteLeaf(a);this.insertLeaf(a)},insertLeaf:function(a){if(null==this.root)this.root=a;else{for(var c=a.aabb,b=this.root,d,e;null==b.proxy;){var f=b.child1,h=b.child2,g=b.aabb,l=f.aabb,k=h.aabb;d=g.surfaceArea();this.aabb.combine(c,g);e=this.aabb.surfaceArea();g=2*e;d=e=2*(e-d);this.aabb.combine(c,l);d=null!=f.proxy?d+this.aabb.surfaceArea():d+(this.aabb.surfaceArea()-l.surfaceArea());l=e;this.aabb.combine(c,k);l=null!=h.proxy?
l+this.aabb.surfaceArea():l+(this.aabb.surfaceArea()-k.surfaceArea());if(d<l)if(g<d)break;else b=f;else if(g<l)break;else b=h}c=b.parent;f=0<this.numFreeNodes?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode;f.parent=c;f.child1=a;f.child2=b;f.aabb.combine(a.aabb,b.aabb);f.height=b.height+1;b.parent=f;a.parent=f;b==this.root?this.root=f:c.child1==b?c.child1=f:c.child2=f;do f=this.balance(f),this.fix(f),f=f.parent;while(null!=f)}},getBalance:function(a){return null!=a.proxy?0:a.child1.height-a.child2.height},
print:function(a,c,b){var d=null==a.proxy;d&&(b=this.print(a.child1,c+1,b));for(var e=2*c;0<=e;e--)b+=" ";b+=(d?this.getBalance(a):"["+a.proxy.aabb.minX+"]")+"\n";d&&(b=this.print(a.child2,c+1,b));return b},deleteLeaf:function(a){if(a==this.root)this.root=null;else{var c=a.parent;a=c.child1==a?c.child2:c.child1;if(c==this.root)this.root=a,a.parent=null;else{var b=c.parent;a.parent=b;b.child1==c?b.child1=a:b.child2=a;16384>this.numFreeNodes&&(this.freeNodes[this.numFreeNodes++]=c);do b=this.balance(b),
this.fix(b),b=b.parent;while(null!=b)}}},balance:function(a){var c=a.height;if(2>c)return a;var b=a.parent,d=a.child1,e=a.child2,f=d.height,h=e.height,g=f-h;if(1<g){var f=d.child1,g=d.child2,l=f.height,k=g.height;l>k?(d.child2=a,a.parent=d,a.child1=g,g.parent=a,a.aabb.combine(g.aabb,e.aabb),h=k-h,a.height=k-(h&h>>31)+1,d.aabb.combine(f.aabb,a.aabb),h=l-c,d.height=l-(h&h>>31)+1):(d.child1=a,a.parent=d,a.child1=f,f.parent=a,a.aabb.combine(f.aabb,e.aabb),h=l-h,a.height=l-(h&h>>31)+1,d.aabb.combine(a.aabb,
g.aabb),h=c-k,d.height=c-(h&h>>31)+1);null!=b?b.child1==a?b.child1=d:b.child2=d:this.root=d;d.parent=b;return d}if(-1>g){var g=e.child1,l=e.child2,k=g.height,p=l.height;k>p?(e.child2=a,a.parent=e,a.child2=l,l.parent=a,a.aabb.combine(d.aabb,l.aabb),h=f-p,a.height=f-(h&h>>31)+1,e.aabb.combine(g.aabb,a.aabb),h=k-c,e.height=k-(h&h>>31)+1):(e.child1=a,a.parent=e,a.child2=g,g.parent=a,a.aabb.combine(d.aabb,g.aabb),h=f-k,a.height=f-(h&h>>31)+1,e.aabb.combine(a.aabb,l.aabb),h=c-p,e.height=c-(h&h>>31)+1);
null!=b?b.child1==a?b.child1=e:b.child2=e:this.root=e;e.parent=b;return e}return a},fix:function(a){var c=a.child1,b=a.child2;a.aabb.combine(c.aabb,b.aabb);c=c.height;b=b.height;a.height=c<b?b+1:c+1}};OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=3;this.maxLeaves=this.numLeaves=0;this.tree=new OIMO.DBVT;this.maxStack=256;this.stack=[];this.stack.length=this.maxStack;this.maxLeaves=256;this.leaves=[];this.leaves.length=this.maxLeaves};OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.DBVTBroadPhase.prototype.createProxy=function(a){return new OIMO.DBVTProxy(a)};
OIMO.DBVTBroadPhase.prototype.addProxy=function(a){this.tree.insertLeaf(a.leaf);if(this.numLeaves==this.maxLeaves){this.maxLeaves*=2;var c=[];c.length=this.maxLeaves;for(var b=0;b<this.numLeaves;b++)c[b]=this.leaves[b];this.leaves=c}this.leaves[this.numLeaves++]=a.leaf};OIMO.DBVTBroadPhase.prototype.removeProxy=function(a){this.tree.deleteLeaf(a.leaf);for(var c=0;c<this.numLeaves;c++)if(this.leaves[c]==a.leaf){this.leaves[c]=this.leaves[--this.numLeaves];this.leaves[this.numLeaves]=null;break}};
OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(2>this.numLeaves))for(var a=0;a<this.numLeaves;a++){var c=this.leaves[a],b=c.proxy.aabb,d=c.aabb;if(b.minX<d.minX||b.maxX>d.maxX||b.minY<d.minY||b.maxY>d.maxY||b.minZ<d.minZ||b.maxZ>d.maxZ)this.tree.deleteLeaf(c),d.minX=b.minX-0.1,d.maxX=b.maxX+0.1,d.minY=b.minY-0.1,d.maxY=b.maxY+0.1,d.minZ=b.minZ-0.1,d.maxZ=b.maxZ+0.1,this.tree.insertLeaf(c),this.collide(c,this.tree.root)}};
OIMO.DBVTBroadPhase.prototype.collide=function(a,c){var b=2;this.stack[0]=a;for(this.stack[1]=c;0<b;){var d=this.stack[--b],e=this.stack[--b],f=null!=d.proxy,h=null!=e.proxy;this.numPairChecks++;if(f&&h){var d=d.proxy.shape,e=e.proxy.shape,g=d.aabb,l=e.aabb;d==e||g.maxX<l.minX||g.minX>l.maxX||g.maxY<l.minY||g.minY>l.maxY||g.maxZ<l.minZ||g.minZ>l.maxZ||!this.isAvailablePair(d,e)||this.addPair(d,e)}else if(g=d.aabb,l=e.aabb,!(g.maxX<l.minX||g.minX>l.maxX||g.maxY<l.minY||g.minY>l.maxY||g.maxZ<l.minZ||
g.minZ>l.maxZ)){if(b+4>=this.maxStack){this.maxStack*=2;g=[];g.length=this.maxStack;for(l=0;l<b;l++)g[l]=this.stack[l];this.stack=g}h||!f&&d.aabb.surfaceArea()>e.aabb.surfaceArea()?(this.stack[b++]=d.child1,this.stack[b++]=e,this.stack[b++]=d.child2,this.stack[b++]=e):(this.stack[b++]=d,this.stack[b++]=e.child1,this.stack[b++]=d,this.stack[b++]=e.child2)}}};OIMO.DBVTNode=function(){this.proxy=this.parent=this.child2=this.child1=null;this.height=0;this.aabb=new OIMO.AABB};OIMO.DBVTProxy=function(a){OIMO.Proxy.call(this,a);this.leaf=new OIMO.DBVTNode;this.leaf.proxy=this};OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.DBVTProxy.prototype.update=function(){};
