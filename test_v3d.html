<!DOCTYPE html>
<html lang="en">
<head>
<title>Oimo.js Basic</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=11" />
<link rel="shortcut icon" href="favicon.ico">
<link href="css/demo.css"  media="screen, print" rel="stylesheet" type="text/css" />

<script src="js/three.min.js"></script>
<script src="js/V3D.js"></script>
<script src="build/Oimo.min.js"></script>

</head>
<body>
<div id='container'></div>
<div id='interface'>
    <input type="button" value="sphere" onClick=populate(1)>
    <input type="button" value="boxe" onClick=populate(2)>
    <input type="button" value="mix" onClick=populate(3)>
    <input type="number" name="quantity" min="10" max="20" value="20"  id='MaxNumber'>
    <input type="submit" onClick=populate()>
    <input type="number" name="gravity" min="-20" max="20" value="-10" id='gravity' onChange=gravity() >
</div>
<div id='info'></div>
<a href="https://github.com/lo-th/Oimo.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="images/ribbon.png" alt="Fork me on GitHub"></a>       
<script>

    // three var
    var v3d;
    var meshs = [];
    var grounds = [];

    //oimo var
    var world = null;
    var bodys = [];
    var type=1;
    var infos;

    init();
    loop();

    function init() {
        infos = document.getElementById("info");
        v3d = new V3D.View();
        world = new OIMO.World(1/60, 2, 8);
        populate(1);
        setInterval(updateOimoPhysics, 1000/60);
    }

    function loop() {
        requestAnimationFrame( loop );
        v3d.render();
    }

    function clearMesh(){
        var i=meshs.length;
        while (i--) v3d.scene.remove(meshs[i]);
        i = grounds.length;
        while (i--) v3d.scene.remove(grounds[i]);
        grounds = [];
        meshs = [];
    }

    function populate(n) {
        var obj;
        var max = document.getElementById("MaxNumber").value;

        if(n===1) type = 1
        else if(n===2) type = 2;
        else if(n===3) type = 3;

        // reset old
        clearMesh();
        world.clear();
        bodys=[];

        obj = {size:[400, 40, 390], pos:[0,-20,0], world:world}
        //add ground
        var ground = new OIMO.Body(obj);
        ground[0] = v3d.add(obj);

        //add object
        var x, y, z, w, h, d;
        var i = max;

        while (i--){
            if(type===3) t = Math.floor(Math.random()*2)+1;
            else t = type;
            x = -100 + Math.random()*200;
            z = -100 + Math.random()*200;
            y = 100 + Math.random()*1000;
            w = 10 + Math.random()*10;
            h = 10 + Math.random()*10;
            d = 10 + Math.random()*10;

            if(t===1) obj = {type:'sphere', size:[w*0.5, w*0.5, w*0.5], pos:[x,y,z], move:true, world:world};
            if(t===2) obj = {type:'box', size:[w,h,d], pos:[x,y,z], move:true, world:world};
            
            bodys[i] = new OIMO.Body(obj);
            meshs[i] = v3d.add(obj);
        }
    }

    function updateOimoPhysics() {
        world.step();

        var x, y, z;
        var i = bodys.length;
        var mesh;
        var body; 

        while (i--){
            body = bodys[i];
            mesh = meshs[i];

            if(!body.sleeping){

                mesh.position.copy(body.getPosition());
                mesh.quaternion.copy(body.getQuaternion());

                // change material
                if(mesh.material.name === 'sbox') mesh.material = v3d.mats.box;
                if(mesh.material.name === 'ssph') mesh.material = v3d.mats.sph; 

                // reset position
                if(mesh.position.y<-100){
                    x = -100 + Math.random()*200;
                    z = -100 + Math.random()*200;
                    y = 100 + Math.random()*1000;
                    body.resetPosition(x,y,z);
                }
            } else {
                if(mesh.material.name === 'box') mesh.material = v3d.mats.sbox;
                if(mesh.material.name === 'sph') mesh.material = v3d.mats.ssph;
            }
        }

        infos.innerHTML = world.performance.show();
    }

    function gravity(g){
        nG = document.getElementById("gravity").value
        world.gravity = new OIMO.Vec3(0, nG, 0);
    }

</script>
</body>
</html>